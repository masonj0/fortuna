{
    "file_path": "python_service/adapters/drf_adapter.py",
    "content": "# python_service/adapters/drf_adapter.py\nfrom datetime import datetime\nfrom typing import List\nfrom typing import Optional\n\nfrom bs4 import BeautifulSoup\nfrom dateutil.parser import parse\n\nfrom ..models import OddsData\nfrom ..models import Race\nfrom ..models import Runner\nfrom ..utils.odds import parse_odds_to_decimal\nfrom ..utils.text import normalize_venue_name\nfrom .base_v3 import BaseAdapterV3\n\n\nclass DRFAdapter(BaseAdapterV3):\n    \"\"\"\n    Adapter for drf.com, migrated to BaseAdapterV3.\n    \"\"\"\n\n    SOURCE_NAME = \"DRF\"\n    BASE_URL = \"https://www.drf.com\"\n\n    def __init__(self, config=None):\n        super().__init__(\n            source_name=self.SOURCE_NAME, base_url=self.BASE_URL, config=config\n        )\n\n    async def _fetch_data(self, date: str) -> Optional[dict]:\n        \"\"\"Fetches the raw HTML from the DRF entries page.\"\"\"\n        url = f\"/entries/{date}/USA\"\n        response = await self.make_request(self.http_client, \"GET\", url)\n        return (\n            {\"html\": response.text, \"date\": date}\n            if response and response.text\n            else None\n        )\n\n    def _parse_races(self, raw_data: Optional[dict]) -> List[Race]:\n        \"\"\"Parses the raw HTML into a list of Race objects.\"\"\"\n        if not raw_data or not raw_data.get(\"html\"):\n            return []\n\n        html = raw_data[\"html\"]\n        race_date = raw_data[\"date\"]\n        soup = BeautifulSoup(html, \"html.parser\")\n\n        venue_node = soup.select_one(\"div.track-info h1\")\n        if not venue_node:\n            self.logger.warning(\"Could not find venue name on DRF page.\")\n            return []\n\n        venue_text = venue_node.text\n        venue = normalize_venue_name(\n            venue_text.split(\" - \")[0].replace(\"Entries for \", \"\")\n        )\n\n        races = []\n        for race_entry in soup.select(\"div.race-entries\"):\n            try:\n                race_number_str = race_entry.get(\"data-race-number\")\n                if not race_number_str or not race_number_str.isdigit():\n                    continue\n                race_number = int(race_number_str)\n\n                post_time_node = race_entry.select_one(\".post-time\")\n                if not post_time_node:\n                    continue\n                post_time_str = post_time_node.text.replace(\"Post Time: \", \"\").strip()\n                start_time = parse(f\"{race_date} {post_time_str}\")\n\n                runners = []\n                for entry in race_entry.select(\"li.entry\"):\n                    if \"scratched\" in entry.get(\"class\", []):\n                        continue\n\n                    number_node = entry.select_one(\".program-number\")\n                    if not number_node or not number_node.text.isdigit():\n                        continue\n                    number = int(number_node.text)\n\n                    name_node = entry.select_one(\".horse-name\")\n                    if not name_node:\n                        continue\n                    name = name_node.text\n\n                    odds_node = entry.select_one(\".odds\")\n                    odds_str = odds_node.text.replace(\"-\", \"/\") if odds_node else \"\"\n\n                    win_odds = parse_odds_to_decimal(odds_str)\n                    odds = {}\n                    if win_odds:\n                        odds[self.source_name] = OddsData(\n                            win=win_odds,\n                            source=self.source_name,\n                            last_updated=datetime.now(),\n                        )\n\n                    runners.append(Runner(number=number, name=name, odds=odds))\n\n                if not runners:\n                    continue\n\n                race = Race(\n                    id=f\"drf_{venue.replace(' ', '').lower()}_{race_date}_{race_number}\",\n                    venue=venue,\n                    race_number=race_number,\n                    start_time=start_time,\n                    runners=runners,\n                    source=self.source_name,\n                    field_size=len(runners),\n                )\n                races.append(race)\n            except (ValueError, KeyError, TypeError):\n                self.logger.warning(\n                    \"Failed to parse a race on DRF, skipping.\", exc_info=True\n                )\n                continue\n        return races\n"
}