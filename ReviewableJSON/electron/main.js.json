{
    "file_path": "electron/main.js",
    "content": "// electron/main.js - CORRECTED VERSION\nconst { app, BrowserWindow, Tray, Menu, nativeImage, ipcMain } = require('electron');\nconst { spawn } = require('child_process');\nconst path = require('path');\nconst fs = require('fs');\n\nclass FortunaDesktopApp {\n  constructor() {\n    this.backendProcess = null;\n    this.mainWindow = null;\n    this.tray = null;\n    this.backendState = 'stopped'; // \"stopped\", \"starting\", \"running\", \"error\"\n    this.backendLogs = [];\n  }\n\n  sendBackendStatusUpdate() {\n    if (this.mainWindow) {\n      this.mainWindow.webContents.send('backend-status-update', {\n        state: this.backendState,\n        logs: this.backendLogs.slice(-20) // Send last 20 log entries\n      });\n    }\n  }\n\n  startBackend() {\n    this.backendState = 'starting';\n    this.backendLogs = ['Attempting to start backend process...'];\n    this.sendBackendStatusUpdate();\n\n    if (this.backendProcess && !this.backendProcess.killed) {\n      console.log('Backend process already running. Killing old process.');\n      this.backendProcess.kill();\n    }\n\n    const isDev = !app.isPackaged;\n\n    if (isDev) {\n      // Development: use Python venv\n      console.log('[DEV MODE] Starting backend from Python venv...');\n      const pythonPath = path.join(__dirname, '..', '.venv', 'Scripts', 'python.exe');\n\n      if (!fs.existsSync(pythonPath)) {\n        const errorMsg = 'FATAL: Python executable not found. Run setup first.';\n        console.error(errorMsg, { path: pythonPath });\n        this.backendState = 'error';\n        this.backendLogs.push(errorMsg);\n        this.sendBackendStatusUpdate();\n        return;\n      }\n\n      this.backendProcess = spawn(pythonPath, ['-m', 'uvicorn', 'api:app', '--host', '127.0.0.1', '--port', '8000'], {\n        cwd: path.join(__dirname, '..', 'python_service'),\n        env: process.env\n      });\n    } else {\n      // Production: use PyInstaller exe\n      console.log('[PROD MODE] Starting backend from packaged executable...');\n      const exePath = path.join(process.resourcesPath, 'fortuna-backend', 'fortuna-backend.exe');\n\n      if (!fs.existsSync(exePath)) {\n        const errorMsg = 'FATAL: Backend executable missing from installation.';\n        console.error(errorMsg, { path: exePath });\n        this.backendState = 'error';\n        this.backendLogs.push(errorMsg, `Expected at: ${exePath}`);\n        this.sendBackendStatusUpdate();\n        return;\n      }\n\n      console.log('Launching backend from:', exePath);\n      this.backendProcess = spawn(exePath, [], {\n        env: { ...process.env, HOST: '127.0.0.1', PORT: '8000' }\n      });\n    }\n\n    // Common event handlers for the backend process\n    this.backendProcess.stdout.on('data', (data) => {\n      const output = data.toString().trim();\n      console.log(`[Backend] ${output}`);\n      this.backendLogs.push(output);\n\n      if (this.backendState !== 'running' && (output.includes('Uvicorn running') || output.includes('Application startup complete'))) {\n        console.log('\u2705 Backend is ready!');\n        this.backendState = 'running';\n      }\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.stderr.on('data', (data) => {\n      const errorOutput = data.toString().trim();\n      console.error(`[Backend ERROR] ${errorOutput}`);\n      this.backendLogs.push(`ERROR: ${errorOutput}`);\n      this.backendState = 'error';\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.on('error', (err) => {\n      const errorMsg = `FATAL: Failed to start backend process: ${err.message}`;\n      console.error(errorMsg);\n      this.backendLogs.push(errorMsg);\n      this.backendState = 'error';\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.on('exit', (code) => {\n      // Only flag as an error if it wasn't a clean shutdown or a planned restart\n      if (code !== 0 && this.backendState !== 'stopped') {\n        const errorMsg = `Backend process exited unexpectedly with code ${code}`;\n        console.error(errorMsg);\n        this.backendLogs.push(errorMsg);\n        this.backendState = 'error';\n        this.sendBackendStatusUpdate();\n      }\n    });\n  }\n\n  getFrontendPath() {\n    const isDev = !app.isPackaged;\n\n    if (isDev) {\n      return 'http://localhost:3000';\n    }\n\n    // FIXED: In production, the frontend files are in app/web-ui-build/out/\n    // When packaged in app.asar, use app.getAppPath() to get the asar location\n    // The files are included via the files array in package.json\n    const indexPath = path.join(app.getAppPath(), 'web-ui-build', 'out', 'index.html');\n\n    console.log('DEBUG [Frontend Path Resolution]:');\n    console.log('  app.isPackaged:', app.isPackaged);\n    console.log('  app.getAppPath():', app.getAppPath());\n    console.log('  Resolved path:', indexPath);\n    console.log('  File exists:', fs.existsSync(indexPath));\n\n    // If not found, list what's actually there for debugging\n    if (!fs.existsSync(indexPath)) {\n      const appPath = app.getAppPath();\n      try {\n        console.error('Contents of app directory:');\n        const listDir = (dir, depth = 0) => {\n          if (depth > 3) return; // Limit recursion\n          try {\n            const files = fs.readdirSync(dir);\n            files.forEach(file => {\n              const fullPath = path.join(dir, file);\n              const indent = '  '.repeat(depth);\n              if (fs.statSync(fullPath).isDirectory()) {\n                console.error(`${indent}\ud83d\udcc1 ${file}/`);\n                listDir(fullPath, depth + 1);\n              } else {\n                console.error(`${indent}\ud83d\udcc4 ${file}`);\n              }\n            });\n          } catch (err) {\n            console.error(`Error listing ${dir}:`, err.message);\n          }\n        };\n        listDir(appPath);\n      } catch (err) {\n        console.error('Could not list app directory:', err);\n      }\n    }\n\n    return `file://${indexPath}`;\n  }\n\n  createMainWindow() {\n    this.mainWindow = new BrowserWindow({\n      width: 1600,\n      height: 1000,\n      title: 'Fortuna Faucet - Racing Analysis',\n      icon: path.join(__dirname, 'assets', 'icon.ico'),\n      webPreferences: {\n        nodeIntegration: false,\n        contextIsolation: true,\n        preload: path.join(__dirname, 'preload.js')\n      },\n      autoHideMenuBar: true,\n      backgroundColor: '#1a1a2e'\n    });\n\n    const isDev = !app.isPackaged;\n\n    if (isDev) {\n      // Development: load from Next.js dev server\n      console.log('[DEV MODE] Loading frontend from http://localhost:3000');\n      this.mainWindow.loadURL('http://localhost:3000');\n\n      // Open DevTools in development\n      this.mainWindow.webContents.openDevTools();\n    } else {\n      // Production: load from bundled static files\n      const frontendUrl = this.getFrontendPath();\n\n      if (!frontendUrl.startsWith('http') && !fs.existsSync(frontendUrl.replace('file://', ''))) {\n        console.error('FATAL: Frontend index.html not found!');\n\n        // Show error dialog to user\n        const { dialog } = require('electron');\n        dialog.showErrorBox(\n          'Installation Error',\n          'The application frontend is missing. Please reinstall Fortuna Faucet.'\n        );\n        app.quit();\n        return;\n      }\n\n      console.log('[PROD MODE] Loading frontend from:', frontendUrl);\n      this.mainWindow.loadURL(frontendUrl);\n    }\n\n    // Handle window close - keep running in tray\n    this.mainWindow.on('close', (event) => {\n      if (!app.isQuitting) {\n        event.preventDefault();\n        this.mainWindow.hide();\n      }\n    });\n  }\n\n  createSystemTray() {\n    const iconPath = path.join(__dirname, 'assets', 'tray-icon.png');\n\n    // Create tray icon (with fallback if missing)\n    let icon;\n    if (fs.existsSync(iconPath)) {\n      icon = nativeImage.createFromPath(iconPath).resize({ width: 16, height: 16 });\n    } else {\n      console.warn('Tray icon not found, using default');\n      icon = nativeImage.createEmpty();\n    }\n\n    this.tray = new Tray(icon);\n\n    const contextMenu = Menu.buildFromTemplate([\n      {\n        label: 'Open Dashboard',\n        click: () => {\n          this.mainWindow.show();\n          this.mainWindow.focus();\n        }\n      },\n      { type: 'separator' },\n      {\n        label: 'Backend Status',\n        enabled: false\n      },\n      {\n        label: this.backendProcess && !this.backendProcess.killed ? '\u2705 Running' : '\u274c Stopped',\n        enabled: false\n      },\n      { type: 'separator' },\n      {\n        label: 'Exit',\n        click: () => {\n          app.isQuitting = true;\n          app.quit();\n        }\n      }\n    ]);\n\n    this.tray.setToolTip('Fortuna Faucet - Racing Analysis');\n    this.tray.setContextMenu(contextMenu);\n\n    // Double-click tray icon to show window\n    this.tray.on('double-click', () => {\n      this.mainWindow.show();\n      this.mainWindow.focus();\n    });\n  }\n\n  initialize() {\n    console.log('=== Fortuna Faucet Initializing ===');\n\n    // Create the window immediately\n    this.createMainWindow();\n    this.createSystemTray();\n\n    // Start the backend in parallel\n    this.startBackend();\n\n    // Set up IPC listener for restart command\n    ipcMain.on('restart-backend', (event) => {\n      console.log('Received restart-backend command from frontend.');\n      this.backendLogs.push('Restart command received. Attempting to restart backend...');\n      this.startBackend(); // This will kill the old process and start a new one\n    });\n\n    // Add a handler for the frontend to request the current status on load\n    ipcMain.handle('get-backend-status', async (event) => {\n      console.log('Received get-backend-status request from frontend.');\n      return {\n        state: this.backendState,\n        logs: this.backendLogs.slice(-20)\n      };\n    });\n\n    console.log('\u2705 Fortuna Faucet UI initialized. Backend starting in background...');\n  }\n\n  cleanup() {\n    console.log('Cleaning up processes...');\n\n    if (this.backendProcess && !this.backendProcess.killed) {\n      console.log('Stopping backend process...');\n      this.backendProcess.kill();\n    }\n  }\n}\n\nlet fortunaApp;\n\napp.whenReady().then(() => {\n  fortunaApp = new FortunaDesktopApp();\n  fortunaApp.initialize();\n});\n\n// macOS: re-create window when dock icon is clicked\napp.on('activate', () => {\n  if (BrowserWindow.getAllWindows().length === 0) {\n    fortunaApp.createMainWindow();\n  } else {\n    fortunaApp.mainWindow.show();\n  }\n});\n\n// Don't quit on window close (run in tray)\napp.on('window-all-closed', () => {\n  // On Windows/Linux, keep running in system tray\n  // On macOS, it's common to quit when all windows are closed\n  if (process.platform === 'darwin') {\n    app.quit();\n  }\n});\n\n// Clean up on quit\napp.on('before-quit', () => {\n  if (fortunaApp) {\n    fortunaApp.cleanup();\n  }\n});\n"
}