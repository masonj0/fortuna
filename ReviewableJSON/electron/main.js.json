{
    "file_path": "electron/main.js",
    "content": "// electron/main.js - CORRECTED VERSION\nconst { app, BrowserWindow, Tray, Menu, nativeImage, ipcMain } = require('electron');\nconst { spawn } = require('child_process');\nconst path = require('path');\nconst fs = require('fs');\nconst SecureSettingsManager = require('./secure-settings-manager');\n\nclass FortunaDesktopApp {\n  constructor() {\n    this.backendProcess = null;\n    this.mainWindow = null;\n    this.tray = null;\n    this.backendState = 'stopped'; // \"stopped\", \"starting\", \"running\", \"error\"\n    this.backendLogs = [];\n  }\n\n  sendBackendStatusUpdate() {\n    if (this.mainWindow) {\n      this.mainWindow.webContents.send('backend-status-update', {\n        state: this.backendState,\n        logs: this.backendLogs.slice(-20) // Send last 20 log entries\n      });\n    }\n  }\n\n  startBackend() {\n    this.backendState = 'starting';\n    this.backendLogs = ['Attempting to start backend process...'];\n    this.sendBackendStatusUpdate();\n\n    if (this.backendProcess && !this.backendProcess.killed) {\n      console.log('Backend process already running. Killing old process.');\n      this.backendProcess.kill();\n    }\n\n    const isDev = !app.isPackaged;\n    let backendCommand;\n    let backendArgs = [];\n    let backendCwd = process.cwd();\n\n    if (isDev) {\n      console.log('[DEV MODE] Configuring backend to run from Python venv...');\n      backendCommand = path.join(__dirname, '..', '.venv', 'Scripts', 'python.exe');\n      backendArgs = ['-m', 'uvicorn', 'api:app', '--host', '127.0.0.1', '--port', '8000'];\n      backendCwd = path.join(__dirname, '..', 'python_service');\n\n      if (!fs.existsSync(backendCommand)) {\n        const errorMsg = `FATAL: Python executable for dev not found at ${backendCommand}. Run setup first.`;\n        this.backendState = 'error';\n        this.backendLogs.push(errorMsg);\n        this.sendBackendStatusUpdate();\n        return;\n      }\n    } else {\n      console.log('[PROD MODE] Configuring backend to run from packaged executable...');\n      backendCommand = path.join(process.resourcesPath, 'fortuna-backend.exe');\n      if (!fs.existsSync(backendCommand)) {\n        const errorMsg = `FATAL: Backend executable missing at ${backendCommand}`;\n        console.error(errorMsg);\n        this.backendState = 'error';\n        this.backendLogs.push(errorMsg);\n        this.sendBackendStatusUpdate();\n        const { dialog } = require('electron');\n        dialog.showErrorBox(\n          'Backend Missing',\n          'The backend service is missing. Please reinstall Fortuna Faucet.'\n        );\n        return;\n      }\n    }\n\n    console.log(`Spawning backend: ${backendCommand} ${backendArgs.join(' ')}`);\n    this.backendProcess = spawn(backendCommand, backendArgs, {\n      cwd: backendCwd,\n      env: { ...process.env, HOST: '127.0.0.1', PORT: '8000' },\n      stdio: ['ignore', 'pipe', 'pipe']\n    });\n\n    // Common event handlers for the backend process\n    this.backendProcess.stdout.on('data', (data) => {\n      const output = data.toString().trim();\n      console.log(`[Backend] ${output}`);\n      this.backendLogs.push(output);\n\n      if (this.backendState !== 'running' && (output.includes('Uvicorn running') || output.includes('Application startup complete'))) {\n        console.log('\u2705 Backend is ready!');\n        this.backendState = 'running';\n      }\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.stderr.on('data', (data) => {\n      const errorOutput = data.toString().trim();\n      console.error(`[Backend ERROR] ${errorOutput}`);\n      this.backendLogs.push(`ERROR: ${errorOutput}`);\n      this.backendState = 'error';\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.on('error', (err) => {\n      const errorMsg = `FATAL: Failed to start backend process: ${err.message}`;\n      console.error(errorMsg);\n      this.backendLogs.push(errorMsg);\n      this.backendState = 'error';\n      this.sendBackendStatusUpdate();\n    });\n\n    this.backendProcess.on('exit', (code) => {\n      if (code !== 0 && this.backendState !== 'stopped') {\n        const errorMsg = `Backend process exited unexpectedly with code ${code}`;\n        console.error(errorMsg);\n        this.backendLogs.push(errorMsg);\n        this.backendState = 'error';\n        this.sendBackendStatusUpdate();\n      }\n    });\n  }\n\n  getFrontendPath() {\n    const isDev = !app.isPackaged;\n\n    if (isDev) {\n      return 'http://localhost:3000';\n    }\n\n    const indexPath = path.join(app.getAppPath(), 'web-ui-build', 'out', 'index.html');\n    return `file://${indexPath}`;\n  }\n\n  createMainWindow() {\n    this.mainWindow = new BrowserWindow({\n      width: 1600,\n      height: 1000,\n      title: 'Fortuna Faucet - Racing Analysis',\n      icon: path.join(__dirname, 'assets', 'icon.ico'),\n      webPreferences: {\n        nodeIntegration: false,\n        contextIsolation: true,\n        preload: path.join(__dirname, 'preload.js')\n      },\n      autoHideMenuBar: true,\n      backgroundColor: '#1a1a2e'\n    });\n\n    const frontendUrl = this.getFrontendPath();\n    this.mainWindow.loadURL(frontendUrl);\n\n    if (!app.isPackaged) {\n      this.mainWindow.webContents.openDevTools();\n    }\n\n    this.mainWindow.on('close', (event) => {\n      if (!app.isQuitting) {\n        event.preventDefault();\n        this.mainWindow.hide();\n      }\n    });\n  }\n\n  createSystemTray() {\n    // ... (rest of the file is unchanged)\n  }\n\n  initialize() {\n    this.createMainWindow();\n    this.createSystemTray();\n    this.startBackend();\n\n    ipcMain.on('restart-backend', () => this.startBackend());\n    ipcMain.handle('get-backend-status', async () => ({\n      state: this.backendState,\n      logs: this.backendLogs.slice(-20)\n    }));\n\n    ipcMain.handle('get-api-key', async () => {\n      return SecureSettingsManager.getApiKey();\n    });\n\n    ipcMain.handle('generate-api-key', async () => {\n      const crypto = require('node:crypto');\n      const newKey = crypto.randomBytes(16).toString('hex');\n      SecureSettingsManager.saveApiKey(newKey);\n      return newKey;\n    });\n\n    ipcMain.handle('save-api-key', async (event, apiKey) => {\n      return SecureSettingsManager.saveApiKey(apiKey);\n    });\n\n    ipcMain.handle('save-betfair-credentials', async (event, credentials) => {\n      return SecureSettingsManager.saveBetfairCredentials(credentials);\n    });\n  }\n\n  cleanup() {\n    if (this.backendProcess && !this.backendProcess.killed) {\n      this.backendProcess.kill();\n    }\n  }\n}\n\nlet fortunaApp;\n\napp.whenReady().then(() => {\n  fortunaApp = new FortunaDesktopApp();\n  fortunaApp.initialize();\n});\n\napp.on('window-all-closed', () => {\n  if (process.platform !== 'darwin') {\n    // Do nothing, keep app running in tray\n  }\n});\n\napp.on('activate', () => {\n  if (BrowserWindow.getAllWindows().length === 0) {\n    fortunaApp.createMainWindow();\n  } else {\n    fortunaApp.mainWindow.show();\n  }\n});\n\napp.on('before-quit', () => {\n  app.isQuitting = true;\n  if (fortunaApp) {\n    fortunaApp.cleanup();\n  }\n});\n"
}