# System Timestamp: 2025-12-21 14:04:35
name: ü§ñ Build Electron MSI (GPT-5 Edition - Fixed)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder
  BACKEND_DIR: 'web_service/backend'
  PYTHONUTF8: '1'

jobs:
  validate-environment:
    name: ‚úÖ Pre-flight Validation
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - name: Derive Build Metadata
        id: meta
        shell: pwsh
        run: |
          $semver = if ("${{ github.ref }}" -like 'refs/tags/v*') { "${{ github.ref }}" -replace 'refs/tags/v', '' } else { "0.0.${{ github.run_number }}" }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Append

  build-backend-service:
    name: 'üêç Build Backend Service (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: validate-environment
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "üõ°Ô∏è ACTIVATING X86 SAFE MODE"
            @(
              "numpy==1.23.5",
              "pandas==1.5.3",
              "greenlet==3.1.1",
              "scipy==1.10.1",
              "--only-binary=:all:"
            ) | Set-Content $file
            Write-Host "‚úÖ x86 constraints: numpy 1.23.5, pandas 1.5.3, greenlet 3.1.1, scipy 1.10.1"
          } else {
            New-Item $file -ItemType File -Force
            Write-Host "‚úÖ x64 build: no constraints needed"
          }
          "file=$file" | Out-File $env:GITHUB_OUTPUT -Append
      - name: üíæ Create required directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/data" -Force
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/json" -Force
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/adapters" -Force
      - name: üì¶ Install Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller==6.6.0 pywin32 -c ${{ steps.constraints.outputs.file }}
      - name: üèóÔ∏è Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean fortuna-backend-electron.spec
          Write-Host "‚úÖ Backend built for ${{ matrix.arch }}"
      - name: üß™ Verify Backend Works
        shell: pwsh
        run: |
          $process = Start-Process -FilePath "dist/fortuna-backend.exe" -NoNewWindow -PassThru
          Write-Host "Backend process started with PID: $($process.Id). Waiting 10 seconds..."
          Start-Sleep -Seconds 10
          Write-Host "10 seconds elapsed. Stopping process..."
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          Write-Host "Process stopped. Verification complete."
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: backend-service-${{ matrix.arch }}
          path: dist/fortuna-backend.exe

  build-frontend:
    name: üé® Build Web Frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: üî® Build
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out/

  build-electron-msi:
    name: 'üöÄ Build Electron MSI (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: [validate-environment, build-backend-service, build-frontend]
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/download-artifact@v4
        with:
          name: backend-service-${{ matrix.arch }}
          path: temp_backend
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: electron/out
      - name: 'üöö Stage Backend'
        shell: pwsh
        run: |
          $dest = "electron/resources/fortuna-backend"
          New-Item -ItemType Directory -Path $dest -Force
          Copy-Item -Path "temp_backend/*" -Destination $dest -Recurse -Force
      - name: ‚úÖ Verify backend staged for Electron
        shell: pwsh
        run: |
          Test-Path electron/resources/fortuna-backend/fortuna-backend.exe
      - name: 'üèóÔ∏è Build MSI'
        working-directory: electron
        shell: pwsh
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          npm ci

          # FIXED: Copy WiX template from root to where electron-builder expects it
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix }
          Copy-Item ../build_wix/Product_Electron.wxs build_wix/Product_Electron.wxs -Force
          Write-Host "‚úÖ WiX template staged successfully."

          $archFlag = if ($env:ARCH -eq 'x86') { '--ia32' } else { '--x64' }
          $name = "Fortuna-${{ matrix.arch }}-${{ needs.validate-environment.outputs.semver }}.msi"
          npx electron-builder --win msi $archFlag --publish never --config.extraMetadata.version="${{ needs.validate-environment.outputs.semver }}" --config.artifactName="$name"
      - name: 'üì§ Upload MSI'
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-msi-${{ matrix.arch }}
          path: electron/dist/*.msi

  smoke-test:
    name: 'üî• Smoke Test (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: [build-electron-msi]
    continue-on-error: true
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: üì• Download MSI
        uses: actions/download-artifact@v4
        with:
          name: fortuna-msi-${{ matrix.arch }}
          path: installer
      - name: üöÄ Install & Verify
        shell: pwsh
        run: |
          $msi = (Get-ChildItem "installer" -Filter "*.msi" -Recurse | Select -First 1).FullName
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /qn /L*v install.log" -Wait

          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { ${env:ProgramFiles} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          New-Item -Path "$installDir\data", "$installDir\json", "$installDir\logs" -ItemType Directory -Force | Out-Null
      - name: üö¶ Launch & Verify
        shell: pwsh
        run: |
          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { ${env:ProgramFiles} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          Start-Process -FilePath "$installDir\Fortuna Faucet.exe"

          Write-Host "Polling for backend process for up to 30 seconds..."
          $timeout = 30
          $startTime = Get-Date
          $child = $null
          while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
            $child = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue
            if ($child) {
              Write-Host "‚úÖ Backend process found!"
              break
            }
            Start-Sleep -Seconds 5
          }

          $parent = Get-Process -Name "Fortuna Faucet" -ErrorAction SilentlyContinue

          if (-not $parent) {
            throw "Main process 'Fortuna Faucet' not found!"
          }
          if (-not $child) {
            throw "Backend process 'fortuna-backend' not found after timeout!"
          }

          Write-Host "‚úÖ Both parent and child processes are running."
      - name: üßπ Cleanup
        if: always()
        run: |
          Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue
