name: ü§ñ Build Electron MSI (GPT-5 Edition - Fixed)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder
  BACKEND_DIR: 'web_service/backend'
  PYTHONUTF8: '1'

jobs:
  validate-environment:
    name: ‚úÖ Pre-flight Validation
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - name: Derive Build Metadata
        id: meta
        shell: pwsh
        run: |
          $semver = if ("${{ github.ref }}" -like 'refs/tags/v*') { "${{ github.ref }}" -replace 'refs/tags/v', '' } else { "0.0.${{ github.run_number }}" }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Append

  build-python-service:
    name: 'üêç Build Python Service (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: validate-environment
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
      - name: üì¶ Build Binary
        shell: pwsh
        run: |
          pip install --upgrade pip setuptools wheel
          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt
          pip install pyinstaller==6.6.0
          pyinstaller --noconfirm --onedir --clean --name fortuna-backend `
            --distpath ./final_dist --add-data "${{ env.BACKEND_DIR }};backend" `
            ${{ env.BACKEND_DIR }}/service_entry.py
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}
          path: final_dist/fortuna-backend/

  build-frontend:
    name: üé® Build Web Frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: üî® Build
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out/

  build-electron-msi:
    name: 'üöÄ Build Electron MSI (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: [validate-environment, build-python-service, build-frontend]
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/download-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}
          path: temp_backend
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: electron/out
      - name: üöö Stage Backend
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "electron/resources" -Force
          Copy-Item -Path "temp_backend/*" -Destination "electron/resources" -Recurse -Force
      - name: üèóÔ∏è Build MSI
        working-directory: electron
        shell: pwsh
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          npm ci
          $archFlag = if ($env:ARCH -eq 'x86') { '--ia32' } else { '--x64' }
          $name = "Fortuna-${{ matrix.arch }}-${{ needs.validate-environment.outputs.semver }}.msi"
          npx electron-builder --win msi $archFlag --publish never -c.extraMetadata.version="${{ needs.validate-environment.outputs.semver }}" -c.artifactName="$name"
      - name: üì§ Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-msi-${{ matrix.arch }}
          path: electron/dist/*.msi
