# System Timestamp: 2025-12-24 18:00:00
name: ðŸ¤– Build Electron MSI (GPT-5 Edition - Fixed)

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder
  BACKEND_DIR: 'web_service/backend'
  PYTHONUTF8: '1'

jobs:
  validate-environment:
    name: âœ… Pre-flight Validation
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - name: Derive Build Metadata
        id: meta
        shell: pwsh
        run: |
          $semver = if ("${{ github.ref }}" -like 'refs/tags/v*') { "${{ github.ref }}" -replace 'refs/tags/v', '' } else { "0.0.${{ github.run_number }}" }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Append

  build-python-service:
    name: 'ðŸ Build Python Service (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: validate-environment
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
      - name: ðŸ’¾ Create required directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/data" -Force
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/json" -Force
          New-Item -ItemType Directory -Path "${{ env.BACKEND_DIR }}/adapters" -Force

      - name: ðŸ“¦ Install Dependencies
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          $ErrorActionPreference = 'Stop'

          pip install --upgrade pip

          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "--- Using x86-specific requirements file ---"
            # Pre-install specific versions of packages with known good 32-bit wheels for Python 3.11
            # to avoid building from source which is failing for scipy.
            Write-Host "--- Pre-installing numpy, pandas, and scipy for x86 ---"
            pip install numpy==1.23.5 pandas==1.5.3 scipy==1.10.1
            $requirementsFile = "${{ env.BACKEND_DIR }}/requirements-x86.txt"
            # Install the rest of the requirements. Pip will skip already satisfied packages.
            pip install -r $requirementsFile
          } else {
            Write-Host "--- Using standard requirements file ---"
            $requirementsFile = "${{ env.BACKEND_DIR }}/requirements.txt"
            pip install -r $requirementsFile
          }

          pip install --upgrade "pyinstaller>=6.12" pywin32

          Write-Host "--- Final installed packages (pip list) ---"
          pip list

      - name: ðŸ Set up PYTHONPATH
        shell: pwsh
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PYTHONPATH set to ${{ github.workspace }}"

      - name: 'ðŸ©¹ Temporarily Rename Shadowing Directory'
        shell: pwsh
        run: |
          Rename-Item -Path "${{ env.BACKEND_DIR }}\json" -NewName "json_temp" -Force
          Write-Host "Temporarily renamed 'json' directory to avoid import shadowing."

      - name: 'ðŸ”¬ Pre-build Import Verification'
        id: verify-imports
        shell: pwsh
        run: |
          Write-Host "--- Verifying all critical modules can be imported before build ---"
          $modules = @(
              'structlog',
              'uvicorn',
              'fastapi',
              'starlette',
              'pydantic',
              'pydantic_settings',
              'sqlalchemy',
              'aiosqlite',
              'httpx',
              'redis',
              'slowapi',
              'limits',
              'web_service',
              'web_service.backend',
              'web_service.backend.api'
          )
          $ErrorActionPreference = "Continue"
          foreach ($module in $modules) {
              python -c "import $module; print('âœ… $module')"
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "âŒ Failed to import '$module'. This module is required for the application to run."
                  exit 1
              }
          }
          Write-Host "âœ… All critical modules imported successfully."

      - name: 'ðŸ©¹ Restore Shadowing Directory Name'
        if: always()
        shell: pwsh
        run: |
          if (Test-Path "${{ env.BACKEND_DIR }}\json_temp") {
            Rename-Item -Path "${{ env.BACKEND_DIR }}\json_temp" -NewName "json" -Force
            Write-Host "Restored 'json' directory name."
          } else {
            Write-Host "Skipping restore, 'json_temp' directory not found."
          }

      - name: 'ðŸ“¦ Build Executable'
        shell: pwsh
        run: |
          Write-Host "=== BUILDING EXECUTABLE WITH UVICORN HOOK ==="

          # Verify hooks directory exists
          $hooksDir = "fortuna-backend-hooks"
          if (!(Test-Path $hooksDir)) {
            Write-Error "âŒ CRITICAL: Hooks directory not found at $hooksDir"
            exit 1
          }
          Write-Host "âœ… Hooks directory confirmed: $(Resolve-Path $hooksDir)"

          # Verify hook file exists
          $hookFile = Join-Path $hooksDir "hook-uvicorn.py"
          if (!(Test-Path $hookFile)) {
            Write-Error "âŒ CRITICAL: Hook file not found at $hookFile"
            exit 1
          }
          Write-Host "âœ… Hook file confirmed: $(Resolve-Path $hookFile)"

          # Build with hooks directory
          $hooksPath = Resolve-Path $hooksDir
          Write-Host "Running PyInstaller with hooks from: $hooksPath"

          pyinstaller --noconfirm --clean --log-level INFO `
            --additional-hooks-dir="$hooksPath" `
            fortuna-backend-electron.spec

          if ($LASTEXITCODE -ne 0) {
            Write-Error "âŒ PyInstaller build failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "âœ… Build completed successfully"

      - name: 'ðŸ” Post-build Bundle Inspection'
        id: inspect-bundle
        shell: pwsh
        run: |
          $internalDir = "dist/fortuna-backend/_internal"
          if (!(Test-Path $internalDir)) {
              throw "âŒ CRITICAL: _internal directory not found after build. The bundle is incomplete."
          }

          Write-Host "âœ… Bundle directory structure verified"
          Write-Host ""
          Write-Host "--- Checking for critical modules ---"

          $modules_to_check = @(
              "structlog",
              "uvicorn",
              "fastapi",
              "starlette",
              "pydantic",
              "sqlalchemy",
              "httpx",
              "redis"
          )

          $found_all = $true
          foreach ($module in $modules_to_check) {
              $found = Get-ChildItem -Path $internalDir -Recurse -Filter "*$module*" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                  Write-Host "âœ… Found '$module' in bundle"
              } else {
                  Write-Error "âŒ CRITICAL: Did not find '$module' in the final bundle"
                  $found_all = $false
              }
          }

          Write-Host ""
          if (-not $found_all) {
              throw "One or more critical modules were not found in the PyInstaller bundle."
          }

          Write-Host "âœ… All critical modules verified in the final bundle"

      - name: ðŸ“¦ Download Tesseract OCR
        run: |
          Invoke-WebRequest -Uri https://digi.bib.uni-mannheim.de/tesseract/tesseract-ocr-w64-setup-5.4.0.20240606.exe -OutFile tesseract_installer.exe

      - name: ðŸ§ List dist directory
        shell: pwsh
        run: |
          Get-ChildItem -Path dist -Recurse

      - name: ðŸ” Sanity Check Executable
        shell: pwsh
        run: |
          dist/fortuna-backend/fortuna-backend.exe --help

      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}
          path: dist/fortuna-backend.exe

  build-frontend:
    name: ðŸŽ¨ Build Web Frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: ðŸ”¨ Build
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build
      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out/

  build-electron-msi:
    name: 'ðŸš€ Build Electron MSI (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: [validate-environment, build-python-service, build-frontend]
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - uses: actions/download-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}
          path: temp_backend
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: electron/out
      - name: 'ðŸšš Stage Backend'
        shell: pwsh
        run: |
          $dest = "electron/resources/fortuna-backend"
          New-Item -ItemType Directory -Path $dest -Force
          Copy-Item -Path "temp_backend/*" -Destination $dest -Recurse -Force
      - name: âœ… Verify backend staged for Electron
        shell: pwsh
        run: |
          Test-Path electron/resources/fortuna-backend/fortuna-backend.exe
      - name: 'ðŸ—ï¸ Build MSI'
        working-directory: electron
        shell: pwsh
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          npm ci
          $archFlag = if ($env:ARCH -eq 'x86') { '--ia32' } else { '--x64' }
          $name = "Fortuna-${{ matrix.arch }}-${{ needs.validate-environment.outputs.semver }}.msi"
          npx electron-builder --win msi $archFlag --publish never --config.extraMetadata.version="${{ needs.validate-environment.outputs.semver }}" --config.artifactName="$name"
      - name: 'ðŸ“¤ Upload MSI'
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-msi-${{ matrix.arch }}
          path: electron/dist/*.msi


      - name: 'ðŸ” Verify PyInstaller Bundle'
        shell: pwsh
        run: |
          $exe = "dist/fortuna-backend/fortuna-backend.exe"
          $internalDir = "dist/fortuna-backend/_internal"

          Write-Host "Checking: $exe"
          if (!(Test-Path $exe)) {
            throw "Executable not found!"
          }
          Write-Host "âœ… Executable exists"

          Write-Host "Checking: $internalDir"
          if (!(Test-Path $internalDir)) {
            throw "Dependencies not bundled!"
          }
          Write-Host "âœ… Dependencies folder exists"

          # Check for key modules
          $keyModules = @("uvicorn", "fastapi", "starlette", "pydantic")
          foreach ($module in $keyModules) {
            $modulePath = Join-Path $internalDir $module
            if (Test-Path $modulePath) {
              Write-Host "âœ… Found $module"
            } else {
              Write-Host "âš ï¸  Missing $module - might fail at runtime"
            }
          }

          # Try to run --help
          Write-Host "Testing executable..."
          & $exe --help 2>&1 | Select-Object -First 10

          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Executable failed with code $LASTEXITCODE"
            Write-Host "This might be OK if it's just --help not being recognized"
          }

  smoke-test:
    name: 'ðŸ”¬ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: build-electron-msi
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: 'ðŸ“¥ Download MSI'
        uses: actions/download-artifact@v4
        with:
          name: fortuna-msi-${{ matrix.arch }}
          path: msi-installer
      - name: 'ðŸ”¥ Install & Verify'
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) { throw "MSI not found!" }

          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait

          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"

      - name: 'âœ… Create Required Runtime Directories Post-Install'
        shell: pwsh
        run: |
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          if (! (Test-Path $installDir)) {
            Write-Error "Installation directory not found at $installDir."
            exit 1
          }
          New-Item -Path "$installDir\\data" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installDir\\json" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installDir\\logs" -ItemType Directory -Force | Out-Null
          Write-Host "âœ… Created runtime directories (data, json, logs) in '$installDir'."

      - name: 'ðŸ”¬ Debug: Run Backend Directly'
        shell: pwsh
        continue-on-error: true
        run: |
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          $backendExe = Join-Path $installDir "resources/fortuna-backend/fortuna-backend.exe"

          if (Test-Path $backendExe) {
            Write-Host "Attempting to run backend directly for 10 seconds..."
            $process = Start-Process -FilePath $backendExe -NoNewWindow -PassThru
            Start-Sleep -Seconds 10
            Stop-Process -Id $process.Id -Force
            Write-Host "Backend process stopped."
          } else {
            Write-Error "Backend executable not found at $backendExe"
          }

      - name: 'ðŸš€ Launch & Verify'
        shell: pwsh
        run: |
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"

          Start-Process -FilePath "$installDir\\Fortuna Faucet.exe"
          Start-Sleep -Seconds 15

          $parent = Get-Process -Name "Fortuna Faucet" -ErrorAction SilentlyContinue
          $child = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue

          if (-not $parent) { throw "Main process 'Fortuna Faucet' not found!" }
          if (-not $child) { throw "Backend process 'fortuna-backend' not found!" }

          Write-Host "âœ… Smoke test passed! Both processes are running."

      - name: 'ðŸ“¸ Paparazzi (Visual Proof)'
        continue-on-error: true
        shell: pwsh
        run: |
          $url = "http://127.0.0.1:8000" # The backend serves the UI from this port
          Write-Host "Waiting for URL: $url"
          $maxRetries = 10
          $delay = 3
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… URL is accessible. Proceeding with screenshot."
                break
              }
            } catch {
              Write-Warning "Attempt ${i}: URL not accessible yet. Retrying in $delay seconds..."
              Start-Sleep -Seconds $delay
            }
            if ($i -eq $maxRetries) {
              throw "âŒ URL did not become accessible after $maxRetries attempts."
            }
          }

          npm install playwright
          npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => { const browser = await chromium.launch(); const page = await browser.newPage(); try { await page.goto('$url', {timeout: 15000}); await page.screenshot({ path: 'proof.png' }); } catch(e) { console.error(e); process.exit(1); } await browser.close(); })();"

      - name: 'ðŸ“¤ Upload Visual Proof'
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-proof-${{ matrix.arch }}
          path: proof.png

      - name: 'ðŸ§¹ Cleanup'
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue
