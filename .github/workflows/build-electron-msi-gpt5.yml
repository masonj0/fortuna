# System Timestamp: 2025-11-29 13:19:26.933797
name: ğŸ”¨ Build Electron MSI Installer (Production)

on:
  push:
    branches:
      - main
      - session/jules1130
  workflow_dispatch:

concurrency:
  group: build-electron-msi-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder
  BACKEND_DIR: 'python_service'
  PYTHONUTF8: '1'

jobs:
  validate-environment:
    name: âœ… Pre-flight Validation
    runs-on: windows-latest
    timeout-minutes: 5
    outputs:
      node_version: ${{ steps.versions.outputs.node }}
      python_version: ${{ steps.versions.outputs.python }}
      build_id: ${{ steps.versions.outputs.build_id }}
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Verify Critical Files Exist
        shell: pwsh
        run: |
          $criticalFiles = @(
            'fortuna-backend-electron.spec',
            'electron/electron-builder-config.yml',
            'web_platform/frontend/package.json',
            '${{ env.BACKEND_DIR }}/requirements-dev.txt',
            'electron/package.json'
          )

          $manifest = @{
            timestamp = Get-Date -Format 'o'
            checks = @()
            errors = @()
          }

          foreach ($file in $criticalFiles) {
            if (Test-Path -LiteralPath $file) {
              $hash = (Get-FileHash -LiteralPath $file -Algorithm SHA256).Hash
              $manifest.checks += @{
                file = $file
                exists = $true
                sha256 = $hash
              }
              Write-Host "âœ“ $file ($hash.Substring(0,8)...)"
            } else {
              $manifest.errors += @{ file = $file; error = 'MISSING' }
              Write-Error "âœ— CRITICAL: $file not found"
              exit 1
            }
          }

          $manifest | ConvertTo-Json | Out-File -FilePath ".\validation-manifest.json"
          Write-Host "Manifest saved"

      - name: ğŸ“Š Capture Version Information
        id: versions
        shell: pwsh
        run: |
          $nodeVersion = node --version
          $pythonVersion = python --version
          $buildId = "${{ github.run_id }}-${{ github.run_attempt }}"

          Write-Host "Node: $nodeVersion"
          Write-Host "Python: $pythonVersion"
          Write-Host "Build ID: $buildId"

          "node=$nodeVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "python=$pythonVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_id=$buildId" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: ğŸš¨ Capture Environment State
        if: always()
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "debug-artifacts" -Force | Out-Null

          # System info
          systeminfo | Out-File "debug-artifacts/systeminfo.txt"
          Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object Caption, Version, BuildNumber | Out-File "debug-artifacts/os-version.txt"

          # Disk space
          Get-Volume | Out-File "debug-artifacts/disk-space.txt"

          # File permissions
          Get-ChildItem -Recurse -Include "*.yml", "*.spec", "*.json" -ErrorAction SilentlyContinue |
            ForEach-Object { "{0} {1}" -f $_.FullName, $_.Length } |
            Out-File "debug-artifacts/file-manifest.txt"

      - name: ğŸ“¤ Upload Validation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-${{ github.run_id }}
          path: |
            validation-manifest.json
            debug-artifacts/
          retention-days: 14

  build-python-service:
    name: ğŸ Build Python Service Bundle
    runs-on: windows-latest
    timeout-minutes: 20
    needs: validate-environment
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Python Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt
          Write-Host "âœ“ Python dependencies installed"

      - name: ğŸ”¨ Build Python Service with PyInstaller
        shell: pwsh
        run: |
          $specFile = 'fortuna-backend-electron.spec'

          if (-not (Test-Path $specFile)) {
            Write-Error "Spec file not found: $specFile"
            exit 1
          }

          pyinstaller `
            --distpath ".\dist\service" `
            --workpath ".\build\service" `
            --clean `
            $specFile

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller failed with code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

          $serviceExe = Get-ChildItem -Path ".\dist\service" -Filter "*.exe" | Select-Object -First 1
          if ($null -eq $serviceExe) {
            Write-Error "No executable generated by PyInstaller"
            exit 1
          }

          Write-Host "âœ“ Service executable: $($serviceExe.FullName) ($('{0:N0}' -f $serviceExe.Length) bytes)"

      - name: ğŸ§ª Verify Service Executable
        shell: pwsh
        run: |
          $serviceExe = Get-ChildItem -Path ".\dist\service" -Filter "*.exe" | Select-Object -First 1

          if ($null -eq $serviceExe) {
            Write-Error "Service executable not found"
            exit 1
          }

          # Verify it's a valid PE executable
          $bytes = [System.IO.File]::ReadAllBytes($serviceExe.FullName)
          if ($bytes[0] -ne 0x4D -or $bytes[1] -ne 0x5A) {
            Write-Error "Invalid PE executable signature"
            exit 1
          }

          Write-Host "âœ“ Service executable is valid PE binary"

      - name: ğŸ“¤ Upload Service Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-service-${{ needs.validate-environment.outputs.build_id }}
          path: dist/service/
          retention-days: 1

      - name: ğŸš¨ Upload Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: python-build-failure-logs-${{ needs.validate-environment.outputs.build_id }}
          path: |
            build/service/
            spec-working/
          retention-days: 30

  build-frontend:
    name: ğŸ¨ Build Web Frontend
    runs-on: windows-latest
    timeout-minutes: 15
    needs: validate-environment
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package.json'

      - name: ğŸ“¥ Install Frontend Dependencies
        shell: pwsh
        working-directory: web_platform/frontend
        run: |
          npm ci --prefer-offline --no-audit
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm ci failed"
            exit 1
          }
          npm list --depth=0

      - name: ğŸ”¨ Build Frontend
        shell: pwsh
        working-directory: web_platform/frontend
        run: |
          npm run build 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed"
            exit 1
          }

          $outDir = Get-Item -Path ".\out" -ErrorAction SilentlyContinue
          if ($null -eq $outDir) {
            Write-Error "No out/ directory generated"
            exit 1
          }

          $fileCount = (Get-ChildItem -Recurse -Path ".\out" | Measure-Object).Count
          Write-Host "âœ“ Frontend built: $fileCount files"

      - name: ğŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ needs.validate-environment.outputs.build_id }}
          path: web_platform/frontend/out/
          retention-days: 1

      - name: ğŸš¨ Upload Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-failure-logs-${{ needs.validate-environment.outputs.build_id }}
          path: |
            web_platform/frontend/.next/
            web_platform/frontend/npm-debug.log
          if-no-files-found: ignore
          retention-days: 30

  build-electron-msi:
    name: ğŸš€ Build Electron MSI Package
    runs-on: windows-latest
    timeout-minutes: 30
    needs: [validate-environment, build-python-service, build-frontend]
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'electron/package.json'

      - name: ğŸ“¥ Download Python Service
        uses: actions/download-artifact@v4
        with:
          name: python-service-${{ needs.validate-environment.outputs.build_id }}
          path: python-service-bin

      - name: ğŸ“¥ Download Frontend Dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ needs.validate-environment.outputs.build_id }}
          path: web_platform/frontend/out

      - name: ğŸ“¥ Install Electron Dependencies
        shell: pwsh
        working-directory: electron
        run: |
          npm ci --prefer-offline --no-audit
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm ci failed"
            exit 1
          }

      - name: ğŸ” Verify electron-builder Config
        shell: pwsh
        run: |
          $configPath = 'electron/electron-builder-config.yml'

          if (-not (Test-Path $configPath)) {
            Write-Error "electron-builder config not found: $configPath"
            exit 1
          }

          # Basic YAML syntax check (non-exhaustive)
          $content = Get-Content $configPath -Raw
          if ($content -notmatch 'appId:') {
            Write-Error "Invalid electron-builder config: missing appId"
            exit 1
          }

          Write-Host "âœ“ electron-builder config valid"

      - name: ğŸ”¨ Build Electron Application
        shell: pwsh
        working-directory: electron
        run: |
          # Set code signing to false for CI (unless you have signing certificates)
          $env:CSC_IDENTITY_AUTO_DISCOVERY = 'false'

          npm run build -- --publish never 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Electron build failed"
            exit 1
          }

          Write-Host "âœ“ Electron build completed"

      - name: ğŸ—ï¸ Build MSI with electron-builder
        shell: pwsh
        working-directory: electron
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          npm run dist -- --win msi --publish never 2>&1

          if ($LASTEXITCODE -ne 0) {
            Write-Error "electron-builder MSI creation failed"
            exit 1
          }

          Write-Host "âœ“ MSI build completed"

      - name: ğŸ” Verify MSI Output
        shell: pwsh
        run: |
          $msiFiles = Get-ChildItem -Recurse -Filter "*.msi" -ErrorAction SilentlyContinue

          if ($msiFiles.Count -eq 0) {
            Write-Error "No MSI files generated"
            exit 1
          }

          foreach ($msi in $msiFiles) {
            $sizeGB = $msi.Length / 1GB
            $sizeMB = $msi.Length / 1MB

            if ($msi.Length -lt 10MB) {
              Write-Warning "MSI suspiciously small: $($msi.Name) ($('{0:N1}' -f $sizeMB) MB)"
            }

            Write-Host "âœ“ MSI: $($msi.FullName) ($('{0:N1}' -f $sizeMB) MB)"

            # Generate checksum
            $hash = (Get-FileHash -LiteralPath $msi.FullName -Algorithm SHA256).Hash
            Write-Host "  SHA256: $hash"
            $hash | Out-File -FilePath "$($msi.FullName).sha256"
          }

      - name: ğŸ“¦ Stage Artifacts for Release
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "release-artifacts" -Force | Out-Null

          Get-ChildItem -Filter "*.msi" -Recurse | ForEach-Object {
            Copy-Item -LiteralPath $_.FullName -Destination "release-artifacts/"
            Copy-Item -LiteralPath "$($_.FullName).sha256" -Destination "release-artifacts/" -ErrorAction SilentlyContinue
          }

          Get-ChildItem -Path "release-artifacts/" | Out-Host

      - name: ğŸ“Š Generate Build Report
        if: always()
        shell: pwsh
        run: |
          $report = @{
            build_id = '${{ needs.validate-environment.outputs.build_id }}'
            timestamp = Get-Date -Format 'o'
            status = if ($LASTEXITCODE -eq 0) { 'SUCCESS' } else { 'FAILED' }
            node_version = '${{ needs.validate-environment.outputs.node_version }}'
            python_version = '${{ needs.validate-environment.outputs.python_version }}'
            msi_files = @()
          }

          Get-ChildItem -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            $report.msi_files += @{
              path = $_.FullName
              size_mb = [math]::Round($_.Length / 1MB, 2)
              hash = (Get-FileHash -LiteralPath $_.FullName -Algorithm SHA256).Hash
            }
          }

          $report | ConvertTo-Json | Out-File -FilePath "build-report.json"
          Get-Content "build-report.json" | Out-Host

      - name: ğŸ“¤ Upload Release Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-electron-msi-${{ needs.validate-environment.outputs.build_id }}
          path: release-artifacts/
          retention-days: 90

      - name: ğŸš¨ Upload Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-logs-${{ needs.validate-environment.outputs.build_id }}
          path: |
            electron/dist/
            python-service-bin/
            web_platform/frontend/out/
            build-report.json
          retention-days: 30

  smoke-test:
    name: 'ğŸ”¬ Smoke Test (Install & Launch)'
    runs-on: windows-latest
    timeout-minutes: 15
    needs:
      - build-electron-msi
      - diagnose-asgi-imports
    steps:
      - name: ğŸ“¥ Download MSI Installer
        uses: actions/download-artifact@v4
        with:
          name: fortuna-electron-msi-${{ needs.validate-environment.outputs.build_id }}
          path: msi-installer

      - name: ğŸ¤« Install MSI Silently
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" | Select-Object -First 1
          if ($null -eq $msi) {
            Write-Error "MSI file not found in artifact"
            exit 1
          }

          # Start the installer and wait for it to finish
          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn" -Wait

          # Crude check to see if installation was likely successful
          $installDir = "C:\Program Files\Fortuna Faucet"
          if (-not (Test-Path "$installDir\Fortuna Faucet.exe")) {
            Write-Error "Application executable not found after installation"
            exit 1
          }
          Write-Host "âœ… Application appears to be installed"

      - name: ğŸ—ï¸ Create Runtime Directories
        shell: pwsh
        run: |
          $installDir = "C:\Program Files\Fortuna Faucet"
          New-Item -ItemType Directory -Path "$installDir\data" -Force | Out-Null
          New-Item -ItemType Directory -Path "$installDir\json" -Force | Out-Null
          New-Item -ItemType Directory -Path "$installDir\logs" -Force | Out-Null
          Write-Host "âœ… Created runtime directories in $installDir"

      - name: ğŸš€ Launch Application & Verify Process
        shell: pwsh
        run: |
          $exePath = "C:\Program Files\Fortuna Faucet\Fortuna Faucet.exe"

          # Start the main application
          Start-Process -FilePath $exePath

          # Give it a moment to initialize
          Start-Sleep -Seconds 15

          # Check if the main Electron process and the Python backend are running
          $electronProc = Get-Process -Name "Fortuna Faucet" -ErrorAction SilentlyContinue
          $backendProc = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue

          if ($null -eq $electronProc) {
            Write-Error "Electron process 'Fortuna Faucet.exe' is not running."
            exit 1
          }

          if ($null -eq $backendProc) {
            Write-Error "Backend process 'fortuna-backend.exe' is not running."
            exit 1
          }

          Write-Host "âœ… Electron main process (PID: $($electronProc.Id)) is running."
          Write-Host "âœ… Python backend process (PID: $($backendProc.Id)) is running."

      - name: ğŸ§¹ Cleanup Processes
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "Fortuna Faucet" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "fortuna-backend" -Force -ErrorAction SilentlyContinue
          Write-Host "ğŸ§¹ Cleanup complete"

  diagnose-asgi-imports:
    name: 'ğŸ” ASGI Import Killer (Pre-Smoke Diagnostic)'
    runs-on: windows-latest
    timeout-minutes: 15
    needs: build-python-service
    env:
      PYTHONUTF8: '1'
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ Setup Python (EXACT VERSION)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“‹ Capture Python Info
        run: |
          Set-StrictMode -Version Latest
          Write-Host "Python executable: $(which python)" -ForegroundColor Cyan
          python --version
          python -m site
          python -c "import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)"

      - name: ğŸ“¥ Install Requirements (Exactly as Backend Build)
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel --quiet

          Write-Host "Installing requirements.txt..." -ForegroundColor Cyan
          pip install -r "${{ env.BACKEND_DIR }}/requirements.txt" -v 2>&1 | Tee-Object "install-requirements.log"

          if (Test-Path "${{ env.BACKEND_DIR }}/requirements-dev.txt") {
            Write-Host "Installing requirements-dev.txt..." -ForegroundColor Cyan
            pip install -r "${{ env.BACKEND_DIR }}/requirements-dev.txt" -v 2>&1 | Tee-Object -Append "install-requirements.log"
          }

          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ pip install failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "âœ… All dependencies installed" -ForegroundColor Green

      - name: ğŸ“¦ Capture Installed Packages
        run: |
          pip list | Tee-Object "installed-packages.txt"
          pip freeze | Tee-Object "pip-freeze.txt"

      - name: ğŸ Set PYTHONPATH
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PYTHONPATH set to ${{ github.workspace }}"

      - name: ğŸ§ª PHASE 1 System Imports
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 1 SYSTEM-LEVEL IMPORTS")',
            'print("="*80)',
            'modules = [',
            "    ('os', 'filesystem'), ('sys', 'system'), ('json', 'serialization'),",
            "    ('asyncio', 'async I/O'), ('pathlib', 'paths'), ('typing', 'type hints'),",
            "    ('importlib', 'import utilities')",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:20} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:20} ImportError: {e}")',
            '        failed.append(mod_name)',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} system imports failed")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 1 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 2 Web Framework Core
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'print("\n" + "="*80)',
            'print("PHASE 2 WEB FRAMEWORK CORE")',
            'print("="*80)',
            'modules = [',
            "    ('fastapi', 'web framework'),",
            "    ('uvicorn', 'ASGI server'),",
            "    ('starlette', 'ASGI toolkit'),",
            "    ('starlette.applications', 'ASGI app'),",
            "    ('starlette.routing', 'routing'),",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:30} ImportError: {e}")',
            '        failed.append((mod_name, str(e)))',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} {type(e).__name__}: {e}")',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} core framework imports failed")',
            '    for mod, err in failed:',
            '        print(f"  - {mod}")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 2 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 3 Pydantic & Data Validation
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 3 PYDANTIC & DATA VALIDATION")',
            'print("="*80)',
            'modules = [',
            "    ('pydantic', 'validation'),",
            "    ('pydantic_core', 'core'),",
            "    ('pydantic_settings', 'settings'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 3 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 4 Async/IO Utilities
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 4 ASYNC/IO UTILITIES")',
            'print("="*80)',
            'modules = [',
            "    ('anyio', 'async compat'),",
            "    ('httpcore', 'HTTP core'),",
            "    ('httpx', 'HTTP client'),",
            "    ('aiosqlite', 'async DB'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 4 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 5 Optional Dependencies (non-critical)
        continue-on-error: true
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 5 OPTIONAL DEPENDENCIES (non-critical)")',
            'print("="*80)',
            'modules = [',
            "    ('slowapi', 'rate limiting'),",
            "    ('structlog', 'logging'),",
            "    ('tenacity', 'retries'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} not critical: {type(e).__name__}")',
            'print(f"\nâœ… Phase 5 complete (warnings OK)")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 6 Application Directory Structure
        run: |
          Set-StrictMode -Version Latest

          $script = @(
            'import os',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 6 APPLICATION DIRECTORY STRUCTURE")',
            'print("="*80)',
            'cwd = Path.cwd()',
            'python_service = cwd / "python_service"',
            'print(f"\nCurrent directory: {cwd}")',
            'print(f"\npython_service exists: {python_service.exists()}")',
            'if python_service.exists():',
            '    print(f"  Contents:")',
            '    for item in python_service.iterdir():',
            '        print(f"    - {item.name}")',
            '    main_py = python_service / "main.py"',
            '    api_py = python_service / "api.py"',
            '    print(f''\n  main.py: {main_py.stat().st_size if main_py.exists() else "N/A"} bytes'')',
            '    print(f''  api.py: {api_py.stat().st_size if api_py.exists() else "N/A"} bytes'')'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 7 CRITICAL - Application Module Imports
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)")',
            'print("="*80)',
            'print("\n[Step 1] Importing python_service...")',
            'try:',
            '    import python_service',
            '    print(f"âœ… python_service imported")',
            '    print(f"   Location: {python_service.__file__}")',
            'except Exception as e:',
            '    print(f"âŒ FATAL: python_service import failed")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print(''\\n[Step 2] Retrieving "app" object from main...'')',
            'try:',
            '    from python_service.main import app',
            '    print(f"âœ… app object retrieved")',
            '    print(f"   Type: {type(app)}")',
            '    print(f"   Class: {app.__class__.__name__}")',
            '    print(f"   Module: {app.__class__.__module__}")',
            'except Exception as e:',
            '    print(f"âŒ FATAL: Could not get app object")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print("\n" + "="*80)',
            'print("âœ… ALL APPLICATION IMPORTS SUCCESSFUL")',
            'print("="*80)',
            'print("\nThe ASGI app is fully importable.")',
            'print("Uvicorn should be able to load it successfully.")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ APPLICATION IMPORT TEST FAILED" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ“‹ Generate ASGI Diagnostic Report
        if: always()
        run: |
          Set-StrictMode -Version Latest
          $report = @()
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report += "â•‘              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        â•‘"
          $report += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          $report += ""
          $report += "Timestamp: $(Get-Date -Format 'o')"
          $report += "Python: $(python --version)"
          $report += ""
          $report += "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          $result = if ($LASTEXITCODE -eq 0) { 'PASS âœ…' } else { 'FAIL âŒ' }
          $report += "â”‚ RESULT: $result â”‚"
          $report += "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          $report += ""
          $report += "If this passed:"
          $report += "  âœ… All required dependencies are installed"
          $report += "  âœ… python_service.main is importable"
          $report += "  âœ… FastAPI app is accessible"
          $report += "  âœ… The executable should work"
          $report += "  âœ… Uvicorn WILL be able to load the app"
          $report += ""
          $report += "If this failed:"
          $report += "  âŒ See error output above for the exact problem"
          $report += "  âŒ Fix the import error in your code"
          $report += "  âŒ Common issues:"
          $report += "     - Missing dependency in requirements.txt"
          $report += "     - Syntax error in main.py"
          $report += "     - Circular import in main.py"
          $report += "     - main.py imports a module that fails"
          $report += ""
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report | Tee-Object "asgi-diagnostic-report.txt"

      - name: ğŸ“¤ Upload Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asgi-import-diagnostics-electron-${{ github.run_id }}
          path: |
            install-requirements.log
            installed-packages.txt
            pip-freeze.txt
            asgi-diagnostic-report.txt
          retention-days: 30
          if-no-files-found: warn
