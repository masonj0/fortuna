name: Build Fortuna Faucet MSI Installer - [PROD]

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  build-frontend:
    name: '[BUILD] Frontend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'

      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: frontend-build-output
          path: web_platform/frontend/out
          retention-days: 1

  build-backend:
    name: '[BUILD] Backend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7

      - name: Setup Python
        uses: actions/setup-python@v5.1.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'

      - name: '[MONITOR] Verify Source Code Integrity'
        shell: pwsh
        run: |
          Write-Host "--- Verifying contents of run_backend.py ---" -ForegroundColor Cyan
          Get-Content run_backend.py | Write-Host
          Write-Host "--- End of file ---" -ForegroundColor Cyan

      - name: '[MONITOR] Pre-flight Syntax Check'
        shell: pwsh
        run: |
          Write-Host "--- Running Python syntax pre-flight check ---" -ForegroundColor Cyan
          python -m py_compile run_backend.py
          Write-Host "[OK] Syntax check passed." -ForegroundColor Green

      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r python_service/requirements.txt

      - name: Backend - Security Audit
        shell: pwsh
        run: |
          pip install pip-audit
          $ignoreFlags = @()
          if (Test-Path "audit-ignore.txt") {
              Get-Content "audit-ignore.txt" | ForEach-Object {
                  $line = $_.Trim()
                  if ($line -and !$line.StartsWith("#")) {
                      $ignoreFlags += "--ignore-vuln", $line
                  }
              }
          }
          pip-audit -r python_service/requirements.txt @ignoreFlags

      - name: Backend - Build with PyInstaller (Hardened with Retries)
        shell: pwsh
        run: |
          $adaptersPath = (Resolve-Path -Path "python_service/adapters").Path.Replace('\', '/')
          (Get-Content -Path "fortuna-backend.spec.template" -Raw) -replace '__ADAPTERS_PATH__', $adaptersPath | Set-Content -Path "fortuna-backend.spec" -Encoding UTF8

          # --- HARDENED RETRY LOGIC ---
          # This loop mitigates race conditions with Windows security scanners that can
          # temporarily lock the output .exe file during the build process.
          $maxRetries = 3
          $success = $false
          for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
              Write-Host "--- PyInstaller Build Attempt $attempt of $maxRetries ---" -ForegroundColor Yellow
              pyinstaller fortuna-backend.spec --distpath dist --workpath build --clean --noconfirm
              if ($LASTEXITCODE -eq 0) {
                  $success = $true
                  Write-Host "[OK] PyInstaller build succeeded on attempt $attempt." -ForegroundColor Green
                  break
              } else {
                  Write-Host "[WARN] PyInstaller attempt $attempt failed. Waiting 10 seconds before retry..." -ForegroundColor Yellow
                  Start-Sleep -Seconds 10
              }
          }
          if (-not $success) {
              throw "[FATAL] PyInstaller build failed after $maxRetries attempts."
          }

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: backend-executable
          path: dist/fortuna-backend.exe
          retention-days: 1

  package-and-test:
    name: '[PACKAGE] Package & Test Installer'
    needs: [build-frontend, build-backend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7

      - name: Setup Node.js for Electron
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4.1.8
        with:
          name: frontend-build-output
          path: electron/web-ui-build/out

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4.1.8
        with:
          name: backend-executable
          path: electron/resources/fortuna-backend

      - name: Critical Integration Test
        shell: pwsh
        run: |
          $exe = "./electron/resources/fortuna-backend/fortuna-backend.exe"
          $process = Start-Process -FilePath $exe -PassThru -NoNewWindow
          $serverReady = $false
          Write-Host "--- Starting Integration Test: Polling /health endpoint for 60s ---"
          foreach ($i in 1..30) {
            if ($process.HasExited) {
              throw "[FATAL] Backend process crashed immediately on startup. Exit Code: $($process.ExitCode)"
            }
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/health" -TimeoutSec 1 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "[OK] Health check passed on attempt $i!"
                $serverReady = $true
                break
              }
            } catch {
              Write-Host "Attempt $i... server not ready."
            }
            Start-Sleep -Seconds 2
          }
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          if (-not $serverReady) {
            throw "[FATAL] Backend integration test failed. Server never became healthy."
          }

      - name: Electron - Install & Package MSI
        shell: pwsh
        run: |
          cd electron
          npm ci
          npx electron-builder --config electron-builder-config.yml --publish never

      - name: Upload Final MSI Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: fortuna-installer-windows
          path: electron/dist/*.msi
          retention-days: 7
