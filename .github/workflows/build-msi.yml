name: Build Fortuna Faucet MSI Installer - üèÜ PRODUCTION FORTRESS

# Manually deactivated by setting a trigger that will never fire.
# This keeps the workflow file valid but prevents it from running automatically.
# Preserved for reference by JB's request on 2025-11-23.
on:
  push:
    branches:
      - 'deactivated/do-not-run'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  build-frontend:
    name: 'üì¶ Build Frontend'
    timeout-minutes: 15
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm audit --audit-level=moderate # Added security check
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          $outDir = 'web_platform/frontend/out'
          if (-not (Test-Path $outDir)) {
            Write-Host "‚ùå FATAL: Build output directory 'out' not created" -ForegroundColor Red
            exit 1
          }
          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: Build output directory is empty" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Frontend build verified ($fileCount files)" -ForegroundColor Green
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-output-${{ github.sha }}
          path: web_platform/frontend/out
          retention-days: 1

  build-backend:
    name: 'üêç Build Backend'
    timeout-minutes: 20
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'
      - name: '‚úÖ [MONITOR] Ensure Required Directories Exist'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "python_service/adapters" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/json" -Force | Out-Null
          Write-Host "‚úÖ Ensured required data, json, and adapters directories exist."
      - name: '‚úÖ [MONITOR] Verify Critical Files'
        shell: pwsh
        run: |
          if (-not (Test-Path "python_service/main.py")) { throw "‚ùå FATAL: python_service/main.py not found" }
          Write-Host "‚úÖ Critical files verified."
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r python_service/requirements-dev.txt
      - name: Backend - Security Audit
        shell: pwsh
        run: |
          pip-audit -r python_service/requirements.txt --local
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller fortuna-backend-electron.spec --noconfirm
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: dist/fortuna-backend.exe
          retention-days: 1
          if-no-files-found: error

  smoke-test-service:
    name: 'üß™ Smoke Test Service (Backend + Frontend)'
    timeout-minutes: 15
    needs: [build-backend, build-frontend]
    runs-on: windows-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: Stage Files
        shell: pwsh
        run: |
          Get-ChildItem -Path ./artifacts -Recurse
          Move-Item -Path "./artifacts/backend-executable-${{ github.sha }}/fortuna-backend.exe" -Destination "./fortuna-backend.exe"
          New-Item -ItemType Directory -Path "./frontend" -Force
          Move-Item -Path "./artifacts/frontend-build-output-${{ github.sha }}/*" -Destination "./frontend"
      - name: Run Backend and Frontend
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test"
          FORTUNA_PORT: 8000
        run: |
          $backendLog = "backend.log"
          $frontendLog = "frontend.log"
          Start-Process -FilePath "./fortuna-backend.exe" -RedirectStandardOutput $backendLog -RedirectStandardError $backendLog
          Push-Location ./frontend
          Start-Process python -ArgumentList "-m http.server 3000" -RedirectStandardOutput $frontendLog -RedirectStandardError $frontendLog
          Pop-Location
          Start-Sleep -Seconds 10
      - name: Frontend UI Verification
        shell: pwsh
        run: |
          pip install playwright
          python -m playwright install --with-deps
          $scriptContent = @"
          import sys
          from playwright.sync_api import sync_playwright, expect

          def run_verification():
              with sync_playwright() as p:
                  try:
                      browser = p.chromium.launch()
                      page = browser.new_page()
                      url = "http://127.0.0.1:3000"
                      page.goto(url, wait_until='networkidle', timeout=20000)
                      heading = page.locator("h1:has-text('Fortuna Faucet')")
                      expect(heading).to_be_visible(timeout=10000)
                      page.screenshot(path='smoke-test-screenshot.png')
                      browser.close()
                      sys.exit(0)
                  except Exception as e:
                      print(f"Error: {e}", file=sys.stderr)
                      sys.exit(1)

          if __name__ == "__main__":
              run_verification()
          "@
          Set-Content -Path "verify_frontend.py" -Value $scriptContent
          python verify_frontend.py
      - name: Upload Verification Screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshot-${{ github.sha }}
          path: smoke-test-screenshot.png
          retention-days: 7
      - name: Teardown Processes
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "fortuna-backend" -Force -ErrorAction SilentlyContinue
          Stop-Process -Name "python" -Force -ErrorAction SilentlyContinue

  package-and-test:
    name: 'üèÜ Package & Test Electron Installer'
    timeout-minutes: 25
    needs: [build-frontend, smoke-test-service]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
      - name: Setup Node.js for Electron
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'
      - name: Download All Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./temp-artifacts
      - name: Stage Artifacts for Packaging
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "./electron/web-ui-build" -Force | Out-Null
          New-Item -ItemType Directory -Path "./electron/resources" -Force | Out-Null
          Move-Item -Path "./temp-artifacts/frontend-build-output-${{ github.sha }}/*" -Destination "./electron/web-ui-build/out" -Force
          Move-Item -Path "./temp-artifacts/backend-executable-${{ github.sha }}/fortuna-backend.exe" -Destination "./electron/resources/fortuna-backend.exe" -Force
      - name: Verify Staged Artifacts
        shell: pwsh
        run: |
          $backendPath = "./electron/resources/fortuna-backend.exe"
          $frontendDir = "./electron/web-ui-build/out"
          if (-not (Test-Path $backendPath)) {
            Write-Host "‚ùå FATAL: Backend executable not found at $backendPath" -ForegroundColor Red
            exit 1
          }
          $frontendFiles = (Get-ChildItem -Path $frontendDir -Recurse -File | Measure-Object).Count
          if ($frontendFiles -eq 0) {
            Write-Host "‚ùå FATAL: No files found in frontend directory $frontendDir" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Artifacts staged successfully: Backend executable and $frontendFiles frontend files." -ForegroundColor Green
      - name: Critical Integration Test
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough"
        run: |
          $exe = "./electron/resources/fortuna-backend.exe"
          # ... existing integration test ...
      - name: Electron - Install & Package MSI
        working-directory: electron
        shell: pwsh
        run: |
          npm ci
          npx electron-builder --config electron-builder-config.yml --publish never
      - name: Code Sign MSI
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          # ... code signing script ...
      - name: Upload Final MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer-windows-${{ github.sha }}
          path: electron/dist/*.msi
          retention-days: 7
      - name: Create GitHub Release
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            MSI Installer for Fortuna Faucet.
            Built from commit ${{ github.sha }}.
          draft: false
          prerelease: false
      - name: Upload Release Asset
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: electron/dist/*.msi
          asset_name: fortuna-faucet-${{ github.ref_name }}.msi
          asset_content_type: application/octet-stream
