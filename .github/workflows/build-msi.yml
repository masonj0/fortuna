name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            electron/package-lock.json
            web_platform/frontend/package-lock.json
        env:
          SETUP_NODE_CACHE_KEY: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-20251101

      - name: Install Frontend Dependencies & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build

      - name: Stage Frontend Assets for Packaging
        shell: pwsh
        run: |
          # This script robustly stages the static frontend assets for Electron to package.
          # It ensures the destination is clean, copies the files, and then verifies
          # the file count to prevent packaging an incomplete UI.
          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"
          if (Test-Path $dest) {
            Remove-Item -Recurse -Force $dest
          }
          Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction Stop
          $sourceFiles = (Get-ChildItem -Path $source -Recurse | Measure-Object).Count
          $destFiles = (Get-ChildItem -Path $dest -Recurse | Measure-Object).Count
          if ($destFiles -ne $sourceFiles) {
            Write-Error "File count mismatch after staging frontend assets!"
            exit 1
          }
          Write-Host "Successfully staged $destFiles frontend assets."

      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm ci

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: python_service/requirements.txt
        env:
          SETUP_PYTHON_CACHE_KEY: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}-20251101

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          # Install all Python dependencies from the locked requirements file.
          pip install -r python_service/requirements.txt
          # Run PyInstaller to create a single-file executable.
          # --onefile: Bundles everything into a single .exe.
          # --name: Specifies the output filename.
          # --hidden-import: Explicitly includes modules that PyInstaller might miss.
          # --add-data: Packages the data adapters directory alongside the executable.
          pyinstaller --onefile `
            --name fortuna-backend `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=httpx.models `
            --hidden-import=redis.asyncio `
            --hidden-import=fastapi `
            --hidden-import=pydantic `
            --hidden-import=structlog `
            --hidden-import=httpx `
            --add-data "python_service/adapters:adapters" `
            python_service/api.py

      - name: Stage Backend Executable
        shell: pwsh
        run: |
          $distPath = ".\\dist\\fortuna-backend.exe"
          $destDir = ".\\electron\\resources"
          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }
          if (Test-Path $distPath) {
            Copy-Item -Path $distPath -Destination $destDir -Force
            Write-Host "Backend executable staged successfully."
          } else {
            Write-Error "ERROR: Could not find backend exe at $distPath"
            Get-ChildItem -Path ".\\dist\\" -Recurse
            exit 1
          }

      - name: Verify Build Inputs
        shell: pwsh
        run: |
          $backendExe = ".\\electron\\resources\\fortuna-backend.exe"
          $frontendDir = ".\\electron\\web-ui-build\\out"
          if (-not (Test-Path $backendExe)) {
            Write-Error "CRITICAL: Backend executable not found at $backendExe"
            Get-ChildItem -Path ".\\electron\\resources\\" -Recurse
            exit 1
          }
          if (-not (Test-Path $frontendDir)) {
            Write-Error "CRITICAL: Frontend build directory not found at $frontendDir"
            Get-ChildItem -Path ".\\electron\\web-ui-build\\" -Recurse
            exit 1
          }
          Write-Host "All critical artifacts verified successfully."

      - name: Verify electron/package.json Build Configuration
        shell: pwsh
        run: |
          Write-Host "=== Verifying electron/package.json ===" -ForegroundColor Cyan

          $packageJson = Get-Content electron/package.json | ConvertFrom-Json

          if (-not $packageJson.build) {
            Write-Error "CRITICAL: electron/package.json missing 'build' section!"
            exit 1
          }

          if (-not $packageJson.build.extraResources) {
            Write-Error "CRITICAL: electron/package.json build section missing 'extraResources' array!"
            exit 1
          }

          Write-Host "✅ 'extraResources' configuration found" -ForegroundColor Green
          Write-Host "Extra resources:"
          $packageJson.build.extraResources | ForEach-Object {
            Write-Host "  from: $($_.from) -> to: $($_.to)" -ForegroundColor Cyan
          }

      - name: Verify Pre-Build Assets Exist
        shell: pwsh
        run: |
          Write-Host "`n=== Verifying pre-build staging ===" -ForegroundColor Cyan

          $backendExe = ".\electron\resources\fortuna-backend.exe"
          $frontendDir = ".\electron\web-ui-build\out"
          $frontendIndex = "$frontendDir\index.html"

          if (-not (Test-Path $backendExe)) {
            Write-Error "CRITICAL: Backend executable missing at: $backendExe"
            exit 1
          }
          Write-Host "✅ Backend executable found: $('{0:N2}' -f ((Get-Item $backendExe).Length / 1MB)) MB" -ForegroundColor Green

          if (-not (Test-Path $frontendDir)) {
            Write-Error "CRITICAL: Frontend directory missing at: $frontendDir"
            exit 1
          }

          if (-not (Test-Path $frontendIndex)) {
            Write-Error "CRITICAL: Frontend index.html missing at: $frontendIndex"
            exit 1
          }

          $fileCount = @(Get-ChildItem -Path $frontendDir -Recurse).Count
          Write-Host "✅ Frontend directory found with $fileCount files" -ForegroundColor Green

      - name: Build MSI Installer using electron-builder
        shell: pwsh
        run: |
          cd electron
          Write-Host "`n=== Building MSI with electron-builder ===" -ForegroundColor Cyan
          npm run dist
          if ($LASTEXITCODE -ne 0) {
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }
          Write-Host "✅ MSI build completed" -ForegroundColor Green
        env:
          FORTUNA_BUILD_TYPE: 'full'
          DEBUG: 'electron-builder'
          CI: 'true'

      - name: Extract and Deep Search MSI Contents
        shell: pwsh
        run: |
          Write-Host "`n========== DEEP MSI CONTENTS SEARCH ==========" -ForegroundColor Cyan

          # Find the MSI file
          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Error "No MSI file found in .\electron\dist"
            exit 1
          }

          Write-Host "MSI file: $($msiFile.Name)" -ForegroundColor Green
          Write-Host "Size: $('{0:N2}' -f ($msiFile.Length / 1MB)) MB" -ForegroundColor Green

          # Extract MSI to inspect
          $extractPath = ".\msi-extract"
          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          Write-Host "Extracting MSI..." -ForegroundColor Yellow

          # Extract using 7z if available
          $seven_zip = Get-Command 7z -ErrorAction SilentlyContinue
          if ($seven_zip) {
            & 7z x "$($msiFile.FullName)" -o"$extractPath" -y -bso0 -bsp0 | Out-Null
          } else {
            & msiexec /a "$($msiFile.FullName)" /qn TARGETDIR="$((Resolve-Path $extractPath).Path)"
          }

          # SEARCH: Find ALL .exe files
          Write-Host "`n=== Searching for all .exe files ===" -ForegroundColor Yellow
          $exeFiles = @(Get-ChildItem -Path $extractPath -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue)

          if ($exeFiles.Count -eq 0) {
            Write-Host "❌ NO .exe files found in MSI!" -ForegroundColor Red
            Write-Host "`nDirectory structure:"
            Get-ChildItem -Path $extractPath -Recurse -Directory | Select-Object -First 20 | ForEach-Object {
              Write-Host "  $($_.FullName.Substring($extractPath.Length))"
            }
            exit 1
          }

          Write-Host "✅ Found $($exeFiles.Count) .exe file(s):" -ForegroundColor Green
          $exeFiles | ForEach-Object {
            $relativePath = $_.FullName.Substring($extractPath.Length + 1)
            $size = '{0:N2}' -f ($_.Length / 1MB)
            Write-Host "   - [$($size) MB] $relativePath" -ForegroundColor Cyan
          }

          # Search for fortuna-backend.exe specifically
          $backendFound = $exeFiles | Where-Object { $_.Name -eq "fortuna-backend.exe" }
          if (-not $backendFound) {
            Write-Host "`n❌ fortuna-backend.exe NOT found in MSI" -ForegroundColor Red
            Write-Host "This means 'extraResources' is not working correctly" -ForegroundColor Yellow
            exit 1
          }

          Write-Host "`n✅ BACKEND EXECUTABLE FOUND!" -ForegroundColor Green
          Write-Host "   Location: $($backendFound.FullName.Substring($extractPath.Length + 1))" -ForegroundColor Cyan

          # Search for index.html
          Write-Host "`n=== Searching for frontend index.html ===" -ForegroundColor Yellow
          $indexFiles = @(Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue)
          if ($indexFiles.Count -eq 0) {
            Write-Host "❌ NO index.html found!" -ForegroundColor Red
            exit 1
          }
          Write-Host "✅ Frontend found at: $($indexFiles[0].FullName.Substring($extractPath.Length + 1))" -ForegroundColor Green

          Write-Host "`n✅ ALL CRITICAL COMPONENTS VERIFIED!" -ForegroundColor Green

      - name: Locate Built MSI Path
        id: locate_msi
        shell: pwsh
        run: |
          $msiFiles = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse
          if ($msiFiles.Count -eq 0) {
            Write-Error "CRITICAL: No MSI files found in electron/dist directory."
            exit 1
          }
          if ($msiFiles.Count -gt 1) {
            Write-Warning "Multiple MSI files found. Using the first one: $($msiFiles[0].FullName)"
          }
          $msiPath = $msiFiles[0].FullName
          Write-Host "MSI Path: $msiPath"
          "msi_path=$msiPath" | Add-Content -Path $env:GITHUB_OUTPUT

      - name: Deep Search MSI Contents for Backend Executable
        shell: pwsh
        run: |
          Write-Host "========== DEEP MSI CONTENTS SEARCH ==========" -ForegroundColor Cyan
          Write-Host ""

          $extractPath = ".\msi-extract"

          # SEARCH: Find ALL .exe files
          Write-Host "=== Searching for all .exe files ===" -ForegroundColor Yellow
          $exeFiles = @(Get-ChildItem -Path $extractPath -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue)

          if ($exeFiles.Count -eq 0) {
            Write-Host "❌ NO .exe files found in MSI!" -ForegroundColor Red
            exit 1
          }

          Write-Host "✅ Found $($exeFiles.Count) .exe file(s):" -ForegroundColor Green
          $exeFiles | ForEach-Object {
            $relativePath = $_.FullName.Substring($extractPath.Length + 1)
            $size = '{0:N2}' -f ($_.Length / 1MB)
            Write-Host "   - [$($size) MB] $relativePath" -ForegroundColor Cyan
          }

          # Search for fortuna-backend.exe specifically
          $backendFound = $exeFiles | Where-Object { $_.Name -eq "fortuna-backend.exe" }
          if (-not $backendFound) {
            Write-Host ""
            Write-Host "❌ fortuna-backend.exe NOT found in MSI" -ForegroundColor Red
            Write-Host "This means 'extraResources' is not working correctly" -ForegroundColor Yellow
            exit 1
          }

          Write-Host ""
          Write-Host "✅ BACKEND EXECUTABLE FOUND!" -ForegroundColor Green
          Write-Host "   Path: $($backendFound.FullName.Substring($extractPath.Length + 1))" -ForegroundColor Green

      - name: Generate sanitized artifact name
        id: sanitize
        shell: bash
        run: echo "name=fortuna-faucet-installer-$(echo ${{ github.ref_name }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.sanitize.outputs.name }}
          path: ${{ steps.locate_msi.outputs.msi_path }}
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ${{ steps.locate_msi.outputs.msi_path }}
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
