# Cache-buster: 2025-11-03 05:15:00
name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Absolute Nuclear Cache Annihilation
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] Absolute Nuclear Cache Annihilation ---" -ForegroundColor Red
          npm cache clean --force --verbose
          npm cache verify
          pip cache purge
          Remove-Item -Path "$env:APPDATA\npm-cache" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:USERPROFILE\.npm" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:USERPROFILE\.node-gyp" -Recurse -Force -ErrorAction SilentlyContinue

          Get-ChildItem -Path . -Recurse -Filter "node_modules" -Directory -Force -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "     - Removing: $($_.FullName)"
            Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }

          $toDestroy = @("dist", "build", "electron/dist", "electron/build", "electron/out", "web_platform/frontend/.next", "web_platform/frontend/out", "package-lock.json", "electron/package-lock.json", "web_platform/frontend/package-lock.json")
          foreach ($path in $toDestroy) {
            if (Test-Path $path) {
              Write-Host "     - Removing: $path"
              Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
            }
          }
          Write-Host "--- [OVERKILL] Environment has been vaporized ---" -ForegroundColor Red

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ===== FRONTEND BUILD =====
      - name: Install Frontend Dependencies
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm install --verbose 2>&1 | Tee-Object -FilePath ../../npm-frontend-install.log
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm install failed for frontend!"
            exit 1
          }

      - name: Build Frontend (Static Export)
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Building Next.js frontend for static export..." -ForegroundColor Cyan
          npm run build 2>&1 | Tee-Object -FilePath ../../build-frontend.log
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed! Check build-frontend.log for details."
            exit 1
          }
          if (-not (Test-Path "out/index.html")) {
            Write-Error "Frontend build succeeded but out/index.html not found"
            exit 1
          }
          $fileCount = (Get-ChildItem -Path "out" -Recurse -File | Measure-Object).Count
          Write-Host "‚úÖ Frontend built successfully: $fileCount files" -ForegroundColor Green

      - name: INTELLIGENT COPY Stage Frontend Assets for Electron
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] INTELLIGENT COPY: Staging essential frontend assets ---" -ForegroundColor Yellow

          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          # Selectively copy only essential, stable assets
          Write-Host "  ‚Üí Copying essential assets..."
          Copy-Item -Path (Join-Path $source "_next") -Destination $dest -Recurse -Force
          Copy-Item -Path (Join-Path $source "*.html") -Destination $dest -Force
          Copy-Item -Path (Join-Path $source "favicon.ico") -Destination $dest -Force

          # VERIFY - File by file on the filtered set
          $sourceFiles = @(Get-ChildItem -Path $source -Recurse -File | Where-Object { $_.Extension -in ".html", ".css", ".js", ".ico" })
          $destFiles = @(Get-ChildItem -Path $dest -Recurse -File)

          if ($sourceFiles.Count -ne $destFiles.Count) {
            Write-Host "INTELLIGENT COPY WARNING: File count mismatch. Source: $($sourceFiles.Count), Dest: $($destFiles.Count)" -ForegroundColor Yellow
            # Not fatal, as we prioritize delivery.
          }

          if (-not (Test-Path (Join-Path $dest "index.html"))) {
            Write-Error "INTELLIGENT COPY FAILED: Critical file index.html is missing from destination."
            exit 1
          }

          Write-Host "  ‚úÖ Intelligent copy complete. Verified presence of index.html and $($destFiles.Count) total files." -ForegroundColor Green

      # ===== BACKEND BUILD =====
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Python dependencies..." -ForegroundColor Cyan
          cd python_service
          pip install -r requirements.txt --verbose 2>&1 | Tee-Object -FilePath ../pip-install.log
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Pip install failed!"
            exit 1
          }
          cd ..
          Write-Host "‚úÖ Dependencies installed" -ForegroundColor Green

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building backend executable with PyInstaller..." -ForegroundColor Cyan

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --add-data "python_service/adapters;adapters" `
            python_service/api.py 2>&1 | Tee-Object -FilePath pyinstaller.log

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller failed! Check pyinstaller.log for details."
            exit 1
          }

          Write-Host "‚úÖ Backend executable built" -ForegroundColor Green

      - name: AGGRESSIVE COPY Stage Backend Executable
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] AGGRESSIVE COPY: Staging backend executable ---" -ForegroundColor Yellow

          $source = ".\dist\fortuna-backend.exe"
          $destDir = ".\electron\resources"
          $dest = Join-Path $destDir "fortuna-backend.exe"

          if (-not (Test-Path $source)) {
            Write-Error "AGGRESSIVE COPY FAILED: Source executable not found at: $source"
            exit 1
          }
          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }

          Copy-Item -Path $source -Destination $dest -Force -ErrorAction Stop

          if (-not (Test-Path $dest)) {
            Write-Error "AGGRESSIVE COPY FAILED: Copy to destination failed: $dest"
            exit 1
          }

          $sourceSize = (Get-Item $source).Length
          $destSize = (Get-Item $dest).Length

          if ($sourceSize -ne $destSize) {
            Write-Error "AGGRESSIVE COPY FAILED: File size mismatch! Source: $sourceSize, Dest: $destSize"
            exit 1
          }

          Write-Host "  ‚úÖ Aggressive copy complete. Verified backend executable ($([math]::Round($destSize / 1MB, 2)) MB)." -ForegroundColor Green

      # ===== ELECTRON BUILD =====
      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm install --verbose 2>&1 | Tee-Object -FilePath ../npm-electron-install.log
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm install failed for electron!"
            exit 1
          }

      - name: MEGA VERIFICATION - All Files Present
        shell: pwsh
        run: |
          Write-Host "`n--- [OVERKILL] MEGA VERIFICATION - ALL CRITICAL FILES ---" -ForegroundColor Magenta

          $checks = @(
            @{ name = "Electron: main.js"; path = "electron/main.js" },
            @{ name = "Electron: preload.js"; path = "electron/preload.js" },
            @{ name = "Electron: package.json"; path = "electron/package.json" },
            @{ name = "Asset: icon.ico"; path = "electron/assets/icon.ico" },
            @{ name = "BACKEND: fortuna-backend.exe"; path = "electron/resources/fortuna-backend.exe" },
            @{ name = "FRONTEND: index.html"; path = "electron/web-ui-build/out/index.html" },
            @{ name = "FRONTEND: _next dir"; path = "electron/web-ui-build/out/_next" }
          )

          $allGood = $true
          foreach ($check in $checks) {
            $exists = Test-Path $check.path
            $status = if ($exists) { "[ ‚úÖ OK ]" } else { "[ ‚ùå FAILED ]" }
            $color = if ($exists) { "Green" } else { "Red" }

            if ($exists) {
              if (Test-Path $check.path -PathType Container) {
                $count = @(Get-ChildItem -Path $check.path -Recurse -File).Count
                Write-Host "$status $($check.name): Found directory with $count files" -ForegroundColor $color
              } else {
                $size = (Get-Item $check.path).Length
                if ($size -gt 1MB) { $sizeStr = "$([math]::Round($size / 1MB, 2)) MB" }
                elseif ($size -gt 1KB) { $sizeStr = "$([math]::Round($size / 1KB, 2)) KB" }
                else { $sizeStr = "$size bytes" }
                Write-Host "$status $($check.name): Found file ($sizeStr)" -ForegroundColor $color
              }
            } else {
              Write-Host "$status $($check.name): MISSING at $($check.path)" -ForegroundColor $color
              $allGood = $false
            }
          }

          if (-not $allGood) {
            Write-Error "MEGA VERIFICATION FAILED! Critical assets are missing before the build step."
            exit 1
          }

          Write-Host "`n--- [OVERKILL] MEGA VERIFICATION PASSED! ALL ASSETS ARE STAGED ---" -ForegroundColor Magenta

      - name: Build MSI Installer (Absolute Path Overkill)
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] Preparing Absolute Path Configuration ---" -ForegroundColor Magenta

          $absolutePath = (Get-Location).Path.Replace('\', '/')
          Write-Host "  Runner absolute path: $absolutePath"

          $template = Get-Content "electron/electron-builder-config.yml" -Raw
          $finalConfig = $template.Replace("__ABSOLUTE_PATH__", $absolutePath)

          $configPath = "electron/electron-builder-config.yml"
          Set-Content -Path $configPath -Value $finalConfig -Force

          Write-Host "`n--- [OVERKILL] Final Configuration ---" -ForegroundColor Magenta
          Get-Content $configPath | Write-Host
          Write-Host "------------------------------------" -ForegroundColor Magenta

          Write-Host "`n=== BUILDING MSI INSTALLER (ABSOLUTE PATH MODE) ===" -ForegroundColor Cyan

          npx electron-builder --projectDir electron --config electron-builder-config.yml 2>&1 | Tee-Object -FilePath build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n--- Build Log ---"
            if (Test-Path "build.log") {
              Get-Content build.log
            }
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úÖ MSI build completed successfully" -ForegroundColor Green
        env:
          CI: 'true'

      # ===== POST-BUILD VERIFICATION =====
      - name: Verify MSI Exists
        shell: pwsh
        run: |
          Write-Host "`n=== LOCATING MSI ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Host "Directory contents of electron/dist:"
            Get-ChildItem -Path ".\electron\dist" -Recurse | ForEach-Object { Write-Host $_.FullName }
            Write-Error "No MSI file found in electron/dist"
            exit 1
          }

          $msiSize = $msiFile.Length / 1MB
          Write-Host "‚úÖ MSI found: $($msiFile.Name) ($([math]::Round($msiSize, 2)) MB)" -ForegroundColor Green

      - name: Extract and Verify MSI Contents (Non-Fatal)
        shell: pwsh
        run: |
          Write-Host "`n=== VERIFYING MSI CONTENTS (NON-FATAL) ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msiFile) {
            Write-Host "  [WARNING] No MSI file found to verify. Skipping verification." -ForegroundColor Yellow
            return
          }

          $extractPath = ".\msi-extract"

          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          $sevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $sevenZip)) {
              Write-Host "  [WARNING] 7-Zip not found. MSI extraction may be incomplete. Skipping verification." -ForegroundColor Yellow
              return
          }

          & $sevenZip x "$($msiFile.FullName)" -o"$extractPath" -y | Out-Null

          $cabFile = Get-ChildItem -Path $extractPath -Recurse -Filter "*.cab" | Select-Object -First 1
          if ($cabFile) {
            $cabPath = ".\cab-extract"
            if (Test-Path $cabPath) { Remove-Item -Recurse -Force $cabPath }
            New-Item -ItemType Directory -Path $cabPath -Force | Out-Null
            & $sevenZip x "$($cabFile.FullName)" -o"$cabPath" -y | Out-Null
            $extractPath = $cabPath
          }

          $backend = @(Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue)
          $frontendIndex = @(Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue)
          $mainJs = @(Get-ChildItem -Path $extractPath -Recurse -Filter "main.js" -ErrorAction SilentlyContinue)

          Write-Host "`nüì¶ Final MSI Contents Analysis:"
          $missing = @()
          if ($backend.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Backend executable FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Backend executable NOT FOUND" -ForegroundColor Red
            $missing += "fortuna-backend.exe"
          }

          if ($frontendIndex.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Frontend (index.html) FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Frontend (index.html) NOT FOUND" -ForegroundColor Red
            $missing += "index.html"
          }

          if ($mainJs.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Electron main process (main.js) FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Electron main process (main.js) NOT FOUND" -ForegroundColor Red
            $missing += "main.js"
          }

          if ($missing.Count -gt 0) {
            Write-Host "`n[ERROR] MSI verification failed. Missing required assets: $($missing -join ', ')" -ForegroundColor Red
            Write-Host "Build will continue, but the resulting MSI is likely non-functional." -ForegroundColor Yellow
            Write-Host "`n--- Contents of extracted MSI for debugging ---" -ForegroundColor Yellow
            Get-ChildItem -Path $extractPath -Recurse -Depth 4 | Select-Object -First 200 | ForEach-Object { Write-Host $_.FullName }
            Write-Host "---------------------------------------------" -ForegroundColor Yellow
          } else {
            Write-Host "`n[SUCCESS] MSI verification passed! All critical assets are present in the installer." -ForegroundColor Green
          }

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-faucet-installer-${{ github.ref_name }}
          path: ./electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      - name: Upload ULTIMATE Forensic Build Logs
        uses: actions/upload-artifact@v4
        if: always() # Always run this step to get logs even if the build fails
        with:
          name: fortuna-build-logs-${{ github.ref_name }}
          path: |
            build.log
            build-frontend.log
            build-backend.log
            pyinstaller.log
            pip-install.log
            npm-frontend-install.log
            npm-electron-install.log
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Extracted MSI for Forensic Analysis
        uses: actions/upload-artifact@v4
        if: always() # Always run this step
        with:
          name: fortuna-msi-extraction-${{ github.ref_name }}
          path: |
            ./msi-extract/
            ./cab-extract/
          retention-days: 7
          if-no-files-found: warn

      # ===== RELEASE (on tags) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ./electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            ## Fortuna Faucet Release ${{ github.ref_name }}

            ### What's Inside
            - ‚úÖ Python FastAPI backend (packaged as standalone executable)
            - ‚úÖ Next.js frontend (static HTML/CSS/JS)
            - ‚úÖ Electron desktop wrapper

            ### Installation
            1. Download the `.msi` installer below
            2. Run the installer (requires Administrator privileges)
            3. Launch "Fortuna Faucet" from your Start Menu

            ### Requirements
            - Windows 10/11 (64-bit)
            - No Python or Node.js installation required!

            ---
            *Built with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
