# Cache-buster: 2025-11-02 08:09:23
name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clear Caches for Fresh Build
        shell: pwsh
        run: |
          Write-Host "Clearing npm and pip caches for cache-busting..." -ForegroundColor Yellow
          npm cache clean --force
          pip cache purge

      - name: Clear Caches for Fresh Build
        shell: pwsh
        run: |
          Write-Host "Clearing npm and pip caches for cache-busting..." -ForegroundColor Yellow
          npm cache clean --force
          pip cache purge

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ===== FRONTEND BUILD =====
      - name: Install Frontend Dependencies
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci

      - name: Build Frontend (Static Export)
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Building Next.js frontend for static export..." -ForegroundColor Cyan
          npm run build

          if (-not (Test-Path "out/index.html")) {
            Write-Error "Frontend build failed - out/index.html not found"
            exit 1
          }

          $fileCount = (Get-ChildItem -Path "out" -Recurse -File | Measure-Object).Count
          Write-Host "‚úÖ Frontend built successfully: $fileCount files" -ForegroundColor Green

      - name: Stage Frontend Assets for Electron
        shell: pwsh
        run: |
          Write-Host "Staging frontend assets..." -ForegroundColor Cyan

          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (Test-Path $dest) {
            Remove-Item -Recurse -Force $dest
          }

          Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction Stop

          $sourceFiles = (Get-ChildItem -Path $source -Recurse -File | Measure-Object).Count
          $destFiles = (Get-ChildItem -Path $dest -Recurse -File | Measure-Object).Count

          if ($destFiles -ne $sourceFiles) {
            Write-Error "File count mismatch! Source: $sourceFiles, Dest: $destFiles"
            exit 1
          }

          if (-not (Test-Path "$dest/index.html")) {
            Write-Error "Critical file missing: index.html"
            exit 1
          }

          Write-Host "‚úÖ Staged $destFiles frontend files to $dest" -ForegroundColor Green

      - name: Diagnostic - Verify Staged Frontend
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Post-Frontend-Staging Directory Listing ===" -ForegroundColor Yellow
          Get-ChildItem -Path ".\electron\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "=========================================================" -ForegroundColor Yellow

      # ===== BACKEND BUILD =====
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Python dependencies..." -ForegroundColor Cyan
          pip install -r python_service/requirements.txt
          Write-Host "‚úÖ Dependencies installed" -ForegroundColor Green

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building backend executable with PyInstaller..." -ForegroundColor Cyan

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --add-data "python_service/adapters;adapters" `
            python_service/api.py

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úÖ Backend executable built" -ForegroundColor Green

          Write-Host "--- [DIAG] PyInstaller Output (dist/) ---"
          Get-ChildItem -Recurse ".\dist\" | Out-String -Width 120
          Write-Host "-----------------------------------------"

      - name: Stage Backend Executable
        shell: pwsh
        run: |
          Write-Host "Staging backend executable..." -ForegroundColor Cyan

          $exePath = ".\dist\fortuna-backend.exe"
          $destDir = ".\electron\resources"

          if (-not (Test-Path $exePath)) {
            Write-Error "Backend executable not found at: $exePath"
            Get-ChildItem -Path ".\dist\" -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          $exeSize = (Get-Item $exePath).Length / 1MB
          Write-Host "Backend exe size: $([math]::Round($exeSize, 2)) MB"

          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }

          Copy-Item -Path $exePath -Destination $destDir -Force

          $copiedExe = Join-Path $destDir "fortuna-backend.exe"
          if (-not (Test-Path $copiedExe)) {
            Write-Error "Failed to copy executable to: $copiedExe"
            exit 1
          }

          Write-Host "‚úÖ Backend executable staged successfully" -ForegroundColor Green

          Write-Host "--- [DIAG] Staged Backend Assets (electron/resources) ---"
          Get-ChildItem -Recurse $destDir | Out-String -Width 120
          Write-Host "---------------------------------------------------------"

      - name: Diagnostic - Verify Staged Backend
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Post-Backend-Staging Directory Listing ===" -ForegroundColor Yellow
          Get-ChildItem -Path ".\electron\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "========================================================" -ForegroundColor Yellow

      # ===== ELECTRON BUILD =====
      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm ci

      - name: Pre-Build File Verification
        shell: pwsh
        run: |
          Write-Host "`n=== PRE-BUILD FILE VERIFICATION ===" -ForegroundColor Cyan

          $criticalFiles = @(
            ("main.js", ".\electron\main.js"),
            ("preload.js", ".\electron\preload.js"),
            ("icon", ".\electron\assets\icon.ico"),
            ("backend.exe", ".\electron\resources\fortuna-backend.exe"),
            ("frontend", ".\electron\web-ui-build\out\index.html")
          )

          $allOk = $true
          foreach ($file in $criticalFiles) {
            $name, $path = $file
            if (Test-Path $path) {
              $size = (Get-Item $path).Length
              if ($size -gt 1MB) {
                $sizeStr = "$([math]::Round($size / 1MB, 2)) MB"
              } elseif ($size -gt 1KB) {
                $sizeStr = "$([math]::Round($size / 1KB, 2)) KB"
              } else {
                $sizeStr = "$size bytes"
              }
              Write-Host "  ‚úÖ $name ($sizeStr)" -ForegroundColor Green
            } else {
              Write-Host "  ‚ùå $name - NOT FOUND at: $path" -ForegroundColor Red
              $allOk = $false
            }
          }

          if (-not $allOk) {
            exit 1
          }

          Write-Host "`n‚úÖ All critical files present" -ForegroundColor Green

      - name: Diagnostic - Directory Structure Before Build
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Final Pre-Build Workspace State ===" -ForegroundColor Yellow
          Write-Host "--- electron/package.json ---"
          Get-Content -Path ".\electron\package.json" | Write-Host
          Write-Host "-----------------------------"
          Write-Host
          Write-Host "--- Workspace Directory Listing ---"
          Get-ChildItem -Path ".\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "----------------------------------"
          Write-Host "=================================================" -ForegroundColor Yellow

      - name: Build MSI Installer
        shell: pwsh
        run: |
          cd electron
          Write-Host "`n=== BUILDING MSI INSTALLER ===" -ForegroundColor Cyan

          npm run dist 2>&1 | Tee-Object -FilePath build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n--- Build Log ---"
            Get-Content build.log
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úÖ MSI build completed successfully" -ForegroundColor Green
        env:
          CI: 'true'

      # ===== POST-BUILD VERIFICATION =====
      - name: Verify MSI Exists
        shell: pwsh
        run: |
          Write-Host "`n=== LOCATING MSI ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Host "Directory contents of electron/dist:"
            Get-ChildItem -Path ".\electron\dist" -Recurse | ForEach-Object { Write-Host $_.FullName }
            Write-Error "No MSI file found in electron/dist"
            exit 1
          }

          $msiSize = $msiFile.Length / 1MB
          Write-Host "‚úÖ MSI found: $($msiFile.Name) ($([math]::Round($msiSize, 2)) MB)" -ForegroundColor Green

      - name: Extract and Verify MSI Contents
        shell: pwsh
        run: |
          Write-Host "`n=== VERIFYING MSI CONTENTS ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1
          $extractPath = ".\msi-extract"

          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          # Extract MSI
          $7zPath = "C:\Program Files\7-Zip\7z.exe"
          if (Test-Path $7zPath) {
            & $7zPath x "$($msiFile.FullName)" -o"$extractPath" -y | Out-Null
          } else {
            $fullPath = (Resolve-Path $extractPath).Path
            & msiexec /a "$($msiFile.FullName)" /qn TARGETDIR="$fullPath" | Out-Null
          }

          # Find and extract CAB
          $cabFile = Get-ChildItem -Path $extractPath -Recurse -Filter "*.cab" | Select-Object -First 1
          if ($cabFile) {
            $cabPath = ".\cab-extract"
            if (Test-Path $cabPath) { Remove-Item -Recurse -Force $cabPath }
            New-Item -ItemType Directory -Path $cabPath -Force | Out-Null

            & $7zPath x "$($cabFile.FullName)" -o"$cabPath" -y | Out-Null
            $extractPath = $cabPath
          }

          # Search for critical components
          $backend = @(Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue)
          $frontend = @(Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue)
          $mainJs = @(Get-ChildItem -Path $extractPath -Recurse -Filter "main.js" -ErrorAction SilentlyContinue)

          Write-Host "`nüì¶ MSI Contents:"
          if ($backend.Count -gt 0) {
            Write-Host "  ‚úÖ Backend: $($backend[0].Length / 1MB)MB" -ForegroundColor Green
          } else {
            Write-Host "  ‚ùå Backend executable NOT found" -ForegroundColor Red
          }

          if ($frontend.Count -gt 0) {
            Write-Host "  ‚úÖ Frontend: $($frontend.Count) files" -ForegroundColor Green
          } else {
            Write-Host "  ‚ùå Frontend NOT found" -ForegroundColor Red
          }

          if ($mainJs.Count -gt 0) {
            Write-Host "  ‚úÖ main.js present" -ForegroundColor Green
          } else {
            Write-Host "  ‚ö†Ô∏è  main.js not found" -ForegroundColor Yellow
          }

          if ($backend.Count -eq 0 -or $frontend.Count -eq 0) {
            Write-Host "`nMSI extraction directory contents:"
            Get-ChildItem -Path $extractPath -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          }

          Write-Host "`n‚úÖ MSI verification passed!" -ForegroundColor Green

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-faucet-installer-${{ github.ref_name }}
          path: ./electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      # ===== RELEASE (on tags) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ./electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            ## Fortuna Faucet Release ${{ github.ref_name }}

            ### What's Inside
            - ‚úÖ Python FastAPI backend (packaged as standalone executable)
            - ‚úÖ Next.js frontend (static HTML/CSS/JS)
            - ‚úÖ Electron desktop wrapper

            ### Installation
            1. Download the `.msi` installer below
            2. Run the installer (requires Administrator privileges)
            3. Launch "Fortuna Faucet" from your Start Menu

            ### Requirements
            - Windows 10/11 (64-bit)
            - No Python or Node.js installation required!

            ---
            *Built with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
