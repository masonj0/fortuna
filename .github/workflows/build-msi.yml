name: Build Fortuna Faucet MSI Installer - ðŸ† PRODUCTION FORTRESS

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  build-frontend:
    name: 'ðŸ“¦ Build Frontend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7
      - name: Setup Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: frontend-build-output
          path: web_platform/frontend/out
          retention-days: 1

  build-backend:
    name: 'ðŸ Build Backend'
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7
      - name: Setup Python
        uses: actions/setup-python@v5.1.1
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'
      - name: 'âœ… [MONITOR] Ensure Required Directories Exist'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "python_service/adapters" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/json" -Force | Out-Null
          Write-Host "âœ… Ensured required data, json, and adapters directories exist."
      - name: 'âœ… [MONITOR] Verify Critical Files'
        shell: pwsh
        run: |
          if (-not (Test-Path "python_service/main.py")) { throw "âŒ FATAL: python_service/main.py not found" }
          if (-not (Test-Path "fortuna-backend.spec.template")) { throw "âŒ FATAL: fortuna-backend.spec.template not found" }
          Write-Host "âœ… Critical files main.py and spec template are present."
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r python_service/requirements-dev.txt
      - name: Backend - Security Audit
        shell: pwsh
        run: |
          # The --local flag is critical to prevent pip-audit from scanning system-wide packages
          pip-audit -r python_service/requirements.txt --local
      - name: Backend - Prepare Spec File
        shell: pwsh
        run: |
          Move-Item -Path "fortuna-backend.spec.template" -Destination "fortuna-backend.spec"
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          # Run from the root to ensure correct pathing for PyInstaller
          pyinstaller fortuna-backend.spec --noconfirm
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: backend-executable
          path: dist/fortuna-backend.exe # The spec file builds a --onefile executable directly into dist/
          retention-days: 1
          if-no-files-found: error

  smoke-test-backend:
    name: 'ðŸ§ª Smoke Test Backend Executable'
    needs: [build-backend]
    runs-on: windows-latest
    steps:
      - name: Download Backend Executable
        uses: actions/download-artifact@v4.1.8
        with:
          name: backend-executable
          path: ./
      - name: Run Smoke Test
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test"
        run: |
          $exe = "./fortuna-backend.exe"
          $process = Start-Process -FilePath $exe -PassThru -NoNewWindow
          $serverReady = $false
          Write-Host "--- Starting Smoke Test: Polling /health endpoint for 60s ---"
          foreach ($i in 1..30) {
            if ($process.HasExited) {
              throw "[FATAL] Backend process crashed during smoke test. Exit Code: $($process.ExitCode)"
            }
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/health" -TimeoutSec 1 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "[OK] Health check passed on attempt $i!"
                $serverReady = $true
                break
              }
            } catch {
              Write-Host "Attempt $i... server not ready."
            }
            Start-Sleep -Seconds 2
          }
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          if (-not $serverReady) {
            throw "[FATAL] Backend smoke test failed. Server never became healthy."
          }
          Write-Host "âœ… Backend smoke test passed."

  package-and-test:
    name: 'ðŸ† Package & Test Electron Installer'
    needs: [build-frontend, smoke-test-backend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7
      - name: Setup Node.js for Electron
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'
      - name: Download All Build Artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          path: ./temp-artifacts # Downloads all artifacts into this directory, preserving their names
      - name: Stage Artifacts for Packaging
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "./electron/web-ui-build" -Force | Out-Null
          New-Item -ItemType Directory -Path "./electron/resources" -Force | Out-Null
          Move-Item -Path "./temp-artifacts/frontend-build-output/*" -Destination "./electron/web-ui-build/out" -Force
          Move-Item -Path "./temp-artifacts/backend-executable/fortuna-backend.exe" -Destination "./electron/resources/fortuna-backend.exe" -Force
      - name: Critical Integration Test
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough" # Must be > 16 chars for config validation
        run: |
          $exe = "./electron/resources/fortuna-backend.exe"
          $process = Start-Process -FilePath $exe -PassThru -NoNewWindow
          $serverReady = $false
          Write-Host "--- Starting Integration Test: Polling /health endpoint for 60s ---"
          foreach ($i in 1..30) {
            if ($process.HasExited) {
              # On crash, dump the last 20 lines of stdout/stderr for diagnostics
              $stdErr = Get-Content -Path $process.StandardErrorPath -Tail 20 -ErrorAction SilentlyContinue
              $stdOut = Get-Content -Path $process.StandardOutputPath -Tail 20 -ErrorAction SilentlyContinue
              Write-Host "--- STDERR ---"
              Write-Host $stdErr
              Write-Host "--- STDOUT ---"
              Write-Host $stdOut
              throw "[FATAL] Backend process crashed on startup. Exit Code: $($process.ExitCode)"
            }
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/health" -TimeoutSec 1 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "[OK] Health check passed on attempt $i!"
                $serverReady = $true
                break
              }
            } catch {
              Write-Host "Attempt $i... server not ready."
            }
            Start-Sleep -Seconds 2
          }
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          if (-not $serverReady) {
            throw "[FATAL] Backend integration test failed. Server never became healthy."
          }
      - name: Electron - Install & Package MSI
        shell: pwsh
        run: |
          cd electron
          npm ci
          npx electron-builder --config electron-builder-config.yml --publish never
      - name: Upload Final MSI Artifact
        uses: actions/upload-artifact@v4.3.4
        with:
          name: fortuna-installer-windows
          path: electron/dist/*.msi
          retention-days: 7

