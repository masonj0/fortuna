name: Build Fortuna Faucet MSI Installer - ğŸ† PRODUCTION FORTRESS

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  CACHE_BUST: "2025-11-05-v3-fortress"
  API_KEY: "test_api_key_min16chars_secure_string"

jobs:
  build-installer:
    name: ğŸ† Build MSI Installer (Fortress Mode)
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      # ===== TELEMETRY & DIAGNOSTICS =====
      - name: ğŸ“Š Initialize Build Telemetry
        shell: pwsh
        run: |
          $buildInfo = @{
            StartTime = Get-Date -Format 'o'
            RunnerOS = $env:RUNNER_OS
            RunnerVersion = $env:RUNNER_VERSION
            RunnerName = $env:RUNNER_NAME
            WorkflowRef = "${{ github.workflow }}"
            JobID = "${{ github.job }}"
            RunID = "${{ github.run_id }}"
            RunNumber = "${{ github.run_number }}"
          }
          $buildInfo | ConvertTo-Json | Out-File -FilePath "build-telemetry.json" -Force
          Write-Host "ğŸ† BUILD FORTRESS INITIALIZED" -ForegroundColor Magenta
          $buildInfo | ConvertTo-Json | Write-Host

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===== SYSTEM VERIFICATION =====
      - name: ğŸ” System Health Check
        shell: pwsh
        run: |
          Write-Host "`n=== SYSTEM HEALTH CHECK ===" -ForegroundColor Cyan

          $checks = @{
            "PowerShell Version" = $PSVersionTable.PSVersion
            "Windows Version" = [System.Environment]::OSVersion
            "Total Memory" = "$(([System.Diagnostics.Process]::GetCurrentProcess().WorkingSet64 / 1GB).ToString('F2')) GB available"
            "Disk Space (C:)" = "$(([System.IO.DriveInfo]::GetDrives()[0].AvailableFreeSpace / 1GB).ToString('F2')) GB free"
            "Git Version" = "$(git --version)"
            "Node Version" = "$(node --version)"
            "Python Version" = "$(python --version)"
            "Pip Version" = "$(pip --version)"
          }

          foreach ($check in $checks.GetEnumerator()) {
            Write-Host "  âœ“ $($check.Name): $($check.Value)" -ForegroundColor Green
          }

          # Verify no processes are locking ports we'll use
          $blockedPorts = @(8000, 8998, 8999)
          foreach ($port in $blockedPorts) {
            $existing = netstat -ano 2>$null | Select-String ":$port\s+LISTENING"
            if ($existing) {
              Write-Host "  âš ï¸  WARNING: Port $port is already in use!" -ForegroundColor Yellow
              Write-Host "      $existing"
            } else {
              Write-Host "  âœ“ Port $port is available" -ForegroundColor Green
            }
          }

      # ===== NUCLEAR CACHE OBLITERATION =====
      - name: 'ğŸ”¥ NUCLEAR CACHE OBLITERATION'
        shell: pwsh
        run: |
          Write-Host "`n=== CACHE DESTRUCTION PROTOCOL ===" -ForegroundColor Red

          $itemsToNuke = @(
            "$env:TEMP\npm-*",
            "$env:TEMP\pip-*",
            "$env:APPDATA\npm-cache",
            "$env:APPDATA\pip"
          )

          foreach ($path in $itemsToNuke) {
            if (Test-Path $path) {
              $size = (Get-ChildItem -Path $path -Recurse -Force | Measure-Object -Property Length -Sum).Sum / 1MB
              Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  ğŸ—‘ï¸  Cleared: $path ($([math]::Round($size, 2)) MB)" -ForegroundColor Yellow
            }
          }

          npm cache clean --force 2>&1 | Out-Null
          py -m pip cache purge 2>&1 | Out-Null

          Get-ChildItem -Path . -Recurse -Filter "node_modules" -Directory -Force -ErrorAction SilentlyContinue |
            ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }

          @("dist", "build", "*.egg-info", "__pycache__", ".next") | ForEach-Object {
            Get-ChildItem -Path . -Recurse -Filter $_ -Directory -Force -ErrorAction SilentlyContinue |
              ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }
          }

          Write-Host "âœ… CACHE OBLITERATION COMPLETE" -ForegroundColor Green

      - name: Create Log Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics" -Force | Out-Null
          Write-Host "âœ… Logging infrastructure ready" -ForegroundColor Green

      # ===== ENVIRONMENT SETUP =====
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Verify Tool Versions
        shell: pwsh
        run: |
          Write-Host "`n=== TOOL VERSION VERIFICATION ===" -ForegroundColor Cyan

          $tools = @(
            @{ Name = "Node"; Cmd = "node --version" },
            @{ Name = "npm"; Cmd = "npm --version" },
            @{ Name = "Python"; Cmd = "python --version" },
            @{ Name = "pip"; Cmd = "pip --version" }
          )

          foreach ($tool in $tools) {
            $version = & pwsh -Command $tool.Cmd
            Write-Host "  âœ“ $($tool.Name): $version" -ForegroundColor Green
          }

      # ===== FRONTEND BUILD =====
      - name: Frontend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Installing Dependencies ===" -ForegroundColor Cyan
          cd web_platform/frontend

          # Pre-flight check
          if (-not (Test-Path "package-lock.json")) {
            throw "âŒ FATAL: package-lock.json missing! (lockfile integrity required)"
          }

          npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../../logs/npm-install.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`nâŒ npm ci FAILED" -ForegroundColor Red
            Get-Content ../../logs/npm-install.log | Select-Object -Last 50 | Write-Host
            throw "Frontend npm install failed"
          }

          # Verify critical packages
          $requiredPkgs = @("next", "react", "react-dom")
          foreach ($pkg in $requiredPkgs) {
            if (-not (Test-Path "node_modules/$pkg")) {
              throw "âŒ FATAL: Required package '$pkg' not installed"
            }
          }

          Write-Host "âœ… Frontend dependencies installed & verified" -ForegroundColor Green

      - name: Frontend - Build Static Export
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Building Static Export ===" -ForegroundColor Cyan
          cd web_platform/frontend

          # Pre-build verification
          if (-not (Test-Path "next.config.mjs")) {
            throw "âŒ FATAL: next.config.mjs missing"
          }

          npm run build 2>&1 | Tee-Object -FilePath ../../logs/frontend-build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`nâŒ Frontend build FAILED" -ForegroundColor Red
            Get-Content ../../logs/frontend-build.log | Select-Object -Last 100 | Write-Host
            throw "Frontend build failed"
          }

          # POST-BUILD VERIFICATION (CRITICAL)
          $requiredFiles = @("out/index.html", "out/_next")
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              throw "âŒ FATAL: Expected output file missing: $file"
            }
            Write-Host "  âœ“ Verified: $file" -ForegroundColor Green
          }

          $fileCount = @(Get-ChildItem -Path "out" -Recurse -File).Count
          Write-Host "âœ… Frontend built: $fileCount files" -ForegroundColor Green

          # Generate manifest
          @(Get-ChildItem -Path "out" -Recurse -File | Select-Object FullName) | ConvertTo-Json | Out-File ../../logs/frontend-manifest.json

      - name: Frontend - Stage to Electron
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Staging to Electron ===" -ForegroundColor Cyan

          $src = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (-not (Test-Path $src)) {
            throw "âŒ FATAL: Frontend output directory not found at $src"
          }

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          $filesBefore = @(Get-ChildItem -Path $src -Recurse -File).Count
          Copy-Item -Path "$src/*" -Destination $dest -Recurse -Force -ErrorAction Stop
          $filesAfter = @(Get-ChildItem -Path $dest -Recurse -File).Count

          if ($filesBefore -ne $filesAfter) {
            throw "âŒ FATAL: File count mismatch during copy ($filesBefore -> $filesAfter)"
          }

          if (-not (Test-Path "$dest/index.html")) {
            throw "âŒ FATAL: index.html not found in staging directory"
          }

          Write-Host "âœ… Frontend staged: $filesAfter files" -ForegroundColor Green

      # ===== BACKEND BUILD =====
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Installing Dependencies ===" -ForegroundColor Cyan

          if (-not (Test-Path "python_service/requirements.txt")) {
            throw "âŒ FATAL: requirements.txt not found"
          }

          pip install --upgrade pip wheel setuptools 2>&1 | Tee-Object -FilePath logs/pip-upgrade.log

          pip install -r python_service/requirements.txt --no-cache-dir 2>&1 | Tee-Object -FilePath logs/pip-install.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`nâŒ pip install FAILED" -ForegroundColor Red
            Get-Content logs/pip-install.log | Select-Object -Last 50 | Write-Host
            throw "Backend pip install failed"
          }

          # Verify critical packages
          $criticalPkgs = @("fastapi", "uvicorn", "pydantic")
          $installedPkgs = pip list --format=freeze 2>&1

          foreach ($pkg in $criticalPkgs) {
            $found = $installedPkgs | Select-String -Pattern "^$($pkg.ToLower())==" -Quiet -CaseSensitive
            if (-not $found) {
              Write-Host "âŒ FATAL: Critical package '$pkg' not found in pip list." -ForegroundColor Red
              Write-Host "--- Installed Packages ---"
              $installedPkgs | Write-Host
              throw "âŒ FATAL: Critical package '$pkg' not installed"
            }
            Write-Host "  âœ“ Verified: $pkg" -ForegroundColor Green
          }

          Write-Host "âœ… Backend dependencies installed & verified" -ForegroundColor Green

      - name: Backend - Verify Source Files
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Source File Verification ===" -ForegroundColor Cyan

          $requiredFiles = @(
            "run_backend.py",
            "python_service/main.py",
            "python_service/adapters"
          )

          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              throw "âŒ FATAL: Required source file missing: $file"
            }
            Write-Host "  âœ“ Found: $file" -ForegroundColor Green
          }

      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Building Executable with PyInstaller ===" -ForegroundColor Cyan

          $adaptersPath = (Resolve-Path -Path "python_service/adapters").Path
          $addDataArg = "$adaptersPath;adapters"

          Write-Host "  â†’ PyInstaller --add-data: $addDataArg" -ForegroundColor Yellow

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --clean `
            --noconfirm `
            --distpath electron/resources `
            --workpath python_service/build-pyinstaller `
            --specpath python_service/spec-pyinstaller `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.http.h11_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.protocols.websockets.wsproto_impl `
            --hidden-import=uvicorn.protocols.websockets.websockets_impl `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=fastapi.responses `
            --hidden-import=fastapi.exceptions `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=pydantic_core._pydantic_core `
            --hidden-import=typing_extensions `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=httpcore `
            --hidden-import=httpcore._sync `
            --hidden-import=httpcore._async `
            --hidden-import=h11 `
            --hidden-import=certifi `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --hidden-import=aiosqlite `
            --hidden-import=_sqlite3 `
            --hidden-import=sqlite3 `
            --hidden-import=keyring `
            --hidden-import=keyring.backends.Windows `
            --hidden-import=bs4 `
            --hidden-import=lxml `
            --hidden-import=html5lib `
            --hidden-import=dateutil `
            --hidden-import=pandas `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --collect-all=pydantic `
            --collect-all=pydantic_core `
            --collect-all=aiosqlite `
            --collect-all=httpx `
            --collect-all=certifi `
            --collect-all=bs4 `
            --collect-all=pandas `
            --copy-metadata=pydantic `
            --copy-metadata=pydantic_core `
            --copy-metadata=fastapi `
            --copy-metadata=uvicorn `
            --add-data $addDataArg `
            run_backend.py `
            2>&1 | Tee-Object -FilePath logs/pyinstaller.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`nâŒ PyInstaller FAILED" -ForegroundColor Red
            Get-Content logs/pyinstaller.log | Select-Object -Last 100 | Write-Host
            throw "PyInstaller build failed"
          }

          Write-Host "âœ… PyInstaller completed successfully" -ForegroundColor Green

      - name: Backend - Verify Executable
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Executable Verification ===" -ForegroundColor Cyan

          $exe = "electron/resources/fortuna-backend.exe"

          if (-not (Test-Path $exe)) {
            throw "âŒ FATAL: Backend executable not found at: $exe"
          }

          $exeInfo = Get-Item $exe
          $size = $exeInfo.Length / 1MB
          $fileHash = (Get-FileHash -Path $exe -Algorithm SHA256).Hash

          Write-Host "  âœ“ Path: $exe" -ForegroundColor Green
          Write-Host "  âœ“ Size: $([math]::Round($size, 2)) MB" -ForegroundColor Green
          Write-Host "  âœ“ SHA256: $fileHash" -ForegroundColor Green
          Write-Host "  âœ“ Last Modified: $($exeInfo.LastWriteTime)" -ForegroundColor Green

          # Verify minimum size (should be 100+ MB with FastAPI/pandas)
          if ($exeInfo.Length -lt 50MB) {
            throw "âŒ FATAL: Executable seems too small ($([math]::Round($size, 2)) MB). Possible packaging error."
          }

          # Try to extract version info
          $versionInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($exe)
          Write-Host "  âœ“ Executable is valid PE file" -ForegroundColor Green

      - name: Backend - Deep Integration Test
        shell: pwsh
        timeout-minutes: 10
        run: |
          Write-Host "`n=== BACKEND: FORTRESS INTEGRATION TEST ===" -ForegroundColor Cyan

          $exe = "electron/resources/fortuna-backend.exe"
          $testDir = "backend-test-env"
          $testPort = "8000"

          if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir }
          New-Item -ItemType Directory -Path $testDir -Force | Out-Null

          # Set environment
          $env:API_KEY = "${{ env.API_KEY }}"
          $env:PORT = $testPort
          $env:HOST = "127.0.0.1"

          Write-Host "Starting executable test..." -ForegroundColor Yellow
          Write-Host "  Port: $testPort | API_KEY length: $($env:API_KEY.Length)" -ForegroundColor DarkYellow

          $process = Start-Process -FilePath $exe `
            -WorkingDirectory $testDir `
            -PassThru -NoNewWindow `
            -RedirectStandardOutput "$testDir/stdout.log" `
            -RedirectStandardError "$testDir/stderr.log"

          Write-Host "Process PID: $($process.Id)" -ForegroundColor DarkYellow
          Start-Sleep -Seconds 2

          # Display initial output
          Write-Host "`n--- Initial Backend Output (first 2s) ---" -ForegroundColor DarkCyan
          if (Test-Path "$testDir/stdout.log") {
            Get-Content "$testDir/stdout.log" | Write-Host -ForegroundColor Green
          }
          if (Test-Path "$testDir/stderr.log") {
            Get-Content "$testDir/stderr.log" | Write-Host -ForegroundColor Yellow
          }

          # Health check loop with aggressive diagnostics
          $maxAttempts = 120
          $serverReady = $false

          for ($i = 1; $i -le $maxAttempts; $i++) {
            Start-Sleep -Seconds 1

            # CRASH CHECK
            if ($process.HasExited) {
              Write-Host "`nâŒ PROCESS CRASHED (exit code: $($process.ExitCode))" -ForegroundColor Red
              Write-Host "`n--- STDERR at crash ---" -ForegroundColor Red
              Get-Content "$testDir/stderr.log" | Write-Host
              Write-Host "`n--- STDOUT at crash ---" -ForegroundColor Red
              Get-Content "$testDir/stdout.log" | Write-Host

              Copy-Item "$testDir/stderr.log" "diagnostics/backend-crash-stderr.txt" -ErrorAction SilentlyContinue
              Copy-Item "$testDir/stdout.log" "diagnostics/backend-crash-stdout.txt" -ErrorAction SilentlyContinue

              throw "âŒ FATAL: Backend process crashed during startup"
            }

            # HEALTH CHECK
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:$testPort/health" -TimeoutSec 2 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                $serverReady = $true
                Write-Host "`nâœ… HEALTH CHECK PASSED (attempt $i/$maxAttempts)" -ForegroundColor Green
                break
              }
            } catch {
              Write-Host "." -NoNewline

              # Every 20 attempts, dump diagnostics
              if ($i % 20 -eq 0) {
                Write-Host "`n[Attempt $i/$maxAttempts - diagnostic dump]" -ForegroundColor DarkYellow

                # Check port binding
                $portStatus = netstat -ano 2>/dev/null | Select-String ":$testPort"
                if ($portStatus) {
                  Write-Host "  Port $testPort: LISTENING" -ForegroundColor Green
                } else {
                  Write-Host "  Port $testPort: NOT LISTENING âš ï¸" -ForegroundColor Yellow
                }

                # Show logs
                if (Test-Path "$testDir/stdout.log") {
                  Write-Host "  STDOUT (last 3 lines):" -ForegroundColor Green
                  Get-Content "$testDir/stdout.log" -Tail 3 | Write-Host -ForegroundColor Green
                }

                if (Test-Path "$testDir/stderr.log") {
                  Write-Host "  STDERR (last 3 lines):" -ForegroundColor Yellow
                  Get-Content "$testDir/stderr.log" -Tail 3 | Write-Host -ForegroundColor Yellow
                }
              }
            }
          }

          if (-not $serverReady) {
            Write-Host "`nâŒ HEALTH CHECK FAILED AFTER $maxAttempts SECONDS" -ForegroundColor Red

            Write-Host "`n=== FULL DIAGNOSTICS ===" -ForegroundColor Red

            Write-Host "`n--- Port Status ---" -ForegroundColor Red
            netstat -ano | Select-String ":$testPort|:8000|:8999|:8998" | Write-Host

            Write-Host "`n--- Full STDERR ---" -ForegroundColor Red
            Get-Content "$testDir/stderr.log" | Write-Host

            Write-Host "`n--- Full STDOUT ---" -ForegroundColor Red
            Get-Content "$testDir/stdout.log" | Write-Host

            Write-Host "`n--- Process Check ---" -ForegroundColor Red
            Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue | Write-Host

            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
            throw "âŒ FATAL: Backend never responded to health checks"
          }

          # Endpoint testing (CRITICAL PATH)
          Write-Host "`n=== ENDPOINT VALIDATION ===" -ForegroundColor Cyan

          $endpoints = @(
            @{ Path = "/health"; Name = "Health"; ExpectedCode = 200 },
            @{ Path = "/api/status"; Name = "Status"; ExpectedCode = 200 },
            @{ Path = "/docs"; Name = "OpenAPI"; ExpectedCode = 200 }
          )

          $allPassed = $true
          foreach ($ep in $endpoints) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:$testPort$($ep.Path)" -TimeoutSec 5 -ErrorAction Stop
              if ($response.StatusCode -eq $ep.ExpectedCode) {
                Write-Host "  âœ… $($ep.Name): $($response.StatusCode)" -ForegroundColor Green
              } else {
                Write-Host "  âŒ $($ep.Name): Got $($response.StatusCode), expected $($ep.ExpectedCode)" -ForegroundColor Red
                $allPassed = $false
              }
            } catch {
              Write-Host "  âŒ $($ep.Name): $($_.Exception.Message)" -ForegroundColor Red
              $allPassed = $false
            }
          }

          # Cleanup
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 1

          # Save diagnostics
          Copy-Item "$testDir/stderr.log" "logs/backend-integration-stderr.log" -ErrorAction SilentlyContinue
          Copy-Item "$testDir/stdout.log" "logs/backend-integration-stdout.log" -ErrorAction SilentlyContinue

          if (-not $allPassed) {
            throw "âŒ FATAL: Some endpoint tests failed"
          }

          Write-Host "`nâœ… INTEGRATION TEST COMPLETE - ALL SYSTEMS GO" -ForegroundColor Green

      # ===== E2E UI TEST =====
      - name: 'ğŸ“¸ End-to-End UI Test (Fortress Mode)'
        shell: pwsh
        timeout-minutes: 10
        run: |
          Write-Host "`n=== E2E UI TEST: FORTRESS MODE ===" -ForegroundColor Magenta

          $backendExe = "electron/resources/fortuna-backend.exe"
          $frontendDir = "electron/web-ui-build/out"
          $backendPort = "8999"
          $frontendPort = "8998"
          $testDir = "e2e-test-env"

          if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir }
          New-Item -ItemType Directory -Path $testDir -Force | Out-Null

          $env:API_KEY = "${{ env.API_KEY }}"
          $env:PORT = $backendPort
          $env:HOST = "127.0.0.1"
          $env:ALLOWED_ORIGINS = "http://127.0.0.1:$frontendPort"

          $backendProcess = $null
          $frontendProcess = $null

          try {
              Write-Host "`nğŸš€ Starting E2E backend on :$backendPort..." -ForegroundColor Cyan
              $backendProcess = Start-Process -FilePath $backendExe `
                -WorkingDirectory $testDir -PassThru -NoNewWindow `
                -RedirectStandardOutput "$testDir/backend-stdout.log" `
                -RedirectStandardError "$testDir/backend-stderr.log"

              $maxAttempts = 60
              $serverReady = $false
              for ($i = 1; $i -le $maxAttempts; $i++) {
                Start-Sleep -Seconds 1
                if ($backendProcess.HasExited) {
                  throw "âŒ Backend crashed during E2E startup"
                }
                try {
                  $response = Invoke-WebRequest -Uri "http://127.0.0.1:$backendPort/health" -TimeoutSec 2 -ErrorAction Stop
                  if ($response.StatusCode -eq 200) {
                    $serverReady = $true
                    Write-Host "âœ… Backend ready (E2E)" -ForegroundColor Green
                    break
                  }
                } catch { Write-Host "." -NoNewline }
              }
              if (-not $serverReady) { throw "Backend E2E startup timeout" }

              Write-Host "`nğŸš€ Starting frontend on :$frontendPort..." -ForegroundColor Cyan
              $frontendProcess = Start-Process python -ArgumentList "-m http.server $frontendPort --directory $frontendDir" `
                -PassThru -NoNewWindow `
                -RedirectStandardOutput "$testDir/frontend-stdout.log" `
                -RedirectStandardError "$testDir/frontend-stderr.log"
              Start-Sleep -Seconds 3

              Write-Host "`nğŸ­ Installing Playwright & Chromium..." -ForegroundColor Cyan
              pip install playwright 2>&1 | Out-Null
              playwright install --with-deps chromium 2>&1 | Out-Null
              Write-Host "âœ… Playwright ready" -ForegroundColor Green

              Write-Host "`nâœï¸  Running E2E screenshot test..." -ForegroundColor Cyan
              $pyScript = @(
                  "from playwright.sync_api import sync_playwright",
                  "import sys",
                  "import json",
                  "",
                  "def run(playwright):",
                  "    browser = playwright.chromium.launch()",
                  "    page = browser.new_page()",
                  "    try:",
                  "        url = f'http://127.0.0.1:$frontendPort'",
                  "        print(f'[E2E] Navigating to {url}')",
                  "        page.goto(url, timeout=20000)",
                  "        print('[E2E] Waiting for body element')",
                  "        page.wait_for_selector('body', timeout=10000)",
                  "        print('[E2E] Page loaded successfully')",
                  "        page.screenshot(path='e2e-screenshot.png', full_page=True)",
                  "        print('[E2E] âœ… E2E TEST PASSED')",
                  "    except Exception as e:",
                  "        print(f'[E2E] âŒ E2E TEST FAILED: {e}', file=sys.stderr)",
                  "        page.screenshot(path='e2e-screenshot-failed.png', full_page=True)",
                  "        raise",
                  "    finally:",
                  "        browser.close()",
                  "",
                  "with sync_playwright() as playwright:",
                  "    run(playwright)"
              ) -join "`n"
              Set-Content -Path "run_e2e_test.py" -Value $pyScript

              py run_e2e_test.py 2>&1 | Tee-Object -FilePath "$testDir/playwright.log"
              if ($LASTEXITCODE -ne 0) { throw "E2E test failed" }

              Write-Host "âœ… E2E UI Test PASSED" -ForegroundColor Green

          } finally {
              Write-Host "`nğŸ§¹ Cleaning up E2E processes..." -ForegroundColor Cyan
              if ($backendProcess -and -not $backendProcess.HasExited) { Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue }
              if ($frontendProcess -and -not $frontendProcess.HasExited) { Stop-Process -Id $frontendProcess.Id -Force -ErrorAction SilentlyContinue }
              Copy-Item "$testDir/*.log" "logs/" -ErrorAction SilentlyContinue -Force
          }

      # ===== ELECTRON BUILD =====
      - name: Electron - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Installing Dependencies ===" -ForegroundColor Cyan
          cd electron

          if (-not (Test-Path "package-lock.json")) {
            throw "âŒ FATAL: Electron package-lock.json missing"
          }

          npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../logs/npm-electron.log

          if ($LASTEXITCODE -ne 0) {
            throw "Electron npm install failed"
          }

          # Verify critical Electron packages
          if (-not (Test-Path "node_modules/electron")) {
            throw "âŒ FATAL: Electron not installed"
          }

          Write-Host "âœ… Electron dependencies installed" -ForegroundColor Green

      - name: Electron - Pre-Build Verification (CRITICAL)
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: PRE-BUILD VERIFICATION ===" -ForegroundColor Cyan

          $checks = @{
            "main.js" = "electron/main.js"
            "preload.js" = "electron/preload.js"
            "package.json" = "electron/package.json"
            "electron-builder-config.yml" = "electron/electron-builder-config.yml"
            "icon.ico" = "electron/assets/icon.ico"
            "backend.exe" = "electron/resources/fortuna-backend.exe"
            "frontend/index.html" = "electron/web-ui-build/out/index.html"
            "frontend/_next" = "electron/web-ui-build/out/_next"
          }

          $allPresent = $true
          foreach ($name in $checks.Keys) {
            $path = $checks[$name]
            if (-not (Test-Path $path)) {
              Write-Host "  âŒ MISSING: $name" -ForegroundColor Red
              $allPresent = $false
            } else {
              $item = Get-Item $path
              $size = if ($item.PSIsContainer) { "[DIR]" } else { "$($item.Length / 1KB) KB" }
              Write-Host "  âœ“ $name ($size)" -ForegroundColor Green
            }
          }

          if (-not $allPresent) {
            throw "âŒ FATAL: Some required files are missing"
          }

          Write-Host "`nâœ… All pre-build checks passed" -ForegroundColor Green

      - name: Electron - Validate Configuration
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Configuration Validation ===" -ForegroundColor Cyan

          $configPath = "electron/electron-builder-config.yml"
          $configContent = Get-Content $configPath -Raw

          $requiredStrings = @(
            "artifactName",
            "directories",
            "files",
            "nsis"
          )

          foreach ($req in $requiredStrings) {
            if ($configContent -notmatch $req) {
              throw "âŒ FATAL: electron-builder config missing required key: $req"
            }
            Write-Host "  âœ“ Found: $req" -ForegroundColor Green
          }

          Write-Host "âœ… Configuration is valid" -ForegroundColor Green

      - name: Electron - Build MSI
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: BUILDING MSI ===" -ForegroundColor Cyan
          cd electron

          $startTime = Get-Date
          Write-Host "Build start: $startTime" -ForegroundColor DarkYellow

          npx electron-builder --config electron-builder-config.yml --publish never 2>&1 | Tee-Object -FilePath ../logs/electron-builder.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`nâŒ electron-builder FAILED" -ForegroundColor Red
            Get-Content ../logs/electron-builder.log | Select-Object -Last 100 | Write-Host
            throw "MSI build failed"
          }

          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalSeconds
          Write-Host "âœ… MSI build completed in $([math]::Round($duration))s" -ForegroundColor Green

      # ===== POST-BUILD VERIFICATION =====
      - name: Post-Build - Locate & Verify MSI
        shell: pwsh
        run: |
          Write-Host "`n=== POST-BUILD: MSI VERIFICATION ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $msi) {
            Write-Host "`nâŒ FATAL: MSI file not found!" -ForegroundColor Red
            Write-Host "`nContents of electron/dist:" -ForegroundColor Yellow
            if (Test-Path "electron/dist") {
              Get-ChildItem -Path "electron/dist" -Recurse | ForEach-Object { Write-Host "  $_" }
            } else {
              Write-Host "  (directory does not exist!)"
            }
            throw "MSI not found"
          }

          $size = $msi.Length / 1MB
          $hash = (Get-FileHash -Path $msi.FullName -Algorithm SHA256).Hash

          Write-Host "  âœ“ Filename: $($msi.Name)" -ForegroundColor Green
          Write-Host "  âœ“ Size: $([math]::Round($size, 2)) MB" -ForegroundColor Green
          Write-Host "  âœ“ Path: $($msi.FullName)" -ForegroundColor Green
          Write-Host "  âœ“ SHA256: $hash" -ForegroundColor Green
          Write-Host "  âœ“ Last Modified: $($msi.LastWriteTime)" -ForegroundColor Green

          # Verify minimum size
          if ($msi.Length -lt 50MB) {
            throw "âŒ FATAL: MSI too small ($([math]::Round($size, 2)) MB). Possible packaging error."
          }

          # Verify it's actually a Windows Installer file (MZ header + "Embedded Document" signature)
          $bytes = [System.IO.File]::ReadAllBytes($msi.FullName)
          if ($bytes[0] -ne 0xD0 -or $bytes[1] -ne 0xCF) {
            throw "âŒ FATAL: MSI file header invalid. Not a valid Windows Installer."
          }

          Write-Host "`nâœ… MSI Verification PASSED" -ForegroundColor Green

          # Save metadata
          @{
            FileName = $msi.Name
            FullPath = $msi.FullName
            SizeMB = [math]::Round($size, 2)
            SHA256 = $hash
            CreatedAt = $msi.LastWriteTime
            BuildID = "${{ github.run_id }}-${{ github.run_number }}"
          } | ConvertTo-Json | Out-File -FilePath "msi-metadata.json" -Force

          $msi.FullName | Out-File -FilePath "msi-path.txt" -Force

      - name: Post-Build - MSI Content Extraction (7-Zip Deep Inspection)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`n=== POST-BUILD: DEEP MSI INSPECTION ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $msi) { return }

          $sevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $sevenZip)) {
            Write-Host "âš ï¸  7-Zip not found. Skipping deep inspection." -ForegroundColor Yellow
            return
          }

          $extractPath = "msi-inspection"
          if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          & $sevenZip x "$($msi.FullName)" -o"$extractPath" -y 2>&1 | Out-Null

          Write-Host "`nMSI Contents:" -ForegroundColor Cyan
          $files = @(Get-ChildItem -Path $extractPath -Recurse -File)
          Write-Host "  Total files: $($files.Count)" -ForegroundColor Green

          $criticalFiles = @(
            "*fortuna-backend.exe",
            "*index.html",
            "*main.js"
          )

          foreach ($pattern in $criticalFiles) {
            $found = $files | Where-Object { $_.Name -like $pattern }
            if ($found) {
              Write-Host "  âœ“ Found: $($found.Name)" -ForegroundColor Green
            } else {
              Write-Host "  âŒ Missing: $pattern" -ForegroundColor Red
            }
          }

      - name: Build Summary - Fortress Report
        shell: pwsh
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Magenta
          Write-Host "â•‘              ğŸ† FORTRESS BUILD COMPLETE ğŸ†                  â•‘" -ForegroundColor Magenta
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Magenta

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($msi) {
            Write-Host "`nğŸ“¦ DELIVERABLE:" -ForegroundColor Green
            Write-Host "   âœ… MSI Installer: $($msi.Name)" -ForegroundColor Green
            Write-Host "   âœ… Size: $([math]::Round($msi.Length / 1MB, 2)) MB" -ForegroundColor Green
            Write-Host "   âœ… SHA256: $((Get-FileHash -Path $msi.FullName -Algorithm SHA256).Hash.Substring(0, 16))..." -ForegroundColor Green
          }

          Write-Host "`nâœ… VERIFICATION CHECKLIST:" -ForegroundColor Green
          Write-Host "   âœ… Frontend: Built & staged to Electron" -ForegroundColor Green
          Write-Host "   âœ… Backend: PyInstaller executable created & tested" -ForegroundColor Green
          Write-Host "   âœ… Integration: Health checks & endpoint validation passed" -ForegroundColor Green
          Write-Host "   âœ… E2E UI: Playwright screenshot test passed" -ForegroundColor Green
          Write-Host "   âœ… Packaging: MSI created & validated" -ForegroundColor Green

          Write-Host "`nğŸ“Š BUILD ARTIFACTS:" -ForegroundColor Cyan
          Write-Host "   â€¢ Build logs: logs/" -ForegroundColor Cyan
          Write-Host "   â€¢ Diagnostics: diagnostics/" -ForegroundColor Cyan
          Write-Host "   â€¢ MSI metadata: msi-metadata.json" -ForegroundColor Cyan
          Write-Host "   â€¢ Screenshots: e2e-screenshot.png" -ForegroundColor Cyan

          Write-Host "`nğŸš€ READY FOR DEPLOYMENT" -ForegroundColor Green
          Write-Host "   This MSI has passed all fortress-level quality gates." -ForegroundColor Green
          Write-Host "`n" -ForegroundColor Magenta

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fortuna-installer-${{ github.ref_name }}
          path: electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      - name: Upload Build Diagnostics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-diagnostics-${{ github.ref_name }}
          path: |
            logs/
            diagnostics/
            msi-metadata.json
            build-telemetry.json
          retention-days: 14
          if-no-files-found: warn

      - name: Upload E2E Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-screenshots-${{ github.ref_name }}
          path: |
            e2e-screenshot.png
            e2e-screenshot-failed.png
          retention-days: 30
          if-no-files-found: warn

      # ===== GITHUB RELEASE (Tags Only) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            # ğŸ† Fortuna Faucet ${{ github.ref_name }}

            ## ğŸ“¦ What's Included
            - âœ… Python FastAPI backend (standalone executable)
            - âœ… Next.js frontend (static HTML/CSS/JS)
            - âœ… Electron desktop wrapper
            - âœ… NSIS Windows installer

            ## âš™ï¸ Installation
            1. Download the `.msi` installer below
            2. Run installer (admin privileges required)
            3. Application will appear in Start Menu
            4. Launch and enjoy!

            ## ğŸ“‹ System Requirements
            - **OS**: Windows 10 (Build 19041+) or Windows 11
            - **Architecture**: 64-bit only
            - **RAM**: 2 GB minimum recommended
            - **Disk Space**: 300 MB for installation
            - **No dependencies**: Python, Node.js, or runtime not required

            ## âœ¨ Build Information
            - **Build ID**: ${{ github.run_id }}
            - **Build Number**: ${{ github.run_number }}
            - **Commit**: ${{ github.sha }}
            - **Built with**: GitHub Actions (Windows Latest)

            ## ğŸ”’ Verification
            All builds are created with fortress-level quality assurance:
            - âœ… System health verification
            - âœ… Dependency integrity checks
            - âœ… Frontend build validation
            - âœ… Backend PyInstaller testing
            - âœ… Integration test suite
            - âœ… End-to-end UI validation
            - âœ… MSI package inspection

            **Built with â¤ï¸ by GitHub Actions - Fortress Mode**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}