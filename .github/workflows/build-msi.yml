name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            electron/package-lock.json
            web_platform/frontend/package-lock.json
        env:
          SETUP_NODE_CACHE_KEY: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-20251101

      - name: Install Frontend Dependencies & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build

      - name: Stage Frontend Assets for Packaging
        shell: pwsh
        run: |
          # This script robustly stages the static frontend assets for Electron to package.
          # It ensures the destination is clean, copies the files, and then verifies
          # the file count to prevent packaging an incomplete UI.
          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"
          if (Test-Path $dest) {
            Remove-Item -Recurse -Force $dest
          }
          Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction Stop
          $sourceFiles = (Get-ChildItem -Path $source -Recurse | Measure-Object).Count
          $destFiles = (Get-ChildItem -Path $dest -Recurse | Measure-Object).Count
          if ($destFiles -ne $sourceFiles) {
            Write-Error "File count mismatch after staging frontend assets!"
            exit 1
          }
          Write-Host "Successfully staged $destFiles frontend assets."

      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm ci

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: python_service/requirements.txt
        env:
          SETUP_PYTHON_CACHE_KEY: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}-20251101

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          # Install all Python dependencies from the locked requirements file.
          pip install -r python_service/requirements.txt
          # Run PyInstaller to create a single-file executable.
          # --onefile: Bundles everything into a single .exe.
          # --name: Specifies the output filename.
          # --hidden-import: Explicitly includes modules that PyInstaller might miss.
          # --add-data: Packages the data adapters directory alongside the executable.
          pyinstaller --onefile `
            --name fortuna-backend `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=httpx.models `
            --hidden-import=redis.asyncio `
            --hidden-import=fastapi `
            --hidden-import=pydantic `
            --hidden-import=structlog `
            --hidden-import=httpx `
            --add-data "python_service/adapters:adapters" `
            python_service/api.py

      - name: Stage Backend Executable
        shell: pwsh
        run: |
          $distPath = ".\\dist\\fortuna-backend.exe"
          $destDir = ".\\electron\\resources"
          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }
          if (Test-Path $distPath) {
            Copy-Item -Path $distPath -Destination $destDir -Force
            Write-Host "Backend executable staged successfully."
          } else {
            Write-Error "ERROR: Could not find backend exe at $distPath"
            Get-ChildItem -Path ".\\dist\\" -Recurse
            exit 1
          }

      - name: Verify Build Inputs
        shell: pwsh
        run: |
          $backendExe = ".\\electron\\resources\\fortuna-backend.exe"
          $frontendDir = ".\\electron\\web-ui-build\\out"
          if (-not (Test-Path $backendExe)) {
            Write-Error "CRITICAL: Backend executable not found at $backendExe"
            Get-ChildItem -Path ".\\electron\\resources\\" -Recurse
            exit 1
          }
          if (-not (Test-Path $frontendDir)) {
            Write-Error "CRITICAL: Frontend build directory not found at $frontendDir"
            Get-ChildItem -Path ".\\electron\\web-ui-build\\" -Recurse
            exit 1
          }
          Write-Host "All critical artifacts verified successfully."

      - name: Verify electron/package.json Has Build Config
        shell: pwsh
        run: |
          # This is CRITICAL - verify the build configuration exists
          # before electron-builder runs.
          $packageJson = Get-Content electron/package.json | ConvertFrom-Json

          if (-not $packageJson.build) {
            Write-Error "CRITICAL: electron/package.json missing 'build' section!"
            exit 1
          }

          if (-not $packageJson.build.files) {
            Write-Error "CRITICAL: electron/package.json build section missing 'files' array!"
            exit 1
          }

          $hasResources = $packageJson.build.files -contains "resources/**/*"
          $hasWebUI = $packageJson.build.files -match "web-ui-build"

          if (-not $hasResources) {
            Write-Error "CRITICAL: 'files' does not include resources/**/*"
            exit 1
          }

          if (-not $hasWebUI) {
            Write-Error "CRITICAL: 'files' does not include web-ui-build"
            exit 1
          }

          Write-Host "✅ electron/package.json build configuration is valid"
          Write-Host "Files to include:"
          $packageJson.build.files | ForEach-Object { Write-Host "  - $_" }

      - name: Build MSI Installer using electron-builder
        shell: pwsh
        run: |
          cd electron
          # CRITICAL: electron/package.json MUST have "files" and "asarUnpack"
          # configured to point to:
          #   - resources/ (backend executable)
          #   - web-ui-build/out/ (frontend static build)
          #
          # Without this, electron-builder won't know WHERE to find
          # the backend and frontend assets, resulting in a sparse MSI.
          npm run dist
          if ($LASTEXITCODE -ne 0) {
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }
          Write-Host "--- Verifying contents of electron/dist ---"
          Get-ChildItem -Path dist -Recurse
        env:
          FORTUNA_BUILD_TYPE: 'full'
          DEBUG: 'electron-builder'
          CI: 'true'

      - name: Locate Built MSI Path
        id: locate_msi
        shell: pwsh
        run: |
          # Finds the generated MSI file in the dist directory.
          # It handles cases with no MSI or multiple MSIs, and then
          # exports the path for use in subsequent steps.
          $msiFiles = Get-ChildItem -Path ".\\electron\\dist" -Filter "*.msi" -Recurse
          if ($msiFiles.Count -eq 0) {
            Write-Error "CRITICAL: No MSI files found in electron/dist directory."
            Write-Host "Directory contents:"
            Get-ChildItem -Path ".\\electron\\dist" -Recurse
            exit 1
          }
          if ($msiFiles.Count -gt 1) {
            Write-Warning "Multiple MSI files found. Using the first one: $($msiFiles[0].FullName)"
          }
          $msiPath = $msiFiles[0].FullName
          Write-Host "MSI Path: $msiPath"
          "msi_path=$msiPath" | Add-Content -Path $env:GITHUB_OUTPUT

      - name: Verify MSI Contents (Extract & Inspect)
        shell: pwsh
        run: |
          # Extract the MSI to inspect its actual contents
          $msiPath = "${{ steps.locate_msi.outputs.msi_path }}"
          $extractPath = ".\msi-extract"

          if (-not $msiPath) {
            Write-Error "No MSI found to verify"
            exit 1
          }

          Write-Host "Extracting MSI from: $msiPath"

          # Use 7z to extract the MSI contents
          $null = New-Item -ItemType Directory -Path $extractPath -Force
          & 7z x "$msiPath" -o"$extractPath" -y

          Write-Host ""
          Write-Host "=== MSI Contents ==="
          Get-ChildItem -Path $extractPath -Recurse | Select-Object -Property FullName | ForEach-Object { Write-Host $_.FullName }

          # Specifically look for critical files
          $backendExe = Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue
          $indexHtml = Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue

          if ($backendExe) {
            Write-Host "✅ Backend executable found: $($backendExe.FullName)"
          } else {
            Write-Error "❌ CRITICAL: Backend executable NOT found in MSI"
            exit 1
          }

          if ($indexHtml) {
            Write-Host "✅ Frontend index.html found: $($indexHtml.FullName)"
          } else {
            Write-Error "❌ CRITICAL: Frontend index.html NOT found in MSI"
            exit 1
          }

      - name: Generate sanitized artifact name
        id: sanitize
        shell: bash
        run: echo "name=fortuna-faucet-installer-$(echo ${{ github.ref_name }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.sanitize.outputs.name }}
          path: ${{ steps.locate_msi.outputs.msi_path }}
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ${{ steps.locate_msi.outputs.msi_path }}
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
