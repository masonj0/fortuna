# Cache-buster: 2025-11-02 08:09:23
name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Nuclear Cache & Artifact Clearing
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] Obliterating all caches and previous artifacts ---" -ForegroundColor Magenta
          Write-Host "  ‚Üí Clearing npm cache..."
          npm cache clean --force --verbose
          Write-Host "  ‚Üí Clearing pip cache..."
          pip cache purge

          Write-Host "  ‚Üí Nuking old build artifacts and node_modules..."
          $toNuke = @(
            "dist",
            "build",
            "electron/dist",
            "electron/build",
            "electron/out",
            "electron/node_modules",
            "web_platform/frontend/.next",
            "web_platform/frontend/out",
            "web_platform/frontend/node_modules",
            "node_modules"
          )

          foreach ($path in $toNuke) {
            if (Test-Path $path) {
              Write-Host "    - Removing $path"
              Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
            }
          }
          Write-Host "--- [OVERKILL] Environment is now sterile ---" -ForegroundColor Magenta

      - name: Clear Caches for Fresh Build
        shell: pwsh
        run: |
          Write-Host "Clearing npm and pip caches for cache-busting..." -ForegroundColor Yellow
          npm cache clean --force
          pip cache purge

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # ===== FRONTEND BUILD =====
      - name: Install Frontend Dependencies
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci

      - name: Build Frontend (Static Export)
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Building Next.js frontend for static export..." -ForegroundColor Cyan
          npm run build 2>&1 | Tee-Object -FilePath ../../build-frontend.log

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Frontend build failed! Check build-frontend.log for details."
            exit 1
          }

          if (-not (Test-Path "out/index.html")) {
            Write-Error "Frontend build succeeded but out/index.html not found"
            exit 1
          }

          $fileCount = (Get-ChildItem -Path "out" -Recurse -File | Measure-Object).Count
          Write-Host "‚úÖ Frontend built successfully: $fileCount files" -ForegroundColor Green

      - name: Stage Frontend Assets for Electron
        shell: pwsh
        run: |
          Write-Host "Staging frontend assets..." -ForegroundColor Cyan

          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (Test-Path $dest) {
            Remove-Item -Recurse -Force $dest
          }

          Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction Stop

          $sourceFiles = (Get-ChildItem -Path $source -Recurse -File | Measure-Object).Count
          $destFiles = (Get-ChildItem -Path $dest -Recurse -File | Measure-Object).Count

          if ($destFiles -ne $sourceFiles) {
            Write-Error "File count mismatch! Source: $sourceFiles, Dest: $destFiles"
            exit 1
          }

          if (-not (Test-Path "$dest/index.html")) {
            Write-Error "Critical file missing: index.html"
            exit 1
          }

          Write-Host "‚úÖ Staged $destFiles frontend files to $dest" -ForegroundColor Green

      - name: Diagnostic - Verify Staged Frontend
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Post-Frontend-Staging Directory Listing ===" -ForegroundColor Yellow
          Get-ChildItem -Path ".\electron\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "=========================================================" -ForegroundColor Yellow

      # ===== BACKEND BUILD =====
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Python dependencies..." -ForegroundColor Cyan
          pip install -r python_service/requirements.txt
          Write-Host "‚úÖ Dependencies installed" -ForegroundColor Green

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building backend executable with PyInstaller..." -ForegroundColor Cyan

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --add-data "python_service/adapters;adapters" `
            python_service/api.py 2>&1 | Tee-Object -FilePath build-backend.log

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller failed! Check build-backend.log for details."
            exit 1
          }

          Write-Host "‚úÖ Backend executable built" -ForegroundColor Green

          Write-Host "--- [DIAG] PyInstaller Output (dist/) ---"
          Get-ChildItem -Recurse ".\dist\" | Out-String -Width 120
          Write-Host "-----------------------------------------"

      - name: Stage Backend Executable
        shell: pwsh
        run: |
          Write-Host "Staging backend executable..." -ForegroundColor Cyan

          $exePath = ".\dist\fortuna-backend.exe"
          $destDir = ".\electron\resources"

          if (-not (Test-Path $exePath)) {
            Write-Error "Backend executable not found at: $exePath"
            Get-ChildItem -Path ".\dist\" -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

          $exeSize = (Get-Item $exePath).Length / 1MB
          Write-Host "Backend exe size: $([math]::Round($exeSize, 2)) MB"

          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }

          Copy-Item -Path $exePath -Destination $destDir -Force

          $copiedExe = Join-Path $destDir "fortuna-backend.exe"
          if (-not (Test-Path $copiedExe)) {
            Write-Error "Failed to copy executable to: $copiedExe"
            exit 1
          }

          Write-Host "‚úÖ Backend executable staged successfully" -ForegroundColor Green

          Write-Host "--- [DIAG] Staged Backend Assets (electron/resources) ---"
          Get-ChildItem -Recurse $destDir | Out-String -Width 120
          Write-Host "---------------------------------------------------------"

      - name: Diagnostic - Verify Staged Backend
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Post-Backend-Staging Directory Listing ===" -ForegroundColor Yellow
          Get-ChildItem -Path ".\electron\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "========================================================" -ForegroundColor Yellow

      # ===== ELECTRON BUILD =====
      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm ci

      - name: MEGA VERIFICATION - All Files Present
        shell: pwsh
        run: |
          Write-Host "`n--- [OVERKILL] MEGA VERIFICATION - ALL CRITICAL FILES ---" -ForegroundColor Magenta

          $checks = @(
            @{ name = "Electron: main.js"; path = "electron/main.js" },
            @{ name = "Electron: preload.js"; path = "electron/preload.js" },
            @{ name = "Electron: package.json"; path = "electron/package.json" },
            @{ name = "Asset: icon.ico"; path = "electron/assets/icon.ico" },
            @{ name = "BACKEND: fortuna-backend.exe"; path = "electron/resources/fortuna-backend.exe" },
            @{ name = "FRONTEND: index.html"; path = "electron/web-ui-build/out/index.html" },
            @{ name = "FRONTEND: _next dir"; path = "electron/web-ui-build/out/_next" }
          )

          $allGood = $true
          foreach ($check in $checks) {
            $exists = Test-Path $check.path
            $status = if ($exists) { "[ ‚úÖ OK ]" } else { "[ ‚ùå FAILED ]" }
            $color = if ($exists) { "Green" } else { "Red" }

            if ($exists) {
              if (Test-Path $check.path -PathType Container) {
                $count = @(Get-ChildItem -Path $check.path -Recurse -File).Count
                Write-Host "$status $($check.name): Found directory with $count files" -ForegroundColor $color
              } else {
                $size = (Get-Item $check.path).Length
                if ($size -gt 1MB) { $sizeStr = "$([math]::Round($size / 1MB, 2)) MB" }
                elseif ($size -gt 1KB) { $sizeStr = "$([math]::Round($size / 1KB, 2)) KB" }
                else { $sizeStr = "$size bytes" }
                Write-Host "$status $($check.name): Found file ($sizeStr)" -ForegroundColor $color
              }
            } else {
              Write-Host "$status $($check.name): MISSING at $($check.path)" -ForegroundColor $color
              $allGood = $false
            }
          }

          if (-not $allGood) {
            Write-Error "MEGA VERIFICATION FAILED! Critical assets are missing before the build step."
            exit 1
          }

          Write-Host "`n--- [OVERKILL] MEGA VERIFICATION PASSED! ALL ASSETS ARE STAGED ---" -ForegroundColor Magenta

      - name: Diagnostic - Directory Structure Before Build
        shell: pwsh
        run: |
          Write-Host "`n=== [DIAG] Final Pre-Build Workspace State ===" -ForegroundColor Yellow
          Write-Host "--- electron/package.json ---"
          Get-Content -Path ".\electron\package.json" | Write-Host
          Write-Host "-----------------------------"
          Write-Host
          Write-Host "--- Workspace Directory Listing ---"
          Get-ChildItem -Path ".\" -Recurse -Depth 4 | ForEach-Object { Write-Host $_.FullName }
          Write-Host "----------------------------------"
          Write-Host "=================================================" -ForegroundColor Yellow

      - name: Build MSI Installer (Absolute Path Overkill)
        shell: pwsh
        run: |
          Write-Host "--- [OVERKILL] Preparing Absolute Path Configuration ---" -ForegroundColor Magenta

          # 1. Get the runner's absolute path and normalize it for YAML/JSON.
          $absolutePath = (Get-Location).Path.Replace('\', '/')
          Write-Host "  Runner absolute path: $absolutePath"

          # 2. Read the template and inject the absolute path.
          $template = Get-Content "electron/electron-builder-config.yml" -Raw
          $finalConfig = $template.Replace("__ABSOLUTE_PATH__", $absolutePath)

          # 3. Force-write the final, absolute-pathed config.
          $configPath = "electron/electron-builder-config.yml"
          Set-Content -Path $configPath -Value $finalConfig -Force

          Write-Host "`n--- [OVERKILL] Final Configuration ---" -ForegroundColor Magenta
          Get-Content $configPath | Write-Host
          Write-Host "------------------------------------" -ForegroundColor Magenta

          Write-Host "`n=== BUILDING MSI INSTALLER (ABSOLUTE PATH MODE) ===" -ForegroundColor Cyan

          # 4. Run from the root, explicitly telling the builder where the project is and what config to use.
          npx electron-builder --projectDir electron --config $configPath 2>&1 | Tee-Object -FilePath build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n--- Build Log ---"
            Get-Content build.log
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "‚úÖ MSI build completed successfully" -ForegroundColor Green
        env:
          CI: 'true'

      # ===== POST-BUILD VERIFICATION =====
      - name: Verify MSI Exists
        shell: pwsh
        run: |
          Write-Host "`n=== LOCATING MSI ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Host "Directory contents of electron/dist:"
            Get-ChildItem -Path ".\electron\dist" -Recurse | ForEach-Object { Write-Host $_.FullName }
            Write-Error "No MSI file found in electron/dist"
            exit 1
          }

          $msiSize = $msiFile.Length / 1MB
          Write-Host "‚úÖ MSI found: $($msiFile.Name) ($([math]::Round($msiSize, 2)) MB)" -ForegroundColor Green

      - name: Extract and Verify MSI Contents (Non-Fatal)
        shell: pwsh
        run: |
          Write-Host "`n=== VERIFYING MSI CONTENTS (NON-FATAL) ===" -ForegroundColor Cyan

          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1
          # If no MSI, we can't continue this step, but we won't fail the build.
          if (-not $msiFile) {
            Write-Host "  [WARNING] No MSI file found to verify. Skipping verification." -ForegroundColor Yellow
            return
          }

          $extractPath = ".\msi-extract"

          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          # Using 7-Zip is more reliable for extraction forensics
          $sevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $sevenZip)) {
              Write-Host "  [WARNING] 7-Zip not found. MSI extraction may be incomplete. Skipping verification." -ForegroundColor Yellow
              return
          }

          & $sevenZip x "$($msiFile.FullName)" -o"$extractPath" -y | Out-Null

          $cabFile = Get-ChildItem -Path $extractPath -Recurse -Filter "*.cab" | Select-Object -First 1
          if ($cabFile) {
            $cabPath = ".\cab-extract"
            if (Test-Path $cabPath) { Remove-Item -Recurse -Force $cabPath }
            New-Item -ItemType Directory -Path $cabPath -Force | Out-Null
            & $sevenZip x "$($cabFile.FullName)" -o"$cabPath" -y | Out-Null
            $extractPath = $cabPath
          }

          $backend = @(Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue)
          $frontendIndex = @(Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue)
          $mainJs = @(Get-ChildItem -Path $extractPath -Recurse -Filter "main.js" -ErrorAction SilentlyContinue)

          Write-Host "`nüì¶ Final MSI Contents Analysis:"
          $missing = @()
          if ($backend.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Backend executable FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Backend executable NOT FOUND" -ForegroundColor Red
            $missing += "fortuna-backend.exe"
          }

          if ($frontendIndex.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Frontend (index.html) FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Frontend (index.html) NOT FOUND" -ForegroundColor Red
            $missing += "index.html"
          }

          if ($mainJs.Count -gt 0) {
            Write-Host "  [ ‚úÖ PASS ] Electron main process (main.js) FOUND" -ForegroundColor Green
          } else {
            Write-Host "  [ ‚ùå FAIL ] Electron main process (main.js) NOT FOUND" -ForegroundColor Red
            $missing += "main.js"
          }

          if ($missing.Count -gt 0) {
            Write-Host "`n[ERROR] MSI verification failed. Missing required assets: $($missing -join ', ')" -ForegroundColor Red
            Write-Host "Build will continue, but the resulting MSI is likely non-functional." -ForegroundColor Yellow
            Write-Host "`n--- Contents of extracted MSI for debugging ---" -ForegroundColor Yellow
            Get-ChildItem -Path $extractPath -Recurse -Depth 4 | Select-Object -First 200 | ForEach-Object { Write-Host $_.FullName }
            Write-Host "---------------------------------------------" -ForegroundColor Yellow
          } else {
            Write-Host "`n[SUCCESS] MSI verification passed! All critical assets are present in the installer." -ForegroundColor Green
          }

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-faucet-installer-${{ github.ref_name }}
          path: ./electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      - name: Upload Build Logs for Forensic Analysis
        uses: actions/upload-artifact@v4
        if: always() # Always run this step to get logs even if the build fails
        with:
          name: fortuna-build-logs-${{ github.ref_name }}
          path: |
            build-frontend.log
            build-backend.log
            build.log
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Extracted MSI for Forensic Analysis
        uses: actions/upload-artifact@v4
        if: always() # Always run this step
        with:
          name: fortuna-msi-extraction-${{ github.ref_name }}
          path: |
            ./msi-extract/
            ./cab-extract/
          retention-days: 7
          if-no-files-found: warn

      # ===== RELEASE (on tags) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ./electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            ## Fortuna Faucet Release ${{ github.ref_name }}

            ### What's Inside
            - ‚úÖ Python FastAPI backend (packaged as standalone executable)
            - ‚úÖ Next.js frontend (static HTML/CSS/JS)
            - ‚úÖ Electron desktop wrapper

            ### Installation
            1. Download the `.msi` installer below
            2. Run the installer (requires Administrator privileges)
            3. Launch "Fortuna Faucet" from your Start Menu

            ### Requirements
            - Windows 10/11 (64-bit)
            - No Python or Node.js installation required!

            ---
            *Built with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
