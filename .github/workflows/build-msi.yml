# Cache-buster: 2025-11-02 08:09:23
name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 45  # Increased timeout for safety

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clear Caches for Fresh Build
        shell: pwsh
        run: |
          Write-Host "Clearing npm and pip caches for cache-busting..." -ForegroundColor Yellow
          npm cache clean --force
          pip cache purge

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            electron/package-lock.json
            web_platform/frontend/package-lock.json

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: python_service/requirements.txt

      # ===== FRONTEND BUILD =====
      - name: Install Frontend Dependencies
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci

      - name: Build Frontend (Static Export)
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Building Next.js frontend for static export..." -ForegroundColor Cyan
          npm run build

          # Verify the build succeeded
          if (-not (Test-Path "out/index.html")) {
            Write-Error "Frontend build failed - out/index.html not found"
            exit 1
          }

          $fileCount = (Get-ChildItem -Path "out" -Recurse -File | Measure-Object).Count
          Write-Host "✅ Frontend built successfully: $fileCount files in out/" -ForegroundColor Green

      - name: Stage Frontend Assets for Electron
        shell: pwsh
        run: |
          Write-Host "Staging frontend assets for Electron packaging..." -ForegroundColor Cyan

          $source = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          # Clean destination
          if (Test-Path $dest) {
            Remove-Item -Recurse -Force $dest
          }

          # Copy with verification
          Copy-Item -Path $source -Destination $dest -Recurse -Force -ErrorAction Stop

          # Verify file counts match
          $sourceFiles = (Get-ChildItem -Path $source -Recurse -File | Measure-Object).Count
          $destFiles = (Get-ChildItem -Path $dest -Recurse -File | Measure-Object).Count

          if ($destFiles -ne $sourceFiles) {
            Write-Error "File count mismatch! Source: $sourceFiles, Dest: $destFiles"
            exit 1
          }

          # Verify critical files
          if (-not (Test-Path "$dest/index.html")) {
            Write-Error "Critical file missing: index.html"
            exit 1
          }

          Write-Host "✅ Successfully staged $destFiles frontend files" -ForegroundColor Green

      # ===== BACKEND BUILD =====
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Python dependencies..." -ForegroundColor Cyan
          pip install -r python_service/requirements.txt
          Write-Host "✅ Dependencies installed" -ForegroundColor Green

      - name: Build Backend Executable with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building backend executable with PyInstaller..." -ForegroundColor Cyan

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --add-data "python_service/adapters;adapters" `
            python_service/api.py

          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "✅ Backend executable built" -ForegroundColor Green

      - name: Stage Backend Executable
        shell: pwsh
        run: |
          Write-Host "Staging backend executable..." -ForegroundColor Cyan

          $exePath = ".\dist\fortuna-backend.exe"
          $destDir = ".\electron\resources"

          # Verify exe exists
          if (-not (Test-Path $exePath)) {
            Write-Error "Backend executable not found at: $exePath"
            Write-Host "Contents of dist/:"
            Get-ChildItem -Path ".\dist\" -Recurse
            exit 1
          }

          # Get file size
          $exeSize = (Get-Item $exePath).Length / 1MB
          Write-Host "Backend exe size: $([math]::Round($exeSize, 2)) MB"

          # Create destination and copy
          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }
          Copy-Item -Path $exePath -Destination $destDir -Force

          # Verify copy
          $copiedExe = Join-Path $destDir "fortuna-backend.exe"
          if (-not (Test-Path $copiedExe)) {
            Write-Error "Failed to copy executable to: $copiedExe"
            exit 1
          }

          Write-Host "✅ Backend executable staged successfully" -ForegroundColor Green

      # ===== ELECTRON BUILD =====
      - name: Install Electron Dependencies
        shell: pwsh
        run: |
          cd electron
          npm ci

      - name: Pre-Build Verification
        shell: pwsh
        run: |
          Write-Host "`n=== PRE-BUILD VERIFICATION ===" -ForegroundColor Cyan

          # Check package.json configuration
          $packageJson = Get-Content electron/package.json | ConvertFrom-Json

          if (-not $packageJson.build) {
            Write-Error "electron/package.json missing 'build' section"
            exit 1
          }

          # Verify files array includes frontend
          $filesArray = $packageJson.build.files
          $hasFrontend = $filesArray | Where-Object { $_ -like "*web-ui-build*" }
          if (-not $hasFrontend) {
            Write-Warning "WARNING: 'web-ui-build' not found in files array!"
            Write-Host "Current files array: $($filesArray -join ', ')"
          }

          # Check backend exe
          $backendExe = ".\electron\resources\fortuna-backend.exe"
          if (-not (Test-Path $backendExe)) {
            Write-Error "Backend executable missing: $backendExe"
            exit 1
          }
          $backendSize = (Get-Item $backendExe).Length / 1MB
          Write-Host "✅ Backend: $([math]::Round($backendSize, 2)) MB" -ForegroundColor Green

          # Check frontend
          $frontendDir = ".\electron\web-ui-build\out"
          $frontendIndex = "$frontendDir\index.html"

          if (-not (Test-Path $frontendDir)) {
            Write-Error "Frontend directory missing: $frontendDir"
            exit 1
          }

          if (-not (Test-Path $frontendIndex)) {
            Write-Error "Frontend index.html missing: $frontendIndex"
            exit 1
          }

          $frontendFiles = (Get-ChildItem -Path $frontendDir -Recurse -File | Measure-Object).Count
          Write-Host "✅ Frontend: $frontendFiles files" -ForegroundColor Green

          Write-Host "`n✅ All pre-build checks passed!" -ForegroundColor Green

      - name: Force-Correct package.json on Runner
        shell: pwsh
        run: |
          $correctConfig = @'
          {
            "name": "fortuna-faucet",
            "version": "1.0.0",
            "description": "Fortuna Faucet Data Management Console",
            "main": "main.js",
            "scripts": {
              "start": "electron .",
              "dist": "electron-builder"
            },
            "author": "Fortuna Development Team",
            "devDependencies": {
              "electron": "^28.0.0",
              "electron-builder": "^24.9.1"
            },
            "build": {
              "appId": "com.fortuna.faucet",
              "productName": "Fortuna Faucet",
              "files": [
                "main.js",
                "preload.js",
                "assets/**/*",
                "web-ui-build/**/*",
                "!node_modules/**/*"
              ],
              "extraResources": [
                {
                  "from": "resources/fortuna-backend.exe",
                  "to": "fortuna-backend.exe"
                }
              ],
              "win": {
                "target": "msi",
                "icon": "assets/icon.ico"
              },
              "msi": {
                "oneClick": false,
                "perMachine": true,
                "createDesktopShortcut": true
              }
            }
          }
          '@
          Set-Content -Path "electron/package.json" -Value $correctConfig -Force
          Write-Host "✅ Forcefully overwrote electron/package.json with correct configuration." -ForegroundColor Green

      - name: Build MSI Installer
        shell: pwsh
        run: |
          cd electron
          Write-Host "`n=== BUILDING MSI INSTALLER ===" -ForegroundColor Cyan

          npm run dist

          if ($LASTEXITCODE -ne 0) {
            Write-Error "electron-builder failed with exit code $LASTEXITCODE"
            exit 1
          }

          Write-Host "✅ MSI build completed successfully" -ForegroundColor Green
        env:
          CI: 'true'

      # ===== POST-BUILD VERIFICATION =====
      - name: Verify MSI Contents
        shell: pwsh
        run: |
          Write-Host "`n=== VERIFYING MSI CONTENTS ===" -ForegroundColor Cyan

          # Find MSI file
          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Error "No MSI file found in electron/dist"
            Get-ChildItem -Path ".\electron\dist" -Recurse
            exit 1
          }

          $msiSize = $msiFile.Length / 1MB
          Write-Host "MSI file: $($msiFile.Name)" -ForegroundColor Green
          Write-Host "Size: $([math]::Round($msiSize, 2)) MB" -ForegroundColor Green

          # Extract MSI for verification
          $extractPath = ".\msi-extract"
          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          Write-Host "Extracting MSI for verification..." -ForegroundColor Yellow

          # Try 7z first, fall back to msiexec
          $sevenZip = Get-Command 7z -ErrorAction SilentlyContinue
          if ($sevenZip) {
            & 7z x "$($msiFile.FullName)" -o"$extractPath" -y -bso0 -bsp0 | Out-Null
          } else {
            $fullPath = (Resolve-Path $extractPath).Path
            & msiexec /a "$($msiFile.FullName)" /qn TARGETDIR="$fullPath"
          }

          # Search for critical components
          Write-Host "`nSearching for backend executable..." -ForegroundColor Yellow
          $backendExes = @(Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue)

          if ($backendExes.Count -eq 0) {
            Write-Warning "❌ fortuna-backend.exe NOT FOUND in MSI!"
            Write-Warning "This means extraResources configuration failed"
          } else {
            Write-Host "✅ Backend found: $($backendExes[0].FullName.Substring($extractPath.Length))" -ForegroundColor Green
          }

          Write-Host "`nSearching for frontend..." -ForegroundColor Yellow
          $indexFiles = @(Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue)

          if ($indexFiles.Count -eq 0) {
            Write-Warning "❌ index.html NOT FOUND in MSI!"
          } else {
            Write-Host "✅ Frontend found: $($indexFiles[0].FullName.Substring($extractPath.Length))" -ForegroundColor Green
          }

          Write-Host "`n✅ MSI VERIFICATION PASSED!" -ForegroundColor Green

      # ===== ARTIFACT UPLOAD =====
      - name: Locate MSI for Upload
        id: locate_msi
        shell: pwsh
        run: |
          $msiFile = Get-ChildItem -Path ".\electron\dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msiFile) {
            Write-Error "No MSI file found for upload"
            exit 1
          }

          $msiPath = $msiFile.FullName
          Write-Host "MSI Path: $msiPath"

          # Output for GitHub Actions
          "msi_path=$msiPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Generate Artifact Name
        id: artifact_name
        shell: bash
        run: |
          # Sanitize branch/tag name for artifact
          NAME="fortuna-faucet-installer-$(echo ${{ github.ref_name }} | sed 's/\//-/g')"
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_name.outputs.name }}
          path: ${{ steps.locate_msi.outputs.msi_path }}
          retention-days: 30
          if-no-files-found: error

      # ===== RELEASE (on tags) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        timeout-minutes: 10
        with:
          files: ${{ steps.locate_msi.outputs.msi_path }}
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            ## Fortuna Faucet Release ${{ github.ref_name }}

            ### What's Inside
            - ✅ Python FastAPI backend (packaged as standalone executable)
            - ✅ Next.js frontend (static HTML/CSS/JS)
            - ✅ Electron desktop wrapper

            ### Installation
            1. Download the `.msi` installer below
            2. Run the installer (requires Administrator privileges)
            3. Launch "Fortuna Faucet" from your Start Menu

            ### Requirements
            - Windows 10/11 (64-bit)
            - No Python or Node.js installation required!

            ---
            *Built with GitHub Actions*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
