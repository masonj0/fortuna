name: Build Fortuna Faucet MSI Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  CACHE_BUST: ${{ github.run_id }}

jobs:
  build-installer:
    name: Build MSI Installer
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ===== NUCLEAR CACHE OBLITERATION =====
      - name: 'üî• NUCLEAR CACHE OBLITERATION'
        shell: pwsh
        run: |
          Write-Host "=== STARTING NUCLEAR CACHE OBLITERATION ===" -ForegroundColor Red

          # NPM cleanup
          npm cache clean --force 2>&1 | Out-Null

          # Python cleanup
          py -m pip cache purge 2>&1 | Out-Null

          # Intentionally leaving global caches for actions/setup-node to manage
          # but clearing temp files for good measure.
          $cleanupPaths = @(
            "$env:TEMP\npm-*",
            "$env:TEMP\pip-*"
          )

          foreach ($path in $cleanupPaths) {
            if (Test-Path $path) {
              Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue | Out-Null
            }
          }

          # Remove node_modules globally
          Get-ChildItem -Path . -Recurse -Filter "node_modules" -Directory -Force -ErrorAction SilentlyContinue |
            ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }

          # Clean build artifacts
          @("dist", "build", "*.egg-info", "__pycache__") | ForEach-Object {
            Get-ChildItem -Path . -Recurse -Filter $_ -Directory -Force -ErrorAction SilentlyContinue |
              ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }
          }

          Write-Host "=== CACHE OBLITERATION COMPLETE ===" -ForegroundColor Green

      # ===== ENVIRONMENT SETUP =====
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Create Log Directory for Forensic Analysis
        shell: pwsh
        run: |
          if (-not (Test-Path "logs")) {
            New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          }

      # ===== FRONTEND BUILD =====
      - name: Frontend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Installing Dependencies ===" -ForegroundColor Cyan
          cd web_platform/frontend
          npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../../logs/npm-install.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "npm ci output:" -ForegroundColor Yellow
            Get-Content ../../logs/npm-install.log | Select-Object -Last 50
            throw "Frontend npm install failed"
          }
          Write-Host "‚úÖ Frontend dependencies installed" -ForegroundColor Green

      - name: Frontend - Build Static Export
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Building Static Export ===" -ForegroundColor Cyan
          cd web_platform/frontend
          npm run build 2>&1 | Tee-Object -FilePath ../../logs/frontend-build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Frontend build failed!" -ForegroundColor Red
            Get-Content ../../logs/frontend-build.log | Select-Object -Last 100
            throw "Frontend build failed"
          }

          if (-not (Test-Path "out/index.html")) {
            throw "Frontend build succeeded but out/index.html missing"
          }

          $fileCount = @(Get-ChildItem -Path "out" -Recurse -File).Count
          Write-Host "‚úÖ Frontend built: $fileCount files" -ForegroundColor Green

      - name: Frontend - Verify Output
        shell: pwsh
        run: |
          $outDir = "web_platform/frontend/out"
          $requiredFiles = @("index.html", "_next")

          Write-Host "`n=== FRONTEND: Verifying Output ===" -ForegroundColor Cyan
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path (Join-Path $outDir $file))) {
              throw "Missing required file: $file"
            }
            Write-Host "‚úÖ $file found" -ForegroundColor Green
          }

      - name: Frontend - Stage to Electron
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Staging to Electron ===" -ForegroundColor Cyan

          $src = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          Copy-Item -Path "$src/*" -Destination $dest -Recurse -Force

          if (-not (Test-Path "$dest/index.html")) {
            throw "Failed to stage frontend to electron"
          }

          $fileCount = @(Get-ChildItem -Path $dest -Recurse -File).Count
          Write-Host "‚úÖ Frontend staged: $fileCount files" -ForegroundColor Green

      # ===== BACKEND BUILD =====
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Installing Dependencies ===" -ForegroundColor Cyan
          cd python_service
          pip install --upgrade pip setuptools wheel 2>&1 | Out-Null
          pip install -r requirements.txt --no-cache-dir 2>&1 | Tee-Object -FilePath ../logs/pip-install.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Pip install failed!" -ForegroundColor Red
            throw "Backend pip install failed"
          }
          Write-Host "‚úÖ Backend dependencies installed" -ForegroundColor Green

      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Building Executable ===" -ForegroundColor Cyan
          cd python_service

          # Construct the absolute path for the --add-data argument
          $adaptersPath = (Resolve-Path -Path "./adapters").Path
          $addDataArg = "$adaptersPath;adapters"
          Write-Host "  ‚Üí Using --add-data arg: $addDataArg"

          pyinstaller --onefile `
            --name fortuna-backend `
            --console `
            --clean `
            --noconfirm `
            --distpath ../electron/resources `
            --workpath ./build-pyinstaller `
            --specpath ./spec-pyinstaller `
            --hidden-import=uvicorn `
            --hidden-import=uvicorn.logging `
            --hidden-import=uvicorn.loops `
            --hidden-import=uvicorn.loops.auto `
            --hidden-import=uvicorn.protocols `
            --hidden-import=uvicorn.protocols.http `
            --hidden-import=uvicorn.protocols.http.auto `
            --hidden-import=uvicorn.protocols.http.httptools_impl `
            --hidden-import=uvicorn.protocols.websockets `
            --hidden-import=uvicorn.protocols.websockets.auto `
            --hidden-import=uvicorn.lifespan `
            --hidden-import=uvicorn.lifespan.on `
            --hidden-import=fastapi `
            --hidden-import=fastapi.routing `
            --hidden-import=pydantic `
            --hidden-import=pydantic_core `
            --hidden-import=httpx `
            --hidden-import=httpx._transports `
            --hidden-import=httpx._transports.default `
            --hidden-import=redis `
            --hidden-import=redis.asyncio `
            --hidden-import=redis.asyncio.client `
            --hidden-import=redis.asyncio.connection `
            --collect-all=uvicorn `
            --collect-all=fastapi `
            --add-data $addDataArg `
            api.py `
            2>&1 | Tee-Object -FilePath ../logs/pyinstaller.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "PyInstaller failed!" -ForegroundColor Red
            Get-Content ../logs/pyinstaller.log | Select-Object -Last 50
            throw "PyInstaller build failed"
          }
          Write-Host "‚úÖ Backend executable built" -ForegroundColor Green

      - name: Backend - Verify Executable
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Verifying Executable ===" -ForegroundColor Cyan

          $exe = "electron/resources/fortuna-backend.exe"

          if (-not (Test-Path $exe)) {
            throw "Backend executable not found at: $exe"
          }

          $size = (Get-Item $exe).Length / 1MB
          Write-Host "‚úÖ Backend executable verified: $([math]::Round($size, 2)) MB" -ForegroundColor Green

      # ===== ELECTRON BUILD =====
      - name: Electron - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Installing Dependencies ===" -ForegroundColor Cyan
          cd electron
          npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../logs/npm-electron.log

          if ($LASTEXITCODE -ne 0) {
            throw "Electron npm install failed"
          }
          Write-Host "‚úÖ Electron dependencies installed" -ForegroundColor Green

      - name: Electron - Pre-Build Verification
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Pre-Build Verification ===" -ForegroundColor Cyan

          $checks = @{
            "main.js" = "electron/main.js"
            "preload.js" = "electron/preload.js"
            "package.json" = "electron/package.json"
            "icon.ico" = "electron/assets/icon.ico"
            "backend.exe" = "electron/resources/fortuna-backend.exe"
            "frontend/index.html" = "electron/web-ui-build/out/index.html"
            "frontend/_next" = "electron/web-ui-build/out/_next"
          }

          foreach ($name in $checks.Keys) {
            $path = $checks[$name]
            if (-not (Test-Path $path)) {
              throw "Missing required file: $name at $path"
            }
            Write-Host "‚úÖ $name verified" -ForegroundColor Green
          }

      - name: Electron - Build MSI
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Building MSI ===" -ForegroundColor Cyan
          cd electron

          npx electron-builder --config electron-builder-config.yml --publish never 2>&1 | Tee-Object -FilePath ../logs/electron-builder.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "electron-builder failed!" -ForegroundColor Red
            Get-Content ../logs/electron-builder.log | Select-Object -Last 100
            throw "MSI build failed"
          }
          Write-Host "‚úÖ MSI build completed" -ForegroundColor Green

      # ===== POST-BUILD VERIFICATION =====
      - name: Post-Build - Locate MSI
        shell: pwsh
        run: |
          Write-Host "`n=== POST-BUILD: Locating MSI ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse | Select-Object -First 1

          if (-not $msi) {
            Write-Host "Contents of electron/dist:" -ForegroundColor Yellow
            Get-ChildItem -Path "electron/dist" -Recurse | ForEach-Object { Write-Host $_.FullName }
            throw "MSI file not found"
          }

          $size = $msi.Length / 1MB
          Write-Host "‚úÖ MSI found: $($msi.Name) ($([math]::Round($size, 2)) MB)" -ForegroundColor Green

          # Save path for artifact upload
          $msi.FullName | Out-File -FilePath "msi-path.txt" -Force

      - name: Post-Build - Extract & Verify MSI (Optional)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`n=== POST-BUILD: MSI Content Verification ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) {
            Write-Host "No MSI found to verify" -ForegroundColor Yellow
            return
          }

          $extractPath = "msi-contents"
          if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
          New-Item -ItemType Directory -Path $extractPath | Out-Null

          # Try to extract with 7-Zip if available
          $sevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (Test-Path $sevenZip) {
            & $sevenZip x "$($msi.FullName)" -o"$extractPath" -y 2>&1 | Out-Null

            $backendFound = Get-ChildItem -Path $extractPath -Recurse -Filter "fortuna-backend.exe" -ErrorAction SilentlyContinue
            $frontendFound = Get-ChildItem -Path $extractPath -Recurse -Filter "index.html" -ErrorAction SilentlyContinue

            if ($backendFound) { Write-Host "‚úÖ Backend executable verified in MSI" -ForegroundColor Green }
            if ($frontendFound) { Write-Host "‚úÖ Frontend files verified in MSI" -ForegroundColor Green }
          } else {
            Write-Host "‚ö†Ô∏è  7-Zip not available for extraction, skipping detailed verification" -ForegroundColor Yellow
          }

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer-${{ github.ref_name }}
          path: electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs-${{ github.ref_name }}
          path: logs/
          retention-days: 7
          if-no-files-found: warn

      # ===== RELEASE (Tags Only) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            ## Fortuna Faucet ${{ github.ref_name }}

            ### üì¶ What's Included
            - ‚úÖ Python FastAPI backend (standalone executable)
            - ‚úÖ Next.js frontend (static HTML/CSS/JS)
            - ‚úÖ Electron desktop wrapper

            ### ‚öôÔ∏è Installation
            1. Download the `.msi` installer
            2. Run installer (admin privileges required)
            3. Launch from Start Menu

            ### üìã Requirements
            - Windows 10/11 (64-bit)
            - No Python or Node.js installation needed

            Built with ‚ù§Ô∏è by GitHub Actions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
