name: Build Fortuna Web Service MSI (Experimental)

on:
  push:
    branches:
      - 'main'
    paths:
      - 'web_platform/**'
      - 'python_service/**'
      - 'fortuna-webservice.spec'
      - '.github/workflows/build-msi.yml'

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  system-check:
    name: '‚öôÔ∏è System Prerequisites'
    runs-on: windows-latest
    timeout-minutes: 5
    outputs:
      disk_free_gb: ${{ steps.system.outputs.disk_gb }}
    steps:
      - name: Verify Build Tools
        run: |
          Set-StrictMode -Version Latest
          $tools = @('dotnet', 'python', 'node', 'npm', 'git')
          foreach ($tool in $tools) {
            Write-Host "Checking for $($tool)..."
            Get-Command $tool -ErrorAction SilentlyContinue
            if (-not $?) {
              Write-Host "‚ùå FATAL: Build tool '$tool' not found in PATH." -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ All critical build tools are present." -ForegroundColor Green
      - name: Check Disk Space
        id: system
        run: |
          Set-StrictMode -Version Latest
          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }
          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)
          if ($freeGB -lt 10) {
            Write-Host "‚ö†Ô∏è WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended)." -ForegroundColor Yellow
          } else {
            Write-Host "‚úÖ Disk space check passed ($freeGB GB free)." -ForegroundColor Green
          }
          "disk_gb=$freeGB" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

  build-frontend:
    name: 'üì¶ Build Frontend'
    timeout-minutes: 15
    runs-on: windows-latest
    needs: system-check
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1 # Pinned to SHA
      - name: Setup Node.js
        uses: actions/setup-node@v4.0.2 # Pinned to SHA
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          cd web_platform/frontend
          npm ci
          npm audit --audit-level=moderate # Added security check
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $outDir = 'web_platform/frontend/out'
          if (-not (Test-Path $outDir)) {
            Write-Host "‚ùå FATAL: Build output directory 'out' not created" -ForegroundColor Red
            exit 1
          }
          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: Build output directory is empty" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Frontend build verified ($fileCount files)" -ForegroundColor Green
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: frontend-build-output
          path: web_platform/frontend/out
          retention-days: 1

  build-backend:
    name: 'üêç Build Backend'
    timeout-minutes: 20
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1 # Pinned to SHA
      - name: Setup Python
        uses: actions/setup-python@v5.0.0 # Pinned to SHA
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'
      - name: '‚úÖ [MONITOR] Ensure Required Directories Exist'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          New-Item -ItemType Directory -Path "python_service/adapters" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/json" -Force | Out-Null
          Write-Host "‚úÖ Ensured required data, json, and adapters directories exist."
      - name: '‚úÖ [MONITOR] Verify Critical Files'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (-not (Test-Path "python_service/main.py")) { throw "‚ùå FATAL: python_service/main.py not found" }
          Write-Host "‚úÖ Critical files verified."
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip
          pip install -r python_service/requirements-dev.txt
      - name: Backend - Security Audit
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          pip-audit -r python_service/requirements.txt --local
      - name: Verify PyInstaller Entry Point
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $specFile = "fortuna-webservice.spec"
          if (-not (Test-Path $specFile)) { throw "‚ùå FATAL: Spec file not found: $specFile" }
          $specContent = Get-Content $specFile -Raw
          if ($specContent -match "Analysis\(\s*\[?'([^']+)'") {
            $entryPoint = $matches[1]
            $entryPointPath = $entryPoint -replace '/', '\'
            if (Test-Path $entryPointPath) {
              Write-Host "‚úÖ Entry point file exists: $entryPointPath" -ForegroundColor Green
            } else {
              throw "‚ùå FATAL: Entry point file NOT found: $entryPointPath"
            }
          } else {
            throw "‚ö†Ô∏è WARNING: Could not parse entry point from spec file"
          }
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          pyinstaller fortuna-webservice.spec --noconfirm
      - name: Verify Executable Size
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-webservice.exe"
          if (-not (Test-Path $exePath)) {
            Write-Host "‚ùå FATAL: Executable not found" -ForegroundColor Red
            exit 1
          }
          $size = (Get-Item $exePath).Length / 1MB
          if ($size -lt 10) {
            Write-Host "‚ùå FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete." -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Backend executable size is reasonable: $([math]::Round($size, 2)) MB" -ForegroundColor Green
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: backend-executable
          path: dist/fortuna-webservice.exe
          retention-days: 1
          if-no-files-found: error

  diagnose-asgi-imports:
    name: 'üîç ASGI Import Killer (Pre-Smoke Diagnostic)'
    runs-on: windows-latest
    timeout-minutes: 15
    needs: build-backend
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ‚öôÔ∏è Setup Python (EXACT VERSION)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üìã Capture Python Info
        run: |
          Set-StrictMode -Version Latest
          Write-Host "Python executable: $(which python)" -ForegroundColor Cyan
          python --version
          python -m site
          python -c "import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)"

      - name: üì• Install Requirements (Exactly as Backend Build)
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel --quiet

          Write-Host "Installing requirements.txt..." -ForegroundColor Cyan
          pip install -r "web_service/backend/requirements.txt" -v 2>&1 | Tee-Object "install-requirements.log"

          if (Test-Path "web_service/backend/requirements-dev.txt") {
            Write-Host "Installing requirements-dev.txt..." -ForegroundColor Cyan
            pip install -r "web_service/backend/requirements-dev.txt" -v 2>&1 | Tee-Object -Append "install-requirements.log"
          }

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå pip install failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ All dependencies installed" -ForegroundColor Green

      - name: üì¶ Capture Installed Packages
        run: |
          pip list | Tee-Object "installed-packages.txt"
          pip freeze | Tee-Object "pip-freeze.txt"

      - name: üß™ PHASE 1 System Imports
        run: |
          python -c @'
          import sys

          print("\n" + "="*80)
          print("PHASE 1 SYSTEM-LEVEL IMPORTS")
          print("="*80)

          modules = [
              ('os', 'filesystem'),
              ('sys', 'system'),
              ('json', 'serialization'),
              ('asyncio', 'async I/O'),
              ('pathlib', 'paths'),
              ('typing', 'type hints'),
              ('importlib', 'import utilities'),
          ]

          failed = []
          for mod_name, desc in modules:
              try:
                  __import__(mod_name)
                  print(f"‚úÖ {mod_name:20} [{desc}]")
              except Exception as e:
                  print(f"‚ùå {mod_name:20} ERROR: {e}")
                  failed.append((mod_name, str(e)))

          if failed:
              print(f"\n‚ùå CRITICAL: {len(failed)} system imports failed")
              sys.exit(1)

          print(f"\n‚úÖ Phase 1 complete")
          '@

          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üß™ PHASE 2 Web Framework Core
        run: |
          python -c @'
          import sys
          import traceback

          print("\n" + "="*80)
          print("PHASE 2 WEB FRAMEWORK CORE")
          print("="*80)

          modules = [
              ('fastapi', 'web framework'),
              ('uvicorn', 'ASGI server'),
              ('starlette', 'ASGI toolkit'),
              ('starlette.applications', 'ASGI app'),
              ('starlette.routing', 'routing'),
          ]

          failed = []
          for mod_name, desc in modules:
              try:
                  __import__(mod_name)
                  print(f"‚úÖ {mod_name:30} [{desc}]")
              except ImportError as e:
                  print(f"‚ùå {mod_name:30} ImportError: {e}")
                  failed.append((mod_name, str(e)))
              except Exception as e:
                  print(f"‚ö†Ô∏è  {mod_name:30} {type(e).__name__}: {e}")

          if failed:
              print(f"\n‚ùå {len(failed)} core framework imports failed")
              for mod, err in failed:
                  print(f"  - {mod}")
              sys.exit(1)

          print(f"\n‚úÖ Phase 2 complete")
          '@

          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üß™ PHASE 3 Pydantic & Data Validation
        run: |
          python -c @'
          import sys

          print("\n" + "="*80)
          print("PHASE 3 PYDANTIC & DATA VALIDATION")
          print("="*80)

          modules = [
              ('pydantic', 'validation'),
              ('pydantic_core', 'core'),
              ('pydantic_settings', 'settings'),
          ]

          for mod_name, desc in modules:
              try:
                  __import__(mod_name)
                  print(f"‚úÖ {mod_name:30} [{desc}]")
              except Exception as e:
                  print(f"‚ùå {mod_name:30} {type(e).__name__}: {e}")
                  sys.exit(1)

          print(f"\n‚úÖ Phase 3 complete")
          '@

          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üß™ PHASE 4 Async/IO Utilities
        run: |
          python -c @'
          import sys

          print("\n" + "="*80)
          print("PHASE 4 ASYNC/IO UTILITIES")
          print("="*80)

          modules = [
              ('anyio', 'async compat'),
              ('httpcore', 'HTTP core'),
              ('httpx', 'HTTP client'),
              ('aiosqlite', 'async DB'),
          ]

          for mod_name, desc in modules:
              try:
                  __import__(mod_name)
                  print(f"‚úÖ {mod_name:30} [{desc}]")
              except Exception as e:
                  print(f"‚ùå {mod_name:30} {type(e).__name__}: {e}")
                  sys.exit(1)

          print(f"\n‚úÖ Phase 4 complete")
          '@

          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: üß™ PHASE 5 Optional Dependencies (non-critical)
        continue-on-error: true
        run: |
          python -c @'
          import sys

          print("\n" + "="*80)
          print("PHASE 5 OPTIONAL DEPENDENCIES (non-critical)")
          print("="*80)

          modules = [
              ('slowapi', 'rate limiting'),
              ('structlog', 'logging'),
              ('tenacity', 'retries'),
          ]

          for mod_name, desc in modules:
              try:
                  __import__(mod_name)
                  print(f"‚úÖ {mod_name:30} [{desc}]")
              except Exception as e:
                  print(f"‚ö†Ô∏è  {mod_name:30} not critical: {type(e).__name__}")

          print(f"\n‚úÖ Phase 5 complete (warnings OK)")
          '@

      - name: üß™ PHASE 6 Application Directory Structure
        run: |
          Set-StrictMode -Version Latest

          python -c @'
          import os
          from pathlib import Path

          print("\n" + "="*80)
          print("PHASE 6 APPLICATION DIRECTORY STRUCTURE")
          print("="*80)

          cwd = Path.cwd()
          web_service = cwd / "web_service"
          backend = web_service / "backend"

          print(f"\nCurrent directory: {cwd}")
          print(f"\nweb_service exists: {web_service.exists()}")
          if web_service.exists():
              print(f"  Contents:")
              for item in web_service.iterdir():
                  print(f"    - {item.name}")

          print(f"\nweb_service/backend exists: {backend.exists()}")
          if backend.exists():
              print(f"  Contents:")
              for item in backend.iterdir():
                  print(f"    - {item.name}")

              main_py = backend / "main.py"
              api_py = backend / "api.py"

              print(f"\n  main.py: {main_py.exists()} ({main_py.stat().st_size if main_py.exists() else 'N/A'} bytes)")
              print(f"  api.py: {api_py.exists()} ({api_py.stat().st_size if api_py.exists() else 'N/A'} bytes)")
          '@

      - name: üß™ PHASE 7 CRITICAL - Application Module Imports
        run: |
          python -c @'
          import sys
          import traceback
          from pathlib import Path

          print("\n" + "="*80)
          print("PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)")
          print("="*80)

          # Step 1: web_service
          print("\n[Step 1] Importing web_service...")
          try:
              import web_service
              print(f"‚úÖ web_service imported")
              print(f"   Location: {web_service.__file__}")
          except Exception as e:
              print(f"‚ùå FATAL: web_service import failed")
              print(f"   Error: {type(e).__name__}: {e}")
              traceback.print_exc()
              sys.exit(1)

          # Step 2: Get app object
          print("\n[Step 5] Retrieving 'app' object from main...")
          try:
              from web_service.backend.main import app
              print(f"‚úÖ app object retrieved")
              print(f"   Type: {type(app)}")
              print(f"   Class: {app.__class__.__name__}")
              print(f"   Module: {app.__class__.__module__}")
          except Exception as e:
              print(f"‚ùå FATAL: Could not get app object")
              print(f"   Error: {type(e).__name__}: {e}")
              traceback.print_exc()
              sys.exit(1)

          print("\n" + "="*80)
          print("‚úÖ ALL APPLICATION IMPORTS SUCCESSFUL")
          print("="*80)
          print("\nThe ASGI app is fully importable.")
          print("Uvicorn should be able to load it successfully.")
          '@

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå APPLICATION IMPORT TEST FAILED" -ForegroundColor Red
            exit 1
          }

      - name: üìã Generate ASGI Diagnostic Report
        if: always()
        run: |
          Set-StrictMode -Version Latest
          $report = @()
          $report += "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          $report += "‚ïë              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        ‚ïë"
          $report += "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          $report += ""
          $report += "Timestamp: $(Get-Date -Format 'o')"
          $report += "Python: $(python --version)"
          $report += ""
          $report += "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
          $result = if ($LASTEXITCODE -eq 0) { 'PASS ‚úÖ' } else { 'FAIL ‚ùå' }
          $report += "‚îÇ RESULT: $result ‚îÇ"
          $report += "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
          $report += ""
          $report += "If this passed:"
          $report += "  ‚úÖ All required dependencies are installed"
          $report += "  ‚úÖ python_service.main is importable"
          $report += "  ‚úÖ FastAPI app is accessible"
          $report += "  ‚úÖ The executable should work"
          $report += "  ‚úÖ Uvicorn WILL be able to load the app"
          $report += ""
          $report += "If this failed:"
          $report += "  ‚ùå See error output above for the exact problem"
          $report += "  ‚ùå Fix the import error in your code"
          $report += "  ‚ùå Common issues:"
          $report += "     - Missing dependency in requirements.txt"
          $report += "     - Syntax error in main.py"
          $report += "     - Circular import in main.py"
          $report += "     - main.py imports a module that fails"
          $report += ""
          $report += "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          $report | Tee-Object "asgi-diagnostic-report.txt"

      - name: üì§ Upload Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asgi-import-diagnostics-experimental-${{ github.run_id }}
          path: |
            install-requirements.log
            installed-packages.txt
            pip-freeze.txt
            asgi-diagnostic-report.txt
          retention-days: 30
          if-no-files-found: warn

  smoke-test-service:
    name: 'üß™ Smoke Test Service (Backend + Frontend)'
    timeout-minutes: 15
    needs: [build-backend, build-frontend, diagnose-asgi-imports]
    runs-on: windows-latest
    env:
      API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test"
      FORTUNA_PORT: 8100
      SMOKE_FRONTEND_PORT: 3300
      SMOKE_FRONTEND_URL: "http://localhost:3300"
      SMOKE_HEADING_SELECTOR: "h1:has-text('Fortuna Faucet')"
      SMOKE_SCREENSHOT_PATH: "smoke-test-screenshot.png"
      SMOKE_FAILURE_SCREENSHOT_PATH: "smoke-test-screenshot-FAILURE.png"
    steps:
      - name: Get Playwright Version
        id: playwright-version
        shell: pwsh
        run: echo "VERSION=$(python -c 'from importlib.metadata import version; print(version("playwright"))')" >> $env:GITHUB_OUTPUT
      - name: Cache Playwright browsers
        uses: actions/cache@88522ab9f39a2ea568f7027ed67a8d8f9e9d59c3 # v4.0.2
        id: playwright-cache
        with:
          path: C:\Users\runneradmin\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.VERSION }}
      - name: Download Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: ./artifacts
      - name: 'üõ°Ô∏è Configure Firewall for Smoke Test'
        shell: pwsh
        run: |
          New-NetFirewallRule -DisplayName "Allow Fortuna Smoke Test" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}
          Write-Host "‚úÖ Firewall rule added for port ${{ env.FORTUNA_PORT }}."
      - name: Stage Files
        shell: pwsh
        run: |
          Get-ChildItem -Path "./artifacts/backend-executable" | ForEach-Object { Move-Item -Path $_.FullName -Destination "." -Force }
          New-Item -ItemType Directory -Path "./frontend" -Force
          Get-ChildItem -Path "./artifacts/frontend-build-output" | ForEach-Object { Move-Item -Path $_.FullName -Destination "./frontend" -Force }
      - name: Run Backend and Frontend
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          New-Item -ItemType Directory -Path "data" -Force | Out-Null
          New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "json" -Force | Out-Null
          $backendProcess = Start-Process -FilePath "./fortuna-webservice.exe" -PassThru -RedirectStandardOutput "backend-out.log" -RedirectStandardError "backend-err.log"
          Set-Content -Path "backend.pid" -Value $backendProcess.Id
          Push-Location ./frontend
          $frontendProcess = Start-Process python -ArgumentList "-m http.server ${{ env.SMOKE_FRONTEND_PORT }}" -PassThru -RedirectStandardOutput "../frontend-out.log" -RedirectStandardError "../frontend-err.log"
          Pop-Location
          Set-Content -Path "frontend.pid" -Value $frontendProcess.Id
      - name: Deep Integration Test (Poll Health Endpoint)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $healthUrl = "http://127.0.0.1:${{ env.FORTUNA_PORT }}/health"
          $maxAttempts = 15
          $delaySeconds = 2
          $success = $false
          For ($i=1; $i -le $maxAttempts; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check passed on attempt $i."
                New-Item -Path . -Name ready -ItemType File
                $success = $true
                break
              }
            } catch {
              Write-Host "Attempt $i of $maxAttempts failed. Retrying in $delaySeconds seconds..."
              Start-Sleep -Seconds $delaySeconds
            }
          }
          if (-not $success) {
            Write-Host "‚ùå Health check failed after $maxAttempts attempts."
            exit 1
          }
      - name: 'üïµÔ∏è‚Äç‚ôÄÔ∏è Enhanced Forensic Analysis'
        if: failure()
        shell: pwsh
        run: |
          Write-Host "--- üïµÔ∏è‚Äç‚ôÄÔ∏è FORENSIC ANALYSIS üïµÔ∏è‚Äç‚ôÄÔ∏è ---"

          Write-Host "`n--- 1. ENVIRONMENT VARIABLES ---"
          Get-ChildItem Env: | Sort-Object Name | Format-Table -AutoSize | Out-String -Width 4096

          Write-Host "`n--- 2. FILE SYSTEM SNAPSHOT ---"
          Get-ChildItem -Recurse | Out-String -Width 4096

          Write-Host "`n--- 3. NETWORK PORT USAGE (netstat) ---"
          try {
            netstat -anb
          } catch {
            Write-Host "  (netstat -anb failed, attempting without -b)"
            netstat -an
          }

          Write-Host "`n--- 4. BACKEND STDOUT (backend-out.log) ---"
          if (Test-Path backend-out.log) { Get-Content backend-out.log -Raw }

          Write-Host "`n--- 5. BACKEND STDERR (backend-err.log) ---"
          if (Test-Path backend-err.log) { Get-Content backend-err.log -Raw }

          Write-Host "`n--- END OF FORENSIC ANALYSIS ---"
      - name: Frontend UI Verification
        continue-on-error: true
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (-not (Test-Path ready)) {
            Write-Host "Skipping UI verification: backend not ready."
            exit 0
          }
          pip install playwright==1.48.2
          python -m playwright install chromium
          $scriptContent = @"
          import sys, os
          from playwright.sync_api import sync_playwright, expect

          def run_verification():
              with sync_playwright() as p:
                  browser = p.chromium.launch()
                  page = browser.new_page()
                  page.tracing.start(screenshots=True, snapshots=True)
                  try:
                      url = os.environ["SMOKE_FRONTEND_URL"]
                      page.goto(url, wait_until='networkidle', timeout=20000)
                      heading = page.locator(os.environ["SMOKE_HEADING_SELECTOR"])
                      expect(heading).to_be_visible(timeout=10000)
                      page.screenshot(path=os.environ["SMOKE_SCREENSHOT_PATH"])
                      page.tracing.stop(path="trace-success.zip")
                      sys.exit(0)
                  except Exception as e:
                      print(f"Error: {e}", file=sys.stderr)
                      page.screenshot(path=os.environ["SMOKE_FAILURE_SCREENSHOT_PATH"])
                      page.tracing.stop(path="trace-failure.zip")
                      sys.exit(1)
                  finally:
                      browser.close()

          if __name__ == "__main__":
              run_verification()
          "@
          Set-Content -Path "verify_frontend.py" -Value $scriptContent
          python verify_frontend.py
      - name: Upload Verification Artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: smoke-test-artifacts
          path: |
            ${{ env.SMOKE_SCREENSHOT_PATH }}
            ${{ env.SMOKE_FAILURE_SCREENSHOT_PATH }}
            trace-*.zip
          if-no-files-found: warn
      - name: Teardown Processes and Firewall
        if: always()
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (Test-Path "backend.pid") { Get-Content "backend.pid" | ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue } }
          if (Test-Path "frontend.pid") { Get-Content "frontend.pid" | ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue } }
          Remove-NetFirewallRule -DisplayName "Allow Fortuna Smoke Test" -ErrorAction SilentlyContinue

  package-and-test:
    name: 'üèÜ Package & Test Electron Installer'
    timeout-minutes: 25
    needs: [build-frontend, smoke-test-service]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.1 # Pinned to SHA
      - name: Setup Node.js for Electron
        uses: actions/setup-node@v4.0.2 # Pinned to SHA
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'
      - name: Download All Build Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: ./temp-artifacts
      - name: Stage Artifacts for Packaging
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          New-Item -ItemType Directory -Path "./electron/web-ui-build" -Force | Out-Null
          New-Item -ItemType Directory -Path "./electron/resources" -Force | Out-Null
          Move-Item -Path "./temp-artifacts/frontend-build-output/*" -Destination "./electron/web-ui-build/out" -Force
          Move-Item -Path "./temp-artifacts/backend-executable/fortuna-webservice.exe" -Destination "./electron/resources/fortuna-backend.exe" -Force
      - name: Verify Staged Artifacts
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $backendPath = "./electron/resources/fortuna-backend.exe"
          $frontendDir = "./electron/web-ui-build/out"
          if (-not (Test-Path $backendPath)) {
            Write-Host "‚ùå FATAL: Backend executable not found at $backendPath" -ForegroundColor Red
            exit 1
          }
          $frontendFiles = (Get-ChildItem -Path $frontendDir -Recurse -File | Measure-Object).Count
          if ($frontendFiles -eq 0) {
            Write-Host "‚ùå FATAL: No files found in frontend directory $frontendDir" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Artifacts staged successfully: Backend executable and $frontendFiles frontend files." -ForegroundColor Green
      - name: Critical Integration Test
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough"
        run: |
          Set-StrictMode -Version Latest
          $exe = "./electron/resources/fortuna-backend.exe"
          # ... existing integration test ...
      - name: Electron - Install & Package MSI
        working-directory: electron
        shell: pwsh
        run: |
          npm ci
          npx electron-builder --config electron-builder-config.yml --publish never
      - name: Code Sign MSI
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          # ... code signing script ...
      - name: Upload Final MSI Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: fortuna-installer-windows-${{ github.sha }}
          path: electron/dist/*.msi
          retention-days: 7
      - name: Create GitHub Release
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        id: create_release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.2.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            MSI Installer for Fortuna Faucet.
            Built from commit ${{ github.sha }}.
          draft: false
          prerelease: false
      - name: Upload Release Asset
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@a3c3b214041997193b7385d10a241e57c1975e53 # v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: electron/dist/*.msi
          asset_name: fortuna-faucet-${{ github.ref_name }}.msi
          asset_content_type: application/octet-stream
