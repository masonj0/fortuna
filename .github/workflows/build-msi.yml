name: Build Fortuna Faucet MSI Installer - üèÜ PRODUCTION FORTRESS

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  CACHE_BUST: "2025-11-05-v3-fortress"
  API_KEY: "${{ secrets.API_KEY }}"

jobs:
  build-installer:
    name: üèÜ Build MSI Installer (Fortress Mode)
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      # ===== TELEMETRY & DIAGNOSTICS =====
      - name: üìä Initialize Build Telemetry
        shell: pwsh
        run: |
          $buildInfo = @{
            StartTime = Get-Date -Format 'o'
            RunnerOS = $env:RUNNER_OS
            RunnerVersion = $env:RUNNER_VERSION
            RunnerName = $env:RUNNER_NAME
            WorkflowRef = "${{ github.workflow }}"
            JobID = "${{ github.job }}"
            RunID = "${{ github.run_id }}"
            RunNumber = "${{ github.run_number }}"
          }
          $buildInfo | ConvertTo-Json | Out-File -FilePath "build-telemetry.json" -Force
          Write-Host "üèÜ BUILD FORTRESS INITIALIZED" -ForegroundColor Magenta
          $buildInfo | ConvertTo-Json | Write-Host

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===== SYSTEM VERIFICATION =====
      - name: üîç System Health Check
        shell: pwsh
        run: |
          Write-Host "`n=== SYSTEM HEALTH CHECK ===" -ForegroundColor Cyan

          $checks = @{
            "PowerShell Version" = $PSVersionTable.PSVersion
            "Windows Version" = [System.Environment]::OSVersion
            "Total Memory" = "$(([System.Diagnostics.Process]::GetCurrentProcess().WorkingSet64 / 1GB).ToString('F2')) GB available"
            "Disk Space (C:)" = "$(([System.IO.DriveInfo]::GetDrives()[0].AvailableFreeSpace / 1GB).ToString('F2')) GB free"
            "Git Version" = "$(git --version)"
            "Node Version" = "$(node --version)"
            "Python Version" = "$(python --version)"
            "Pip Version" = "$(pip --version)"
          }

          foreach ($check in $checks.GetEnumerator()) {
            Write-Host "  ‚úì $($check.Name): $($check.Value)" -ForegroundColor Green
          }

          $blockedPorts = @(8000, 8998, 8999)
          foreach ($port in $blockedPorts) {
            $connections = netstat -ano 2>$null | Select-String ":$port\s+LISTENING"
            if ($connections) {
              $pidMatch = $connections -match '\s+(\d+)\s*$'
              if ($pidMatch -and $Matches[1]) {
                $pid = $Matches[1]
                Write-Host "  ‚ö†Ô∏è  Port $port occupied by PID $pid - terminating..." -ForegroundColor Yellow
                try {
                  Stop-Process -Id $pid -Force -ErrorAction Stop
                  Start-Sleep -Seconds 2
                  Write-Host "  ‚úì Port $port freed" -ForegroundColor Green
                } catch {
                  Write-Host "  ‚ùå Failed to free port $port" -ForegroundColor Red
                  throw "Cannot free required port $port"
                }
              }
            } else {
              Write-Host "  ‚úì Port $port is available" -ForegroundColor Green
            }
          }

      # ===== NUCLEAR CACHE OBLITERATION =====
      - name: 'üî• NUCLEAR CACHE OBLITERATION'
        shell: pwsh
        run: |
          Write-Host "`n=== CACHE DESTRUCTION PROTOCOL ===" -ForegroundColor Red

          $itemsToNuke = @(
            "$env:TEMP\npm-*",
            "$env:TEMP\pip-*",
            "$env:APPDATA\npm-cache",
            "$env:APPDATA\pip"
          )

          foreach ($path in $itemsToNuke) {
            if (Test-Path $path) {
              $size = (Get-ChildItem -Path $path -Recurse -Force | Measure-Object -Property Length -Sum).Sum / 1MB
              Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  üóëÔ∏è  Cleared: $path ($([math]::Round($size, 2)) MB)" -ForegroundColor Yellow
            }
          }

          npm cache clean --force 2>&1 | Out-Null
          py -m pip cache purge 2>&1 | Out-Null

          Get-ChildItem -Path . -Recurse -Filter "node_modules" -Directory -Force -ErrorAction SilentlyContinue |
            ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }

          @("dist", "build", "*.egg-info", "__pycache__", ".next") | ForEach-Object {
            Get-ChildItem -Path . -Recurse -Filter $_ -Directory -Force -ErrorAction SilentlyContinue |
              ForEach-Object { Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue }
          }

          Write-Host "‚úÖ CACHE OBLITERATION COMPLETE" -ForegroundColor Green

      - name: Create Log Directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics" -Force | Out-Null
          Write-Host "‚úÖ Logging infrastructure ready" -ForegroundColor Green

      # ===== ENVIRONMENT SETUP =====
      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'

      - name: Verify Tool Versions
        shell: pwsh
        run: |
          Write-Host "`n=== TOOL VERSION VERIFICATION ===" -ForegroundColor Cyan

          $tools = @(
            @{ Name = "Node"; Cmd = "node --version" },
            @{ Name = "npm"; Cmd = "npm --version" },
            @{ Name = "Python"; Cmd = "python --version" },
            @{ Name = "pip"; Cmd = "pip --version" }
          )

          foreach ($tool in $tools) {
            $version = & pwsh -Command $tool.Cmd
            Write-Host "  ‚úì $($tool.Name): $version" -ForegroundColor Green
          }

      # ===== FRONTEND BUILD =====
      - name: Frontend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Installing Dependencies ===" -ForegroundColor Cyan
          cd web_platform/frontend

          if (-not (Test-Path "package-lock.json")) {
            throw "‚ùå FATAL: package-lock.json missing!"
          }

          # RETRY LOGIC
          $maxRetries = 3
          $retryDelay = 10
          $success = $false

          for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
            Write-Host "Installation attempt $attempt of $maxRetries..." -ForegroundColor Yellow

            npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../../logs/npm-install-attempt$attempt.log

            if ($LASTEXITCODE -eq 0) {
              $success = $true
              Write-Host "‚úÖ npm ci succeeded on attempt $attempt" -ForegroundColor Green
              break
            } else {
              Write-Host "‚ö†Ô∏è  Attempt $attempt failed" -ForegroundColor Yellow
              if ($attempt -lt $maxRetries) {
                Write-Host "Waiting ${retryDelay}s before retry..." -ForegroundColor Yellow
                Start-Sleep -Seconds $retryDelay
                if (Test-Path "node_modules") {
                  Remove-Item -Recurse -Force "node_modules" -ErrorAction SilentlyContinue
                }
              }
            }
          }

          if (-not $success) {
            Write-Host "`n‚ùå npm ci FAILED after $maxRetries attempts" -ForegroundColor Red
            Get-Content ../../logs/npm-install-attempt$maxRetries.log | Select-Object -Last 50 | Write-Host
            throw "Frontend npm install failed after retries"
          }

          $requiredPkgs = @("next", "react", "react-dom")
          foreach ($pkg in $requiredPkgs) {
            if (-not (Test-Path "node_modules/$pkg")) {
              throw "‚ùå FATAL: Required package '$pkg' not installed"
            }
          }

          Write-Host "‚úÖ Frontend dependencies installed & verified" -ForegroundColor Green

      - name: Frontend - Build Static Export
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Building Static Export ===" -ForegroundColor Cyan
          cd web_platform/frontend

          # Pre-build verification
          if (-not (Test-Path "next.config.mjs")) {
            throw "‚ùå FATAL: next.config.mjs missing"
          }

          npm run build 2>&1 | Tee-Object -FilePath ../../logs/frontend-build.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n‚ùå Frontend build FAILED" -ForegroundColor Red
            Get-Content ../../logs/frontend-build.log | Select-Object -Last 100 | Write-Host
            throw "Frontend build failed"
          }

          # POST-BUILD VERIFICATION (CRITICAL)
          $requiredFiles = @("out/index.html", "out/_next")
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              throw "‚ùå FATAL: Expected output file missing: $file"
            }
            Write-Host "  ‚úì Verified: $file" -ForegroundColor Green
          }

          $fileCount = @(Get-ChildItem -Path "out" -Recurse -File).Count
          Write-Host "‚úÖ Frontend built: $fileCount files" -ForegroundColor Green

          # Generate manifest
          @(Get-ChildItem -Path "out" -Recurse -File | Select-Object FullName) | ConvertTo-Json | Out-File ../../logs/frontend-manifest.json

      - name: Frontend - Stage to Electron
        shell: pwsh
        run: |
          Write-Host "`n=== FRONTEND: Staging to Electron ===" -ForegroundColor Cyan

          $src = "web_platform/frontend/out"
          $dest = "electron/web-ui-build/out"

          if (-not (Test-Path $src)) {
            throw "‚ùå FATAL: Frontend output directory not found at $src"
          }

          if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          $filesBefore = @(Get-ChildItem -Path $src -Recurse -File).Count
          Copy-Item -Path "$src/*" -Destination $dest -Recurse -Force -ErrorAction Stop
          $filesAfter = @(Get-ChildItem -Path $dest -Recurse -File).Count

          if ($filesBefore -ne $filesAfter) {
            throw "‚ùå FATAL: File count mismatch during copy ($filesBefore -> $filesAfter)"
          }

          if (-not (Test-Path "$dest/index.html")) {
            throw "‚ùå FATAL: index.html not found in staging directory"
          }

          Write-Host "‚úÖ Frontend staged: $filesAfter files" -ForegroundColor Green

      # ===== BACKEND BUILD =====
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Installing Dependencies ===" -ForegroundColor Cyan

          if (-not (Test-Path "python_service/requirements.txt")) {
            throw "‚ùå FATAL: requirements.txt not found"
          }

          pip install --upgrade pip wheel setuptools 2>&1 | Tee-Object -FilePath logs/pip-upgrade.log

          $maxRetries = 3
          $retryDelay = 10
          $success = $false
          for ($attempt = 1; $attempt -le $maxRetries; $attempt++) {
            Write-Host "Pip install attempt $attempt of $maxRetries..." -ForegroundColor Yellow
            pip install -r python_service/requirements.txt --no-cache-dir 2>&1 | Tee-Object -FilePath logs/pip-install-attempt$attempt.log
            if ($LASTEXITCODE -eq 0) {
              $success = $true
              Write-Host "‚úÖ Pip install succeeded on attempt $attempt" -ForegroundColor Green
              break
            } else {
              Write-Host "‚ö†Ô∏è Pip install attempt $attempt failed" -ForegroundColor Yellow
              if ($attempt -lt $maxRetries) {
                Write-Host "Waiting ${retryDelay}s before retry..." -ForegroundColor Yellow
                Start-Sleep -Seconds $retryDelay
              }
            }
          }
          if (-not $success) {
            Write-Host "`n‚ùå Pip install FAILED after $maxRetries attempts" -ForegroundColor Red
            Get-Content logs/pip-install-attempt$maxRetries.log | Select-Object -Last 50 | Write-Host
            throw "Backend pip install failed after retries"
          }

          $criticalPkgs = @("fastapi", "uvicorn", "pydantic")
          $installedPkgs = pip list --format=freeze 2>&1
          foreach ($pkg in $criticalPkgs) {
            if (-not ($installedPkgs | Select-String -Pattern "^$($pkg.ToLower())==" -Quiet -CaseSensitive)) {
              throw "‚ùå FATAL: Critical package '$pkg' not installed"
            }
          }
          Write-Host "‚úÖ Backend dependencies installed & verified" -ForegroundColor Green

      - name: Backend - Verify Source Files
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Source File Verification ===" -ForegroundColor Cyan

          $requiredFiles = @(
            "run_backend.py",
            "python_service/api.py",
            "python_service/adapters"
          )

          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              throw "‚ùå FATAL: Required source file missing: $file"
            }
            Write-Host "  ‚úì Found: $file" -ForegroundColor Green
          }

      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Building Executable with PyInstaller ===" -ForegroundColor Cyan
          $adaptersPath = (Resolve-Path -Path "python_service/adapters").Path
          $specLines = @(
              "# -*- mode: python ; coding: utf-8 -*-",
              "import sys",
              "import os",
              "from PyInstaller.utils.hooks import collect_all, collect_submodules, copy_metadata",
              "block_cipher = None",
              "datas = [('__ADAPTERS_PATH__', 'adapters')]",
              "hiddenimports = []",
              "binaries = []",
              "for pkg in ['uvicorn', 'fastapi', 'pydantic', 'pydantic_core', 'httpx', 'certifi', 'bs4', 'pandas', 'aiosqlite']:",
              "    tmp_datas, tmp_binaries, tmp_hiddenimports = collect_all(pkg)",
              "    datas += tmp_datas",
              "    binaries += tmp_binaries",
              "    hiddenimports += tmp_hiddenimports",
              "for pkg in ['pydantic', 'pydantic_core', 'fastapi', 'uvicorn', 'httpx']:",
              "    datas += copy_metadata(pkg)",
              "hiddenimports += [",
              "    'uvicorn.logging', 'uvicorn.loops.auto', 'uvicorn.protocols.http.auto',",
              "    'uvicorn.protocols.websockets.auto', 'uvicorn.lifespan.on', 'h11',",
              "    'httptools', 'websockets', 'fastapi.routing', 'starlette.routing',",
              "    'starlette.middleware', 'starlette.middleware.cors', 'pydantic._internal',",
              "    'pydantic.deprecated', 'email.mime.multipart', 'email.mime.text',",
              "    '_sqlite3', 'sqlite3', 'win32api', 'win32con', 'pywintypes',",
              "]",
              "a = Analysis(",
              "    ['run_backend.py'], pathex=[], binaries=binaries, datas=datas,",
              "    hiddenimports=hiddenimports, hookspath=[], hooksconfig={}, runtime_hooks=[],",
              "    excludes=['matplotlib', 'tkinter', 'pytest', 'IPython'],",
              "    win_no_prefer_redirects=False, win_private_assemblies=False, cipher=block_cipher,",
              "    noarchive=False",
              ")",
              "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)",
              "exe = EXE(",
              "    pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],",
              "    name='fortuna-backend', debug=False, bootloader_ignore_signals=False,",
              "    strip=False, upx=True, upx_exclude=[], runtime_tmpdir=None, console=True,",
              "    disable_windowed_traceback=False, argv_emulation=False, target_arch=None,",
              "    codesign_identity=None, entitlements_file=None",
              ")"
          )
          $specContent = ($specLines -join "`n").Replace('__ADAPTERS_PATH__', $adaptersPath.Replace('\', '/'))
          Set-Content -Path "fortuna-backend.spec" -Value $specContent -Encoding UTF8
          pyinstaller fortuna-backend.spec `
            --distpath electron/resources `
            --workpath python_service/build-pyinstaller `
            --clean --noconfirm `
            2>&1 | Tee-Object -FilePath logs/pyinstaller.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n‚ùå PyInstaller FAILED" -ForegroundColor Red
            Get-Content logs/pyinstaller.log | Select-Object -Last 100 | Write-Host
            throw "PyInstaller build failed"
          }

      - name: Backend - Verify Executable
        shell: pwsh
        run: |
          Write-Host "`n=== BACKEND: Executable Verification ===" -ForegroundColor Cyan

          $exe = "electron/resources/fortuna-backend.exe"

          if (-not (Test-Path $exe)) {
            throw "‚ùå FATAL: Backend executable not found at: $exe"
          }

          $exeInfo = Get-Item $exe
          $size = $exeInfo.Length / 1MB
          $fileHash = (Get-FileHash -Path $exe -Algorithm SHA256).Hash

          Write-Host "  ‚úì Path: $exe" -ForegroundColor Green
          Write-Host "  ‚úì Size: $([math]::Round($size, 2)) MB" -ForegroundColor Green
          Write-Host "  ‚úì SHA256: $fileHash" -ForegroundColor Green
          Write-Host "  ‚úì Last Modified: $($exeInfo.LastWriteTime)" -ForegroundColor Green

          # Verify minimum size (should be 100+ MB with FastAPI/pandas)
          if ($exeInfo.Length -lt 50MB) {
            throw "‚ùå FATAL: Executable seems too small ($([math]::Round($size, 2)) MB). Possible packaging error."
          }

          # Try to extract version info
          $versionInfo = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($exe)
          Write-Host "  ‚úì Executable is valid PE file" -ForegroundColor Green

      - name: Backend - Deep Integration Test
        shell: pwsh
        timeout-minutes: 10
        run: |
          Write-Host "`n=== BACKEND: FORTRESS INTEGRATION TEST ===" -ForegroundColor Cyan

          $exe = "electron/resources/fortuna-backend.exe"
          $testDir = "backend-test-env"
          $testPort = "8000"

          if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir }
          New-Item -ItemType Directory -Path $testDir -Force | Out-Null

          # Create .env file for the backend process
          $envLines = @(
            "API_KEY=${{ env.API_KEY }}",
            "PORT=$testPort",
            "HOST=0.0.0.0"
          )
          Set-Content -Path (Join-Path $testDir ".env") -Value ($envLines -join "`n") -Encoding UTF8

          Write-Host "‚úÖ .env created. Content Check (API_KEY Exists?):" -ForegroundColor Green
          (Get-Content (Join-Path $testDir ".env") -Raw) | Select-String "API_KEY" | Write-Host -ForegroundColor Yellow

          Write-Host "Starting executable test (Checking ENV file: .env) ..." -ForegroundColor Yellow
          Write-Host "  Port: $testPort | API_KEY length: $(($envLines | Select-String -Pattern "API_KEY=").ToString().Length - 8)" -ForegroundColor DarkYellow

          $process = Start-Process -FilePath $exe `
            -WorkingDirectory $testDir `
            -PassThru -NoNewWindow `
            -RedirectStandardOutput "$testDir/stdout.log" `
            -RedirectStandardError "$testDir/stderr.log"

          Write-Host "Process PID: $($process.Id)" -ForegroundColor DarkYellow
          Start-Sleep -Seconds 2

          # Display initial output
          Write-Host "`n--- Initial Backend Output (first 2s) ---" -ForegroundColor DarkCyan
          if (Test-Path "$testDir/stdout.log") {
            Get-Content "$testDir/stdout.log" | Write-Host -ForegroundColor Green
          }
          if (Test-Path "$testDir/stderr.log") {
            Get-Content "$testDir/stderr.log" | Write-Host -ForegroundColor Yellow
          }

          # Resilient Health-Check Polling Loop
          $maxTotalTimeout = 90 # Total seconds allowed for Uvicorn startup
          $checkInterval = 1
          $timeElapsed = 0
          $serverReady = $false

          while ($timeElapsed -lt $maxTotalTimeout) {
            if ($process.HasExited) {
              Write-Host "`n‚ùå PROCESS CRASHED (exit code: $($process.ExitCode))" -ForegroundColor Red
              throw "‚ùå FATAL: Backend process crashed during startup"
            }

            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:$testPort/health" -TimeoutSec 1 -UseBasicParsing -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                $serverReady = $true
                Write-Host "`n‚úÖ HEALTH CHECK PASSED (Total time: ${timeElapsed}s)" -ForegroundColor Green
                break
              }
            } catch {
              if ($timeElapsed % 5 -eq 0) { Write-Host "[$timeElapsed/${maxTotalTimeout}s] Server connecting..." -ForegroundColor DarkYellow }
            }

            Start-Sleep -Seconds $checkInterval
            $timeElapsed += $checkInterval
          }

          if (-not $serverReady) {
            Write-Host "`n‚ùå HEALTH CHECK FAILED AFTER $maxTotalTimeout SECONDS" -ForegroundColor Red

            Write-Host "`n=== FULL DIAGNOSTICS ===" -ForegroundColor Red

            Write-Host "`n--- Port Status ---" -ForegroundColor Red
            netstat -ano | Select-String ":$testPort|:8000|:8999|:8998" | Write-Host

            Write-Host "`n--- Full STDERR ---" -ForegroundColor Red
            Get-Content "$testDir/stderr.log" | Write-Host

            Write-Host "`n--- Full STDOUT ---" -ForegroundColor Red
            Get-Content "$testDir/stdout.log" | Write-Host

            Write-Host "`n--- Process Check ---" -ForegroundColor Red
            Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue | Write-Host

            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
            throw "‚ùå FATAL: Backend never responded to health checks"
          }

          # Endpoint testing (CRITICAL PATH)
          Write-Host "`n=== ENDPOINT VALIDATION ===" -ForegroundColor Cyan

          $endpoints = @(
            @{ Path = "/health"; Name = "Health"; ExpectedCode = 200 },
            @{ Path = "/api/status"; Name = "Status"; ExpectedCode = 200 },
            @{ Path = "/docs"; Name = "OpenAPI"; ExpectedCode = 200 }
          )

          $allPassed = $true
          foreach ($ep in $endpoints) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:$testPort$($ep.Path)" -TimeoutSec 5 -ErrorAction Stop
              if ($response.StatusCode -eq $ep.ExpectedCode) {
                Write-Host "  ‚úÖ $($ep.Name): $($response.StatusCode)" -ForegroundColor Green
              } else {
                Write-Host "  ‚ùå $($ep.Name): Got $($response.StatusCode), expected $($ep.ExpectedCode)" -ForegroundColor Red
                $allPassed = $false
              }
            } catch {
              Write-Host "  ‚ùå $($ep.Name): $($_.Exception.Message)" -ForegroundColor Red
              $allPassed = $false
            }
          }

          # Cleanup
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 1

          # Save diagnostics
          Copy-Item "$testDir/stderr.log" "logs/backend-integration-stderr.log" -ErrorAction SilentlyContinue
          Copy-Item "$testDir/stdout.log" "logs/backend-integration-stdout.log" -ErrorAction SilentlyContinue

          if (-not $allPassed) {
            throw "‚ùå FATAL: Some endpoint tests failed"
          }

          Write-Host "`n‚úÖ INTEGRATION TEST COMPLETE - ALL SYSTEMS GO" -ForegroundColor Green

      # ===== E2E UI TEST =====
      - name: 'üì∏ End-to-End UI Test (Fortress Mode)'
        shell: pwsh
        timeout-minutes: 10
        run: |
          Write-Host "`n=== E2E UI TEST: FORTRESS MODE ===" -ForegroundColor Magenta
          $backendExe = "electron/resources/fortuna-backend.exe"
          $frontendDir = "electron/web-ui-build/out"
          $backendPort = "8999"
          $frontendPort = "8998"
          $testDir = "e2e-test-env"
          if (Test-Path $testDir) { Remove-Item -Recurse -Force $testDir }
          New-Item -ItemType Directory -Path $testDir -Force | Out-Null

          # Create .env file for the backend process
          $envLines = @(
            "API_KEY=${{ env.API_KEY }}",
            "PORT=$backendPort",
            "HOST=0.0.0.0",
            "ALLOWED_ORIGINS=http://127.0.0.1:$frontendPort"
          )
          Set-Content -Path (Join-Path $testDir ".env") -Value ($envLines -join "`n") -Encoding UTF8

          Write-Host "‚úÖ E2E .env created. Content Check (API_KEY Exists?):" -ForegroundColor Green
          (Get-Content (Join-Path $testDir ".env") -Raw) | Select-String "API_KEY" | Write-Host -ForegroundColor Yellow

          $backendProcess = $null
          $frontendProcess = $null
          try {
              Write-Host "`nüöÄ Starting E2E backend on :$backendPort..." -ForegroundColor Cyan
              $backendProcess = Start-Process -FilePath $backendExe `
                -WorkingDirectory $testDir -PassThru -NoNewWindow `
                -RedirectStandardOutput "$testDir/backend-stdout.log" `
                -RedirectStandardError "$testDir/backend-stderr.log"
              $maxAttempts = 60
              $serverReady = $false
              for ($i = 1; $i -le $maxAttempts; $i++) {
                Start-Sleep -Seconds 1
                if ($backendProcess.HasExited) {
                  throw "‚ùå Backend crashed during E2E startup"
                }
                try {
                  $response = Invoke-WebRequest -Uri "http://127.0.0.1:$backendPort/health" -TimeoutSec 2 -ErrorAction Stop
                  if ($response.StatusCode -eq 200) {
                    $serverReady = $true
                    Write-Host "‚úÖ Backend ready (E2E)" -ForegroundColor Green
                    break
                  }
                } catch { Write-Host "." -NoNewline }
              }
              if (-not $serverReady) { throw "Backend E2E startup timeout" }
              Write-Host "`nüöÄ Starting frontend on :$frontendPort..." -ForegroundColor Cyan
              $frontendProcess = Start-Process python -ArgumentList "-m http.server $frontendPort --directory $frontendDir" `
                -PassThru -NoNewWindow `
                -RedirectStandardOutput "$testDir/frontend-stdout.log" `
                -RedirectStandardError "$testDir/frontend-stderr.log"
              Start-Sleep -Seconds 3
              Write-Host "`nüé≠ Installing Playwright & Chromium..." -ForegroundColor Cyan
              pip install playwright 2>&1 | Out-Null
              playwright install --with-deps chromium 2>&1 | Out-Null
              Write-Host "‚úÖ Playwright ready" -ForegroundColor Green
              Write-Host "`n‚úçÔ∏è  Running E2E screenshot test..." -ForegroundColor Cyan
              $pyScriptLines = @(
                  "from playwright.sync_api import sync_playwright",
                  "import sys",
                  "import json",
                  "def run(playwright):",
                  "    browser = playwright.chromium.launch()",
                  "    page = browser.new_page()",
                  "    try:",
                  "        url = 'http://127.0.0.1:__FRONTEND_PORT__'",
                  "        print(f'[E2E] Navigating to {url}')",
                  "        page.goto(url, timeout=20000)",
                  "        print('[E2E] Waiting for body element')",
                  "        page.wait_for_selector('body', timeout=10000)",
                  "        print('[E2E] Page loaded successfully')",
                  "        page.screenshot(path='e2e-screenshot.png', full_page=True)",
                  "        print('[E2E] ‚úÖ E2E TEST PASSED')",
                  "    except Exception as e:",
                  "        print(f'[E2E] ‚ùå E2E TEST FAILED: {e}', file=sys.stderr)",
                  "        page.screenshot(path='e2e-screenshot-failed.png', full_page=True)",
                  "        raise",
                  "    finally:",
                  "        browser.close()",
                  "with sync_playwright() as playwright:",
                  "    run(playwright)"
              )
              $pyScript = ($pyScriptLines -join "`n") -replace '__FRONTEND_PORT__', $frontendPort
              Set-Content -Path "run_e2e_test.py" -Value $pyScript
              py run_e2e_test.py 2>&1 | Tee-Object -FilePath "$testDir/playwright.log"
              if ($LASTEXITCODE -ne 0) { throw "E2E test failed" }
              Write-Host "‚úÖ E2E UI Test PASSED" -ForegroundColor Green
          } finally {
              Write-Host "`nüßπ Cleaning up E2E processes..." -ForegroundColor Cyan
              if ($backendProcess -and -not $backendProcess.HasExited) { Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue }
              if ($frontendProcess -and -not $frontendProcess.HasExited) { Stop-Process -Id $frontendProcess.Id -Force -ErrorAction SilentlyContinue }
              Copy-Item "$testDir/*.log" "logs/" -ErrorAction SilentlyContinue -Force
          }

      # ===== ELECTRON BUILD =====
      - name: Electron - Install Dependencies
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Installing Dependencies ===" -ForegroundColor Cyan
          cd electron

          if (-not (Test-Path "package-lock.json")) {
            throw "‚ùå FATAL: Electron package-lock.json missing"
          }

          npm ci --prefer-offline --no-audit 2>&1 | Tee-Object -FilePath ../logs/npm-electron.log

          if ($LASTEXITCODE -ne 0) {
            throw "Electron npm install failed"
          }

          # Verify critical Electron packages
          if (-not (Test-Path "node_modules/electron")) {
            throw "‚ùå FATAL: Electron not installed"
          }

          Write-Host "‚úÖ Electron dependencies installed" -ForegroundColor Green

      - name: Electron - Pre-Build Verification (CRITICAL)
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: PRE-BUILD VERIFICATION ===" -ForegroundColor Cyan

          $checks = @{
            "main.js" = "electron/main.js"
            "preload.js" = "electron/preload.js"
            "package.json" = "electron/package.json"
            "electron-builder-config.yml" = "electron/electron-builder-config.yml"
            "icon.ico" = "electron/assets/icon.ico"
            "backend.exe" = "electron/resources/fortuna-backend.exe"
            "frontend/index.html" = "electron/web-ui-build/out/index.html"
            "frontend/_next" = "electron/web-ui-build/out/_next"
          }

          $allPresent = $true
          foreach ($name in $checks.Keys) {
            $path = $checks[$name]
            if (-not (Test-Path $path)) {
              Write-Host "  ‚ùå MISSING: $name" -ForegroundColor Red
              $allPresent = $false
            } else {
              $item = Get-Item $path
              $size = if ($item.PSIsContainer) { "[DIR]" } else { "$($item.Length / 1KB) KB" }
              Write-Host "  ‚úì $name ($size)" -ForegroundColor Green
            }
          }

          if (-not $allPresent) {
            throw "‚ùå FATAL: Some required files are missing"
          }

          Write-Host "`n‚úÖ All pre-build checks passed" -ForegroundColor Green

      - name: Electron - Validate Configuration
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: Configuration Validation ===" -ForegroundColor Cyan

          $configPath = "electron/electron-builder-config.yml"
          $configContent = Get-Content $configPath -Raw

          $requiredStrings = @(
            "artifactName",
            "directories",
            "files",
            "nsis"
          )

          foreach ($req in $requiredStrings) {
            if ($configContent -notmatch $req) {
              throw "‚ùå FATAL: electron-builder config missing required key: $req"
            }
            Write-Host "  ‚úì Found: $req" -ForegroundColor Green
          }

          Write-Host "‚úÖ Configuration is valid" -ForegroundColor Green

      - name: Electron - Build MSI
        shell: pwsh
        run: |
          Write-Host "`n=== ELECTRON: BUILDING MSI ===" -ForegroundColor Cyan
          cd electron

          $startTime = Get-Date
          Write-Host "Build start: $startTime" -ForegroundColor DarkYellow

          npx electron-builder --config electron-builder-config.yml --publish never 2>&1 | Tee-Object -FilePath ../logs/electron-builder.log

          if ($LASTEXITCODE -ne 0) {
            Write-Host "`n‚ùå electron-builder FAILED" -ForegroundColor Red
            Get-Content ../logs/electron-builder.log | Select-Object -Last 100 | Write-Host
            throw "MSI build failed"
          }

          $endTime = Get-Date
          $duration = ($endTime - $startTime).TotalSeconds
          Write-Host "‚úÖ MSI build completed in $([math]::Round($duration))s" -ForegroundColor Green

      # ===== POST-BUILD VERIFICATION =====
      - name: Post-Build - Locate & Verify MSI
        shell: pwsh
        run: |
          Write-Host "`n=== POST-BUILD: MSI VERIFICATION ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $msi) {
            Write-Host "`n‚ùå FATAL: MSI file not found!" -ForegroundColor Red
            Write-Host "`nContents of electron/dist:" -ForegroundColor Yellow
            if (Test-Path "electron/dist") {
              Get-ChildItem -Path "electron/dist" -Recurse | ForEach-Object { Write-Host "  $_" }
            } else {
              Write-Host "  (directory does not exist!)"
            }
            throw "MSI not found"
          }

          $size = $msi.Length / 1MB
          $hash = (Get-FileHash -Path $msi.FullName -Algorithm SHA256).Hash

          Write-Host "  ‚úì Filename: $($msi.Name)" -ForegroundColor Green
          Write-Host "  ‚úì Size: $([math]::Round($size, 2)) MB" -ForegroundColor Green
          Write-Host "  ‚úì Path: $($msi.FullName)" -ForegroundColor Green
          Write-Host "  ‚úì SHA256: $hash" -ForegroundColor Green
          Write-Host "  ‚úì Last Modified: $($msi.LastWriteTime)" -ForegroundColor Green

          # Verify minimum size
          if ($msi.Length -lt 50MB) {
            throw "‚ùå FATAL: MSI too small ($([math]::Round($size, 2)) MB). Possible packaging error."
          }

          # Verify it's actually a Windows Installer file (MZ header + "Embedded Document" signature)
          $bytes = [System.IO.File]::ReadAllBytes($msi.FullName)
          if ($bytes[0] -ne 0xD0 -or $bytes[1] -ne 0xCF) {
            throw "‚ùå FATAL: MSI file header invalid. Not a valid Windows Installer."
          }

          Write-Host "`n‚úÖ MSI Verification PASSED" -ForegroundColor Green

          # Save metadata
          @{
            FileName = $msi.Name
            FullPath = $msi.FullName
            SizeMB = [math]::Round($size, 2)
            SHA256 = $hash
            CreatedAt = $msi.LastWriteTime
            BuildID = "${{ github.run_id }}-${{ github.run_number }}"
          } | ConvertTo-Json | Out-File -FilePath "msi-metadata.json" -Force

          $msi.FullName | Out-File -FilePath "msi-path.txt" -Force

      - name: Post-Build - MSI Content Extraction (7-Zip Deep Inspection)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`n=== POST-BUILD: DEEP MSI INSPECTION ===" -ForegroundColor Cyan

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $msi) { return }

          $sevenZip = "C:\Program Files\7-Zip\7z.exe"
          if (-not (Test-Path $sevenZip)) {
            Write-Host "‚ö†Ô∏è  7-Zip not found. Skipping deep inspection." -ForegroundColor Yellow
            return
          }

          $extractPath = "msi-inspection"
          if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
          New-Item -ItemType Directory -Path $extractPath -Force | Out-Null

          & $sevenZip x "$($msi.FullName)" -o"$extractPath" -y 2>&1 | Out-Null

          Write-Host "`nMSI Contents:" -ForegroundColor Cyan
          $files = @(Get-ChildItem -Path $extractPath -Recurse -File)
          Write-Host "  Total files: $($files.Count)" -ForegroundColor Green

          $criticalFiles = @(
            "*fortuna-backend.exe",
            "*index.html",
            "*main.js"
          )

          foreach ($pattern in $criticalFiles) {
            $found = $files | Where-Object { $_.Name -like $pattern }
            if ($found) {
              Write-Host "  ‚úì Found: $($found.Name)" -ForegroundColor Green
            } else {
              Write-Host "  ‚ùå Missing: $pattern" -ForegroundColor Red
            }
          }

      - name: Build Summary - Fortress Report
        shell: pwsh
        run: |
          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Magenta
          Write-Host "‚ïë              üèÜ FORTRESS BUILD COMPLETE üèÜ                  ‚ïë" -ForegroundColor Magenta
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Magenta

          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($msi) {
            Write-Host "`nüì¶ DELIVERABLE:" -ForegroundColor Green
            Write-Host "   ‚úÖ MSI Installer: $($msi.Name)" -ForegroundColor Green
            Write-Host "   ‚úÖ Size: $([math]::Round($msi.Length / 1MB, 2)) MB" -ForegroundColor Green
            Write-Host "   ‚úÖ SHA256: $((Get-FileHash -Path $msi.FullName -Algorithm SHA256).Hash.Substring(0, 16))..." -ForegroundColor Green
          }

          Write-Host "`n‚úÖ VERIFICATION CHECKLIST:" -ForegroundColor Green
          Write-Host "   ‚úÖ Frontend: Built & staged to Electron" -ForegroundColor Green
          Write-Host "   ‚úÖ Backend: PyInstaller executable created & tested" -ForegroundColor Green
          Write-Host "   ‚úÖ Integration: Health checks & endpoint validation passed" -ForegroundColor Green
          Write-Host "   ‚úÖ E2E UI: Playwright screenshot test passed" -ForegroundColor Green
          Write-Host "   ‚úÖ Packaging: MSI created & validated" -ForegroundColor Green

          Write-Host "`nüìä BUILD ARTIFACTS:" -ForegroundColor Cyan
          Write-Host "   ‚Ä¢ Build logs: logs/" -ForegroundColor Cyan
          Write-Host "   ‚Ä¢ Diagnostics: diagnostics/" -ForegroundColor Cyan
          Write-Host "   ‚Ä¢ MSI metadata: msi-metadata.json" -ForegroundColor Cyan
          Write-Host "   ‚Ä¢ Screenshots: e2e-screenshot.png" -ForegroundColor Cyan

          Write-Host "`nüöÄ READY FOR DEPLOYMENT" -ForegroundColor Green
          Write-Host "   This MSI has passed all fortress-level quality gates." -ForegroundColor Green
          Write-Host "`n" -ForegroundColor Magenta

      # ===== ARTIFACT UPLOAD =====
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fortuna-installer-${{ github.ref_name }}
          path: electron/dist/**/*.msi
          retention-days: 30
          if-no-files-found: error

      - name: Post-Build - Verify MSI with Windows Installer
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "electron/dist" -Filter "*.msi" -Recurse | Select-Object -First 1
          if ($msi) {
            try {
              $windowsInstaller = New-Object -ComObject WindowsInstaller.Installer
              $database = $windowsInstaller.GetType().InvokeMember("OpenDatabase", "InvokeMethod", $null, $windowsInstaller, @($msi.FullName, 0))
              $view = $database.GetType().InvokeMember("OpenView", "InvokeMethod", $null, $database, @("SELECT Value FROM Property WHERE Property='ProductName'"))
              $view.GetType().InvokeMember("Execute", "InvokeMethod", $null, $view, $null)
              $record = $view.GetType().InvokeMember("Fetch", "InvokeMethod", $null, $view, $null)
              $productName = $record.GetType().InvokeMember("StringData", "GetProperty", $null, $record, 1)
              Write-Host "  ‚úì MSI ProductName: $productName" -ForegroundColor Green
            } catch {
              Write-Host "  ‚ö†Ô∏è Could not validate MSI with Windows Installer: $($_.Exception.Message)" -ForegroundColor Yellow
            } finally {
              if ($database) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($database) }
              if ($windowsInstaller) { [System.Runtime.Interopservices.Marshal]::ReleaseComObject($windowsInstaller) }
            }
          }
      - name: Generate SBOM
        shell: pwsh
        run: |
          pip install cyclonedx-bom
          cyclonedx-py -r -i python_service -o sbom-backend.json
          cd web_platform/frontend
          npm install
          npm sbom --omit=dev --output-format=json > ../../sbom-frontend.json

      - name: Upload Build Diagnostics
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-diagnostics-${{ github.ref_name }}
          path: |
            logs/
            diagnostics/
            msi-metadata.json
            build-telemetry.json
          retention-days: 14
          if-no-files-found: warn
      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sboms-${{ github.ref_name }}
          path: |
            sbom-backend.json
            sbom-frontend.json

      - name: Upload E2E Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-screenshots-${{ github.ref_name }}
          path: |
            e2e-screenshot.png
            e2e-screenshot-failed.png
          retention-days: 30
          if-no-files-found: warn

      # ===== GITHUB RELEASE (Tags Only) =====
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: electron/dist/**/*.msi
          name: "Fortuna Faucet ${{ github.ref_name }}"
          draft: false
          prerelease: false
          body: |
            # üèÜ Fortuna Faucet ${{ github.ref_name }}

            ## üì¶ What's Included
            - ‚úÖ Python FastAPI backend (standalone executable)
            - ‚úÖ Next.js frontend (static HTML/CSS/JS)
            - ‚úÖ Electron desktop wrapper
            - ‚úÖ NSIS Windows installer

            ## ‚öôÔ∏è Installation
            1. Download the `.msi` installer below
            2. Run installer (admin privileges required)
            3. Application will appear in Start Menu
            4. Launch and enjoy!

            ## üìã System Requirements
            - **OS**: Windows 10 (Build 19041+) or Windows 11
            - **Architecture**: 64-bit only
            - **RAM**: 2 GB minimum recommended
            - **Disk Space**: 300 MB for installation
            - **No dependencies**: Python, Node.js, or runtime not required

            ## ‚ú® Build Information
            - **Build ID**: ${{ github.run_id }}
            - **Build Number**: ${{ github.run_number }}
            - **Commit**: ${{ github.sha }}
            - **Built with**: GitHub Actions (Windows Latest)

            ## üîí Verification
            All builds are created with fortress-level quality assurance:
            - ‚úÖ System health verification
            - ‚úÖ Dependency integrity checks
            - ‚úÖ Frontend build validation
            - ‚úÖ Backend PyInstaller testing
            - ‚úÖ Integration test suite
            - ‚úÖ End-to-end UI validation
            - ‚úÖ MSI package inspection

            **Built with ‚ù§Ô∏è by GitHub Actions - Fortress Mode**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
