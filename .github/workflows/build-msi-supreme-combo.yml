# System Timestamp: 2025-12-21 14:04:35
name: ðŸš€ Supreme Combo Build (MSI)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip heavy tests?'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11' # 3.12 breaks some x86 wheels
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8102'

  # Mock credentials for smoke tests to prevent crashes
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  # =========================================================
  # PHASE 1: PRE-FLIGHT & INTEGRITY
  # =========================================================
  preflight-check:
    name: ðŸ” System & Asset Preflight
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.git_version.outputs.semver }}
      build_id: ${{ steps.git_version.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ðŸ§¹ Pre-Flight: Clear Zombie Ports
        shell: pwsh
        run: |
          $ports = @(3000, 8000)
          foreach ($port in $ports) {
            $tcp = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
            if ($tcp) {
              Stop-Process -Id $tcp.OwningProcess -Force
              Write-Host "Cleared zombie process on port $port"
            }
          }
      - name: ðŸ·ï¸ Derive SemVer & Build ID
        id: git_version
        shell: pwsh
        run: |
          $semver = "0.0.${{ github.run_number }}"
          $run = "${{ github.run_number }}"
          echo "semver=$semver" >> $env:GITHUB_OUTPUT
          echo "build_id=$run" >> $env:GITHUB_OUTPUT
          Write-Host "Build Version: $semver"

      - name: ðŸ”Ž Forensic Asset Verification (GPT5)
        shell: pwsh
        run: |
          $critical = @("web_platform/frontend/package.json", "web_service/backend/requirements.txt", "build_wix/Product_WebService.wxs")
          foreach ($file in $critical) {
            if (-not (Test-Path $file)) {
              Write-Error "âŒ FATAL: Missing critical asset: $file"; exit 1
            }
            $hash = (Get-FileHash $file).Hash
            Write-Host "âœ… Verified: $file ($hash)"
          }

  # =========================================================
  # PHASE 2: PARALLEL BUILDS (Matrix Architecture)
  # =========================================================
  build-backend:
    name: ðŸ Build Backend (${{ matrix.arch }})
    needs: [preflight-check, build-frontend]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: web_platform/frontend/out

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      - name: ðŸ§¾ Create Architecture Constraints (Revived)
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "ðŸ›¡ï¸ ACTIVATING X86 SAFE MODE"
            "numpy==1.23.5`r`npandas==1.5.3" | Set-Content $file
          } else {
            New-Item $file -ItemType File -Force
          }
          echo "file=$file" >> $env:GITHUB_OUTPUT

      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install -r web_service/backend/requirements.txt -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller

      - name: ðŸ§ª Backend Quality Gate (Fail Fast)
        if: matrix.arch == 'x64' && !inputs.skip_tests
        run: |
          python -m compileall web_service/backend -q

      - name: ðŸ—ï¸ Build Binary (PyInstaller)
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          python scripts/generate_spec_dual.py --mode svc

      - name: ðŸ“¤ Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: dist/fortuna-core-service
          retention-days: 1

  build-frontend:
    name: âš›ï¸ Build Frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web_platform/frontend/package-lock.json

      - name: ðŸ—ï¸ Build Next.js/React
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build

      - name: ðŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: web_platform/frontend/out
          retention-days: 1

  # =========================================================
  # PHASE 3: PACKAGE MSI (The Dietician & The Canary)
  # =========================================================
  package-msi:
    name: ðŸ“¦ Package MSI (${{ matrix.arch }})
    needs: [build-backend]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4

      # Download Artifacts
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: staging/backend

      - name: ðŸ“ Inject Restart Script (Revived)
        shell: cmd
        run: |
          echo @echo off > staging\\backend\\restart_service.bat
          echo net stop FortunaWebService >> staging\\backend\\restart_service.bat
          echo net start FortunaWebService >> staging\\backend\\restart_service.bat

      - name: âš–ï¸ The Dietician (Size Analysis)
        shell: pwsh
        run: |
          $size = (Get-ChildItem staging -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "ðŸ“Š Total Payload: $([math]::Round($size, 2)) MB"
          if ($size -gt 300) { Write-Warning "âš ï¸ BLOAT ALERT: Payload exceeds 300MB!" }

      - name: ðŸ§ Pre-Build Forensic File Audit
        shell: pwsh
        run: |
          Get-ChildItem -Path "staging" -Recurse | Select-Object FullName, Length

      - name: ðŸ”§ Setup WiX Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - run: dotnet tool install --global wix --version ${{ env.WIX_VERSION }}

      - run: echo C:\Users\runneradmin\.dotnet\tools >> $GITHUB_PATH
        shell: bash

      - name: ðŸ—ï¸ Build MSI
        shell: pwsh
        run: |
          $arch = "${{ matrix.arch }}"
          wix build build_wix/Product_WebService.wxs `
            -arch $arch `
            -o "Fortuna-${{ needs.preflight-check.outputs.semver }}-${arch}.msi" `
            -d Version="${{ needs.preflight-check.outputs.semver }}" `
            -d SourceDir="staging/backend" `
            -d Platform=$arch

      - name: ðŸ¦œ The Canary (Malware Scan)
        continue-on-error: true
        shell: pwsh
        run: |
          $msi = "Fortuna-${{ needs.preflight-check.outputs.semver }}-${{ matrix.arch }}.msi"
          if (Test-Path "C:\\Program Files\\Windows Defender\\MpCmdRun.exe") {
            Write-Host "ðŸ›¡ï¸ Scanning $msi with Windows Defender..."
            & "C:\\Program Files\\Windows Defender\\MpCmdRun.exe" -Scan -ScanType 3 -File "$pwd\\$msi"
            if ($LASTEXITCODE -ne 0) { throw "ðŸ¦  MALWARE DETECTED in MSI!" }
          }

      - name: ðŸ“¤ Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: Fortuna-${{ needs.preflight-check.outputs.semver }}-${{ matrix.arch }}.msi

      - name: 'ðŸ§ª Basic Integrity Check'
        shell: pwsh
        run: |
            Get-ChildItem -Path "." -Recurse

  # =========================================================
  # PHASE 4: SMOKE TEST (Paparazzi & CSI)
  # =========================================================
  smoke-test:
    name: ðŸš¬ Smoke Test (${{ matrix.arch }})
    needs: package-msi
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: Pre-Flight - Clear Zombie Ports
        shell: powershell
        run: |
          Write-Host "Checking for zombie processes on ports 3000 and 8000..."
          $ports = @(3000, 8000)
          foreach ($port in $ports) {
            $tcp = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue
            if ($tcp) {
              Write-Host "Killing process on port $port (PID $($tcp.OwningProcess))..."
              Stop-Process -Id $tcp.OwningProcess -Force -ErrorAction SilentlyContinue
            }
          }
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4 # Needed for Playwright

      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: msi-installer

      - name: 'ðŸ§ª Basic Integrity Check'
        shell: pwsh
        run: |
            Get-ChildItem -Path "msi-installer" -Recurse

      - name: ðŸ§¹ Pre-Install Cleanup
        shell: pwsh
        run: |
          # The '*' is a wildcard that tells PowerShell to ignore any errors if the service doesn't exist.
          sc.exe delete "FortunaWebService" *>$null
          Start-Sleep -Seconds 2

      - name: ðŸ’¿ Install MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) { throw "MSI not found in msi-installer directory!" }
          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /quiet /norestart" -Wait
          Start-Sleep 10 # Give service time to register

      - name: ðŸ” Dynamic Path Verification (Revived)
        shell: pwsh
        run: |
          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { $env:ProgramFiles }
          $installRoot = Join-Path $progFiles "Fortuna Faucet Service"
          if (-not (Test-Path $installRoot)) { throw "âŒ Install dir not found at $installRoot" }
          Write-Host "âœ… Found install at $installRoot"
          New-Item -Path "$installRoot\data", "$installRoot\json", "$installRoot\logs" -ItemType Directory -Force | Out-Null
          Start-Service "FortunaWebService"
          Start-Sleep 10

      - name: ðŸ©º Health Check
        shell: pwsh
        run: |
          $maxRetries = 5
          $delay = 2 # Initial delay in seconds
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:${{ env.SERVICE_PORT }}/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Health check PASSED on attempt $i."
                exit 0
              } else {
                Write-Warning "Attempt $i: Received status code $($response.StatusCode)"
              }
            } catch {
              Write-Warning "Attempt $i: Health check failed. Error: $($_.Exception.Message)"
            }
            if ($i -lt $maxRetries) {
              $currentDelay = [math]::Pow($delay, $i)
              Write-Host "Waiting for $currentDelay seconds before retry..."
              Start-Sleep -Seconds $currentDelay
            }
          }
          throw "âŒ Service health check failed after $maxRetries attempts."

      - name: ðŸ“¸ Paparazzi (Visual Proof)
        continue-on-error: true
        shell: pwsh
        run: |
          $url = "http://127.0.0.1:${{ env.SERVICE_PORT }}/docs"
          Write-Host "Waiting for URL: $url"
          $maxRetries = 10
          $delay = 3
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… URL is accessible. Proceeding with screenshot."
                break
              }
            } catch {
              Write-Warning "Attempt ${i}: URL not accessible yet. Retrying in $delay seconds..."
              Start-Sleep -Seconds $delay
            }
            if ($i -eq $maxRetries) {
              throw "âŒ URL did not become accessible after $maxRetries attempts."
            }
          }

          npm install playwright
          npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            try {
              await page.goto('$url', {timeout: 15000});
              await page.screenshot({ path: 'proof.png' });
            } catch(e) { console.error(e); process.exit(1); }
            await browser.close();
          })();"

      - name: 'ðŸ•µï¸ CSI: Windows Post-Mortem (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Get-Process | Where-Object { $_.ProcessName -match "fortuna" }
          Get-EventLog -LogName Application -Newest 50 -EntryType Error,Warning

      - name: ðŸ“¤ Upload Proof
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-proof-${{ matrix.arch }}
          path: proof.png

  # =========================================================
  # PHASE 5: RELEASE
  # =========================================================
  release:
    name: ðŸš€ Publish Release
    needs: smoke-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: msi-*
          merge-multiple: true
          path: release_assets

      - name: ðŸ” Generate Checksums
        run: |
          cd release_assets
          sha256sum *.msi > SHASUMS256.txt

      - name: ðŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*
          generate_release_notes: true
