# System Timestamp: 2025-12-24 18:00:00
name: üî¨ Build Fortuna Faucet Web Service Installer (Synthesized Overkill)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read
  checks: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: pwsh

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9' # üöÄ DOWNGRADE
  DOTNET_VERSION: '8.0.x'
  PYTHONUTF8: '1'
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_PYTHON_VERSION_WARNING: '1'
  NPM_CONFIG_FUND: 'false'
  NPM_CONFIG_AUDIT: 'false'
  FORCE_COLOR: '3'
  FRONTEND_DIR: 'web_platform/frontend'
  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'
  WIX_DIR: 'build_wix'
  SERVICE_PORT: '8102'
  HEALTH_ENDPOINT: '/health'
  API_KEY: ${{ secrets.TEST_API_KEY }}
  TVG_API_KEY: "mock_key"
  GREYHOUND_API_URL: "http://mock"
  FORTUNA_ENV: "smoke-test"
  MSI_STAGING_DIR: 'build_wix/staging'
  MSI_OUTPUT_DIR: 'dist'
  WIX_VERSION: '4.0.5'

jobs:
  system-check:
    name: '‚öôÔ∏è System Prerequisites'
    runs-on: windows-2022
    timeout-minutes: 5
    outputs:
      disk_free_gb: ${{ steps.system.outputs.disk_gb }}
    steps:
      - name: Verify Build Tools
        run: |
          Set-StrictMode -Version Latest
          $tools = @('dotnet', 'python', 'node', 'npm', 'git')
          foreach ($tool in $tools) {
            Write-Host "Checking for $($tool)..."
            Get-Command $tool -ErrorAction SilentlyContinue
            if (-not $?) {
              Write-Host "‚ùå FATAL: Build tool '$tool' not found in PATH." -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ All critical build tools are present." -ForegroundColor Green
      - name: Check Disk Space
        id: system
        run: |
          Set-StrictMode -Version Latest
          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }
          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)
          if ($freeGB -lt 10) {
            Write-Host "‚ö†Ô∏è WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended)." -ForegroundColor Yellow
          } else {
            Write-Host "‚úÖ Disk space check passed ($freeGB GB free)." -ForegroundColor Green
          }
          "disk_gb=$freeGB" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

  repo-preflight:
    name: 'üß™ Repo Preflight & Integrity'
    runs-on: windows-2022
    needs: [system-check]
    timeout-minutes: 5
    outputs:
      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}
      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}
      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive Build Metadata
        id: meta
        run: |
          Set-StrictMode -Version Latest
          $ref = "${{ github.ref }}"
          if ($ref -like 'refs/tags/v*') {
            $semver = $ref -replace 'refs/tags/v', ''
          } else {
            $semver = "0.0.${{ github.run_number }}"
          }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "üîñ Version: $semver ($shortSha)"

      - name: Validate Critical Files Exist
        env:
          BACKEND_DIR: 'web_service/backend'
        run: |
          Set-StrictMode -Version Latest
          $paths = @(
            "${{ env.FRONTEND_DIR }}/package.json",
            "${{ env.FRONTEND_DIR }}/package-lock.json",
            (Join-Path $env:BACKEND_DIR "requirements.txt"),
            (Join-Path $env:BACKEND_DIR "main.py"),
            "${{ env.WIX_DIR }}/Product_WebService.wxs"
          )
          foreach ($path in $paths) {
            if (-not (Test-Path $path)) {
              Write-Host "‚ùå FATAL: Required path missing: $path" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ All critical files confirmed."

      - name: Capture Integrity Hashes
        id: hashes
        env:
          BACKEND_DIR: 'web_service/backend'
        run: |
          Set-StrictMode -Version Latest
          $frontend = (Get-FileHash "${{ env.FRONTEND_DIR }}/package-lock.json" -Algorithm SHA256).Hash
          $backend = (Get-FileHash (Join-Path $env:BACKEND_DIR "requirements.txt") -Algorithm SHA256).Hash
          $wix = (Get-FileHash "${{ env.WIX_DIR }}/Product_WebService.wxs" -Algorithm SHA256).Hash
          "frontend_lock_hash=$frontend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_requirements_hash=$backend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "wix_definition_hash=$wix" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload Integrity Snapshot
        uses: actions/upload-artifact@v4
        with:
          name: repo-preflight-${{ github.run_id }}
          path: |
            ${{ env.FRONTEND_DIR }}/package-lock.json
            web_service/backend/requirements.txt
            ${{ env.WIX_DIR }}/Product_WebService.wxs
          retention-days: 3

  frontend-quality:
    name: 'üßº Frontend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Run Lint (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {
            Write-Host "üßπ Running npm run lint"
            npm run lint
          } else {
            Write-Host "‚ÑπÔ∏è No lint script defined, skipping."
          }

      - name: Run Tests (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {
            Write-Host "üß™ Running npm test -- --watch=false"
            npm test -- --watch=false
          } else {
            Write-Host "‚ÑπÔ∏è No test script defined, skipping."
          }

      - name: Security Audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm audit --audit-level=critical

  backend-quality:
    name: 'üßØ Backend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: repo-preflight
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
      BACKEND_DIR: 'web_service/backend'
      BACKEND_SPEC: 'jules.spec'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel
          pip install uv
          uv pip install --system -r (Join-Path $env:BACKEND_DIR "requirements.txt")
          if (Test-Path (Join-Path $env:BACKEND_DIR "requirements-dev.txt")) {
            uv pip install --system -r (Join-Path $env:BACKEND_DIR "requirements-dev.txt")
          }

      - name: Bytecode Compile (Fail Fast)
        run: |
          Set-StrictMode -Version Latest
          python -m compileall -q "${{ env.BACKEND_DIR }}"

      - name: Run Pytest (if available)
        run: |
          Set-StrictMode -Version Latest
          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec("pytest") else 1)'
          if ($LASTEXITCODE -eq 0) {
            Write-Host "üß™ pytest detected, running suite..."
            python -m pytest "${{ env.BACKEND_DIR }}" --maxfail=1 --disable-warnings
          } else {
            Write-Host "‚ÑπÔ∏è pytest not installed; skipping tests."
          }

      - name: pip-audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          uv pip install pip-audit
          pip-audit -r (Join-Path $env:BACKEND_DIR "requirements.txt")

  sbom:
    name: 'üìÑ SBOM Snapshot'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom.spdx.json
          format: spdx-json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.spdx.json
          retention-days: 7

  build-frontend:
    name: 'üì¶ Build Frontend'
    runs-on: windows-2022
    timeout-minutes: 20
    needs: [repo-preflight, frontend-quality]
    env:
      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}
          restore-keys: |
            ${{ runner.os }}-frontend-build-

      - name: Prime npm Cache
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\npm-cache
          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        env:
          NEXT_PUBLIC_API_URL: http://127.0.0.1:${{ env.SERVICE_PORT }}
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm run build

      - name: Report Cache Status
        run: |
          if ('${{ steps.cache-frontend.outputs.cache-hit }}' -eq 'true') {
            Write-Host "‚úÖ Frontend build restored from cache." -ForegroundColor Green
          } else {
            Write-Host "‚ÑπÔ∏è No cache hit. A new build was performed." -ForegroundColor Yellow
          }

      - name: Verify Build Output
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}"
          if (-not (Test-Path $outDir)) {
             Write-Host "‚ùå FATAL: Build directory not found" -ForegroundColor Red
             exit 1
          }
          $files = Get-ChildItem -Path $outDir -Recurse -File
          if ($files.Count -eq 0) {
             Write-Host "‚ùå FATAL: Build directory empty" -ForegroundColor Red
             exit 1
          }
          Write-Host "‚úÖ Frontend built: $($files.Count) files."

      - name: Generate Artifact Manifest
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_DIR }}/out"
          # Fallback for different env var names in different workflows
          if (-not (Test-Path $outDir)) { $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}" }

          if (-not (Test-Path $outDir)) { Write-Error "‚ùå Build failed: 'out' dir missing"; exit 1 }

          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8

          $files = Get-ChildItem -Path $outDir -Recurse -File
          if ($files.Count -eq 0) { Write-Error "‚ùå Build failed: 'out' dir empty"; exit 1 }

          Write-Host "‚úÖ Frontend built: $($files.Count) files."

          foreach ($f in $files) {
            $rel = $f.FullName.Substring($outDir.Path.Length) -replace '^[\\\/]', ''
            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)
            "$rel`t$($f.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 3

      - name: Upload Manifest
        uses: actions/upload-artifact@v4
        with:
          name: frontend-manifest-${{ github.run_id }}
          path: frontend-manifest.tsv
          retention-days: 3

  build-backend:
    name: 'üêç Build Backend (${{ matrix.arch }})'
    runs-on: windows-2022
    timeout-minutes: 25
    needs: [repo-preflight, build-frontend, backend-quality]
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
      BACKEND_DIR: 'web_service/backend'
      BACKEND_MODULE_PATH: 'web_service.backend'
      BACKEND_SPEC: 'jules.spec'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: temp-frontend
      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ matrix.arch }}-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}
          restore-keys: |
            ${{ runner.os }}-backend-build-${{ matrix.arch }}-
      - name: Stage Frontend for PyInstaller
        run: |
          Set-StrictMode -Version Latest
          $dest = "staging/ui"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path "temp-frontend/*" -Destination $dest -Recurse -Force
          Write-Host "‚úÖ Frontend staged for inclusion."
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $constraintDir = "temp-constraints"
          New-Item -ItemType Directory -Path $constraintDir -Force | Out-Null
          $constraintFile = Join-Path $constraintDir "constraint-${{ matrix.arch }}.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            "numpy==1.23.5`r`npandas==1.5.3`r`nscipy==1.10.1`r`nsqlalchemy==1.4.46`r`ngreenlet==1.1.2`r`n--only-binary=:all:" | Set-Content $constraintFile
          } else {
            New-Item $constraintFile -ItemType File -Force
          }
          "file=$constraintFile" | Out-File $env:GITHUB_OUTPUT -Append

      - name: CACHE-PYI Cache PyInstaller Build
        id: cache-pyi-build
        uses: actions/cache@v4
        with:
          path: dist/fortuna-core-service
          key: ${{ runner.os }}-${{ matrix.arch }}-pyi-${{ hashFiles('web_service/backend/**/*.py', 'scripts/generate_spec_dual.py', 'web_service/backend/requirements*.txt') }}
      - name: Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install uv

          Write-Host "[BUILD] Installing x86-constrained packages first..."
          uv pip install --system --only-binary=:all: `
            "sqlalchemy==1.4.46" `
            "greenlet==1.1.2" `
            "pandas==1.5.3" `
            "numpy==1.23.5" `
            "scipy==1.10.1"

          if ($LASTEXITCODE -ne 0) {
            throw "[BUILD] ‚ùå Failed to install x86-constrained packages"
          }

          Write-Host "[BUILD] Installing remaining dependencies..."
          uv pip install --system -r (Join-Path $env:BACKEND_DIR "requirements.txt") --no-deps

          if ($LASTEXITCODE -ne 0) {
            throw "[BUILD] ‚ùå Failed to install remaining requirements"
          }

          Write-Host "[BUILD] Verifying all dependencies are satisfied..."
          pip check

          Write-Host "[BUILD] Installing PyInstaller and PyWin32..."
          uv pip install --system pyinstaller pywin32

          Write-Host "[BUILD] ‚úÖ All dependencies installed successfully"

      - name: Verify x86 package versions
        if: matrix.arch == 'x86'
        shell: pwsh
        run: |
          Write-Host "[BUILD] Verifying x86-constrained packages..."

          # CRITICAL: These must match the versions installed in the previous step
          $expectedVersions = @{
            'sqlalchemy' = '1.4.46'  # ‚úÖ FIXED: Match installed version
            'greenlet' = '1.1.2'     # ‚úÖ FIXED: Match installed version
            'pandas' = '1.5.3'
            'numpy' = '1.23.5'
            'scipy' = '1.10.1'
          }

          $allVerified = $true

          foreach ($pkg in $expectedVersions.Keys) {
            $expectedVersion = $expectedVersions[$pkg]

            # Get installed version
            $installedVersion = pip show $pkg 2>&1 | Select-String "Version:" | ForEach-Object { $_.Line -replace 'Version: ', '' }

            if (-not $installedVersion) {
              Write-Error "‚ùå Package '$pkg' not installed!"
              $allVerified = $false
              continue
            }

            # Trim whitespace for comparison
            $installedVersion = $installedVersion.Trim()
            $expectedVersion = $expectedVersion.Trim()

            if ($installedVersion -ne $expectedVersion) {
              Write-Error "‚ùå Package '$pkg' has wrong version: $installedVersion (expected $expectedVersion)"
              $allVerified = $false
            } else {
              Write-Host "‚úÖ $pkg==$installedVersion"
            }
          }

          if (-not $allVerified) {
            throw "[BUILD] ‚ùå x86 package verification failed"
          }

          Write-Host "[BUILD] ‚úÖ All x86 packages verified"

      - name: üî¨ Diagnostic - Verify wheel installation method
        if: matrix.arch == 'x86'
        shell: pwsh
        run: |
          Write-Host "[DIAGNOSTIC] Checking installation metadata for x86 packages..."

          $packages = @('sqlalchemy', 'greenlet')

          foreach ($pkg in $packages) {
            $location = pip show $pkg 2>&1 | Select-String "Location:" | ForEach-Object { $_.Line -replace 'Location: ', '' }

            if ($location) {
              $location = $location.Trim()
              Write-Host "Package: $pkg"
              Write-Host "  Location: $location"

              # Find the .dist-info directory
              $distInfo = Get-ChildItem -Path $location -Directory -Filter "${pkg}*.dist-info" -ErrorAction SilentlyContinue | Select-Object -First 1

              if ($distInfo) {
                Write-Host "  .dist-info: $($distInfo.Name)"

                # Check for WHEEL file (proves it was a wheel installation)
                $wheelFile = Join-Path $distInfo.FullName "WHEEL"
                if (Test-Path $wheelFile) {
                  $wheelContent = Get-Content $wheelFile -Raw
                  Write-Host "  ‚úÖ Installed from wheel (WHEEL file exists)"

                  # Extract wheel tag
                  if ($wheelContent -match "Tag: ([^\r\n]+)") {
                    Write-Host "  Wheel tag: $($Matches[1])"
                  }
                } else {
                  Write-Warning "  ‚ö†Ô∏è  No WHEEL file found - might be source install"
                }

                # Check for INSTALLER file
                $installerFile = Join-Path $distInfo.FullName "INSTALLER"
                if (Test-Path $installerFile) {
                  $installer = Get-Content $installerFile -Raw
                  Write-Host "  Installer: $installer"
                }
              } else {
                Write-Warning "  ‚ö†Ô∏è  No .dist-info directory found for $pkg"
              }

              Write-Host ""
            }
          }

      - name: Generate SBOM (Software Bill of Materials)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          artifact-name: sbom-${{ github.job }}-${{ github.sha }}

      - name: üîê pip-audit
        continue-on-error: true
        run: |
          uv pip install --system pip-audit
          pip-audit -r (Join-Path $env:BACKEND_DIR "requirements.txt")
      - name: Build with PyInstaller
        if: steps.cache-pyi-build.outputs.cache-hit != 'true'
        env:
          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}
        run: |
          pyinstaller --noconfirm --clean --log-level INFO fortuna-unified.spec
      - name: üîç Sanity Check Executable
        shell: pwsh
        run: |
          dist/fortuna-core-service/fortuna-core-service.exe --help
      - name: Verify Executable
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-core-service.exe"
          if (-not (Test-Path $exePath)) { throw "‚ùå FATAL: Executable not found" }
          $size = (Get-Item $exePath).Length / 1MB
          if ($size -lt 10) { throw "‚ùå FATAL: Executable is suspiciously small: $($size) MB." }
          Write-Host "‚úÖ Backend ready: $([math]::Round($size, 2)) MB"

      - name: üå≥ Tree Command for Debugging
        run: |
          tree /F dist
      - name: Upload Backend Executable
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/fortuna-core-service.exe
          retention-days: 3

  diagnose-asgi-imports:
    name: 'üîç ASGI Import Killer Pre-Smoke Diagnostic'
    runs-on: windows-2022
    timeout-minutes: 15
    needs: [build-backend]
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: 'Run ASGI Diagnostics'
        uses: ./.github/actions/run-asgi-diagnostics
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          backend-dir: 'web_service/backend'
          backend-module-path: 'web_service.backend'
  diagnose-runtime:
    name: 'üîé Diagnose PyInstaller Runtime'
    runs-on: windows-2022
    timeout-minutes: 10
    needs: [build-backend]
    continue-on-error: true
    strategy:
      matrix:
        arch: [x64, x86]
    env:
      BACKEND_MODULE_PATH: 'web_service.backend'
    steps:
      - name: üì• Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ matrix.arch }}-${{ github.run_id }}
          path: dist
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
      - name: üì¶ Install PyInstaller
        run: uv pip install pyinstaller==6.6.0
      - name: üïµÔ∏è Extract and Analyze Executable Contents
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-backend.exe"
          Write-Host "--- Executable Analysis ---"
          $archiveContents = pyi-archive_viewer $exePath
          if ($LASTEXITCODE -ne 0) { throw "Failed to analyze executable." }
          Write-Host "--- Archive Contents ---"
          $archiveContents | Out-Host
          $expectedInitFile = ($env:BACKEND_MODULE_PATH.Replace('.', '/') + '/__init__.py')
          $found = $archiveContents | ForEach-Object { $_.Replace('\', '/') } | Select-String -Pattern $expectedInitFile -SimpleMatch -Quiet
          if ($found) {
            Write-Host "‚úÖ SUCCESS: Key module file found." -ForegroundColor Green
          } else {
            Write-Error "‚ùå FAILURE: Key module file '$expectedInitFile' NOT found."
            exit 1
          }
  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-2022
    timeout-minutes: 20
    needs: [build-backend, package-msi-service]
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: üì• Download MSI Installer
        uses: actions/download-artifact@v4
        with:
          name: fortuna-service-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: msi-installer
      - name: '‚úÖ Create Required Runtime Directories & Start Service'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"

          # Determine install path based on architecture
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet Service"

          if (-not (Test-Path $installDir)) {
            throw "‚ùå Installation directory not found at $installDir"
          }

          # CRITICAL: Create runtime directories that service needs
          $dirs = @('data', 'json', 'logs')
          foreach ($dir in $dirs) {
            $fullPath = Join-Path $installDir $dir
            New-Item -ItemType Directory -Path $fullPath -Force | Out-Null
            # Grant LocalSystem (the service account) full control
            icacls $fullPath /grant "NT AUTHORITY\SYSTEM:(OI)(CI)F" /T 2>&1 | Out-Null
          }
          Write-Host "‚úÖ Created runtime directories with proper permissions"

          # CRITICAL: Explicitly start the service (WiX removed auto-start)
          Write-Host "Starting FortunaWebService..."
          Start-Service -Name "FortunaWebService" -ErrorAction Stop
          Start-Sleep -Seconds 10

          # Verify service is running
          $svc = Get-Service -Name "FortunaWebService"
          if ($svc.Status -ne 'Running') {
            throw "‚ùå Service failed to start. Status: $($svc.Status)"
          }
          Write-Host "‚úÖ Service started successfully"
      - name: ü©∫ Health Check
        shell: pwsh
        run: |
          $maxRetries = 5
          $delay = 5
          For ($i=0; $i -lt $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:${{ env.SERVICE_PORT }}/health" -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check PASSED."
                Stop-Service -Name "FortunaWebService"
                exit 0
              }
            } catch { Write-Host "Attempt $($i+1) failed. Retrying..." }
            Start-Sleep -Seconds $delay
          }
          throw "Health check failed."


  package-msi-service:
    name: 'üíø Package Service MSI (${{ matrix.arch }})'
    runs-on: windows-2022
    timeout-minutes: 25
    needs: [repo-preflight, build-backend]
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    env:
      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Download Backend
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ matrix.arch }}-${{ github.run_id }}
          path: dist
      - name: Stage Artifacts
        id: stage
        run: |
          Set-StrictMode -Version Latest
          $staging = "${{ env.MSI_STAGING_DIR }}"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Move-Item -Path "dist/fortuna-core-service.exe" -Destination "$staging/fortuna-webservice.exe" -Force
          $msiName = "Fortuna-WebService-${{ matrix.arch }}-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi".Replace('/', '-')
          "msi_name=$msiName" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "‚úÖ Staged for MSI: $msiName"
      - name: Create Restart Service Batch Script
        shell: pwsh
        run: |
          $scriptContent = "@echo off`r`necho Requesting Admin privileges to restart FortunaWebService...`r`nnet stop FortunaWebService`r`nnet start FortunaWebService`r`necho Service Restarted.`r`npause"
          Set-Content -Path "${{ env.MSI_STAGING_DIR }}/restart_service.bat" -Value $scriptContent -Encoding Ascii
          Write-Host "‚úÖ Created restart_service.bat script."
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}
      - name: üìÑ Ensure WiX License Exists
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          $licensePath = 'build_wix/license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder...'
            $rtfContent = '{\rtf1\ansi\deff0{\fonttbl{\f0 Arial;}}\f0\fs24 END USER LICENSE AGREEMENT\par\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: Prepare WiX Project
        run: |
          Set-StrictMode -Version Latest
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <Version Condition="''$(Version)'' == ''''">0.0.1</Version>',
            '    <ServicePort Condition="''$(ServicePort)'' == ''''">8102</ServicePort>',
            '    <SourceDir Condition="''$(SourceDir)'' == ''''">staging/backend</SourceDir>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64;x86</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort);Platform=$(Platform)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product_WebService.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content "${{ env.WIX_DIR }}/Fortuna.wixproj" -Value ($proj -join "`r`n") -Encoding utf8
      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        run: |
          Set-StrictMode -Version Latest
          dotnet build Fortuna.wixproj -c Release `
            -p:Platform=${{ matrix.arch }} `
            -p:SourceDir="../${{ env.MSI_STAGING_DIR }}" `
            -p:Version="${{ env.BUILD_VERSION }}" `
            -p:ServicePort="${{ env.SERVICE_PORT }}"
          $releaseDir = "bin/${{ matrix.arch }}/Release"
          $defaultOutput = "$releaseDir/Fortuna.msi"
          $targetName = "${{ steps.stage.outputs.msi_name }}"
          $targetPath = "$releaseDir/$targetName"
          if (Test-Path $defaultOutput) {
            Move-Item -Path $defaultOutput -Destination $targetPath -Force
            Write-Host "‚úÖ Renamed MSI to $targetName"
          } else { throw "‚ùå Build failed: $defaultOutput not found" }
      - name: Upload MSI + Hash
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-service-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: ${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release/*
          retention-days: 10

  create-release:
    name: 'üöÄ Create Release'
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: package-msi-service
    permissions:
      contents: write
    steps:
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          pattern: fortuna-service-msi-*
          merge-multiple: true
          path: assets

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: assets

      - name: Generate Checksums
        run: |
          cd assets
          ls *.msi
          sha256sum *.msi > SHASUMS256.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            assets/*.msi
            assets/*.sha256
            assets/SHASUMS256.txt
            assets/sbom.spdx.json
          generate_release_notes: true

  stage-release-artifacts:
    name: 'üì¶ Stage Release Artifacts'
    runs-on: windows-2022
    timeout-minutes: 5
    needs: [package-msi-service, repo-preflight]
    steps:
      - name: üì• Download MSI Installer
        uses: actions/download-artifact@v4
        with:
          name: fortuna-service-msi-${{ github.run_id }}
          path: msi-installer
      - name: üöö Stage Final Artifact
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $sourceDir = "msi-installer"
          $destDir = "final-release-artifact"
          New-Item -ItemType Directory -Path $destDir -Force | Out-Null

          robocopy $sourceDir $destDir /E

          if ($LASTEXITCODE -ge 8) {
            Write-Error "Robocopy failed with exit code $LASTEXITCODE. This indicates a serious error."
            exit 1
          }

          Write-Host "‚úÖ Robocopy completed successfully."
          Get-ChildItem -Path $destDir | Write-Host
          exit 0

      - name: üì§ Upload Final MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Final-MSI-Artifact
          path: final-release-artifact/
          retention-days: 90
