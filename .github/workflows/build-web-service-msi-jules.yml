# System Timestamp: 2025-12-04 16:01:12.318079
name: Build Fortuna Faucet Web Service Installer (Synthesized Overkill)

on:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read
  checks: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: pwsh

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  DOTNET_VERSION: '8.0.x'
  PYTHONUTF8: '1'
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_PYTHON_VERSION_WARNING: '1'
  NPM_CONFIG_FUND: 'false'
  NPM_CONFIG_AUDIT: 'false'
  FORCE_COLOR: '3'
  FRONTEND_DIR: 'web_platform/frontend'
  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'
  WIX_DIR: 'build_wix'
  SERVICE_PORT: '8102'
  HEALTH_ENDPOINT: '/health'
  API_KEY: ${{ secrets.TEST_API_KEY }}
  MSI_STAGING_DIR: 'build_wix/staging'
  MSI_OUTPUT_DIR: 'dist'
  WIX_VERSION: '4.0.5'

jobs:
  path-finder:
    name: 'ðŸ”Ž Path Finder Dynamic Backend Detection'
    runs-on: windows-latest
    outputs:
      backend_dir: ${{ steps.find-path.outputs.backend_dir }}
      backend_module_path: ${{ steps.find-path.outputs.backend_module_path }}
      spec_file: ${{ steps.find-path.outputs.spec_file }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect Backend Path
        id: find-path
        run: |
          Set-StrictMode -Version Latest
          $web_service_path = "web_service/backend"
          $python_service_path = "python_service"
          $backend_dir = ""
          $backend_module_path = ""
          $spec_file = ""

          Write-Host "--- Path Finding Forensics ---"
          Write-Host "Searching for the correct backend service directory..."

          # Test web_service path
          $web_service_main = Test-Path (Join-Path $web_service_path "main.py")
          $web_service_api = Test-Path (Join-Path $web_service_path "api.py")
          $web_service_init = Test-Path (Join-Path $web_service_path "__init__.py")
          Write-Host "Checking '$web_service_path':"
          Write-Host "  main.py -> $web_service_main"
          Write-Host "  api.py -> $web_service_api"
          Write-Host "  __init__.py -> $web_service_init"

          # Test python_service path
          $python_service_main = Test-Path (Join-Path $python_service_path "main.py")
          $python_service_api = Test-Path (Join-Path $python_service_path "api.py")
          $python_service_init = Test-Path (Join-Path $python_service_path "__init__.py")
          Write-Host "Checking '$python_service_path':"
          Write-Host "  main.py -> $python_service_main"
          Write-Host "  api.py -> $python_service_api"
          Write-Host "  __init__.py -> $python_service_init"

          if ($web_service_main -and $web_service_api -and $web_service_init) {
            $backend_dir = $web_service_path
            $backend_module_path = "web_service.backend"
            $spec_file = "webservice.spec"
            Write-Host "âœ… Verdict: Detected 'web_service/backend' as the target." -ForegroundColor Green
          } elseif ($python_service_main -and $python_service_api -and $python_service_init) {
            $backend_dir = $python_service_path
            $backend_module_path = "python_service"
            $spec_file = "fortuna-backend-webservice.spec"
            Write-Host "âœ… Verdict: Detected 'python_service' as the target." -ForegroundColor Green
          } else {
            Write-Host "âŒ FATAL: Could not determine a valid backend directory. Neither 'web_service/backend' nor 'python_service' contains the required files (main.py, api.py, __init__.py)." -ForegroundColor Red
            exit 1
          }

          Write-Host "--- Outputs ---"
          Write-Host "backend_dir: $backend_dir"
          Write-Host "backend_module_path: $backend_module_path"
          Write-Host "spec_file: $spec_file"

          "backend_dir=$backend_dir" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_module_path=$backend_module_path" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "spec_file=$spec_file" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
  system-check:
    name: 'âš™ï¸ System Prerequisites'
    runs-on: windows-latest
    timeout-minutes: 5
    outputs:
      disk_free_gb: ${{ steps.system.outputs.disk_gb }}
    steps:
      - name: Verify Build Tools
        run: |
          Set-StrictMode -Version Latest
          $tools = @('dotnet', 'python', 'node', 'npm', 'git')
          foreach ($tool in $tools) {
            Write-Host "Checking for $($tool)..."
            Get-Command $tool -ErrorAction SilentlyContinue
            if (-not $?) {
              Write-Host "âŒ FATAL: Build tool '$tool' not found in PATH." -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "âœ… All critical build tools are present." -ForegroundColor Green
      - name: Check Disk Space
        id: system
        run: |
          Set-StrictMode -Version Latest
          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }
          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)
          if ($freeGB -lt 10) {
            Write-Host "âš ï¸ WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended)." -ForegroundColor Yellow
          } else {
            Write-Host "âœ… Disk space check passed ($freeGB GB free)." -ForegroundColor Green
          }
          "disk_gb=$freeGB" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

  repo-preflight:
    name: 'ðŸ§ª Repo Preflight & Integrity'
    runs-on: windows-latest
    needs: [path-finder, system-check]
    timeout-minutes: 5
    outputs:
      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}
      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}
      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive Build Metadata
        id: meta
        run: |
          Set-StrictMode -Version Latest
          $ref = "${{ github.ref }}"
          if ($ref -like 'refs/tags/v*') {
            $semver = $ref -replace 'refs/tags/v', ''
          } else {
            $semver = "0.0.${{ github.run_number }}"
          }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ðŸ”– Version: $semver ($shortSha)"

      - name: Validate Critical Files Exist
        env:
          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}
        run: |
          Set-StrictMode -Version Latest
          $paths = @(
            "${{ env.FRONTEND_DIR }}/package.json",
            "${{ env.FRONTEND_DIR }}/package-lock.json",
            (Join-Path $env:BACKEND_DIR "requirements.txt"),
            (Join-Path $env:BACKEND_DIR "main.py"),
            "${{ env.WIX_DIR }}/Product_WithService.wxs"
          )
          foreach ($path in $paths) {
            if (-not (Test-Path $path)) {
              Write-Host "âŒ FATAL: Required path missing: $path" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "âœ… All critical files confirmed."

      - name: Capture Integrity Hashes
        id: hashes
        env:
          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}
        run: |
          Set-StrictMode -Version Latest
          $frontend = (Get-FileHash "${{ env.FRONTEND_DIR }}/package-lock.json" -Algorithm SHA256).Hash
          $backend = (Get-FileHash (Join-Path $env:BACKEND_DIR "requirements.txt") -Algorithm SHA256).Hash
          $wix = (Get-FileHash "${{ env.WIX_DIR }}/Product_WithService.wxs" -Algorithm SHA256).Hash
          "frontend_lock_hash=$frontend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_requirements_hash=$backend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "wix_definition_hash=$wix" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload Integrity Snapshot
        uses: actions/upload-artifact@v4
        with:
          name: repo-preflight-${{ github.run_id }}
          path: |
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.WIX_DIR }}/Product_WithService.wxs
          retention-days: 3

  frontend-quality:
    name: 'ðŸ§¼ Frontend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Run Lint (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {
            Write-Host "ðŸ§¹ Running npm run lint"
            npm run lint
          } else {
            Write-Host "â„¹ï¸ No lint script defined, skipping."
          }

      - name: Run Tests (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {
            Write-Host "ðŸ§ª Running npm test -- --watch=false"
            npm test -- --watch=false
          } else {
            Write-Host "â„¹ï¸ No test script defined, skipping."
          }

      - name: Security Audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm audit --audit-level=critical

  backend-quality:
    name: 'ðŸ§¯ Backend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [path-finder, repo-preflight]
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}
      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel
          pip install -r (Join-Path $env:BACKEND_DIR "requirements.txt")
          if (Test-Path (Join-Path $env:BACKEND_DIR "requirements-dev.txt")) {
            pip install -r (Join-Path $env:BACKEND_DIR "requirements-dev.txt")
          } else {
            Write-Host "â„¹ï¸ requirements-dev.txt not found, skipping."
          }

      - name: Bytecode Compile (Fail Fast)
        run: |
          Set-StrictMode -Version Latest
          python -m compileall -q "${{ env.BACKEND_DIR }}"

      - name: Run Pytest (if available)
        run: |
          Set-StrictMode -Version Latest
          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec("pytest") else 1)'
          if ($LASTEXITCODE -eq 0) {
            Write-Host "ðŸ§ª pytest detected, running suite..."
            python -m pytest "${{ env.BACKEND_DIR }}" --maxfail=1 --disable-warnings
          } else {
            Write-Host "â„¹ï¸ pytest not installed; skipping tests."
          }

      - name: pip-audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          pip install pip-audit
          pip-audit -r (Join-Path $env:BACKEND_DIR "requirements.txt")

  sbom:
    name: 'ðŸ“„ SBOM Snapshot'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom.spdx.json
          format: spdx-json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.spdx.json
          retention-days: 7

  build-frontend:
    name: 'ðŸ“¦ Build Frontend'
    runs-on: windows-latest
    timeout-minutes: 20
    needs: [path-finder, repo-preflight, frontend-quality]
    env:
      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}
          restore-keys: |
            ${{ runner.os }}-frontend-build-

      - name: Prime npm Cache
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\npm-cache
          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        env:
          NEXT_PUBLIC_API_URL: http://127.0.0.1:${{ env.SERVICE_PORT }}
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm run build

      - name: Report Cache Status
        run: |
          if ('${{ steps.cache-frontend.outputs.cache-hit }}' -eq 'true') {
            Write-Host "âœ… Frontend build restored from cache." -ForegroundColor Green
          } else {
            Write-Host "â„¹ï¸ No cache hit. A new build was performed." -ForegroundColor Yellow
          }

      - name: Verify Build Output
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}"
          if (-not (Test-Path $outDir)) {
             Write-Host "âŒ FATAL: Build directory not found" -ForegroundColor Red
             exit 1
          }
          $files = Get-ChildItem -Path $outDir -Recurse -File
          if ($files.Count -eq 0) {
             Write-Host "âŒ FATAL: Build directory empty" -ForegroundColor Red
             exit 1
          }
          Write-Host "âœ… Frontend built: $($files.Count) files."

      - name: Generate Artifact Manifest
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}"
          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8
          Get-ChildItem -Path $outDir -Recurse -File | ForEach-Object {
            $relative = $_.FullName.Substring($outDir.Path.Length).TrimStart('\','/')
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$relative`t$($_.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 3

      - name: Upload Manifest
        uses: actions/upload-artifact@v4
        with:
          name: frontend-manifest-${{ github.run_id }}
          path: frontend-manifest.tsv
          retention-days: 3

  build-backend:
    name: 'ðŸ Build Backend'
    runs-on: windows-latest
    timeout-minutes: 25
    needs: [path-finder, repo-preflight, build-frontend, backend-quality]
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}
      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}
      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: temp-frontend

      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}
          restore-keys: |
            ${{ runner.os }}-backend-build-

      - name: Stage Frontend for PyInstaller
        run: |
          Set-StrictMode -Version Latest
          $dest = "staging/ui"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path "temp-frontend/*" -Destination $dest -Recurse -Force
          Write-Host "âœ… Frontend staged for inclusion."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel
          pip install -r (Join-Path $env:BACKEND_DIR "requirements.txt")
          if (Test-Path (Join-Path $env:BACKEND_DIR "requirements-dev.txt")) {
            pip install -r (Join-Path $env:BACKEND_DIR "requirements-dev.txt")
          }

      - name: Freeze Dependency Snapshot
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          Set-StrictMode -Version Latest
          pip freeze | Out-File backend-freeze.txt -Encoding utf8

      - name: Create Dynamic webservice.spec for PyInstaller
        if: steps.cache-backend.outputs.cache-hit != 'true'
        shell: python
        env:
          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}
          BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}
          BACKEND_SPEC_FILE: ${{ needs.path-finder.outputs.spec_file }}
        run: |
          import os
          from pathlib import Path

          # Create __init__.py files in-memory to avoid filesystem race conditions
          init_content = "# This file is intentionally non-empty to ensure package recognition."

          # Ensure parent directories exist before writing files
          Path("web_service").mkdir(exist_ok=True)
          Path("web_service/backend").mkdir(exist_ok=True)

          with open("web_service/__init__.py", "w") as f:
              f.write(init_content)
          with open("web_service/backend/__init__.py", "w") as f:
              f.write(init_content)

          print("âœ… Ensured non-empty __init__.py files exist for package discovery.")

          entry_point = os.path.join(os.environ['BACKEND_DIR'], "main.py").replace('\\', '/')
          staging_ui_path = Path("staging/ui").resolve().as_posix()
          other_service = "python_service" if "web_service" in os.environ['BACKEND_DIR'] else "web_service"
          backend_init = Path("web_service/backend/__init__.py").resolve().as_posix()
          parent_init = Path("web_service/__init__.py").resolve().as_posix()
          spec_file = os.environ['BACKEND_SPEC_FILE']

          spec_content = f"""
          # -*- mode: python ; coding: utf-8 -*-
          import os
          from pathlib import Path
          from PyInstaller.utils.hooks import collect_data_files, collect_submodules

          block_cipher = None
          project_root = Path(os.getcwd())

          # Standard Data Collection
          datas = [
              ('{staging_ui_path}', 'ui'),
          ]
          datas += collect_data_files('uvicorn')
          datas += collect_data_files('slowapi')
          datas += collect_data_files('structlog')

          hiddenimports = collect_submodules('{os.environ["BACKEND_MODULE_PATH"]}')
          hiddenimports += [
              'uvicorn.logging', 'uvicorn.loops.auto', 'uvicorn.lifespan.on',
              'uvicorn.protocols.http.h11_impl', 'uvicorn.protocols.websockets.wsproto_impl',
              'fastapi.routing', 'starlette.staticfiles', 'anyio._backends._asyncio',
              'httpcore', 'httpx', 'slowapi', 'structlog', 'tenacity', 'aiosqlite',
              'pydantic_core', 'pydantic_settings.sources'
          ]

          a = Analysis(
              ['{entry_point}'],
              pathex=[str(project_root)],
              binaries=[],
              datas=datas,
              hiddenimports=hiddenimports,
              hookspath=[],
              runtime_hooks=[],
              excludes=['tests', 'pytest', '{other_service}'],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False
          )

          # â˜¢ï¸ NUCLEAR OVERRIDE: Force __init__ files into the PYZ archive
          # This puts them in the importable namespace, not just on the filesystem.
          a.pure += [
              ('web_service', '{parent_init}', 'PYMODULE'),
              ('web_service.backend', '{backend_init}', 'PYMODULE')
          ]

          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
          exe = EXE(
              pyz,
              a.scripts,
              a.binaries,
              a.zipfiles,
              a.datas,
              [],
              name='fortuna-backend',
              debug=False,
              bootloader_ignore_signals=False,
              strip=False,
              upx=True,
              console=False,
          )
          """
          with open(spec_file, "w") as f:
              f.write(spec_content)

          print(f"âœ… Dynamically generated '{spec_file}' with PYZ Injection.")

      - name: Create Required Backend Directories
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          Set-StrictMode -Version Latest
          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR "data") -Force | Out-Null
          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR "json") -Force | Out-Null
          Write-Host "âœ… Created required backend directories for PyInstaller." -ForegroundColor Green

      - name: Build with PyInstaller
        if: steps.cache-backend.outputs.cache-hit != 'true'
        env:
          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}
        run: |
          Set-StrictMode -Version Latest
          pyinstaller "${{ env.BACKEND_SPEC }}" --clean --log-level=WARN --noconfirm

      - name: Report Cache Status
        run: |
          if ('${{ steps.cache-backend.outputs.cache-hit }}' -eq 'true') {
            Write-Host "âœ… Backend build restored from cache." -ForegroundColor Green
          } else {
            Write-Host "â„¹ï¸ No cache hit. A new build was performed." -ForegroundColor Yellow
          }

      - name: Verify Executable
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-backend.exe"
          if (-not (Test-Path $exePath)) {
            Write-Host "âŒ FATAL: Executable not found" -ForegroundColor Red
            exit 1
          }
          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash
          $size = (Get-Item $exePath).Length / 1MB
          if ($size -lt 10) {
            Write-Host "âŒ FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete." -ForegroundColor Red
            exit 1
          }
          "fortuna-backend.exe`t$hash" | Out-File backend-sha256.tsv -Encoding utf8
          Write-Host "âœ… Backend ready: $([math]::Round($size, 2)) MB ($hash)"

      - name: Upload Backend Executable
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist/fortuna-backend.exe
          retention-days: 3

      - name: Upload Backend Metadata
        uses: actions/upload-artifact@v4
        with:
          name: backend-metadata-${{ github.run_id }}
          path: |
            backend-sha256.tsv
            backend-freeze.txt
          retention-days: 7

  diagnose-asgi-imports:
    name: 'ðŸ” ASGI Import Killer Pre-Smoke Diagnostic'
    runs-on: windows-latest
    timeout-minutes: 15
    needs: [path-finder, build-backend]
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: 'Run ASGI Diagnostics'
        uses: ./.github/actions/run-asgi-diagnostics
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          backend-dir: ${{ needs.path-finder.outputs.backend_dir }}
          backend-module-path: ${{ needs.path-finder.outputs.backend_module_path }}

  diagnose-runtime:
    name: 'ðŸ”Ž Diagnose PyInstaller Runtime'
    runs-on: windows-latest
    timeout-minutes: 10
    needs: [path-finder, build-backend]
    continue-on-error: true
    env:
      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}
    steps:
      - name: ðŸ“¥ Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install PyInstaller
        run: pip install pyinstaller==6.6.0

      - name: ðŸ•µï¸ Extract and Analyze Executable Contents
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-backend.exe"

          Write-Host "--- Executable Analysis ---"
          Write-Host "Analyzing contents of $exePath with pyi-archive_viewer..."

          $archiveContents = pyi-archive_viewer $exePath
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to analyze executable with pyi-archive_viewer."
            exit 1
          }

          Write-Host "\n--- Archive Contents ---"
          $archiveContents | Out-Host

          # FIX: Normalize slashes for comparison
          $expectedInitFile = ($env:BACKEND_MODULE_PATH.Replace('.', '/') + '/__init__.py')

          # Check for the file, replacing backslashes with forward slashes in the output
          $found = $archiveContents | ForEach-Object { $_.Replace('\', '/') } | Select-String -Pattern $expectedInitFile -SimpleMatch -Quiet

          if ($found) {
            Write-Host "âœ… SUCCESS: Key module file found inside the executable archive." -ForegroundColor Green
          } else {
            Write-Error "âŒ FAILURE: Key module file '$expectedInitFile' NOT found inside the executable."
            exit 1
          }

      - name: ðŸ“¤ Upload Extracted Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extracted-executable-${{ github.run_id }}
          path: extracted_exe/
          retention-days: 7

  smoke-test:
    name: 'ðŸ”¬ Smoke Test (Triple-Loop Synthesis)'
    runs-on: windows-latest
    timeout-minutes: 20
    needs:
      - build-backend
      - package-msi-service # Run after packaging is complete
    steps:
      - name: ðŸ“¥ Download MSI Installer
        uses: actions/download-artifact@v4
        with:
          name: fortuna-service-msi-${{ github.run_id }}
          path: msi-installer

      - name: ðŸ•µï¸ Find MSI Installer
        id: find_msi
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) {
            Write-Error "âŒ No MSI found in the artifact!"
            Get-ChildItem -Path "msi-installer" -Recurse | Write-Host
            exit 1
          }
          Write-Host "âœ… Found MSI: $($msi.FullName)"
          "msi_path=$($msi.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: ðŸ›¡ï¸ Grant Full Control to SYSTEM for Temp Directory
        shell: pwsh
        run: |
          $tempPath = $env:TEMP
          Write-Host "Granting SYSTEM FullControl on $tempPath"
          icacls $tempPath /grant "NT AUTHORITY\SYSTEM:(OI)(CI)F" /T
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "icacls command failed, but continuing..."
          } else {
            Write-Host "âœ… Privileges granted successfully."
          }

      - name: 'ðŸš€ LOOP 1 - Install & Verify Service Registration'
        shell: pwsh
        run: |
          $msiPath = "${{ steps.find_msi.outputs.msi_path }}"
          Write-Host "Starting installation of $msiPath..."

          $proc = Start-Process msiexec.exe -ArgumentList "/i `"$msiPath`" /qn /L*v msi-install.log" -Wait -PassThru

          # Allow exit code 3010 (reboot required)
          if ($proc.ExitCode -ne 0 -and $proc.ExitCode -ne 3010) {
            Write-Error "âŒ MSI installation failed with exit code $($proc.ExitCode)."
            Get-Content msi-install.log -Tail 50 | Write-Host
            exit 1
          }

          Write-Host "âœ… Installation completed (Exit Code: $($proc.ExitCode)). Verifying service registration..."

          $service = Get-Service -Name "FortunaFaucetService" -ErrorAction SilentlyContinue
          if (-not $service) {
            Write-Error "âŒ FATAL: Service 'FortunaFaucetService' was not registered."
            exit 1
          }

          Write-Host "âœ… Service is registered. State: $($service.Status)"

      - name: 'ðŸš¦ LOOP 2 - Start Service & Verify Process'
        shell: pwsh
        run: |
          Write-Host "Attempting to start the 'FortunaFaucetService'..."
          Start-Service -Name "FortunaFaucetService"

          Write-Host "Waiting for process to appear (up to 30 seconds)..."
          $deadline = (Get-Date).AddSeconds(30)
          $processFound = $false

          while ((Get-Date) -lt $deadline) {
            $proc = Get-Process -Name "fortuna-webservice" -ErrorAction SilentlyContinue
            if ($proc) {
              Write-Host "âœ… Process 'fortuna-webservice.exe' is running (PID: $($proc.Id))."
              $processFound = $true
              break
            }
            Start-Sleep -Seconds 1
          }

          if (-not $processFound) {
            Write-Error "âŒ FATAL: Process did not start after 30 seconds."
            Get-EventLog -LogName Application -Source "FortunaFaucetService" -Newest 10 | Format-List
            exit 1
          }

      - name: 'ðŸ©º LOOP 3 - Health Check Endpoint'
        shell: pwsh
        run: |
          Write-Host "Starting health checks against http://localhost:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }} (up to 60 seconds)..."
          $deadline = (Get-Date).AddSeconds(60)
          $healthCheckPassed = $false

          while ((Get-Date) -lt $deadline) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Health check PASSED with status 200."
                $healthCheckPassed = $true
                break
              }
            } catch {
              # This will catch connection refused, timeouts, etc.
              Write-Host "  ... waiting for service to be ready."
            }
            Start-Sleep -Seconds 2
          }

          if (-not $healthCheckPassed) {
            Write-Error "âŒ FATAL: Health check endpoint did not return 200 within the time limit."
            exit 1
          }

      - name: ðŸ“Š Capture Diagnostics on Failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "=== Capturing Failure Diagnostics ==="
          Get-Content msi-install.log | Out-File diagnostic-install-log.txt
          Get-EventLog -LogName Application -Source "FortunaFaucetService" -Newest 20 | Format-List | Out-File diagnostic-eventlog.txt
          Get-Service -Name "FortunaFaucetService" | Format-List | Out-File diagnostic-service-state.txt
          Get-Process -Name "fortuna-webservice" -ErrorAction SilentlyContinue | Format-List | Out-File diagnostic-process-state.txt
          netstat -anob > diagnostic-netstat.txt
          Write-Host "âœ… Diagnostics captured."

      - name: ðŸ“¤ Upload Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: jules-smoke-test-failure-${{ github.run_id }}
          path: diagnostic-*.txt
          retention-days: 30

      - name: ðŸ§¹ Cleanup
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up..."
          Stop-Service -Name "FortunaFaucetService" -Force -ErrorAction SilentlyContinue
          # Uninstall may not always work, especially if the service is stuck, but we try.
          $msiPath = "${{ steps.find_msi.outputs.msi_path }}"
          if (Test-Path $msiPath) {
            Start-Process msiexec.exe -ArgumentList "/x `"$msiPath`" /qn" -Wait
          }
          Get-Process -Name "fortuna-webservice" -ErrorAction SilentlyContinue | Stop-Process -Force
          Write-Host "âœ… Cleanup complete."


  package-msi-service:
    name: 'ðŸ’¿ Package Service MSI'
    runs-on: windows-latest
    timeout-minutes: 25
    needs: [path-finder, repo-preflight, build-backend]
    env:
      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Backend
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist

      - name: Stage Artifacts
        id: stage
        run: |
          Set-StrictMode -Version Latest
          $staging = "${{ env.MSI_STAGING_DIR }}"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          # Rename the executable to match the service name defined in the WiX project
          Move-Item -Path "dist/fortuna-backend.exe" -Destination "$staging/fortuna-webservice.exe" -Force
          $msiName = "Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi".Replace('/', '-')
          "msi_name=$msiName" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "âœ… Staged for MSI: $msiName"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}

      - name: Prepare WiX Project
        run: |
          Set-StrictMode -Version Latest
          Copy-Item "${{ env.WIX_DIR }}/Product_WithService.wxs" "${{ env.WIX_DIR }}/Product.wxs" -Force
          $wixProj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">'
            '  <PropertyGroup>'
            '    <OutputName>${{ steps.stage.outputs.msi_name }}</OutputName>'
            '    <OutputType>Package</OutputType>'
            '    <DefineConstants>SourceDir=staging;Version=${{ env.BUILD_VERSION }}</DefineConstants>'
            '    <Platforms>x64</Platforms>'
            '    <Version>${{ env.BUILD_VERSION }}</Version>'
            '    <BinderIncludeCabinetFilesInPackage>true</BinderIncludeCabinetFilesInPackage>'
            '  </PropertyGroup>'
            '  <ItemGroup>'
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />'
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />'
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />'
            '  </ItemGroup>'
            '  <ItemGroup>'
            '    <Compile Include="Product.wxs" />'
            '  </ItemGroup>'
            '</Project>'
          )
          Set-Content "${{ env.WIX_DIR }}/Fortuna.wixproj" -Value $wixProj -Encoding utf8

      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        run: |
          Set-StrictMode -Version Latest
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version="${{ env.BUILD_VERSION }}"
          $msiFile = "bin/x64/Release/${{ steps.stage.outputs.msi_name }}"
          if (-not (Test-Path $msiFile)) { throw "MSI not created" }
          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash
          $hash | Out-File "$msiFile.sha256" -Encoding utf8
          Write-Host "âœ… MSI Built: $hash"

      - name: Upload MSI + Hash
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-service-msi-${{ github.run_id }}
          path: ${{ env.WIX_DIR }}/bin/x64/Release/*
          retention-days: 10

  create-release:
    name: 'ðŸš€ Create Release'
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: package-msi-service
    permissions:
      contents: write
    steps:
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          pattern: fortuna-service-msi-*
          merge-multiple: true
          path: assets

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: assets

      - name: Generate Checksums
        run: |
          cd assets
          ls *.msi
          sha256sum *.msi > SHASUMS256.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            assets/*.msi
            assets/*.sha256
            assets/SHASUMS256.txt
            assets/sbom.spdx.json
          generate_release_notes: true

  stage-release-artifacts:
    name: 'ðŸ“¦ Stage Release Artifacts'
    runs-on: windows-latest
    timeout-minutes: 5
    needs: [package-msi-service, repo-preflight]
    steps:
      - name: ðŸ“¥ Download MSI Installer
        uses: actions/download-artifact@v4
        with:
          name: fortuna-service-msi-${{ github.run_id }}
          path: msi-installer
      - name: ðŸšš Stage Final Artifact
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $sourceDir = "msi-installer"
          $destDir = "final-release-artifact"
          New-Item -ItemType Directory -Path $destDir -Force | Out-Null

          robocopy $sourceDir $destDir /E

          if ($LASTEXITCODE -ge 8) {
            Write-Error "Robocopy failed with exit code $LASTEXITCODE. This indicates a serious error."
            exit 1
          }

          Write-Host "âœ… Robocopy completed successfully."
          Get-ChildItem -Path $destDir | Write-Host
          exit 0

      - name: ðŸ“¤ Upload Final MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Final-MSI-Artifact
          path: final-release-artifact/
          retention-days: 90
