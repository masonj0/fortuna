name: Build Fortuna Web Service MSI Installer

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  build-frontend:
    name: 'üì¶ Build Frontend'
    timeout-minutes: 15
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_service/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd web_service/frontend
          npm ci
          npm audit --audit-level=moderate
          npm run build
      - name: Verify Frontend Build
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $outDir = 'web_service/frontend/out'
          if (-not (Test-Path $outDir)) {
            Write-Host "‚ùå FATAL: Build output directory 'out' not created" -ForegroundColor Red
            exit 1
          }
          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: Build output directory is empty" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Frontend build verified ($fileCount files)" -ForegroundColor Green
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-output
          path: web_service/frontend/out
          retention-days: 1

  build-backend:
    name: 'üêç Build Web Service Backend'
    needs: [build-frontend]
    timeout-minutes: 20
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
      FORTUNA_MODE: "webservice"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-output
          path: web_service/frontend/out
      - name: Setup Python
        uses: actions/setup-python@v5.0.0 # Pinned to SHA
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'
      - name: Backend - Install Dependencies
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python -m pip install --upgrade pip
          pip install -r web_service/backend/requirements-dev.txt
      - name: Backend - Security Audit
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          pip-audit -r web_service/backend/requirements.txt --local
      - name: Verify Frontend Files in Executable Package
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # PyInstaller creates a temporary extraction - we can't easily inspect the exe
          # But we can verify the frontend source exists before building
          $frontendOut = 'web_service/frontend/out'
          if (-not (Test-Path $frontendOut)) {
            Write-Host "‚ùå FATAL: Frontend build output missing before PyInstaller!" -ForegroundColor Red
            exit 1
          }
          $fileCount = (Get-ChildItem -Path $frontendOut -Recurse -File | Measure-Object).Count
          Write-Host "‚úÖ Frontend files present for bundling: $fileCount files" -ForegroundColor Green
      - name: Verify PyInstaller Entry Point
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $specFile = "fortuna-webservice.spec"
          if (-not (Test-Path $specFile)) { throw "‚ùå FATAL: Spec file not found: $specFile" }
          $specContent = Get-Content $specFile -Raw
          if ($specContent -match "Analysis\(\s*\[?'([^']+)'") {
            $entryPoint = $matches[1]
            $entryPointPath = $entryPoint -replace '/', '\'
            if (Test-Path $entryPointPath) {
              Write-Host "‚úÖ Entry point file exists: $entryPointPath" -ForegroundColor Green
            } else {
              throw "‚ùå FATAL: Entry point file NOT found: $entryPointPath"
            }
          } else {
            throw "‚ö†Ô∏è WARNING: Could not parse entry point from spec file"
          }
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          pyinstaller fortuna-webservice.spec --noconfirm
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-webservice-executable
          path: dist/fortuna-webservice.exe
          retention-days: 1
          if-no-files-found: error

  smoke-test-service:
    name: 'üß™ Smoke Test Service (Backend + Frontend)'
    timeout-minutes: 15
    needs: [build-backend]
    runs-on: windows-latest
    env:
      API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test"
      FORTUNA_MODE: "webservice"
      FORTUNA_PORT: 8102
      SMOKE_FRONTEND_URL: "http://localhost:8102"
      SMOKE_HEADING_SELECTOR: "h1:has-text('Fortuna Faucet')"
      SMOKE_SCREENSHOT_PATH: "smoke-test-screenshot.png"
      SMOKE_FAILURE_SCREENSHOT_PATH: "smoke-test-screenshot-FAILURE.png"
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-webservice-executable
          path: .
      - name: 'üõ°Ô∏è Configure Firewall for Smoke Test'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-NetFirewallRule -DisplayName "Allow Fortuna Smoke Test" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}
          Write-Host "‚úÖ Firewall rule added for port ${{ env.FORTUNA_PORT }}."
      - name: Run Backend
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $backendProcess = Start-Process -FilePath "./fortuna-webservice.exe" -PassThru -RedirectStandardOutput "backend-out.log" -RedirectStandardError "backend-err.log"
          Set-Content -Path "backend.pid" -Value $backendProcess.Id
          Start-Sleep -Seconds 10
      - name: Deep Integration Test (Poll Health Endpoint)
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $healthUrl = "${{ env.SMOKE_FRONTEND_URL }}/health"
          $maxAttempts = 15
          $delaySeconds = 2
          For ($i=1; $i -le $maxAttempts; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check passed on attempt $i."
                return
              }
            } catch {
              Write-Host "Attempt $i of $maxAttempts failed. Full error:"
              Write-Host ($_ | Out-String)
              Write-Host "Retrying in $delaySeconds seconds..."
              Start-Sleep -Seconds $delaySeconds
            }
          }
          Write-Host "‚ùå Health check failed after $maxAttempts attempts."
          exit 1
      - name: 'üïµÔ∏è‚Äç‚ôÄÔ∏è Enhanced Forensic Analysis'
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $logFile = "forensic-analysis.log"
          "--- üïµÔ∏è‚Äç‚ôÄÔ∏è FORENSIC ANALYSIS üïµÔ∏è‚Äç‚ôÄÔ∏è ---" | Out-File $logFile -Encoding utf8
          "`n--- 1. SYSTEM INFORMATION ---" | Out-File $logFile -Append -Encoding utf8
          Get-ComputerInfo | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8
          "`n--- 2. ENVIRONMENT VARIABLES ---" | Out-File $logFile -Append -Encoding utf8
          Get-ChildItem Env: | Sort-Object Name | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8
          "`n--- 3. FILE SYSTEM SNAPSHOT ---" | Out-File $logFile -Append -Encoding utf8
          Get-ChildItem -Recurse | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8
          "`n--- 4. RUNNING PROCESSES ---" | Out-File $logFile -Append -Encoding utf8
          Get-Process | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8
          "`n--- 5. NETWORK PORT USAGE (netstat) ---" | Out-File $logFile -Append -Encoding utf8
          try {
            netstat -anb | Out-File $logFile -Append -Encoding utf8
          } catch {
            "  (netstat -anb failed, attempting without -b)" | Out-File $logFile -Append -Encoding utf8
            netstat -an | Out-File $logFile -Append -Encoding utf8
          }
          "`n--- 6. FIREWALL RULES ---" | Out-File $logFile -Append -Encoding utf8
          Get-NetFirewallRule -DisplayName "Allow Fortuna Smoke Test" | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8
          "`n--- 7. FATAL BOOT ERROR LOG (fatal_boot_error.log) ---" | Out-File $logFile -Append -Encoding utf8
          if (Test-Path fatal_boot_error.log) { Get-Content fatal_boot_error.log -Raw | Out-File $logFile -Append -Encoding utf8 }
          "`n--- 8. BACKEND STDOUT (backend-out.log) ---" | Out-File $logFile -Append -Encoding utf8
          if (Test-Path backend-out.log) { Get-Content backend-out.log -Raw | Out-File $logFile -Append -Encoding utf8 }
          "`n--- 9. BACKEND STDERR (backend-err.log) ---" | Out-File $logFile -Append -Encoding utf8
          if (Test-Path backend-err.log) { Get-Content backend-err.log -Raw | Out-File $logFile -Append -Encoding utf8 }
          "`n--- END OF FORENSIC ANALYSIS ---" | Out-File $logFile -Append -Encoding utf8
          Write-Host "‚úÖ Forensic analysis written to $logFile"
      - name: Upload Forensic Analysis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forensic-analysis-jules-${{ github.sha }}
          path: forensic-analysis.log
          retention-days: 7
      - name: Frontend UI Verification
        continue-on-error: true
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          pip install playwright
          if ($LASTEXITCODE -ne 0) { throw "Playwright installation via pip failed." }
          python -m playwright install --with-deps
          if ($LASTEXITCODE -ne 0) { throw "Playwright browser installation failed." }
          $scriptContent = @"
          import sys, os
          from playwright.sync_api import sync_playwright, expect

          def run_verification():
              with sync_playwright() as p:
                  browser = p.chromium.launch()
                  page = browser.new_page()
                  try:
                      url = os.environ["SMOKE_FRONTEND_URL"]
                      page.goto(url, wait_until='networkidle', timeout=20000)
                      heading = page.locator(os.environ["SMOKE_HEADING_SELECTOR"])
                      expect(heading).to_be_visible(timeout=10000)
                      page.screenshot(path=os.environ["SMOKE_SCREENSHOT_PATH"])
                      sys.exit(0)
                  except Exception as e:
                      print(f"Error: {e}", file=sys.stderr)
                      page.screenshot(path=os.environ["SMOKE_FAILURE_SCREENSHOT_PATH"])
                      sys.exit(1)
                  finally:
                      browser.close()

          if __name__ == "__main__":
              run_verification()
          "@
          Set-Content -Path "verify_frontend.py" -Value $scriptContent
          python verify_frontend.py
      - name: Upload Verification Screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshot-${{ github.sha }}
          path: |
            ${{ env.SMOKE_SCREENSHOT_PATH }}
            ${{ env.SMOKE_FAILURE_SCREENSHOT_PATH }}
          if-no-files-found: warn
      - name: Teardown Processes
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (Test-Path "backend.pid") { Get-Content "backend.pid" | ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue } }
      - name: Upload Backend Logs for Diagnosis
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-jules-${{ github.sha }}
          path: |
            backend-out.log
            backend-err.log
          if-no-files-found: ignore

  package-msi-installer:
    name: 'üèÜ Package Web Service Installer'
    timeout-minutes: 15
    needs: [smoke-test-service]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-webservice-executable
          path: ./dist
      - name: Stage Artifacts
        id: stage_files
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $staging = "build_wix/staging"
          New-Item -ItemType Directory -Path $staging -Force
          Move-Item -Path "./dist/fortuna-webservice.exe" -Destination "$staging/fortuna-webservice.exe" -Force
          $msiName = "Fortuna-Jules-${{ github.ref_name }}.msi".Replace('/', '-')
          if ($msiName -match "main") { $msiName = "Fortuna-Jules-Nightly.msi" }
          echo "msi_name=$msiName" >> $env:GITHUB_OUTPUT
      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Build MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # Use the Product_WithService.wxs configuration
          $wixProjContent = @"
          <Project Sdk="WixToolset.Sdk/4.0.5">
            <PropertyGroup>
              <OutputName>${{ steps.stage_files.outputs.msi_name }}</OutputName>
              <OutputType>Package</OutputType>
              <DefineConstants>SourceDir=./staging</DefineConstants>
              <Platforms>x64</Platforms>
              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="WixToolset.Util.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.Firewall.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.UI.wixext" Version="4.0.5" />
              <Compile Include="./Product_WithService.wxs" />
            </ItemGroup>
          </Project>
          "@
          Set-Content -Path "FortunaWebService.wixproj" -Value $wixProjContent -Encoding UTF8
          dotnet build FortunaWebService.wixproj -c Release -p:Platform=x64
          $msiPath = "bin/x64/Release/${{ steps.stage_files.outputs.msi_name }}"
          if (-not (Test-Path $msiPath)) { throw "‚ùå Service MSI was not created." }
          New-Item -ItemType Directory -Path "dist" -Force
          Copy-Item -Path $msiPath -Destination "dist/${{ steps.stage_files.outputs.msi_name }}" -Force
      - name: Upload Final MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-webservice-installer-${{ github.sha }}
          path: fortuna-webservice.msi
          retention-days: 7
      - name: Create GitHub Release
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }} (Web Service)
          body: |
            MSI Installer for the Fortuna Faucet Web Service.
            Built from commit ${{ github.sha }}.
          draft: false
          prerelease: false
      - name: Upload Release Asset
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: fortuna-webservice.msi
          asset_name: fortuna-webservice-${{ github.ref_name }}.msi
          asset_content_type: application/octet-stream
