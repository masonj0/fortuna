name: Fortuna Monolith Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-monolith:
    name: 'Build Fortuna Monolith EXE'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # ========== FRONTEND ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend

          # Create next.config.js for static export
          $config = @(
            "module.exports = {",
            "  output: 'export',",
            "  distDir: 'out',",
            "  images: { unoptimized: true },",
            "  trailingSlash: true,",
            "};"
          )
          $config | Set-Content "next.config.js" -Force

          npm ci
          npm run build

          if (-not (Test-Path "out/index.html")) {
            throw "Frontend build failed"
          }

          Copy-Item -Path "out" -Destination "${{ github.workspace }}/frontend_dist" -Recurse -Force
          Write-Host "Frontend built successfully"

      # ========== BACKEND ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # FIXED: Downgraded for CEFPython3 compatibility
          cache: 'pip'

      - name: Install Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install pyinstaller==6.6.0
          pip install -r web_service/backend/requirements.txt

      - name: Create Data Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/json" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/logs" | Out-Null

      # ========== BUILD ==========
      - name: Build Monolith EXE
        shell: pwsh
        env:
          PYTHONIOENCODING: utf-8
        run: |
          Write-Host "Building Fortuna Monolith..."
          pyinstaller --clean --noconfirm fortuna-monolith.spec

          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"

          if (-not (Test-Path $exePath)) {
            Write-Host "ERROR: EXE not found at expected path."
            Write-Host "Searching for .exe files..."
            Get-ChildItem -Recurse -Filter "*.exe" -Path "./dist", "./build" | Select-Object FullName
            throw "Build failed - EXE not created at $exePath"
          }

          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "Build complete: $([math]::Round($size, 2)) MB"

      # ========== UPLOAD ==========
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fortuna-Monolith-${{ github.sha }}
          path: dist/fortuna-monolith/fortuna-monolith.exe
          retention-days: 30

      # ========== TEST ==========
      - name: Smoke Test
        shell: pwsh
        timeout-minutes: 5
        run: |
          $stdOutLog = "${{ github.workspace }}/monolith-stdout.log"
          $stdErrLog = "${{ github.workspace }}/monolith-stderr.log"

          Write-Host "Starting Fortuna Monolith..."
          $process = Start-Process `
            -FilePath "dist/fortuna-monolith/fortuna-monolith.exe" `
            -PassThru `
            -RedirectStandardOutput $stdOutLog `
            -RedirectStandardError $stdErrLog `
            -WindowStyle Hidden

          Write-Host "Waiting for startup (max 10 seconds)..."
          Start-Sleep -Seconds 4

          # Health check
          $success = $false
          for ($i = 1; $i -le 6; $i++) {
            try {
              $response = Invoke-WebRequest `
                -Uri "http://127.0.0.1:8000/api/health" `
                -UseBasicParsing `
                -TimeoutSec 2 `
                -ErrorAction Stop

              if ($response.StatusCode -eq 200) {
                Write-Host "Health check passed"
                $success = $true
                break
              }
            } catch {
              if ($i -lt 6) {
                Start-Sleep -Seconds 2
              }
            }
          }

          # Cleanup
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

          # Show logs if test failed
          if (-not $success) {
            Write-Host "`nApplication Log (stdout):"
            Get-Content $stdOutLog -ErrorAction SilentlyContinue | Select-Object -Last 100
            Write-Host "`nApplication Log (stderr):"
            Get-Content $stdErrLog -ErrorAction SilentlyContinue | Select-Object -Last 100
            throw "Health check failed"
          }

          Write-Host "Test passed successfully"
