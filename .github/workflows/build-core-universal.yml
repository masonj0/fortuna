name: ðŸ§¬ Universal Core (MSI)

on:
  workflow_call:
    inputs:
      # --- VERSIONING ---
      node_version:
        type: string
        default: '20'
      python_version:
        type: string
        default: '3.11'
      wix_version:
        type: string
        default: '4.0.5'

      # --- FEATURE TOGGLES ---
      enable_dietician:
        type: boolean
        default: false
      enable_canary:
        type: boolean
        default: false
      enable_paparazzi:
        type: boolean
        default: false
      enable_forensics:
        type: boolean
        default: false

      # --- CONFIG ---
      service_port:
        type: string
        default: '8102'
      skip_tests:
        type: boolean
        default: false

    secrets:
      API_KEY:
        required: false
      TVG_API_KEY:
        required: false

env:
  DOTNET_VERSION: '8.0.x'
  FORTUNA_ENV: smoke-test

jobs:
  # =========================================================
  # 1. PREFLIGHT
  # =========================================================
  preflight:
    name: ðŸ” Preflight
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.ver.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: ðŸ·ï¸ Versioning
        id: ver
        shell: pwsh
        run: |
          $tag = git describe --tags --abbrev=0 2>$null; if (-not $tag) { $tag = "v0.0.0" }
          "semver=$($tag -replace '^v','')" >> $env:GITHUB_OUTPUT

      - name: ðŸ”Ž Forensic Asset Verification
        if: ${{ inputs.enable_forensics }}
        shell: pwsh
        run: |
          # Checking paths based on Supreme Combo structure
          $files = @("electron/package.json", "web_service/backend/requirements.txt", "build_wix/Product_WithService.wxs")
          foreach ($f in $files) { if (-not (Test-Path $f)) { throw "Missing $f" } }

  # =========================================================
  # 2. BUILD FRONTEND
  # =========================================================
  build-frontend:
    name: âš›ï¸ Frontend
    needs: preflight
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'

      - name: ðŸ” Verify Build Script Exists
        shell: pwsh
        working-directory: electron
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          if (-not $pkg.scripts.build) { throw "âŒ package.json in electron/ is missing 'build' script!" }

      - run: npm ci && npm run build
        working-directory: electron

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: electron/out

  # =========================================================
  # 3. BUILD BACKEND
  # =========================================================
  build-backend:
    name: ðŸ Backend (${{ matrix.arch }})
    needs: [preflight, build-frontend]
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: electron/out

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      - name: ðŸ§¾ Arch Constraints
        shell: pwsh
        run: if ('${{ matrix.arch }}' -eq 'x86') { Set-Content constraints.txt 'numpy==1.23.5'; Add-Content constraints.txt 'pandas==1.5.3' } else { New-Item constraints.txt -Force }

      - run: pip install -r web_service/backend/requirements.txt -c constraints.txt && pip install pyinstaller

      - name: ðŸ—ï¸ PyInstaller
        run: |
          pyinstaller --noconfirm --onedir --clean --name fortuna-backend `
            --hidden-import=win32timezone --hidden-import=win32serviceutil `
            --add-data "web_service/backend;backend" `
            --add-data "electron/out;ui" `
            web_service/backend/service_entry.py
      - uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: dist/fortuna-backend

  # =========================================================
  # 4. PACKAGE MSI
  # =========================================================
  package-msi:
    name: ðŸ“¦ MSI (${{ matrix.arch }})
    needs: build-backend
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: staging/backend

      - name: ðŸ“ Inject Restart Script
        run: echo net stop FortunaWebService > staging\backend\restart_service.bat & echo net start FortunaWebService >> staging\backend\restart_service.bat
        shell: cmd

      - name: âš–ï¸ The Dietician
        if: ${{ inputs.enable_dietician }}
        shell: pwsh
        run: Write-Host "Payload: $((Get-ChildItem staging -Recurse | Measure-Object -Sum Length).Sum / 1MB) MB"

      - name: ðŸ”§ Setup WiX
        run: dotnet tool install --global wix --version ${{ inputs.wix_version }} && echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH

      - name: ðŸ—ï¸ Build MSI
        run: wix build build_wix/Product_WithService.wxs -arch ${{ matrix.arch }} -o Fortuna-${{ matrix.arch }}.msi -d Version="${{ needs.preflight.outputs.semver }}" -d SourceDir="staging"

      - name: ðŸ¦œ The Canary
        if: ${{ inputs.enable_canary }}
        shell: pwsh
        run: |
          try {
            if (Test-Path "C:\Program Files\Windows Defender\MpCmdRun.exe") {
               & "C:\Program Files\Windows Defender\MpCmdRun.exe" -Scan -ScanType 3 -File "$pwd\Fortuna-${{ matrix.arch }}.msi"
            }
          } catch { Write-Warning "Canary scan failed or skipped: $_" }

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: Fortuna-${{ matrix.arch }}.msi

  # =========================================================
  # 5. SMOKE TEST (Fast)
  # =========================================================
  smoke-test:
    name: ðŸš¬ Smoke (${{ matrix.arch }})
    needs: package-msi
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      # NO CHECKOUT HERE - Pure Artifacts
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ðŸ§¹ Clean & Install
        shell: pwsh
        run: |
          sc.exe delete "FortunaWebService" *>$null; Start-Sleep 2
          Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ðŸ©º Health Check
        shell: pwsh
        run: |
          Start-Sleep 10
          for($i=0;$i -lt 5;$i++) { try { if ((Invoke-RestMethod "http://127.0.0.1:${{ inputs.service_port }}/health").status -eq "ok") { return } } catch { Start-Sleep 5 } }
          throw "Dead Service"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: sc.exe delete "FortunaWebService" *>$null

  # =========================================================
  # 6. UI PROOF (Heavy/Optional)
  # =========================================================
  ui-proof:
    name: ðŸ“¸ Paparazzi (${{ matrix.arch }})
    needs: smoke-test
    if: ${{ inputs.enable_paparazzi }}
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ðŸ’¿ Re-Install for UI
        shell: pwsh
        run: Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ðŸ“¸ Run Playwright
        shell: pwsh
        run: |
          npm install playwright; npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => { const b = await chromium.launch(); const p = await b.newPage(); await p.goto('http://127.0.0.1:${{ inputs.service_port }}/docs'); await p.screenshot({path: 'proof.png'}); await b.close(); })();"

      - uses: actions/upload-artifact@v4
        with:
          name: proof-${{ matrix.arch }}
          path: proof.png

      - name: ðŸ§¹ Cleanup
        if: always()
        run: sc.exe delete "FortunaWebService" *>$null