name: ðŸ§¬ Universal Core (MSI)

on:
  workflow_call:
    inputs:
      # --- VERSIONING ---
      node_version: { type: string, default: '18' }
      python_version: { type: string, default: '3.11' }
      wix_version: { type: string, default: '4.0.5' }

      # --- FEATURE TOGGLES ---
      enable_dietician: { type: boolean, default: false }
      enable_canary: { type: boolean, default: false }
      enable_paparazzi: { type: boolean, default: false }
      enable_forensics: { type: boolean, default: false }

      # --- CONFIG ---
      service_port: { type: string, default: '8102' }
      skip_tests: { type: boolean, default: false }

    secrets:
      API_KEY: { required: false }
      TVG_API_KEY: { required: false }

env:
  DOTNET_VERSION: '8.0.x'
  FORTUNA_ENV: smoke-test

jobs:
  # =========================================================
  # 1. PREFLIGHT
  # =========================================================
  preflight:
    name: ðŸ” Preflight
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.ver.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Versioning
        id: ver
        shell: pwsh
        run: |
          try {
            $tag = git describe --tags --abbrev=0
          } catch {
            $tag = "v0.0.0"
            Write-Warning "Could not describe tags. Defaulting to $tag"
          }
          $semver = $tag -replace '^v',''
          "semver=$semver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Derived version: $semver"

      - name: ðŸ”Ž Forensic Asset Verification
        if: ${{ inputs.enable_forensics }}
        shell: pwsh
        run: |
          $files = @("web_platform/frontend/package.json", "web_service/backend/requirements.txt", "electron/package.json")
          foreach ($f in $files) { if (-not (Test-Path $f)) { throw "Missing $f" } }

  # =========================================================
  # 2. BUILD FRONTEND
  # =========================================================
  build-frontend:
    name: âš›ï¸ Frontend
    needs: preflight
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'

      - name: ðŸ” Verify Build Script Exists
        shell: pwsh
        working-directory: web_platform/frontend
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          if (-not $pkg.scripts.build) { throw "âŒ package.json in web_platform/frontend is missing 'build' script!" }

      - run: npm ci && npm run build
        working-directory: web_platform/frontend

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out

  # =========================================================
  # 3. BUILD BACKEND
  # =========================================================
  build-backend:
    name: ðŸ Backend (${{ matrix.arch }})
    needs: [preflight, build-frontend]
    runs-on: windows-latest
    strategy: { matrix: { arch: [x64, x86] } }
    steps:
      - uses: 'actions/checkout@v4'

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      # FIX: Replaced fragile backtick escape with robust multi-line commands
      - name: ðŸ§¾ Arch Constraints
        shell: pwsh
        run: |
          if ('${{ matrix.arch }}' -eq 'x86') {
            "numpy==1.23.5" | Set-Content constraints.txt
            "pandas==1.5.3" | Add-Content constraints.txt
          } else {
            New-Item constraints.txt -Force
          }

      - run: pip install -r web_service/backend/requirements.txt -c constraints.txt && pip install pyinstaller

      - name: ðŸ—ï¸ PyInstaller
        run: |
          pyinstaller --noconfirm --onedir --clean --name fortuna-backend `
            --hidden-import=win32timezone --hidden-import=win32serviceutil `
            --add-data "web_service/backend;backend" `
            --add-data "web_platform/frontend/out;ui" `
            web_service/backend/service_entry.py
      - uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: dist/fortuna-backend

  # =========================================================
  # 4. PACKAGE MSI
  # =========================================================
  package-msi:
    name: ðŸ“¦ MSI (${{ matrix.arch }})
    needs: build-backend
    runs-on: windows-latest
    strategy: { matrix: { arch: [x64, x86] } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: staging/backend

      - name: ðŸ“ Inject Restart Script
        run: echo net stop FortunaWebService > staging\backend\restart_service.bat & echo net start FortunaWebService >> staging\backend\restart_service.bat
        shell: cmd

      - name: âš–ï¸ The Dietician
        if: ${{ inputs.enable_dietician }}
        shell: pwsh
        run: |
          $sizeBytes = (Get-ChildItem staging -Recurse |
                        Measure-Object -Property Length -Sum).Sum
          $sizeMB = [math]::Round($sizeBytes / 1MB, 2)
          Write-Host "Payload: $sizeMB MB"

      - name: ðŸ”§ Setup WiX
        run: dotnet tool install --global wix --version ${{ inputs.wix_version }} && echo "$env:USERPROFILE\\.dotnet\\tools" >> $env:GITHUB_PATH

      - name: ðŸ—ï¸ Build MSI
        run: wix build build_wix/Product_WithService.wxs -arch ${{ matrix.arch }} -o Fortuna-${{ matrix.arch }}.msi -d Version="${{ needs.preflight.outputs.semver }}" -d SourceDir="staging"

      - name: ðŸ¦œ The Canary
        if: ${{ inputs.enable_canary }}
        shell: pwsh
        run: |
          try {
            if (Test-Path "C:\Program Files\Windows Defender\MpCmdRun.exe") {
               & "C:\Program Files\Windows Defender\MpCmdRun.exe" -Scan -ScanType 3 -File "$pwd\Fortuna-${{ matrix.arch }}.msi"
            }
          } catch { Write-Warning "Canary scan failed or skipped: $_" }

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: Fortuna-${{ matrix.arch }}.msi

  # =========================================================
  # 5. SMOKE TEST (Fast)
  # =========================================================
  smoke-test:
    name: ðŸš¬ Smoke (${{ matrix.arch }})
    needs: package-msi
    runs-on: windows-latest
    strategy: { matrix: { arch: [x64, x86] } }
    steps:
      # NO CHECKOUT HERE - Pure Artifacts
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ðŸ§¹ Clean & Install
        shell: pwsh
        run: |
          sc.exe delete "FortunaWebService" *>$null; Start-Sleep 2
          Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ðŸ©º Health Check
        shell: pwsh
        run: |
          Start-Sleep 10
          for($i=0;$i -lt 5;$i++) { try { if ((Invoke-RestMethod "http://127.0.0.1:${{ inputs.service_port }}/health").status -eq "ok") { return } } catch { Start-Sleep 5 } }
          throw "Dead Service"

      - name: ðŸ§¹ Cleanup
        if: always()
        run: sc.exe delete "FortunaWebService" *>$null

  # =========================================================
  # 6. UI PROOF (Heavy/Optional)
  # =========================================================
  ui-proof:
    name: ðŸ“¸ Paparazzi (${{ matrix.arch }})
    needs: smoke-test
    if: ${{ inputs.enable_paparazzi }}
    runs-on: windows-latest
    strategy: { matrix: { arch: [x64, x86] } }
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ðŸ’¿ Re-Install for UI
        shell: pwsh
        run: Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ðŸ“¸ Run Playwright
        shell: pwsh
        run: |
          npm install playwright; npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => { const b = await chromium.launch(); const p = await b.newPage(); await p.goto('http://127.0.0.1:${{ inputs.service_port }}/docs'); await p.screenshot({path: 'proof.png'}); await b.close(); })();"

      - uses: actions/upload-artifact@v4
        with:
          name: proof-${{ matrix.arch }}
          path: proof.png

      - name: ðŸ§¹ Cleanup
        if: always()
        run: sc.exe delete "FortunaWebService" *>$null
