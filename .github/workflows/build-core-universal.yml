name: ğŸ§¬ Universal Core (MSI)

on:
  workflow_call:
    inputs:
      # --- VERSIONING ---
      node_version:
        description: 'Node.js version to use for the build'
        required: false
        type: string
        default: '20'
      python_version:
        description: 'Python version to use for the build'
        required: false
        type: string
        default: '3.11'
      wix_version:
        description: 'Version of the WiX Toolset to install'
        required: false
        type: string
        default: '4.0.5'

      # --- FEATURE TOGGLES ---
      enable_dietician:
        description: 'If true, runs a pre-package size analysis job'
        required: false
        type: boolean
        default: false
      enable_canary:
        description: 'If true, runs a Windows Defender malware scan on the MSI'
        required: false
        type: boolean
        default: false
      enable_paparazzi:
        description: 'If true, runs a Playwright-based visual verification test'
        required: false
        type: boolean
        default: false
      enable_forensics:
        description: 'If true, runs a deep asset verification pre-flight job'
        required: false
        type: boolean
        default: false

      # --- CONFIG ---
      service_port:
        description: 'The localhost port to use for the backend service during smoke tests'
        required: false
        type: string
        default: '8102'
      skip_tests:
        description: 'If true, skips running the unit test suite'
        required: false
        type: boolean
        default: false

    secrets:
      API_KEY:
        required: false
      TVG_API_KEY:
        required: false

# -------------------------------------------------------------------------
# 2. GLOBAL PERMISSIONS & ENV
# -------------------------------------------------------------------------
permissions:
  contents: read

env:
  DOTNET_VERSION: '8.0.x'
  FORTUNA_ENV: smoke-test

# -------------------------------------------------------------------------
# 3. JOBS DEFINITION
# -------------------------------------------------------------------------
jobs:
  # =========================================================
  # 1. PREFLIGHT DIAGNOSTICS
  # =========================================================
  preflight:
    name: ğŸ” Preflight Diagnostics
    runs-on: windows-latest
    timeout-minutes: 10
    outputs:
      semver: ${{ steps.ver.outputs.semver }}
      build_timestamp: ${{ steps.env.outputs.build_timestamp }}
      short_sha: ${{ steps.env.outputs.short_sha }}
      is_tag: ${{ steps.env.outputs.is_tag }}
      branch: ${{ steps.env.outputs.branch }}
      diagnostics_passed: ${{ steps.summary.outputs.passed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # ENVIRONMENT DIAGNOSTICS
      # -------------------------------------------------------
      - name: ğŸ–¥ï¸ Environment Diagnostics
        id: env
        shell: pwsh
        run: |
          Write-Host '::group::ğŸ–¥ï¸ Runner Environment'

          $diag = @{
            runner = @{
              os = $env:RUNNER_OS
              arch = $env:PROCESSOR_ARCHITECTURE
              name = $env:RUNNER_NAME
              temp = $env:RUNNER_TEMP
              workspace = $env:GITHUB_WORKSPACE
            }
            workflow = @{
              event = $env:GITHUB_EVENT_NAME
              ref = $env:GITHUB_REF
              sha = $env:GITHUB_SHA
              actor = $env:GITHUB_ACTOR
              run_id = $env:GITHUB_RUN_ID
              run_number = $env:GITHUB_RUN_NUMBER
            }
          }

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚                    RUNNER INFO                              â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host "â”‚ OS:        $($diag.runner.os.PadRight(47)) â”‚"
          Write-Host "â”‚ Arch:      $($diag.runner.arch.PadRight(47)) â”‚"
          Write-Host "â”‚ Name:      $($diag.runner.name.PadRight(47)) â”‚"
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # System Resources
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚                  SYSTEM RESOURCES                           â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $disk = Get-PSDrive C
          $diskFreeGB = [math]::Round($disk.Free/1GB, 2)
          $diskUsedGB = [math]::Round($disk.Used/1GB, 2)
          $diskTotalGB = $diskFreeGB + $diskUsedGB
          $diskPct = [math]::Round(($diskUsedGB / $diskTotalGB) * 100, 1)

          $ram = Get-CimInstance Win32_OperatingSystem
          $ramTotalGB = [math]::Round($ram.TotalVisibleMemorySize/1MB, 2)
          $ramFreeGB = [math]::Round($ram.FreePhysicalMemory/1MB, 2)
          $ramUsedGB = $ramTotalGB - $ramFreeGB
          $ramPct = [math]::Round(($ramUsedGB / $ramTotalGB) * 100, 1)

          $cpuInfo = Get-CimInstance Win32_Processor | Select-Object -First 1

          Write-Host "â”‚ CPU:       $($cpuInfo.Name.Substring(0, [Math]::Min(47, $cpuInfo.Name.Length)).PadRight(47)) â”‚"
          Write-Host "â”‚ Cores:     $($("$($cpuInfo.NumberOfCores) cores / $($cpuInfo.NumberOfLogicalProcessors) threads").PadRight(47)) â”‚"
          Write-Host "â”‚ RAM:       $($("$ramFreeGB GB free / $ramTotalGB GB total ($ramPct% used)").PadRight(47)) â”‚"
          Write-Host "â”‚ Disk (C:): $($("$diskFreeGB GB free / $diskTotalGB GB total ($diskPct% used)").PadRight(47)) â”‚"
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # Resource warnings
          if ($diskFreeGB -lt 10) {
            Write-Host '::warning::Low disk space: Only $diskFreeGB GB free'
          }
          if ($ramFreeGB -lt 2) {
            Write-Host '::warning::Low memory: Only $ramFreeGB GB free'
          }

          # Outputs
          $timestamp = Get-Date -Format 'yyyy-MM-ddTHH:mm:ssZ'
          $shortSha = $env:GITHUB_SHA.Substring(0,7)

          # FIX: Use single quotes to prevent JSON escaping issues
          $isTag = 'false'
          if ($env:GITHUB_REF -like 'refs/tags/*') { $isTag = 'true' }

          $branch = $env:GITHUB_REF
          if ($env:GITHUB_REF -match '^refs/heads/') { $branch = $env:GITHUB_REF -replace 'refs/heads/','' }
          if ($env:GITHUB_REF -match '^refs/tags/') { $branch = $env:GITHUB_REF -replace 'refs/tags/','' }

          "build_timestamp=$timestamp" >> $env:GITHUB_OUTPUT
          "short_sha=$shortSha" >> $env:GITHUB_OUTPUT
          "is_tag=$isTag" >> $env:GITHUB_OUTPUT
          "branch=$branch" >> $env:GITHUB_OUTPUT

          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # INPUT VALIDATION
      # -------------------------------------------------------
      - name: âœ… Input Validation
        id: inputs
        shell: pwsh
        run: |
          Write-Host '::group::âœ… Input Validation'

          $errors = [System.Collections.ArrayList]@()
          $warnings = [System.Collections.ArrayList]@()

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚                   INPUT PARAMETERS                          â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          # Node version
          $nodeVer = "${{ inputs.node_version }}"
          $nodeValid = $nodeVer -match '^\d+(\.\d+)?(\.\d+)?$'
          $nodeIcon = if ($nodeValid) { 'âœ…' } else { 'âŒ' }
          Write-Host "â”‚ $nodeIcon Node Version:    $($nodeVer.PadRight(43)) â”‚"
          if (-not $nodeValid) { [void]$errors.Add("Invalid node_version: $nodeVer") }

          # Python version
          $pyVer = "${{ inputs.python_version }}"
          $pyValid = $pyVer -match '^\d+\.\d+(\.\d+)?$'
          $pyIcon = if ($pyValid) { 'âœ…' } else { 'âŒ' }
          Write-Host "â”‚ $pyIcon Python Version:  $($pyVer.PadRight(43)) â”‚"
          if (-not $pyValid) { [void]$errors.Add("Invalid python_version: $pyVer") }

          # WiX version
          $wixVer = "${{ inputs.wix_version }}"
          $wixValid = $wixVer -match '^\d+\.\d+\.\d+$'
          $wixIcon = if ($wixValid) { 'âœ…' } else { 'âŒ' }
          Write-Host "â”‚ $wixIcon WiX Version:     $($wixVer.PadRight(43)) â”‚"
          if (-not $wixValid) { [void]$errors.Add("Invalid wix_version: $wixVer") }

          # Port validation
          $port = "${{ inputs.service_port }}"
          $portNum = 0
          $portValid = [int]::TryParse($port, [ref]$portNum) -and $portNum -ge 1 -and $portNum -le 65535
          $portIcon = if ($portValid) { 'âœ…' } else { 'âŒ' }
          Write-Host "â”‚ $portIcon Service Port:   $($port.PadRight(43)) â”‚"
          if (-not $portValid) {
            [void]$errors.Add("Invalid service_port: $port (must be 1-65535)")
          } elseif ($portNum -lt 1024) {
            [void]$warnings.Add("Port $port is privileged (<1024)")
          } elseif ($portNum -lt 49152) {
            # Check for common conflicts
            $commonPorts = @{ 8080='HTTP-Alt'; 3000='Dev Server'; 5000='Flask'; 8000='Django' }
            if ($commonPorts.ContainsKey($portNum)) {
              [void]$warnings.Add("Port $port commonly used by $($commonPorts[$portNum])")
            }
          }

          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host 'â”‚                   FEATURE TOGGLES                           â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $features = @(
            @{ name = 'Dietician'; value = "${{ inputs.enable_dietician }}" },
            @{ name = 'Canary'; value = "${{ inputs.enable_canary }}" },
            @{ name = 'Paparazzi'; value = "${{ inputs.enable_paparazzi }}" },
            @{ name = 'Forensics'; value = "${{ inputs.enable_forensics }}" },
            @{ name = 'Skip Tests'; value = "${{ inputs.skip_tests }}" }
          )

          foreach ($f in $features) {
            $icon = if ($f.value -eq 'true') { 'ğŸŸ¢' } else { 'âšª' }
            $status = if ($f.value -eq 'true') { 'ENABLED' } else { 'disabled' }
            Write-Host "â”‚ $icon $($f.name.PadRight(14)): $($status.PadRight(41)) â”‚"
          }

          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # Report warnings and errors
          if ($warnings.Count -gt 0) {
            Write-Host "`nâš ï¸ WARNINGS ($($warnings.Count)):"
            foreach ($w in $warnings) {
              Write-Host "  â€¢ $w"
              Write-Host "::warning::$w"
            }
          }

          if ($errors.Count -gt 0) {
            Write-Host "`nâŒ ERRORS ($($errors.Count)):" -ForegroundColor Red
            foreach ($e in $errors) {
              Write-Host "  â€¢ $e" -ForegroundColor Red
              Write-Host "::error::$e"
            }
            throw "Input validation failed with $($errors.Count) error(s)"
          }

          Write-Host "`nâœ… All inputs validated successfully"
          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # TOOL CHAIN VERIFICATION
      # -------------------------------------------------------
      - name: ğŸ”§ Tool Chain Verification
        shell: pwsh
        run: |
          Write-Host '::group::ğŸ”§ Tool Chain Verification'

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚                   INSTALLED TOOLS                           â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host 'â”‚ Tool             â”‚ Version / Status                         â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $tools = @(
            @{ name = 'git'; cmd = 'git --version'; parse = { $args[0] -replace 'git version ','' } },
            @{ name = 'dotnet'; cmd = 'dotnet --version'; parse = { $args[0] } },
            @{ name = 'msiexec'; cmd = 'msiexec /?'; parse = { 'Available (Windows Installer)' } },
            @{ name = 'sc.exe'; cmd = 'sc.exe query type= service'; parse = { 'Available (Service Control)' } },
            @{ name = 'PowerShell'; cmd = '$PSVersionTable.PSVersion.ToString()'; parse = { $args[0] } },
            @{ name = 'Windows SDK'; cmd = 'if (Test-Path "C:\\Program Files (x86)\\Windows Kits\\10") { "Installed" } else { "Not Found" }'; parse = { $args[0] } }
          )

          $toolStatus = @{}
          foreach ($tool in $tools) {
            try {
              $result = Invoke-Expression $tool.cmd 2>&1 | Select-Object -First 1
              $version = & $tool.parse $result
              $icon = 'âœ…'
              $toolStatus[$tool.name] = $true
            } catch {
              $version = 'NOT AVAILABLE'
              $icon = 'âŒ'
              $toolStatus[$tool.name] = $false
            }
            Write-Host "â”‚ $icon $($tool.name.PadRight(14)) â”‚ $($version.ToString().PadRight(40)) â”‚"
          }

          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # .NET SDKs detail
          Write-Host "`nğŸ“¦ .NET SDKs Installed:"
          dotnet --list-sdks 2>$null | ForEach-Object { Write-Host "   $_" }

          # Check for critical tool failures
          $criticalTools = @('git', 'dotnet', 'msiexec')
          $missingCritical = $criticalTools | Where-Object { -not $toolStatus[$_] }
          if ($missingCritical) {
            throw "Critical tools missing: $($missingCritical -join ', ')"
          }

          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # GIT STATE & VERSIONING
      # -------------------------------------------------------
      - name: ğŸ·ï¸ Git State & Versioning
        id: ver
        shell: pwsh
        run: |
          Write-Host '::group::ğŸ·ï¸ Git State & Versioning'

          # Ensure we have all tags
          git fetch --prune --unshallow --tags 2>$null

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚                    GIT STATE                                â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $branch = git rev-parse --abbrev-ref HEAD 2>$null
          $commit = git rev-parse HEAD 2>$null
          $shortSha = git rev-parse --short HEAD 2>$null
          $commitCount = git rev-list --count HEAD 2>$null
          $lastCommitMsg = git log -1 --pretty=format:"%s" 2>$null
          $lastCommitAuthor = git log -1 --pretty=format:"%an" 2>$null
          $lastCommitDate = git log -1 --pretty=format:"%ci" 2>$null

          Write-Host "â”‚ Branch:      $($branch.PadRight(45)) â”‚"
          Write-Host "â”‚ Commit:      $($shortSha.PadRight(45)) â”‚"
          Write-Host "â”‚ Full SHA:    $($commit.Substring(0,40).PadRight(45)) â”‚"
          Write-Host "â”‚ Total:       $("$commitCount commits").PadRight(45) â”‚"
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host "â”‚ Last Commit: $($lastCommitMsg.Substring(0, [Math]::Min(45, $lastCommitMsg.Length)).PadRight(45)) â”‚"
          Write-Host "â”‚ Author:      $($lastCommitAuthor.PadRight(45)) â”‚"
          Write-Host "â”‚ Date:        $($lastCommitDate.PadRight(45)) â”‚"
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # Tag analysis
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚                   TAG ANALYSIS                              â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $allTags = git tag --list 2>$null
          $tagCount = if ($allTags) { ($allTags -split "`n" | Where-Object { $_ }).Count } else { 0 }

          Write-Host "â”‚ Total Tags: $($tagCount.ToString().PadRight(46)) â”‚"

          if ($tagCount -gt 0) {
            Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
            Write-Host 'â”‚ Recent Tags (newest first):                                 â”‚'
            $recentTags = git tag --list --sort=-version:refname 2>$null | Select-Object -First 5
            foreach ($t in $recentTags) {
              Write-Host "â”‚   â€¢ $($t.PadRight(53)) â”‚"
            }
          }
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # Version detection
          Write-Host "`nğŸ”¢ VERSION DETECTION:"
          $tag = git describe --tags --abbrev=0 2>$null
          $descFull = git describe --tags --always 2>$null
          $commitsAhead = 0

          if ([string]::IsNullOrEmpty($tag)) {
            Write-Host "   âš ï¸ No tags found in repository"
            Write-Host "   ğŸ“¦ Using fallback version: v0.0.0"
            Write-Host '::warning::No git tags found. Using default version v0.0.0'
            $tag = "v0.0.0"
          } else {
            Write-Host "   Latest Tag: $tag"
            Write-Host "   Full Describe: $descFull"

            # Check commits ahead of tag
            $commitsAhead = git rev-list "$tag..HEAD" --count 2>$null
            if ($commitsAhead -gt 0) {
              Write-Host "   âš ï¸ $commitsAhead commit(s) ahead of latest tag"
            }
          }

          $semver = $tag -replace '^v',''

          # Validate semver
          if ($semver -match '^\\d+\\.\\d+\\.\\d+(-[a-zA-Z0-9.-]+)?(\\+[a-zA-Z0-9.-]+)?$') {
            Write-Host "   âœ… Valid SemVer format"
          } else {
            Write-Host "   âš ï¸ Non-standard version format: $semver"
            Write-Host "::warning::Version `$semver` does not follow standard SemVer"
          }

          Write-Host ""
          Write-Host "   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "   â•‘  ğŸ“¦ BUILD VERSION: $($semver.PadRight(18)) â•‘"
          Write-Host "   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          "semver=$semver" >> $env:GITHUB_OUTPUT

          # Dirty state check
          Write-Host "`nğŸ§¹ WORKING DIRECTORY STATUS:"
          $status = git status --porcelain 2>$null
          if ($status) {
            $changedFiles = ($status -split "`n" | Where-Object { $_ }).Count
            Write-Host "   âš ï¸ $changedFiles uncommitted change(s) detected:"
            $status -split "`n" | Select-Object -First 5 | ForEach-Object {
              Write-Host "      $_"
            }
            if ($changedFiles -gt 5) {
              Write-Host "      ... and $($changedFiles - 5) more"
            }
          } else {
            Write-Host "   âœ… Working directory is clean"
          }

          Write-Host '::endgroup::'

      - name: âœ¨ Runner Stabilization
        shell: pwsh
        run: |
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host "  Runner stabilization checkpoint - 2 second pause"
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Start-Sleep -Seconds 2

      # -------------------------------------------------------
      # CORE ASSET VERIFICATION (Always runs)
      # -------------------------------------------------------
      - name: ğŸ“‚ Core Asset Verification
        id: assets
        shell: pwsh
        run: |
          Write-Host '::group::ğŸ“‚ Core Asset Verification'

          $criticalAssets = @(
            @{ path = "electron/package.json"; desc = "Electron package manifest" },
            @{ path = "electron/package-lock.json"; desc = "Electron dependency lock" },
            @{ path = "web_service/backend/requirements.txt"; desc = "Python dependencies" },
            @{ path = "web_service/backend/service_entry.py"; desc = "Service entry point" },
            @{ path = "build_wix/Product_WithService.wxs"; desc = "WiX installer definition" }
          )

          $optionalAssets = @(
            @{ path = ".github/workflows"; desc = "GitHub Actions workflows" },
            @{ path = "README.md"; desc = "Project documentation" },
            @{ path = "LICENSE"; desc = "License file" },
            @{ path = ".gitignore"; desc = "Git ignore rules" },
            @{ path = "tests"; desc = "Test suite" }
          )

          $missing = @()

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚                CRITICAL ASSETS                              â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          foreach ($asset in $criticalAssets) {
            if (Test-Path $asset.path) {
              $item = Get-Item $asset.path
              if ($item.PSIsContainer) {
                $size = "directory"
                $files = (Get-ChildItem $asset.path -Recurse -File | Measure-Object).Count
                $size = "$files files"
              } else {
                $bytes = $item.Length
                $size = switch ($bytes) {
                  { $_ -lt 1KB } { "$bytes B" }
                  { $_ -lt 1MB } { "{0:N1} KB" -f ($_ / 1KB) }
                  default { "{0:N1} MB" -f ($_ / 1MB) }
                }
              }
              Write-Host "â”‚ âœ… $($asset.path.PadRight(35)) ($size)"
            } else {
              Write-Host "â”‚ âŒ $($asset.path.PadRight(35)) MISSING!" -ForegroundColor Red
              $missing += $asset
            }
          }

          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host 'â”‚                OPTIONAL ASSETS                              â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          foreach ($asset in $optionalAssets) {
            if (Test-Path $asset.path) {
              Write-Host "â”‚ âœ… $($asset.path.PadRight(35)) present"
            } else {
              Write-Host "â”‚ âšª $($asset.path.PadRight(35)) not found" -ForegroundColor Gray
            }
          }

          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          if ($missing.Count -gt 0) {
            Write-Host ""
            Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
            Write-Host "â•‘  âŒ FATAL: Missing $($missing.Count) critical asset(s)!                        â•‘" -ForegroundColor Red
            Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Red
            foreach ($m in $missing) {
              Write-Host "â•‘  â€¢ $($m.path.PadRight(30)) - $($m.desc.PadRight(20)) â•‘" -ForegroundColor Red
              Write-Host "::error file=$($m.path)::Missing critical asset: $($m.desc)"
            }
            Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
            throw "Missing critical assets: $($missing.path -join ', ')"
          }

          Write-Host "`nâœ… All critical assets verified"
          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # EXTENDED FORENSICS (Optional - Deep Analysis)
      # -------------------------------------------------------
      - name: ğŸ”¬ Extended Forensics
        if: ${{ inputs.enable_forensics == true }}
        shell: pwsh
        run: |
          Write-Host '::group::ğŸ”¬ Extended Forensics Analysis'

          # ======= ELECTRON PACKAGE ANALYSIS =======
          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚            ELECTRON PACKAGE ANALYSIS                        â”‚'
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          $pkg = Get-Content "electron/package.json" -Raw | ConvertFrom-Json

          Write-Host "  Name:    $($pkg.name)"
          Write-Host "  Version: $($pkg.version)"
          Write-Host "  Main:    $($pkg.main)"

          Write-Host "`n  ğŸ“œ Available Scripts:"
          if ($pkg.scripts) {
            $pkg.scripts.PSObject.Properties | ForEach-Object {
              $icon = if ($_.Name -eq 'build') { "â­" } else { "  " }
              Write-Host "     $icon $($_.Name): $($_.Value)"
            }

            if (-not $pkg.scripts.build) {
              Write-Host "     âš ï¸ WARNING: No 'build' script defined!" -ForegroundColor Yellow
              Write-Host "::warning file=electron/package.json::No 'build' script defined in package.json"
            }
          }

          Write-Host "`n  ğŸ“¦ Dependencies:"
          if ($pkg.dependencies) {
            $depCount = ($pkg.dependencies.PSObject.Properties | Measure-Object).Count
            Write-Host "     Production: $depCount packages"
            $pkg.dependencies.PSObject.Properties | Select-Object -First 10 | ForEach-Object {
              Write-Host "       â€¢ $($_.Name)@$($_.Value)"
            }
          }
          if ($pkg.devDependencies) {
            $devCount = ($pkg.devDependencies.PSObject.Properties | Measure-Object).Count
            Write-Host "     Development: $devCount packages"
          }

          # ======= PYTHON REQUIREMENTS ANALYSIS =======
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚            PYTHON REQUIREMENTS ANALYSIS                     â”‚'
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          $reqs = Get-Content "web_service/backend/requirements.txt"
          $packages = $reqs | Where-Object { $_ -notmatch '^\\s*(#|$)' }
          $pkgCount = ($packages | Measure-Object).Count

          Write-Host "  Total packages: $pkgCount"
          Write-Host "`n  ğŸ“¦ Dependencies:"

          # Categorize packages
          $pinnedExact = $packages | Where-Object { $_ -match '==' }
          $pinnedMin = $packages | Where-Object { $_ -match '>=' }
          $unpinned = $packages | Where-Object { $_ -notmatch '[<>=]' }

          Write-Host "     Pinned (exact): $($pinnedExact.Count)"
          Write-Host "     Pinned (min):   $($pinnedMin.Count)"
          Write-Host "     Unpinned:       $($unpinned.Count)"

          if ($unpinned.Count -gt 0) {
            Write-Host "`n     âš ï¸ Unpinned packages (potential reproducibility issues):"
            $unpinned | Select-Object -First 5 | ForEach-Object { Write-Host "        â€¢ $_" }
          }

          # Check for known problematic packages on Windows
          $winProblematic = @("pywin32", "win32", "numpy", "pandas", "scipy")
          $foundProblematic = $packages | Where-Object {
            $pkg = $_
            $winProblematic | Where-Object { $pkg -match $_ }
          }
          if ($foundProblematic) {
            Write-Host "`n     ğŸ“‹ Windows-sensitive packages detected:"
            $foundProblematic | ForEach-Object { Write-Host "        â€¢ $_" }
          }

          # ======= WIX CONFIGURATION ANALYSIS =======
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚              WIX CONFIGURATION ANALYSIS                     â”‚'
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          $wxsPath = "build_wix/Product_WithService.wxs"
          $wxs = Get-Content $wxsPath -Raw

          $patterns = @{
            "UpgradeCode" = 'UpgradeCode="([^\"]+)"'
            "Product Name" = 'Name="([^\"]+)"'
            "Manufacturer" = 'Manufacturer="([^\"]+)"'
            "Version Variable" = 'Version="\\$\\(var\\.([^)]+)\\)"'
          }

          foreach ($item in $patterns.Keys) {
            if ($wxs -match $patterns[$item]) {
              Write-Host "  $item`: $($Matches[1])"
            }
          }

          # Check for service configuration
          if ($wxs -match 'ServiceInstall') {
            Write-Host "  âœ… Windows Service installation configured"
          } else {
            Write-Host "  âš ï¸ No ServiceInstall element found" -ForegroundColor Yellow
          }

          # ======= DIRECTORY STRUCTURE =======
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚              PROJECT STRUCTURE                              â”‚'
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          function Show-Tree {
            param([string]$Path, [int]$Indent = 0, [int]$MaxDepth = 2)
            if ($Indent -ge $MaxDepth) { return }

            Get-ChildItem $Path -ErrorAction SilentlyContinue | ForEach-Object {
              $prefix = "  " * $Indent
              if ($_.PSIsContainer) {
                Write-Host "$prefixğŸ“ $($_.Name)/"
                Show-Tree $_.FullName ($Indent + 1) $MaxDepth
              } else {
                $size = switch ($_.Length) {
                  { $_ -lt 1KB } { "$($_.Length)B" }
                  { $_ -lt 1MB } { "{0:N0}KB" -f ($_ / 1KB) }
                  default { "{0:N1}MB" -f ($_ / 1MB) }
                }
                Write-Host "$prefixğŸ“„ $($_.Name) ($size)"
              }
            }
          }

          Show-Tree "." 0 2

          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # SECRET & CREDENTIAL CHECK
      # -------------------------------------------------------
      - name: ğŸ” Secret Availability Check
        shell: pwsh
        env:
          HAS_API_KEY: ${{ secrets.API_KEY != '' }}
          HAS_TVG_API_KEY: ${{ secrets.TVG_API_KEY != '' }}
        run: |
          Write-Host '::group::ğŸ” Secret Configuration'

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚               SECRET AVAILABILITY                           â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host 'â”‚ Secret           â”‚ Status                                     â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $secrets = @(
            @{ name = "API_KEY"; configured = $env:HAS_API_KEY -eq 'true'; required = $false },
            @{ name = "TVG_API_KEY"; configured = $env:HAS_TVG_API_KEY -eq 'true'; required = $false }
          )

          foreach ($s in $secrets) {
            $status = if ($s.configured) {
              "âœ… Configured"
            } elseif ($s.required) {
              "âŒ MISSING (Required!)"
            } else {
              "âšª Not configured (Optional)"
            }
            Write-Host "â”‚ $($s.name.PadRight(16)) â”‚ $($status.PadRight(42)) â”‚"
          }

          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          $missingRequired = $secrets | Where-Object { $_.required -and -not $_.configured }
          if ($missingRequired) {
            throw "Missing required secrets: $($missingRequired.name -join ', ')"
          }

          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # NETWORK DIAGNOSTICS
      # -------------------------------------------------------
      - name: ğŸŒ Network Diagnostics
        shell: pwsh
        run: |
          Write-Host '::group::ğŸŒ Network Diagnostics'

          Write-Host 'â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”'
          Write-Host 'â”‚              ENDPOINT CONNECTIVITY                          â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'
          Write-Host 'â”‚ Endpoint         â”‚ Status                                   â”‚'
          Write-Host 'â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤'

          $endpoints = @(
            @{ name = "GitHub API"; url = "https://api.github.com"; critical = $true },
            @{ name = "npm Registry"; url = "https://registry.npmjs.org"; critical = $true },
            @{ name = "PyPI"; url = "https://pypi.org/simple/"; critical = $true },
            @{ name = "NuGet"; url = "https://api.nuget.org/v3/index.json"; critical = $true }
          )

          $failures = @()

          foreach ($ep in $endpoints) {
            try {
              $start = Get-Date
              $null = Invoke-WebRequest -Uri $ep.url -Method Head -TimeoutSec 10 -UseBasicParsing
              $latency = [math]::Round(((Get-Date) - $start).TotalMilliseconds)
              $status = "âœ… OK (${latency}ms)"
            } catch {
              $status = "âŒ FAILED"
              if ($ep.critical) { $failures += $ep.name }
            }
            Write-Host "â”‚ $($ep.name.PadRight(16)) â”‚ $($status.PadRight(40)) â”‚"
          }

          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # Local port check
          Write-Host "`nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          Write-Host 'â”‚              LOCAL PORT STATUS                              â”‚'
          Write-Host 'â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜'

          # FIX: Quoted the input to prevent type coercion errors
          $port = "${{ inputs.service_port }}"
          $connections = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue

          if ($connections) {
            Write-Host "  âš ï¸ Port $port is currently IN USE:" -ForegroundColor Yellow
            $connections | ForEach-Object {
              $proc = Get-Process -Id $_.OwningProcess -ErrorAction SilentlyContinue
              Write-Host "     PID: $($_.OwningProcess) | Process: $($proc.ProcessName) | State: $($_.State)"
            }
            Write-Host "::warning::Port $port is already in use on the runner"
          } else {
            Write-Host "  âœ… Port $port is available"
          }

          # DNS resolution check
          Write-Host "`n  ğŸ” DNS Resolution:"
          try {
            $dns = Resolve-DnsName "github.com" -Type A -DnsOnly -ErrorAction Stop
            Write-Host "     âœ… github.com resolves to $($dns.IPAddress -join ', ')"
          } catch {
            Write-Host "     âŒ DNS resolution failed"
          }

          if ($failures.Count -gt 0) {
            Write-Host "::warning::Failed to reach: $($failures -join ', ')"
          }

          Write-Host '::endgroup::'

      # -------------------------------------------------------
      # PREFLIGHT SUMMARY
      # -------------------------------------------------------
      - name: ğŸ“‹ Preflight Summary
        id: summary
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Green
          Write-Host "â•‘          âœ…  PREFLIGHT DIAGNOSTICS COMPLETE                     â•‘" -ForegroundColor Green
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Green
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸ“¦ VERSION:     $($("${{ steps.ver.outputs.semver }}").PadRight(44)) â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸ”– COMMIT:      $($("${{ steps.env.outputs.short_sha }}").PadRight(44)) â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸŒ¿ BRANCH:      $($("${{ steps.env.outputs.branch }}").PadRight(44)) â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  ğŸ·ï¸ IS TAG:      $($("${{ steps.env.outputs.is_tag }}").PadRight(44)) â•‘" -ForegroundColor Cyan
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Cyan
          Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Green
          Write-Host "â•‘  TOOLCHAIN                                                      â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  â”œâ”€ Node:   $($("${{ inputs.node_version }}").PadRight(49)) â•‘" -ForegroundColor White
          Write-Host "â•‘  â”œâ”€ Python: $($("${{ inputs.python_version }}").PadRight(49)) â•‘" -ForegroundColor White
          Write-Host "â•‘  â””â”€ WiX:    $($("${{ inputs.wix_version }}").PadRight(49)) â•‘" -ForegroundColor White
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Cyan
          Write-Host "â•‘  CONFIGURATION                                                  â•‘" -ForegroundColor Yellow
          Write-Host "â•‘  â””â”€ Service Port: $($("${{ inputs.service_port }}").PadRight(43)) â•‘" -ForegroundColor White
          Write-Host "â•‘                                                                 â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸš€ Ready to proceed with build pipeline!" -ForegroundColor Green
          Write-Host ""

          # --- GitHub Job Summary ---
          $summary = @"
          ## ğŸ” Preflight Diagnostics Complete

          | Property | Value |
          |----------|-------|
          | ğŸ“¦ **Version** | `${{ steps.ver.outputs.semver }}` |
          | ğŸ”– **Commit** | `${{ steps.env.outputs.short_sha }}` |
          | ğŸŒ¿ **Branch** | `${{ steps.env.outputs.branch }}` |
          | ğŸ·ï¸ **Is Tag** | `${{ steps.env.outputs.is_tag }}` |
          | â° **Timestamp** | `${{ steps.env.outputs.build_timestamp }}` |

          ### ğŸ› ï¸ Toolchain
          | Tool | Version |
          |------|---------|
          | Node.js | `${{ inputs.node_version }}` |
          | Python | `${{ inputs.python_version }}` |
          | WiX | `${{ inputs.wix_version }}` |

          ### âš™ï¸ Feature Toggles
          | Feature | Status |
          |---------|--------|
          | ğŸ¥— Dietician | $(if ('${{ inputs.enable_dietician }}' -eq 'true') { 'ğŸŸ¢ Enabled' } else { 'âšª Disabled' }) |
          | ğŸ¦œ Canary | $(if ('${{ inputs.enable_canary }}' -eq 'true') { 'ğŸŸ¢ Enabled' } else { 'âšª Disabled' }) |
          | ğŸ“¸ Paparazzi | $(if ('${{ inputs.enable_paparazzi }}' -eq 'true') { 'ğŸŸ¢ Enabled' } else { 'âšª Disabled' }) |
          | ğŸ”¬ Forensics | $(if ('${{ inputs.enable_forensics }}' -eq 'true') { 'ğŸŸ¢ Enabled' } else { 'âšª Disabled' }) |

          ---
          âœ… **Ready to proceed with build pipeline**
          "@

          $summary >> $env:GITHUB_STEP_SUMMARY

          "passed=true" >> $env:GITHUB_OUTPUT

  # =========================================================
  # 2. BUILD FRONTEND
  # =========================================================
  build-frontend:
    name: âš›ï¸ Frontend
    needs: preflight
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: 'electron/package-lock.json'

      - name: ğŸ” Verify Build Script Exists
        shell: pwsh
        working-directory: electron
        run: |
          $pkg = Get-Content package.json | ConvertFrom-Json
          if (-not $pkg.scripts.build) { throw "âŒ package.json in electron/ is missing 'build' script!" }

      - name: ğŸ—ï¸ Build Frontend
        working-directory: electron
        run: |
          npm ci && npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: electron/out

  # =========================================================
  # 3. BUILD BACKEND
  # =========================================================
  build-backend:
    name: ğŸ Backend (${{ matrix.arch }})
    needs: [preflight, build-frontend]
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: electron/out

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      - name: ğŸ§¾ Arch Constraints
        shell: pwsh
        run: |
          if ('${{ matrix.arch }}' -eq 'x86') {
            Set-Content constraints.txt 'numpy==1.23.5'
            Add-Content constraints.txt 'pandas==1.5.3'
          } else {
            New-Item constraints.txt -Force
          }

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install -r web_service/backend/requirements.txt -c constraints.txt && pip install pyinstaller

      - name: ğŸ—ï¸ PyInstaller
        run: |
          pyinstaller --noconfirm --onedir --clean --name fortuna-backend `
            --hidden-import=win32timezone --hidden-import=win32serviceutil `
            --add-data "web_service/backend;backend" `
            --add-data "electron/out;ui" `
            web_service/backend/service_entry.py

      - uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: dist/fortuna-backend

  # =========================================================
  # 4. PACKAGE MSI
  # =========================================================
  package-msi:
    name: ğŸ“¦ MSI (${{ matrix.arch }})
    needs: build-backend
    runs-on: windows-latest
    timeout-minutes: 20
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-${{ matrix.arch }}
          path: staging/backend

      - name: ğŸ“ Inject Restart Script
        shell: cmd
        run: |
          echo net stop FortunaWebService > staging\\backend\\restart_service.bat
          echo net start FortunaWebService >> staging\\backend\\restart_service.bat

      - name: âš–ï¸ The Dietician
        if: ${{ inputs.enable_dietician }}
        shell: pwsh
        run: |
          Write-Host "Payload: $((Get-ChildItem staging -Recurse | Measure-Object -Sum Length).Sum / 1MB) MB"

      - name: ğŸ”§ Setup WiX
        run: |
          dotnet tool install --global wix --version ${{ inputs.wix_version }}
          echo "$env:USERPROFILE\\.dotnet\\tools" >> $env:GITHUB_PATH

      - name: ğŸ—ï¸ Build MSI
        run: |
          wix build build_wix/Product_WithService.wxs -arch ${{ matrix.arch }} -o Fortuna-${{ matrix.arch }}.msi -d Version="${{ needs.preflight.outputs.semver }}" -d SourceDir="staging"

      - name: ğŸ¦œ The Canary
        if: ${{ inputs.enable_canary }}
        shell: pwsh
        run: |
          try {
            if (Test-Path "C:\\Program Files\\Windows Defender\\MpCmdRun.exe") {
               & "C:\\Program Files\\Windows Defender\\MpCmdRun.exe" -Scan -ScanType 3 -File "$pwd\\Fortuna-${{ matrix.arch }}.msi"
            }
          } catch { Write-Warning "Canary scan failed or skipped: $_" }

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: Fortuna-${{ matrix.arch }}.msi

  # =========================================================
  # 5. SMOKE TEST (Fast)
  # =========================================================
  smoke-test:
    name: ğŸš¬ Smoke (${{ matrix.arch }})
    needs: package-msi
    runs-on: windows-latest
    timeout-minutes: 15
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      # NO CHECKOUT HERE - Pure Artifacts
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ğŸ§¹ Clean & Install
        shell: pwsh
        run: |
          sc.exe delete "FortunaWebService" *>$null; Start-Sleep 2
          Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ğŸ©º Health Check
        shell: pwsh
        run: |
          Start-Sleep 10
          for($i=0;$i -lt 5;$i++) { try { if ((Invoke-RestMethod "http://127.0.0.1:${{ inputs.service_port }}/health").status -eq "ok") { return } } catch { Start-Sleep 5 } }
          throw "Dead Service"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          sc.exe delete "FortunaWebService" *>$null

  # =========================================================
  # 6. UI PROOF (Heavy/Optional)
  # =========================================================
  ui-proof:
    name: ğŸ“¸ Paparazzi (${{ matrix.arch }})
    needs: smoke-test
    if: ${{ inputs.enable_paparazzi }}
    runs-on: windows-latest
    timeout-minutes: 15
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ğŸ’¿ Re-Install for UI
        shell: pwsh
        run: |
          Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait

      - name: ğŸ“¸ Run Playwright
        shell: pwsh
        run: |
          npm install playwright; npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => { const b = await chromium.launch(); const p = await b.newPage(); await p.goto('http://127.0.0.1:${{ inputs.service_port }}/docs'); await p.screenshot({path: 'proof.png'}); await b.close(); })();"

      - uses: actions/upload-artifact@v4
        with:
          name: proof-${{ matrix.arch }}
          path: proof.png

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          sc.exe delete "FortunaWebService" *>$null
