# System Timestamp: 2025-12-24 18:00:00
name: üé© HatTrick Fusion (Standard)
on:
  workflow_dispatch:
  push:
    branches: ["main"]
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9' # üöÄ DOWNGRADED for x86
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8102'
  FRONTEND_PORT: '3000'
  MSI_NAME: 'HatTrickFusion.msi'
  FIREWALL_RULE: 'HatTrickFusion-Port'
  UPGRADE_CODE: 'FA689549-366B-4C5C-A482-1132F9A34B10'
  FORTUNA_PORT: '8102'
  # Mock API keys for service startup
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  # 1. Build Frontend First (so Backend can bundle it)
  build-frontend:
    name: Build Frontend
    runs-on: windows-2022
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      - name: Cache Build Output
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: web_platform/frontend/out
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package-lock.json', 'web_platform/frontend/**/*.js', 'web_platform/frontend/**/*.ts', 'web_platform/frontend/**/*.tsx', 'web_platform/frontend/**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-frontend-
      - name: Install and Build
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: |
          cd web_platform/frontend
          npm ci --prefer-offline --no-audit --no-fund
          npm run build
      - name: Generate Artifact Manifest
        shell: pwsh
        working-directory: web_platform/frontend
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "out"
          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8
          $files = Get-ChildItem -Path $outDir -Recurse -File
          foreach ($f in $files) {
            $rel = $f.FullName.Substring($outDir.Path.Length) -replace '^[\\\/]', ''
            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)
            "$rel`t$($f.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }
          Write-Host "‚úÖ Generated frontend artifact manifest."
      - name: Upload Frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            web_platform/frontend/out
            web_platform/frontend/frontend-manifest.tsv

  # 2. Build Backend (Downloads Frontend to bundle it)
  build-backend:
    name: 'üêç Build Backend (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: build-frontend
    timeout-minutes: 30
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: web_platform/frontend/out
      - id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_dir=web_service/backend" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "module_path=web_service.backend" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'
      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $constraintDir = "temp-constraints"
          New-Item -ItemType Directory -Path $constraintDir -Force | Out-Null
          $constraintFile = Join-Path $constraintDir "constraint-${{ matrix.arch }}.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "üõ°Ô∏è ACTIVATING X86 SAFE MODE"
            @(
              "numpy==1.23.5",
              "pandas==1.5.3",
              "scipy==1.10.1",
              "--only-binary=:all:"
            ) | Set-Content $constraintFile
            Write-Host "‚úÖ x86 constraints: numpy 1.23.5, pandas 1.5.3, scipy 1.10.1, wheel-only"
          } else { New-Item $constraintFile -ItemType File -Force }
          "file=$constraintFile" | Out-File $env:GITHUB_OUTPUT -Append

      - name: CACHE-PYI Cache PyInstaller Build
        id: cache-pyi-build
        uses: actions/cache@v4
        with:
          path: dist/fortuna-core-service
          key: ${{ runner.os }}-${{ matrix.arch }}-pyi-${{ hashFiles('web_service/backend/**/*.py', 'scripts/generate_spec_dual.py', 'web_service/backend/requirements*.txt') }}

      - name: Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install uv

          Write-Host "[BUILD] Installing x86-constrained packages first..."
          uv pip install --only-binary=:all: `
            "sqlalchemy==1.4.46" `
            "greenlet==1.1.2" `
            "pandas==1.5.3" `
            "numpy==1.23.5" `
            "scipy==1.10.1"

          if ($LASTEXITCODE -ne 0) {
            throw "[BUILD] ‚ùå Failed to install x86-constrained packages"
          }

          Write-Host "[BUILD] Installing remaining dependencies..."
          uv pip install -r web_service/backend/requirements.txt --no-deps

          if ($LASTEXITCODE -ne 0) {
            throw "[BUILD] ‚ùå Failed to install remaining requirements"
          }

          Write-Host "[BUILD] Verifying all dependencies are satisfied..."
          pip check

          Write-Host "[BUILD] Installing PyInstaller..."
          uv pip install pyinstaller==6.6.0 pywin32

          Write-Host "[BUILD] ‚úÖ All dependencies installed successfully"

      - name: Verify x86 package versions
        if: matrix.arch == 'x86'
        shell: pwsh
        run: |
          Write-Host "[BUILD] Verifying x86-constrained packages..."

          # CRITICAL: These must match the versions installed in the previous step
          $expectedVersions = @{
            'sqlalchemy' = '1.4.46'  # ‚úÖ FIXED: Match installed version
            'greenlet' = '1.1.2'     # ‚úÖ FIXED: Match installed version
            'pandas' = '1.5.3'
            'numpy' = '1.23.5'
            'scipy' = '1.10.1'
          }

          $allVerified = $true

          foreach ($pkg in $expectedVersions.Keys) {
            $expectedVersion = $expectedVersions[$pkg]

            # Get installed version
            $installedVersion = pip show $pkg 2>&1 | Select-String "Version:" | ForEach-Object { $_.Line -replace 'Version: ', '' }

            if (-not $installedVersion) {
              Write-Error "‚ùå Package '$pkg' not installed!"
              $allVerified = $false
              continue
            }

            # Trim whitespace for comparison
            $installedVersion = $installedVersion.Trim()
            $expectedVersion = $expectedVersion.Trim()

            if ($installedVersion -ne $expectedVersion) {
              Write-Error "‚ùå Package '$pkg' has wrong version: $installedVersion (expected $expectedVersion)"
              $allVerified = $false
            } else {
              Write-Host "‚úÖ $pkg==$installedVersion"
            }
          }

          if (-not $allVerified) {
            throw "[BUILD] ‚ùå x86 package verification failed"
          }

          Write-Host "[BUILD] ‚úÖ All x86 packages verified"
      - name: üî¨ Diagnostic - Verify wheel installation method
        shell: pwsh
        run: |
          Write-Host "[DIAGNOSTIC] Checking installation metadata for x86 packages..."

          $packages = @('sqlalchemy', 'greenlet')

          foreach ($pkg in $packages) {
            $location = pip show $pkg 2>&1 | Select-String "Location:" | ForEach-Object { $_.Line -replace 'Location: ', '' }

            if ($location) {
              $location = $location.Trim()
              Write-Host "Package: $pkg"
              Write-Host "  Location: $location"

              # Find the .dist-info directory
              $distInfo = Get-ChildItem -Path $location -Directory -Filter "${pkg}*.dist-info" -ErrorAction SilentlyContinue | Select-Object -First 1

              if ($distInfo) {
                Write-Host "  .dist-info: $($distInfo.Name)"

                # Check for WHEEL file (proves it was a wheel installation)
                $wheelFile = Join-Path $distInfo.FullName "WHEEL"
                if (Test-Path $wheelFile) {
                  $wheelContent = Get-Content $wheelFile -Raw
                  Write-Host "  ‚úÖ Installed from wheel (WHEEL file exists)"

                  # Extract wheel tag
                  if ($wheelContent -match "Tag: ([^\r\n]+)") {
                    Write-Host "  Wheel tag: $($Matches[1])"
                  }
                } else {
                  Write-Warning "  ‚ö†Ô∏è  No WHEEL file found - might be source install"
                }

                # Check for INSTALLER file
                $installerFile = Join-Path $distInfo.FullName "INSTALLER"
                if (Test-Path $installerFile) {
                  $installer = Get-Content $installerFile -Raw
                  Write-Host "  Installer: $installer"
                }
              } else {
                Write-Warning "  ‚ö†Ô∏è  No .dist-info directory found for $pkg"
              }

              Write-Host ""
            }
          }
      - name: Build Backend (PyInstaller)
        if: steps.cache-pyi-build.outputs.cache-hit != 'true'
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean --log-level INFO fortuna-unified.spec
      - name: üîç Sanity Check Executable
        shell: pwsh
        run: |
          dist/fortuna-core-service/fortuna-core-service.exe --help
      - name: Upload Backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/fortuna-core-service/

  package-msi:
    name: 'üíø Package MSI (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: build-backend
    timeout-minutes: 30
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: staging/backend

      - name: 'üîê Verify Backend Executable Hash'
        shell: pwsh
        run: |
          $exePath = "staging/backend/fortuna-core-service.exe"
          if (Test-Path $exePath) {
            $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash
            Write-Host "‚úÖ SHA-256 of fortuna-core-service.exe: $hash"
          } else {
            throw "‚ùå Backend executable not found at $exePath"
          }

      - name: '‚öñÔ∏è The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $target = "staging"
          $limitMB = 300
          Write-Host "--- üìä Size Breakdown ---"
          $files = Get-ChildItem -Path $target -Recurse -File -ErrorAction SilentlyContinue
          if (!$files) { Write-Warning "No files found to weigh."; exit 0 }
          $totalBytes = ($files | Measure-Object -Property Length -Sum).Sum
          $totalMB = [math]::Round($totalBytes / 1MB, 2)
          Write-Host "Total Payload Size: $totalMB MB"
          if ($totalMB -gt $limitMB) {
              Write-Warning "‚ö†Ô∏è BLOAT ALERT: Build exceeds $limitMB MB limit! Check the heaviest files below."
          } else {
              Write-Host "‚úÖ Size within limits (< $limitMB MB)." -ForegroundColor Green
          }
          Write-Host "`n--- üêò Top 10 Heaviest Files ---"
          $files | Sort-Object Length -Descending | Select-Object -First 10 @{N='File';E={$_.FullName.Replace($pwd,'')}}, @{N='Size(MB)';E={"{0:N2}" -f ($_.Length/1MB)}} | Format-Table -AutoSize

      - name: Create Restart Service Batch Script
        shell: pwsh
        run: |
          $scriptContent = "@echo off`r`necho Requesting Admin privileges to restart fortuna-core-service...`r`nnet stop fortuna-core-service`r`nnet start fortuna-core-service`r`necho Service Restarted.`r`npause"
          Set-Content -Path "staging/backend/restart_service.bat" -Value $scriptContent -Encoding Ascii
          Write-Host "‚úÖ Created restart_service.bat script."

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üìÑ Ensure WiX License Exists
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          $licensePath = 'build_wix/license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder...'
            # FIX: Use Base64 decoding to avoid RTF escape sequence issues in PowerShell/YAML
            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String("e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0="))
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: Prepare WiX
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          Copy-Item build_wix/Product_WebService.wxs build_wix/Product.wxs -Force
          $wxsPath = 'build_wix/Product.wxs'
          $wxsContent = [xml](Get-Content $wxsPath -Raw)
          $serviceControl = $wxsContent.SelectSingleNode("//*[local-name()='ServiceControl']")
          if ($serviceControl -and $serviceControl.HasAttribute("Start")) {
              $serviceControl.RemoveAttribute("Start")
              $wxsContent.Save($wxsPath)
              Write-Host "‚úÖ Dynamically removed 'Start=install' attribute from WiX template."
          }
          $sourceDir = "staging/backend"
          $distDir = "staging/backend/fortuna-core-service" # PyInstaller one-dir output
          $targetExe = "fortuna-webservice.exe"

          if (Test-Path $distDir) {
            Write-Host "PyInstaller 'onedir' output found. Staging entire directory..."
            # Move all files from the 'dist' folder up one level
            Move-Item -Path (Join-Path $distDir "*") -Destination $sourceDir -Force
            # Clean up the now-empty dist directory
            Remove-Item $distDir -Recurse -Force
            # Rename the main executable for WiX
            Rename-Item -Path (Join-Path $sourceDir "fortuna-core-service.exe") -NewName $targetExe -Force
            Write-Host "‚úÖ Staging complete for WiX."
          } else {
            Write-Host "##[error]Could not find fortuna-backend.exe in expected locations."
            Write-Host "Listing contents of staging directory for forensics:"
            Get-ChildItem -Path "staging" -Recurse
            exit 1
          }
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64;x86</Platforms>',
            '    <!-- Platform is set via -p:Platform in build command, NOT in DefineConstants -->',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content build_wix/Fortuna.wixproj ($proj -join "`r`n") -Encoding utf8
      - name: Build MSI
        working-directory: build_wix
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=${{ matrix.arch }} -p:Version="${{ needs.build-backend.outputs.semver }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.SERVICE_PORT }}"
      - name: Rename & Hash MSI
        run: |
          $ver = "${{ needs.build-backend.outputs.semver }}"
          $releaseDir = "build_wix/bin/${{ matrix.arch }}/Release"
          $msiFound = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select-Object -First 1
          if (-not $msiFound) { throw "MSI not found in $releaseDir" }
          $targetName = "HatTrickFusion-${{ matrix.arch }}-${ver}.msi"
          $newPath = Join-Path $releaseDir $targetName
          Move-Item -Path $msiFound.FullName -Destination $newPath -Force
          Write-Host "‚úÖ MSI Ready: $targetName"
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: hat-trick-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: build_wix/bin/${{ matrix.arch }}/Release/*

      - name: üìù Generate Job Summary
        shell: pwsh
        run: |
          $ver = "${{ needs.build-backend.outputs.semver }}"
          $targetName = "HatTrickFusion-${{ matrix.arch }}-${ver}.msi"
          $hash = (Get-FileHash "build_wix/bin/${{ matrix.arch }}/Release/$targetName").Hash
          echo "### üì¶ Build Summary (`${{ matrix.arch }}`)" >> $env:GITHUB_STEP_SUMMARY
          echo "| File | Version | SHA-256 |" >> $env:GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $env:GITHUB_STEP_SUMMARY
          echo "| `$targetName` | `$ver` | `$hash` |" >> $env:GITHUB_STEP_SUMMARY

  generate-sbom:
    name: 'üìú Generate SBOM (${{ matrix.arch }})'
    runs-on: ubuntu-latest
    needs: [build-backend]
    timeout-minutes: 30
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: backend
      - name: Create SBOM
        uses: anchore/sbom-action@v0
        with:
          path: backend
          artifact-name: sbom-${{ matrix.arch }}-${{ github.run_id }}
          format: spdx-json

  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: package-msi
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: hat-trick-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: msi-installer
      - name: üî• Smoke Test
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $msiPath = (Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1).FullName
          if (-not $msiPath) { throw "MSI not found!" }
          Write-Host "Found MSI at $msiPath"

          # 1. PRE-INSTALL CLEANUP
          Write-Host "Attempting pre-emptive service removal..."
          $service = Get-Service -Name "FortunaWebService" -ErrorAction SilentlyContinue
          if ($service) {
            sc.exe delete "FortunaWebService"
            Start-Sleep -Seconds 5
          }

          # 2. INSTALL
          $logFile = "msi-install.log"
          $msiArgs = "/i `"$msiPath`" /qn /L*v `"$logFile`""
          Write-Host "Running: msiexec.exe $msiArgs"
          $proc = Start-Process msiexec.exe -ArgumentList $msiArgs -Wait -PassThru
          if ($proc.ExitCode -ne 0 -and $proc.ExitCode -ne 3010) {
            Get-Content $logFile -Tail 50
            throw "MSI installation failed with exit code $($proc.ExitCode)."
          }
          Write-Host "‚úÖ MSI Installation successful."

          # 3. VERIFY & RUN
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet Service"
          if (-not (Test-Path $installDir)) { throw "Installation directory not found!" }
          New-Item -ItemType Directory -Path (Join-Path $installDir "data") -Force | Out-Null
          New-Item -ItemType Directory -Path (Join-Path $installDir "json") -Force | Out-Null
          New-Item -ItemType Directory -Path (Join-Path $installDir "logs") -Force | Out-Null
          Start-Service -Name "FortunaWebService" -ErrorAction Stop
          Start-Sleep -Seconds 10

          # 4. HEALTH CHECK
          $maxRetries = 5
          $delay = 5
          For ($i=0; $i -lt $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:${{ env.SERVICE_PORT }}/health" -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check PASSED."
                Stop-Service -Name "FortunaWebService"
                exit 0
              }
            } catch { Write-Host "Attempt $($i+1) failed. Retrying in $delay seconds..." }
            Start-Sleep -Seconds $delay
          }
          throw "Health check failed after $maxRetries attempts."
      - name: 'üïµÔ∏è CSI: Windows Post-Mortem (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Get-Process | Where-Object { $_.ProcessName -match "fortuna" }
          Get-EventLog -LogName Application -Newest 50 -EntryType Error,Warning
