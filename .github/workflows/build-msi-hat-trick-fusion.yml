# System Timestamp: 2025-12-07 14:00:00
name: HatTrick Fusion (Perfected)
on:
  workflow_dispatch:
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8102'
  FRONTEND_PORT: '3000'
  MSI_NAME: 'HatTrickFusion.msi'
  FIREWALL_RULE: 'HatTrickFusion-Port'
  UPGRADE_CODE: 'FA689549-366B-4C5C-A482-1132F9A34B10'
  FORTUNA_PORT: '8102'
  # Mock API keys for service startup
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  # 1. Build Frontend First (so Backend can bundle it)
  build-frontend:
    name: Build Frontend
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      - name: Install and Build
        run: |
          cd web_platform/frontend
          npm ci --prefer-offline --no-audit --no-fund
          npm run build
      - name: Upload Frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web_platform/frontend/out

  # 2. Build Backend (Downloads Frontend to bundle it)
  build-backend:
    name: Build Backend Binary
    runs-on: windows-latest
    needs: build-frontend
    timeout-minutes: 30
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      backend-dir: ${{ steps.meta.outputs.backend_dir }}
    steps:
      - uses: actions/checkout@v4

      # Download Frontend for bundling
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: web_platform/frontend/out

      - id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_dir=web_service/backend" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "module_path=web_service.backend" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r ${{ steps.meta.outputs.backend_dir }}/requirements.txt
          pip install pyinstaller==6.6.0

      - name: Build Backend (PyInstaller)
        run: |
          # FIX: Target service_entry.py and include win32timezone
          pyinstaller --noconfirm --onedir --clean --name fortuna-webservice --hidden-import=win32timezone --hidden-import=win32serviceutil --add-data "web_service/backend;backend" web_service/backend/service_entry.py

      - name: Upload Backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: dist/fortuna-backend.exe

  package-msi:
    name: Package MSI
    runs-on: windows-latest
    needs: build-backend
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: staging/backend

      - name: Create Restart Service Batch Script
        shell: pwsh
        run: |
          $scriptContent = @"
          @echo off
          echo Requesting Admin privileges to restart FortunaWebService...
          net stop FortunaWebService
          net start FortunaWebService
          echo Service Restarted.
          pause
          "@
          Set-Content -Path "staging/backend/restart_service.bat" -Value $scriptContent -Encoding Ascii
          Write-Host "‚úÖ Created restart_service.bat script."

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üìÑ Ensure WiX License Exists
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          $licensePath = 'build_wix/license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder...'
            # FIX: Use Base64 decoding to avoid RTF escape sequence issues in PowerShell/YAML
            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String("e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0="))
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: Prepare WiX
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }

          # Copy template
          Copy-Item build_wix/Product_WithService.wxs build_wix/Product.wxs -Force

          # Dynamically remove the problematic Start="install" attribute
          $wxsPath = 'build_wix/Product.wxs'
          $wxsContent = [xml](Get-Content $wxsPath -Raw)
          $serviceControl = $wxsContent.SelectSingleNode("//*[local-name()='ServiceControl']")
          if ($serviceControl -and $serviceControl.HasAttribute("Start")) {
              $serviceControl.RemoveAttribute("Start")
              $wxsContent.Save($wxsPath)
              Write-Host "‚úÖ Dynamically removed 'Start=install' attribute from WiX template."
          }

          # Stage Executable
          if (Test-Path staging/backend/fortuna-backend.exe) {
            Move-Item staging/backend/fortuna-backend.exe staging/backend/fortuna-webservice.exe -Force
          }

          # FIX: Generate Valid .wixproj with Extensions
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content build_wix/Fortuna.wixproj ($proj -join "`r`n") -Encoding utf8

      - name: üî¨ Forensic Packaging Analysis
        shell: pwsh
        run: |
          Write-Host "=== STAGING DIRECTORY MANIFEST ==="
          Get-ChildItem -Path staging -Recurse | Sort-Object Length | Format-Table FullName, Length, LastWriteTime -AutoSize

          Write-Host "=== CRITICAL FILE CHECK ==="
          $critical = @("fortuna-webservice.exe", "restart_service.bat")
          foreach ($file in $critical) {
            $found = Get-ChildItem -Path staging -Recurse -Filter $file
            if ($found) { Write-Host "‚úÖ FOUND: $file" -ForegroundColor Green }
            else { Write-Host "‚ùå MISSING: $file" -ForegroundColor Red }
          }
      - name: Build MSI
        working-directory: build_wix
        run: dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version="${{ needs.build-backend.outputs.semver }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.SERVICE_PORT }}"

      - name: 'üê§ The Canary (Malware Pre-Flight)'
        shell: pwsh
        continue-on-error: true
        run: |
          $msi = Get-ChildItem -Recurse -Filter "*.msi" | Select-Object -First 1
          if (!$msi) { Write-Warning "No MSI found to scan."; exit 0 }

          Write-Host "üîç Scanning $($msi.Name) with Windows Defender..."
          $defender = "C:\Program Files\Windows Defender\MpCmdRun.exe"

          if (-not (Test-Path $defender)) {
              Write-Warning "Windows Defender CLI not found at expected path."
              exit 0
          }

          # ScanType 3 = File/Custom Scan
          $proc = Start-Process -FilePath $defender -ArgumentList "-Scan -ScanType 3 -File `"$($msi.FullName)`"" -Wait -PassThru -NoNewWindow

          if ($proc.ExitCode -eq 0) {
              Write-Host "‚úÖ CLEAN: Windows Defender found no threats." -ForegroundColor Green
          } elseif ($proc.ExitCode -eq 2) {
              Write-Error "üö® THREAT DETECTED: Windows Defender flagged this installer!"
              exit 1
          } else {
              Write-Warning "‚ö†Ô∏è Scan completed with inconclusive exit code: $($proc.ExitCode)"
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: hat-trick-msi
          path: build_wix/bin/x64/Release/

  smoke-test:
    name: 'üî¨ Smoke Test'
    needs: package-msi
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}
          path: installer
      - name: üõ°Ô∏è Firewall & Install
        shell: pwsh
        run: |
          New-NetFirewallRule -DisplayName "${{ env.FIREWALL_RULE }}" -Direction Inbound -LocalPort ${{ env.FORTUNA_PORT }} -Protocol TCP -Action Allow
          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {
            sc.exe stop FortunaWebService 2>&1 | Out-Null
            sc.exe delete FortunaWebService 2>&1 | Out-Null
          }
          $msi = Get-ChildItem installer -Filter "*.msi" -Recurse | Select -First 1
          if (!$msi) { throw "No MSI found" }
          Write-Host "Installing $($msi.Name)..."
          $msiPath = $msi.FullName
          $args = "/i `"$msiPath`" /qn /L*v installation.log"
          $proc = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru
          if ($proc.ExitCode -ne 0) {
            Get-Content install.log -Tail 50
            throw "Install failed with code $($proc.ExitCode)"
          }

      # üîç STEP 1: VERIFY FILES EXIST
      - name: "üîç Diag 1: Verify Install Directory"
        shell: pwsh
        run: |
          $expected = "C:\Program Files\Fortuna Faucet Service\fortuna-webservice.exe"
          if (Test-Path $expected) {
            Write-Host "‚úÖ Binary FOUND at: $expected"
          } else {
            Write-Error "‚ùå Binary MISSING at: $expected"
            Write-Host "Listing C:\Program Files to see what happened:"
            Get-ChildItem "C:\Program Files" -Recurse -Depth 2 | Select-Object FullName
            exit 1
          }

      # üîç STEP 2: VERIFY SERVICE STATE
      - name: "üîç Diag 2: Check Windows Service Status"
        shell: pwsh
        run: |
          $svc = Get-Service "FortunaWebService" -ErrorAction SilentlyContinue
          if (!$svc) {
            Write-Error "‚ùå Service 'FortunaWebService' is NOT registered! MSI Install failed to register service."
            exit 1
          }
          Write-Host "Service Status: $($svc.Status)"

          if ($svc.Status -ne 'Running') {
            Write-Host "‚ö†Ô∏è Service is not running. Attempting to start..."
            Start-Service "FortunaWebService"
            Start-Sleep -Seconds 5
            $svc = Get-Service "FortunaWebService"
          }

          if ($svc.Status -eq 'Running') {
            Write-Host "‚úÖ Service is RUNNING"
          } else {
            Write-Error "‚ùå Service failed to start. Status: $($svc.Status)"
            Write-Host "Dumping Event Logs for Service Failure:"
            Get-EventLog -LogName System -Source "Service Control Manager" -Newest 20 | Format-Table -AutoSize
            exit 1
          }

      # üîç STEP 3: THE PORT LOOP (Replaces 'Loop 2')
      - name: "üîç Diag 3: Port 8102 Listener Check"
        shell: pwsh
        run: |
          Write-Host "Starting Port Hunt on 8102..."
          $max = 30
          for ($i=1; $i -le $max; $i++) {
            $conn = Get-NetTCPConnection -LocalPort 8102 -ErrorAction SilentlyContinue
            if ($conn) {
              Write-Host "‚úÖ Port 8102 is OPEN (State: $($conn.State))"
              exit 0
            }
            Write-Host "‚è≥ Attempt $i of $max: Port not open yet..."
            Start-Sleep -Seconds 2
          }
          Write-Error "‚ùå Timeout: Nothing is listening on Port 8102 after 60 seconds."
          Write-Host "Checking for ANY python/fortuna processes:"
          Get-Process | Where-Object { $_.ProcessName -match "fortuna|python" } | Format-Table Id, ProcessName, Responding
          exit 1

      # üîç STEP 4: FINAL API PROBE
      - name: "üîç Diag 4: HTTP Health Probe"
        shell: pwsh
        run: |
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8102/health" -UseBasicParsing
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ HTTP 200 OK received. System is GREEN."
              Write-Host $response.Content
            } else {
              Write-Error "‚ùå HTTP Error: $($response.StatusCode)"
              exit 1
            }
          } catch {
            Write-Error "‚ùå HTTP Request Failed: $_"
            exit 1
          }

      - name: 'üì∏ The Paparazzi (Visual Proof)'
        shell: pwsh
        run: |
          Write-Host "Installing Playwright..."
          npm install playwright
          npx playwright install chromium --with-deps

          $port = "${{ env.FORTUNA_PORT }}"
          $url = "http://127.0.0.1:$port/docs"

          node -e "
            const { chromium } = require('playwright');
            (async () => {
              try {
                const browser = await chromium.launch();
                const page = await browser.newPage();
                console.log('Navigating to $url...');
                await page.goto('$url', { timeout: 15000 });
                await page.waitForSelector('.swagger-ui', { timeout: 5000 }).catch(() => console.log('UI not fully loaded, snapping anyway...'));
                await page.screenshot({ path: 'proof-of-life.png', fullPage: true });
                console.log('‚úÖ Screenshot captured: proof-of-life.png');
                await browser.close();
              } catch (e) {
                console.error(e); process.exit(1);
              }
            })();
          "

      - name: Upload Visual Proof
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-proof-${{ github.run_id }}
          path: proof-of-life.png

      - name: üßπ Cleanup
        if: always()
        run: |
          sc.exe stop FortunaWebService
          sc.exe delete FortunaWebService
          Remove-NetFirewallRule -DisplayName "${{ env.FIREWALL_RULE }}" -ErrorAction SilentlyContinue
