name: Build Monolith (Final)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: 'Build Fortuna Monolith'
    runs-on: windows-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      # ========== FRONTEND ==========
      - name: üé® Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üßπ Clean Previous Builds
        working-directory: ./web_service/frontend
        shell: pwsh
        run: |
          Remove-Item -Path "public" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path ".next" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Cleaned"

      - name: üìã Check Next.js Config
        working-directory: ./web_service/frontend
        shell: pwsh
        run: |
          Write-Host "Checking package.json..."
          if (Test-Path "package.json") {
            $pkg = Get-Content package.json | ConvertFrom-Json
            Write-Host "  name: $($pkg.name)"
            Write-Host "  build: $($pkg.scripts.build)"
          } else {
            Write-Error "package.json not found!"
            exit 1
          }

      - name: üèóÔ∏è Build Frontend
        working-directory: ./web_service/frontend
        shell: pwsh
        run: |
          Write-Host "=== BUILDING FRONTEND ===" -ForegroundColor Cyan

          # Create/verify next.config.js
          $configLines = @(
            "/** @type {import('next').NextConfig} */",
            "const nextConfig = {",
            "  output: 'export',",
            "  distDir: 'build',",
            "  images: { unoptimized: true },",
            "  trailingSlash: true,",
            "}",
            "module.exports = nextConfig"
          )
          $configContent = $configLines -join [System.Environment]::NewLine
          Set-Content -Path "next.config.js" -Value $configContent -Encoding UTF8
          Write-Host "‚úÖ next.config.js set for 'build' directory output"

          Write-Host "Installing dependencies..."
          npm install --legacy-peer-deps
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm install failed"
            exit 1
          }

          Write-Host "Building..."
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Error "npm run build failed"
            exit 1
          }

          Write-Host "Moving build artifacts to 'public'..."
          New-Item -ItemType Directory -Force -Path "public" | Out-Null
          Move-Item -Path "build/*" -Destination "public" -Force
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to move build artifacts"
            exit 1
          }
          Write-Host "‚úÖ Artifacts moved."

          # Verify output
          Write-Host "`nVerifying output..."
          if (-not (Test-Path "public")) {
            Write-Host "‚ùå 'public' directory not found!" -ForegroundColor Red
            Write-Host "Contents of current dir:"
            Get-ChildItem | Format-Table Name
            exit 1
          }

          if (-not (Test-Path "public/index.html")) {
            Write-Host "‚ùå public/index.html not found!" -ForegroundColor Red
            Write-Host "Contents of 'public':"
            Get-ChildItem -Path "public" -Recurse | Format-Table Name
            exit 1
          }

          $count = (Get-ChildItem -Path "public" -Recurse -File).Count
          Write-Host "‚úÖ Frontend built: $count files" -ForegroundColor Green

      # ========== BACKEND ==========
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'

      - name: üì¶ Install Python Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install pyinstaller==6.6.0
          pip install pywin32 # CRITICAL: Provides the 'win32timezone' hidden import
          pip install -r web_service/backend/requirements.txt

      - name: üìÇ Create Data Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/json" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/logs" | Out-Null

      # ========== BUILD ==========
      - name: üî® Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== BUILDING MONOLITH ===" -ForegroundColor Cyan

          # Final verification
          if (-not (Test-Path "web_service/frontend/public/index.html")) {
            Write-Error "‚ùå Frontend not ready!"
            Write-Host "Frontend path check:"
            Test-Path "web_service/frontend/public"
            Test-Path "web_service/frontend/public/index.html"
            exit 1
          }

          Write-Host "‚úÖ Frontend verified"
          Write-Host "Running PyInstaller..."

          pyinstaller --noconfirm --clean fortuna-desktop.spec 2>&1 | Tee-Object -FilePath "build.log"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "Last 100 lines of build.log:" -ForegroundColor Red
            Get-Content "build.log" -Tail 100
            exit 1
          }

          $exe = "dist/Fortuna-Desktop/Fortuna-Desktop.exe"
          if (Test-Path $exe) {
            $mb = (Get-Item $exe).Length / 1MB
            Write-Host "‚úÖ BUILD SUCCESS: $([math]::Round($mb, 2)) MB" -ForegroundColor Green
          } else {
            Write-Error "EXE not created!"
            exit 1
          }

      # ========== PACKAGE & UPLOAD ==========
      - name: üì¶ Package Artifact for Distribution
        shell: pwsh
        run: |
          $distDir = "dist/Fortuna-Desktop"
          Write-Host "=== PACKAGING ARTIFACT ===" -ForegroundColor Cyan

          # Create README.txt
          $readmeLines = @(
            'Fortuna Desktop - User Guide',
            '',
            '**HOW TO RUN**',
            '1. Double-click "Fortuna-Desktop.exe".',
            '2. The application window will open and the dashboard will load.',
            '',
            '**WHAT TO EXPECT**',
            '- To stop the application, simply close the window.'
          )
          $readmeLines | Out-File -FilePath "$distDir/README.txt" -Encoding utf8
          Write-Host "‚úÖ Created README.txt"

          # Create ZIP archive
          $zipFileName = "Fortuna-Desktop-Windows-${{ github.run_number }}.zip"
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipFileName -Force
          Write-Host "‚úÖ Created $zipFileName" -ForegroundColor Green

      - name: üì§ Upload Packaged Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fortuna-Desktop-Windows-${{ github.run_number }}
          path: Fortuna-Desktop-Windows-${{ github.run_number }}.zip
          if-no-files-found: error

      # ========== TEST ==========
      - name: Install VC++ Redistributable
        shell: pwsh
        run: |
          # Download and install VC++ Runtime
          $url = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
          Invoke-WebRequest -Uri $url -OutFile vc_redist.x64.exe
          .\vc_redist.x64.exe /install /quiet /norestart

      - name: üß™ Smoke Test
        continue-on-error: true
        shell: pwsh
        timeout-minutes: 5
        run: |
          Write-Host "=== SMOKE TEST ===" -ForegroundColor Cyan
          $distDir = "dist/Fortuna-Desktop"
          $exe = "$distDir/Fortuna-Desktop.exe"
          $outputLog = "$distDir/smoke-test-output.log"
          $internalLog = "$distDir/fortuna-desktop.log" # Assumes log is named after exe

          Write-Host "--- 1. Directory Manifest ---" -ForegroundColor Yellow
          Get-ChildItem -Path $distDir -Recurse | Format-Table Name, Length
          if (-not (Test-Path $exe)) {
            Write-Error "FATAL: Executable not found at $exe"
            exit 1
          }

          Write-Host "--- 2. Network State Dump ---" -ForegroundColor Yellow
          netstat -ano
          Write-Host "--- End of Network State ---"

          Write-Host "--- 3. Starting Executable ---" -ForegroundColor Yellow
          Write-Host "Starting: $exe"
          cmd /c "start /b `"$exe`" > `"$outputLog`" 2>&1"
          Start-Sleep -Seconds 10 # Increased wait for GUI app

          $proc = Get-Process -Name "Fortuna-Desktop" -ErrorAction SilentlyContinue
          if (-not $proc) {
              Write-Host "‚ùå Process failed to start!" -ForegroundColor Red
              # Failure analysis will run at the end
              $success = $false
          } else {
              Write-Host "PID: $($proc.Id). Waiting up to 45 seconds for health check..."
              $success = $false
              for ($i = 1; $i -le 45; $i++) {
                  if ($proc.HasExited) {
                      Write-Host "‚ùå Process exited prematurely (code: $($proc.ExitCode))" -ForegroundColor Red
                      break
                  }
                  try {
                      $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing -TimeoutSec 1 -ErrorAction Stop
                      if ($response.StatusCode -eq 200) {
                          Write-Host "‚úÖ SMOKE TEST PASSED!" -ForegroundColor Green
                          $success = $true
                          break
                      }
                  } catch {
                      Write-Host "Health check attempt $i failed. Retrying... Error: $($_.Exception.Message)"
                      Start-Sleep -Seconds 1
                  }
              }
          }

          # --- Cleanup ---
          if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          }

          # --- Final Verdict & Diagnostics ---
          if ($success) {
            Write-Host "Smoke test SUCCEEDED."
            exit 0
          } else {
            Write-Error "SMOKE TEST FAILED."

            Write-Host "--- 4. Failure Analysis ---" -ForegroundColor Yellow
            if (Test-Path $outputLog) {
                Write-Host "--- Displaying startup output log (smoke-test-output.log) ---"
                Get-Content $outputLog -ErrorAction SilentlyContinue
            } else {
                Write-Host "--- WARNING: Startup output log not found! ($outputLog) ---"
            }

            if (Test-Path $internalLog) {
                Write-Host "--- Displaying internal application log (fortuna-monolith.log) ---"
                Get-Content $internalLog -ErrorAction SilentlyContinue
            } else {
                Write-Host "--- WARNING: Internal application log not found! ($internalLog) ---"
                Write-Host "This usually means the application crashed before it could initialize its logging."
            }
            exit 1
          }

      - name: üìã Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.run_number }}
          path: build.log
          if-no-files-found: ignore
