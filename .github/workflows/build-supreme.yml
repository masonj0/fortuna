name: ðŸš€ Supreme Combo Build (MSI)

on:
  push:
    branches: [main]
    tags: [v*]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: Skip heavy tests?
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8102'

  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

# =========================================================
# PHASE 1: PREFLIGHT
# =========================================================
jobs:
  preflight-check:
    name: ðŸ” System & Asset Preflight
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.version.outputs.semver }}
      build_id: ${{ steps.version.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Derive Version
        id: version
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $tag = git describe --tags --abbrev=0 2>$null
          if (-not $tag) { $tag = "v0.0.0" }
          $tag = $tag -replace '^v',''
          "semver=$tag" >> $env:GITHUB_OUTPUT
          "build_id=${{ github.run_number }}" >> $env:GITHUB_OUTPUT
          Write-Host "âœ… Version: $tag.${{ github.run_number }}"

      - name: ðŸ”Ž Asset Integrity
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $files = @(
            "web_platform/frontend/package.json",
            "web_service/backend/requirements.txt",
            "build_wix/Product_WithService.wxs"
          )
          foreach ($f in $files) {
            if (-not (Test-Path $f)) {
              throw "âŒ Missing required file: $f"
            }
            Write-Host "âœ… Verified $f"
          }

# =========================================================
# PHASE 2: FRONTEND
# =========================================================
  build-frontend:
    name: âš›ï¸ Build Frontend
    runs-on: windows-latest
    needs: preflight-check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web_platform/frontend/package-lock.json

      - name: ðŸ—ï¸ Build UI
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out
          retention-days: 1

# =========================================================
# PHASE 2: BACKEND (MATRIX)
# =========================================================
  build-backend:
    name: ðŸ Backend (${{ matrix.arch }})
    runs-on: windows-latest
    needs: build-frontend
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, x86]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web_platform/frontend/out

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: pip

      - name: ðŸ§¾ Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $file = "constraints.txt"
          if ("${{ matrix.arch }}" -eq "x86") {
            "numpy==1.23.5`r`npandas==1.5.3" | Set-Content $file
          } else {
            New-Item $file -ItemType File -Force | Out-Null
          }
          "file=$file" >> $env:GITHUB_OUTPUT

      - name: ðŸ“¦ Install Deps
        run: |
          pip install -r web_service/backend/requirements.txt -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller

      - name: ðŸ§ª Compile Gate
        if: matrix.arch == 'x64' && inputs.skip_tests != true
        run: python -m compileall web_service/backend -q

      - name: ðŸ—ï¸ PyInstaller Build
        shell: pwsh
        run: |
          pyinstaller --noconfirm --onedir --clean `
            --name fortuna-backend `
            --hidden-import win32timezone `
            --hidden-import win32serviceutil `
            --hidden-import win32service `
            --hidden-import win32event `
            --add-data "web_service/backend;backend" `
            --add-data "web_platform/frontend/out;ui" `
            web_service/backend/service_entry.py

      - uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: dist/fortuna-backend
          retention-days: 1

# =========================================================
# PHASE 3: MSI
# =========================================================
  package-msi:
    name: ðŸ“¦ MSI (${{ matrix.arch }})
    runs-on: windows-latest
    needs: build-backend
    strategy:
      matrix:
        arch: [x64, x86]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: staging/backend

      - name: ðŸ”§ Setup WiX
        run: |
          dotnet tool install --global wix --version ${{ env.WIX_VERSION }}
          echo "$env:USERPROFILE\.dotnet\tools" >> $env:GITHUB_PATH

      - name: ðŸ—ï¸ Build MSI
        shell: pwsh
        run: |
          wix build build_wix/Product_WithService.wxs `
            -arch ${{ matrix.arch }} `
            -o Fortuna-${{ matrix.arch }}.msi `
            -d Version="${{ needs.preflight-check.outputs.semver }}" `
            -d SourceDir="staging"

      - name: âœ… Verify MSI
        shell: pwsh
        run: |
          if (-not (Test-Path "Fortuna-${{ matrix.arch }}.msi")) {
            throw "âŒ MSI not produced"
          }

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: Fortuna-${{ matrix.arch }}.msi

# =========================================================
# PHASE 4: SMOKE
# =========================================================
  smoke-test:
    name: ðŸš¬ Smoke (${{ matrix.arch }})
    runs-on: windows-latest
    needs: package-msi
    strategy:
      matrix:
        arch: [x64, x86]

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}

      - name: ðŸ’¿ Install
        shell: pwsh
        run: |
          Start-Process msiexec.exe -ArgumentList "/i Fortuna-${{ matrix.arch }}.msi /quiet /norestart" -Wait
          Start-Sleep 10

      - name: ðŸ©º Health
        shell: pwsh
        run: |
          for ($i=0; $i -lt 6; $i++) {
            try {
              $r = Invoke-RestMethod "http://127.0.0.1:${{ env.SERVICE_PORT }}/health"
              if ($r.status -eq "ok") { exit 0 }
            } catch {}
            Start-Sleep 5
          }
          throw "âŒ Service unhealthy"

# =========================================================
# PHASE 5: RELEASE
# =========================================================
  release:
    name: ðŸš€ Release
    runs-on: ubuntu-latest
    needs: smoke-test
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: msi-*
          merge-multiple: true
          path: release

      - name: ðŸ” Checksums
        run: |
          cd release
          sha256sum *.msi > SHASUMS256.txt

      - uses: softprops/action-gh-release@v1
        with:
          files: release/*
          generate_release_notes: true
