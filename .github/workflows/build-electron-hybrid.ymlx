# System Timestamp: 2025-12-25 10:00:00
name:  üöÄ Build Electron MSI (Hybrid V12 Engine) - UNIFIED

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  BACKEND_DIR: 'web_service/backend'
  FRONTEND_DIR: 'web_platform/frontend'
  ELECTRON_DIR: 'electron'
  SERVICE_PORT: '8102'
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  build-core:
    name: '‚öôÔ∏è Build Core Components (${{ matrix.arch }})'
    runs-on: windows-2022
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      build_id: ${{ steps.meta.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
      - name: 'üîñ Metadata'
        id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_id=${{ github.run_id }}" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
      - name: 'üé® Build Frontend'
        shell: pwsh
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline
          npm run build
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'
      - name: 'üßæ Create Architecture Constraints'
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            "numpy==1.23.5`r`npandas==1.5.3`r`n--only-binary=:all:" | Set-Content $file
          } else {
            New-Item $file -ItemType File -Force
          }
          "file=$file" | Out-File $env:GITHUB_OUTPUT -Append
      - name: 'üì¶ Install Dependencies & Build Backend'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv pip install --system -r ${{ env.BACKEND_DIR }}/requirements.txt -c ${{ steps.constraints.outputs.file }}
          uv pip install --system pyinstaller==6.6.0 pywin32
          pyinstaller --noconfirm --clean --log-level INFO fortuna-backend-electron.spec
      - name: 'üì§ Upload Backend Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: python-backend-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/fortuna-backend
      - name: 'üì§ Upload Frontend Artifact'
        if: matrix.arch == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_DIR }}/out/
          retention-days: 1

  package-electron:
    name: '‚ö° Package Electron MSI (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: build-core
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.ELECTRON_DIR }}/package-lock.json'
      - name: 'üì• Download Backend Artifact'
        uses: actions/download-artifact@v4
        with:
          name: python-backend-${{ matrix.arch }}-${{ needs.build-core.outputs.build_id }}
          path: python-service-bin
      - name: 'üì• Download Frontend Artifact'
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.build-core.outputs.build_id }}
          path: ${{ env.FRONTEND_DIR }}/out
      - name: 'üé® Stage Frontend for Electron Builder'
        shell: pwsh
        run: |
          Copy-Item -Path "${{ env.FRONTEND_DIR }}/out/*" -Destination "${{ env.ELECTRON_DIR }}/out" -Recurse -Force
      - name: 'üöö Stage Backend for Electron Builder'
        shell: pwsh
        run: |
          Copy-Item -Path "python-service-bin/*" -Destination "${{ env.ELECTRON_DIR }}/resources/bin" -Recurse -Force
      - name: 'üìÑ Ensure WiX License Exists'
        shell: pwsh
        run: |
          if (-not (Test-Path 'build_wix/license.rtf')) {
            Set-Content -Path 'build_wix/license.rtf' -Value '{\rtf1\ansi Placeholder License}' -Encoding Ascii
          }
      - name: 'üèóÔ∏è Build MSI'
        working-directory: ${{ env.ELECTRON_DIR }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          npm ci --prefer-offline
          $ver = "${{ needs.build-core.outputs.semver }}"
          $arch_flag = if ('${{ matrix.arch }}' -eq 'x86') { '--ia32' } else { '--x64' }
          npm run dist -- --win msi $arch_flag --config electron-builder-config.yml --publish never --config.artifactName="Fortuna-Electron-Hybrid-${ver}-${{ matrix.arch }}.msi"
      - name: 'üì§ Upload MSI'
        uses: actions/upload-artifact@v4
        with:
          name: electron-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: ${{ env.ELECTRON_DIR }}/dist/*.msi

  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: package-electron
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: 'üì• Download MSI'
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: installer
      - name: 'ü§´ Install MSI & Verify'
        shell: pwsh
        run: |
          $msi = (Get-ChildItem "installer" -Filter "*.msi" -Recurse | Select -First 1).FullName
          Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /qn /L*v install.log" -Wait
          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { ${env:ProgramFiles} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          New-Item -Path "$installDir\data", "$installDir\json", "$installDir\logs" -ItemType Directory -Force | Out-Null
      - name: 'üöÄ Launch & Verify'
        shell: pwsh
        run: |
          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { ${env:ProgramFiles} }
          $installDir = Join-Path $progFiles "Fortuna Faucet"
          Start-Process -FilePath "$installDir\Fortuna Faucet.exe"
          Start-Sleep 15
          $parent = Get-Process -Name "Fortuna Faucet" -ErrorAction SilentlyContinue
          $child = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue
          if (-not $parent) { throw "Main process 'Fortuna Faucet' not found!" }
          if (-not $child) { throw "Backend process 'fortuna-backend' not found!" }
          $response = Invoke-WebRequest -Uri "http://localhost:${{ env.SERVICE_PORT }}/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) { throw "Service health check failed." }
      - name: Cleanup
        if: always()
        run: Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue
