name: Build Docker & Create Launcher Scripts

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-docker:
    permissions:
      contents: write
    name: 'Build Docker Image & Create Launchers'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ============================================================
      # STEP 1: Build Docker Image
      # ============================================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker Image (for local use)
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: fortuna-faucet:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ============================================================
      # STEP 2: Test the Container
      # ============================================================
      - name: Test Container Startup & Playwright Screenshot
        run: |
          echo "Starting container for health check..."
          docker run -d --name fortuna-test -p 8000:8000 fortuna-faucet:latest
          sleep 10
          echo "Container logs:"
          docker logs fortuna-test
          echo "Running health check..."
          curl -f http://localhost:8000/api/health || (docker logs fortuna-test && exit 1)
          echo "âœ“ Health check passed!"

          echo "Running Playwright Smoke Test..."
          sudo apt-get update && sudo apt-get install -y python3-pip
          pip3 install playwright
          playwright install --with-deps
          python3 e2e/jules-smoke-test.py
          echo "Playwright test finished."

          echo "Stopping container..."
          docker stop fortuna-test
          docker rm fortuna-test

      - name: Upload Playwright Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-screenshot-docker
          path: playwright-screenshot.png
          retention-days: 7

      # ============================================================
      # STEP 3: Create Windows Launcher Script (.bat file)
      # ============================================================
      - name: Create Windows Launcher Script
        shell: pwsh
        run: |
          $scriptContent = @'
          @echo off
          REM Fortuna Faucet - Docker Launcher for Windows
          REM This script starts Fortuna with Docker

          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘        ðŸ´ Fortuna Faucet Launcher ðŸ´        â•‘
          echo â•‘      Powered by Docker & Python FastAPI    â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.

          REM Check if Docker is installed
          docker --version >nul 2>&1
          if errorlevel 1 (
              echo âœ— ERROR: Docker is not installed!
              echo.
              echo Please install Docker Desktop from: https://www.docker.com/products/docker-desktop
              echo.
              pause
              exit /b 1
          )

          echo âœ“ Docker detected
          echo.

          REM Check if Docker daemon is running
          docker ps >nul 2>&1
          if errorlevel 1 (
              echo âœ— ERROR: Docker daemon is not running!
              echo.
              echo Please start Docker Desktop and try again.
              echo.
              pause
              exit /b 1
          )

          echo âœ“ Docker daemon is running
          echo.
          echo Pulling latest Fortuna image...
          docker pull masonj0/fortuna-faucet:latest

          if errorlevel 1 (
              echo.
              echo âœ— Failed to pull Docker image. Checking local image...
          )

          echo.
          echo Starting Fortuna container...
          echo.

          REM Stop any existing container
          docker stop fortuna-faucet >nul 2>&1
          docker rm fortuna-faucet >nul 2>&1

          REM Start the container
          docker run -d ^
            --name fortuna-faucet ^
            -p 8000:8000 ^
            -v %cd%/data:/app/web_service/backend/data ^
            -v %cd%/logs:/app/web_service/backend/logs ^
            masonj0/fortuna-faucet:latest

          if errorlevel 1 (
              echo âœ— Failed to start container
              pause
              exit /b 1
          )

          echo âœ“ Container started!
          echo.
          echo Waiting for application to initialize...
          timeout /t 5 /nobreak

          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘  ðŸŽ‰ Fortuna is running!                   â•‘
          echo â•‘                                            â•‘
          echo â•‘  Opening browser at:                       â•‘
          echo â•‘  http://localhost:8000                     â•‘
          echo â•‘                                            â•‘
          echo â•‘  Press Ctrl+C in Docker Desktop to stop   â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.

          REM Open browser
          start http://localhost:8000

          REM Show logs
          echo.
          echo Container logs:
          echo.
          docker logs -f fortuna-faucet
          '@

          Set-Content -Path "launcher.bat" -Value $scriptContent -Encoding ASCII
          Write-Host "âœ“ Created launcher.bat"

      # ============================================================
      # STEP 4: Create Mac/Linux Launcher Script (.sh file)
      # ============================================================
      - name: Create Mac/Linux Launcher Script
        run: |
          cat > launcher.sh << 'EOF'
          #!/bin/bash

          # Fortuna Faucet - Docker Launcher for Mac/Linux

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ðŸ´ Fortuna Faucet Launcher ðŸ´        â•‘"
          echo "â•‘      Powered by Docker & Python FastAPI    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
              echo "âœ— ERROR: Docker is not installed!"
              echo ""
              echo "Please install Docker from: https://www.docker.com/products/docker-desktop"
              echo ""
              exit 1
          fi

          echo "âœ“ Docker detected"
          echo ""

          # Check if Docker daemon is running
          if ! docker ps &> /dev/null; then
              echo "âœ— ERROR: Docker daemon is not running!"
              echo ""
              echo "Please start Docker and try again."
              echo ""
              exit 1
          fi

          echo "âœ“ Docker daemon is running"
          echo ""
          echo "Pulling latest Fortuna image..."
          docker pull masonj0/fortuna-faucet:latest

          echo ""
          echo "Starting Fortuna container..."
          echo ""

          # Stop any existing container
          docker stop fortuna-faucet 2>/dev/null
          docker rm fortuna-faucet 2>/dev/null

          # Create data directories
          mkdir -p data logs

          # Start the container
          docker run -d \
            --name fortuna-faucet \
            -p 8000:8000 \
            -v "$(pwd)/data:/app/web_service/backend/data" \
            -v "$(pwd)/logs:/app/web_service/backend/logs" \
            masonj0/fortuna-faucet:latest

          if [ $? -ne 0 ]; then
              echo "âœ— Failed to start container"
              exit 1
          fi

          echo "âœ“ Container started!"
          echo ""
          echo "Waiting for application to initialize..."
          sleep 5

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸŽ‰ Fortuna is running!                   â•‘"
          echo "â•‘                                            â•‘"
          echo "â•‘  Opening browser at:                       â•‘"
          echo "â•‘  http://localhost:8000                     â•‘"
          echo "â•‘                                            â•‘"
          echo "â•‘  Press Ctrl+C to stop                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Open browser (Mac)
          if [[ "$OSTYPE" == "darwin"* ]]; then
              open http://localhost:8000
          fi

          # Open browser (Linux)
          if [[ "$OSTYPE" == "linux-gnu"* ]]; then
              xdg-open http://localhost:8000 2>/dev/null || echo "Please open http://localhost:8000 in your browser"
          fi

          # Show logs
          echo ""
          echo "Container logs:"
          echo ""
          docker logs -f fortuna-faucet
          EOF

          chmod +x launcher.sh
          echo "âœ“ Created launcher.sh"

      # ============================================================
      # STEP 5: Create README for Launcher
      # ============================================================
      - name: Create Launcher README
        run: |
          cat > LAUNCHER_README.md << 'EOF'
          # ðŸ´ Fortuna Faucet - Docker Launcher

          ## Quick Start

          ### Windows Users
          1. Download `launcher.bat` from the releases
          2. Double-click `launcher.bat`
          3. Your browser opens to http://localhost:8000
          4. Done! ðŸŽ‰

          ### Mac/Linux Users
          1. Download `launcher.sh` from the releases
          2. Open Terminal and run: `bash launcher.sh`
          3. Your browser opens to http://localhost:8000
          4. Done! ðŸŽ‰

          ## Prerequisites

          - **Docker Desktop** installed and running
            - Download from: https://www.docker.com/products/docker-desktop

          ## What the Launcher Does

          1. âœ“ Checks if Docker is installed
          2. âœ“ Checks if Docker daemon is running
          3. âœ“ Pulls the latest Fortuna image
          4. âœ“ Starts the container
          5. âœ“ Opens your browser automatically
          6. âœ“ Shows live logs

          ## Stopping Fortuna

          Press `Ctrl+C` in the terminal where launcher is running.

          ## Troubleshooting

          ### "Docker is not installed"
          - Install Docker Desktop: https://www.docker.com/products/docker-desktop
          - Restart your computer after installation

          ### "Docker daemon is not running"
          - Open Docker Desktop application
          - Wait for it to fully start
          - Try the launcher again

          ### Port 8000 already in use
          - Edit the launcher script and change `8000:8000` to `8001:8000`
          - Then access at http://localhost:8001

          ### Can't open browser automatically
          - Manually open http://localhost:8000 in your browser
          - Logs will still show in terminal

          ## File Structure

          After running the launcher:
          - `data/` - Persisted race data
          - `logs/` - Application logs

          These are preserved between restarts.

          EOF

          cat LAUNCHER_README.md
          echo "âœ“ Created LAUNCHER_README.md"

      # ============================================================
      # STEP 6: Create Release/Artifacts
      # ============================================================
      - name: Upload Launcher Scripts as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-launchers
          path: |
            launcher.bat
            launcher.sh
            LAUNCHER_README.md
          retention-days: 30

      # ============================================================
      # STEP 7: Create GitHub Release (Optional)
      # ============================================================
      - name: Create Release with Launchers
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            launcher.bat
            launcher.sh
            LAUNCHER_README.md
          tag_name: latest-docker-${{ github.run_number }}
          body: |
            # ðŸ´ Fortuna Faucet - Docker Launcher Release

            ## Download & Run

            **Windows:** Download `launcher.bat`, double-click it
            **Mac/Linux:** Download `launcher.sh`, run `bash launcher.sh`

            ## What's Included
            - âœ“ Automatic Docker image pull
            - âœ“ Health checks
            - âœ“ Auto browser open
            - âœ“ Live logs display

            See `LAUNCHER_README.md` for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # STEP 8: Success Summary
      # ============================================================
      - name: Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                   âœ“ BUILD SUCCESSFUL!                     â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Docker image built and tested                            â•‘"
          echo "â•‘  Launcher scripts created:                                â•‘"
          echo "â•‘    - launcher.bat (Windows)                               â•‘"
          echo "â•‘    - launcher.sh  (Mac/Linux)                             â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Download from Artifacts or Releases                      â•‘"
          echo "â•‘  Then just run: double-click .bat or bash .sh             â•‘"
          echo "â•‘                                                            â•‘"
          echo "â•‘  Your betting strategy engine is ready! ðŸ´                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
