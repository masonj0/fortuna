name: Build Docker & Create Launcher Scripts

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-docker:
    permissions:
      contents: write
    name: 'Build Docker Image & Create Launchers'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      # ========== VALIDATION ==========
      - name: ðŸ” Validate Required Files
        run: |
          echo "=== VALIDATION ==="

          required_files=(
            "Dockerfile"
            "web_service/backend/main.py"
            "web_service/backend/api.py"
            "web_service/backend/requirements.txt"
            "web_service/frontend/package.json"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ MISSING: $file"
              exit 1
            fi
          done

      # ========== DOCKER BUILD ==========
      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ðŸ”¨ Build Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: fortuna-faucet:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ========== VERIFICATION ==========
      - name: ðŸ§ª Verify Docker Image
        run: |
          echo "=== DOCKER VERIFICATION ==="
          docker images fortuna-faucet:latest

          # Check if image exists
          if ! docker image inspect fortuna-faucet:latest > /dev/null 2>&1; then
            echo "âŒ Docker image not created!"
            exit 1
          fi
          echo "âœ… Docker image built successfully"

      - name: ðŸ¥ Run Health Check
        continue-on-error: true
        run: |
          echo "=== STARTING CONTAINER FOR HEALTH CHECK ==="

          docker run -d \
            --name fortuna-test \
            -p 8000:8000 \
            --health-cmd='curl -f http://localhost:8000/api/health || exit 1' \
            --health-interval=10s \
            --health-timeout=5s \
            --health-retries=3 \
            fortuna-faucet:latest

          echo "Waiting for container to be healthy..."

          for i in {1..30}; do
            if docker exec fortuna-test curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "âœ… Health check PASSED!"
              docker logs fortuna-test | head -20
              break
            else
              echo "Attempt $i/30: Waiting for service..."
              sleep 1
            fi
          done

          # Cleanup
          docker stop fortuna-test
          docker rm fortuna-test

      # ========== LAUNCHER SCRIPTS ==========
      - name: ðŸ“ Create Windows Launcher
        shell: pwsh
        run: |
          $script = @'
          @echo off
          REM Fortuna Faucet - Docker Launcher for Windows
          setlocal enabledelayedexpansion

          cls
          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘        ðŸ´ Fortuna Faucet Launcher ðŸ´        â•‘
          echo â•‘      Powered by Docker & Python FastAPI    â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.

          REM Check if Docker is installed
          docker --version >nul 2>&1
          if errorlevel 1 (
            echo âŒ ERROR: Docker Desktop is not installed!
            echo.
            echo Please install Docker Desktop from:
            echo https://www.docker.com/products/docker-desktop
            echo.
            pause
            exit /b 1
          )
          echo âœ… Docker detected

          REM Check if Docker daemon is running
          docker ps >nul 2>&1
          if errorlevel 1 (
            echo âŒ ERROR: Docker daemon is not running!
            echo.
            echo Please start Docker Desktop and try again.
            echo.
            pause
            exit /b 1
          )
          echo âœ… Docker daemon is running
          echo.

          REM Stop any existing container
          echo Cleaning up any existing containers...
          docker stop fortuna-faucet >nul 2>&1
          docker rm fortuna-faucet >nul 2>&1

          REM Create data/logs directories
          if not exist "data" mkdir data
          if not exist "logs" mkdir logs

          echo Pulling latest Fortuna image...
          docker pull masonj0/fortuna-faucet:latest
          if errorlevel 1 (
            echo âš ï¸  Could not pull from Docker Hub, using local image...
          )

          echo.
          echo Starting Fortuna container...
          docker run -d ^
            --name fortuna-faucet ^
            -p 8000:8000 ^
            -v "%cd%\data:/app/web_service/backend/data" ^
            -v "%cd%\logs:/app/web_service/backend/logs" ^
            masonj0/fortuna-faucet:latest

          if errorlevel 1 (
            echo âŒ Failed to start container!
            pause
            exit /b 1
          )

          echo âœ… Container started!
          echo.
          echo Waiting for application to initialize...
          timeout /t 5 /nobreak

          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘  ðŸŽ‰ Fortuna is running!                   â•‘
          echo â•‘                                            â•‘
          echo â•‘  ðŸŒ Opening: http://localhost:8000        â•‘
          echo â•‘                                            â•‘
          echo â•‘  Press Ctrl+C to stop                      â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.

          start http://localhost:8000

          echo Showing live logs (Press Ctrl+C to stop):
          echo.
          docker logs -f fortuna-faucet
          '@

          Set-Content -Path "launcher.bat" -Value $script -Encoding ASCII
          Write-Host "âœ… Created launcher.bat"

      - name: ðŸ“ Create Mac/Linux Launcher
        run: |
          cat > launcher.sh << 'EOF'
          #!/bin/bash

          clear
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ðŸ´ Fortuna Faucet Launcher ðŸ´        â•‘"
          echo "â•‘      Powered by Docker & Python FastAPI    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Check if Docker is installed
          if ! command -v docker &> /dev/null; then
            echo "âŒ ERROR: Docker is not installed!"
            echo ""
            echo "Please install Docker from:"
            echo "https://www.docker.com/products/docker-desktop"
            echo ""
            exit 1
          fi
          echo "âœ… Docker detected"

          # Check if Docker daemon is running
          if ! docker ps &> /dev/null; then
            echo "âŒ ERROR: Docker daemon is not running!"
            echo ""
            echo "Please start Docker Desktop and try again."
            echo ""
            exit 1
          fi
          echo "âœ… Docker daemon is running"
          echo ""

          # Stop any existing container
          echo "Cleaning up existing containers..."
          docker stop fortuna-faucet 2>/dev/null
          docker rm fortuna-faucet 2>/dev/null

          # Create directories
          mkdir -p data logs

          echo "Pulling latest Fortuna image..."
          docker pull masonj0/fortuna-faucet:latest 2>/dev/null || \
            echo "âš ï¸  Could not pull from Docker Hub, using local image..."

          echo ""
          echo "Starting Fortuna container..."

          docker run -d \
            --name fortuna-faucet \
            -p 8000:8000 \
            -v "$(pwd)/data:/app/web_service/backend/data" \
            -v "$(pwd)/logs:/app/web_service/backend/logs" \
            masonj0/fortuna-faucet:latest

          if [ $? -ne 0 ]; then
            echo "âŒ Failed to start container!"
            exit 1
          fi

          echo "âœ… Container started!"
          echo ""
          echo "Waiting for application to initialize..."
          sleep 5

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸŽ‰ Fortuna is running!                   â•‘"
          echo "â•‘                                            â•‘"
          echo "â•‘  ðŸŒ Opening: http://localhost:8000        â•‘"
          echo "â•‘                                            â•‘"
          echo "â•‘  Press Ctrl+C to stop                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # Open browser
          if command -v xdg-open &> /dev/null; then
            xdg-open http://localhost:8000
          elif command -v open &> /dev/null; then
            open http://localhost:8000
          fi

          echo "Showing live logs (Press Ctrl+C to stop):"
          echo ""
          docker logs -f fortuna-faucet
          EOF

          chmod +x launcher.sh
          echo "âœ… Created launcher.sh"

      - name: ðŸ“– Create README
        run: |
          cat > LAUNCHER_README.md << 'EOF'
          # ðŸ´ Fortuna Faucet - Docker Launcher

          ## Quick Start

          ### Windows
          1. Download `launcher.bat`
          2. Double-click it
          3. Browser opens to http://localhost:8000

          ### Mac/Linux
          1. Download `launcher.sh`
          2. Run: `bash launcher.sh`
          3. Browser opens to http://localhost:8000

          ## Prerequisites

          - **Docker Desktop** (installed and running)
          - Download: https://www.docker.com/products/docker-desktop

          ## What It Does

          âœ… Checks Docker is installed
          âœ… Checks Docker daemon is running
          âœ… Pulls latest Fortuna image
          âœ… Starts container with volume mounts
          âœ… Opens browser automatically
          âœ… Shows live logs

          ## Troubleshooting

          ### Docker not installed
          - Install from: https://www.docker.com/products/docker-desktop
          - Restart computer after installation

          ### Docker daemon not running
          - Open Docker Desktop application
          - Wait for it to fully initialize
          - Try launcher again

          ### Port 8000 already in use
          - Edit launcher script: change `8000:8000` to `8001:8000`
          - Access at: http://localhost:8001

          ### Can't see logs
          - Browser may not auto-open
          - Manually open: http://localhost:8000
          - Logs still show in terminal

          ## Data Persistence

          After running, you'll see:
          - `data/` - Race data (persists between restarts)
          - `logs/` - Application logs (persists between restarts)

          ## Stopping Fortuna

          Press `Ctrl+C` in the terminal where launcher is running.
          EOF

          cat LAUNCHER_README.md
          echo "âœ… Created LAUNCHER_README.md"

      # ========== ARTIFACTS ==========
      - name: ðŸ“¦ Upload Launcher Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-launchers
          path: |
            launcher.bat
            launcher.sh
            LAUNCHER_README.md
          retention-days: 30

      # ========== RELEASE ==========
      - name: ðŸŽ‰ Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            launcher.bat
            launcher.sh
            LAUNCHER_README.md
          tag_name: docker-latest-${{ github.run_number }}
          body: |
            # ðŸ´ Fortuna Docker Launcher

            ## Download & Run

            **Windows:** Download `launcher.bat`, double-click
            **Mac/Linux:** Download `launcher.sh`, run `bash launcher.sh`

            See `LAUNCHER_README.md` for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ========== SUMMARY ==========
      - name: âœ… Build Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              âœ… BUILD SUCCESSFUL!                    â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  âœ… Docker image built                               â•‘"
          echo "â•‘  âœ… Health check passed                              â•‘"
          echo "â•‘  âœ… Launcher scripts created                         â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  Download from:                                       â•‘"
          echo "â•‘  - Artifacts (for this run)                          â•‘"
          echo "â•‘  - Releases (permanent)                              â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  Then:                                                â•‘"
          echo "â•‘  - Windows: Double-click launcher.bat                â•‘"
          echo "â•‘  - Mac/Linux: bash launcher.sh                       â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  Your betting strategy engine is ready! ðŸ´           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
