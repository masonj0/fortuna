# System Timestamp: 2025-12-21 14:04:35
name: ðŸš€ Build Web Service MSI (GPT-5 Overkill)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9'
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8100'

jobs:
  # =========================================================
  # PHASE 1: PRE-FLIGHT & PATHFINDING
  # =========================================================
  preflight-check:
    name: ðŸ” System & Asset Preflight
    runs-on: windows-2022
    outputs:
      backend_dir: ${{ steps.pathfinder.outputs.backend_dir }}
      backend_reqs: ${{ steps.pathfinder.outputs.backend_reqs }}
      backend_spec: ${{ steps.pathfinder.outputs.backend_spec }}
      frontend_dir: ${{ steps.pathfinder.outputs.frontend_dir }}
      wix_proj: ${{ steps.pathfinder.outputs.wix_proj }}
      semver: ${{ steps.git_version.outputs.semver }}
      build_id: ${{ steps.git_version.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Derive SemVer & Build ID
        id: git_version
        shell: pwsh
        run: |
          $semver = "0.0.${{ github.run_number }}"
          $run_id = "${{ github.run_id }}-${{ github.run_attempt }}"
          echo "semver=$semver" >> $env:GITHUB_OUTPUT
          echo "build_id=$run_id" >> $env:GITHUB_OUTPUT
          Write-Host "Build Version: $semver"

      - name: ðŸ—ºï¸ Path-Finder (Dynamic Project Detection)
        id: pathfinder
        shell: pwsh
        run: |
          if (Test-Path "web_service/backend/main.py") {
            echo "backend_dir=web_service/backend" >> $env:GITHUB_OUTPUT
            echo "backend_reqs=web_service/backend/requirements.txt" >> $env:GITHUB_OUTPUT
            echo "backend_spec=fortuna-unified.spec" >> $env:GITHUB_OUTPUT
            Write-Host "âœ… Detected 'web_service' backend."
          } else {
            throw "âŒ FATAL: Could not detect a valid backend."
          }

          if (Test-Path "web_platform/frontend/next.config.mjs") {
            echo "frontend_dir=web_platform/frontend" >> $env:GITHUB_OUTPUT
            Write-Host "âœ… Detected 'web_platform' frontend."
          } else {
            throw "âŒ FATAL: Could not detect a valid frontend."
          }

          if (Test-Path "build_wix/Product_WebService.wxs") {
              echo "wix_proj=build_wix/Product_WebService.wxs" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… Detected 'Product_WebService.wxs' for WiX build."
          } else {
              throw "âŒ FATAL: Could not find a valid .wxs file."
          }

      - name: ðŸ”Ž Forensic Asset Verification
        shell: pwsh
        run: |
          $critical_assets = @(
            "${{ steps.pathfinder.outputs.frontend_dir }}/package.json",
            "${{ steps.pathfinder.outputs.backend_reqs }}",
            "${{ steps.pathfinder.outputs.wix_proj }}"
          )
          foreach ($asset in $critical_assets) {
            if (-not (Test-Path $asset)) {
              Write-Error "âŒ FATAL: Missing critical asset: $asset"
              exit 1
            }
            $hash = (Get-FileHash $asset).Hash
            Write-Host "âœ… Verified: $asset ($hash)"
          }

  # =========================================================
  # PHASE 2: PARALLEL BUILDS
  # =========================================================
  build-backend:
    name: ðŸ Build Backend (${{ matrix.arch }})
    needs: preflight-check
    runs-on: windows-2022
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'
          cache-dependency-path: ${{ needs.preflight-check.outputs.backend_reqs }}

      - name: ðŸ§¾ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "ðŸ›¡ï¸ ACTIVATING X86 SAFE MODE"
            @(
              "numpy==1.23.5",
              "pandas==1.5.3",
              "greenlet==3.1.1",
              "scipy==1.10.1",
              "--only-binary=:all:"
            ) | Set-Content $file
            Write-Host "âœ… x86 constraints: numpy 1.23.5, pandas 1.5.3, greenlet 3.1.1, scipy 1.10.1"
          } else {
            New-Item $file -ItemType File -Force
            Write-Host "âœ… x64 build: no constraints needed"
          }
          "file=$file" | Out-File $env:GITHUB_OUTPUT -Append

      - name: ðŸ“¦ Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ needs.preflight-check.outputs.backend_reqs }} -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller==6.6.0 pywin32 -c ${{ steps.constraints.outputs.file }}

      - name: ðŸ—ï¸ Build Binary with PyInstaller
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean --log-level INFO ${{ needs.preflight-check.outputs.backend_spec }}

      - name: ðŸ“¤ Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ needs.preflight-check.outputs.build_id }}
          path: dist/fortuna-webservice
          retention-days: 1

  build-frontend:
    name: âš›ï¸ Build Frontend
    needs: preflight-check
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ needs.preflight-check.outputs.frontend_dir }}/package-lock.json

      - name: ðŸ—ï¸ Build Next.js/React App
        working-directory: ${{ needs.preflight-check.outputs.frontend_dir }}
        run: |
          npm ci
          npm run build
      - name: ðŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ needs.preflight-check.outputs.build_id }}
          path: ${{ needs.preflight-check.outputs.frontend_dir }}/out
          retention-days: 1

  # =========================================================
  # PHASE 3: PACKAGE MSI INSTALLER
  # =========================================================
  package-msi:
    name: ðŸ“¦ Package MSI Installer (${{ matrix.arch }})
    needs: [preflight-check, build-backend, build-frontend]
    runs-on: windows-2022
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¥ Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ needs.preflight-check.outputs.build_id }}
          path: staging/backend
      - name: ðŸ“¥ Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ needs.preflight-check.outputs.build_id }}
          path: staging/backend/ui

      - name: ðŸ§ Pre-Build Forensic File Audit
        shell: pwsh
        run: |
          Get-ChildItem -Path "staging" -Recurse | Select-Object FullName, Length

      - name: ðŸ”§ Setup WiX Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: dotnet tool install --global wix --version ${{ env.WIX_VERSION }}
      - run: echo C:\Users\runneradmin\.dotnet\tools >> $GITHUB_PATH
        shell: bash

      - name: Create Required WiX Files
        shell: pwsh
        run: |
          Set-Content -Path "build_wix/license.rtf" -Value '{\rtf1\ansi Placeholder License}' -Encoding Ascii
          $scriptContent = "@echo off`r`necho Requesting Admin privileges to restart FortunaWebService...`r`nnet stop FortunaWebService`r`nnet start FortunaWebService`r`necho Service Restarted.`r`npause"
          Set-Content -Path "staging/backend/restart_service.bat" -Value $scriptContent -Encoding Ascii
          $readmeContent = @"
Welcome to Fortuna Faucet!

The Fortuna Faucet service has been installed and is now running in the background.

To access the application, please open your web browser and navigate to:

http://localhost:${{ env.SERVICE_PORT }}

Enjoy the races!
"@
          Set-Content -Path "staging/backend/README.txt" -Value $readmeContent -Encoding utf8

      - name: Prepare WiX Project
        shell: pwsh
        run: |
          Copy-Item "${{ needs.preflight-check.outputs.wix_proj }}" "build_wix/Product.wxs" -Force
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64;x86</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content "build_wix/Fortuna.wixproj" -Value ($proj -join "`r`n") -Encoding utf8

      - name: Build and Rename MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=${{ matrix.arch }} -p:Version="${{ needs.preflight-check.outputs.semver }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.SERVICE_PORT }}"
          $ver = "${{ needs.preflight-check.outputs.semver }}"
          $releaseDir = "bin/${{ matrix.arch }}/Release"
          $msiFound = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select-Object -First 1
          $targetName = "Fortuna-${ver}-${{ matrix.arch }}.msi"
          $newPath = Join-Path $releaseDir $targetName
          Move-Item -Path $msiFound.FullName -Destination $newPath -Force

      - name: ðŸ“¤ Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi-dist-${{ matrix.arch }}-${{ needs.preflight-check.outputs.build_id }}
          path: build_wix/bin/${{ matrix.arch }}/Release/Fortuna-${{ needs.preflight-check.outputs.semver }}-${{ matrix.arch }}.msi
          retention-days: 1

  # =========================================================
  # PHASE 4: SMOKE TEST
  # =========================================================
  smoke-test:
    name: ðŸš¬ Smoke Test Installation (${{ matrix.arch }})
    needs: [package-msi, preflight-check]
    runs-on: windows-2022
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ“¥ Download MSI Artifact
        uses: actions/download-artifact@v4
        with:
          name: msi-dist-${{ matrix.arch }}-${{ needs.preflight-check.outputs.build_id }}
          path: msi-installer

      - name: ðŸ§¹ Pre-Install Service Cleanup
        shell: pwsh
        run: |
          sc.exe delete "FortunaWebService" *>$null
          Start-Sleep -Seconds 3

      - name: ðŸ’¿ Install MSI Silently
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) { throw "MSI not found in msi-installer directory!" }
          $proc = Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /quiet /norestart /L*v install.log" -Wait -PassThru
          if ($proc.ExitCode -ne 0 -and $proc.ExitCode -ne 3010) {
            Get-Content install.log | Write-Error
            throw "MSI installation failed with exit code $($proc.ExitCode)"
          }
      - name: ðŸš€ Start Service & Create Runtime Dirs
        shell: pwsh
        run: |
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installRoot = Join-Path $progFiles "Fortuna Faucet Service"
          if (-not (Test-Path $installRoot)) { throw "âŒ Install dir not found at $installRoot" }
          New-Item -Path "$installRoot\data", "$installRoot\json", "$installRoot\logs" -ItemType Directory -Force | Out-Null
          Start-Service "FortunaWebService"
          Start-Sleep -Seconds 15

      - name: ðŸ©º Health Check with Retry
        shell: pwsh
        run: |
          $maxRetries = 5
          $delay = 3
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:${{ env.SERVICE_PORT }}/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Health check PASSED on attempt $i."
                exit 0
              }
            } catch {
              Write-Warning "Attempt $i: Health check failed. Error: $($_.Exception.Message)"
            }
            if ($i -lt $maxRetries) { Start-Sleep -Seconds ($delay * $i) }
          }
          throw "âŒ Service health check failed after $maxRetries attempts."

      - name: 'ðŸ•µï¸ CSI: Windows Post-Mortem (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Get-Process | Where-Object { $_.ProcessName -like "fortuna*" }
          Get-EventLog -LogName Application -Newest 50 -EntryType Error,Warning
          Get-Content "C:\Program Files\Fortuna Faucet Service\logs\*.log" -ErrorAction SilentlyContinue

      - name: ðŸ“¤ Upload Diagnostic Logs (On Failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs-${{ needs.preflight-check.outputs.build_id }}
          path: |
            install.log
            C:\Program Files\Fortuna Faucet Service\logs\*.log

  # =========================================================
  # PHASE 5: RELEASE
  # =========================================================
  release:
    name: ðŸš€ Publish Release
    needs: smoke-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-dist-${{ needs.preflight-check.outputs.build_id }}
          path: release_assets

      - name: ðŸ” Generate Checksums
        run: |
          cd release_assets
          sha256sum *.msi > SHASUMS256.txt

      - name: ðŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*
          generate_release_notes: true
