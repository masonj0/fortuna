# System Timestamp: 2025-11-29 13:19:26.933797
name: Build Fortuna Faucet Web Service Installer (Omega Overkill)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'python_service/**'
      - 'web_platform/frontend/**'
      - 'fortuna-backend-webservice.spec'
      - '.github/workflows/build-web-service-msi-gpt5.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: pwsh

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  DOTNET_VERSION: '8.0.x'
  PYTHONUTF8: '1'
  PIP_DISABLE_PIP_VERSION_CHECK: '1'
  PIP_NO_PYTHON_VERSION_WARNING: '1'
  NPM_CONFIG_FUND: 'false'
  NPM_CONFIG_AUDIT: 'false'
  FORCE_COLOR: '3'
  FRONTEND_DIR: 'web_platform/frontend'
  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'
  BACKEND_DIR: 'python_service'
  WIX_DIR: 'build_wix'
  BACKEND_SPEC: 'fortuna-backend-webservice.spec'
  SERVICE_PORT: '8102'
  HEALTH_ENDPOINT: '/health'
  API_KEY: ${{ secrets.TEST_API_KEY }}
  MSI_STAGING_DIR: 'build_wix/staging'
  MSI_OUTPUT_DIR: 'dist'
  WIX_VERSION: '4.0.5'

jobs:
  system-check:
    name: 'âš™ï¸ System Prerequisites'
    runs-on: windows-latest
    timeout-minutes: 5
    outputs:
      disk_free_gb: ${{ steps.system.outputs.disk_gb }}
    steps:
      - name: Verify Build Tools
        run: |
          Set-StrictMode -Version Latest
          $tools = @('dotnet', 'python', 'node', 'npm', 'git')
          foreach ($tool in $tools) {
            Write-Host "Checking for $($tool)..."
            Get-Command $tool -ErrorAction SilentlyContinue
            if (-not $?) {
              Write-Host "âŒ FATAL: Build tool '$tool' not found in PATH." -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "âœ… All critical build tools are present." -ForegroundColor Green
      - name: Check Disk Space
        id: system
        run: |
          Set-StrictMode -Version Latest
          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }
          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)
          if ($freeGB -lt 10) {
            Write-Host "âš ï¸ WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended)." -ForegroundColor Yellow
          } else {
            Write-Host "âœ… Disk space check passed ($freeGB GB free)." -ForegroundColor Green
          }
          "disk_gb=$freeGB" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

  repo-preflight:
    name: 'ğŸ§ª Repo Preflight & Integrity'
    runs-on: windows-latest
    needs: system-check
    timeout-minutes: 5
    outputs:
      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}
      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}
      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Derive Build Metadata
        id: meta
        run: |
          Set-StrictMode -Version Latest
          $ref = "${{ github.ref }}"
          if ($ref -like 'refs/tags/v*') {
            $semver = $ref -replace 'refs/tags/v', ''
          } else {
            $semver = "0.0.${{ github.run_number }}"
          }
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ”– Version: $semver ($shortSha)"

      - name: Validate Critical Files Exist
        run: |
          Set-StrictMode -Version Latest
          $paths = @(
            "${{ env.FRONTEND_DIR }}/package.json",
            "${{ env.FRONTEND_DIR }}/package-lock.json",
            "${{ env.BACKEND_DIR }}/requirements.txt",
            "${{ env.BACKEND_DIR }}/main.py",
            "${{ env.BACKEND_SPEC }}",
            "${{ env.WIX_DIR }}/Product_WithService.wxs"
          )
          foreach ($path in $paths) {
            if (-not (Test-Path $path)) {
              Write-Host "âŒ FATAL: Required path missing: $path" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "âœ… All critical files confirmed."

      - name: Capture Integrity Hashes
        id: hashes
        run: |
          Set-StrictMode -Version Latest
          $frontend = (Get-FileHash "${{ env.FRONTEND_DIR }}/package-lock.json" -Algorithm SHA256).Hash
          $backend = (Get-FileHash "${{ env.BACKEND_DIR }}/requirements.txt" -Algorithm SHA256).Hash
          $wix = (Get-FileHash "${{ env.WIX_DIR }}/Product_WithService.wxs" -Algorithm SHA256).Hash
          "frontend_lock_hash=$frontend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "backend_requirements_hash=$backend" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "wix_definition_hash=$wix" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload Integrity Snapshot
        uses: actions/upload-artifact@v4
        with:
          name: repo-preflight-${{ github.run_id }}
          path: |
            ${{ env.FRONTEND_DIR }}/package-lock.json
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.WIX_DIR }}/Product_WithService.wxs
          retention-days: 3

  frontend-quality:
    name: 'ğŸ§¼ Frontend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Run Lint (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {
            Write-Host "ğŸ§¹ Running npm run lint"
            npm run lint
          } else {
            Write-Host "â„¹ï¸ No lint script defined, skipping."
          }

      - name: Run Tests (if defined)
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {
            Write-Host "ğŸ§ª Running npm test -- --watch=false"
            npm test -- --watch=false
          } else {
            Write-Host "â„¹ï¸ No test script defined, skipping."
          }

      - name: Security Audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm audit --audit-level=critical

  backend-quality:
    name: 'ğŸ§¯ Backend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: repo-preflight
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ hashFiles('${{ env.BACKEND_DIR }}/**', '${{ env.BACKEND_SPEC }}') }}

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel
          pip install -r "${{ env.BACKEND_DIR }}/requirements.txt"
          if (Test-Path "${{ env.BACKEND_DIR }}/requirements-dev.txt") {
            pip install -r "${{ env.BACKEND_DIR }}/requirements-dev.txt"
          } else {
            Write-Host "â„¹ï¸ requirements-dev.txt not found, skipping."
          }

      - name: Bytecode Compile (Fail Fast)
        run: |
          Set-StrictMode -Version Latest
          python -m compileall -q "${{ env.BACKEND_DIR }}"

      - name: Run Pytest (if available)
        run: |
          Set-StrictMode -Version Latest
          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec("pytest") else 1)'
          if ($LASTEXITCODE -eq 0) {
            Write-Host "ğŸ§ª pytest detected, running suite..."
            python -m pytest "${{ env.BACKEND_DIR }}" --maxfail=1 --disable-warnings
          } else {
            Write-Host "â„¹ï¸ pytest not installed; skipping tests."
          }

      - name: pip-audit (non-blocking)
        continue-on-error: true
        run: |
          Set-StrictMode -Version Latest
          pip install pip-audit
          pip-audit -r ${{ env.BACKEND_DIR }}/requirements.txt

  sbom:
    name: 'ğŸ“„ SBOM Snapshot'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: repo-preflight
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate SBOM (SPDX)
        uses: anchore/sbom-action@v0
        with:
          output-file: sbom.spdx.json
          format: spdx-json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: sbom.spdx.json
          retention-days: 7

  build-frontend:
    name: 'ğŸ“¦ Build Frontend'
    runs-on: windows-latest
    timeout-minutes: 20
    needs: [repo-preflight, frontend-quality]
    env:
      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Cache Frontend Build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_BUILD_DIR }}
          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}
          restore-keys: |
            ${{ runner.os }}-frontend-build-

      - name: Prime npm Cache
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\npm-cache
          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}
          restore-keys: |
            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm ci --prefer-offline --no-audit --no-fund

      - name: Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: |
          Set-StrictMode -Version Latest
          cd "${{ env.FRONTEND_DIR }}"
          npm run build

      - name: Report Cache Status
        run: |
          if ('${{ steps.cache-frontend.outputs.cache-hit }}' -eq 'true') {
            Write-Host "âœ… Frontend build restored from cache." -ForegroundColor Green
          } else {
            Write-Host "â„¹ï¸ No cache hit. A new build was performed." -ForegroundColor Yellow
          }

      - name: Verify Build Output
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}"
          if (-not (Test-Path $outDir)) {
             Write-Host "âŒ FATAL: Build directory not found" -ForegroundColor Red
             exit 1
          }
          $files = Get-ChildItem -Path $outDir -Recurse -File
          if ($files.Count -eq 0) {
             Write-Host "âŒ FATAL: Build directory empty" -ForegroundColor Red
             exit 1
          }
          Write-Host "âœ… Frontend built: $($files.Count) files."

      - name: Generate Artifact Manifest
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}"
          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8
          Get-ChildItem -Path $outDir -Recurse -File | ForEach-Object {
            $relative = $_.FullName.Substring($outDir.Path.Length).TrimStart('\','/')
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$relative`t$($_.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_BUILD_DIR }}
          retention-days: 3

      - name: Upload Manifest
        uses: actions/upload-artifact@v4
        with:
          name: frontend-manifest-${{ github.run_id }}
          path: frontend-manifest.tsv
          retention-days: 3

  build-backend:
    name: 'ğŸ Build Backend'
    runs-on: windows-latest
    timeout-minutes: 25
    needs: [repo-preflight, build-frontend, backend-quality]
    env:
      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: temp-frontend

      - name: Stage Frontend for PyInstaller
        run: |
          Set-StrictMode -Version Latest
          $dest = "staging/ui"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path "temp-frontend/*" -Destination $dest -Recurse -Force
          Write-Host "âœ… Frontend staged for inclusion."

      - name: Cache Backend Build
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-build-${{ hashFiles('${{ env.BACKEND_DIR }}/**', '${{ env.BACKEND_SPEC }}') }}
          restore-keys: |
            ${{ runner.os }}-backend-build-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            ${{ env.BACKEND_DIR }}/requirements.txt
            ${{ env.BACKEND_DIR }}/requirements-dev.txt

      - name: Install Dependencies
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel
          pip install -r "${{ env.BACKEND_DIR }}/requirements.txt"
          if (Test-Path "${{ env.BACKEND_DIR }}/requirements-dev.txt") {
            pip install -r "${{ env.BACKEND_DIR }}/requirements-dev.txt"
          }

      - name: Freeze Dependency Snapshot
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          Set-StrictMode -Version Latest
          pip freeze | Out-File backend-freeze.txt -Encoding utf8

      - name: Create Required Backend Directories
        if: steps.cache-backend.outputs.cache-hit != 'true'
        run: |
          Set-StrictMode -Version Latest
          New-Item -ItemType Directory -Path "python_service/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/json" -Force | Out-Null
          Write-Host "âœ… Created required backend directories for PyInstaller." -ForegroundColor Green

      - name: Build with PyInstaller
        if: steps.cache-backend.outputs.cache-hit != 'true'
        env:
          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}
        run: |
          Set-StrictMode -Version Latest
          pyinstaller "${{ env.BACKEND_SPEC }}" --clean --log-level=WARN --noconfirm

      - name: Report Cache Status
        run: |
          if ('${{ steps.cache-backend.outputs.cache-hit }}' -eq 'true') {
            Write-Host "âœ… Backend build restored from cache." -ForegroundColor Green
          } else {
            Write-Host "â„¹ï¸ No cache hit. A new build was performed." -ForegroundColor Yellow
          }

      - name: Verify Executable
        run: |
          Set-StrictMode -Version Latest
          $exePath = "dist/fortuna-backend.exe"
          if (-not (Test-Path $exePath)) {
            Write-Host "âŒ FATAL: Executable not found" -ForegroundColor Red
            exit 1
          }
          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash
          $size = (Get-Item $exePath).Length / 1MB
          if ($size -lt 10) {
            Write-Host "âŒ FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete." -ForegroundColor Red
            exit 1
          }
          "fortuna-backend.exe`t$hash" | Out-File backend-sha256.tsv -Encoding utf8
          Write-Host "âœ… Backend ready: $([math]::Round($size, 2)) MB ($hash)"

      - name: Upload Backend Executable
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist/fortuna-backend.exe
          retention-days: 3

      - name: Upload Backend Metadata
        uses: actions/upload-artifact@v4
        with:
          name: backend-metadata-${{ github.run_id }}
          path: |
            backend-sha256.tsv
            backend-freeze.txt
          retention-days: 7

  diagnose-asgi-imports:
    name: 'ğŸ” ASGI Import Killer (Pre-Smoke Diagnostic)'
    runs-on: windows-latest
    timeout-minutes: 15
    needs: build-backend
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âš™ï¸ Setup Python (EXACT VERSION)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“‹ Capture Python Info
        run: |
          Set-StrictMode -Version Latest
          Write-Host "Python executable: $(which python)" -ForegroundColor Cyan
          python --version
          python -m site
          python -c "import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)"

      - name: ğŸ“¥ Install Requirements (Exactly as Backend Build)
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel --quiet

          Write-Host "Installing requirements.txt..." -ForegroundColor Cyan
          pip install -r "${{ env.BACKEND_DIR }}/requirements.txt" -v 2>&1 | Tee-Object "install-requirements.log"

          if (Test-Path "${{ env.BACKEND_DIR }}/requirements-dev.txt") {
            Write-Host "Installing requirements-dev.txt..." -ForegroundColor Cyan
            pip install -r "${{ env.BACKEND_DIR }}/requirements-dev.txt" -v 2>&1 | Tee-Object -Append "install-requirements.log"
          }

          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ pip install failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "âœ… All dependencies installed" -ForegroundColor Green

      - name: ğŸ“¦ Capture Installed Packages
        run: |
          pip list | Tee-Object "installed-packages.txt"
          pip freeze | Tee-Object "pip-freeze.txt"

      - name: ğŸ Set PYTHONPATH
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PYTHONPATH set to ${{ github.workspace }}"

      - name: ğŸ§ª PHASE 1 System Imports
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 1 SYSTEM-LEVEL IMPORTS")',
            'print("="*80)',
            'modules = [',
            "    ('os', 'filesystem'), ('sys', 'system'), ('json', 'serialization'),",
            "    ('asyncio', 'async I/O'), ('pathlib', 'paths'), ('typing', 'type hints'),",
            "    ('importlib', 'import utilities')",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:20} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:20} ImportError: {e}")',
            '        failed.append(mod_name)',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} system imports failed")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 1 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 2 Web Framework Core
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'print("\n" + "="*80)',
            'print("PHASE 2 WEB FRAMEWORK CORE")',
            'print("="*80)',
            'modules = [',
            "    ('fastapi', 'web framework'),",
            "    ('uvicorn', 'ASGI server'),",
            "    ('starlette', 'ASGI toolkit'),",
            "    ('starlette.applications', 'ASGI app'),",
            "    ('starlette.routing', 'routing'),",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:30} ImportError: {e}")',
            '        failed.append((mod_name, str(e)))',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} {type(e).__name__}: {e}")',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} core framework imports failed")',
            '    for mod, err in failed:',
            '        print(f"  - {mod}")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 2 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 3 Pydantic & Data Validation
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 3 PYDANTIC & DATA VALIDATION")',
            'print("="*80)',
            'modules = [',
            "    ('pydantic', 'validation'),",
            "    ('pydantic_core', 'core'),",
            "    ('pydantic_settings', 'settings'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 3 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 4 Async/IO Utilities
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 4 ASYNC/IO UTILITIES")',
            'print("="*80)',
            'modules = [',
            "    ('anyio', 'async compat'),",
            "    ('httpcore', 'HTTP core'),",
            "    ('httpx', 'HTTP client'),",
            "    ('aiosqlite', 'async DB'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 4 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 5 Optional Dependencies (non-critical)
        continue-on-error: true
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 5 OPTIONAL DEPENDENCIES (non-critical)")',
            'print("="*80)',
            'modules = [',
            "    ('slowapi', 'rate limiting'),",
            "    ('structlog', 'logging'),",
            "    ('tenacity', 'retries'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} not critical: {type(e).__name__}")',
            'print(f"\nâœ… Phase 5 complete (warnings OK)")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 6 Application Directory Structure
        run: |
          Set-StrictMode -Version Latest

          $script = @(
            'import os',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 6 APPLICATION DIRECTORY STRUCTURE")',
            'print("="*80)',
            'cwd = Path.cwd()',
            'python_service = cwd / "python_service"',
            'print(f"\nCurrent directory: {cwd}")',
            'print(f"\npython_service exists: {python_service.exists()}")',
            'if python_service.exists():',
            '    print(f"  Contents:")',
            '    for item in python_service.iterdir():',
            '        print(f"    - {item.name}")',
            '    main_py = python_service / "main.py"',
            '    api_py = python_service / "api.py"',
            '    print(f"\n  main.py: {main_py.exists()} ({main_py.stat().st_size if main_py.exists() else \'N/A\'} bytes)")',
            '    print(f"  api.py: {api_py.exists()} ({api_py.stat().st_size if api_py.exists() else \'N/A\'} bytes)")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 7 CRITICAL - Application Module Imports
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)")',
            'print("="*80)',
            'print("\n[Step 1] Importing python_service...")',
            'try:',
            '    import python_service',
            '    print(f"âœ… python_service imported")',
            '    print(f"   Location: {python_service.__file__}")',
            'except Exception as e:',
            '    print(f"âŒ FATAL: python_service import failed")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print("\n[Step 2] Retrieving \'app\' object from main...")',
            'try:',
            '    from python_service.main import app',
            '    print(f"âœ… app object retrieved")',
            '    print(f"   Type: {type(app)}")',
            '    print(f"   Class: {app.__class__.__name__}")',
            '    print(f"   Module: {app.__class__.__module__}")',
            'except Exception as e:',
            '    print(f"âŒ FATAL: Could not get app object")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print("\n" + "="*80)',
            'print("âœ… ALL APPLICATION IMPORTS SUCCESSFUL")',
            'print("="*80)',
            'print("\nThe ASGI app is fully importable.")',
            'print("Uvicorn should be able to load it successfully.")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ APPLICATION IMPORT TEST FAILED" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ“‹ Generate ASGI Diagnostic Report
        if: always()
        run: |
          Set-StrictMode -Version Latest
          $report = @()
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report += "â•‘              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        â•‘"
          $report += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          $report += ""
          $report += "Timestamp: $(Get-Date -Format 'o')"
          $report += "Python: $(python --version)"
          $report += ""
          $report += "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          $result = if ($LASTEXITCODE -eq 0) { 'PASS âœ…' } else { 'FAIL âŒ' }
          $report += "â”‚ RESULT: $result â”‚"
          $report += "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          $report += ""
          $report += "If this passed:"
          $report += "  âœ… All required dependencies are installed"
          $report += "  âœ… python_service.main is importable"
          $report += "  âœ… FastAPI app is accessible"
          $report += "  âœ… The executable should work"
          $report += "  âœ… Uvicorn WILL be able to load the app"
          $report += ""
          $report += "If this failed:"
          $report += "  âŒ See error output above for the exact problem"
          $report += "  âŒ Fix the import error in your code"
          $report += "  âŒ Common issues:"
          $report += "     - Missing dependency in requirements.txt"
          $report += "     - Syntax error in api.py or main.py"
          $report += "     - Circular import in api.py"
          $report += "     - api.py imports a module that fails"
          $report += ""
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report | Tee-Object "asgi-diagnostic-report.txt"

      - name: ğŸ“¤ Upload Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asgi-import-diagnostics-${{ github.run_id }}
          path: |
            install-requirements.log
            installed-packages.txt
            pip-freeze.txt
            asgi-diagnostic-report.txt
          retention-days: 30
          if-no-files-found: warn

  smoke-test:
    name: 'ğŸ”¬ Smoke Test (Diagnostic Overkill)'
    runs-on: windows-latest
    timeout-minutes: 30
    needs: [build-frontend, build-backend, diagnose-asgi-imports]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 0: PRE-EXECUTION FORENSICS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist

      - name: ğŸ“¥ Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: frontend-dist

      - name: ğŸ—ï¸ Setup Directories & Capture Baseline
        run: |
          Set-StrictMode -Version Latest

          # Create diagnostic structure
          New-Item -ItemType Directory -Path "service-logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics/exe-analysis" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics/runtime-trace" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics/import-analysis" -Force | Out-Null
          New-Item -ItemType Directory -Path "diagnostics/environment" -Force | Out-Null
          New-Item -ItemType Directory -Path "data" -Force | Out-Null
          New-Item -ItemType Directory -Path "json" -Force | Out-Null

          # Baseline system state
          Get-Process | Out-File "diagnostics/baseline-processes.txt"
          Get-NetTCPConnection -ErrorAction SilentlyContinue | Out-File "diagnostics/baseline-network.txt"
          [Environment]::GetEnvironmentVariables() | Out-File "diagnostics/baseline-env.txt"

          Write-Host "âœ… Diagnostic directories created" -ForegroundColor Green

      - name: ğŸ”¬ Analyze Executable (Pre-Execution)
        run: |
          Set-StrictMode -Version Latest

          $exe = "dist/fortuna-backend.exe"

          # File properties
          $info = Get-Item $exe
          $size = $info.Length / 1MB

          $exeAnalysis = @(
            "=== EXECUTABLE ANALYSIS ===",
            "Path: $($info.FullName)",
            "Size: $([math]::Round($size, 2)) MB",
            "Created: $($info.CreationTime)",
            "Modified: $($info.LastWriteTime)",
            "Attributes: $($info.Attributes)"
          )
          $exeAnalysis | Tee-Object "diagnostics/exe-analysis/exe-properties.txt"

          # PE signature check
          $bytes = [System.IO.File]::ReadAllBytes($exe)
          $peSignature = "{0:X2}{1:X2}" -f $bytes[0], $bytes[1]
          if ($peSignature -eq "4D5A") {
            Write-Host "âœ… Valid PE signature: $peSignature" -ForegroundColor Green
          } else {
            Write-Host "âŒ INVALID PE signature: $peSignature (expected 4D5A)" -ForegroundColor Red
            exit 1
          }

          # Check for embedded dependencies (more robustly)
          $searchString = "uvicorn"
          # Use Select-String instead of findstr to avoid exit code 1 issues
          if (Select-String -Path $exe -Pattern $searchString -Quiet -SimpleMatch) {
              Write-Host "âœ… Found '$searchString' reference."
          } else {
              Write-Host "â„¹ï¸ '$searchString' not found in binary (likely packed). Continuing..." -ForegroundColor Gray
          }

      - name: ğŸ”’ Configure Firewall & Network
        run: |
          Set-StrictMode -Version Latest

          # Create firewall rule
          try {
            New-NetFirewallRule `
              -DisplayName "FortunaSmoke" `
              -Direction Inbound `
              -Action Allow `
              -Protocol TCP `
              -LocalPort ${{ env.SERVICE_PORT }} `
              -ErrorAction Stop
            Write-Host "âœ… Firewall rule created" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸  Firewall rule may exist: $_" -ForegroundColor Yellow
          }

          # Allow port in Windows Defender
          try {
            netsh advfirewall firewall add rule name="FortunaSmokeHTTP" dir=in action=allow protocol=tcp localport=${{ env.SERVICE_PORT }} | Out-File "diagnostics/firewall-netsh.log"
          } catch {
            Write-Host "âš ï¸  netsh command issue (non-critical)" -ForegroundColor Yellow
          }

          # Baseline netstat
          netstat -ano | Out-File "diagnostics/network-baseline.txt"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 1: PRE-LAUNCH PYTHON/ASGI VALIDATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Setup Python for Pre-Launch Check
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies for Pre-Launch Check
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip
          pip install -r "${{ env.BACKEND_DIR }}/requirements.txt"
          if (Test-Path "${{ env.BACKEND_DIR }}/requirements-dev.txt") {
            pip install -r "${{ env.BACKEND_DIR }}/requirements-dev.txt"
          }

      - name: ğŸ Set PYTHONPATH for Pre-Launch Check
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PYTHONPATH set to ${{ github.workspace }}"

      - name: ğŸ Test PyInstaller Python Environment (Mimic Executable)
        run: |
          Set-StrictMode -Version Latest

          # Create a test script that mimics what the executable should do
          $testScript = @(
            'import sys, os, traceback',
            'print("=" * 80)',
            'print("PRE-LAUNCH PYTHON ENVIRONMENT CHECK")',
            'print("=" * 80)',
            'print("\n1. PYTHON ENVIRONMENT:")',
            'print(f"   Python: {sys.executable}")',
            'print(f"   Version: {sys.version}")',
            'print(f"   Platform: {sys.platform}")',
            'print(f"   Prefix: {sys.prefix}")',
            'print("\n2. MODULE SEARCH PATHS:")',
            'for i, p in enumerate(sys.path):',
            '    print(f"   [{i}] {p}")',
            'critical_modules = [',
            "    'fastapi', 'uvicorn', 'pydantic', 'pydantic_core', 'pydantic_settings',",
            "    'aiosqlite', 'slowapi', 'structlog', 'starlette', 'starlette.staticfiles',",
            "    'anyio', 'httpcore', 'httpx'",
            ']',
            'print("\n3. CRITICAL MODULE IMPORTS:")',
            'failed = []',
            'for mod in critical_modules:',
            '    try:',
            '        __import__(mod)',
            '        print(f"   âœ… {mod}")',
            '    except ImportError as e:',
            '        print(f"   âŒ {mod}: {e}")',
            '        failed.append((mod, str(e)))',
            '    except Exception as e:',
            '        print(f"   âš ï¸  {mod}: {type(e).__name__}: {e}")',
            'print("\n4. APPLICATION MODULES (${{ env.BACKEND_DIR }}):")',
            "app_modules = [",
            "    '${{ env.BACKEND_DIR }}',",
            "    '${{ env.BACKEND_DIR }}.main',",
            "    '${{ env.BACKEND_DIR }}.api',",
            "]",
            'for mod in app_modules:',
            '    try:',
            '        __import__(mod)',
            '        print(f"   âœ… {mod}")',
            '    except ImportError as e:',
            '        print(f"   âŒ {mod}: {e}")',
            '        failed.append((mod, str(e)))',
            '        traceback.print_exc()',
            '    except Exception as e:',
            '        print(f"   âš ï¸  {mod}: {type(e).__name__}: {e}")',
            '        traceback.print_exc()',
            'print("\n5. ASGI APP INSTANTIATION:")',
            'try:',
            "    from ${{ env.BACKEND_DIR }}.main import app",
            '    print(f"   âœ… Successfully imported app from main")',
            '    print(f"   App type: {type(app)}")',
            '    print(f"   App class: {app.__class__.__name__}")',
            'except ImportError as e:',
            '    print(f"   âŒ Failed to import app: {e}")',
            '    traceback.print_exc()',
            '    failed.append(("main.app", str(e)))',
            'except Exception as e:',
            '    print(f"   âš ï¸  {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            'print("\n" + "=" * 80)',
            'if failed:',
            '    print(f"FAILURES: {len(failed)} module(s) failed")',
            '    for mod, err in failed:',
            '        print(f"  - {mod}")',
            '        print(f"    {err[:100]}")',
            '    sys.exit(1)',
            'else:',
            '    print("âœ… ALL CHECKS PASSED")',
            '    sys.exit(0)',
            ''
          )
          $testScript | Out-File "diagnostics/import-analysis/pre-launch-test.py" -Encoding utf8

          python "diagnostics/import-analysis/pre-launch-test.py" 2>&1 | Tee-Object "diagnostics/import-analysis/pre-launch-output.txt"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "âš ï¸  Pre-launch Python check failed (but executable may still work)" -ForegroundColor Yellow
          }

      - name: ğŸ” Inspect Executable Contents (Strings Dump)
        run: |
          Set-StrictMode -Version Latest

          $exe = "dist/fortuna-backend.exe"

          # Extract strings from executable (look for module names, ports, etc.)
          # Note: This requires PowerShell Get-Content binary reading
          $content = [System.IO.File]::ReadAllBytes($exe)
          $text = [System.Text.Encoding]::ASCII.GetString($content)

          # Extract readable strings
          $strings = [regex]::Matches($text, '[A-Za-z0-9_.\-/]+') | ForEach-Object { $_.Value } | Sort-Object -Unique

          # Filter for interesting ones
          $interestingStrings = $strings | Where-Object {
            $_ -match '(uvicorn|fastapi|web_service|backend|main|api|asgi|starlette)' -or
            $_.Length -gt 20 -and $_ -match '(\.py|\.so|\.dll|Protocol|http)'
          }

          Write-Host "Found $($interestingStrings.Count) interesting strings in executable" -ForegroundColor Cyan
          $interestingStrings | Out-File "diagnostics/exe-analysis/interesting-strings.txt"
          $interestingStrings | Out-Host

      - name: ğŸ“Š Capture Environment for Service Launch
        run: |
          Set-StrictMode -Version Latest

          Get-ChildItem Env: | Out-File "diagnostics/environment/launch-environment.txt"

          $envVars = @{
            'API_KEY' = $env:API_KEY
            'FORTUNA_PORT' = $env:FORTUNA_PORT
            'FORTUNA_ENV' = $env:FORTUNA_ENV
            'PYTHONPATH' = $env:PYTHONPATH
            'PATH' = $env:PATH
            'TEMP' = $env:TEMP
            'TMP' = $env:TMP
          }

          @"
          === SERVICE LAUNCH ENVIRONMENT ===
          API_KEY: $($envVars['API_KEY'] ? '***SET***' : 'NOT SET')
          FORTUNA_PORT: $($envVars['FORTUNA_PORT'])
          FORTUNA_ENV: $($envVars['FORTUNA_ENV'])
          PYTHONPATH: $($envVars['PYTHONPATH'])
          TEMP: $($envVars['TEMP'])

          Full environment:
          "@ | Out-File "diagnostics/environment/service-environment.txt"

          $envVars.GetEnumerator() | ForEach-Object {
            "$($_.Key)=$($_.Value)" | Out-File -Append "diagnostics/environment/service-environment.txt"
          }

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 2: SERVICE LAUNCH WITH OBSESSIVE TRACING
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸš€ Start Service with Full Output Capture
        run: |
          Set-StrictMode -Version Latest

          $exe = Resolve-Path "dist/fortuna-backend.exe"
          $outLog = "service-logs/stdout.txt"
          $errLog = "service-logs/stderr.txt"

          Write-Host "Starting service..." -ForegroundColor Cyan
          Write-Host "Executable: $exe" -ForegroundColor Cyan
          Write-Host "Port: ${{ env.SERVICE_PORT }}" -ForegroundColor Cyan
          Write-Host "API_KEY: ***" -ForegroundColor Cyan

          # Set environment for subprocess
          $env:API_KEY = "${{ env.API_KEY }}"
          $env:FORTUNA_PORT = "${{ env.SERVICE_PORT }}"
          $env:FORTUNA_ENV = "smoke-test"
          $env:PYTHONUNBUFFERED = "1"  # Force unbuffered output

          # Start process with full I/O redirection
          $proc = Start-Process `
            -FilePath $exe `
            -PassThru `
            -RedirectStandardOutput $outLog `
            -RedirectStandardError $errLog `
            -NoNewWindow

          $backendPid = $proc.Id
          Write-Host "âœ… Service process started with PID: $backendPid" -ForegroundColor Green
          $backendPid | Out-File "service.pid" -Encoding ascii

          # Don't wait - proceed to health check
          Start-Sleep -Seconds 5

          # Check if process is still alive
          if (Get-Process -Id $backendPid -ErrorAction SilentlyContinue) {
            Write-Host "âœ… Process still alive after 5 seconds" -ForegroundColor Green
          } else {
            Write-Host "âŒ FATAL: Process died immediately" -ForegroundColor Red
            Write-Host "=== STDOUT ===" -ForegroundColor Red
            Get-Content $outLog
            Write-Host "=== STDERR ===" -ForegroundColor Red
            Get-Content $errLog
            exit 1
          }

      - name: ğŸ“Š Monitor Process While Running
        run: |
          Set-StrictMode -Version Latest

          $backendPid = Get-Content "service.pid" -Raw -ErrorAction SilentlyContinue
          if ($backendPid) {
            $proc = Get-Process -Id $backendPid -ErrorAction SilentlyContinue
            if ($proc) {
              $processInfo = @(
                "=== PROCESS INFO ===",
                "PID: $backendPid",
                "Name: $($proc.ProcessName)",
                "Memory: $([math]::Round($proc.WorkingSet / 1MB, 2)) MB",
                "CPU Time: $($proc.TotalProcessorTime)",
                "Threads: $($proc.Threads.Count)",
                "Handle Count: $($proc.HandleCount)"
              )
              $processInfo | Tee-Object "diagnostics/runtime-trace/process-info.txt"
            }
          }

          # Network state while running
          netstat -ano | Out-File "diagnostics/network-running.txt"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 3: HEALTH CHECK WITH AGGRESSIVE RETRIES & DEBUGGING
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ’“ Health Check (Retry Loop with Diagnostics)
        run: |
          Set-StrictMode -Version Latest

          $url = "http://127.0.0.1:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}"
          $maxRetries = 60  # 60 retries = 2 minutes
          $retryInterval = 2
          $attempt = 0
          $success = $false

          Write-Host "Health check URL: $url" -ForegroundColor Cyan
          Write-Host "Max retries: $maxRetries | Interval: $retryInterval seconds" -ForegroundColor Cyan

          $healthLog = "diagnostics/runtime-trace/health-check.log"

          while ($attempt -lt $maxRetries -and -not $success) {
            $attempt++
            $elapsed = ($attempt - 1) * $retryInterval

            Write-Host "Attempt $attempt/$maxRetries (${elapsed}s elapsed)..." -ForegroundColor Yellow

            try {
              # Attempt 1: Test-NetConnection (TCP)
              Write-Host "  [TCP Check]..." -ForegroundColor Gray
              $tcpTest = Test-NetConnection -ComputerName 127.0.0.1 -Port ${{ env.SERVICE_PORT }} -ErrorAction Stop
              if ($tcpTest.TcpTestSucceeded) {
                Write-Host "  âœ… TCP Connection successful" -ForegroundColor Green
                "[$attempt] TCP connection successful" | Out-File -Append $healthLog
              } else {
                Write-Host "  âŒ TCP connection failed" -ForegroundColor Red
                "[$ attempt] TCP connection failed" | Out-File -Append $healthLog
                throw "TCP connection failed"
              }

              # Attempt 2: HTTP Request
              Write-Host "  [HTTP GET]..." -ForegroundColor Gray
              $response = Invoke-WebRequest `
                -Uri $url `
                -UseBasicParsing `
                -TimeoutSec 10 `
                -ErrorAction Stop

              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… HEALTH CHECK PASSED (HTTP $($response.StatusCode))" -ForegroundColor Green
                $response.Content | Out-File "diagnostics/runtime-trace/health-response.json"
                $response.Content | Out-File -Append $healthLog
                $success = $true
                break
              } else {
                Write-Host "âš ï¸  Unexpected status: $($response.StatusCode)" -ForegroundColor Yellow
                "[$attempt] Status $($response.StatusCode)" | Out-File -Append $healthLog
              }

            } catch [System.Net.WebException] {
              $ex = $_
              Write-Host "  âŒ Request failed: $($ex.Exception.Message)" -ForegroundColor Red
              "[$attempt] WebException: $($ex.Exception.Message)" | Out-File -Append $healthLog

            } catch [System.Net.Sockets.SocketException] {
              $ex = $_
              Write-Host "  âŒ Socket error: $($ex.Exception.Message)" -ForegroundColor Red
              "[$attempt] SocketException: $($ex.Exception.Message)" | Out-File -Append $healthLog

            } catch {
              Write-Host "  âŒ Error: $_" -ForegroundColor Red
              "$attempt] Exception: $_" | Out-File -Append $healthLog
            }

            # Capture logs between attempts
            $stdoutTail = Get-Content "service-logs/stdout.txt" -Tail 5 -ErrorAction SilentlyContinue
            $stderrTail = Get-Content "service-logs/stderr.txt" -Tail 5 -ErrorAction SilentlyContinue

            if ($stderrTail) {
              Write-Host "  [STDERR tail]:" -ForegroundColor Gray
              $stderrTail | ForEach-Object { Write-Host "    $_" -ForegroundColor Red }
            }

            if ($attempt -lt $maxRetries) {
              Start-Sleep -Seconds $retryInterval
            }
          }

          if (-not $success) {
            Write-Host "âŒ FATAL: Health check failed after $maxRetries attempts" -ForegroundColor Red

            # FULL DIAGNOSTICS ON FAILURE
            Write-Host "`n=== FULL DIAGNOSTIC DUMP ===" -ForegroundColor Red

            Write-Host "`n[STDOUT - Last 50 lines]" -ForegroundColor Cyan
            Get-Content "service-logs/stdout.txt" -Tail 50

            Write-Host "`n[STDERR - Last 50 lines]" -ForegroundColor Cyan
            Get-Content "service-logs/stderr.txt" -Tail 50

            Write-Host "`n[Process Status]" -ForegroundColor Cyan
            $processId = Get-Content "service.pid" -Raw
            Get-Process -Id $processId -ErrorAction SilentlyContinue | Format-List

            Write-Host "`n[Port Binding Check]" -ForegroundColor Cyan
            netstat -ano | grep -E "127\.0\.0\.1:${{ env.SERVICE_PORT }}" 2>$null || `
              netstat -ano | Select-String "127.0.0.1" | Select-String "${{ env.SERVICE_PORT }}"

            Write-Host "`n[Firewall Rules]" -ForegroundColor Cyan
            Get-NetFirewallRule -DisplayName "*Fortuna*" -ErrorAction SilentlyContinue | Format-List

            exit 1
          }

      - name: ğŸ”Œ Test API Endpoint
        run: |
          Set-StrictMode -Version Latest

          $url = "http://127.0.0.1:${{ env.SERVICE_PORT }}/api/races"
          $headers = @{ 'X-API-Key' = "${{ env.API_KEY }}" }

          Write-Host "Testing API endpoint: $url" -ForegroundColor Cyan

          try {
            $response = Invoke-WebRequest `
              -Uri $url `
              -Headers $headers `
              -UseBasicParsing `
              -TimeoutSec 10

            Write-Host "âœ… API Response: HTTP $($response.StatusCode)" -ForegroundColor Green
            Write-Host "Response size: $($response.Content.Length) bytes" -ForegroundColor Cyan
            $response.Content | Out-File "diagnostics/runtime-trace/api-response.json"

          } catch {
            Write-Host "âš ï¸  API call failed (service running, but endpoint issue): $_" -ForegroundColor Yellow
          }

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 4: FRONTEND UI VERIFICATION
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: 'âš™ï¸ Setup Node.js for Frontend Server'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 'ğŸ“¦ Install Serve for Static Hosting'
        run: npm install -g serve

      - name: 'ğŸš€ Start Frontend Server'
        run: |
          serve -s frontend-dist -l 3000 > frontend-server.log 2>&1 &
          Start-Sleep -Seconds 5
          $proc = Get-Process -Name "serve"
          $frontendPid = $proc.Id
          Write-Host "âœ… Frontend server started with PID: $frontendPid"
          $frontendPid | Out-File "frontend.pid" -Encoding ascii
          Start-Sleep -Seconds 3

      - name: 'ğŸ§ª Frontend UI Verification'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          pip install playwright==1.48.2
          python -m playwright install chromium
          $scriptContent = @(
            'import sys, os, time',
            'from playwright.sync_api import sync_playwright, expect',
            '',
            'def run_verification():',
            '    url = "http://127.0.0.1:3000"  # FRONTEND port, not backend!',
            '',
            '    with sync_playwright() as p:',
            '        browser = p.chromium.launch()',
            '        page = browser.new_page()',
            '        page.tracing.start(screenshots=True, snapshots=True)',
            '',
            '        try:',
            '            print(f"[1] Navigating to {url}")',
            "            page.goto(url, wait_until='networkidle', timeout=20000)",
            '',
            '            print(f"[2] Page title: {page.title()}")',
            '            print(f"[3] Page URL: {page.url}")',
            '',
            '            # Diagnostic: Get all h1 tags',
            '            h1_elements = page.locator("h1").all()',
            '            print(f"[4] Found {len(h1_elements)} h1 tag(s)")',
            '            for i, elem in enumerate(h1_elements):',
            '                text = elem.text_content()',
            '                print(f"     h1[{i}] = \'{text}\'")',
            '',
            '            # Diagnostic: Check page content',
            '            content = page.content()',
            '            if "Fortuna Faucet" in content:',
            '                print("[5] âœ… \'Fortuna Faucet\' in HTML")',
            '            else:',
            '                print("[5] âŒ \'Fortuna Faucet\' NOT in HTML")',
            '                print(f"     Page length: {len(content)} bytes")',
            '                print(f"     First 500 chars: {content[:500]}")',
            '',
            '            # Assertion',
            "            heading = page.locator(\"h1:has-text('Fortuna Faucet')\")",
            '            expect(heading).to_be_visible(timeout=10000)',
            '',
            '            print("[6] âœ… UI test PASSED")',
            '            page.screenshot(path="smoke-test-screenshot.png")',
            '            page.tracing.stop(path="trace-success.zip")',
            '            sys.exit(0)',
            '',
            '        except Exception as e:',
            '            print(f"[ERROR] {type(e).__name__}: {e}", file=sys.stderr)',
            '            page.screenshot(path="smoke-test-screenshot-FAILURE.png")',
            '            page.tracing.stop(path="trace-failure.zip")',
            '            sys.exit(1)',
            '        finally:',
            '            browser.close()',
            '',
            'if __name__ == "__main__":',
            '    run_verification()',
            ''
          )
          Set-Content -Path "verify_frontend.py" -Value $scriptContent
          python verify_frontend.py

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # PHASE 4: POST-EXECUTION FORENSICS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Post-Test Forensics
        if: failure()
        run: |
          Set-StrictMode -Version Latest

          "=== TOP PROCESSES ===" | Out-File "diagnostics/forensics.log"
          Get-Process | Sort-Object CPU -Descending | Select-Object -First 20 | Out-File -Append "diagnostics/forensics.log"

          "=== NETWORK CONNECTIONS ===" | Out-File -Append "diagnostics/forensics.log"
          netstat -ano | Out-File -Append "diagnostics/forensics.log"

          "=== EVENT VIEWER (Last 20 errors) ===" | Out-File -Append "diagnostics/forensics.log"
          Get-EventLog -LogName System -EntryType Error -Newest 20 -ErrorAction SilentlyContinue | Out-File -Append "diagnostics/forensics.log"

          "=== DISK SPACE ===" | Out-File -Append "diagnostics/forensics.log"
          Get-Volume | Out-File -Append "diagnostics/forensics.log"

          "=== REGISTRY (FortunaWebService) ===" | Out-File -Append "diagnostics/forensics.log"
          Get-ItemProperty -Path "HKLM:\Software\FortunaWebService" -ErrorAction SilentlyContinue | Out-File -Append "diagnostics/forensics.log"

      - name: ğŸ“¤ Upload All Diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-diagnostics-${{ github.run_id }}
          path: |
            service-logs/
            diagnostics/
            service.pid
            frontend.pid
            frontend-server.log
            smoke-test-screenshot*.png
            trace-*.zip
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          if (Test-Path 'service.pid') {
            try {
              $backendPid = Get-Content 'service.pid' -Raw
              Stop-Process -Id $backendPid -Force -ErrorAction SilentlyContinue
              Write-Host "âœ… Backend service process terminated"
            } catch {
              Write-Host "âš ï¸  Could not terminate backend process"
            }
          }
          if (Test-Path 'frontend.pid') {
            try {
              $frontendPid = Get-Content 'frontend.pid' -Raw
              Stop-Process -Id $frontendPid -Force -ErrorAction SilentlyContinue
              Write-Host "âœ… Frontend server process terminated"
            } catch {
              Write-Host "âš ï¸  Could not terminate frontend process"
            }
          }
          Remove-NetFirewallRule -DisplayName "FortunaSmoke" -ErrorAction SilentlyContinue
          Remove-NetFirewallRule -DisplayName "FortunaSmokeHTTP" -ErrorAction SilentlyContinue

  package-msi-service:
    name: 'ğŸ’¿ Package Service MSI'
    runs-on: windows-latest
    timeout-minutes: 25
    needs: [repo-preflight, smoke-test]
    env:
      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}
      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}
      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Backend
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.run_id }}
          path: dist

      - name: Stage Artifacts
        id: stage
        run: |
          Set-StrictMode -Version Latest
          $staging = "${{ env.MSI_STAGING_DIR }}"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          # Rename the executable to match the service name defined in the WiX project
          Move-Item -Path "dist/fortuna-backend.exe" -Destination "$staging/fortuna-webservice.exe" -Force
          $msiName = "Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi".Replace('/', '-')
          "msi_name=$msiName" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "âœ… Staged for MSI: $msiName"

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}

      - name: Prepare WiX Project
        run: |
          Set-StrictMode -Version Latest
          Copy-Item "${{ env.WIX_DIR }}/Product_WithService.wxs" "${{ env.WIX_DIR }}/Product.wxs" -Force
          $wixProj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">'
            '  <PropertyGroup>'
            '    <OutputName>${{ steps.stage.outputs.msi_name }}</OutputName>'
            '    <OutputType>Package</OutputType>'
            '    <DefineConstants>SourceDir=staging</DefineConstants>'
            '    <Platforms>x64</Platforms>'
            '    <Version>${{ env.BUILD_VERSION }}</Version>'
            '  </PropertyGroup>'
            '  <ItemGroup>'
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />'
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />'
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />'
            '  </ItemGroup>'
            '  <ItemGroup>'
            '    <Compile Include="Product.wxs" />'
            '  </ItemGroup>'
            '</Project>'
          )
          Set-Content "${{ env.WIX_DIR }}/Fortuna.wixproj" -Value $wixProj -Encoding utf8

      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        run: |
          Set-StrictMode -Version Latest
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version="${{ env.BUILD_VERSION }}"
          $msiFile = "bin/x64/Release/${{ steps.stage.outputs.msi_name }}"
          if (-not (Test-Path $msiFile)) { throw "MSI not created" }
          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash
          $hash | Out-File "$msiFile.sha256" -Encoding utf8
          Write-Host "âœ… MSI Built: $hash"

      - name: Upload MSI + Hash
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-service-msi-${{ github.run_id }}
          path: |
            ${{ env.WIX_DIR }}/bin/x64/Release/*.msi
            ${{ env.WIX_DIR }}/bin/x64/Release/*.sha256
          retention-days: 10

  create-release:
    name: 'ğŸš€ Create Release'
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: package-msi-service
    permissions:
      contents: write
    steps:
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          pattern: fortuna-service-msi-*
          merge-multiple: true
          path: assets

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.run_id }}
          path: assets

      - name: Generate Checksums
        run: |
          cd assets
          ls *.msi
          sha256sum *.msi > SHASUMS256.txt

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            assets/*.msi
            assets/*.sha256
            assets/SHASUMS256.txt
            assets/sbom.spdx.json
          generate_release_notes: true
