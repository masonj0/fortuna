name: üíé Build Universal Monolith (Single EXE)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-the-monolith:
    name: 'üóø Build All-in-One EXE'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # --- PHASE 1: THE FRONTEND ---
      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üé® Build Frontend
        shell: pwsh
        run: |
          Write-Host "Building React Frontend..."
          cd web_platform/frontend
          npm ci
          npm run build

          # Validation
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed!" }

          # Stage it for the Backend to grab
          $root = "$env:GITHUB_WORKSPACE"
          Copy-Item -Path "out" -Destination "$root/frontend_dist" -Recurse -Force
          Write-Host "‚úÖ Frontend built and staged at $root/frontend_dist"

      # --- PHASE 2: THE BACKEND ---
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: x86
          cache: 'pip'

      - name: üßæ Create x86 Architecture Constraints
        shell: pwsh
        run: |
          "numpy==1.23.5" | Set-Content -Path "constraints.txt"
          "pandas==1.5.3" | Add-Content -Path "constraints.txt"
          Write-Host "‚úÖ Created constraints.txt for x86 build."

      - name: üì¶ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt -c constraints.txt
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32 -c constraints.txt

      # --- PHASE 2.5: SETUP HOOKS (NEW) ---
      - name: ü™ù Create PyInstaller Custom Hooks
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "fortuna-backend-hooks"

          # Custom Uvicorn Hook (CRITICAL for fixing ModuleNotFoundError)
          $uvicornHook = @(
            '"""',
            'Custom PyInstaller hook for Uvicorn',
            "Resolves: ModuleNotFoundError: No module named 'uvicorn'",
            '"""',
            'from PyInstaller.utils.hooks import collect_submodules, collect_data_files',
            '',
            '# Collect ALL uvicorn submodules (including runtime-loaded ones)',
            "hiddenimports = collect_submodules('uvicorn')",
            "datas = collect_data_files('uvicorn')",
            '',
            "# Explicit critical imports that PyInstaller's auto-detection misses",
            "hiddenimports += [",
            "    'uvicorn.logging',",
            "    'uvicorn.loops.auto',",
            "    'uvicorn.loops.asyncio',",
            "    'uvicorn.loops.uvloop',",
            "    'uvicorn.protocols.http.auto',",
            "    'uvicorn.protocols.http.h11_impl',",
            "    'uvicorn.protocols.http.httptools_impl',",
            "    'uvicorn.protocols.websockets.auto',",
            "    'uvicorn.protocols.websockets.websockets_impl',",
            "    'uvicorn.protocols.websockets.wsproto_impl',",
            "    'uvicorn.lifespan.on',",
            "    'uvicorn.lifespan.off',",
            "]"
          )
          $uvicornHook | Set-Content -Path "fortuna-backend-hooks/hook-uvicorn.py"

          # Custom FastAPI Hook (Belt & Suspenders)
          $fastapiHook = @(
            '"""Custom PyInstaller hook for FastAPI"""',
            'from PyInstaller.utils.hooks import collect_submodules, collect_data_files',
            '',
            "hiddenimports = collect_submodules('fastapi')",
            "datas = collect_data_files('fastapi')"
          )
          $fastapiHook | Set-Content -Path "fortuna-backend-hooks/hook-fastapi.py"

          Write-Host "‚úÖ Custom PyInstaller hooks created:"
          Get-ChildItem "fortuna-backend-hooks" | ForEach-Object { Write-Host "   - $($_.Name)" }

      # --- PHASE 3: THE DATA DIRECTORIES ---
      - name: üìÅ Create Required Data Dirs
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data"
          New-Item -ItemType Directory -Force -Path "web_service/backend/json"
          Write-Host "‚úÖ Ensured data directories exist for PyInstaller."

      # --- PHASE 4: THE MERGE (PyInstaller) ---
      - name: üîÆ Generate Enhanced Spec & Build
        shell: pwsh
        run: |
          $specContent = @(
            '# -*- mode: python ; coding: utf-8 -*-',
            '"""',
            'Fortuna Universal Monolith Spec',
            'Single EXE with embedded frontend and backend',
            'FIXED: Enhanced uvicorn imports to resolve ModuleNotFoundError',
            '"""',
            'from PyInstaller.utils.hooks import collect_submodules, collect_data_files',
            'import os',
            '',
            'block_cipher = None',
            '',
            '# ====================================================================',
            '# DATA FILES (Frontend + Backend)',
            '# ====================================================================',
            "datas = [",
            "    ('frontend_dist', 'frontend_dist'),  # Staged React frontend",
            "]",
            '',
            '# Framework data files',
            "datas += collect_data_files('uvicorn')",
            "datas += collect_data_files('fastapi')",
            "datas += collect_data_files('starlette')",
            '',
            '# Backend data',
            "datas += [",
            "    ('web_service/backend/data', 'data'),",
            "    ('web_service/backend/json', 'json'),",
            "    ('web_service/backend/adapters', 'adapters')",
            "]",
            '',
            '# ====================================================================',
            '# HIDDEN IMPORTS (ENHANCED for Uvicorn)',
            '# ====================================================================',
            "hiddenimports = [",
            "    # === UVICORN (COMPLETE SET) ===",
            "    'uvicorn',",
            "    'uvicorn.logging',",
            "    'uvicorn.loops',",
            "    'uvicorn.loops.auto',",
            "    'uvicorn.loops.asyncio',",
            "    'uvicorn.loops.uvloop',",
            "    'uvicorn.protocols',",
            "    'uvicorn.protocols.http',",
            "    'uvicorn.protocols.http.auto',",
            "    'uvicorn.protocols.http.h11_impl',",
            "    'uvicorn.protocols.http.httptools_impl',",
            "    'uvicorn.protocols.websockets',",
            "    'uvicorn.protocols.websockets.auto',",
            "    'uvicorn.protocols.websockets.websockets_impl',",
            "    'uvicorn.protocols.websockets.wsproto_impl',",
            "    'uvicorn.lifespan',",
            "    'uvicorn.lifespan.on',",
            "    'uvicorn.lifespan.off',",
            "    ",
            "    # === FASTAPI & STARLETTE ===",
            "    'fastapi',",
            "    'starlette',",
            "    'starlette.routing',",
            "    'starlette.middleware',",
            "    'starlette.middleware.cors',",
            "    'pydantic',",
            "    'pydantic_core',",
            "    'pydantic_settings',",
            "    'pydantic_settings.sources',",
            "    ",
            "    # === WEBVIEW (for GUI) ===",
            "    'webview',",
            "    'webview.platforms.winforms',",
            "    'clr',",
            "    ",
            "    # === WINDOWS SERVICES ===",
            "    'win32timezone',",
            "    'win32serviceutil',",
            "    'win32service',",
            "    'win32event',",
            "    'servicemanager',",
            "    ",
            "    # === OTHER DEPS ===",
            "    'structlog',",
            "    'tenacity',",
            "    'redis',",
            "    'sqlalchemy',",
            "    'greenlet',",
            "]",
            '',
            "# Collect ALL submodules (belt & suspenders approach)",
            "hiddenimports += collect_submodules('web_service.backend')",
            "hiddenimports += collect_submodules('anyio')",
            "hiddenimports += collect_submodules('uvicorn')",
            "hiddenimports += collect_submodules('fastapi')",
            "hiddenimports += collect_submodules('starlette')",
            '',
            '# ====================================================================',
            '# ANALYSIS',
            '# ====================================================================',
            "a = Analysis(",
            "    ['web_service/backend/monolith.py'],",
            "    pathex=[],",
            "    binaries=[],",
            "    datas=datas,",
            "    hiddenimports=hiddenimports,",
            "    hookspath=['fortuna-backend-hooks'],  # Use our custom hooks",
            "    hooksconfig={},",
            "    runtime_hooks=[],",
            "    excludes=[],",
            "    win_no_prefer_redirects=False,",
            "    win_private_assemblies=False,",
            "    cipher=block_cipher,",
            "    noarchive=False,",
            ")",
            '',
            "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)",
            '',
            '# ====================================================================',
            '# SINGLE FILE EXECUTABLE',
            '# ====================================================================',
            "exe = EXE(",
            "    pyz,",
            "    a.scripts,",
            "    a.binaries,",
            "    a.zipfiles,",
            "    a.datas,",
            "    name='FortunaApp',",
            "    debug=False,",
            "    bootloader_ignore_signals=False,",
            "    strip=False,",
            "    upx=True,",
            "    upx_exclude=[],",
            "    runtime_tmpdir=None,",
            "    console=False,  # GUI Mode (No console window)",
            "    disable_windowed_traceback=False,",
            "    argv_emulation=False,",
            "    target_arch='x86',",
            "    codesign_identity=None,",
            "    entitlements_file=None,",
            ")"
          )
          $specContent | Set-Content -Path "universal.spec"
          Write-Host "‚úÖ Enhanced spec file generated"

          # Build it
          Write-Host "üî® Building single EXE (this takes ~5 minutes)..."
          pyinstaller --noconfirm --clean universal.spec

      # --- PHASE 5: VERIFICATION ---
      - name: üîç Verify Build Output
        shell: pwsh
        run: |
          if (-not (Test-Path "dist/FortunaApp.exe")) {
            throw "‚ùå Build failed - FortunaApp.exe not found"
          }

          $fileInfo = Get-Item "dist/FortunaApp.exe"
          Write-Host "‚úÖ Build successful:"
          Write-Host "   Size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          Write-Host "   Path: dist/FortunaApp.exe"

      # --- PHASE 6: SMOKE TEST ---
      - name: üß™ Smoke Test (Launch & Kill)
        shell: pwsh
        timeout-minutes: 2
        run: |
          Write-Host "üöÄ Starting FortunaApp.exe..."
          Start-Process "dist/FortunaApp.exe"

          Write-Host "‚è≥ Waiting 10 seconds for startup..."
          Start-Sleep -Seconds 10

          $process = Get-Process -Name "FortunaApp" -ErrorAction SilentlyContinue
          if ($null -eq $process) {
            throw "‚ùå App didn't start - check for missing modules"
          }

          Write-Host "‚úÖ App is running (PID: $($process.Id))"

          Stop-Process -Name "FortunaApp" -Force
          Write-Host "‚úÖ Smoke test passed"

      # --- PHASE 7: ARTIFACT UPLOAD ---
      - name: üì§ Upload The Monolith
        uses: actions/upload-artifact@v4
        with:
          name: FortunaApp-Universal-x86
          path: dist/FortunaApp.exe
          retention-days: 30
