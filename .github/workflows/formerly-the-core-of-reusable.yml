name: üß¨ Standalone Monolith SPA Builder

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-monolith:
    name: 'üóø Build Python SPA Monolith'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # --- Frontend Build ---
      - name: üé® Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed" }
          Copy-Item -Path "out" -Destination "${{ github.workspace }}/frontend_dist" -Recurse -Force

      # --- Backend Build ---
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32

      - name: üìÅ Create Required Data Dirs
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data"
          New-Item -ItemType Directory -Force -Path "web_service/backend/json"

      # --- PyInstaller Build ---
      - name: üîÆ Generate Spec & Build
        shell: pwsh
        run: |
          $specContent = @(
            '# -*- mode: python ; coding: utf-8 -*-',
            'from PyInstaller.utils.hooks import collect_submodules, collect_data_files',
            'import os',
            'block_cipher = None',
            "datas = [('frontend_dist', 'frontend_dist')]",
            "hiddenimports = [",
            "    'web_service.backend.api',",
            "    'web_service.backend.monolith',",
            "    'uvicorn', 'uvicorn.logging', 'uvicorn.loops', 'uvicorn.loops.auto', 'uvicorn.loops.asyncio',",
            "    'uvicorn.protocols', 'uvicorn.protocols.http', 'uvicorn.protocols.http.auto', 'uvicorn.protocols.http.h11_impl',",
            "    'uvicorn.lifespan', 'uvicorn.lifespan.on', 'uvicorn.lifespan.off', 'uvicorn.config', 'uvicorn.server',",
            "    'h11', 'httptools', 'httpx', 'httpcore',",
            "    'fastapi', 'starlette',",
            "    'pydantic', 'pydantic_core', 'pydantic_settings',",
            "    'webview', 'webview.platforms', 'webview.platforms.winforms', 'clr', 'System',",
            "    'anyio', 'anyio._backends', 'anyio._backends._asyncio',",
            "    'structlog', 'logging.config',",
            "    'tenacity', 'redis', 'sqlalchemy', 'greenlet', 'win32timezone', 'win32api', 'win32con'",
            "]",
            "hiddenimports += collect_submodules('web_service.backend')",
            "hiddenimports += collect_submodules('uvicorn')",
            "hiddenimports += collect_submodules('fastapi')",
            "hiddenimports += collect_submodules('starlette')",
            "a = Analysis(",
            "    ['web_service/backend/monolith.py'],",
            "    datas=datas,",
            "    hiddenimports=hiddenimports,",
            "    runtime_hooks=[],",
            "    excludes=[],",
            "    cipher=block_cipher",
            ")",
            "pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)",
            "exe = EXE(",
            "    pyz, a.scripts, a.binaries, a.zipfiles, a.datas,",
            "    name='Fortuna-SPA-Monolith',",
            "    console=True,",
            "    icon='electron/assets/icon.ico'",
            ")"
          )
          $specContent | Set-Content -Path "generated.spec"
          pyinstaller --noconfirm --clean generated.spec

      # --- Verification ---
      - name: üîç Verify Build
        id: verify
        shell: pwsh
        run: |
          $exePath = "dist/Fortuna-SPA-Monolith.exe"
          if (-not (Test-Path $exePath)) {
            throw "PyInstaller build failed - EXE not found at $exePath"
          }
          Write-Host "‚úÖ Monolith built successfully at $exePath"

      - name: üß™ Smoke Test
        shell: pwsh
        timeout-minutes: 2
        run: |
          Write-Host "üöÄ Starting Fortuna-SPA-Monolith.exe..."
          Start-Process -FilePath "dist/Fortuna-SPA-Monolith.exe"

          Write-Host "‚è≥ Waiting for server..."
          $maxAttempts = 20
          $attempt = 0
          $success = $false

          while ($attempt -lt $maxAttempts -and -not $success) {
            Start-Sleep -Seconds 1
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -TimeoutSec 2 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                $success = $true
                Write-Host "‚úÖ Server responded on attempt $attempt"
              }
            } catch {
              Write-Host "   Attempt $attempt - waiting..."
            }
          }

          if (-not $success) {
            Write-Host "‚ùå Server never responded!"
            $logPath = "$env:TEMP\fortuna-monolith.log"
            if (Test-Path $logPath) {
              Write-Host "--- LOG FILE CONTENTS ---"
              Get-Content $logPath
            } else {
              Write-Host "--- LOG FILE NOT FOUND ---"
            }
            throw "Smoke test failed: Server did not respond at http://127.0.0.1:8000/api/health"
          }

          try {
            Stop-Process -Name "Fortuna-SPA-Monolith" -Force -ErrorAction Stop
            Write-Host "üõë Stopped Fortuna-SPA-Monolith process."
          } catch {
            Write-Host "ü§î Process not found, may have already terminated."
          }

          Write-Host "‚úÖ Smoke test passed"

      - name: üì§ Upload Monolith Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fortuna-SPA-Monolith
          path: dist/Fortuna-SPA-Monolith.exe
          retention-days: 7
