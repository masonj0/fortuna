name: üê¥ Fortuna - Instant Filtered Race Report

on:
  workflow_dispatch:  # Manual trigger from Actions tab
  push:
    branches:
      - main
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

concurrency:
  group: fortuna-report-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate-race-report:
    name: 'üìä Generate Filtered Race List'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]  # Windows for native exe support

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: üì¶ Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          pip install requests

      - name: üìÇ Create Runtime Directories
        shell: pwsh
        run: |
          $dirs = @(
            "web_service/backend/data",
            "web_service/backend/json",
            "web_service/backend/logs"
          )
          foreach ($dir in $dirs) {
            New-Item -ItemType Directory -Force -Path $dir | Out-Null
          }
          Write-Host "‚úÖ Runtime directories created"

      - name: üöÄ Start Backend Service
        shell: pwsh
        env:
          PYTHONUNBUFFERED: '1'
          PYTHONUTF8: '1'
        run: |
          Write-Host "Starting backend service..." -ForegroundColor Cyan

          # Start uvicorn in background job
          $job = Start-Job -ScriptBlock {
            Set-Location "${{ github.workspace }}"
            $env:PYTHONPATH = "${{ github.workspace }}"
            python -m uvicorn web_service.backend.main:app --host 127.0.0.1 --port 8000 --log-level warning
          }

          # Store job ID for later cleanup
          $job.Id | Out-File -FilePath "backend-job.txt"
          Write-Host "Backend job started (ID: $($job.Id))"

      - name: ‚è≥ Wait for Backend Health Check
        shell: pwsh
        run: |
          Write-Host "Waiting for backend to be healthy..." -ForegroundColor Cyan

          $healthUrl = "http://127.0.0.1:8000/api/health"
          $maxAttempts = 30
          $attempt = 0
          $healthy = $false

          while ($attempt -lt $maxAttempts) {
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Backend is healthy!" -ForegroundColor Green
                $healthy = $true
                break
              }
            } catch {
              Write-Host "...attempt $attempt/$maxAttempts, retrying..."
              Start-Sleep -Seconds 1
            }
          }

          if (-not $healthy) {
            Write-Host "‚ùå Backend failed to start" -ForegroundColor Red
            exit 1
          }

      - name: üìä Query Filtered Race Data
        shell: pwsh
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          Write-Host "Fetching qualified races..." -ForegroundColor Cyan

          $apiUrl = "http://127.0.0.1:8000/api/races/qualified/trifecta"
          $headers = @{ "X-API-Key" = "${{ env.API_KEY }}" }

          try {
            $races = Invoke-RestMethod -Uri $apiUrl -Headers $headers -TimeoutSec 10

            # Save JSON
            $races | ConvertTo-Json -Depth 10 | Out-File -FilePath "qualified_races.json" -Encoding utf8

            $count = $races.races.Count
            Write-Host "‚úÖ Retrieved $count qualified races" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Failed to fetch races: $_" -ForegroundColor Red
            exit 1
          }

      - name: üé® Generate HTML Report
        shell: pwsh
        run: pwsh -File scripts/generate_report.ps1 -JsonInputPath qualified_races.json -HtmlOutputPath race-report.html

      - name: üì§ Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-race-report-${{ github.run_number }}
          path: |
            race-report.html
            qualified_races.json
          retention-days: 30
          if-no-files-found: warn

      - name: üìã Create Job Summary
        if: always()
        shell: pwsh
        run: |
          $races = Get-Content "qualified_races.json" -ErrorAction SilentlyContinue | ConvertFrom-Json -ErrorAction SilentlyContinue
          $count = $races.races.Count ?? 0

          $summaryLines = @(
              "## üê¥ Fortuna Race Report Summary",
              "",
              "**Report Generated:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')",
              "",
              "**Total Qualified Races:** $count",
              "",
              "### Download Artifacts",
              "- üìÑ [HTML Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
              "- üìä [Raw JSON Data](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
              "",
              "### Status",
              "- ‚úÖ Backend service started",
              "- ‚úÖ Health check passed",
              "- ‚úÖ Race data fetched",
              "- ‚úÖ Report generated"
          )

          $summary = $summaryLines -join "`n"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary

      - name: üõë Cleanup Backend
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up backend process..." -ForegroundColor Yellow

          $jobFile = "backend-job.txt"
          if (Test-Path $jobFile) {
            $jobId = Get-Content $jobFile
            try {
              Stop-Job -Id $jobId -ErrorAction SilentlyContinue
              Remove-Job -Id $jobId -ErrorAction SilentlyContinue
              Write-Host "‚úÖ Backend process stopped cleanly"
            } catch {
              Write-Host "‚ö†Ô∏è Could not stop job: $_"
            }
          }

          # Kill any orphaned python processes
          Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
