name: ðŸ´ Fortuna - Debug & Generate Report

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt
          pip install requests

      - name: ðŸ“‚ Create Runtime Directories
        run: |
          mkdir -p web_service/backend/data
          mkdir -p web_service/backend/json
          mkdir -p web_service/backend/logs
          mkdir -p scripts/templates

      - name: ðŸ” Debug - Start Backend with Logging
        env:
          PYTHONUTF8: '1'
          API_KEY: ${{ secrets.API_KEY || 'a_secure_test_api_key_that_is_long_enough' }}
        run: |
          echo "ðŸš€ Starting backend server..."
          # Start server in background, capture logs
          python -m uvicorn web_service.backend.main:app --host 127.0.0.1 --port 8000 > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "Backend PID: $BACKEND_PID"

          # Wait for health
          echo "â³ Waiting for health check..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8000/api/health > /dev/null 2>&1; then
              echo "âœ… Backend is healthy!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

          # Show backend logs so far
          echo "ðŸ“‹ Backend startup logs:"
          cat backend.log || echo "No logs yet"

      - name: ðŸ” Debug - Inspect Available Endpoints
        run: |
          echo "ðŸ” Testing available endpoints..."
          echo ""

          echo "1ï¸âƒ£ Health endpoint (no auth):"
          curl -v http://127.0.0.1:8000/api/health 2>&1 || true
          echo ""

          echo "2ï¸âƒ£ Testing /api/races (with API key):"
          curl -v -H "X-API-Key: a_secure_test_api_key_that_is_long_enough" \
               http://127.0.0.1:8000/api/races 2>&1 || true
          echo ""

          echo "3ï¸âƒ£ Testing /api/races (without API key):"
          curl -v http://127.0.0.1:8000/api/races 2>&1 || true
          echo ""

          echo "4ï¸âƒ£ Testing qualified endpoint (with API key):"
          curl -v -H "X-API-Key: a_secure_test_api_key_that_is_long_enough" \
               http://127.0.0.1:8000/api/races/qualified/tiny_field_trifecta 2>&1 || true
          echo ""

          echo "5ï¸âƒ£ Testing qualified endpoint (without API key):"
          curl -v http://127.0.0.1:8000/api/races/qualified/tiny_field_trifecta 2>&1 || true
          echo ""

          echo "6ï¸âƒ£ Adapter status endpoint:"
          curl -v -H "X-API-Key: a_secure_test_api_key_that_is_long_enough" \
               http://127.0.0.1:8000/api/adapters/status 2>&1 || true
          echo ""

      - name: ðŸ” Debug - Check Backend Logs for Errors
        if: always()
        run: |
          echo "ðŸ“‹ Full Backend Logs:"
          cat backend.log || echo "No backend logs found"

      - name: ðŸ” Debug - Check Backend Configuration
        run: |
          echo "ðŸ” Checking backend configuration files..."

          if [ -f "web_service/backend/.env" ]; then
            echo "Found .env file:"
            cat web_service/backend/.env | grep -v "PASSWORD\|SECRET\|KEY" || true
          else
            echo "No .env file found"
          fi

          echo ""
          echo "ðŸ” Checking for config files:"
          find web_service/backend -name "*.yaml" -o -name "*.yml" -o -name "config.py" 2>/dev/null || echo "No config files found"

      - name: ðŸš€ Generate Report (with enhanced debugging)
        env:
          API_KEY: ${{ secrets.API_KEY || 'a_secure_test_api_key_that_is_long_enough' }}
        run: |
          echo "ðŸ“Š Running report generation script..."
          python scripts/query_and_generate_report.py || true

          echo ""
          echo "ðŸ“‹ Checking output files:"
          ls -lh race-report.html qualified_races.json 2>/dev/null || echo "No output files generated"

      - name: ðŸ“¤ Upload Debug Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ github.run_number }}
          path: |
            backend.log
            *.log
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ“¤ Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-report-${{ github.run_number }}
          path: race-report.html
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“¤ Upload JSON Data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-data-${{ github.run_number }}
          path: qualified_races.json
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“‹ Create Detailed Summary
        if: always()
        run: |
          echo "## ðŸ´ Fortuna Debug Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“Š Output Files" >> $GITHUB_STEP_SUMMARY
          if [ -f "race-report.html" ]; then
            SIZE=$(du -h race-report.html | cut -f1)
            echo "- âœ… HTML Report: Generated ($SIZE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ HTML Report: Not generated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "qualified_races.json" ]; then
            SIZE=$(du -h qualified_races.json | cut -f1)
            RACES=$(jq '.races | length' qualified_races.json 2>/dev/null || echo "unknown")
            echo "- âœ… JSON Data: Generated ($SIZE, $RACES races)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ JSON Data: Not generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Debug Information" >> $GITHUB_STEP_SUMMARY
          echo "Backend logs have been uploaded as an artifact. Check the workflow artifacts for:" >> $GITHUB_STEP_SUMMARY
          echo "- \`backend.log\` - Full backend server logs" >> $GITHUB_STEP_SUMMARY
          echo "- API endpoint test results in step outputs" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the 'Debug - Inspect Available Endpoints' step output" >> $GITHUB_STEP_SUMMARY
          echo "2. Check which endpoints return 200 vs 403" >> $GITHUB_STEP_SUMMARY
          echo "3. Download backend.log artifact to see server-side errors" >> $GITHUB_STEP_SUMMARY
          echo "4. Verify API key requirements in your backend code" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Stopping backend processes..."
          pkill -f "uvicorn" || true
          sleep 2
