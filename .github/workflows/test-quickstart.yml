name: üß™ Backend CI & Quick-Start Test

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  test-bootstrapper:
    name: 'üèÉ Run Quick-Start PS1'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web_platform/frontend/package-lock.json

      - name: üì¶ Install Python Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt
          pip install -r web_service/backend/requirements-dev.txt

      - name: üß™ Run Backend Unit Tests
        shell: pwsh
        run: |
          $env:PYTHONPATH = "$env:PYTHONPATH;${env:GITHUB_WORKSPACE}/web_service/backend"
          python -m pytest web_service/backend/tests/

      - name: üîç Syntax Validation
        shell: pwsh
        run: |
          try {
            $script = Get-Content "scripts/fortuna-quick-start.ps1" -Raw
            [void][System.Management.Automation.PSParser]::Tokenize($script, [ref]$null)
            Write-Host "‚úÖ PowerShell Syntax is valid."
          } catch {
            Write-Error "‚ùå Syntax Error: $_"
            exit 1
          }

      - name: üöÄ Execute Bootstrapper
        shell: pwsh
        run: |
          Write-Host "Starting script in CI mode..."
          # Run with -Clean to test dependency installation
          # Run with -NoFrontend to focus on Backend health first
          # *>&1 combines stdout/stderr, Tee-Object saves to file AND shows in console
          ./scripts/fortuna-quick-start.ps1 -Clean -NoFrontend *>&1 | Tee-Object -FilePath "bootstrapper_log.txt"

      - name: üì§ Upload Debug Logs
        if: always() # CRITICAL: Run this even if the bootstrapper crashes
        uses: actions/upload-artifact@v4
        with:
          name: quickstart-debug-logs
          path: |
            bootstrapper_log.txt
            web_service/backend/*.log
            web_service/backend/logs/*.log

      - name: ü©∫ Verify Backend Health
        shell: pwsh
        run: |
          $url = "http://127.0.0.1:8000/docs"
          Write-Host "‚è≥ Waiting for Backend at $url..."

          # Give it up to 60 seconds to install deps and start
          for ($i=0; $i -lt 20; $i++) {
            try {
              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 2
              if ($resp.StatusCode -eq 200) {
                Write-Host "‚úÖ Backend is UP and responding! The script works."
                return
              }
            } catch {
              Write-Host "... ping failed, retrying ($i/20)"
              Start-Sleep -Seconds 3
            }
          }
          throw "‚ùå Backend failed to start within timeout."

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          # The script spawns 'pwsh' and 'python' processes. Kill them.
          Stop-Process -Name "uvicorn", "python", "pwsh" -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Cleanup complete."