name: üß™ Backend CI & Quick-Start Test

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  test-bootstrapper:
    name: 'üèÉ Run Quick-Start PS1'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üü¢ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web_platform/frontend/package-lock.json

      - name: üì¶ Install Python Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt
          pip install -r web_service/backend/requirements-dev.txt

      - name: üß™ Run Backend Unit Tests
        shell: pwsh
        run: |
          $env:PYTHONPATH = "$env:PYTHONPATH;${env:GITHUB_WORKSPACE}/web_service/backend"
          python -m pytest web_service/backend/tests/

      - name: üîç Syntax Validation
        shell: pwsh
        run: |
          try {
            $script = Get-Content "scripts/fortuna-quick-start.ps1" -Raw
            [void][System.Management.Automation.PSParser]::Tokenize($script, [ref]$null)
            Write-Host "‚úÖ PowerShell Syntax is valid."
          } catch {
            Write-Error "‚ùå Syntax Error: $_"
            exit 1
          }

      - name: üöÄ Launch Backend & Verify Health
        shell: pwsh
        run: |
          # Start the server as a background process directly.
          # All STDERR/STDOUT will go to the main job log.
          Start-Process "${{ steps.setup-python.outputs.python-path }}" -ArgumentList "-m uvicorn web_service.backend.main:app --host 127.0.0.1 --port 8000" -NoNewWindow

          # Health Check Loop
          $url = "http://127.0.0.1:8000/api/health"
          Write-Host "‚è≥ Waiting for Backend at $url..."
          for ($i=0; $i -lt 30; $i++) {
            try {
              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 2
              if ($resp.StatusCode -eq 200) {
                Write-Host "‚úÖ Backend is UP and responding!"
                # Capture logs for debugging if needed later
                Get-Content web_service/backend/app.log -ErrorAction SilentlyContinue
                exit 0 # Success
              }
            } catch {
              Write-Host "... ping failed, retrying ($($i+1)/30)"
              Start-Sleep -Seconds 2
            }
          }

          Write-Error "‚ùå Backend failed to start within timeout."
          # If it fails, dump the logs for diagnosis
          Get-Content web_service/backend/app.log -ErrorAction SilentlyContinue
          exit 1

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          # The script spawns 'pwsh' and 'python' processes. Kill them.
          Stop-Process -Name "uvicorn", "python", "pwsh" -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Cleanup complete."