name: PyInstaller Diagnostic Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  diagnostic-build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # ========== ENVIRONMENT INFO ==========
      - name: üìã Environment Diagnostics
        shell: pwsh
        run: |
          Write-Host "=== SYSTEM INFO ===" -ForegroundColor Cyan
          Write-Host "OS: $([System.Environment]::OSVersion.VersionString)"
          Write-Host "PowerShell: $($PSVersionTable.PSVersion)"
          Write-Host "Working Directory: $(Get-Location)"
          Write-Host ""

          Write-Host "=== DIRECTORY STRUCTURE ===" -ForegroundColor Cyan
          Get-ChildItem -Recurse -Depth 2 | Select-Object FullName | Format-Table -AutoSize

      # ========== PYTHON SETUP ==========
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: üì¶ Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "=== INSTALLING DEPENDENCIES ===" -ForegroundColor Cyan
          python -m pip install --upgrade pip wheel
          pip install pyinstaller==6.6.0

          # Try to find requirements.txt
          $reqFiles = @(
            "web_service/backend/requirements.txt",
            "requirements.txt",
            "python_service/requirements.txt"
          )

          foreach ($req in $reqFiles) {
            if (Test-Path $req) {
              Write-Host "‚úÖ Found requirements at: $req" -ForegroundColor Green
              pip install -r $req
              break
            }
          }

          Write-Host ""
          Write-Host "=== INSTALLED PACKAGES ===" -ForegroundColor Cyan
          pip freeze > pip-freeze.log
          pip list

      # ========== FRONTEND SETUP ==========
      - name: üé® Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üèóÔ∏è Build Frontend (with detailed logging)
        working-directory: ./web_service/frontend
        shell: pwsh
        run: |
          Write-Host "=== FRONTEND BUILD START ===" -ForegroundColor Cyan
          Write-Host "Installing npm dependencies..."
          npm ci 2>&1 | Tee-Object -FilePath "../../npm-install.log"

          Write-Host "Running build..."
          npm run build 2>&1 | Tee-Object -FilePath "../../npm-build.log"

          if (-not $frontendDir) {
            Write-Error "‚ùå Could not find frontend directory!"
            exit 1
          }

          cd $frontendDir

          Write-Host "Installing npm dependencies..."
          npm ci 2>&1 | Tee-Object -FilePath "../../npm-install.log"

          Write-Host "Running build..."
          npm run build 2>&1 | Tee-Object -FilePath "../../npm-build.log"

          # Verify output
          if (Test-Path "out") {
            Write-Host "‚úÖ 'out' directory created" -ForegroundColor Green
            $fileCount = (Get-ChildItem -Path "out" -Recurse -File).Count
            Write-Host "   Files in 'out': $fileCount"

            if (Test-Path "out/index.html") {
              Write-Host "‚úÖ index.html exists" -ForegroundColor Green
            } else {
              Write-Error "‚ùå index.html NOT found in 'out'"
              Write-Host "Contents of 'out' directory:"
              Get-ChildItem -Path "out" -Recurse | Format-Table Name, FullName
              exit 1
            }
          } else {
            Write-Error "‚ùå 'out' directory was NOT created"
            Write-Host "Contents of frontend directory:"
            Get-ChildItem | Format-Table Name
            exit 1
          }

          cd ../..
          Write-Host "=== FRONTEND BUILD COMPLETE ===" -ForegroundColor Green

      # ========== PYINSTALLER SETUP ==========
      - name: üî© Create Missing Data Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data"
          New-Item -ItemType Directory -Force -Path "web_service/backend/json"

      - name: üìÅ Verify Paths for PyInstaller
        shell: pwsh
        run: |
          Write-Host "=== PATH VERIFICATION ===" -ForegroundColor Cyan

          $paths = @{
            "Frontend Output" = "web_platform/frontend/out"
            "Backend Main" = "web_service/backend/main.py"
            "Spec File" = "fortuna-monolith-diagnostic.spec"
            "Icon" = "assets/icon.ico"
            "Backend Data" = "web_service/backend/data"
            "Backend JSON" = "web_service/backend/json"
          }

          $allGood = $true
          foreach ($name in $paths.Keys) {
            $path = $paths[$name]
            if (Test-Path $path) {
              Write-Host "‚úÖ $name`: $path" -ForegroundColor Green
            } else {
              Write-Host "‚ùå $name`: $path (NOT FOUND)" -ForegroundColor Red
              $allGood = $false
            }
          }

          if (-not $allGood) {
            Write-Error "Some required paths are missing!"
            exit 1
          }

      # ========== PYINSTALLER BUILD ==========
      - name: "Generate Pre-Build File Listing"
        shell: pwsh
        run: |
          Write-Host "Generating file listing before build..."
          Get-ChildItem -Recurse | Select-Object FullName, Length, LastWriteTime | Out-File -FilePath "directory-listing.log"
          Write-Host "File listing saved to directory-listing.log"

      - name: üî® Run PyInstaller (with verbose logging)
        shell: pwsh
        env:
          PYTHONIOENCODING: utf-8
        run: |
          Write-Host "=== PYINSTALLER BUILD START ===" -ForegroundColor Cyan

          # Run PyInstaller with maximum verbosity
          pyinstaller --noconfirm --clean --log-level DEBUG fortuna-monolith.spec 2>&1 | Tee-Object -FilePath "pyinstaller-build.log"

          Write-Host ""
          Write-Host "=== BUILD OUTPUT ANALYSIS ===" -ForegroundColor Cyan

          if (Test-Path "build") {
            Write-Host "‚úÖ 'build' directory exists"
            Get-ChildItem "build" -Recurse -Depth 1 | Format-Table Name, FullName
          }

          if (Test-Path "dist") {
            Write-Host "‚úÖ 'dist' directory exists"
            Get-ChildItem "dist" -Recurse -Depth 1 | Format-Table Name, FullName
          }

          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "‚úÖ EXE created: $([math]::Round($size, 2)) MB" -ForegroundColor Green

            # Check what got bundled
            Write-Host ""
            Write-Host "=== BUNDLED FILES ===" -ForegroundColor Cyan
            Get-ChildItem "dist/fortuna-monolith" -Recurse | Format-Table Name, Length
          } else {
            Write-Error "‚ùå EXE was NOT created at $exePath"

            Write-Host "Checking for error indicators in build log..."
            Select-String -Path "pyinstaller-build.log" -Pattern "ERROR|CRITICAL|Failed" -Context 2

            exit 1
          }

      # ========== QUICK TEST ==========
      - name: üß™ Quick Executable Test
        shell: pwsh
        run: |
          Write-Host "=== TESTING EXECUTABLE ===" -ForegroundColor Cyan

          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"

          # Just try to run it and see what happens
          Write-Host "Attempting to run executable..."
          $process = Start-Process -FilePath $exePath -PassThru -WindowStyle Hidden -RedirectStandardOutput "exe-stdout.log" -RedirectStandardError "exe-stderr.log"

          Start-Sleep -Seconds 10

          if ($process.HasExited) {
            Write-Host "‚ùå Process exited with code: $($process.ExitCode)"
            Write-Host "STDOUT:"
            Get-Content "exe-stdout.log"
            Write-Host "STDERR:"
            Get-Content "exe-stderr.log"
          } else {
            Write-Host "‚úÖ Process is running (PID: $($process.Id))"

            # Try to hit the health endpoint
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing -TimeoutSec 5
              Write-Host "‚úÖ Health endpoint responded: $($response.StatusCode)" -ForegroundColor Green
            } catch {
              Write-Host "‚ö†Ô∏è  Health endpoint not responding: $_" -ForegroundColor Yellow
            }

            Stop-Process -Id $process.Id -Force
          }

      # ========== UPLOAD ALL LOGS ==========
      - name: üì§ Upload All Diagnostic Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostic-logs-${{ github.run_number }}
          path: |
            pyinstaller-build.log
            web_service/frontend/npm-install.log
            web_service/frontend/npm-build.log
            exe-stdout.log
            exe-stderr.log
            build/**/*.log
            directory-listing.log
            pip-freeze.log
          if-no-files-found: ignore

      # ========== UPLOAD EXE IF IT EXISTS ==========
      - name: üì§ Upload Executable (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-monolith-diagnostic-${{ github.run_number }}
          path: dist/fortuna-monolith/fortuna-monolith.exe
          if-no-files-found: ignore
