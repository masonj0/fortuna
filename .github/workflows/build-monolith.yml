name: Fortuna Monolith Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-monolith:
    name: 'Build Fortuna Monolith EXE'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # ========== FRONTEND ==========
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build

          # CRITICAL: Verify frontend built successfully
          if (-not (Test-Path "out/index.html")) {
            Write-Error "‚ùå Frontend build failed: index.html not found in 'out' directory."
            exit 1
          }

          $fileCount = (Get-ChildItem -Path "out" -Recurse -File).Count
          Write-Host "‚úÖ Frontend built successfully ($fileCount files)"

      # ========== BACKEND ==========
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: Install Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install pyinstaller==6.6.0
          pip install -r web_service/backend/requirements.txt

      - name: Create Data Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "web_service/backend/data" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/json" | Out-Null
          New-Item -ItemType Directory -Force -Path "web_service/backend/logs" | Out-Null

      # ========== BUILD ==========
      - name: Build Monolith EXE
        shell: pwsh
        env:
          PYTHONIOENCODING: utf-8
        run: |
          Write-Host "üî® Building Fortuna Monolith..."

          # Verify frontend exists before building
          if (-not (Test-Path "web_platform/frontend/out")) {
            Write-Error "‚ùå Frontend 'out' directory not found!"
            exit 1
          }

          pyinstaller --noconfirm --clean fortuna-monolith.spec

          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"
          if (-not (Test-Path $exePath)) {
            Write-Error "‚ùå Build failed - EXE not created at $exePath"

            # Show PyInstaller output directory contents for debugging
            Write-Host "Contents of dist directory:"
            Get-ChildItem -Path "dist" -Recurse | Format-Table Name, FullName

            exit 1
          }

          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "‚úÖ Build complete: $([math]::Round($size, 2)) MB"

      # ========== UPLOAD ==========
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fortuna-Monolith-${{ github.run_number }}
          path: dist/fortuna-monolith/fortuna-monolith.exe
          retention-days: 30
          if-no-files-found: error  # CRITICAL: Fail if file doesn't exist

      # ========== SMOKE TEST ==========
      - name: Smoke Test Monolith
        shell: pwsh
        timeout-minutes: 5
        run: |
          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"
          $logFile = "monolith-smoke-test.log"

          Write-Host "üß™ Starting smoke test for $exePath..."
          $process = Start-Process -FilePath $exePath -PassThru -RedirectStandardOutput $logFile -RedirectStandardError $logFile -WindowStyle Hidden

          Write-Host "‚è≥ Waiting for process (PID: $($process.Id)) to initialize (max 30s)..."
          $success = $false

          foreach ($i in 1..15) {
            if ($process.HasExited) {
              Write-Host "‚ùå Process exited prematurely with code $($process.ExitCode)"
              Write-Host "Last 20 lines of log:"
              Get-Content $logFile -Tail 20
              break
            }

            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check passed on attempt $i"
                $success = $true
                break
              }
            } catch {
              Write-Host "‚è≥ Health check attempt $i failed, retrying in 2s..."
              Start-Sleep -Seconds 2
            }
          }

          # Additional check for the frontend root
          if ($success) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/" -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Frontend root page loaded successfully"
              } else {
                Write-Host "‚ùå Frontend root page check failed with status $($response.StatusCode)"
                $success = $false
              }
            } catch {
              Write-Host "‚ùå Frontend root page check failed: $($_.Exception.Message)"
              $success = $false
            }
          }

          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

          if (-not $success) {
            Write-Host "‚ùå SMOKE TEST FAILED"
            Write-Host "Full log contents:"
            Get-Content $logFile
            throw "Monolith smoke test failed"
          }

          Write-Host "‚úÖ SMOKE TEST PASSED"

      # ========== OPTIONAL VERIFICATION STEPS ==========
      - name: Run Verification Scripts
        shell: pwsh
        continue-on-error: true
        run: |
          pip install playwright
          playwright install --with-deps

          $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"
          $logFile = "verification.log"

          Write-Host "Starting monolith for verification tests..."
          $process = Start-Process -FilePath $exePath -PassThru -RedirectStandardOutput $logFile -RedirectStandardError $logFile -WindowStyle Hidden
          Start-Sleep -Seconds 15

          Write-Host "Running Playwright script..."
          python e2e/jules-smoke-test.py

          Write-Host "Running race info script..."
          python e2e/get-race-info.py

          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

      - name: Upload Playwright Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-screenshot-${{ github.run_number }}
          path: playwright-screenshot.png
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Race Info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: race-info-${{ github.run_number }}
          path: race-info.txt
          retention-days: 7
          if-no-files-found: ignore
