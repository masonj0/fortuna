# System Timestamp: 2024-05-21 12:00:00
name:  Build Electron MSI (Hybrid V12 Engine)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11' # üöÄ DOWNGRADE
  # Paths
  BACKEND_DIR: 'web_service/backend'
  FRONTEND_DIR: 'web_platform/frontend'
  ELECTRON_DIR: 'electron'
  FORTUNA_PORT: '8102'
  # Mock API keys for service startup
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  quality-gate:
    name: 'Run Tests'
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          pip install -r web_service/backend/requirements-dev.txt
          pytest web_service/backend/tests
  # ============================================================================
  # JOB 1: BUILD CORE (The "HatTrick" Engine)
  # ============================================================================
  build-core:
    name: '‚öôÔ∏è Build Core Components (${{ matrix.arch }})'
    runs-on: windows-latest
    timeout-minutes: 30
    needs: quality-gate
    strategy:
      matrix:
        arch: [x64, x86]
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      build_id: ${{ steps.meta.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4
      - name: üîñ Metadata
        id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_id=${{ github.run_id }}" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
      # --- FRONTEND (Standard) ---
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
      - name: Cache Build Output
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_DIR }}/out
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package-lock.json', '${{ env.FRONTEND_DIR }}/**/*.js', '${{ env.FRONTEND_DIR }}/**/*.ts', '${{ env.FRONTEND_DIR }}/**/*.tsx', '${{ env.FRONTEND_DIR }}/**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-frontend-
      - name: üé® Build Frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline
          npm run build
      - name: üìã Generate Artifact Manifest
        shell: pwsh
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "out"
          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8
          $files = Get-ChildItem -Path $outDir -Recurse -File
          foreach ($f in $files) {
            $rel = $f.FullName.Substring($outDir.Path.Length) -replace '^[\\\/]', ''
            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)
            "$rel`t$($f.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }
          Write-Host "‚úÖ Generated frontend artifact manifest."
      # --- BACKEND (The "HatTrick" Upgrade) ---
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'
      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $constraintDir = "temp-constraints"
          New-Item -ItemType Directory -Path $constraintDir -Force | Out-Null
          $constraintFile = Join-Path $constraintDir "constraint-${{ matrix.arch }}.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            "numpy==1.23.5" | Set-Content $constraintFile
          } else { New-Item $constraintFile -ItemType File -Force }
          "file=$constraintFile" | Out-File $env:GITHUB_OUTPUT -Append
      - name: üêç Install Python Dependencies
        run: |
          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller==6.6.0
      - name: üì¶ Build Python Backend
        shell: pwsh
        env:
          BACKEND_DIR: ${{ env.BACKEND_DIR }}
          PYTHONUTF8: '1'
        run: python scripts/generate_spec_electron.py
      - name: Compress Backend Artifact
        shell: pwsh
        run: |
          Compress-Archive -Path dist/service/fortuna-backend/* -DestinationPath dist/service/fortuna-backend.tar.gz
      - name: üì§ Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/service/fortuna-backend.tar.gz
          retention-days: 1

      - name: üì§ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: |
            ${{ env.FRONTEND_DIR }}/out/
            ${{ env.FRONTEND_DIR }}/frontend-manifest.tsv
          retention-days: 1

  # ============================================================================
  # JOB 2: PACKAGE ELECTRON (The "Ironclad" Chassis)
  # ============================================================================
  package-electron:
    name: '‚ö° Package Electron MSI (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: build-core
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.ELECTRON_DIR }}/package-lock.json'
      - name: CACHE - Cache Electron and electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-
      - name: üì• Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: python-service-${{ matrix.arch }}-${{ needs.build-core.outputs.build_id }}
          path: python-service-bin
      - name: Decompress Backend Artifact
        shell: pwsh
        run: |
          Expand-Archive -Path python-service-bin/fortuna-backend.tar.gz -DestinationPath python-service-bin
      - name: üì• Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.build-core.outputs.build_id }}
          path: ${{ env.FRONTEND_DIR }}/out
      - name: üöö Stage Backend for Electron Builder
        shell: pwsh
        run: |
          $sourceDir = "python-service-bin"
          $targetDir = "${{ env.ELECTRON_DIR }}/resources"
          if (-not (Test-Path "$sourceDir/fortuna-backend.exe")) {
            Write-Host "Contents of $sourceDir:"
            Get-ChildItem -Path $sourceDir -Recurse
            throw "‚ùå Backend executable not found in '$sourceDir' after download."
          }
          New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
          Write-Host "Copying backend from '$sourceDir' to '$targetDir'..."
          Copy-Item -Path "$sourceDir/*" -Destination $targetDir -Recurse -Force
          if (-not (Test-Path "$targetDir/fortuna-backend.exe")) {
            Write-Host "Contents of $targetDir:"
            Get-ChildItem -Path $targetDir -Recurse
            throw "‚ùå Backend executable failed to copy to '$targetDir'."
          }
          Write-Host "‚úÖ Backend executable successfully staged in '$targetDir'."
      - name: '‚öñÔ∏è The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $target = "." # Analyze entire workspace staged for build
          $limitMB = 300
          Write-Host "--- üìä Size Breakdown ---"
          $files = Get-ChildItem -Path $target -Recurse -File -ErrorAction SilentlyContinue
          if (!$files) { Write-Warning "No files found to weigh."; exit 0 }
          $totalBytes = ($files | Measure-Object -Property Length -Sum).Sum
          $totalMB = [math]::Round($totalBytes / 1MB, 2)
          Write-Host "Total Payload Size: $totalMB MB"
          if ($totalMB -gt $limitMB) {
              Write-Warning "‚ö†Ô∏è BLOAT ALERT: Build exceeds $limitMB MB limit! Check the heaviest files below."
          } else {
              Write-Host "‚úÖ Size within limits (< $limitMB MB)." -ForegroundColor Green
          }
          Write-Host "`n--- üêò Top 10 Heaviest Files ---"
          $files | Sort-Object Length -Descending | Select-Object -First 10 @{N='File';E={$_.FullName.Replace($pwd,'')}}, @{N='Size(MB)';E={"{0:N2}" -f ($_.Length/1MB)}} | Format-Table -AutoSize
      - name: 'üßê Forensically Guarantee Icon Paths'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          Install-Module -Name powershell-yaml -Force -Scope CurrentUser -ErrorAction Stop
          Import-Module powershell-yaml
          $configPath = '${{ env.ELECTRON_DIR }}/electron-builder-config.yml'
          $iconPath = "${{ env.ELECTRON_DIR }}/assets/icon.ico"
          if (-not (Test-Path -LiteralPath $iconPath)) {
            Write-Error "CRITICAL: The primary icon file is missing at '$iconPath'."
            exit 1
          }
          $absoluteIconPath = (Resolve-Path -LiteralPath $iconPath).Path
          $config = Get-Content $configPath | ConvertFrom-Yaml
          $config.win.icon = $absoluteIconPath.Replace('\\', '/')
          try { $config.msi.PSObject.Properties.Remove('installerIcon') } catch {}
          try { $config.msi.PSObject.Properties.Remove('uninstallerIcon') } catch {}
          $tempConfigPath = '${{ env.ELECTRON_DIR }}/temp-builder-config.yml'
          $config | ConvertTo-Yaml | Set-Content -Path $tempConfigPath
          Write-Host "‚úÖ Successfully created temporary config '$tempConfigPath' with corrected icon paths."
      - name: üìÑ Ensure WiX License Exists for electron-builder
        shell: pwsh
        run: |
          # electron-builder uses build_wix/license.rtf by convention
          $wixDir = 'build_wix'
          if (-not (Test-Path $wixDir)) { New-Item -ItemType Directory -Path $wixDir | Out-Null }
          $licensePath = Join-Path $wixDir 'license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder for electron-builder...'
            $rtfContent = '{\rtf1\ansi\deff0{\fonttbl{\f0 Arial;}}\f0\fs24 END USER LICENSE AGREEMENT\par\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: üèóÔ∏è Build MSI
        working-directory: ${{ env.ELECTRON_DIR }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          npm ci --prefer-offline
          $ver = "${{ needs.build-core.outputs.semver }}"
          $arch_flag = if ('${{ matrix.arch }}' -eq 'x86') { '--ia32' } else { '--x64' }
          npm run dist -- --win msi $arch_flag --config temp-builder-config.yml --publish never --config.artifactName="Fortuna-Electron-${ver}-${{ matrix.arch }}.msi"
      - name: 'üïµÔ∏è Post-Build Forensic Analysis'
        shell: pwsh
        run: |
          $unpackedDir = "electron/dist/" + (if ('${{ matrix.arch }}' -eq 'x86') { 'win-ia32-unpacked' } else { 'win-unpacked' })
          $backendExePath = Join-Path $unpackedDir "resources/fortuna-backend.exe"
          if (-not (Test-Path $backendExePath)) {
            Write-Host "Contents of '$unpackedDir/resources':"
            Get-ChildItem -Path (Join-Path $unpackedDir "resources") -Recurse
            throw "‚ùå Post-build verification failed: fortuna-backend.exe not found in the unpacked application."
          }
          Write-Host "‚úÖ Post-build verification passed: fortuna-backend.exe found."
      - name: Rename & Hash MSI
        id: name_msi
        shell: pwsh
        run: |
          $ver = "${{ needs.build-core.outputs.semver }}"
          $sha = "${{ needs.build-core.outputs.short_sha }}"
          $releaseDir = "${{ env.ELECTRON_DIR }}/dist"
          $msiFound = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select-Object -First 1
          if (-not $msiFound) {
            Write-Error "‚ùå FATAL: No MSI file found in $releaseDir."
            exit 1
          }
          $targetName = "Fortuna-Electron-Hybrid-${{ matrix.arch }}-${ver}-${sha}.msi"
          $newPath = Join-Path $releaseDir $targetName
          Move-Item -Path $msiFound.FullName -Destination $newPath -Force
          "msi_name=$targetName" | Out-File $env:GITHUB_OUTPUT -Append
      - name: üì§ Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: electron-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: ${{ env.ELECTRON_DIR }}/dist/*.msi
          retention-days: 1

  # ============================================================================
  # JOB 3: SMOKE TEST (The "Robust" Verification)
  # ============================================================================
  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: package-electron
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: üì• Download MSI
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: installer
      - name: ü§´ Install MSI & Verify
        shell: pwsh
        run: |
          $msi = Get-ChildItem "installer" -Filter "*.msi" -Recurse | Select -First 1
          if (!$msi) { throw "No MSI found" }
          $proc = Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait -PassThru
          if ($proc.ExitCode -ne 0 -and $proc.ExitCode -ne 3010) {
            Get-Content install.log -Tail 50
            throw "Install failed with code $($proc.ExitCode)"
          }
      - name: '‚úÖ Create Required Runtime Directories Post-Install'
        shell: pwsh
        run: |
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installRoot = Join-Path $progFiles "Fortuna Faucet"
          if (! (Test-Path $installRoot)) {
            Write-Error "Installation directory not found at $installRoot."
            exit 1
          }
          New-Item -Path "$installRoot\data" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installRoot\json" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installRoot\logs" -ItemType Directory -Force | Out-Null
      - name: 'üî¨ Complete Smoke Test (3-Layer Defense)'
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = "Stop"
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installRoot = Join-Path $progFiles "Fortuna Faucet"
          # --- LAYER 1: FILE VERIFICATION ---
          $mainExe = Get-ChildItem -Path $installRoot -Filter "*.exe" -Recurse | Where-Object { $_.Name -notmatch 'uninstall' } | Select -First 1
          $backendExe = Get-ChildItem -Path $installRoot -Filter "fortuna-backend.exe" -Recurse | Select -First 1
          if (-not $mainExe) { Write-Error "‚ùå LAYER 1 FAILED: Main 'Fortuna Faucet.exe' not found."; exit 1 }
          if (-not $backendExe) { Write-Error "‚ùå LAYER 1 FAILED: Backend 'fortuna-backend.exe' not found."; exit 1 }
          # --- LAYER 2: PROCESS VERIFICATION ---
          $proc = Start-Process -FilePath $mainExe.FullName -ArgumentList "--no-sandbox" -PassThru
          Start-Sleep -Seconds 10
          $parentProcess = Get-Process -Name "Fortuna Faucet" -ErrorAction SilentlyContinue
          $childProcess = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue
          if (-not $parentProcess) { Write-Error "‚ùå LAYER 2 FAILED: Main 'Fortuna Faucet' process is not running."; exit 1 }
          if (-not $childProcess) { Write-Error "‚ùå LAYER 2 FAILED: Child 'fortuna-backend' process is not running."; exit 1 }
          # --- LAYER 3: NETWORK VERIFICATION ---
          $maxAttempts = 10
          $healthUrl = "http://localhost:${{ env.FORTUNA_PORT }}/health"
          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $healthUrl -Method Get -UseBasicParsing -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ‚úÖ‚úÖ SMOKE TEST PASSED ‚úÖ‚úÖ‚úÖ"
                Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue
                exit 0
              }
            } catch { Start-Sleep -Seconds 5 }
          }
          Write-Error "‚ùå LAYER 3 FAILED: Service Failed Health Check"
          exit 1
      - name: Cleanup
        if: always()
        run: Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue

  # ============================================================================
  # JOB 4: RELEASE (The "Triple-Tap" Staging)
  # ============================================================================
  release:
    name: 'üì¶ Release'
    runs-on: windows-latest
    needs: smoke-test
    timeout-minutes: 30
    steps:
      - name: üì• Download MSI (x64)
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-x64-${{ github.run_id }}
          path: staging/x64
      - name: üì• Download MSI (x86)
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-x86-${{ github.run_id }}
          path: staging/x86
      - name: üöö Robocopy Safe-Stage
        shell: pwsh
        run: |
          $dest = "final-artifact"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          robocopy staging $dest /E /np
          if ($LASTEXITCODE -le 3) {
            Write-Host "‚úÖ Staged successfully."
            exit 0
          } else {
            throw "Robocopy failed with code $LASTEXITCODE"
          }
      - name: üì§ Upload Final
        uses: actions/upload-artifact@v4
        with:
          name: Final-Electron-MSI
          path: final-artifact/
