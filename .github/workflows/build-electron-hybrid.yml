name: üèéÔ∏è Build Electron MSI (Hybrid V12 Engine)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  # Paths
  BACKEND_DIR: 'python_service'
  FRONTEND_DIR: 'web_platform/frontend'
  ELECTRON_DIR: 'electron'

jobs:
  # ==================================================================================
  # JOB 1: BUILD CORE (The "HatTrick" Engine)
  # ==================================================================================
  build-core:
    name: '‚öôÔ∏è Build Core Components'
    runs-on: windows-latest
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      build_id: ${{ steps.meta.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4

      - name: üè∑Ô∏è Metadata
        id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_id=${{ github.run_id }}" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # --- FRONTEND (Standard) ---
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: üé® Build Frontend
        shell: pwsh
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline
          npm run build

      # --- BACKEND (The "HatTrick" Upgrade) ---
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üêç Install Python Dependencies
        run: |
          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt
          pip install pyinstaller==6.6.0

      - name: üì¶ Build Python Backend
        shell: pwsh
        env:
          BACKEND_DIR: ${{ env.BACKEND_DIR }}
          PYTHONUTF8: '1'
        run: python scripts/generate_spec_electron.py

      - name: üì§ Upload Core Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-build-${{ github.run_id }}
          path: |
            dist/service/fortuna-backend/
            ${{ env.FRONTEND_DIR }}/out/
          retention-days: 1

  # ==================================================================================
  # JOB 2: PACKAGE ELECTRON (The "Ironclad" Chassis)
  # ==================================================================================
  package-electron:
    name: '‚ö° Package Electron MSI'
    runs-on: windows-latest
    needs: build-core
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.ELECTRON_DIR }}/package-lock.json'

      - name: üì• Download Core Artifacts
        uses: actions/download-artifact@v4
        with:
          name: core-build-${{ github.run_id }}
          path: downloaded_core

      - name: üöö Stage Artifacts for Electron
        shell: pwsh
        run: |
          # Move Python Backend to where electron-builder expects it
          # (Adjust this path based on your electron-builder-config.yml)
          $backendDest = "${{ env.ELECTRON_DIR }}/python_service-bin"
          New-Item -ItemType Directory -Path $backendDest -Force | Out-Null
          Copy-Item -Path "downloaded_core/fortuna-backend/*" -Destination $backendDest -Recurse -Force

          # Move Frontend to where Electron expects it
          $frontendDest = "${{ env.FRONTEND_DIR }}/out"
          New-Item -ItemType Directory -Path $frontendDest -Force | Out-Null
          Copy-Item -Path "downloaded_core/out/*" -Destination $frontendDest -Recurse -Force

      - name: üìÑ Ensure WiX License Exists for electron-builder
        shell: pwsh
        run: |
          # electron-builder uses build_wix/license.rtf by convention
          $wixDir = 'build_wix'
          if (-not (Test-Path $wixDir)) { New-Item -ItemType Directory -Path $wixDir | Out-Null }
          $licensePath = Join-Path $wixDir 'license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder for electron-builder...'
            $rtfContent = '{\rtf1\ansi\deff0{\fonttbl{\f0 Arial;}}\f0\fs24 END USER LICENSE AGREEMENT\par\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: üèóÔ∏è Build MSI
        working-directory: ${{ env.ELECTRON_DIR }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          npm ci --prefer-offline
          $ver = "${{ needs.build-core.outputs.semver }}"
          npm run dist -- --win msi --config electron-builder-config.yml --publish never --config.artifactName="Fortuna-Electron-${ver}.msi"

      - name: üì§ Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: ${{ env.ELECTRON_DIR }}/dist/*.msi
          retention-days: 1

  # ==================================================================================
  # JOB 3: SMOKE TEST (The "Robust" Verification)
  # ==================================================================================
  smoke-test:
    name: 'üî¨ Smoke Test'
    runs-on: windows-latest
    needs: package-electron
    steps:
      - name: üì• Download MSI
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: installer

      - name: ü§´ Install & Verify
        shell: pwsh
        run: |
          $msi = Get-ChildItem "installer" -Filter "*.msi" -Recurse | Select -First 1
          if (!$msi) { throw "No MSI found" }

          Write-Host "Installing $($msi.Name)..."
          # EXOTIC INGREDIENT: PassThru for accurate exit codes
          $proc = Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait -PassThru

          if ($proc.ExitCode -ne 0) {
            Get-Content install.log -Tail 50
            throw "Install failed with code $($proc.ExitCode)"
          }

      - name: üöÄ Launch & Wait (Dual Process)
        shell: pwsh
        run: |
          # EXOTIC INGREDIENT: Dynamic Path Finding
          $root = "C:\Program Files\Fortuna Faucet"
          $exe = Get-ChildItem $root -Filter "*.exe" -Recurse | Where { $_.Name -notmatch 'uninstall' } | Select -First 1
          if (!$exe) { throw "Executable not found in $root" }

          Start-Process $exe.FullName

          Write-Host "Waiting for Electron + Python..."
          for ($i=0; $i -lt 30; $i++) {
            $e = Get-Process "Fortuna Faucet" -ErrorAction SilentlyContinue
            $b = Get-Process "fortuna-backend" -ErrorAction SilentlyContinue

            if ($e -and $b) {
              Write-Host "‚úÖ SUCCESS: App (PID $($e.Id)) and Backend (PID $($b.Id)) are running."
              exit 0
            }
            Start-Sleep 2
          }
          throw "Timeout waiting for processes."

      - name: üßπ Cleanup
        if: always()
        run: Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue

  # ==================================================================================
  # JOB 4: RELEASE (The "Triple-Tap" Staging)
  # ==================================================================================
  release:
    name: 'üì¶ Release'
    runs-on: windows-latest
    needs: smoke-test
    steps:
      - name: üì• Download MSI
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: staging

      - name: üöö Robocopy Safe-Stage
        shell: pwsh
        run: |
          $dest = "final-artifact"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          # EXOTIC INGREDIENT: The Robocopy Logic that finally worked
          robocopy staging $dest /E /np

          # 0-3 = Success. 4+ = Error.
          if ($LASTEXITCODE -le 3) {
            Write-Host "‚úÖ Staged successfully."
            exit 0
          } else {
            throw "Robocopy failed with code $LASTEXITCODE"
          }

      - name: üì§ Upload Final
        uses: actions/upload-artifact@v4
        with:
          name: Final-Electron-MSI
          path: final-artifact/
