name:  Build Electron MSI (Hybrid V12 Engine)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  # Paths
  BACKEND_DIR: 'python_service'
  FRONTEND_DIR: 'web_platform/frontend'
  ELECTRON_DIR: 'electron'
  FORTUNA_PORT: '8102'
  # Mock API keys for service startup
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  quality-gate:
    name: 'Run Tests'
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: |
          pip install -r python_service/requirements-dev.txt
          pytest python_service/tests
  # ==================================================================================
  # JOB 1: BUILD CORE (The "HatTrick" Engine)
  # ==================================================================================
  build-core:
    name: 'âš™ï¸ Build Core Components'
    runs-on: windows-latest
    timeout-minutes: 30
    needs: quality-gate
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      build_id: ${{ steps.meta.outputs.build_id }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”– Metadata
        id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "build_id=${{ github.run_id }}" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

      # --- FRONTEND (Standard) ---
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: ðŸŽ¨ Build Frontend
        shell: pwsh
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline
          npm run build

      # --- BACKEND (The "HatTrick" Upgrade) ---
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ Install Python Dependencies
        run: |
          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt
          pip install pyinstaller==6.6.0

      - name: ðŸ“¦ Build Python Backend
        shell: pwsh
        env:
          BACKEND_DIR: ${{ env.BACKEND_DIR }}
          PYTHONUTF8: '1'
        run: python scripts/generate_spec_electron.py

      - name: ðŸ“¤ Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-service-${{ github.run_id }}
          path: dist/service/fortuna-backend/
          retention-days: 1

      - name: ðŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_DIR }}/out/
          retention-days: 1

  # ==================================================================================
  # JOB 2: PACKAGE ELECTRON (The "Ironclad" Chassis)
  # ==================================================================================
  package-electron:
    name: 'âš¡ Package Electron MSI'
    runs-on: windows-latest
    needs: build-core
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.ELECTRON_DIR }}/package-lock.json'

      - name: CACHE - Cache Electron and electron-builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-

      - name: ðŸ“¥ Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: python-service-${{ github.run_id }}
          path: python-service-bin

      - name: ðŸ“¥ Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: ${{ env.FRONTEND_DIR }}/out

      - name: ðŸšš Stage Artifacts for Electron
        shell: pwsh
        run: |
          # No staging needed, artifacts are downloaded to the correct locations
          Write-Host "Backend and Frontend artifacts downloaded to their respective directories."


      - name: ðŸ“„ Ensure WiX License Exists for electron-builder
        shell: pwsh
        run: |
          # electron-builder uses build_wix/license.rtf by convention
          $wixDir = 'build_wix'
          if (-not (Test-Path $wixDir)) { New-Item -ItemType Directory -Path $wixDir | Out-Null }
          $licensePath = Join-Path $wixDir 'license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host 'âš ï¸ License file missing. Generating placeholder for electron-builder...'
            $rtfContent = '{\rtf1\ansi\deff0{\fonttbl{\f0 Arial;}}\f0\fs24 END USER LICENSE AGREEMENT\par\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host 'âœ… Placeholder license.rtf created.'
          } else {
            Write-Host 'âœ… Existing license.rtf found.'
          }
      - name: ðŸ—ï¸ Build MSI
        working-directory: ${{ env.ELECTRON_DIR }}
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: |
          npm ci --prefer-offline
          $ver = "${{ needs.build-core.outputs.semver }}"
          npm run dist -- --win msi --config electron-builder-config.yml --publish never --config.artifactName="Fortuna-Electron-${ver}.msi"

      - name: ðŸ”¬ Forensic Packaging Analysis
        shell: pwsh
        run: |
          Write-Host "=== HYBRID STAGING LAYOUT ==="
          Get-ChildItem -Path "${{ env.ELECTRON_DIR }}/dist/win-unpacked" -Recurse | Select-Object FullName, Length

      - name: 'ðŸ¤ The Canary (Malware Pre-Flight)'
        shell: pwsh
        continue-on-error: true
        run: |
          $msi = Get-ChildItem -Recurse -Filter "*.msi" | Select-Object -First 1
          if (!$msi) { Write-Warning "No MSI found to scan."; exit 0 }

          Write-Host "ðŸ” Scanning $($msi.Name) with Windows Defender..."
          $defender = "C:\Program Files\Windows Defender\MpCmdRun.exe"

          if (-not (Test-Path $defender)) {
              Write-Warning "Windows Defender CLI not found at expected path."
              exit 0
          }

          # ScanType 3 = File/Custom Scan
          $proc = Start-Process -FilePath $defender -ArgumentList "-Scan -ScanType 3 -File `"$($msi.FullName)`"" -Wait -PassThru -NoNewWindow

          if ($proc.ExitCode -eq 0) {
              Write-Host "âœ… CLEAN: Windows Defender found no threats." -ForegroundColor Green
          } elseif ($proc.ExitCode -eq 2) {
              Write-Error "ðŸš¨ THREAT DETECTED: Windows Defender flagged this installer!"
              exit 1
          } else {
              Write-Warning "âš ï¸ Scan completed with inconclusive exit code: $($proc.ExitCode)"
          }

      - name: ðŸ“¤ Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: ${{ env.ELECTRON_DIR }}/dist/*.msi
          retention-days: 1

  # ==================================================================================
  # JOB 3: SMOKE TEST (The "Robust" Verification)
  # ==================================================================================
  smoke-test:
    name: 'ðŸ”¬ Smoke Test'
    runs-on: windows-latest
    needs: package-electron
    timeout-minutes: 30
    steps:
      - name: ðŸ“¥ Download MSI
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: installer

      - name: Configure Firewall
        shell: pwsh
        run: |
          New-NetFirewallRule -DisplayName "FortunaTest" -Direction Inbound -LocalPort 8102 -Protocol TCP -Action Allow

      - name: ðŸ¤« Install & Verify
        shell: pwsh
        run: |
          $msi = Get-ChildItem "installer" -Filter "*.msi" -Recurse | Select -First 1
          if (!$msi) { throw "No MSI found" }

          Write-Host "Installing $($msi.Name)..."
          # EXOTIC INGREDIENT: PassThru for accurate exit codes
          $proc = Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait -PassThru

          if ($proc.ExitCode -ne 0) {
            Get-Content install.log -Tail 50
            throw "Install failed with code $($proc.ExitCode)"
          }

      - name: 'âœ… Create Required Runtime Directories Post-Install'
        shell: pwsh
        run: |
          $installRoot = "C:\Program Files\Fortuna Faucet"
          if (-not (Test-Path $installRoot)) {
            Write-Error "Installation directory not found at $installRoot. Cannot create runtime directories."
            exit 1
          }
          New-Item -Path "$installRoot\data" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installRoot\json" -ItemType Directory -Force | Out-Null
          New-Item -Path "$installRoot\logs" -ItemType Directory -Force | Out-Null
          Write-Host "âœ… Created data, json, and logs directories in $installRoot"

      - name: ðŸ” Debug Backend Launch (Direct Execution)
        shell: pwsh
        run: |
          $paths = @(
            "C:\Program Files\Fortuna Faucet\resources\resources\python-service-bin\fortuna-backend.exe",
            "C:\Program Files\Fortuna Faucet\resources\python-service-bin\fortuna-backend.exe"
          )
          $exe = $paths | Where-Object { Test-Path $_ } | Select-Object -First 1

          if ($exe) {
            Write-Host "Found backend at: $exe"
            Write-Host "Running diagnostic..."
            & $exe --help 2>&1 | Tee-Object -FilePath "backend_debug.log"
            Get-Content "backend_debug.log"
          } else {
            Write-Warning "Backend binary not found. Dumping file structure:"
            Get-ChildItem "C:\Program Files\Fortuna Faucet" -Recurse | Select-Object FullName
          }

      - name: ðŸš€ Launch & Wait (Port Detection)
        shell: pwsh
        run: |
          $root = 'C:\Program Files\Fortuna Faucet'
          $exe = Get-ChildItem $root -Filter "*.exe" -Recurse | Where { $_.Name -notmatch 'uninstall' } | Select -First 1
          if (!$exe) { throw "Executable not found in $root" }

          Write-Host "Target: $($exe.FullName)"

          # Create Log Directory
          $logDir = "C:\Temp\fortuna-logs"
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null

          # Launch Electron with Log Redirection
          # We use Start-Process to detach, but redirect streams
          $proc = Start-Process -FilePath $exe.FullName -ArgumentList "--no-sandbox" -NoNewWindow -PassThru -RedirectStandardOutput "$logDir\stdout.log" -RedirectStandardError "$logDir\stderr.log"

          Write-Host "Electron launched (PID: $($proc.Id)). Waiting for Port 8102..."

          # Wait for Port 8102 (The Backend)
          $deadline = (Get-Date).AddSeconds(60)
          $connected = $false

          while ((Get-Date) -lt $deadline) {
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $tcp.Connect('127.0.0.1', 8102)
              $tcp.Close()
              Write-Host "âœ… SUCCESS: Backend is listening on port 8102!" -ForegroundColor Green
              $connected = $true
              break
            } catch {
              Write-Host "  ...waiting for port..."
              Start-Sleep 2
            }
          }

          if (-not $connected) {
            Write-Error "âŒ TIMEOUT: Backend did not bind port 8102."

            Write-Host "--- ELECTRON STDOUT ---"
            if (Test-Path "$logDir\stdout.log") { Get-Content "$logDir\stdout.log" -Tail 50 }

            Write-Host "--- ELECTRON STDERR ---"
            if (Test-Path "$logDir\stderr.log") { Get-Content "$logDir\stderr.log" -Tail 50 }

            exit 1
          }

      - name: "ðŸ’€ CSI: Windows (Post-Mortem Diagnostics)"
        if: failure()
        shell: pwsh
        run: |
          Write-Host "=== BACKEND LOGS (If Available) ==="
          if (Test-Path "C:\ProgramData\Fortuna\logs\backend.log") { Get-Content "C:\ProgramData\Fortuna\logs\backend.log" -Tail 100 }
          Write-Host "=== PORT 8102 LISTENER ==="
          netstat -an | findstr "8102"
          Write-Host "=== RUNNING PROCESSES ==="
          tasklist /FI "IMAGENAME eq fortuna*"

      - name: 'ðŸ“¸ The Paparazzi (Visual Proof)'
        shell: pwsh
        run: |
          Write-Host "Installing Playwright..."
          npm install playwright
          npx playwright install chromium --with-deps

          $port = "${{ env.FORTUNA_PORT }}"
          $url = "http://127.0.0.1:$port/docs"

          node -e "
            const { chromium } = require('playwright');
            (async () => {
              try {
                const browser = await chromium.launch();
                const page = await browser.newPage();
                await page.goto('$url', { timeout: 15000 });
                await page.waitForSelector('.swagger-ui', { timeout: 5000 }).catch(() => console.log('UI not fully loaded, snapping anyway...'));
                await page.screenshot({ path: 'proof-of-life.png', fullPage: true });
                await browser.close();
              } catch (e) {
                console.error(e); process.exit(1);
              }
            })();
          "

      - name: ðŸ“¤ Upload Visual Proof
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-proof-${{ github.run_id }}
          path: proof-of-life.png
          retention-days: 7

      - name: ðŸ§¹ Cleanup
        if: always()
        run: Stop-Process -Name "Fortuna Faucet", "fortuna-backend" -Force -ErrorAction SilentlyContinue

  # ==================================================================================
  # JOB 4: RELEASE (The "Triple-Tap" Staging)
  # ==================================================================================
  release:
    name: 'ðŸ“¦ Release'
    runs-on: windows-latest
    needs: smoke-test
    timeout-minutes: 30
    steps:
      - name: ðŸ“¥ Download MSI
        uses: actions/download-artifact@v4
        with:
          name: electron-msi-${{ github.run_id }}
          path: staging

      - name: ðŸšš Robocopy Safe-Stage
        shell: pwsh
        run: |
          $dest = "final-artifact"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          # EXOTIC INGREDIENT: The Robocopy Logic that finally worked
          robocopy staging $dest /E /np

          # 0-3 = Success. 4+ = Error.
          if ($LASTEXITCODE -le 3) {
            Write-Host "âœ… Staged successfully."
            exit 0
          } else {
            throw "Robocopy failed with code $LASTEXITCODE"
          }

      - name: ðŸ“¤ Upload Final
        uses: actions/upload-artifact@v4
        with:
          name: Final-Electron-MSI
          path: final-artifact/
