name: ğŸ§ª Build Monolith (Experimental)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-monolith:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ¨ Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed" }
          Write-Host "âœ… Frontend built successfully"

      - name: ğŸ“¦ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          # Install the magic ingredients
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32 playwright
          # Install Playwright browsers
          playwright install chromium
          Write-Host "âœ… Dependencies installed"

      - name: ğŸ—ï¸ Build Single EXE
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean fortuna-monolith.spec
          if (-not (Test-Path dist/FortunaMonolith.exe)) {
            throw "PyInstaller build failed"
          }
          Write-Host "âœ… Monolith EXE built successfully"

      - name: ğŸ”¬ Smoke Test Monolith and Capture Screenshot
        shell: pwsh
        timeout-minutes: 5
        run: |
          Write-Host "ğŸš€ Launching Monolith for smoke test..."
          $process = Start-Process -FilePath "dist/FortunaMonolith.exe" -PassThru -NoNewWindow

          # Wait for the main window to appear by polling the process list
          $maxRetries = 10
          $found = $false
          for ($i = 1; $i -le $maxRetries; $i++) {
            Write-Host "Attempt ${i}: Checking for 'Fortuna Faucet' window..."
            $mainWindow = Get-Process | Where-Object { $_.MainWindowTitle -eq "Fortuna Faucet" }
            if ($null -ne $mainWindow) {
              Write-Host "âœ… Main window found!"
              $found = $true
              break
            }
            Start-Sleep -Seconds 2
          }
          if (-not $found) {
            throw "âŒ Timed out waiting for the Monolith main window to appear."
          }

          # Now that the window is up, take a screenshot
          $screenshotPath = "monolith-screenshot.png"
          $nodeScript = "const { chromium } = require('playwright');(async () => { const browser = await chromium.launch(); const page = await browser.newPage(); await page.goto('http://127.0.0.1:8000', { waitUntil: 'networkidle' }); await page.screenshot({ path: '$screenshotPath', fullPage: true }); await browser.close(); })();"
          node -e $nodeScript

          if (-not (Test-Path $screenshotPath)) {
            throw "âŒ Screenshot was not created!"
          }
          Write-Host "âœ… Screenshot captured successfully."

          # Clean up
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Monolith test complete."

      - name: ğŸ“¤ Upload Monolith EXE
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: dist/FortunaMonolith.exe
          retention-days: 30

      - name: ğŸ“¤ Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monolith-paparazzi-${{ matrix.arch || 'x64' }}
          path: monolith-screenshot.png
          retention-days: 7

      - name: ğŸ§¹ Cleanup
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "FortunaMonolith" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Cleanup complete"

  package-msi:
    name: 'ğŸ’¿ Package Monolith MSI'
    runs-on: windows-latest
    needs: build-monolith
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“¥ Download Monolith EXE
        uses: actions/download-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: staging

      - name: ğŸ”§ Setup WiX Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - run: dotnet tool install --global wix --version 4.0.5
      - run: echo C:\Users\runneradmin\.dotnet\tools >> $GITHUB_PATH
        shell: bash

      - name: ğŸ“„ Create License File
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          Set-Content -Path "build_wix/license.rtf" -Value '{\rtf1\ansi Placeholder License}' -Encoding Ascii

      - name: ğŸ—ï¸ Build MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          $ver = "0.0.${{ github.run_number }}"
          wix build Product_Monolith.wxs -o "FortunaMonolith-${ver}.msi" -d Version=$ver -d SourceDir="../staging"
          Write-Host "âœ… MSI built successfully"

      - name: ğŸ“¤ Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-MSI
          path: build_wix/FortunaMonolith-*.msi
