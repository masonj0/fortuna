name: üß™ Build Monolith (Experimental)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-monolith:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üé® Build Frontend
        shell: pwsh
        env:
          NEXT_PUBLIC_API_URL: http://127.0.0.1:8000
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed" }
          Write-Host "‚úÖ Frontend built successfully"

      - name: üì¶ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          # Install the magic ingredients
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32 playwright
          # Install Playwright browsers
          playwright install chromium
          Write-Host "‚úÖ Dependencies installed"

      - name: üèóÔ∏è Build Single EXE
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean fortuna-monolith.spec
          if (-not (Test-Path dist/FortunaMonolith.exe)) {
            throw "PyInstaller build failed"
          }
          Write-Host "‚úÖ Monolith EXE built successfully"

      - name: üì§ Upload Monolith EXE
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: dist/FortunaMonolith.exe
          retention-days: 30

  smoke-test:
    needs: build-monolith
    runs-on: windows-latest
    steps:
      - name: ‚¨áÔ∏è Download Monolith EXE
        uses: actions/download-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: ./dist

      - name: üêç Setup Python for Test
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install Verification Dependencies
        shell: pwsh
        run: |
          pip install requests

      - name: üöÄ Launch & Verify Monolith
        shell: pwsh
        run: |
          $env:FORTUNA_DEBUG = '1'
          Start-Process -FilePath "./dist/FortunaMonolith.exe" -WindowStyle Hidden -RedirectStandardOutput "monolith-stdout.log" -RedirectStandardError "monolith-stderr.log"

          $scriptLines = @(
              'import requests',
              'import time',
              'import sys',
              'url = "http://127.0.0.1:8000/api/health"',
              'print(f"Polling {url}...")',
              'for i in range(20):',
              '    try:',
              '        response = requests.get(url, timeout=2)',
              '        print(f"Attempt {i+1}/20: Status Code: {response.status_code}")',
              '        if response.status_code == 200:',
              '            try:',
              '                data = response.json()',
              '                print(f"Response JSON: {data}")',
              '            except Exception as json_e:',
              '                print(f"Failed to parse JSON: {json_e}")',
              '                print(f"Response Text: {response.text}")',
              '                data = {}',
              '            if data.get("status") == "ok":',
              '                print("‚úÖ Smoke test passed!")',
              '                sys.exit(0)',
              '    except requests.exceptions.RequestException as e:',
              '        print(f"Attempt {i+1}/20 failed: {e}")',
              '    time.sleep(1)',
              'print("‚ùå Smoke test failed: Server did not respond correctly in time.")',
              'sys.exit(1)'
          )
          $scriptLines | Out-File -FilePath "verify_script.py" -Encoding utf8
          python verify_script.py

      - name: üîç Display Logs on Failure
        if: failure()
        shell: pwsh
        run: |
          Write-Host "## üìÑ Monolith STDOUT Log ##"
          Get-Content monolith-stdout.log -ErrorAction SilentlyContinue
          Write-Host "## üìÑ Monolith STDERR Log ##"
          Get-Content monolith-stderr.log -ErrorAction SilentlyContinue
