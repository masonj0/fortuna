name: ğŸ§ª Build Monolith (Experimental)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-monolith:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ¨ Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed" }
          Write-Host "âœ… Frontend built successfully"

      - name: ğŸ“¦ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          # Install the magic ingredients
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32 playwright
          # Install Playwright browsers
          playwright install chromium
          Write-Host "âœ… Dependencies installed"

      - name: ğŸ—ï¸ Build Single EXE
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean fortuna-monolith.spec
          if (-not (Test-Path dist/FortunaMonolith.exe)) {
            throw "PyInstaller build failed"
          }
          Write-Host "âœ… Monolith EXE built successfully"

      - name: ğŸ“¤ Upload Monolith EXE
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: dist/FortunaMonolith.exe
          retention-days: 30

      - name: ğŸš€ Launch Monolith Service
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Launching Monolith for smoke test..."
          Start-Process -FilePath "dist/FortunaMonolith.exe" -PassThru -NoNewWindow
          Start-Sleep -Seconds 5 # Give it a moment to initialize

      - name: ğŸ”¬ Verify Backend Health
        shell: pwsh
        run: |
          $healthUrl = "http://localhost:8000/health"
          $maxRetries = 12
          $delay = 5
          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 10
              if ($response.StatusCode -eq 200) {
                Write-Host "âœ… Backend health check PASSED on attempt $i."
                return
              }
            } catch {
              Write-Warning "Attempt $i: Health check failed. Retrying in $delay seconds..."
            }
            Start-Sleep -Seconds $delay
          }
          throw "âŒ Backend health check failed after $maxRetries attempts."

      - name: ğŸ“¸ Capture UI Screenshot
        shell: pwsh
        continue-on-error: true
        run: |
          # Install Playwright browsers
          playwright install chromium
          $screenshotPath = "monolith-screenshot.png"
          $nodeScript = "const { chromium } = require('playwright');(async () => { const browser = await chromium.launch(); const page = await browser.newPage(); try { await page.goto('http://127.0.0.1:8000', { waitUntil: 'networkidle', timeout: 20000 }); await page.screenshot({ path: '$screenshotPath', fullPage: true }); console.log('âœ… Screenshot captured.'); } catch(e) { console.error('Failed to capture screenshot:', e); process.exit(1); } finally { await browser.close(); } })();"
          node -e $nodeScript

      - name: ğŸ“¤ Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monolith-paparazzi-${{ matrix.arch || 'x64' }}
          path: monolith-screenshot.png
          retention-days: 7

      - name: ğŸ§¹ Cleanup
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "FortunaMonolith" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ… Cleanup complete"

  package-msi:
    name: 'ğŸ’¿ Package Monolith MSI'
    runs-on: windows-latest
    needs: build-monolith
    steps:
      - uses: actions/checkout@v4
      - name: ğŸ“¥ Download Monolith EXE
        uses: actions/download-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: staging

      - name: ğŸ”§ Setup WiX Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - run: dotnet tool install --global wix --version 4.0.5
      - run: echo C:\Users\runneradmin\.dotnet\tools >> $GITHUB_PATH
        shell: bash

      - name: ğŸ“„ Create License File
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          Set-Content -Path "build_wix/license.rtf" -Value '{\rtf1\ansi Placeholder License}' -Encoding Ascii

      - name: ğŸ—ï¸ Build MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          $ver = "0.0.${{ github.run_number }}"
          wix build Product_Monolith.wxs -o "FortunaMonolith-${ver}.msi" -d Version=$ver -d SourceDir="../staging"
          Write-Host "âœ… MSI built successfully"

      - name: ğŸ“¤ Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-MSI
          path: build_wix/FortunaMonolith-*.msi
