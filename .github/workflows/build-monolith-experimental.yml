name: üß™ Build Monolith (Experimental)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-monolith:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üé® Build Frontend
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
          if (-not (Test-Path out/index.html)) { throw "Frontend build failed" }
          Write-Host "‚úÖ Frontend built successfully"

      - name: üì¶ Install Backend Dependencies
        shell: pwsh
        run: |
          pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt
          # Install the magic ingredients
          pip install pywebview[cef] pyinstaller==6.6.0 pywin32 playwright
          # Install Playwright browsers
          playwright install chromium
          Write-Host "‚úÖ Dependencies installed"

      - name: üèóÔ∏è Build Single EXE
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean fortuna-monolith.spec
          if (-not (Test-Path dist/FortunaMonolith.exe)) {
            throw "PyInstaller build failed"
          }
          Write-Host "‚úÖ Monolith EXE built successfully"

      - name: üî¨ Smoke Test Monolith and Capture Screenshot
        shell: pwsh
        timeout-minutes: 5
        run: |
          Write-Host "üöÄ Launching Monolith for smoke test..."
          $process = Start-Process -FilePath "dist/FortunaMonolith.exe" -PassThru -NoNewWindow

          # Wait for the main window to appear by polling the process list
          $maxRetries = 10
          $found = $false
          for ($i = 1; $i -le $maxRetries; $i++) {
            Write-Host "Attempt $i: Checking for 'Fortuna Faucet' window..."
            $mainWindow = Get-Process | Where-Object { $_.MainWindowTitle -eq "Fortuna Faucet" }
            if ($null -ne $mainWindow) {
              Write-Host "‚úÖ Main window found!"
              $found = $true
              break
            }
            Start-Sleep -Seconds 2
          }
          if (-not $found) {
            throw "‚ùå Timed out waiting for the Monolith main window to appear."
          }

          # Now that the window is up, take a screenshot
          $screenshotPath = "monolith-screenshot.png"
          $nodeScript = "const { chromium } = require('playwright');(async () => { const browser = await chromium.launch(); const page = await browser.newPage(); await page.goto('http://127.0.0.1:8000', { waitUntil: 'networkidle' }); await page.screenshot({ path: '$screenshotPath', fullPage: true }); await browser.close(); })();"
          node -e $nodeScript

          if (-not (Test-Path $screenshotPath)) {
            throw "‚ùå Screenshot was not created!"
          }
          Write-Host "‚úÖ Screenshot captured successfully."

          # Clean up
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Monolith test complete."

      - name: üì§ Upload Monolith EXE
        uses: actions/upload-artifact@v4
        with:
          name: FortunaMonolith-EXE
          path: dist/FortunaMonolith.exe
          retention-days: 30

      - name: üì§ Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monolith-paparazzi-${{ matrix.arch || 'x64' }}
          path: monolith-screenshot.png
          retention-days: 7

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          Stop-Process -Name "FortunaMonolith" -Force -ErrorAction SilentlyContinue
          Write-Host "‚úÖ Cleanup complete"