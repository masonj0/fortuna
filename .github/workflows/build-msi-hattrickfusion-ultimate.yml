# System Timestamp: 2025-12-24 18:00:00
name: üé© HatTrick Fusion (Ultimate)
on:
  workflow_dispatch:
    inputs:
      cache-bust:
        description: 'Force a clean build by ignoring all caches'
        required: false
        type: boolean
        default: false
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11' # ‚úÖ RESTORED
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8102'
  FRONTEND_PORT: '3000'
  MSI_NAME: 'HatTrickFusion.msi'
  FIREWALL_RULE: 'HatTrickFusion-Port'
  UPGRADE_CODE: 'FA689549-366B-4C5C-A482-1132F9A34B10'
  FORTUNA_PORT: '8102'
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: windows-2022
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: Cache Build Output
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: web_platform/frontend/out
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package-lock.json', 'web_platform/frontend/**/*.js', 'web_platform/frontend/**/*.ts', 'web_platform/frontend/**/*.tsx', 'web_platform/frontend/**/*.css') }}${{ inputs.cache-bust && format('-{0}', github.run_id) || '' }}
      - name: Install and Build
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: |
          cd web_platform/frontend
          npm ci --prefer-offline --no-audit --no-fund
          npm run build
      - name: Upload Frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: web_platform/frontend/out

  backend-quality:
    name: 'üßØ Backend Quality Gates'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-frontend
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - name: Install Dependencies
        run: |
          pip install uv
          uv pip install --system -r web_service/backend/requirements-dev.txt
      - name: Run Pytest
        run: |
          pytest web_service/backend/tests
  build-backend:
    name: 'üêç Build Backend (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: [build-frontend, backend-quality]
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    env:
      PYTHONUTF8: '1'
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
        with:
          architecture: ${{ matrix.arch }}
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}
          path: web_platform/frontend/out
      - id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $shortSha = "${{ github.sha }}".Substring(0,7)
          "short_sha=$shortSha" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $constraintFile = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "üõ°Ô∏è ACTIVATING X86 SAFE MODE (SIMPLE)"
            @(
              "numpy==1.23.5",
              "pandas==1.5.3",
              "greenlet==3.0.3",
              "--only-binary=:all:"
            ) | Set-Content $constraintFile
            Write-Host "‚úÖ Constraints: numpy, pandas, greenlet==3.0.3"
          } else { New-Item $constraintFile -ItemType File -Force }
          "file=$constraintFile" | Out-File $env:GITHUB_OUTPUT -Append

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv pip install --system -r web_service/backend/requirements.txt -c ${{ steps.constraints.outputs.file }}
          uv pip install --system pyinstaller==6.6.0 pywin32

      - name: üíæ Create required directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "web_service/backend/json" -Force

      - name: üîÆ Build Executable
        run: |
          pyinstaller --noconfirm --clean --log-level INFO fortuna-unified.spec

      - name: Upload Backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/fortuna-webservice/

  package-msi:
    name: 'üíø Package MSI (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: [build-backend]
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
    env:
      SERVICE_NAME: 'FortunaWebService'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: staging/backend
      - name: '‚öñÔ∏è The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $stagingDir = "staging"
          if (Test-Path $stagingDir) {
            $size = (Get-ChildItem $stagingDir -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            $sizeRounded = [math]::Round($size, 2)
            Write-Host "üìä Total Payload Size: $sizeRounded MB"
          }
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: üìÑ Ensure WiX License Exists
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          $licensePath = 'build_wix/license.rtf'
          Set-Content -Path $licensePath -Value '{\rtf1\ansi\deff0{\fonttbl{\f0 Arial;}}\f0\fs24 Placeholder License}\0' -Encoding Ascii
      - name: Prepare WiX
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          Copy-Item build_wix/Product_WebService.wxs build_wix/Product.wxs -Force
          $wxsPath = 'build_wix/Product.wxs'
          $wxsContent = [xml](Get-Content $wxsPath -Raw)
          $serviceControl = $wxsContent.SelectSingleNode("//*[local-name()='ServiceControl']")
          if ($serviceControl -and $serviceControl.HasAttribute("Start")) {
              $serviceControl.RemoveAttribute("Start")
              $wxsContent.Save($wxsPath)
          }
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64;x86</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content build_wix/Fortuna.wixproj ($proj -join "`r`n") -Encoding utf8
      - name: Build MSI
        working-directory: build_wix
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=${{ matrix.arch }} -p:Version="${{ needs.build-backend.outputs.semver }}" -p:SourceDir="../staging" -p:ServicePort="${{ env.SERVICE_PORT }}"
      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: hat-trick-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: build_wix/bin/${{ matrix.arch }}/Release/*

  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: package-msi
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: hat-trick-msi-${{ matrix.arch }}-${{ github.run_id }}
          path: msi-installer
      - name: üî• Install & Verify
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $msiPath = (Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1).FullName
          sc.exe delete "FortunaWebService" 2>$null
          Start-Sleep -Seconds 5
          $logFile = "msi-install.log"
          $msiArgs = "/i `"$msiPath`" /qn /L*v `"$logFile`""
          Start-Process msiexec.exe -ArgumentList $msiArgs -Wait -PassThru
          $progFiles = ${env:ProgramFiles}
          if ('${{ matrix.arch }}' -eq 'x86') { $progFiles = ${env:ProgramFiles(x86)} }
          $installDir = Join-Path $progFiles "Fortuna Faucet Service"
          New-Item -ItemType Directory -Path (Join-Path $installDir "data"), (Join-Path $installDir "json"), (Join-Path $installDir "logs") -Force
          icacls (Join-Path $installDir "data") /grant "NT AUTHORITY\SYSTEM:(OI)(CI)F" /T
          icacls (Join-Path $installDir "json") /grant "NT AUTHORITY\SYSTEM:(OI)(CI)F" /T
          icacls (Join-Path $installDir "logs") /grant "NT AUTHORITY\SYSTEM:(OI)(CI)F" /T
      - name: üöÄ Start Service & Health Check
        shell: pwsh
        run: |
          Start-Service -Name "FortunaWebService"
          Start-Sleep -Seconds 10
          $maxRetries = 5
          For ($i=0; $i -lt $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:${{ env.SERVICE_PORT }}/health" -UseBasicParsing
              if ($response.StatusCode -eq 200) { Write-Host "‚úÖ Health check PASSED."; exit 0 }
            } catch { Write-Host "Attempt $($i+1) failed. Retrying..." }
            Start-Sleep -Seconds 5
          }
          throw "Health check failed."
      - name: 'üì∏ Paparazzi (Visual Proof)'
        if: success()
        shell: pwsh
        run: |
          npm install playwright
          npx playwright install chromium
          $nodeScript = "const { chromium } = require('playwright'); (async () => { const browser = await chromium.launch(); const page = await browser.newPage(); try { await page.goto('http://127.0.0.1:8000/docs', { timeout: 10000 }); await page.screenshot({ path: 'proof-of-life.png', fullPage: true }); } finally { await browser.close(); } })();"
          node -e $nodeScript
      - name: üì§ Upload Visual Proof
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-proof-${{ matrix.arch }}
          path: proof-of-life.png
      - name: 'üïµÔ∏è CSI: Windows Post-Mortem (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Get-EventLog -LogName Application -Newest 50 -EntryType Error,Warning
      - name: üßπ Stop Service
        if: always()
        shell: pwsh
        run: |
          Stop-Service -Name "FortunaWebService" -ErrorAction SilentlyContinue
