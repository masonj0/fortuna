name: HatTrick Fusion (Ultimate Edition)
on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  FORTUNA_PORT: '8102'
  FRONTEND_PORT: '3000'
  FIREWALL_RULE: 'HatTrickFusion-Port'
  # Paths
  FRONTEND_DIR: 'web_platform/frontend'
  WIX_DIR: 'build_wix'
  # Settings
  PYTHONUTF8: '1'
  # CRITICAL FIX: Mock Keys to prevent backend crash
  API_KEY: 'mock_key_for_build'
  TVG_API_KEY: 'mock_tvg_key'
  FORTUNA_ENV: 'build_mode'

jobs:
  # ==================================================================================
  # JOB 2: BUILD FRONTEND (Cached & Manifested)
  # ==================================================================================
  build-frontend:
    name: 'üé® Build Frontend'
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'
      - name: Cache Build Output
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: ${{ env.FRONTEND_DIR }}/out
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package-lock.json', '**/*.js', '**/*.ts', '**/*.tsx', '**/*.css') }}
          restore-keys: |
            ${{ runner.os }}-frontend-
      - name: Install & Build
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline --no-audit
          npm run build
      - name: Generate Artifact Manifest
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $outDir = Resolve-Path "${{ env.FRONTEND_DIR }}/out"
          # Fallback for different env var names in different workflows
          if (-not (Test-Path $outDir)) { $outDir = Resolve-Path "${{ env.FRONTEND_BUILD_DIR }}" }

          if (-not (Test-Path $outDir)) { Write-Error "‚ùå Build failed: 'out' dir missing"; exit 1 }

          $manifestPath = "frontend-manifest.tsv"
          "RelativePath`tSizeBytes`tSHA256" | Out-File $manifestPath -Encoding utf8

          $files = Get-ChildItem -Path $outDir -Recurse -File
          if ($files.Count -eq 0) { Write-Error "‚ùå Build failed: 'out' dir empty"; exit 1 }

          Write-Host "‚úÖ Frontend built: $($files.Count) files."

          foreach ($f in $files) {
            # FIX: Use TrimStart('\','/') to prevent char conversion error.
            $rel = $f.FullName.Substring($outDir.Path.Length).TrimStart('\','/')
            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)
            "$rel`t$($f.Length)`t$hash" | Out-File $manifestPath -Encoding utf8 -Append
          }
      - name: Upload Frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            ${{ env.FRONTEND_DIR }}/out
            frontend-manifest.tsv
          retention-days: 3

  # ==================================================================================
  # JOB 3: BUILD BACKEND (TDD, Cached, Frozen & Injected)
  # ==================================================================================
  build-backend:
    name: 'üêç Build Backend'
    runs-on: windows-latest
    needs: [build-frontend]
    timeout-minutes: 30
    outputs:
      semver: ${{ steps.meta.outputs.semver }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
    env:
      BACKEND_DIR: 'web_service/backend'
      MODULE_PATH: 'web_service.backend'
    steps:
      - uses: actions/checkout@v4
      - id: meta
        shell: pwsh
        run: |
          $ver = if ("${{ github.ref }}" -match 'refs/tags/v(.*)') { $Matches[1] } else { "0.0.${{ github.run_number }}" }
          "semver=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          $sha = git rev-parse --short HEAD
          "short_sha=$sha" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.FRONTEND_DIR }}/out
      - name: Clean Staging
        run: Remove-Item "${{ env.FRONTEND_DIR }}/out/frontend-manifest.tsv" -ErrorAction SilentlyContinue
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: Install Dependencies
        run: |
          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt
          pip install pyinstaller==6.6.0 pytest pytest-asyncio httpx asgi-lifespan fakeredis
          pip freeze > backend-freeze.txt

      - name: üß™ Run Unit Tests (Quality Gate)
        shell: pwsh
        run: |
          # 1. Define the Failure Threshold
          $MAX_ALLOWED_FAILURES = 30
          Write-Host "Running Test Suite (Threshold: $MAX_ALLOWED_FAILURES failures)..."
          # 2. Run Pytest and generate an XML report.
          # We use 'cmd /c' and '|| true' to ensure the script doesn't die immediately on exit code 1.
          cmd /c "pytest ${{ env.BACKEND_DIR }}/tests --junitxml=test-report.xml" || Write-Host "Pytest finished with issues."
          # 3. Parse the XML Report
          if (Test-Path "test-report.xml") {
              [xml]$xml = Get-Content "test-report.xml"
              # Sum up failures and errors
              $failures = 0
              $errors = 0
              # Handle different XML structures (sometimes root is testsuites, sometimes testsuite)
              if ($xml.testsuites) {
                  $failures = [int]$xml.testsuites.failures
                  $errors = [int]$xml.testsuites.errors
              } elseif ($xml.testsuite) {
                  $failures = [int]$xml.testsuite.failures
                  $errors = [int]$xml.testsuite.errors
              }
              $total_issues = $failures + $errors
              Write-Host "----------------------------------------"
              Write-Host "üìä TEST RESULTS SUMMARY"
              Write-Host "   Failures: $failures"
              Write-Host "   Errors:   $errors"
              Write-Host "   Total:    $total_issues"
              Write-Host "   Limit:    $MAX_ALLOWED_FAILURES"
              Write-Host "----------------------------------------"
              # 4. The Decision Logic
              if ($total_issues -gt $MAX_ALLOWED_FAILURES) {
                  Write-Error "‚ùå CRITICAL: Too many tests failed ($total_issues). Limit is $MAX_ALLOWED_FAILURES."
                  exit 1
              } else {
                  Write-Host "‚úÖ ACCEPTABLE: Failure count is within tolerance. Proceeding with build..." -ForegroundColor Green
                  exit 0 # Explicitly exit with success code to override pytest's failure code
              }
          } else {
              Write-Error "‚ùå FATAL: No test report generated. Pytest failed to start."
              exit 1
          }

      - name: Cache PyInstaller Dist
        id: cache-backend
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ runner.os }}-backend-${{ hashFiles(format('{0}/**', env.BACKEND_DIR)) }}

      - name: Generate Spec & Build
        if: steps.cache-backend.outputs.cache-hit != 'true'
        shell: python
        env:
          BACKEND_DIR: ${{ env.BACKEND_DIR }}
          MODULE_PATH: ${{ env.MODULE_PATH }}
          FRONTEND_OUT: ${{ env.FRONTEND_DIR }}/out
        run: |
          import os
          from pathlib import Path

          bk_dir = os.environ['BACKEND_DIR']
          mod_path = os.environ['MODULE_PATH']
          # CHANGE: Point to the new service wrapper
          entry = f"{bk_dir}/main.py"
          frontend_out = os.environ['FRONTEND_OUT']

          # FIX: Fixed quoting in datas list to avoid syntax error
          spec = f"""
          # -- mode: python ; coding: utf-8 --
          from PyInstaller.utils.hooks import collect_data_files, collect_submodules

          block_cipher = None

          a = Analysis(
              ['{entry}'],
              pathex=[],
              binaries=[],
              datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],
              hiddenimports=collect_submodules('{mod_path}') + ['win32timezone'],
              hookspath=[],
              runtime_hooks=[],
              excludes=['tests', 'pytest'],
              win_no_prefer_redirects=False,
              win_private_assemblies=False,
              cipher=block_cipher,
              noarchive=False,
          )
          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)
          exe = EXE(
              pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],
              name='fortuna-backend', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False
          )
          """
          with open("hat-trick.spec", "w") as f: f.write(spec)
          os.system("pyinstaller hat-trick.spec --clean --noconfirm")
      - name: Verify & Hash Executable
        shell: pwsh
        run: |
          $exe = "dist/fortuna-backend.exe"
          if (-not (Test-Path $exe)) { Write-Error "‚ùå Executable missing"; exit 1 }
          $size = (Get-Item $exe).Length / 1MB
          if ($size -lt 10) { Write-Error "‚ùå Executable too small ($size MB)"; exit 1 }
          $hash = (Get-FileHash $exe -Algorithm SHA256).Hash
          $hash | Out-File "dist/fortuna-backend.exe.sha256" -Encoding utf8
          Move-Item backend-freeze.txt dist/
          Write-Host "‚úÖ Backend ready: $size MB | SHA256: $hash"
      - name: Upload Backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}
          path: dist/
          retention-days: 3

  # ==================================================================================
  # JOB 4: PACKAGE MSI (WiX v4 with Dietician & Canary)
  # ==================================================================================
  package-msi:
    name: 'üíø Package MSI'
    runs-on: windows-latest
    needs: [build-backend]
    timeout-minutes: 30
    outputs:
      msi_name: ${{ steps.name_msi.outputs.msi_name }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}
          path: staging/backend

      - name: Create Restart Service Batch Script
        shell: cmd
        run: |
          echo @echo off > staging\\backend\\restart_service.bat
          echo net stop FortunaWebService >> staging\\backend\\restart_service.bat
          echo net start FortunaWebService >> staging\\backend\\restart_service.bat
          echo Created restart_service.bat for installer inclusion.

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: '‚öñÔ∏è The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $target = "staging"
          $limitMB = 300
          Write-Host "--- üìä Size Breakdown ---"
          $files = Get-ChildItem -Path $target -Recurse -File -ErrorAction SilentlyContinue
          if (!$files) { Write-Warning "No files found to weigh."; exit 0 }
          $totalBytes = ($files | Measure-Object -Property Length -Sum).Sum
          $totalMB = [math]::Round($totalBytes / 1MB, 2)
          Write-Host "Total Payload Size: $totalMB MB"
          if ($totalMB -gt $limitMB) {
              Write-Warning "‚ö†Ô∏è BLOAT ALERT: Build exceeds $limitMB MB limit! Check the heaviest files below."
          } else {
              Write-Host "‚úÖ Size within limits (< $limitMB MB)." -ForegroundColor Green
          }
          Write-Host "`n--- üêò Top 10 Heaviest Files ---"
          $files | Sort-Object Length -Descending | Select-Object -First 10 @{N='File';E={$_.FullName.Replace($pwd,'')}}, @{N='Size(MB)';E={"{0:N2}" -f ($_.Length/1MB)}} | Format-Table -AutoSize

      - name: üìÑ Ensure WiX License Exists
        shell: pwsh
        run: |
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }
          $licensePath = 'build_wix/license.rtf'
          if (-not (Test-Path $licensePath)) {
            Write-Host '‚ö†Ô∏è License file missing. Generating placeholder...'
            # FIX: Use Base64 decoding to avoid RTF escape sequence issues
            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String("e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0="))
            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii
            Write-Host '‚úÖ Placeholder license.rtf created.'
          } else {
            Write-Host '‚úÖ Existing license.rtf found.'
          }
      - name: Prepare WiX
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }

          # Copy template and apply fix
          Copy-Item build_wix/Product_WithService.wxs build_wix/Product.wxs -Force

          # Stage Executable
          if (Test-Path staging/backend/fortuna-backend.exe) {
            Move-Item staging/backend/fortuna-backend.exe staging/backend/fortuna-webservice.exe -Force
          }

          # FIX: Generate Valid .wixproj with Extensions
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content build_wix/Fortuna.wixproj ($proj -join "`r`n") -Encoding utf8
      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        # FIX: Pass variables via DefineConstants
        run: dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version="0.0.${{ github.run_number }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.FORTUNA_PORT }}"

      - name: 'üê§ The Canary (Malware Pre-Flight)'
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "${{ env.WIX_DIR }}/bin/x64/Release" -Filter "*.msi" | Select-Object -First 1
          if (!$msi) { Write-Warning "No MSI found to scan."; exit 0 }
          Write-Host "üîç Scanning $($msi.Name) with Windows Defender..."
          $defender = "C:\Program Files\Windows Defender\MpCmdRun.exe"
          if (-not (Test-Path $defender)) { Write-Warning "Windows Defender CLI not found."; exit 0 }
          $proc = Start-Process -FilePath $defender -ArgumentList "-Scan -ScanType 3 -File `"$($msi.FullName)`"" -Wait -PassThru -NoNewWindow
          if ($proc.ExitCode -eq 0) { Write-Host "‚úÖ CLEAN: Windows Defender found no threats." -ForegroundColor Green }
          elseif ($proc.ExitCode -eq 2) { Write-Error "üö® THREAT DETECTED!"; exit 1 }
          else { Write-Warning "‚ö†Ô∏è Scan inconclusive: $($proc.ExitCode)" }

      - name: Rename & Hash MSI
        id: name_msi
        shell: pwsh
        run: |
          $ver = "${{ needs.build-backend.outputs.semver }}"
          $sha = "${{ needs.build-backend.outputs.short_sha }}"

          # FIX: Don't assume the name. Find whatever MSI was built.
          $releaseDir = "${{ env.WIX_DIR }}/bin/x64/Release"
          $msiFound = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select-Object -First 1

          if (-not $msiFound) {
            Write-Error "‚ùå FATAL: No MSI file found in $releaseDir. Build may have failed silently."
            exit 1
          }

          Write-Host "Found built MSI: $($msiFound.Name)"

          $targetName = "HatTrickFusion-${ver}-${sha}.msi"
          $newPath = Join-Path $releaseDir $targetName

          Move-Item -Path $msiFound.FullName -Destination $newPath -Force

          # Generate Hash
          $hash = (Get-FileHash $newPath -Algorithm SHA256).Hash
          $hash | Out-File "$newPath.sha256" -Encoding utf8

          Write-Host "‚úÖ MSI Renamed to: $targetName"
          "msi_name=$targetName" | Out-File $env:GITHUB_OUTPUT -Append

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ env.WIX_DIR }}/bin/x64/Release/*
          retention-days: 7

  # ==================================================================================
  # JOB 5: SMOKE TEST (Triple-Loop + Paparazzi)
  # ==================================================================================
  smoke-test:
    name: 'üî¨ Smoke Test'
    runs-on: windows-latest
    needs: [package-msi]
    timeout-minutes: 30
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}
          path: installer
      - name: üõ°Ô∏è Firewall & Install
        shell: pwsh
        run: |
          New-NetFirewallRule -DisplayName "${{ env.FIREWALL_RULE }}" -Direction Inbound -LocalPort ${{ env.FORTUNA_PORT }} -Protocol TCP -Action Allow
          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {
            sc.exe stop FortunaWebService 2>&1 | Out-Null
            sc.exe delete FortunaWebService 2>&1 | Out-Null
          }
          $msi = Get-ChildItem installer -Filter "*.msi" -Recurse | Select -First 1
          if (!$msi) { throw "No MSI found" }
          Write-Host "Installing $($msi.Name)..."
          $msiPath = $msi.FullName
          $args = "/i `"$msiPath`" /qn /L*v installation.log"
          $proc = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru
          if ($proc.ExitCode -ne 0) {
            Get-Content install.log -Tail 50
            throw "Install failed with code $($proc.ExitCode)"
          }

      - name: Create Runtime Directories
        shell: pwsh
        run: |
          $installDir = "C:\Program Files\Fortuna Faucet Service"
          New-Item -ItemType Directory -Path "$installDir\data" -Force
          New-Item -ItemType Directory -Path "$installDir\json" -Force
          New-Item -ItemType Directory -Path "$installDir\logs" -Force
          Write-Host "‚úÖ Ensured runtime directories exist in $installDir"
      - name: '‚è≥ Loop 1 - Service Registration'
        shell: pwsh
        run: |
          $reg = "HKLM:\SYSTEM\CurrentControlSet\Services\FortunaWebService"
          for ($i=0; $i -lt 30; $i++) {
            if (Test-Path $reg) { Write-Host "‚úÖ Service Registered"; exit 0 }
            Start-Sleep 1
          }
          throw "Service failed to register in Registry"

      - name: 'üöÄ Loop 2 - Launch & Port Bind'
        shell: python
        env:
          PORT: ${{ env.FORTUNA_PORT }}
        run: |
          import os, socket, time, urllib.request, urllib.error, subprocess, sys
          port = int(os.environ["PORT"])
          print("--- Starting Service ---")
          subprocess.run(["sc.exe", "start", "FortunaWebService"], check=False)
          print(f"--- Waiting for Port {port} (60s) ---")
          for _ in range(60):
            try:
              with socket.create_connection(("127.0.0.1", port), timeout=1):
                print("‚úÖ Socket bound.")
                sys.exit(0)
            except:
              time.sleep(1)

          print("[X] Port bind timeout")
          subprocess.run(["sc.exe", "query", "FortunaWebService"])
          sys.exit(1)

      - name: Test Service Health (Smoke Test)
        shell: pwsh
        run: |
          Start-Sleep -Seconds 10
          $response = Invoke-WebRequest -Uri http://localhost:8102/health -Method Get -UseBasicParsing
          if ($response.StatusCode -eq 200) {
            Write-Host '‚úÖ Service is Healthy on Port 8102'
          } else {
            Write-Error '‚ùå Service Failed Health Check'
            exit 1
          }

      - name: üìä Capture Diagnostics
        if: failure()
        shell: pwsh
        run: |
          $diag = "diagnostics"
          New-Item -ItemType Directory -Path $diag -Force
          Copy-Item install.log $diag
          Get-EventLog -LogName Application -Source "FortunaWebService" -Newest 50 | Out-File "$diag/events.txt"
          Get-Service FortunaWebService | Out-File "$diag/service_state.txt"
          netstat -anob > "$diag/netstat.txt"
      - name: üì§ Upload Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-failure-${{ needs.path-finder.outputs.build_id }}
          path: diagnostics/
          retention-days: 30
      - name: üßπ Cleanup
        if: always()
        run: |
          sc.exe stop FortunaWebService
          sc.exe delete FortunaWebService
          Remove-NetFirewallRule -DisplayName "${{ env.FIREWALL_RULE }}" -ErrorAction SilentlyContinue

  # ==================================================================================
  # JOB 6: GENERATE SBOM
  # ==================================================================================
  generate-sbom:
    name: 'üìú Generate SBOM'
    runs-on: ubuntu-latest
    needs: [build-backend]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}
          path: backend
      - name: Create SBOM
        uses: anchore/sbom-action@v0
        with:
          path: backend
          output-file: sbom.spdx.json
          format: spdx-json
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.run_id }}-${{ github.run_attempt }}
          path: sbom.json

  # ==================================================================================
  # JOB 7: RELEASE (On Tag)
  # ==================================================================================
  release:
    name: 'üöÄ Create Release'
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [smoke-test, generate-sbom]
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}
          path: assets
      - uses: actions/download-artifact@v4
        with:
          name: sbom-${{ github.run_id }}-${{ github.run_attempt }}
          path: assets
      - name: Generate Checksums
        run: |
          cd assets
          sha256sum * > SHASUMS256.txt
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build_wix/FortunaWebSetup.msi
            sbom.json
          draft: false
          prerelease: false
