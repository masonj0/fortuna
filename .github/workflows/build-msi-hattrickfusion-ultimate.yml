# System Timestamp: 2025-12-21 14:04:35
name: ðŸš€ HattrickFusion Ultimate (MSI)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9'
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  SERVICE_PORT: '8101'
  FORTUNA_ENV: smoke-test

jobs:
  preflight-check:
    name: ðŸ” Preflight & Pathfinding
    runs-on: windows-latest
    outputs:
      backend_dir: ${{ steps.pathfinder.outputs.backend_dir }}
      backend_reqs: ${{ steps.pathfinder.outputs.backend_reqs }}
      backend_spec: ${{ steps.pathfinder.outputs.backend_spec }}
      semver: ${{ steps.git_version.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: ðŸ·ï¸ Derive SemVer
        id: git_version
        shell: pwsh
        run: |
          $semver = "0.0.${{ github.run_number }}"
          echo "semver=$semver" >> $env:GITHUB_OUTPUT
      - name: ðŸ—ºï¸ Path-Finder (Dynamic Backend Detection)
        id: pathfinder
        shell: pwsh
        run: |
          if (Test-Path "web_service/backend/main.py") {
            echo "backend_dir=web_service/backend" >> $env:GITHUB_OUTPUT
            echo "backend_reqs=web_service/backend/requirements.txt" >> $env:GITHUB_OUTPUT
            echo "backend_spec=fortuna-unified.spec" >> $env:GITHUB_OUTPUT
            Write-Host "âœ… Detected 'web_service' backend."
          } else {
            throw "âŒ FATAL: Could not detect a valid backend."
          }

  build-backend:
    name: ðŸ Build Backend
    needs: preflight-check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      - name: 'ðŸ Install Dependencies & PyInstaller'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ needs.preflight-check.outputs.backend_reqs }}
          pip install pyinstaller pywin32
      - name: 'ðŸ—ï¸ Build Binary with PyInstaller'
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --log-level INFO ${{ needs.preflight-check.outputs.backend_spec }}
      - name: 'ðŸ“¤ Upload Backend Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ github.run_id }}
          path: dist/fortuna-webservice

  build-frontend:
    name: âš›ï¸ Build Frontend
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: web_platform/frontend/package-lock.json
      - name: ðŸ—ï¸ Build Next.js
        working-directory: web_platform/frontend
        run: |
          npm ci
          npm run build
      - name: ðŸ“¤ Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: web_platform/frontend/out

  package-msi:
    name: ðŸ“¦ Package MSI
    needs: [preflight-check, build-backend, build-frontend]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ github.run_id }}
          path: staging/backend
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: staging/backend/ui
      - name: ðŸ”§ Setup WiX Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - run: dotnet tool install --global wix --version ${{ env.WIX_VERSION }}
      - run: echo C:\Users\runneradmin\.dotnet\tools >> $GITHUB_PATH
        shell: bash
      - name: 'ðŸ—ï¸ Build MSI'
        shell: pwsh
        run: |
          wix build build_wix/Product_WebService.wxs `
            -o "Fortuna-${{ needs.preflight-check.outputs.semver }}-x64.msi" `
            -d Version="${{ needs.preflight-check.outputs.semver }}" `
            -d SourceDir="staging/backend" `
            -d Platform="x64" `
            -d ServicePort="${{ env.SERVICE_PORT }}"
      - name: ðŸ“¤ Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: msi-dist-${{ github.run_id }}
          path: Fortuna-*.msi

  smoke-test:
    name: ðŸš¬ Smoke Test
    needs: [package-msi, preflight-check]
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-dist-${{ github.run_id }}
          path: msi-installer
      - name: ðŸ§¹ Pre-Install Cleanup
        shell: pwsh
        run: |
          # The '*' is a wildcard that tells PowerShell to ignore any errors if the service doesn't exist.
          sc.exe delete "FortunaWebService" *>$null
          Start-Sleep -Seconds 2
      - name: ðŸ’¿ Install MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path "msi-installer" -Filter "*.msi" -Recurse | Select-Object -First 1
          if (-not $msi) { throw "MSI not found!" }
          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /quiet /norestart" -Wait
          Start-Sleep 10
      - name: 'ðŸš€ Start Service & Create Dirs'
        shell: pwsh
        run: |
          $installRoot = "C:\Program Files\Fortuna Faucet Service"
          if (-not (Test-Path $installRoot)) { throw "âŒ Install dir not found!" }
          New-Item -Path "$installRoot\data", "$installRoot\json", "$installRoot\logs" -ItemType Directory -Force | Out-Null
          Start-Service "FortunaWebService"
          Start-Sleep 10
      - name: 'ðŸ©º Health Check'
        shell: pwsh
        run: |
          $maxRetries = 5
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:${{ env.SERVICE_PORT }}/health" -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) { Write-Host "âœ… Health check PASSED on attempt $i."; exit 0 }
            } catch {}
            Start-Sleep -Seconds (2 * $i)
          }
          throw "âŒ Service health check failed after $maxRetries attempts."
      - name: 'ðŸ•µï¸ CSI (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Get-Process | Where-Object { $_.ProcessName -match "fortuna" }
          Get-EventLog -LogName Application -Newest 50 -EntryType Error,Warning

  release:
    name: ðŸš€ Publish Release
    needs: smoke-test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-dist-${{ github.run_id }}
          path: release_assets
      - name: ðŸ” Generate Checksums
        run: |
          cd release_assets
          sha256sum *.msi > SHASUMS256.txt
      - name: ðŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*
          generate_release_notes: true
