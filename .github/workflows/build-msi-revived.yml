# System Timestamp: 2025-12-13 13:01:00
name: ðŸ§Ÿ ðŸ›ï¸ Fortuna Web Service MSI (The Veteran Reborn)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11' # ðŸš€ CRITICAL: 3.12 breaks x86 builds
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  FORTUNA_PORT: '8102'
  # Mock Keys to prevent backend crash
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test
  # Paths
  FRONTEND_DIR: 'web_platform/frontend'
  BACKEND_DIR: 'web_service/backend'
  WIX_DIR: 'build_wix'

jobs:
  # 1. BUILD FRONTEND (Architecture Neutral)
  build-frontend:
    name: 'ðŸŽ¨ Build Frontend'
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Install & Build
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline --no-audit
          npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_DIR }}/out

  # 2. BUILD BACKEND (Matrix: x64 & x86)
  build-backend:
    name: 'ðŸ Build Backend (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: build-frontend
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ${{ env.FRONTEND_DIR }}/out

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.arch }}
          cache: 'pip'

      - name: ðŸ§¾ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            # ðŸš€ SAFE MODE: Pin versions with known 32-bit wheels
            "numpy==1.23.5`r`npandas==1.5.3" | Set-Content $file
            Write-Host "âœ… Created x86 constraints (Safe Mode)"
          } else {
            New-Item $file -ItemType File -Force
            Write-Host "âœ… Created x64 constraints (Modern Mode)"
          }
          "file=$file" | Out-File $env:GITHUB_OUTPUT -Append

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # ðŸš€ Apply Constraints
          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt -c ${{ steps.constraints.outputs.file }}
          pip install pyinstaller==6.6.0 pywin32

      - name: Build Backend (PyInstaller)
        run: |
          # CRITICAL: Target service_entry.py for Windows Service
          # CRITICAL: Add win32timezone to prevent Error 1053
          pyinstaller --noconfirm --onedir --clean --name fortuna-backend --hidden-import=win32timezone --hidden-import=win32serviceutil --add-data "web_service/backend;backend" --add-data "web_platform/frontend/out;ui" web_service/backend/service_entry.py

      - uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: dist/fortuna-backend/

  # 3. PACKAGE MSI (Matrix: x64 & x86)
  package-msi:
    name: 'ðŸ’¿ Package MSI (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: build-backend
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - name: ðŸ·ï¸ Derive SemVer & Build ID
        id: git_version
        shell: pwsh
        run: |
          $tag = git describe --tags --abbrev=0 2>$null
          if (-not $tag) { Write-Host "No tags found, defaulting to v0.0.0"; $tag = "v0.0.${{ github.run_number }}" }
          echo "Build Version: $tag"
          "semver=$tag" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}
          path: staging/backend

      - name: Create Restart Service Batch Script
        shell: cmd
        run: |
          echo @echo off > staging\backend\restart_service.bat
          echo net stop FortunaService >> staging\backend\restart_service.bat
          echo net start FortunaService >> staging\backend\restart_service.bat

      - name: 'âš–ï¸ The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $size = (Get-ChildItem staging -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Total Payload: $([math]::Round($size, 2)) MB"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}


      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        run: |
          # ðŸš€ Pass Matrix Arch to WiX
          dotnet build Fortuna.wixproj -c Release -p:Platform=${{ matrix.arch }} -p:Version="${{ steps.git_version.outputs.semver }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.FORTUNA_PORT }}"

      - name: Rename & Hash
        run: |
          $releaseDir = "${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release"
          $msi = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select -First 1
          $target = "FortunaService-${{ matrix.arch }}-${{ steps.git_version.outputs.semver }}.msi"
          Move-Item $msi.FullName -Destination "$releaseDir/$target" -Force
          Write-Host "âœ… MSI Ready: $target"

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: ${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release/*.msi

  # 4. SMOKE TEST (Matrix: x64 & x86)
  smoke-test:
    name: 'ðŸ”¬ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-latest
    needs: package-msi
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}
          path: installer

      - name: Install MSI
        run: |
          $msi = Get-ChildItem installer/*.msi | Select -First 1
          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait

      - name: Verify Service & Port
        shell: pwsh
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          # ðŸš€ DYNAMIC PATH LOGIC
          $progFiles = if ($env:ARCH -eq 'x86') { ${env:ProgramFiles(x86)} } else { $env:ProgramFiles }
          $installRoot = "$progFiles\FortunaWeb"

          if (-not (Test-Path $installRoot)) { throw "âŒ Install dir not found at $installRoot" }

          Write-Host "Waiting for service..."
          Start-Sleep -Seconds 10

          $response = Invoke-WebRequest -Uri "http://localhost:${{ env.FORTUNA_PORT }}/health" -UseBasicParsing
          if ($response.StatusCode -eq 200) { Write-Host "âœ… Service Healthy" } else { throw "âŒ Service Failed" }

      - name: 'ðŸ“¸ Paparazzi (Visual Proof)'
        run: |
          npm install playwright
          npx playwright install chromium --with-deps
          # FIX: Point to /docs
          $url = "http://127.0.0.1:${{ env.FORTUNA_PORT }}/docs"
          node -e "const { chromium } = require('playwright'); (async () => { const browser = await chromium.launch(); const page = await browser.newPage(); await page.goto('$url'); await page.screenshot({ path: 'proof.png' }); await browser.close(); })();"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: proof-${{ matrix.arch }}
          path: proof.png
