# System Timestamp: 2025-12-21 14:04:35
name: üßü üèõÔ∏è Fortuna Web Service MSI (The Veteran Reborn)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.9' # üöÄ CRITICAL: 3.12 breaks x86 builds
  DOTNET_VERSION: '8.0.x'
  WIX_VERSION: '4.0.5'
  FORTUNA_PORT: '8102'
  # Mock Keys to prevent backend crash
  API_KEY: mock_key
  TVG_API_KEY: mock
  GREYHOUND_API_URL: http://mock
  FORTUNA_ENV: smoke-test
  # Paths
  FRONTEND_DIR: 'web_platform/frontend'
  BACKEND_DIR: 'web_service/backend'
  WIX_DIR: 'build_wix'

jobs:
  # 1. BUILD FRONTEND (Architecture Neutral)
  build-frontend:
    name: 'üé® Build Frontend'
    runs-on: windows-2022
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'

      - name: Install & Build
        run: |
          cd ${{ env.FRONTEND_DIR }}
          npm ci --prefer-offline --no-audit
          npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: ${{ env.FRONTEND_DIR }}/out

  # 2. BUILD BACKEND (Matrix: x64 & x86)
  build-backend:
    name: 'üêç Build Backend (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: build-frontend
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: frontend-dist-${{ github.run_id }}
          path: ${{ env.FRONTEND_DIR }}/out

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          architecture: '${{ matrix.arch }}'
          cache: 'pip'

      - name: üßæ Create Architecture Constraints
        id: constraints
        shell: pwsh
        run: |
          $file = "constraints.txt"
          if ('${{ matrix.arch }}' -eq 'x86') {
            "numpy==1.23.5`r`npandas==1.5.3" | Set-Content $file
            Write-Host "‚úÖ Created x86 constraints (Safe Mode)"
          } else {
            New-Item $file -ItemType File -Force
          }
          "file=$file" | Out-File $env:GITHUB_OUTPUT -Append

      - name: CACHE-PYI Cache PyInstaller Build
        id: cache-pyi-build
        uses: actions/cache@v4
        with:
          path: dist/fortuna-webservice
          key: ${{ runner.os }}-${{ matrix.arch }}-pyi-${{ hashFiles('web_service/backend/**/*.py', 'fortuna-unified.spec', 'web_service/backend/requirements*.txt') }}
      - name: Install Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install uv

          if ('${{ matrix.arch }}' -eq 'x86') {
            Write-Host "[BUILD] Installing x86-constrained packages first..."
            uv pip install --system --only-binary=:all: `
              "sqlalchemy==1.4.46" `
              "greenlet==1.1.2" `
              "pandas==1.5.3" `
              "numpy==1.23.5" `
              "scipy==1.8.1"
            if ($LASTEXITCODE -ne 0) {
              throw "[BUILD] ‚ùå Failed to install x86-constrained packages"
            }
            Write-Host "[BUILD] Installing remaining dependencies for x86..."
            uv pip install --system -r ${{ env.BACKEND_DIR }}/requirements.txt --no-deps
          } else {
            Write-Host "[BUILD] Installing all dependencies for x64..."
            uv pip install --system -r ${{ env.BACKEND_DIR }}/requirements.txt
          }

          if ($LASTEXITCODE -ne 0) {
            throw "[BUILD] ‚ùå Failed to install remaining requirements"
          }

          Write-Host "[BUILD] Verifying all dependencies are satisfied..."
          pip check

          Write-Host "[BUILD] Installing PyInstaller..."
          uv pip install --system pyinstaller==6.6.0 pywin32

          Write-Host "[BUILD] ‚úÖ All dependencies installed successfully"

      - name: Verify x86 package versions
        if: matrix.arch == 'x86'
        shell: pwsh
        run: |
          Write-Host "[BUILD] Verifying x86-constrained packages..."
          $expectedVersions = @{
            'sqlalchemy' = '1.4.46'
            'greenlet' = '1.1.2'
            'pandas' = '1.5.3'
            'numpy' = '1.23.5'
            'scipy' = '1.8.1'
          }
          $allVerified = $true
          foreach ($pkg in $expectedVersions.Keys) {
            $expectedVersion = $expectedVersions[$pkg]
            $installedVersion = pip show $pkg 2>&1 | Select-String "Version:" | ForEach-Object { $_.Line -replace 'Version: ', '' }
            if (-not $installedVersion) {
              Write-Error "‚ùå Package '$pkg' not installed!"
              $allVerified = $false
              continue
            }
            $installedVersion = $installedVersion.Trim()
            $expectedVersion = $expectedVersion.Trim()
            if ($installedVersion -ne $expectedVersion) {
              Write-Error "‚ùå Package '$pkg' has wrong version: $installedVersion (expected $expectedVersion)"
              $allVerified = $false
            } else {
              Write-Host "‚úÖ $pkg==$installedVersion"
            }
          }
          if (-not $allVerified) {
            throw "[BUILD] ‚ùå x86 package verification failed"
          }
          Write-Host "[BUILD] ‚úÖ All x86 packages verified"
      - name: üî¨ Diagnostic - Verify wheel installation method
        shell: pwsh
        run: |
          Write-Host "[DIAGNOSTIC] Checking installation metadata for x86 packages..."

          $packages = @('sqlalchemy', 'greenlet')

          foreach ($pkg in $packages) {
            $location = pip show $pkg 2>&1 | Select-String "Location:" | ForEach-Object { $_.Line -replace 'Location: ', '' }

            if ($location) {
              $location = $location.Trim()
              Write-Host "Package: $pkg"
              Write-Host "  Location: $location"

              # Find the .dist-info directory
              $distInfo = Get-ChildItem -Path $location -Directory -Filter "${pkg}*.dist-info" -ErrorAction SilentlyContinue | Select-Object -First 1

              if ($distInfo) {
                Write-Host "  .dist-info: $($distInfo.Name)"

                # Check for WHEEL file (proves it was a wheel installation)
                $wheelFile = Join-Path $distInfo.FullName "WHEEL"
                if (Test-Path $wheelFile) {
                  $wheelContent = Get-Content $wheelFile -Raw
                  Write-Host "  ‚úÖ Installed from wheel (WHEEL file exists)"

                  # Extract wheel tag
                  if ($wheelContent -match "Tag: ([^\r\n]+)") {
                    Write-Host "  Wheel tag: $($Matches[1])"
                  }
                } else {
                  Write-Warning "  ‚ö†Ô∏è  No WHEEL file found - might be source install"
                }

                # Check for INSTALLER file
                $installerFile = Join-Path $distInfo.FullName "INSTALLER"
                if (Test-Path $installerFile) {
                  $installer = Get-Content $installerFile -Raw
                  Write-Host "  Installer: $installer"
                }
              } else {
                Write-Warning "  ‚ö†Ô∏è  No .dist-info directory found for $pkg"
              }

              Write-Host ""
            }
          }

      - name: Build Backend (PyInstaller)
        if: steps.cache-pyi-build.outputs.cache-hit != 'true'
        env:
          PYTHONUTF8: '1'
        run: |
          pyinstaller --noconfirm --clean --log-level INFO fortuna-unified.spec

      - uses: actions/upload-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: dist/fortuna-webservice/

  # 3. PREFLIGHT CHECK
  preflight-check:
    name: 'üîç Preflight Check'
    runs-on: windows-2022
    outputs:
      semver: ${{ steps.git_version.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
      - name: 'üè∑Ô∏è Derive SemVer'
        id: git_version
        shell: pwsh
        run: |
          $semver = "0.0.${{ github.run_number }}"
          Write-Host "Build Version: $semver"
          "semver=$semver" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append

  # 4. PACKAGE MSI
  package-msi:
    name: 'üíø Package MSI (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: [build-backend, preflight-check]
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backend-dist-${{ matrix.arch }}-${{ github.run_id }}
          path: staging/backend

      - name: Create Restart Service Batch Script
        shell: cmd
        run: |
          echo @echo off > staging\backend\restart_service.bat
          echo net stop FortunaWebService >> staging\backend\restart_service.bat
          echo net start FortunaWebService >> staging\backend\restart_service.bat

      - name: '‚öñÔ∏è The Dietician (Size Analysis)'
        shell: pwsh
        run: |
          $size = (Get-ChildItem staging -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "Total Payload: $([math]::Round($size, 2)) MB"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Prepare WiX Project
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $sourceDir = "staging/backend"
          $targetExe = "fortuna-webservice.exe"

          if (Test-Path (Join-Path $sourceDir "fortuna-webservice.exe")) {
              Write-Host "‚úÖ Found fortuna-webservice.exe, no rename needed."
          } else {
              Write-Host "##[error]Could not find fortuna-webservice.exe in the staging directory."
              Get-ChildItem -Path $sourceDir -Recurse
              exit 1
          }
          $proj = @(
            '<Project Sdk="WixToolset.Sdk/${{ env.WIX_VERSION }}">',
            '  <PropertyGroup>',
            '    <Version Condition="''$(Version)'' == ''''">0.0.1</Version>',
            '    <ServicePort Condition="''$(ServicePort)'' == ''''">8102</ServicePort>',
            '    <SourceDir Condition="''$(SourceDir)'' == ''''">staging/backend</SourceDir>',
            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',
            '    <OutputType>Package</OutputType>',
            '    <Platforms>x64;x86</Platforms>',
            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort);Platform=$(Platform)</DefineConstants>',
            '  </PropertyGroup>',
            '  <ItemGroup>',
            '    <PackageReference Include="WixToolset.UI.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Firewall.wixext" Version="${{ env.WIX_VERSION }}" />',
            '    <PackageReference Include="WixToolset.Util.wixext" Version="${{ env.WIX_VERSION }}" />',
            '  </ItemGroup>',
            '  <ItemGroup>',
            '    <Compile Include="Product_WebService.wxs" />',
            '  </ItemGroup>',
            '</Project>'
          )
          Set-Content "${{ env.WIX_DIR }}/Fortuna.wixproj" -Value ($proj -join "`r`n") -Encoding utf8

      - name: Build MSI
        working-directory: ${{ env.WIX_DIR }}
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=${{ matrix.arch }} -p:Version="${{ needs.preflight-check.outputs.semver }}" -p:SourceDir="../staging/backend" -p:ServicePort="${{ env.FORTUNA_PORT }}"

      - name: Rename & Hash
        run: |
          $releaseDir = "${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release"
          $msi = Get-ChildItem -Path $releaseDir -Filter "*.msi" | Select -First 1
          $target = "FortunaService-${{ matrix.arch }}-${{ needs.preflight-check.outputs.semver }}.msi"
          Move-Item $msi.FullName -Destination "$releaseDir/$target" -Force
          Write-Host "‚úÖ MSI Ready: $target"
          $hash = (Get-FileHash "$releaseDir/$target" -Algorithm SHA256).Hash
          Set-Content -Path "$releaseDir/$target.sha256" -Value $hash
          Write-Host "‚úÖ SHA-256: $hash"

      - uses: actions/upload-artifact@v4
        with:
          name: msi-${{ matrix.arch }}-${{ github.run_id }}
          path: |
            ${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release/*.msi
            ${{ env.WIX_DIR }}/bin/${{ matrix.arch }}/Release/*.sha256

  # 5. SMOKE TEST
  smoke-test:
    name: 'üî¨ Smoke Test (${{ matrix.arch }})'
    runs-on: windows-2022
    needs: [package-msi, preflight-check]
    continue-on-error: ${{ matrix.arch == 'x86' }}
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: msi-${{ matrix.arch }}-${{ github.run_id }}
          path: installer

      - name: Install MSI
        run: |
          $msi = Get-ChildItem installer/*.msi | Select -First 1
          Start-Process msiexec.exe -ArgumentList "/i `"$($msi.FullName)`" /qn /L*v install.log" -Wait

      - name: Verify Service & Port
        shell: pwsh
        run: |
          $progFiles = if ('${{ matrix.arch }}' -eq 'x86') { ${env:ProgramFiles(x86)} } else { ${env:ProgramFiles} }
          $installRoot = Join-Path $progFiles "Fortuna Faucet Service"

          if (-not (Test-Path $installRoot)) { throw "‚ùå Install dir not found at $installRoot" }

          Write-Host "Waiting for service..."
          Start-Sleep -Seconds 10

          Start-Service -Name "FortunaWebService" -ErrorAction SilentlyContinue

          $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing
          if ($response.StatusCode -eq 200) { Write-Host "‚úÖ Service Healthy" } else { throw "‚ùå Service Failed" }

      - name: 'üì∏ Paparazzi (Visual Proof)'
        continue-on-error: true
        run: |
          $url = "http://127.0.0.1:8000/docs"
          Write-Host "Waiting for URL: $url"
          $maxRetries = 10
          $delay = 3
          for ($i=1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ URL is accessible. Proceeding with screenshot."
                break
              }
            } catch {
              Write-Warning "Attempt ${i}: URL not accessible yet. Retrying in $delay seconds..."
              Start-Sleep -Seconds $delay
            }
            if ($i -eq $maxRetries) {
              throw "‚ùå URL did not become accessible after $maxRetries attempts."
            }
          }

          npm install playwright
          npx playwright install chromium --with-deps
          node -e "const { chromium } = require('playwright'); (async () => { const browser = await chromium.launch(); const page = await browser.newPage(); await page.goto('$url'); await page.screenshot({ path: 'proof.png' }); await browser.close(); })();"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: proof-${{ matrix.arch }}
          path: proof.png
