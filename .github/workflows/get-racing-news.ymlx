name: üì∞ Get Live Racing News

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  print-the-news:
    name: 'üñ®Ô∏è Printing Daily Form'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: üì¶ Install Backend
        shell: pwsh
        run: |
          pip install -r web_service/backend/requirements.txt
          pip install requests

      - name: üöÄ Start Backend, Fetch News, and Cleanup
        shell: pwsh
        env:
          PYTHONUTF8: '1'
          PYTHONIOENCODING: UTF-8
        run: |
          $env:PYTHONPATH = "."
          $backendProcess = $null
          try {
              # Start Backend
              Write-Host "üöÄ Starting backend server..."
              $backendProcess = Start-Process python -ArgumentList "-m", "uvicorn", "web_service.backend.main:app", "--host", "127.0.0.1", "--port", "8000" -NoNewWindow -PassThru
              Write-Host "Backend process started with PID: $($backendProcess.Id). Beginning health checks..."

              # Health Check
              $timeout = 60
              $startTime = Get-Date
              $healthy = $false
              while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
                  try {
                      $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing -TimeoutSec 2 -ErrorAction Stop
                      if ($response.StatusCode -eq 200) {
                          Write-Host "‚úÖ Backend is healthy!"
                          $healthy = $true
                          break
                      }
                  }
                  catch {
                      Write-Host "Waiting for backend..."
                  }
                  Start-Sleep -Seconds 2
              }

              if (-not $healthy) {
                  Write-Error "‚ùå Backend did not become healthy within $timeout seconds."
                  throw "Backend failed health check."
              }

              # Run News Reporter
              Write-Host "üóûÔ∏è Fetching & Printing News..."
              python scripts/news_reporter.py
              if ($LASTEXITCODE -ne 0) {
                  throw "News reporter script failed."
              }
          }
          finally {
              # Cleanup
              Write-Host "üßπ Cleaning up backend process..."
              if ($backendProcess -ne $null) {
                  try {
                      Stop-Process -Id $backendProcess.Id -Force -ErrorAction SilentlyContinue
                      Write-Host "Backend process (PID: $($backendProcess.Id)) stopped."
                  }
                  catch {
                      Write-Warning "Could not stop backend process. It might have already exited."
                  }
              } else {
                  # Fallback cleanup in case process handle was lost
                  Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
                  Write-Host "Fallback cleanup attempted."
              }
          }
