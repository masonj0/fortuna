name: üì∞ Get Live Racing News

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  print-the-news:
    name: 'üñ®Ô∏è Printing Daily Form'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: üì¶ Install Backend
        shell: pwsh
        run: |
          pip install -r web_service/backend/requirements.txt
          pip install requests

      - name: üöÄ Start and Health Check Backend Engine
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          $env:PYTHONPATH = "."
          Start-Process python -ArgumentList "-m", "uvicorn", "web_service.backend.main:app", "--host", "127.0.0.1", "--port", "8000" -NoNewWindow
          Write-Host "Backend process started. Beginning health checks..."

          $timeout = 30
          $startTime = Get-Date
          $healthy = $false

          while (((Get-Date) - $startTime).TotalSeconds -lt $timeout) {
              try {
                  $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing -TimeoutSec 2
                  if ($response.StatusCode -eq 200) {
                      Write-Host "‚úÖ Backend is healthy!"
                      $healthy = $true
                      break
                  }
              }
              catch {
                  Write-Host "Waiting for backend..."
              }
              Start-Sleep -Seconds 2
          }

          if (-not $healthy) {
              Write-Error "‚ùå Backend did not become healthy within $timeout seconds."
              exit 1
          }

      - name: üóûÔ∏è Fetch & Print News
        shell: pwsh
        env:
          PYTHONIOENCODING: UTF-8
        run: |
          python scripts/news_reporter.py

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          Get-Job | Stop-Job -ErrorAction SilentlyContinue
          Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
