name: üì∞ Get Live Racing News

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  print-the-news:
    name: 'üñ®Ô∏è Printing Daily Form'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'

      - name: üì¶ Install Backend
        shell: pwsh
        run: |
          pip install -r web_service/backend/requirements.txt
          pip install requests

      - name: üöÄ Start Backend Engine
        shell: pwsh
        env:
          PYTHONUTF8: '1'
        run: |
          $env:PYTHONPATH = "."
          $job = Start-Job -ScriptBlock {
              param($root)
              Set-Location $root
              python -m uvicorn web_service.backend.main:app --host 127.0.0.1 --port 8000
          } -ArgumentList $pwd

          Write-Host "Backend job started (Id: $($job.Id)). Warming up..."
          $job.Id | Out-File -FilePath "backend-job.txt"
          Start-Sleep -Seconds 5

      - name: üóûÔ∏è Fetch & Print News
        shell: pwsh
        env:
          API_KEY: ${{ secrets.API_KEY }}
          PYTHONIOENCODING: UTF-8
        run: |
          python scripts/news_reporter.py

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          Get-Job | Stop-Job -ErrorAction SilentlyContinue
          Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
