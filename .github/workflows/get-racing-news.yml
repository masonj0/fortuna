name: üì∞ Get Live Racing News

on:
  workflow_dispatch: # Click button to read news
  push:
    branches:
      - main

jobs:
  print-the-news:
    name: 'üñ®Ô∏è Printing Daily Form'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install Backend
        shell: pwsh
        run: |
          pip install -r web_service/backend/requirements.txt
          pip install requests # Needed for the reporter script

      - name: üöÄ Start Backend Engine
        shell: pwsh
        env:
          # MAP YOUR SECRETS HERE so the backend can fetch real odds
          # TVG_API_KEY: ${{ secrets.TVG_API_KEY }}
          # BETFAIR_USER: ${{ secrets.BETFAIR_USER }}
          PYTHONUTF8: '1'
        run: |
          $env:PYTHONPATH = "."
          # Start Uvicorn in background
          $job = Start-Job -ScriptBlock {
              param($root)
              Set-Location $root
              python -m uvicorn web_service.backend.main:app --port 8000
          } -ArgumentList $pwd

          Write-Host "Backend job started (Id: $($job.Id)). Warming up..."
          Start-Sleep -Seconds 10

      - name: üóûÔ∏è Fetch & Print News
        shell: pwsh
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          python scripts/news_reporter.py

      - name: üßπ Cleanup
        if: always()
        shell: pwsh
        run: |
          Get-Job | Stop-Job
          Get-Process -Name python -ErrorAction SilentlyContinue | Stop-Process -Force
