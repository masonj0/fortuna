name: Monolith Experimental (Webservice Mode)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==6.6.0
        pip install pywebview

    - name: Create required directories
      run: |
        New-Item -ItemType Directory -Force -Path "python_service/data"
        New-Item -ItemType Directory -Force -Path "python_service/json"
        New-Item -ItemType Directory -Force -Path "python_service/logs"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build frontend
      run: |
        cd web_platform/frontend
        npm ci
        npm run build
        Copy-Item -Path "out" -Destination "${{ github.workspace }}/frontend_dist" -Recurse -Force

    - name: Run PyInstaller
      run: pyinstaller --noconfirm fortuna-monolith.spec

    - name: Smoke Test
      env:
        FORTUNA_MODE: webservice
      run: |
        Start-Process -FilePath "dist/fortuna-monolith/fortuna-monolith.exe"
        Start-Sleep -Seconds 10
        try {
          $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing
          if ($response.StatusCode -eq 200) {
            Write-Host "Smoke test passed"
          } else {
            Write-Host "Smoke test failed with status code $($response.StatusCode)"
            $logPath = "$env:TEMP\fortuna-monolith.log"
            if (Test-Path $logPath) {
              Write-Host "--- LOG FILE CONTENTS ---"
              Get-Content $logPath
            }
            exit 1
          }
        } catch {
          Write-Host "Smoke test failed: $_"
            $logPath = "$env:TEMP\fortuna-monolith.log"
            if (Test-Path $logPath) {
              Write-Host "--- LOG FILE CONTENTS ---"
              Get-Content $logPath
            }
          exit 1
        } finally {
          Stop-Process -Name "fortuna-monolith" -Force
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fortuna-monolith
        path: dist/fortuna-monolith/fortuna-monolith.exe

    # ========== OPTIONAL VERIFICATION STEPS ==========
    - name: Run Verification Scripts
      shell: pwsh
      continue-on-error: true
      run: |
        pip install playwright
        playwright install
        $exePath = "dist/fortuna-monolith/fortuna-monolith.exe"
        $logFile = "monolith-verification-test.log"

        Write-Host "Starting monolith for verification tests..."
        $process = Start-Process -FilePath $exePath -PassThru -RedirectStandardOutput $logFile -RedirectStandardError $logFile -WindowStyle Hidden

        Write-Host "Waiting for application to initialize..."
        Start-Sleep -Seconds 15

        Write-Host "Running Playwright script..."
        python e2e/jules-smoke-test.py
        Write-Host "Playwright script finished."

        Write-Host "Running race info script..."
        python e2e/get-race-info.py
        Write-Host "Race info script finished."

        Stop-Process -Id $process.Id -Force
        Write-Host "Verification tests complete."

    - name: Upload Playwright Screenshot
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-screenshot-experimental
        path: playwright-screenshot.png
        retention-days: 7

    - name: Upload Race Info
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: race-info-experimental
        path: race-info.txt
        retention-days: 7
