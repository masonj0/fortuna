name: Monolith Experimental (Webservice Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller==6.6.0
        pip install pywebview

    - name: Create required directories
      run: |
        New-Item -ItemType Directory -Force -Path "python_service/data"
        New-Item -ItemType Directory -Force -Path "python_service/json"
        New-Item -ItemType Directory -Force -Path "python_service/logs"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Build frontend
      run: |
        cd web_service/frontend
        npm ci
        npm run build

    - name: Run PyInstaller
      run: pyinstaller --noconfirm fortuna-monolith.spec

    - name: Smoke Test
      env:
        FORTUNA_MODE: webservice
      run: |
        Start-Process -FilePath "dist/fortuna-monolith/fortuna-monolith.exe"
        Start-Sleep -Seconds 10
        try {
          $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/api/health" -UseBasicParsing
          if ($response.StatusCode -eq 200) {
            Write-Host "Smoke test passed"
          } else {
            Write-Host "Smoke test failed with status code $($response.StatusCode)"
            $logPath = "$env:TEMP\fortuna-monolith.log"
            if (Test-Path $logPath) {
              Write-Host "--- LOG FILE CONTENTS ---"
              Get-Content $logPath
            }
            exit 1
          }
        } catch {
          Write-Host "Smoke test failed: $_"
            $logPath = "$env:TEMP\fortuna-monolith.log"
            if (Test-Path $logPath) {
              Write-Host "--- LOG FILE CONTENTS ---"
              Get-Content $logPath
            }
          exit 1
        } finally {
          Stop-Process -Name "fortuna-monolith" -Force
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fortuna-monolith
        path: dist/fortuna-monolith.exe
