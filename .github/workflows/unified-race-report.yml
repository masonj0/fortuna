# unified-race-report.yml
name: 'Unified Race Report'

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all data (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      analyzer_type:
        description: 'Analyzer to use'
        required: false
        default: 'tiny_field_trifecta'
        type: choice
        options:
          - tiny_field_trifecta
          - value_bet
          - longshot_finder
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'web_service/backend/**'
      - '.github/workflows/unified-race-report.yml'
  schedule:
    # Run at 6 AM, 12 PM, and 6 PM UTC
    - cron: '0 6,12,18 * * *'

concurrency:
  group: race-report-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  REPORT_RETENTION_DAYS: 14
  MAX_RETRIES: 3
  REQUEST_TIMEOUT: 30

jobs:
  generate-unified-report:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # Increased from 20 for browser automation

    permissions:
      contents: read
      actions: write

    outputs:
      race_count: ${{ steps.run-reporter.outputs.race_count }}
      status: ${{ steps.run-reporter.outputs.status }}

    steps:
      - name: 'üì• Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'üêç Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'

      - name: üì¶ Install Dependencies & Browsers
        shell: bash
        run: |
          python -m pip install --upgrade pip wheel
          pip install -r web_service/backend/requirements.txt

          # Install Scrapling/Playwright browsers
          playwright install chromium

      - name: üß™ Verify Browser Installation (Fail Fast)
        run: |
          xvfb-run python - <<EOF
          import asyncio
          from scrapling.fetchers import StealthySession

          async def test():
              session = None
              try:
                  print('Attempting to launch headless browser...')
                  session = StealthySession(headless=True)
                  # The browser context is initialized lazily, so we need to
                  # perform an action to verify it. We'll fetch a dummy page.
                  await session.fetch('http://example.com')
                  if session.context:
                      print('‚úÖ Browser context initialized successfully')
                      return 0
                  else:
                      print('‚ùå Browser context is None')
                      return 1
              except Exception as e:
                  print(f'‚ùå Browser test failed: {e}')
                  return 1
              finally:
                  if session:
                      await session.close()

          if asyncio.run(test()) != 0:
              exit(1)
          EOF

      - name: 'üìÇ Create Runtime Directories'
        run: |
          mkdir -p web_service/backend/{data,json,logs}
          mkdir -p reports/archive

      - name: 'üîÑ Restore Data Cache'
        if: inputs.force_refresh != 'true'
        uses: actions/cache@v4
        with:
          path: |
            web_service/backend/data/*.cache
            web_service/backend/json/*.cache
          key: race-data-${{ runner.os }}-${{ github.run_number }}
          restore-keys: |
            race-data-${{ runner.os }}-

      - name: 'üöÄ Run Unified Reporter'
        id: run-reporter
        env:
          ANALYZER_TYPE: ${{ inputs.analyzer_type || 'tiny_field_trifecta' }}
          FORCE_REFRESH: ${{ inputs.force_refresh || 'false' }}
          MAX_RETRIES: ${{ env.MAX_RETRIES }}
          REQUEST_TIMEOUT: ${{ env.REQUEST_TIMEOUT }}
          # Browser automation needs display (for headless mode)
          DISPLAY: ':99'
          CI: 'true'
        run: |
          # Start virtual display for headless browser
          sudo Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          sleep 2

          set -o pipefail
          python scripts/fortuna_reporter.py 2>&1 | tee reporter_output.log

          # Extract metrics from the log for outputs
          if [ -f "qualified_races.json" ]; then
            RACE_COUNT=$(python scripts/get_race_count.py)
            echo "race_count=${RACE_COUNT}" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "race_count=0" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: 'üìä Upload Report Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-reports-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            race-report.html
            qualified_races.json
            raw_race_data.json
            reporter_output.log
            atr_debug.html
            sl_debug.html
            brisnet_debug.html
            equibase_debug.html
            oddschecker_debug.html
            racingpost_debug.html
            timeform_debug.html
            twinspires_debug.html
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}
          if-no-files-found: warn
          compression-level: 9

      - name: 'üìù Post Summary to GitHub Actions'
        if: always()
        run: |
          {
            echo "## üê¥ Fortuna Race Report Summary"
            echo ""
            echo "**Run:** #${{ github.run_number }} | **Status:** ${{ steps.run-reporter.outputs.status || 'unknown' }}"
            echo "**Analyzer:** ${{ inputs.analyzer_type || 'tiny_field_trifecta' }}"
            echo ""

            if [ -f "github_summary.md" ]; then
              cat github_summary.md
            else
              echo "### ‚ö†Ô∏è Detailed summary not available"
              echo ""
              echo "Check the artifacts for the full report."
            fi

            echo ""
            echo "---"
            echo "*Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
          } >> $GITHUB_STEP_SUMMARY

      - name: 'Install bs4 for HTML Analysis'
        if: failure()
        run: |
          pip install beautifulsoup4

      - name: 'Analyze HTML on Failure'
        if: failure()
        id: analyze-html
        run: |
          mkdir -p debug-analysis
          [ -f "sl_debug.html" ] && python scripts/debug_html_parser.py sl_debug.html debug-analysis/sl_analysis.json || echo "sl_debug.html not found, skipping analysis."
          [ -f "atr_debug.html" ] && python scripts/debug_html_parser.py atr_debug.html debug-analysis/atr_analysis.json "a[href^='/racecard/']" || echo "atr_debug.html not found, skipping analysis."
          [ -f "brisnet_debug.html" ] && python scripts/debug_html_parser.py brisnet_debug.html debug-analysis/brisnet_analysis.json || echo "brisnet_debug.html not found, skipping analysis."
          [ -f "equibase_debug.html" ] && python scripts/debug_html_parser.py equibase_debug.html debug-analysis/equibase_analysis.json || echo "equibase_debug.html not found, skipping analysis."
          [ -f "oddschecker_debug.html" ] && python scripts/debug_html_parser.py oddschecker_debug.html debug-analysis/oddschecker_analysis.json || echo "oddschecker_debug.html not found, skipping analysis."
          [ -f "racingpost_debug.html" ] && python scripts/debug_html_parser.py racingpost_debug.html debug-analysis/racingpost_analysis.json "a[href*='/racecards/']" || echo "racingpost_debug.html not found, skipping analysis."
          [ -f "timeform_debug.html" ] && python scripts/debug_html_parser.py timeform_debug.html debug-analysis/timeform_analysis.json || echo "timeform_debug.html not found, skipping analysis."
          [ -f "twinspires_debug.html" ] && python scripts/debug_html_parser.py twinspires_debug.html debug-analysis/twinspires_analysis.json "div[class*='race'], div[data-track]" || echo "twinspires_debug.html not found, skipping analysis."

      - name: 'Upload Debug Analysis Artifact'
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-analysis
          path: debug-analysis/
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}

      - name: 'üßπ Cleanup on Failure'
        if: failure()
        run: |
          echo "::warning::Report generation failed. Check logs for details."
          # Archive any partial data for debugging
          if ls *.json 1> /dev/null 2>&1; then
            tar -czf debug-data.tar.gz *.json *.log 2>/dev/null || true
          fi

  notify-on-failure:
    needs: generate-unified-report
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: 'üö® Create Failure Issue'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Scheduled Race Report Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Automated Report Failure

            The scheduled race report generation failed.

            **Run ID:** ${{ github.run_id }}
            **Run Number:** ${{ github.run_number }}
            **Workflow:** ${{ github.workflow }}

            [View Run Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            Please investigate and fix any issues.
            `;

            // Check for existing open issue with the same title
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated-failure',
              title: title
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated-failure', 'bug']
              });
            } else {
              console.log(`An open issue with the title "${title}" already exists. Skipping creation.`);
            }
