# .github/workflows/unified-race-report.yml
name: 'Unified Race Report'

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all data (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      # ===== FILTERING LOGIC COMMENTED OUT FOR FUTURE USE =====
      # Complex filtering strategies archived for potential future deployment
      # analyzer_type:
      #   description: 'Analyzer to use'
      #   required: false
      #   default: 'tiny_field_trifecta'
      #   type: choice
      #   options:
      #     - tiny_field_trifecta
      #     - value_bet
      #     - longshot_finder
      #     - all_analyzers
      # ========================================================
      analyzer_type:
        description: 'Analyzer to use (Simply Success - Count & Display Mode)'
        required: false
        default: 'simply_success'
        type: choice
        options:
          - simply_success
      debug_mode:
        description: 'Enable verbose debugging'
        required: false
        default: 'false'
        type: boolean
      run_mode:
        description: 'Execution mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - canary_only
          - canary_quick
          - skip_canary
          - dry_run
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'web_service/backend/**'
      - 'python_service/**'
      - '.github/workflows/unified-race-report.yml'

concurrency:
  group: race-report-${{ github.ref }}-${{ github.event_name == 'workflow_dispatch' && github.run_id || github.sha }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

env:
  PYTHON_VERSION: '3.10.12'
  REPORT_RETENTION_DAYS: 14
  MAX_RETRIES: 3
  REQUEST_TIMEOUT: 45
  SCRAPLING_HEADLESS: 'true'
  SCRAPLING_BLOCK_IMAGES: 'true'
  PLAYWRIGHT_BROWSERS_PATH: '/home/runner/.cache/ms-playwright'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_canary: ${{ steps.determine.outputs.run_canary }}
      run_full_report: ${{ steps.determine.outputs.run_full_report }}
      run_security: ${{ steps.determine.outputs.run_security }}
      matrix: ${{ steps.determine.outputs.matrix }}
    steps:
      - name: 'Determine execution mode'
        id: determine
        run: |
          RUN_CANARY="false"
          RUN_FULL="false"
          RUN_SECURITY="false"

          EVENT="${{ github.event_name }}"
          RUN_MODE="${{ inputs.run_mode }}"

          if [ "$EVENT" = "push" ]; then
            RUN_FULL="true"
            RUN_SECURITY="true"
          elif [ "$EVENT" = "workflow_dispatch" ]; then
            case "$RUN_MODE" in
              "canary_only") RUN_CANARY="true" ;;
              "canary_quick") RUN_CANARY="true" ;;
              "skip_canary") RUN_FULL="true" ;;
              "dry_run") RUN_CANARY="true"; RUN_FULL="true" ;;
              *) RUN_CANARY="true"; RUN_FULL="true" ;;
            esac
          fi

          # ===== ANALYZER MATRIX: SIMPLY SUCCESS MODE =====
          # Preserving old complex filtering logic in comments for future reference
          # ANALYZER="${{ inputs.analyzer_type || 'tiny_field_trifecta' }}"
          # if [ "$ANALYZER" = "all_analyzers" ]; then
          #   MATRIX='["tiny_field_trifecta", "value_bet", "longshot_finder"]'
          # else
          #   MATRIX="[\"$ANALYZER\"]"
          # fi
          # ==============================================
          ANALYZER="${{ inputs.analyzer_type || 'simply_success' }}"
          MATRIX="[\"$ANALYZER\"]"

          echo "run_canary=$RUN_CANARY" >> $GITHUB_OUTPUT
          echo "run_full_report=$RUN_FULL" >> $GITHUB_OUTPUT
          echo "run_security=$RUN_SECURITY" >> $GITHUB_OUTPUT
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  security-scan:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.run_security == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: 'Run Security Scans'
        run: |
          pip install pip-audit==2.7.3 safety==3.2.0 bandit==1.7.9
          pip-audit -r web_service/backend/requirements.txt --ignore-vuln PYSEC-2022-43012 || true
          safety check -r web_service/backend/requirements.txt --full-report || true
          bandit -r scripts/ web_service/ -f screen || true

  canary-check:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.run_canary == 'true'
    timeout-minutes: 15
    env:
      IS_QUICK: ${{ github.event.inputs.run_mode == 'canary_quick' }}
    outputs:
      health_status: ${{ steps.canary.outputs.health_status }}
      should_alert: ${{ steps.canary.outputs.should_alert }}
      success_rate: ${{ steps.canary.outputs.success_rate }}
    steps:
      - uses: actions/checkout@v4
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'
      - name: 'Cache Browsers'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.camoufox
          key: browsers-v1-${{ runner.os }}-${{ hashFiles('web_service/backend/requirements.txt') }}
          restore-keys: browsers-v1-${{ runner.os }}-
      - name: 'Install System Dependencies'
        if: env.IS_QUICK != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y x11-utils
      - name: 'Install Dependencies'
        run: |
          pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt
      - name: 'Install Browser (Minimal)'
        if: env.IS_QUICK != 'true'
        run: playwright install chromium --with-deps
      - name: 'Start Display'
        if: env.IS_QUICK != 'true'
        uses: ./.github/actions/setup-display
      - name: 'Canary Health Check'
        id: canary
        timeout-minutes: 12
        env:
          DISPLAY: ':99'
          PYTHONPATH: ${{ github.workspace }}
        run: python3 scripts/minimal_canary.py

  generate-unified-report:
    runs-on: ubuntu-latest
    needs: [setup, canary-check]
    if: always() && needs.setup.outputs.run_full_report == 'true'
    timeout-minutes: 100
    strategy:
      fail-fast: false
      matrix:
        analyzer: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'
      - name: 'Cache Browsers'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.camoufox
          key: browsers-v1-${{ runner.os }}-${{ hashFiles('web_service/backend/requirements.txt') }}
          restore-keys: browsers-v1-${{ runner.os }}-
      - name: 'Install System Dependencies'
        run: |
          sudo apt-get update
          sudo apt-get install -y x11-utils xvfb
      - name: 'Install Python Dependencies'
        run: |
          pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt
      - name: 'Setup Playwright'
        run: playwright install chromium --with-deps
      - name: 'Start X Display Server'
        uses: ./.github/actions/setup-display
      - name: 'Generate Report'
        id: reporter
        continue-on-error: true
        timeout-minutes: 80
        env:
          PYTHONPATH: ${{ github.workspace }}
          DISPLAY: ':99'
          ANALYZER_TYPE: ${{ matrix.analyzer }}
          DEBUG_MODE: ${{ inputs.debug_mode }}
          FORCE_REFRESH: ${{ inputs.force_refresh }}
        run: |
          python -u scripts/fortuna_reporter.py 2>&1 | tee reporter_output.log
          exit ${PIPESTATUS[0]}
      - name: 'Extract Success Spotlight'
        if: always()
        run: |
          python scripts/track_adapter_success.py || true
          if [ -f "adapter_success_spotlight.json" ]; then
            echo "Spotlight found"
            jq -r '"Successful: " + (.total_successful_adapters|tostring)' adapter_success_spotlight.json
            jq -r '"Races: " + (.total_races|tostring)' adapter_success_spotlight.json
          else
            echo "No spotlight, creating placeholder"
            TS=$(date -u +%Y-%m-%dT%H:%M:%SZ)
            echo "{\"timestamp\": \"$TS\", \"total_successful_adapters\": 0, \"total_races\": 0, \"adapters\": []}" > adapter_success_spotlight.json
          fi
      - name: 'Upload Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-reports-${{ matrix.analyzer }}-${{ github.run_number }}
          path: |
            adapter_success_spotlight.json
            adapter_success_spotlight.md
            race-report.html
            qualified_races.json
            link_healing_report.json
            raw_race_data.json
            reporter_output.log
            browser_verification.json
            metrics.json
            errors.json
            adapter_stats.json
            adapter_success_summary.json
            browser_selector_state.json
            anomaly_history.json
            canary_result.json
            report-metadata.json
            smartfetcher_health.json
            integration_check_report.md
            engine_health.log
            *_debug.html
            debug-output/
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}
          if-no-files-found: warn
          compression-level: 6
      - name: 'Generate Step Summary'
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          echo "## Simply Success Report" >> $GITHUB_STEP_SUMMARY
          echo "Mode: HTTP 200 Celebration" >> $GITHUB_STEP_SUMMARY
          if [ -f "adapter_success_spotlight.json" ]; then
            RACES=$(jq -r '.total_races' adapter_success_spotlight.json)
            ADAPTERS=$(jq -r '.total_successful_adapters' adapter_success_spotlight.json)
            echo "- Success: $ADAPTERS adapters" >> $GITHUB_STEP_SUMMARY
            echo "- Races: $RACES" >> $GITHUB_STEP_SUMMARY
          fi

  validate-results:
    needs: [setup, generate-unified-report]
    runs-on: ubuntu-latest
    if: always() && needs.generate-unified-report.result != 'skipped'
    strategy:
      fail-fast: false
      matrix:
        analyzer: ${{ fromJson(needs.setup.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: 'Download Results'
        uses: actions/download-artifact@v4
        with:
          name: race-reports-${{ matrix.analyzer }}-${{ github.run_number }}
      - name: 'Validate Artifacts'
        run: |
          [ -f "adapter_success_spotlight.json" ] && echo "Spotlight OK" || echo "Spotlight Missing"
          [ -f "qualified_races.json" ] && echo "Races OK" || echo "Races Missing"
          exit 0

  cleanup:
    needs: [setup, security-scan, generate-unified-report, validate-results]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 'Cleanup'
        run: |
          sudo pkill -9 Xvfb || true
          echo "Cleanup complete"

  notify:
    needs: [setup, generate-unified-report, canary-check, validate-results]
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    if: |
      always() &&
      needs.canary-check.result == 'success' &&
      needs.canary-check.outputs.should_alert == 'true'
    steps:
      - name: 'Create Alert'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const canaryHealth = '${{ needs.canary-check.outputs.health_status }}';
            if (canaryHealth !== 'unhealthy') return;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ CANARY ALERT: Race Pipeline - ${today}`,
              body: `Canary health is unhealthy. Run #${{ github.run_number }}`,
              labels: ['automated', 'pipeline-alert']
            });
