# .github/workflows/unified-race-report.yml
name: 'Unified Race Report'

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all data (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      analyzer_type:
        description: 'Analyzer to use'
        required: false
        default: 'tiny_field_trifecta'
        type: choice
        options:
          - tiny_field_trifecta
          - value_bet
          - longshot_finder
      debug_mode:
        description: 'Enable verbose debugging'
        required: false
        default: 'false'
        type: boolean
      canary_only:
        description: 'Run canary check only (no full report)'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'web_service/backend/**'
      - 'python_service/**'
      - '.github/workflows/unified-race-report.yml'
  schedule:
    # Full report runs
    - cron: '0 6,12,18 * * *'
    # Canary runs (more frequent)
    - cron: '30 */2 * * *'

concurrency:
  group: race-report-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  REPORT_RETENTION_DAYS: 14
  MAX_RETRIES: 3
  REQUEST_TIMEOUT: 45
  SCRAPLING_HEADLESS: 'true'
  SCRAPLING_BLOCK_IMAGES: 'true'
  PLAYWRIGHT_BROWSERS_PATH: '/home/runner/.cache/ms-playwright'
  ENABLE_METRICS: 'true'
  ENABLE_ANOMALY_DETECTION: 'true'

jobs:
  # Security scan for dependencies
  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 'Run pip-audit'
        run: |
          pip install pip-audit safety
          pip-audit -r web_service/backend/requirements.txt --ignore-vuln PYSEC-2022-43012 || true
          safety check -r web_service/backend/requirements.txt --full-report || true

  # Canary job - lightweight check
  canary-check:
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 */2 * * *' || inputs.canary_only == 'true'
    timeout-minutes: 15

    outputs:
      health_status: ${{ steps.canary.outputs.health_status }}
      should_alert: ${{ steps.canary.outputs.should_alert }}

    steps:
      - uses: actions/checkout@v4

      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'

      - name: 'Install Dependencies'
        run: |
          pip install -r web_service/backend/requirements.txt
          pip install "scrapling[all]"

      - name: 'Install Browsers (Minimal)'
        run: |
          playwright install chromium --with-deps

      - name: 'Run Canary Check'
        id: canary
        run: |
          python scripts/canary_check.py 2>&1 | tee canary_output.log

          if [ -f canary_result.json ]; then
            HEALTH=$(python -c "import json; print(json.load(open('canary_result.json'))['status'])")
            echo "health_status=$HEALTH" >> $GITHUB_OUTPUT

            if [ "$HEALTH" = "unhealthy" ]; then
              echo "should_alert=true" >> $GITHUB_OUTPUT
            else
              echo "should_alert=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: 'Upload Canary Results'
        uses: actions/upload-artifact@v4
        with:
          name: canary-results-${{ github.run_number }}
          path: |
            canary_result.json
            canary_output.log
          retention-days: 3

  # Main report generation
  generate-unified-report:
    runs-on: ubuntu-latest
    if: github.event.schedule != '30 */2 * * *' && inputs.canary_only != 'true'
    timeout-minutes: 45
    needs: [canary-check]
    # Only run if canary passed or canary didn't run
    if: always() && (needs.canary-check.result == 'skipped' || needs.canary-check.outputs.health_status != 'unhealthy') && github.event.schedule != '30 */2 * * *' && inputs.canary_only != 'true'

    permissions:
      contents: read
      actions: write

    outputs:
      race_count: ${{ steps.run-reporter.outputs.race_count }}
      status: ${{ steps.run-reporter.outputs.status }}
      metrics_summary: ${{ steps.run-reporter.outputs.metrics_summary }}

    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'ðŸ Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'

      - name: 'ðŸ–¥ï¸ Install System Dependencies'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb xauth libx11-xcb1 libxcb1 libxcomposite1 \
            libxcursor1 libxdamage1 libxext6 libxfixes3 \
            libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
            libglib2.0-0 libnss3 libnspr4 libatk1.0-0 \
            libatk-bridge2.0-0 libcups2 libdrm2 libdbus-1-3 \
            libxkbcommon0 libatspi2.0-0 libgbm1 libasound2

      - name: 'ðŸ“¦ Install Python Dependencies'
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r web_service/backend/requirements.txt
          pip install "scrapling[all]" jsonschema pip-audit

      - name: 'ðŸ¦Š Install Browsers'
        id: install-browsers
        run: |
          # Try Camoufox first
          if python -m camoufox fetch 2>/dev/null; then
            echo "camoufox_available=true" >> $GITHUB_OUTPUT
          else
            echo "camoufox_available=false" >> $GITHUB_OUTPUT
          fi

          # Install Playwright browsers
          playwright install chromium --with-deps
          playwright install firefox

          echo "browsers_ready=true" >> $GITHUB_OUTPUT

      - name: 'ðŸ–¥ï¸ Start Virtual Display'
        run: |
          sudo Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 3

      - name: 'ðŸ”„ Restore State Cache'
        uses: actions/cache@v4
        with:
          path: |
            browser_selector_state.json
            anomaly_history.json
            web_service/backend/cache/
          key: state-${{ runner.os }}-${{ github.run_number }}
          restore-keys: |
            state-${{ runner.os }}-

      - name: 'ðŸš€ Run Unified Reporter'
        id: run-reporter
        env:
          ANALYZER_TYPE: ${{ inputs.analyzer_type || 'tiny_field_trifecta' }}
          FORCE_REFRESH: ${{ inputs.force_refresh || 'false' }}
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          MAX_RETRIES: ${{ env.MAX_RETRIES }}
          REQUEST_TIMEOUT: ${{ env.REQUEST_TIMEOUT }}
          CAMOUFOX_AVAILABLE: ${{ steps.install-browsers.outputs.camoufox_available }}
          CI: 'true'
        run: |
          set -o pipefail

          python scripts/fortuna_reporter.py 2>&1 | tee reporter_output.log
          EXIT_CODE=${PIPESTATUS[0]}

          # Extract results
          if [ -f "qualified_races.json" ]; then
            RACE_COUNT=$(python -c "import json; d=json.load(open('qualified_races.json')); print(len(d.get('races', [])))")
            echo "race_count=${RACE_COUNT}" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "race_count=0" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

          # Include metrics summary
          if [ -f "metrics.json" ]; then
            METRICS_SUMMARY=$(python -c "import json; print(json.dumps(json.load(open('metrics.json'))))")
            echo "metrics_summary=${METRICS_SUMMARY}" >> $GITHUB_OUTPUT
          fi

          exit $EXIT_CODE

      - name: 'âœ… Validate Output Schema'
        if: success()
        run: |
          python - <<'PYTHON_SCRIPT'
          import json
          import sys
          from python_service.validation.validator import SchemaValidator

          validator = SchemaValidator()

          files_to_validate = [
              ("qualified_races.json", "qualified_races"),
              ("raw_race_data.json", "raw_race_data"),
          ]

          all_valid = True
          for file_path, schema_name in files_to_validate:
              try:
                  with open(file_path) as f:
                      data = json.load(f)
                  result = validator.validate(data, schema_name)

                  print(f"\n{'='*60}")
                  print(f"Validation: {file_path}")
                  print(f"{'='*60}")
                  print(f"Valid: {result.valid}")
                  print(f"Errors: {len(result.errors)}")
                  print(f"Warnings: {len(result.warnings)}")

                  for error in result.errors[:5]:
                      print(f"  âŒ {error}")
                  for warning in result.warnings[:3]:
                      print(f"  âš ï¸ {warning}")

                  if not result.valid:
                      all_valid = False

              except FileNotFoundError:
                  print(f"âš ï¸ {file_path} not found, skipping validation")

          if not all_valid:
              print("\nâŒ Validation failed!")
              sys.exit(1)
          else:
              print("\nâœ… All validations passed!")
          PYTHON_SCRIPT

      - name: 'ðŸ“Š Upload Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-reports-${{ github.run_number }}
          path: |
            race-report.html
            qualified_races.json
            raw_race_data.json
            reporter_output.log
            metrics.json
            errors.json
            browser_selector_state.json
            anomaly_history.json
            *_debug.html
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}
          compression-level: 9

      - name: 'ðŸ“ Generate Summary'
        if: always()
        run: |
          python scripts/generate_summary.py >> $GITHUB_STEP_SUMMARY

  # Notification job
  notify:
    needs: [generate-unified-report, canary-check]
    runs-on: ubuntu-latest
    if: always() && (failure() || needs.canary-check.outputs.should_alert == 'true')

    steps:
      - name: 'ðŸš¨ Create/Update Issue'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ Race Pipeline Alert - ${new Date().toISOString().split('T')[0]}`;

            let body = `## Pipeline Alert\n\n`;
            body += `**Run:** #${{ github.run_number }}\n`;
            body += `**Trigger:** ${{ github.event_name }}\n\n`;

            const reportStatus = '${{ needs.generate-unified-report.outputs.status }}';
            const canaryHealth = '${{ needs.canary-check.outputs.health_status }}';

            if (reportStatus === 'failed') {
              body += `### âŒ Report Generation Failed\n`;
              body += `Check the [run logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
            }

            if (canaryHealth === 'unhealthy') {
              body += `### âš ï¸ Canary Health Check Failed\n`;
              body += `Upstream data sources may be unavailable or changed.\n\n`;
            }

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pipeline-alert'
            });

            if (issues.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['pipeline-alert', 'automated']
              });
            }
