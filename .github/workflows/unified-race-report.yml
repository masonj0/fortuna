# .github/workflows/unified-race-report.yml
name: 'Unified Race Report'

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh all data (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      analyzer_type:
        description: 'Analyzer to use'
        required: false
        default: 'tiny_field_trifecta'
        type: choice
        options:
          - tiny_field_trifecta
          - value_bet
          - longshot_finder
          - all_analyzers
      debug_mode:
        description: 'Enable verbose debugging'
        required: false
        default: 'false'
        type: boolean
      run_mode:
        description: 'Execution mode'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - canary_only
          - skip_canary
          - dry_run
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'web_service/backend/**'
      - 'python_service/**'
      - '.github/workflows/unified-race-report.yml'
  schedule:
    # Full report runs at 6am, 12pm, 6pm UTC
    - cron: '0 6,12,18 * * *'
    # Canary runs every 2 hours at :30
    - cron: '30 */2 * * *'

concurrency:
  group: race-report-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

env:
  PYTHON_VERSION: '3.10.12'
  REPORT_RETENTION_DAYS: 14
  MAX_RETRIES: 3
  REQUEST_TIMEOUT: 45
  SCRAPLING_HEADLESS: 'true'
  SCRAPLING_BLOCK_IMAGES: 'true'
  PLAYWRIGHT_BROWSERS_PATH: '/home/runner/.cache/ms-playwright'

jobs:
  # Determine what to run based on trigger
  setup:
    runs-on: ubuntu-latest
    outputs:
      run_canary: ${{ steps.determine.outputs.run_canary }}
      run_full_report: ${{ steps.determine.outputs.run_full_report }}
      run_security: ${{ steps.determine.outputs.run_security }}
      matrix: ${{ steps.determine.outputs.matrix }}
    steps:
      - name: 'Determine execution mode'
        id: determine
        run: |
          # Default values
          RUN_CANARY="false"
          RUN_FULL="false"
          RUN_SECURITY="false"

          EVENT="${{ github.event_name }}"
          SCHEDULE="${{ github.event.schedule }}"
          RUN_MODE="${{ inputs.run_mode }}"

          echo "Event: $EVENT"
          echo "Schedule: $SCHEDULE"
          echo "Run Mode: $RUN_MODE"

          if [ "$EVENT" = "schedule" ]; then
            if [ "$SCHEDULE" = "30 */2 * * *" ]; then
              # Canary schedule
              RUN_CANARY="true"
            else
              # Full report schedule
              RUN_FULL="true"
            fi
          elif [ "$EVENT" = "push" ]; then
            RUN_FULL="true"
            RUN_SECURITY="true"
          elif [ "$EVENT" = "workflow_dispatch" ]; then
            case "$RUN_MODE" in
              "canary_only")
                RUN_CANARY="true"
                ;;
              "skip_canary")
                RUN_FULL="true"
                ;;
              "dry_run")
                RUN_CANARY="true"
                # For dry_run, we might still run the full report but with a flag
                RUN_FULL="true"
                ;;
              *)
                # "full" - run both
                RUN_CANARY="true"
                RUN_FULL="true"
                ;;
            esac
          fi

          # Determine Analyzer Matrix
          ANALYZER="${{ inputs.analyzer_type || 'tiny_field_trifecta' }}"
          if [ "$ANALYZER" = "all_analyzers" ]; then
            MATRIX='["tiny_field_trifecta", "value_bet", "longshot_finder"]'
          else
            MATRIX="[\"$ANALYZER\"]"
          fi

          echo "run_canary=$RUN_CANARY" >> $GITHUB_OUTPUT
          echo "run_full_report=$RUN_FULL" >> $GITHUB_OUTPUT
          echo "run_security=$RUN_SECURITY" >> $GITHUB_OUTPUT
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

          echo "=== Execution Plan ==="
          echo "Will run canary: $RUN_CANARY"
          echo "Will run full report: $RUN_FULL"
          echo "Will run security scan: $RUN_SECURITY"
          echo "Analyzer matrix: $MATRIX"

  # Security scan for dependencies
  security-scan:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.run_security == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 'Run Security Scans'
        run: |
          pip install pip-audit safety bandit

          echo "=== pip-audit ==="
          pip-audit -r web_service/backend/requirements.txt \
            --ignore-vuln PYSEC-2022-43012 \
            || echo "pip-audit found issues (non-blocking)"

          echo ""
          echo "=== safety ==="
          safety check -r web_service/backend/requirements.txt --full-report \
            || echo "safety found issues (non-blocking)"

          echo ""
          echo "=== bandit ==="
          bandit -r scripts/ web_service/ -f screen || echo "bandit found issues (non-blocking)"

  # Canary job - lightweight health check
  canary-check:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.run_canary == 'true'
    timeout-minutes: 15

    outputs:
      health_status: ${{ steps.canary.outputs.health_status }}
      should_alert: ${{ steps.canary.outputs.should_alert }}
      success_rate: ${{ steps.canary.outputs.success_rate }}

    steps:
      - uses: actions/checkout@v4

      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'

      - name: 'ðŸ”„ Cache Browsers'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.camoufox
          key: browsers-canary-${{ runner.os }}-${{ hashFiles('web_service/backend/requirements.txt') }}
          restore-keys: |
            browsers-canary-${{ runner.os }}-
            browsers-${{ runner.os }}-

      - name: 'Install Dependencies'
        run: |
          pip install --upgrade pip
          pip install -r web_service/backend/requirements.txt

      - name: 'Install Browser (Minimal)'
        run: |
          playwright install chromium --with-deps

      - name: 'Start Display'
        run: |
          sudo Xvfb :99 -screen 0 1280x720x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      - name: 'Run Canary Check'
        id: canary
        timeout-minutes: 10
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/canary_check.py 2>&1 | tee canary_output.log

          if [ -f canary_result.json ]; then
            HEALTH=$(jq -r '.status // "unknown"' canary_result.json)
            RATE=$(jq -r '.success_rate // "0%"' canary_result.json)

            echo "health_status=$HEALTH" >> $GITHUB_OUTPUT
            echo "success_rate=$RATE" >> $GITHUB_OUTPUT

            if [ "$HEALTH" = "unhealthy" ]; then
              echo "should_alert=true" >> $GITHUB_OUTPUT
            else
              echo "should_alert=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "health_status=unknown" >> $GITHUB_OUTPUT
            echo "should_alert=false" >> $GITHUB_OUTPUT
            echo "success_rate=N/A" >> $GITHUB_OUTPUT
          fi

          # Don't fail the job on canary issues - just report
          exit 0

      - name: 'Upload Canary Results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: canary-results-${{ github.run_number }}
          path: |
            canary_result.json
            canary_output.log
            *_debug.html
          retention-days: 3
          if-no-files-found: ignore

  # Main report generation
  generate-unified-report:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [setup, canary-check]

    strategy:
      fail-fast: false
      matrix:
        analyzer: ${{ fromJson(needs.setup.outputs.matrix) }}

    # Resource hints for GitHub runners
    # Note: 'resources' is not a standard top-level job key in standard GHA,
    # but some enterprise/self-hosted runners use it. For standard runners
    # we just use ubuntu-latest.
    # Run if: full report requested AND (canary passed OR canary was skipped OR canary status is not unhealthy)
    if: |
      always() &&
      needs.setup.outputs.run_full_report == 'true' &&
      (needs.canary-check.result == 'skipped' ||
       needs.canary-check.outputs.health_status != 'unhealthy')

    permissions:
      contents: read
      actions: write

    outputs:
      race_count: ${{ steps.run-reporter.outputs.race_count }}
      status: ${{ steps.run-reporter.outputs.status }}
      adapters_succeeded: ${{ steps.run-reporter.outputs.adapters_succeeded }}
      adapters_failed: ${{ steps.run-reporter.outputs.adapters_failed }}

    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 'ðŸ Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'web_service/backend/requirements.txt'

      - name: 'ðŸ”„ Cache Browsers'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.camoufox
          key: browsers-${{ runner.os }}-${{ hashFiles('web_service/backend/requirements.txt') }}
          restore-keys: |
            browsers-${{ runner.os }}-

      - name: 'ðŸ–¥ï¸ Install System Dependencies'
        run: |
          sudo apt-get update

          # Install all required dependencies for headless browsers
          sudo apt-get install -y --no-install-recommends \
            xvfb \
            xauth \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            libglib2.0-0 \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libgbm1 \
            fonts-liberation \
            fonts-noto-color-emoji

          # Handle libasound2 vs libasound2t64 (Ubuntu 22.04 vs 24.04)
          if apt-cache show libasound2t64 >/dev/null 2>&1; then
            sudo apt-get install -y libasound2t64
          else
            sudo apt-get install -y libasound2
          fi

      - name: 'ðŸ“¦ Install Python Dependencies'
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r web_service/backend/requirements.txt

      - name: 'ðŸ¦Š Install Browsers'
        id: install-browsers
        run: |
          set +e  # Don't exit on individual failures

          echo "=== Installing Camoufox (Firefox-based) ==="
          if python -m camoufox fetch 2>&1; then
            echo "camoufox_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Camoufox installed"
          else
            echo "camoufox_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Camoufox not available, will use Playwright fallback"
          fi

          echo ""
          echo "=== Installing Playwright Chromium ==="
          if playwright install chromium --with-deps 2>&1; then
            echo "chromium_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Chromium installed"
          else
            echo "chromium_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Chromium not available"
          fi

          echo ""
          echo "=== Installing Playwright Firefox ==="
          if playwright install firefox 2>&1; then
            echo "firefox_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Firefox installed"
          else
            echo "firefox_available=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Firefox not available"
          fi

          echo ""
          echo "=== Browser Summary ==="
          echo "browsers_ready=true" >> $GITHUB_OUTPUT

      - name: 'ðŸ–¥ï¸ Start Virtual Display'
        run: |
          # Kill any existing Xvfb
          sudo pkill -9 Xvfb || true
          sleep 1

          # Start fresh Xvfb
          sudo Xvfb :99 -screen 0 1920x1080x24 -ac +extension GLX +render -noreset &
          echo "DISPLAY=:99" >> $GITHUB_ENV

          # Wait and verify
          sleep 3
          for i in {1..5}; do
            if xdpyinfo -display :99 >/dev/null 2>&1; then
              echo "âœ… Display :99 ready"
              break
            fi
            echo "Waiting for display (attempt $i)..."
            sleep 1
          done

      - name: 'ðŸ§ª Verify Browser Setup'
        id: verify-browser
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/verify_browsers.py 2>&1 | tee browser_verify.log
          RESULT=$?

          if [ $RESULT -eq 0 ]; then
            echo "browser_verified=true" >> $GITHUB_OUTPUT
            echo "âœ… Browser verification passed"
          else
            echo "browser_verified=false" >> $GITHUB_OUTPUT
            echo "::warning::Browser verification had issues, continuing anyway..."
          fi

      - name: 'ðŸ“‚ Setup Directories'
        run: |
          mkdir -p web_service/backend/{data,json,logs,cache}
          mkdir -p reports/archive
          mkdir -p debug-output

      - name: 'ðŸ”„ Restore State Cache'
        uses: actions/cache@v4
        with:
          path: |
            browser_selector_state.json
            anomaly_history.json
            adapter_stats.json
            web_service/backend/cache/
          # Deduplicated cache key based on force_refresh
          key: state-${{ runner.os }}-${{ inputs.force_refresh || 'false' }}-${{ github.run_number }}
          restore-keys: |
            state-${{ runner.os }}-${{ inputs.force_refresh || 'false' }}-
            state-${{ runner.os }}-

      - name: 'ðŸš€ Run Unified Reporter'
        id: run-reporter
        timeout-minutes: 35
        env:
          PYTHONPATH: ${{ github.workspace }}
          ANALYZER_TYPE: ${{ matrix.analyzer }}
          FORCE_REFRESH: ${{ inputs.force_refresh || 'false' }}
          DEBUG_MODE: ${{ inputs.debug_mode || 'false' }}
          RUN_MODE: ${{ inputs.run_mode || 'full' }}
          CANARY_HEALTH: ${{ needs.canary-check.outputs.health_status }}
          MAX_RETRIES: ${{ env.MAX_RETRIES }}
          REQUEST_TIMEOUT: ${{ env.REQUEST_TIMEOUT }}
          CAMOUFOX_AVAILABLE: ${{ steps.install-browsers.outputs.camoufox_available }}
          CHROMIUM_AVAILABLE: ${{ steps.install-browsers.outputs.chromium_available }}
          FIREFOX_AVAILABLE: ${{ steps.install-browsers.outputs.firefox_available }}
          CI: 'true'
        run: |
          set -o pipefail

          echo "=== Configuration ==="
          echo "Analyzer: $ANALYZER_TYPE"
          echo "Force Refresh: $FORCE_REFRESH"
          echo "Debug Mode: $DEBUG_MODE"
          echo "Run Mode: $RUN_MODE"
          echo "Canary Health: $CANARY_HEALTH"
          echo ""

          # Use retry wrapper for job-level resilience
          bash scripts/retry_with_backoff.sh python scripts/fortuna_reporter.py 2>&1 | tee reporter_output.log
          EXIT_CODE=${PIPESTATUS[0]}

          # Extract results
          if [ -f "qualified_races.json" ]; then
            RACE_COUNT=$(jq '.races | length' qualified_races.json 2>/dev/null || echo "0")
            echo "race_count=${RACE_COUNT}" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Generated report with ${RACE_COUNT} qualified races"
          elif [ -f "raw_race_data.json" ]; then
            RACE_COUNT=$(jq '.races | length' raw_race_data.json 2>/dev/null || echo "0")
            echo "race_count=${RACE_COUNT}" >> $GITHUB_OUTPUT
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "âš ï¸ Partial data: ${RACE_COUNT} races in raw data"
          else
            echo "race_count=0" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ No race data generated"
          fi

          # Extract adapter stats if available
          if [ -f "adapter_stats.json" ]; then
            # adapter_stats.json is a list of statuses, we need to count them
            SUCCEEDED=$(jq '[.[] | select(.status == "OK")] | length' adapter_stats.json 2>/dev/null || echo "0")
            FAILED=$(jq '[.[] | select(.status != "OK")] | length' adapter_stats.json 2>/dev/null || echo "0")
            echo "adapters_succeeded=${SUCCEEDED}" >> $GITHUB_OUTPUT
            echo "adapters_failed=${FAILED}" >> $GITHUB_OUTPUT
          fi

          exit $EXIT_CODE

      - name: 'ðŸ“Š Upload Artifacts'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: race-reports-${{ matrix.analyzer }}-${{ github.run_number }}
          path: |
            race-report.html
            qualified_races.json
            raw_race_data.json
            reporter_output.log
            browser_verify.log
            browser_verification.json
            metrics.json
            errors.json
            adapter_stats.json
            browser_selector_state.json
            anomaly_history.json
            canary_result.json
            report-metadata.json
            *_debug.html
            debug-output/
          retention-days: ${{ env.REPORT_RETENTION_DAYS }}
          if-no-files-found: warn
          compression-level: 9

      - name: 'ðŸ“ Generate Summary'
        if: always()
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/generate_summary.py >> $GITHUB_STEP_SUMMARY

  # Dedicated validation stage
  validate-results:
    needs: [setup, generate-unified-report]
    runs-on: ubuntu-latest
    if: always() && needs.generate-unified-report.result != 'skipped'

    strategy:
      fail-fast: false
      matrix:
        analyzer: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
      - name: 'Setup Python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: 'Download Results'
        uses: actions/download-artifact@v4
        with:
          name: race-reports-${{ matrix.analyzer }}-${{ github.run_number }}
      - name: 'âœ… Schema & Quality Validation'
        timeout-minutes: 5
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python scripts/validate_output.py

  # Workflow run cleanup
  cleanup:
    needs: [generate-unified-report, validate-results]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 'ðŸ§¹ System Cleanup'
        run: |
          sudo pkill -9 Xvfb || true
          df -h | grep '^/dev/'
          echo "Cleanup complete"

  # Notification job
  notify:
    needs: [setup, generate-unified-report, canary-check, validate-results]
    runs-on: ubuntu-latest
    if: |
      always() && (
        needs.generate-unified-report.result == 'failure' ||
        needs.validate-results.result == 'failure' ||
        needs.canary-check.outputs.should_alert == 'true'
      )

    steps:
      - name: 'ðŸš¨ Create/Update Issue'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];

            const isCritical = '${{ needs.generate-unified-report.result }}' === 'failure' ||
                               '${{ needs.validate-results.result }}' === 'failure';

            const title = `${isCritical ? 'ðŸš¨ CRITICAL' : 'âš ï¸ WARNING'}: Race Pipeline Alert - ${today}`;
            const label = isCritical ? 'pipeline-alert:high' : 'pipeline-alert:low';

            let body = `## Pipeline Alert (${isCritical ? 'CRITICAL' : 'WARNING'})\n\n`;
            body += `| Property | Value |\n`;
            body += `|----------|-------|\n`;
            body += `| Run | #${{ github.run_number }} |\n`;
            body += `| Trigger | ${{ github.event_name }} |\n`;
            body += `| Time | ${new Date().toISOString()} |\n\n`;

            const reportResult = '${{ needs.generate-unified-report.result }}';
            const reportStatus = '${{ needs.generate-unified-report.outputs.status }}';
            const raceCount = '${{ needs.generate-unified-report.outputs.race_count }}';
            const canaryHealth = '${{ needs.canary-check.outputs.health_status }}';
            const canaryRate = '${{ needs.canary-check.outputs.success_rate }}';

            if (reportResult === 'failure' || reportStatus === 'failed') {
              body += `### âŒ Report Generation Failed\n\n`;
              body += `The main report generation job failed.\n\n`;
              body += `| Metric | Value |\n`;
              body += `|--------|-------|\n`;
              body += `| Races Found | ${raceCount || '0'} |\n`;
              body += `| Adapters Succeeded | ${{ needs.generate-unified-report.outputs.adapters_succeeded || 'N/A' }} |\n`;
              body += `| Adapters Failed | ${{ needs.generate-unified-report.outputs.adapters_failed || 'N/A' }} |\n\n`;
            }

            if (canaryHealth === 'unhealthy') {
              body += `### âš ï¸ Canary Health Check: UNHEALTHY\n\n`;
              body += `**Success Rate:** ${canaryRate}\n\n`;
              body += `Upstream data sources may be unavailable or have changed structure.\n\n`;
            }

            body += `### ðŸ”— Links\n\n`;
            body += `- [View Run Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            body += `- [Download Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n`;

            // Check for existing open alert
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pipeline-alert',
              per_page: 5
            });

            const existingIssue = issues.find(i => i.title.includes('Race Pipeline Alert'));

            if (existingIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Alert - Run #${{ github.run_number }}\n\n${body}`
              });

              // Update labels if needed
              if (isCritical) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: existingIssue.number,
                    labels: [label]
                  });
              }
              console.log(`Added comment to issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', label]
              });
              console.log('Created new alert issue');
            }
