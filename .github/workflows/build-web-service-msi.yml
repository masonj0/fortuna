name: Build Fortuna Faucet MSI (WiX v4) - üèÜ PRODUCTION

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # JOB 1: BUILD FRONTEND
  # ============================================================================
  build-frontend:
    name: 'üì¶ Build Frontend'
    timeout-minutes: 15
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci --verbose
          npm audit --audit-level=moderate
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          $outDir = 'web_platform/frontend/out'
          if (-not (Test-Path $outDir)) { throw "‚ùå FATAL: Build output directory 'out' not created" }
          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) { throw "‚ùå FATAL: Build output directory is empty" }
          Write-Host "‚úÖ Frontend build verified ($fileCount files)" -ForegroundColor Green
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: web_platform/frontend/out
          retention-days: 1

  # ============================================================================
  # JOB 2: BUILD BACKEND
  # ============================================================================
  build-backend:
    name: 'üêç Build Backend'
    timeout-minutes: 25
    needs: [build-frontend]
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'
      - name: Create Staging Directory for UI
        shell: pwsh
        run: New-Item -ItemType Directory -Path "staging/ui" -Force | Out-Null
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: staging/ui
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r python_service/requirements-dev.txt
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller fortuna-backend-webservice.spec --noconfirm
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: dist/fortuna-backend.exe
          retention-days: 1

  # ============================================================================
  # JOB 3: SMOKE TEST BACKEND
  # ============================================================================
  smoke-test-backend:
    name: 'üß™ Smoke Test Backend'
    timeout-minutes: 10
    needs: [build-backend]
    runs-on: windows-latest
    steps:
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
      - name: Run Smoke Test
        shell: pwsh
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test_12345"
        run: |
          $exe = './fortuna-backend.exe'
          Start-Process -FilePath $exe -NoNewWindow -RedirectStandardOutput 'out.log' -RedirectStandardError 'err.log'

          $success = $false
          foreach ($attempt in 1..15) {
            Write-Host "Attempt $attempt: Checking health..."
            try {
              $resp = Invoke-WebRequest -Uri 'http://127.0.0.1:8000/health' -UseBasicParsing -TimeoutSec 2
              if ($resp.StatusCode -eq 200) {
                Write-Host "‚úÖ Backend Healthy" -ForegroundColor Green
                $success = $true
                break
              }
            } catch {
              Start-Sleep -Seconds 2
            }
          }

          Stop-Process -Name "fortuna-backend" -Force -ErrorAction SilentlyContinue

          if (-not $success) {
            Write-Host "--- STDOUT ---"
            Get-Content 'out.log' -Tail 30
            Write-Host "--- STDERR ---"
            Get-Content 'err.log' -Tail 30
            throw "‚ùå Smoke Test Failed"
          }

  # ============================================================================
  # JOB 4: PACKAGE MSI & CREATE RELEASE
  # ============================================================================
  package-and-release:
    name: 'üíø Package & Release MSI'
    timeout-minutes: 20
    needs: [smoke-test-backend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: ./dist

      - name: Stage Artifacts for WiX
        id: stage_files
        shell: pwsh
        run: |
          $staging = "build_wix/staging"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null

          # The executable is now self-contained with the UI, so it's the only thing we need to stage.
          Move-Item -Path "./dist/fortuna-backend.exe" -Destination "$staging/fortuna-backend.exe" -Force

          # Sanitize the branch/tag name for the MSI filename
          $msiName = "Fortuna-WebService-${{ github.ref_name }}.msi".Replace('/', '-')
          echo "msi_name=$msiName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          Write-Host "‚úÖ Staging Complete. MSI will be named: $msiName"
          Get-ChildItem -Path $staging -Recurse

      - name: Setup .NET and WiX v4 Toolset
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Install WiX v4 and Extensions
        shell: pwsh
        run: |
          dotnet tool install --global wix
          wix extension add WixToolset.Util.wixext
          wix extension add WixToolset.Firewall.wixext

      - name: Build MSI with WiX v4
        shell: pwsh
        run: |
          $stagingDir = "$PWD/build_wix/staging"
          $outputDir = "$PWD/dist"
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

          # With a self-contained executable, we no longer need to harvest the UI components.
          # The WXS file is now solely responsible for installing the service.
          wix build build_wix/Product_WithService.wxs `
            -ext WixToolset.Util.wixext `
            -ext WixToolset.Firewall.wixext `
            -d "SourceDir=$stagingDir" `
            -o "$outputDir/${{ steps.stage_files.outputs.msi_name }}"

      - name: Verify MSI Creation
        shell: pwsh
        run: |
          $msiPath = "dist/${{ steps.stage_files.outputs.msi_name }}"
          if (-not (Test-Path $msiPath)) { throw "‚ùå MSI was not created at $msiPath" }
          $msiSize = (Get-Item $msiPath).Length / 1MB
          Write-Host "‚úÖ MSI created successfully (${msiSize:.1f} MB)" -ForegroundColor Green

      - name: Upload MSI as Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-webservice-installer
          path: dist/*.msi
          retention-days: 7

      - name: Create GitHub Release (on tags)
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            üèÜ **Fortuna Faucet (Web Service Edition) Production Release**

            - Native Windows MSI Installer built with WiX v4.
            - This installer configures the backend as a Windows Service.
            - Built from commit `${{ github.sha }}`.
          draft: false
          prerelease: false

      - name: Upload MSI to GitHub Release (on tags)
        if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/${{ steps.stage_files.outputs.msi_name }}
          asset_name: ${{ steps.stage_files.outputs.msi_name }}
          asset_content_type: application/octet-stream
