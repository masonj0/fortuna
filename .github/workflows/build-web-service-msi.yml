name: Build Fortuna Faucet Web Service Installer

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================================================
  # STAGE 0: VALIDATION & ENVIRONMENT SETUP
  # ============================================================================
  validate-environment:
    name: 'üîç Validate Environment & Dependencies'
    timeout-minutes: 5
    runs-on: windows-latest
    outputs:
      node-cache-hit: ${{ steps.node-cache.outputs.cache-hit }}
      python-cache-hit: ${{ steps.python-cache.outputs.cache-hit }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Validate Critical Files Exist
        shell: pwsh
        run: |
          $criticalFiles = @(
            'web_platform/frontend/package.json',
            'web_platform/frontend/package-lock.json',
            'python_service/requirements.txt',
            'python_service/requirements-dev.txt',
            'python_service/main.py',
            'fortuna-backend-webservice.spec',
            'build_wix/Product_WithService.wxs',
            'build_wix/harvester/harvest.wixproj'
          )

          $missing = @()
          foreach ($file in $criticalFiles) {
            if (-not (Test-Path $file)) {
              $missing += $file
            }
          }

          if ($missing.Count -gt 0) {
            Write-Host "‚ùå FATAL: Missing critical files:" -ForegroundColor Red
            $missing | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
            exit 1
          }
          Write-Host "‚úÖ All critical files present" -ForegroundColor Green

      - name: Validate Directory Structure
        shell: pwsh
        run: |
          $requiredDirs = @(
            'web_platform/frontend',
            'python_service',
            'build_wix'
          )

          foreach ($dir in $requiredDirs) {
            if (-not (Test-Path $dir -PathType Container)) {
              Write-Host "‚ùå FATAL: Missing directory: $dir" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ All required directories present" -ForegroundColor Green

      - name: Check Cache Status
        id: node-cache
        shell: pwsh
        run: |
          if (Test-Path 'web_platform/frontend/node_modules') {
            Write-Host "node-cache-hit=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "node-cache-hit=false" >> $env:GITHUB_OUTPUT
          }

      - name: Check Python Cache Status
        id: python-cache
        shell: pwsh
        run: |
          if (Test-Path 'python_service/venv') {
            Write-Host "python-cache-hit=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "python-cache-hit=false" >> $env:GITHUB_OUTPUT
          }

  # ============================================================================
  # STAGE 1: FRONTEND BUILD
  # ============================================================================
  build-frontend:
    name: 'üì¶ Build Frontend'
    timeout-minutes: 15
    needs: [validate-environment]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'

      - name: Frontend - Install Dependencies
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Installing dependencies..." -ForegroundColor Cyan
          npm ci --verbose
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå npm ci failed with exit code: $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Dependencies installed" -ForegroundColor Green

      - name: Frontend - Security Audit
        shell: pwsh
        continue-on-error: true
        run: |
          cd web_platform/frontend
          Write-Host "Running npm audit..." -ForegroundColor Cyan
          npm audit --audit-level=moderate
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è npm audit found issues (non-blocking)" -ForegroundColor Yellow
          }

      - name: Frontend - Lint (if configured)
        shell: pwsh
        continue-on-error: true
        run: |
          cd web_platform/frontend
          if (Select-String -Path 'package.json' -Pattern '"lint"' -Quiet) {
            Write-Host "Running lint..." -ForegroundColor Cyan
            npm run lint
          } else {
            Write-Host "‚ö†Ô∏è No lint script found" -ForegroundColor Yellow
          }

      - name: Frontend - Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          Write-Host "Building frontend..." -ForegroundColor Cyan
          npm run build
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå npm run build failed with exit code: $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }

          if (-not (Test-Path 'out')) {
            Write-Host "‚ùå FATAL: Build output directory 'out' not created" -ForegroundColor Red
            exit 1
          }

          $fileCount = (Get-ChildItem -Path 'out' -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: Build output directory is empty" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ Frontend build complete ($fileCount files)" -ForegroundColor Green

      - name: Verify Frontend Build Output
        shell: pwsh
        run: |
          $outDir = 'web_platform/frontend/out'
          Write-Host "Frontend build contents:" -ForegroundColor Cyan
          Get-ChildItem -Path $outDir -Recurse | Select-Object -First 20 | ForEach-Object {
            Write-Host "  $($_.FullName.Replace($outDir, '').TrimStart('\'))"
          }

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-output-${{ github.sha }}
          path: web_platform/frontend/out
          retention-days: 1
          if-no-files-found: error

      - name: Verify Frontend Artifact Upload
        shell: pwsh
        run: |
          Write-Host "‚úÖ Frontend artifact uploaded successfully" -ForegroundColor Green

  # ============================================================================
  # STAGE 2: BACKEND BUILD
  # ============================================================================
  build-backend:
    name: 'üêç Build Backend'
    timeout-minutes: 25
    needs: [build-frontend]
    runs-on: windows-latest
    env:
      PYTHONUTF8: "1"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'

      - name: Verify Python Installation
        shell: pwsh
        run: |
          python --version
          pip --version
          Write-Host "‚úÖ Python environment verified" -ForegroundColor Green

      - name: Create Required Directories
        shell: pwsh
        run: |
          $requiredDirs = @(
            'python_service/adapters',
            'python_service/data',
            'python_service/json',
            'staging/ui'
          )

          foreach ($dir in $requiredDirs) {
            if (-not (Test-Path $dir)) {
              New-Item -ItemType Directory -Path $dir -Force | Out-Null
              Write-Host "‚úÖ Created: $dir" -ForegroundColor Green
            }
          }

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-output-${{ github.sha }}
          path: ./temp-frontend

      - name: Verify Frontend Artifact Downloaded
        shell: pwsh
        run: |
          if (-not (Test-Path 'temp-frontend')) {
            Write-Host "‚ùå FATAL: Frontend artifact not downloaded" -ForegroundColor Red
            exit 1
          }
          $fileCount = (Get-ChildItem -Path 'temp-frontend' -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: Downloaded frontend artifact is empty" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Frontend artifact verified ($fileCount files)" -ForegroundColor Green

      - name: Stage Frontend for PyInstaller
        shell: pwsh
        run: |
          $sourceDir = 'temp-frontend'
          $destinationDir = 'staging/ui'

          Write-Host "Staging frontend from $sourceDir to $destinationDir" -ForegroundColor Cyan

          if (Test-Path $destinationDir) {
            Remove-Item -Recurse -Force $destinationDir
          }
          New-Item -ItemType Directory -Path $destinationDir -Force | Out-Null

          Copy-Item -Path "$sourceDir/*" -Destination $destinationDir -Recurse -Force

          $stagedFileCount = (Get-ChildItem -Path $destinationDir -Recurse -File | Measure-Object).Count
          if ($stagedFileCount -eq 0) {
            Write-Host "‚ùå FATAL: Staging failed - destination is empty" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ Frontend staged successfully ($stagedFileCount files)" -ForegroundColor Green

      - name: Verify Critical Python Files
        shell: pwsh
        run: |
          $criticalFiles = @(
            'python_service/main.py',
            'fortuna-backend-webservice.spec'
          )

          foreach ($file in $criticalFiles) {
            if (-not (Test-Path $file)) {
              Write-Host "‚ùå FATAL: Missing critical file: $file" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ All critical Python files present" -ForegroundColor Green

      - name: Install Python Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing Python dependencies..." -ForegroundColor Cyan
          python -m pip install --upgrade pip setuptools wheel

          pip install -r python_service/requirements.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: pip install failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ Python dependencies installed" -ForegroundColor Green

      - name: Install Development Dependencies
        shell: pwsh
        run: |
          Write-Host "Installing dev dependencies..." -ForegroundColor Cyan
          pip install -r python_service/requirements-dev.txt
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: pip install dev failed" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Dev dependencies installed" -ForegroundColor Green

      - name: Backend - Security Audit
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Running pip-audit..." -ForegroundColor Cyan
          pip install pip-audit
          pip-audit -r python_service/requirements.txt --local
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è pip-audit found issues (non-blocking)" -ForegroundColor Yellow
          }

      - name: Verify PyInstaller Spec
        shell: pwsh
        run: |
          $specFile = 'fortuna-backend-webservice.spec'
          $specContent = Get-Content $specFile -Raw

          if ($specContent -notmatch 'Analysis|PyInstaller') {
            Write-Host "‚ùå FATAL: PyInstaller spec file appears invalid" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ PyInstaller spec file validated" -ForegroundColor Green

      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Building backend with PyInstaller..." -ForegroundColor Cyan
          pyinstaller fortuna-backend-webservice.spec --noconfirm
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: PyInstaller build failed" -ForegroundColor Red
            exit 1
          }

          if (-not (Test-Path 'dist/fortuna-backend.exe')) {
            Write-Host "‚ùå FATAL: PyInstaller did not produce fortuna-backend.exe" -ForegroundColor Red
            Get-ChildItem -Path 'dist' -Recurse | ForEach-Object { Write-Host "  Found: $_" }
            exit 1
          }

          $exeSize = (Get-Item 'dist/fortuna-backend.exe').Length / 1MB
          Write-Host "‚úÖ Backend executable created (${exeSize:.1f} MB)" -ForegroundColor Green

      - name: Verify Backend Executable
        shell: pwsh
        run: |
          $exe = 'dist/fortuna-backend.exe'

          if (-not (Test-Path $exe)) {
            Write-Host "‚ùå FATAL: Executable not found at $exe" -ForegroundColor Red
            exit 1
          }

          $fileInfo = Get-Item $exe
          if ($fileInfo.Length -lt 10MB) {
            Write-Host "‚ö†Ô∏è WARNING: Executable is suspiciously small ($(${fileInfo.Length} / 1MB) MB)" -ForegroundColor Yellow
          }

          Write-Host "‚úÖ Backend executable verified" -ForegroundColor Green
          Write-Host "  Size: $($fileInfo.Length / 1MB) MB" -ForegroundColor Green
          Write-Host "  Modified: $($fileInfo.LastWriteTime)" -ForegroundColor Green

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: dist/fortuna-backend.exe
          retention-days: 1
          if-no-files-found: error

      - name: Verify Backend Artifact Upload
        shell: pwsh
        run: |
          Write-Host "‚úÖ Backend artifact uploaded successfully" -ForegroundColor Green

  # ============================================================================
  # STAGE 3: SMOKE TESTS
  # ============================================================================
  smoke-test-backend:
    name: 'üß™ Smoke Test Backend Executable'
    timeout-minutes: 15
    needs: [build-backend]
    runs-on: windows-latest
    steps:
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: ./backend-dist

      - name: Verify Executable Downloaded
        shell: pwsh
        run: |
          if (-not (Test-Path 'backend-dist/fortuna-backend.exe')) {
            Write-Host "‚ùå FATAL: Backend executable not found" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Backend executable verified" -ForegroundColor Green

      - name: Run Smoke Test - Backend Health
        shell: pwsh
        timeout-minutes: 5
        env:
          API_KEY: "a_secure_test_api_key_that_is_long_enough_for_smoke_test_12345"
        run: |
          $exe = './backend-dist/fortuna-backend.exe'
          $logDir = 'logs'
          $stdOutPath = Join-Path $logDir 'backend-out.txt'
          $stdErrPath = Join-Path $logDir 'backend-err.txt'

          if (-not (Test-Path $logDir)) {
            New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          }

          Write-Host "Starting backend process..." -ForegroundColor Cyan
          $process = Start-Process -FilePath $exe `
            -PassThru `
            -NoNewWindow `
            -RedirectStandardOutput $stdOutPath `
            -RedirectStandardError $stdErrPath `
            -ErrorAction Stop

          Write-Host "Backend process started (PID: $($process.Id))" -ForegroundColor Green

          $serverReady = $false
          $maxAttempts = 40
          $attemptCount = 0

          try {
            for ($i = 1; $i -le $maxAttempts; $i++) {
              $attemptCount = $i

              if ($process.HasExited) {
                Write-Host "‚ùå Backend process exited unexpectedly (Exit Code: $($process.ExitCode))" -ForegroundColor Red
                break
              }

              try {
                Write-Host "Attempt $i/${maxAttempts}: Checking /health endpoint..." -ForegroundColor Gray
                $response = Invoke-WebRequest `
                  -Uri 'http://127.0.0.1:8000/health' `
                  -TimeoutSec 2 `
                  -UseBasicParsing `
                  -ErrorAction SilentlyContinue

                if ($response.StatusCode -eq 200) {
                  Write-Host "‚úÖ Health endpoint responded" -ForegroundColor Green

                  Write-Host "Checking /api/races endpoint..." -ForegroundColor Gray
                  $headers = @{ 'X-API-Key' = $env:API_KEY }
                  $apiResponse = Invoke-WebRequest `
                    -Uri 'http://127.0.0.1:8000/api/races' `
                    -Headers $headers `
                    -TimeoutSec 2 `
                    -UseBasicParsing `
                    -ErrorAction SilentlyContinue

                  if ($apiResponse.StatusCode -eq 200 -or $apiResponse.StatusCode -eq 400 -or $apiResponse.StatusCode -eq 401) {
                    Write-Host "‚úÖ API endpoint responded (Status: $($apiResponse.StatusCode))" -ForegroundColor Green
                    $serverReady = $true
                    break
                  }
                }
              } catch {
                Write-Host "  (waiting...)" -ForegroundColor Gray
              }

              Start-Sleep -Seconds 1.5
            }
          } finally {
            Write-Host "Stopping backend process..." -ForegroundColor Cyan
            Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue
            Start-Sleep -Milliseconds 500
          }

          if (-not $serverReady) {
            Write-Host "‚ùå SMOKE TEST FAILED: Backend did not become healthy" -ForegroundColor Red
            Write-Host "Attempts: ${attemptCount}/${maxAttempts}" -ForegroundColor Red

            if (Test-Path $stdOutPath) {
              Write-Host "`n--- STDOUT (last 30 lines) ---" -ForegroundColor Yellow
              Get-Content $stdOutPath -Tail 30 | Write-Host
            }
            if (Test-Path $stdErrPath) {
              Write-Host "`n--- STDERR (last 30 lines) ---" -ForegroundColor Yellow
              Get-Content $stdErrPath -Tail 30 | Write-Host
            }
            exit 1
          }

          Write-Host "`n‚úÖ SMOKE TEST PASSED on attempt $attemptCount" -ForegroundColor Green

      - name: Upload Smoke Test Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-logs-${{ github.sha }}
          path: logs/
          retention-days: 3

  # ============================================================================
  # STAGE 4: PACKAGING / WiX INSTALLER
  # ============================================================================
  build-wix-installer:
    name: 'üî• Build WiX Installer (v4)'
    timeout-minutes: 20
    needs: [smoke-test-backend, build-frontend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Staging Directory
        shell: pwsh
        run: |
          $stagingDir = 'build_wix/staging'
          if (Test-Path $stagingDir) {
            Remove-Item -Recurse -Force $stagingDir
          }
          New-Item -ItemType Directory -Path "$stagingDir/ui" -Force | Out-Null
          Write-Host "‚úÖ Staging directory prepared" -ForegroundColor Green

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-output-${{ github.sha }}
          path: ./artifacts/frontend

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-executable-${{ github.sha }}
          path: ./artifacts/backend

      - name: Verify Downloaded Artifacts
        shell: pwsh
        run: |
          $frontendPath = './artifacts/frontend'
          $backendPath = './artifacts/backend/fortuna-backend.exe'

          if (-not (Test-Path $frontendPath)) {
            Write-Host "‚ùå FATAL: Frontend artifact not found" -ForegroundColor Red
            exit 1
          }

          if (-not (Test-Path $backendPath)) {
            Write-Host "‚ùå FATAL: Backend executable not found" -ForegroundColor Red
            exit 1
          }

          $frontendFiles = (Get-ChildItem -Path $frontendPath -Recurse -File | Measure-Object).Count
          $backendSize = (Get-Item $backendPath).Length / 1MB

          Write-Host "‚úÖ Artifacts verified:" -ForegroundColor Green
          Write-Host "  Frontend: $frontendFiles files" -ForegroundColor Green
          Write-Host "  Backend: ${backendSize:.1f} MB" -ForegroundColor Green

      - name: Stage Artifacts for WiX
        shell: pwsh
        run: |
          $wixStaging = 'build_wix/staging'
          $uiDir = "$wixStaging/ui"

          Write-Host "Copying backend executable..." -ForegroundColor Cyan
          Copy-Item -Path './artifacts/backend/fortuna-backend.exe' `
            -Destination "$wixStaging/fortuna-backend.exe" -Force

          Write-Host "Copying frontend files..." -ForegroundColor Cyan
          Copy-Item -Path './artifacts/frontend/*' `
            -Destination $uiDir -Recurse -Force

          $backendExists = Test-Path "$wixStaging/fortuna-backend.exe"
          $frontendCount = (Get-ChildItem -Path $uiDir -Recurse -File | Measure-Object).Count

          if (-not $backendExists) {
            Write-Host "‚ùå FATAL: Backend not staged correctly" -ForegroundColor Red
            exit 1
          }

          if ($frontendCount -eq 0) {
            Write-Host "‚ùå FATAL: Frontend staging failed (0 files)" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ All artifacts staged successfully" -ForegroundColor Green
          Write-Host "  Backend: staged" -ForegroundColor Green
          Write-Host "  Frontend: $frontendCount files" -ForegroundColor Green

      - name: Setup .NET for WiX v4
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify .NET Installation
        shell: pwsh
        run: |
          dotnet --version
          Write-Host "‚úÖ .NET SDK verified" -ForegroundColor Green

      - name: Install WiX v4 Toolset
        shell: pwsh
        run: |
          Write-Host "Installing WiX toolset..." -ForegroundColor Cyan
          dotnet tool install --global wix
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: WiX installation failed" -ForegroundColor Red
            exit 1
          }

          wix --version
          Write-Host "‚úÖ WiX toolset installed" -ForegroundColor Green

      - name: Add WiX Extensions
        shell: pwsh
        run: |
          Write-Host "Adding WiX extensions..." -ForegroundColor Cyan
          wix extension add WixToolset.Heat.wixext
          wix extension add WixToolset.Util.wixext
          wix extension add WixToolset.Firewall.wixext
          Write-Host "‚úÖ Extensions installed" -ForegroundColor Green

      - name: Verify WiX Configuration Files
        shell: pwsh
        run: |
          $files = @(
            'build_wix/Product_WithService.wxs',
            'build_wix/harvester/harvest.wixproj'
          )

          foreach ($file in $files) {
            if (-not (Test-Path $file)) {
              Write-Host "‚ùå FATAL: Missing $file" -ForegroundColor Red
              exit 1
            }
          }
          Write-Host "‚úÖ WiX configuration files verified" -ForegroundColor Green

      - name: Harden WiX Source File Encoding (UTF-8)
        shell: pwsh
        run: |
          $filePath = 'build_wix/Product_WithService.wxs'
          Write-Host "Normalizing encoding for $filePath..."
          (Get-Content -Path $filePath -Raw) | Set-Content -Path $filePath -Encoding Utf8 -Force
          Write-Host "‚úÖ Encoding set to UTF-8."

      - name: Run WiX Harvest via MSBuild
        shell: pwsh
        run: |
          Write-Host "Harvesting frontend directory via MSBuild..." -ForegroundColor Cyan
          $uiDir = "build_wix/staging/ui"
          $outputFile = "build_wix/frontend_components.wxs"

          if (-not (Test-Path $uiDir)) {
            Write-Host "‚ùå FATAL: UI staging directory not found at '$uiDir'" -ForegroundColor Red
            exit 1
          }

          $fileCount = (Get-ChildItem -Path $uiDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: No files in UI directory to harvest" -ForegroundColor Red
            exit 1
          }
          Write-Host "Files to harvest: $fileCount" -ForegroundColor Green

          # Clean up old output if it exists
          if (Test-Path $outputFile) {
            Remove-Item $outputFile -Force
          }

          # Build the harvest project - this generates frontend_components.wxs
          $sourcePath = (Resolve-Path "build_wix/staging").Path
          Write-Host "Invoking MSBuild with SourceDir: $sourcePath" -ForegroundColor Cyan
          dotnet build build_wix/harvester/harvest.wixproj -p:SourceDir="$sourcePath" -v:minimal

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: MSBuild harvest failed with exit code: $LASTEXITCODE" -ForegroundColor Red
            exit 1
          }

          if (-not (Test-Path $outputFile)) {
            Write-Host "‚ùå FATAL: Output file was not created at '$outputFile'" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ Frontend harvest complete" -ForegroundColor Green

      - name: Validate Generated Frontend Components
        shell: pwsh
        run: |
          $filePath = 'build_wix/frontend_components.wxs'

          if (-not (Test-Path $filePath)) {
            Write-Host "‚ùå FATAL: frontend_components.wxs not generated" -ForegroundColor Red
            exit 1
          }

          $content = Get-Content $filePath -Raw

          if ($content -notmatch '<ComponentGroup Id="FrontendComponents">') {
            Write-Host "‚ùå FATAL: Missing FrontendComponents ComponentGroup" -ForegroundColor Red
            exit 1
          }

          $fileCount = ([regex]::Matches($content, '<File')).Count
          if ($fileCount -eq 0) {
            Write-Host "‚ùå FATAL: No files in generated WXS" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ Generated WXS validated" -ForegroundColor Green
          Write-Host "  Files: $fileCount" -ForegroundColor Green

      - name: Build MSI with WiX
        shell: pwsh
        run: |
          $sourceDir = "$PWD/build_wix/staging"
          $uiDir = "$sourceDir/ui"
          $outputDir = 'dist'
          $msiName = 'Fortuna-Full-App-Service-v4.msi'

          if (-not (Test-Path $outputDir)) {
            New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          }

          Write-Host "Building MSI..." -ForegroundColor Cyan
          Write-Host "  Source: $sourceDir" -ForegroundColor Gray
          Write-Host "  Output: $outputDir/$msiName" -ForegroundColor Gray

          wix build `
            build_wix/Product_WithService.wxs `
            build_wix/frontend_components.wxs `
            -ext WixToolset.Util.wixext `
            -ext WixToolset.Firewall.wixext `
            -d "SourceDir=$sourceDir" `
            -d "FrontendSourceDir=$uiDir" `
            -o "$outputDir/$msiName"

          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå FATAL: MSI build failed" -ForegroundColor Red
            exit 1
          }

          if (-not (Test-Path "$outputDir/$msiName")) {
            Write-Host "‚ùå FATAL: MSI not created at expected location" -ForegroundColor Red
            exit 1
          }

          Write-Host "‚úÖ MSI created successfully" -ForegroundColor Green

      - name: Verify MSI
        shell: pwsh
        run: |
          $msiPath = 'dist/Fortuna-Full-App-Service-v4.msi'

          if (-not (Test-Path $msiPath)) {
            Write-Host "‚ùå FATAL: MSI file not found" -ForegroundColor Red
            exit 1
          }

          $msiSize = (Get-Item $msiPath).Length / 1MB

          if ($msiSize -lt 5) {
            Write-Host "‚ö†Ô∏è WARNING: MSI is suspiciously small (${msiSize:.1f} MB)" -ForegroundColor Yellow
          }

          Write-Host "‚úÖ MSI verified" -ForegroundColor Green
          Write-Host "  Size: ${msiSize:.1f} MB" -ForegroundColor Green
          Write-Host "  Path: $msiPath" -ForegroundColor Green

      - name: Upload WiX MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-wix-installer-windows-v4
          path: dist/Fortuna-Full-App-Service-v4.msi
          retention-days: 7
          if-no-files-found: error

      - name: Create Release Summary
        shell: pwsh
        run: |
          $msiPath = 'dist/Fortuna-Full-App-Service-v4.msi'
          $msiSize = (Get-Item $msiPath).Length / 1MB
          $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'

          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
          Write-Host "‚ïë          BUILD COMPLETE - SUCCESS              ‚ïë" -ForegroundColor Green
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
          Write-Host "`nBuild Summary:" -ForegroundColor Cyan
          Write-Host "  Timestamp: $timestamp" -ForegroundColor Green
          Write-Host "  Commit: ${{ github.sha }}" -ForegroundColor Green
          Write-Host "  Branch: ${{ github.ref }}" -ForegroundColor Green
          Write-Host "`nArtifacts Generated:" -ForegroundColor Cyan
          Write-Host "  ‚úÖ Frontend Build" -ForegroundColor Green
          Write-Host "  ‚úÖ Backend Executable" -ForegroundColor Green
          Write-Host "  ‚úÖ Smoke Tests Passed" -ForegroundColor Green
          Write-Host "  ‚úÖ WiX MSI Installer" -ForegroundColor Green
          Write-Host "`nInstaller Details:" -ForegroundColor Cyan
          Write-Host "  File: Fortuna-Full-App-Service-v4.msi" -ForegroundColor Green
          Write-Host "  Size: ${msiSize:.1f} MB" -ForegroundColor Green
          Write-Host "  Location: dist/" -ForegroundColor Green

  # ============================================================================
  # FINAL STAGE: BUILD STATUS & NOTIFICATIONS
  # ============================================================================
  build-status:
    name: '‚úÖ Build Status Summary'
    timeout-minutes: 5
    needs: [build-wix-installer]
    runs-on: windows-latest
    if: always()
    steps:
      - name: Check Overall Build Status
        shell: pwsh
        run: |
          $needsContext = '${{ needs }}'
          Write-Host "Build Pipeline Summary:" -ForegroundColor Cyan
          Write-Host "  Validate Environment: ${{ needs.validate-environment.result }}" -ForegroundColor Green
          Write-Host "  Build Frontend: ${{ needs.build-frontend.result }}" -ForegroundColor Green
          Write-Host "  Build Backend: ${{ needs.build-backend.result }}" -ForegroundColor Green
          Write-Host "  Smoke Tests: ${{ needs.smoke-test-backend.result }}" -ForegroundColor Green
          Write-Host "  Build Installer: ${{ needs.build-wix-installer.result }}" -ForegroundColor Green

          if ('${{ needs.build-wix-installer.result }}' -ne 'success') {
            Write-Host "`n‚ùå Build pipeline failed!" -ForegroundColor Red
            exit 1
          }

          Write-Host "`n‚úÖ All stages completed successfully!" -ForegroundColor Green

      - name: Generate Build Report
        if: success()
        shell: pwsh
        run: |
          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
          Write-Host "‚ïë    FORTUNA FAUCET BUILD PIPELINE SUCCESSFUL    ‚ïë" -ForegroundColor Green
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Green
          Write-Host "`n‚úÖ All stages passed:" -ForegroundColor Green
          Write-Host "  1. Environment validation" -ForegroundColor Green
          Write-Host "  2. Frontend build with security audit" -ForegroundColor Green
          Write-Host "  3. Backend build with PyInstaller" -ForegroundColor Green
          Write-Host "  4. Backend smoke tests (health + API)" -ForegroundColor Green
          Write-Host "  5. WiX installer packaging" -ForegroundColor Green
          Write-Host "`nArtifacts Ready for Release:" -ForegroundColor Cyan
          Write-Host "  üì¶ Fortuna-Full-App-Service-v4.msi" -ForegroundColor Green
          Write-Host "`nNext Steps:" -ForegroundColor Cyan
          Write-Host "  1. Download MSI from artifacts" -ForegroundColor Yellow
          Write-Host "  2. Test on target system" -ForegroundColor Yellow
          Write-Host "  3. Create GitHub release" -ForegroundColor Yellow
          Write-Host "  4. Publish to distribution channels" -ForegroundColor Yellow

      - name: Failure Report
        if: failure()
        shell: pwsh
        run: |
          Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Red
          Write-Host "‚ïë           BUILD PIPELINE FAILED                ‚ïë" -ForegroundColor Red
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Red
          Write-Host "`nFailed Jobs:" -ForegroundColor Red
          Write-Host "  Validate Environment: ${{ needs.validate-environment.result }}" -ForegroundColor $(if('${{ needs.validate-environment.result }}' -eq 'failure'){'Red'}else{'Green'})
          Write-Host "  Build Frontend: ${{ needs.build-frontend.result }}" -ForegroundColor $(if('${{ needs.build-frontend.result }}' -eq 'failure'){'Red'}else{'Green'})
          Write-Host "  Build Backend: ${{ needs.build-backend.result }}" -ForegroundColor $(if('${{ needs.build-backend.result }}' -eq 'failure'){'Red'}else{'Green'})
          Write-Host "  Smoke Tests: ${{ needs.smoke-test-backend.result }}" -ForegroundColor $(if('${{ needs.smoke-test-backend.result }}' -eq 'failure'){'Red'}else{'Green'})
          Write-Host "  Build Installer: ${{ needs.build-wix-installer.result }}" -ForegroundColor $(if('${{ needs.build-wix-installer.result }}' -eq 'failure'){'Red'}else{'Green'})
          Write-Host "`nDebugging:" -ForegroundColor Yellow
          Write-Host "  1. Check job logs for specific errors" -ForegroundColor Yellow
          Write-Host "  2. Review artifact uploads" -ForegroundColor Yellow
          Write-Host "  3. Verify environment setup" -ForegroundColor Yellow