name: Build Fortuna Faucet MSI (WiX v4) - üèÜ PRODUCTION

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  PYTHONUTF8: "1"

jobs:
  # ============================================================================
  # JOB 1: BUILD FRONTEND
  # ============================================================================
  build-frontend:
    name: 'üì¶ Build Frontend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_service/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd web_service/frontend
          npm ci
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          if (-not (Test-Path 'web_service/frontend/out/index.html')) { throw "‚ùå Missing index.html" }
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web_service/frontend/out
          retention-days: 1

  # ============================================================================
  # JOB 2: BUILD BACKEND & SMOKE TEST
  # ============================================================================
  build-and-test:
    name: 'üêç Build & Smoke Test'
    needs: [build-frontend]
    runs-on: windows-latest
    env:
      FORTUNA_PORT: 8088
      SMOKE_FRONTEND_URL: "http://localhost:8088"
      SMOKE_HEADING_SELECTOR: "h1"
      SMOKE_SCREENSHOT_PATH: "smoke-test.png"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- SETUP PYTHON ---
      - name: Setup Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: web_service/frontend/out

      - name: Install Dependencies
        shell: pwsh
        run: |
          ${{ steps.setup-python.outputs.python-path }} -m pip install --upgrade pip
          ${{ steps.setup-python.outputs.python-path }} -m pip install -r python_service/requirements-dev.txt
          ${{ steps.setup-python.outputs.python-path }} -m pip install playwright pytest-playwright

      # --- CACHE PLAYWRIGHT BROWSERS ---
      - name: Get Playwright Version
        id: playwright-version
        shell: pwsh
        run: echo "VERSION=$(${{ steps.setup-python.outputs.python-path }} -c 'from importlib.metadata import version; print(version("playwright"))')" >> $env:GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: C:\Users\runneradmin\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.VERSION }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: ${{ steps.setup-python.outputs.python-path }} -m playwright install --with-deps chromium

      # --- BUILD EXE ---
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: ${{ steps.setup-python.outputs.python-path }} -m pyinstaller fortuna-webservice.spec --clean --noconfirm

      # --- SMOKE TEST ---
      - name: 'üõ°Ô∏è Open Firewall'
        shell: pwsh
        run: New-NetFirewallRule -DisplayName "SmokeTest" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}

      - name: Run Backend (Background)
        shell: pwsh
        run: |
          # 1. Create required runtime directories to prevent immediate crash
          New-Item -ItemType Directory -Path "data" -Force | Out-Null
          New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "json" -Force | Out-Null

          Write-Host "üìÇ Runtime directories created."

          # 2. Start the Service
          # Use Start-Process with explicit Environment Variables to ensure Port binding works
          $env:FORTUNA_PORT = "${{ env.FORTUNA_PORT }}"
          $env:FORTUNA_MODE = "webservice"

          $p = Start-Process -FilePath "dist/fortuna-webservice.exe" -PassThru -RedirectStandardOutput "backend.log" -RedirectStandardError "backend.err"
          $p.Id | Out-File "backend.pid"

          Write-Host "üöÄ Service started with PID $($p.Id) on port $env:FORTUNA_PORT"

          # 3. Wait a moment for startup (prevents race condition with Playwright)
          Start-Sleep -Seconds 5

      - name: üì∏ Playwright Verification
        shell: pwsh
        run: |
          $script = @"
          import sys, os, time
          from playwright.sync_api import sync_playwright, expect

          url = os.environ["SMOKE_FRONTEND_URL"]
          print(f"Testing URL: {url}")

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()
              try:
                  # RETRY LOGIC: Wait for network AND DOM readiness
                  for i in range(10):
                      try:
                          # wait_until='domcontentloaded' prevents firing before HTML is parsed
                          page.goto(url, wait_until='domcontentloaded', timeout=5000)
                          break
                      except:
                          print(f"Waiting for server... ({i+1}/10)")
                          time.sleep(2)

                  # ROBUST ASSERTION: Allow 10s for React/Vue hydration
                  expect(page.locator("body")).to_be_visible(timeout=10000)

                  # Capture success
                  page.screenshot(path=os.environ["SMOKE_SCREENSHOT_PATH"])
                  print("‚úÖ Screenshot captured.")
              except Exception as e:
                  print(f"‚ùå Error: {e}")
                  page.screenshot(path="FAILURE.png")
                  sys.exit(1)
              finally:
                  browser.close()
          "@
          Set-Content -Path "verify.py" -Value $script
          python verify.py

      - name: Upload Screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-evidence
          path: |
            *.png
            backend.log
            backend.err

      - name: üïµÔ∏è Inspect Backend Logs (On Failure)
        if: failure()
        shell: pwsh
        run: |
          Write-Host "::group::Backend Error Log (Why did it crash?)"
          if (Test-Path "backend.err") { Get-Content "backend.err" } else { Write-Host "No error log found." }
          Write-Host "::endgroup::"

          Write-Host "::group::Backend Output Log"
          if (Test-Path "backend.log") { Get-Content "backend.log" }
          Write-Host "::endgroup::"

      - name: Upload Validated EXE
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable
          path: dist/fortuna-webservice.exe

      - name: Cleanup Firewall & Process
        if: always()
        shell: pwsh
        run: |
          if (Test-Path "backend.pid") { Stop-Process -Id (Get-Content "backend.pid") -Force -ErrorAction SilentlyContinue }
          Remove-NetFirewallRule -DisplayName "SmokeTest" -ErrorAction SilentlyContinue

  # ============================================================================
  # JOB 3: PACKAGE MSI
  # ============================================================================
  package-msi-service:
    name: 'üíø Package Service MSI'
    needs: [build-and-test]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Validated Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable
          path: build_wix/staging

      - name: Setup .NET 8 (for WiX)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Remove Conflicting WXS
        shell: pwsh
        run: |
           if (Test-Path "build_wix/Product_WithoutService.wxs") { Remove-Item "build_wix/Product_WithoutService.wxs" -Force }

      - name: Generate WiX Project File (Dynamic Name)
        working-directory: build_wix
        shell: pwsh
        run: |
          # DYNAMIC NAMING: Appends Run Number for traceability
          $msiName = "Fortuna-WebService-${{ github.run_number }}"

          $wixProjContent = @"
          <Project Sdk="WixToolset.Sdk/4.0.5">
            <PropertyGroup>
              <OutputName>$msiName</OutputName>
              <OutputType>Package</OutputType>
              <DefineConstants>SourceDir=staging</DefineConstants>
              <Platforms>x64</Platforms>
              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="WixToolset.Util.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.Firewall.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.UI.wixext" Version="4.0.5" />
            </ItemGroup>
            <ItemGroup>
              <Compile Include="Product_WithService.wxs" />
            </ItemGroup>
          </Project>
          "@
          Set-Content -Path "Fortuna.wixproj" -Value $wixProjContent -Encoding UTF8

      - name: Build MSI (Inject Version)
        working-directory: build_wix
        run: |
          $version = "1.0.${{ github.run_number }}.0"
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=$version

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer
          path: build_wix/bin/x64/Release/*.msi
          if-no-files-found: error

  # ============================================================================
  # JOB 4: RELEASE
  # ============================================================================
  create-release:
    name: 'üöÄ Create Release'
    needs: [package-msi-service]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          name: fortuna-installer
          path: dist
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.msi
          generate_release_notes: true
