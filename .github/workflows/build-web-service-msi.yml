name: Build Fortuna Faucet MSI (Web Service) - PRODUCTION

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  PYTHONUTF8: "1"
  FORTUNA_PORT: 8000
  FORTUNA_MODE: webservice

jobs:
  build-frontend:
    name: 'üì¶ Build Frontend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_service/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          cd web_service/frontend
          npm ci
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          if (-not (Test-Path 'web_service/frontend/out/index.html')) { throw "‚ùå Missing index.html" }
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web_service/frontend/out
          retention-days: 1

  build-and-test:
    name: 'üêç Build & Smoke Test'
    needs: [build-frontend]
    runs-on: windows-latest
    env:
      SMOKE_FRONTEND_URL: "http://localhost:${{ env.FORTUNA_PORT }}"
      SMOKE_HEADING_SELECTOR: "h1"
      SMOKE_SCREENSHOT_PATH: "smoke-test.png"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: web_service/frontend/out

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install playwright pytest-playwright

      - name: Get Playwright Version
        id: playwright-version
        shell: pwsh
        run: echo "VERSION=$(python -c 'from importlib.metadata import version; print(version("playwright"))')" >> $env:GITHUB_OUTPUT

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: C:\Users\runneradmin\AppData\Local\ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.VERSION }}

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: python -m playwright install --with-deps chromium

      - name: Create Web Service PyInstaller Spec
        shell: pwsh
        run: |
          cp fortuna-backend-electron.spec fortuna-webservice.spec
          (Get-Content fortuna-webservice.spec) -replace 'python_service/main.py', 'web_service/backend/main.py' | Set-Content fortuna-webservice.spec
          (Get-Content fortuna-webservice.spec) -replace 'python_service/data', 'web_service/backend/data' | Set-Content fortuna-webservice.spec
          (Get-Content fortuna-webservice.spec) -replace 'python_service/json', 'web_service/backend/json' | Set-Content fortuna-webservice.spec
          (Get-Content fortuna-webservice.spec) -replace 'python_service/adapters', 'web_service/backend/adapters' | Set-Content fortuna-webservice.spec
          (Get-Content fortuna-webservice.spec) -replace 'fortuna-backend', 'fortuna-webservice' | Set-Content fortuna-webservice.spec

      - name: Backend - Build with PyInstaller
        run: pyinstaller fortuna-webservice.spec --clean --noconfirm

      - name: 'üîí Open Firewall'
        shell: pwsh
        run: New-NetFirewallRule -DisplayName "SmokeTest" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}

      - name: Run Backend (Background)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "data" -Force | Out-Null
          New-Item -ItemType Directory -Path "logs" -Force | Out-Null
          New-Item -ItemType Directory -Path "json" -Force | Out-Null

          Write-Host "üìÅ Runtime directories created."

          $env:FORTUNA_PORT = "${{ env.FORTUNA_PORT }}"
          $env:FORTUNA_MODE = "${{ env.FORTUNA_MODE }}"

          $p = Start-Process -FilePath "dist/fortuna-webservice.exe" -PassThru -RedirectStandardOutput "backend.log" -RedirectStandardError "backend.err"
          $p.Id | Out-File "backend.pid"

          Write-Host "üöÄ Service started with PID $($p.Id) on port $env:FORTUNA_PORT"

          Start-Sleep -Seconds 5

      - name: 'üì∏ Playwright Verification'
        shell: pwsh
        run: |
          $script = @"
          import sys, os, time
          from playwright.sync_api import sync_playwright, expect

          url = os.environ["SMOKE_FRONTEND_URL"]
          print(f"Testing URL: {url}")

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()
              try:
                  for i in range(10):
                      try:
                          page.goto(url, wait_until='domcontentloaded', timeout=5000)
                          break
                      except:
                          print(f"Waiting for server... ({i+1}/10)")
                          time.sleep(2)

                  expect(page.locator("body")).to_be_visible(timeout=10000)
                  page.screenshot(path=os.environ["SMOKE_SCREENSHOT_PATH"])
                  print("‚úÖ Screenshot captured.")
              except Exception as e:
                  print(f"‚ùå Error: {e}")
                  page.screenshot(path="FAILURE.png")
                  sys.exit(1)
              finally:
                  browser.close()
          "@
          Set-Content -Path "verify.py" -Value $script
          python verify.py

      - name: Upload Screenshot & Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-evidence
          path: |
            *.png
            backend.log
            backend.err

      - name: 'üïµÔ∏è Inspect Backend Logs (On Failure)'
        if: failure()
        shell: pwsh
        run: |
          Write-Host "::group::Backend Error Log (Why did it crash?)"
          if (Test-Path "backend.err") { Get-Content "backend.err" } else { Write-Host "No error log found." }
          Write-Host "::endgroup::"

          Write-Host "::group::Backend Output Log"
          if (Test-Path "backend.log") { Get-Content "backend.log" }
          Write-Host "::endgroup::"

      - name: Upload Validated EXE
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable
          path: dist/fortuna-webservice.exe

      - name: Cleanup Firewall & Process
        if: always()
        shell: pwsh
        run: |
          if (Test-Path "backend.pid") { Stop-Process -Id (Get-Content "backend.pid") -Force -ErrorAction SilentlyContinue }
          Remove-NetFirewallRule -DisplayName "SmokeTest" -ErrorAction SilentlyContinue

  package-msi-service:
    name: 'üì¶ Package Web Service MSI'
    needs: [build-and-test]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Validated Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable
          path: build_wix/staging

      - name: Setup .NET 8 (for WiX)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Remove Conflicting WXS
        shell: pwsh
        run: |
           if (Test-Path "build_wix/Product_WithoutService.wxs") { Remove-Item "build_wix/Product_WithoutService.wxs" -Force }
           if (Test-Path "build_wix/Product_WithService.wxs") { Remove-Item "build_wix/Product_WithService.wxs" -Force }

      - name: Copy WXS File
        shell: pwsh
        run: cp wix/product_webservice.wxs build_wix/Product_WithService.wxs

      - name: Generate WiX Project File (Dynamic Name)
        working-directory: build_wix
        shell: pwsh
        run: |
          $msiName = "Fortuna-WebService-${{ github.run_number }}"

          $wixProjContent = @"
          <Project Sdk="WixToolset.Sdk/4.0.5">
            <PropertyGroup>
              <OutputName>$msiName</OutputName>
              <OutputType>Package</OutputType>
              <DefineConstants>SourceDir=staging</DefineConstants>
              <Platforms>x64</Platforms>
              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="WixToolset.Util.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.Firewall.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.UI.wixext" Version="4.0.5" />
            </ItemGroup>
            <ItemGroup>
              <Compile Include="Product_WithService.wxs" />
            </ItemGroup>
          </Project>
          "@
          Set-Content -Path "Fortuna.wixproj" -Value $wixProjContent -Encoding UTF8

      - name: Build MSI (Inject Version)
        working-directory: build_wix
        run: |
          $version = "1.0.${{ github.run_number }}.0"
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=$version

      - name: Verify MSI
        shell: pwsh
        run: if (-not (Test-Path "bin/x64/Release/*.msi")) { throw "‚ùå MSI build failed" }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer
          path: build_wix/bin/x64/Release/*.msi
          if-no-files-found: error

  create-release:
    name: 'üöÄ Create Release'
    needs: [package-msi-service]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download MSI
        uses: actions/download-artifact@v4
        with:
          name: fortuna-installer
          path: dist
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.msi
          generate_release_notes: true
