name: Build Fortuna Faucet MSI (WiX v4) - üèÜ PRODUCTION

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'
  PYTHONUTF8: "1"

jobs:
  # ============================================================================
  # JOB 1: BUILD FRONTEND
  # ============================================================================
  build-frontend:
    name: 'üì¶ Build Frontend'
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'web_platform/frontend/package-lock.json'
      - name: Frontend - Install & Build
        shell: pwsh
        run: |
          cd web_platform/frontend
          npm ci
          npm run build
      - name: Verify Frontend Build
        shell: pwsh
        run: |
          $outDir = 'web_platform/frontend/out'
          if (-not (Test-Path $outDir)) { throw "‚ùå FATAL: Build output directory 'out' not created" }
          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count
          if ($fileCount -eq 0) { throw "‚ùå FATAL: Build output directory is empty" }
          Write-Host "‚úÖ Frontend build verified ($fileCount files)" -ForegroundColor Green
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: web_platform/frontend/out
          retention-days: 1

  # ============================================================================
  # JOB 2: BUILD BACKEND (Bundles Frontend)
  # ============================================================================
  build-backend:
    name: 'üêç Build Backend'
    needs: [build-frontend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'python_service/requirements.txt'
      - name: Create Staging Directory for UI
        shell: pwsh
        run: New-Item -ItemType Directory -Path "staging/ui" -Force | Out-Null
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: staging/ui
      - name: Install Python Dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r python_service/requirements-dev.txt
      - name: Create Missing Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "python_service/data" -Force | Out-Null
          New-Item -ItemType Directory -Path "python_service/json" -Force | Out-Null
      - name: Backend - Build with PyInstaller
        shell: pwsh
        run: pyinstaller fortuna-backend-webservice.spec --noconfirm
      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-executable
          path: dist/fortuna-backend.exe
          retention-days: 1

  # ============================================================================
  # JOB 2B: SMOKE TEST BACKEND
  # ============================================================================
  smoke-test-backend:
    name: 'üî• Smoke Test Backend'
    needs: [build-backend]
    runs-on: windows-latest
    env:
      FORTUNA_MODE: webservice
    steps:
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable
          path: ./dist
      - name: Run Backend and Test
        shell: pwsh
        run: |
          $stdOutLog = "backend-out.log"
          $stdErrLog = "backend-err.log"
          Start-Process -FilePath "./dist/fortuna-backend.exe" -RedirectStandardOutput $stdOutLog -RedirectStandardError $stdErrLog
          Write-Host "Waiting for backend to become available..."
          $timeout = New-TimeSpan -Seconds 30
          $stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
          $healthCheckPassed = $false
          while ($stopwatch.Elapsed -lt $timeout) {
              try {
                  $response = Invoke-WebRequest -Uri "http://127.0.0.1:8000/" -UseBasicParsing -TimeoutSec 2
                  if ($response.StatusCode -eq 200) {
                      Write-Host "‚úÖ Health check passed!" -ForegroundColor Green
                      $healthCheckPassed = $true
                      break
                  }
              } catch {
                  Write-Host "  - Backend not ready yet, retrying in 3 seconds..."
              }
              Start-Sleep -Seconds 3
          }
          $stopwatch.Stop()
          if (-not $healthCheckPassed) {
              Write-Host "‚ùå FATAL: Backend health check timed out after $($timeout.TotalSeconds) seconds." -ForegroundColor Red
              if (Test-Path $stdOutLog) {
                  Write-Host "--- Backend Standard Output ---"
                  Get-Content $stdOutLog
                  Write-Host "--- End of Standard Output ---"
              }
              if (Test-Path $stdErrLog) {
                  Write-Host "--- Backend Standard Error ---"
                  Get-Content $stdErrLog
                  Write-Host "--- End of Standard Error ---"
              }
              throw "Backend health check failed."
          }
          $process = Get-Process -Name "fortuna-backend" -ErrorAction SilentlyContinue
          if ($process) {
              Stop-Process -Name "fortuna-backend" -Force
          }

  # ============================================================================
  # JOB 3A: PACKAGE SERVICE MSI
  # ============================================================================
  package-msi-service:
    name: 'üíø Package Service MSI'
    needs: [smoke-test-backend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable
          path: ./dist
      - name: Stage Artifacts
        id: stage_files
        shell: pwsh
        run: |
          $staging = "build_wix/staging"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Move-Item -Path "./dist/fortuna-backend.exe" -Destination "$staging/fortuna-backend.exe" -Force
          $msiName = "Fortuna-WebService-${{ github.ref_name }}.msi".Replace('/', '-')
          if ($msiName -match "main") { $msiName = "Fortuna-WebService-Nightly.msi" }
          echo "msi_name=$msiName" >> $env:GITHUB_OUTPUT
      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Harvest Frontend Files
        working-directory: build_wix/harvester
        shell: pwsh
        run: dotnet build harvest.wixproj -c Release -p:Platform=x64
      - name: Verify Harvested File
        shell: pwsh
        run: |
          $harvestedFile = "build_wix/frontend_components.wxs"
          if (-not (Test-Path $harvestedFile)) {
            throw "‚ùå FATAL: Harvested file '$harvestedFile' was not created."
          }
          Write-Host "‚úÖ WiX harvester ran successfully." -ForegroundColor Green
      - name: Generate WiX Project File
        working-directory: build_wix
        shell: pwsh
        run: |
          $msiOutputName = "${{ steps.stage_files.outputs.msi_name }}".Replace('.msi', '')
          $wixProjContent = @"
          <Project Sdk="WixToolset.Sdk/4.0.5">
            <PropertyGroup>
              <OutputName>$msiOutputName</OutputName>
              <OutputType>Package</OutputType>
              <DefineConstants>SourceDir=staging</DefineConstants>
              <Platforms>x64</Platforms>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="WixToolset.Util.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.Firewall.wixext" Version="4.0.5" />
            </ItemGroup>
            <ItemGroup>
              <Compile Include="Product_WithService.wxs" />
              <Compile Include="frontend_components.wxs" />
            </ItemGroup>
          </Project>
          "@
          Set-Content -Path "Fortuna.wixproj" -Value $wixProjContent -Encoding UTF8
      - name: Build MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64
          $msiPath = "bin/x64/Release/${{ steps.stage_files.outputs.msi_name }}"
          if (-not (Test-Path $msiPath)) { throw "‚ùå Service MSI was not created." }
          New-Item -ItemType Directory -Path "dist" -Force | Out-Null
          Copy-Item -Path $msiPath -Destination "dist/" -Force
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer-service
          path: build_wix/dist/*.msi
          retention-days: 1

  # ============================================================================
  # JOB 3B: PACKAGE STANDALONE MSI
  # ============================================================================
  package-msi-standalone:
    name: 'üíø Package Standalone MSI'
    needs: [smoke-test-backend]
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Download Backend Executable
        uses: actions/download-artifact@v4
        with:
          name: backend-executable
          path: ./dist
      - name: Stage Artifacts
        id: stage_files
        shell: pwsh
        run: |
          $staging = "build_wix/staging"
          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Move-Item -Path "./dist/fortuna-backend.exe" -Destination "$staging/fortuna-backend.exe" -Force
          $msiName = "Fortuna-Standalone-${{ github.ref_name }}.msi".Replace('/', '-')
          if ($msiName -match "main") { $msiName = "Fortuna-Standalone-Nightly.msi" }
          echo "msi_name=$msiName" >> $env:GITHUB_OUTPUT
      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Generate WiX Project File
        working-directory: build_wix
        shell: pwsh
        run: |
          $msiOutputName = "${{ steps.stage_files.outputs.msi_name }}".Replace('.msi', '')
          $wixProjContent = @"
          <Project Sdk="WixToolset.Sdk/4.0.5">
            <PropertyGroup>
              <OutputName>$msiOutputName</OutputName>
              <OutputType>Package</OutputType>
              <DefineConstants>SourceDir=staging</DefineConstants>
              <Platforms>x64</Platforms>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="WixToolset.UI.wixext" Version="4.0.5" />
              <PackageReference Include="WixToolset.Util.wixext" Version="4.0.5" />
            </ItemGroup>
            <ItemGroup>
              <Compile Include="Product_WithoutService.wxs" />
            </ItemGroup>
          </Project>
          "@
          Set-Content -Path "Fortuna.wixproj" -Value $wixProjContent -Encoding UTF8
      - name: Build MSI
        working-directory: build_wix
        shell: pwsh
        run: |
          dotnet build Fortuna.wixproj -c Release -p:Platform=x64
          $msiPath = "bin/x64/Release/${{ steps.stage_files.outputs.msi_name }}"
          if (-not (Test-Path $msiPath)) { throw "‚ùå Standalone MSI was not created." }
          New-Item -ItemType Directory -Path "dist" -Force | Out-Null
          Copy-Item -Path $msiPath -Destination "dist/" -Force
      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fortuna-installer-standalone
          path: build_wix/dist/*.msi
          retention-days: 1

  # ============================================================================
  # JOB 4: CREATE GITHUB RELEASE (TAGS ONLY)
  # ============================================================================
  create-release:
    name: 'üöÄ Create GitHub Release'
    needs: [package-msi-service, package-msi-standalone]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download All MSI Artifacts
        uses: actions/download-artifact@v4
        with:
          path: installers/
      - name: List downloaded files
        run: ls -R installers/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: installers/*/*.msi
          body: |
            üèÜ **Fortuna Faucet Production Release**
            - Native Windows Service Installer
            - Standalone Executable Installer
          draft: false
          prerelease: false
