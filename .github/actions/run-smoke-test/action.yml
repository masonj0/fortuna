name: 'Run 4-Step Diagnostic Smoke Test'
description: 'Installs an MSI, then runs a 4-step diagnostic to verify file installation, service status, port binding, and API health, finishing with a Paparazzi screenshot.'

inputs:
  msi-artifact-name:
    description: 'The name of the MSI artifact to download.'
    required: true
  service-name:
    description: 'The name of the Windows Service to verify (e.g., FortunaWebService).'
    required: true
  executable-path:
    description: 'The full, absolute path to the installed service executable to verify.'
    required: true
  port:
    description: 'The port to check for a listener.'
    required: true
  firewall-rule-name:
    description: 'The name of the firewall rule to create.'
    required: true

runs:
  using: "composite"
  steps:
    - name: ðŸ“¥ Download MSI Artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.msi-artifact-name }}
        path: installer

    - name: ðŸ›¡ï¸ Firewall & Install
      shell: pwsh
      run: |
        New-NetFirewallRule -DisplayName "${{ inputs.firewall-rule-name }}" -Direction Inbound -LocalPort ${{ inputs.port }} -Protocol TCP -Action Allow
        if (Get-Service -Name "${{ inputs.service-name }}" -ErrorAction SilentlyContinue) {
          sc.exe stop "${{ inputs.service-name }}" 2>&1 | Out-Null
          sc.exe delete "${{ inputs.service-name }}" 2>&1 | Out-Null
        }
        $msi = Get-ChildItem installer -Filter "*.msi" -Recurse | Select-Object -First 1
        if (!$msi) { throw "No MSI found" }
        Write-Host "Installing $($msi.Name)..."
        $msiPath = $msi.FullName
        $args = "/i `"$msiPath`" /qn /L*v installation.log"
        $proc = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru
        if ($proc.ExitCode -ne 0) {
          Get-Content installation.log -Tail 50
          throw "Install failed with code $($proc.ExitCode)"
        }

    - name: "âœ… Create Required Runtime Directories Post-Install"
      shell: pwsh
      run: |
        $installRoot = Split-Path -Path "${{ inputs.executable-path }}" -Parent
        if (-not (Test-Path $installRoot)) {
          Write-Error "Installation directory not found at $installRoot. Cannot create runtime directories."
          exit 1
        }
        New-Item -Path "$installRoot\data" -ItemType Directory -Force | Out-Null
        New-Item -Path "$installRoot\json" -ItemType Directory -Force | Out-Null
        New-Item -Path "$installRoot\logs" -ItemType Directory -Force | Out-Null
        Write-Host "âœ… Created data, json, and logs directories in $installRoot"

    - name: 'ðŸ”¬ Complete Smoke Test (3-Layer Defense)'
      shell: pwsh
      run: |
        Set-StrictMode -Version Latest
        $ErrorActionPreference = "Stop"

        # --- LAYER 1: INSTALLATION & FILE VERIFICATION ---
        Write-Host "`n--- DEFENSE LAYER 1: VERIFYING INSTALLATION ---"
        $installRoot = Split-Path -Path "${{ inputs.executable-path }}" -Parent
        if (-not (Test-Path $installRoot)) {
          Write-Error "âŒ LAYER 1 FAILED: Install directory not found: $installRoot"
          exit 1
        }
        $mainExe = Get-ChildItem -Path $installRoot -Filter "*.exe" -Recurse | Where-Object { $_.Name -notmatch 'uninstall' } | Select -First 1
        if (-not $mainExe) { Write-Error "âŒ LAYER 1 FAILED: Main executable not found."; exit 1 }
        Write-Host "âœ… Layer 1 Passed: Found main executable ($($mainExe.Name))."

        # --- LAYER 2: PROCESS VERIFICATION ---
        Write-Host "`n--- DEFENSE LAYER 2: VERIFYING PROCESS STARTUP ---"
        $svc = Get-Service "${{ inputs.service-name }}" -ErrorAction SilentlyContinue
        if (!$svc) {
          Write-Error "âŒ LAYER 2 FAILED: Service '${{ inputs.service-name }}' is NOT registered!"
          exit 1
        }
        if ($svc.Status -ne 'Running') {
          Start-Service "${{ inputs.service-name }}"
          Start-Sleep -Seconds 10
        }
        $svc = Get-Service "${{ inputs.service-name }}"
        if ($svc.Status -ne 'Running') {
          Write-Error "âŒ LAYER 2 FAILED: Service failed to start. Status: $($svc.Status)"
          Get-EventLog -LogName System -Source "Service Control Manager" -Newest 20 | Format-Table -AutoSize
          exit 1
        }
        Write-Host "âœ… Layer 2 Passed: Service is RUNNING."

        # Inserted Backend Alive Check
        Write-Host "--- Verifying backend process stability (10s alive check) ---"
        Start-Sleep -Seconds 10
        $svcProcess = Get-CimInstance win32_service | where name -eq "${{ inputs.service-name }}" | select -ExpandProperty ProcessId
        if ($null -eq (Get-Process -Id $svcProcess -ErrorAction SilentlyContinue)) {
          Write-Error "âŒ Backend process crashed within 10 seconds of starting."
          exit 1
        }
        Write-Host "âœ… Backend process is still alive."

        # --- LAYER 3: NETWORK VERIFICATION ---
        Write-Host "`n--- DEFENSE LAYER 3: VERIFYING NETWORK ENDPOINT ---"
        $maxAttempts = 10
        $healthUrl = "http://localhost:${{ inputs.port }}/health"
        for ($i = 1; $i -le $maxAttempts; $i++) {
          try {
            Write-Host "Attempt $i/${maxAttempts}: Pinging $healthUrl..."
            $response = Invoke-WebRequest -Uri $healthUrl -Method Get -UseBasicParsing -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ…âœ…âœ… SMOKE TEST PASSED ALL 3 DEFENSE LAYERS âœ…âœ…âœ…"
              exit 0
            }
          } catch {
            Write-Host "â³ Waiting for service..."
            Start-Sleep -Seconds 5
          }
        }
        Write-Error "âŒ LAYER 3 FAILED: Service Failed Health Check after $maxAttempts attempts"
        exit 1

    - name: 'ðŸ“¸ The Paparazzi (Visual Proof)'
      shell: pwsh
      run: |
        Write-Host "Installing Playwright..."
        npm install playwright
        npx playwright install chromium --with-deps

        $url = "http://127.0.0.1:${{ inputs.port }}/docs"

        node -e "
          const { chromium } = require('playwright');
          (async () => {
            try {
              const browser = await chromium.launch();
              const page = await browser.newPage();
              await page.goto('$url', { timeout: 15000 });
              await page.waitForSelector('.swagger-ui', { timeout: 5000 }).catch(() => console.log('UI not fully loaded, snapping anyway...'));
              await page.screenshot({ path: 'proof-of-life.png', fullPage: true });
              await browser.close();
            } catch (e) {
              console.error(e); process.exit(1);
            }
          })();
        "

    - name: Upload Visual Proof
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: visual-proof-${{ github.run_id }}
        path: proof-of-life.png

    - name: ðŸ§¹ Cleanup
      if: always()
      shell: pwsh
      run: |
        sc.exe stop ${{ inputs.service-name }}
        sc.exe delete ${{ inputs.service-name }}
        Remove-NetFirewallRule -DisplayName "${{ inputs.firewall-rule-name }}" -ErrorAction SilentlyContinue
