name: 'Run ASGI Import Killer Diagnostics'
description: 'Runs a multi-phase diagnostic to verify Python ASGI application imports.'

inputs:
  python-version:
    description: 'The version of Python to use.'
    required: true
  backend-dir:
    description: 'The directory of the backend service to test.'
    required: true
  backend-module-path:
    description: 'The Python module path for the backend service (e.g., web_service.backend).'
    required: true

runs:
  using: "composite"
  steps:
      - name: âš™ï¸ Setup Python (EXACT VERSION)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: ğŸ“‹ Capture Python Info
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          Write-Host "Python executable: $(which python)" -ForegroundColor Cyan
          python --version
          python -m site
          python -c "import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)"

      - name: ğŸ“¥ Install Requirements (Exactly as Backend Build)
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          python -m pip install --upgrade pip setuptools wheel --quiet

          Write-Host "Installing requirements.txt..." -ForegroundColor Cyan
          pip install -r (Join-Path "${{ inputs.backend-dir }}" "requirements.txt") -v 2>&1 | Tee-Object "install-requirements.log"

          if (Test-Path (Join-Path "${{ inputs.backend-dir }}" "requirements-dev.txt")) {
            Write-Host "Installing requirements-dev.txt..." -ForegroundColor Cyan
            pip install -r (Join-Path "${{ inputs.backend-dir }}" "requirements-dev.txt") -v 2>&1 | Tee-Object -Append "install-requirements.log"
          }

          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ pip install failed" -ForegroundColor Red
            exit 1
          }

          Write-Host "âœ… All dependencies installed" -ForegroundColor Green

      - name: ğŸ“¦ Capture Installed Packages
        shell: pwsh
        run: |
          pip list | Tee-Object "installed-packages.txt"
          pip freeze | Tee-Object "pip-freeze.txt"

      - name: ğŸ Set PYTHONPATH
        shell: pwsh
        run: |
          echo "PYTHONPATH=${{ github.workspace }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "PYTHONPATH set to ${{ github.workspace }}"

      - name: ğŸ§ª PHASE 1 System Imports
        shell: pwsh
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 1 SYSTEM-LEVEL IMPORTS")',
            'print("="*80)',
            'modules = [',
            "    ('os', 'filesystem'), ('sys', 'system'), ('json', 'serialization'),",
            "    ('asyncio', 'async I/O'), ('pathlib', 'paths'), ('typing', 'type hints'),",
            "    ('importlib', 'import utilities')",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:20} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:20} ImportError: {e}")',
            '        failed.append(mod_name)',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} system imports failed")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 1 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 2 Web Framework Core
        shell: pwsh
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'print("\n" + "="*80)',
            'print("PHASE 2 WEB FRAMEWORK CORE")',
            'print("="*80)',
            'modules = [',
            "    ('fastapi', 'web framework'),",
            "    ('uvicorn', 'ASGI server'),",
            "    ('starlette', 'ASGI toolkit'),",
            "    ('starlette.applications', 'ASGI app'),",
            "    ('starlette.routing', 'routing'),",
            ']',
            'failed = []',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except ImportError as e:',
            '        print(f"âŒ {mod_name:30} ImportError: {e}")',
            '        failed.append((mod_name, str(e)))',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} {type(e).__name__}: {e}")',
            'if failed:',
            '    print(f"\nâŒ {len(failed)} core framework imports failed")',
            '    for mod, err in failed:',
            '        print(f"  - {mod}")',
            '    sys.exit(1)',
            'print(f"\nâœ… Phase 2 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 3 Pydantic & Data Validation
        shell: pwsh
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 3 PYDANTIC & DATA VALIDATION")',
            'print("="*80)',
            'modules = [',
            "    ('pydantic', 'validation'),",
            "    ('pydantic_core', 'core'),",
            "    ('pydantic_settings', 'settings'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 3 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 4 Async/IO Utilities
        shell: pwsh
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 4 ASYNC/IO UTILITIES")',
            'print("="*80)',
            'modules = [',
            "    ('anyio', 'async compat'),",
            "    ('httpcore', 'HTTP core'),",
            "    ('httpx', 'HTTP client'),",
            "    ('aiosqlite', 'async DB'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âŒ {mod_name:30} {type(e).__name__}: {e}")',
            '        sys.exit(1)',
            'print(f"\nâœ… Phase 4 complete")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: ğŸ§ª PHASE 5 Optional Dependencies (non-critical)
        shell: pwsh
        continue-on-error: true
        run: |
          $script = @(
            'import sys',
            'print("\n" + "="*80)',
            'print("PHASE 5 OPTIONAL DEPENDENCIES (non-critical)")',
            'print("="*80)',
            'modules = [',
            "    ('slowapi', 'rate limiting'),",
            "    ('structlog', 'logging'),",
            "    ('tenacity', 'retries'),",
            ']',
            'for mod_name, desc in modules:',
            '    try:',
            '        __import__(mod_name)',
            '        print(f"âœ… {mod_name:30} [{desc}]")',
            '    except Exception as e:',
            '        print(f"âš ï¸  {mod_name:30} not critical: {type(e).__name__}")',
            'print(f"\nâœ… Phase 5 complete (warnings OK)")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 6 Application Directory Structure
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest

          $script = @(
            'import os',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 6 APPLICATION DIRECTORY STRUCTURE")',
            'print("="*80)',
            'cwd = Path.cwd()',
            'backend_dir = cwd / "${{ inputs.backend-dir }}"',
            'print(f"\nCurrent directory: {cwd}")',
            'print(f"\nBackend directory exists: {backend_dir.exists()}")',
            'if backend_dir.exists():',
            '    print(f"  Contents:")',
            '    for item in backend_dir.iterdir():',
            '        print(f"    - {item.name}")',
            '    main_py = backend_dir / "main.py"',
            '    api_py = backend_dir / "api.py"',
            '    print(f''\n  main.py: {main_py.stat().st_size if main_py.exists() else "N/A"} bytes'')',
            '    print(f''  api.py: {api_py.stat().st_size if api_py.exists() else "N/A"} bytes'')'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py

      - name: ğŸ§ª PHASE 7 CRITICAL - Application Module Imports
        shell: pwsh
        run: |
          $script = @(
            'import sys',
            'import traceback',
            'import importlib',
            'from pathlib import Path',
            'print("\n" + "="*80)',
            'print("PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)")',
            'print("="*80)',
            'backend_module_path = "${{ inputs.backend-module-path }}"',
            'print(f"\n[Step 1] Dynamically importing module: {backend_module_path}")',
            'try:',
            '    backend_module = importlib.import_module(backend_module_path)',
            '    print(f"âœ… {backend_module_path} imported successfully")',
            'except Exception as e:',
            '    print(f"âŒ FATAL: {backend_module_path} import failed")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print(''\\n[Step 2] Retrieving "app" object from the API submodule...'')',
            'api_module_path = f"{backend_module_path}.api"',
            'try:',
            '    api_module = importlib.import_module(api_module_path)',
            '    app = getattr(api_module, "app")',
            '    print(f"âœ… app object retrieved from {api_module_path}")',
            '    print(f"   Type: {type(app)}")',
            '    print(f"   Class: {app.__class__.__name__}")',
            '    print(f"   Module: {app.__class__.__module__}")',
            'except (ImportError, AttributeError) as e:',
            '    print(f"âŒ FATAL: Could not get app object from {api_module_path}")',
            '    print(f"   Error: {type(e).__name__}: {e}")',
            '    traceback.print_exc()',
            '    sys.exit(1)',
            'print("\n" + "="*80)',
            'print("âœ… ALL APPLICATION IMPORTS SUCCESSFUL")',
            'print("="*80)',
            'print("\nThe ASGI app is fully importable.")',
            'print("Uvicorn should be able to load it successfully.")'
          )
          $script | Out-File -FilePath "diag_script.py" -Encoding utf8
          python diag_script.py
          if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ APPLICATION IMPORT TEST FAILED" -ForegroundColor Red
            exit 1
          }

      - name: ğŸ“‹ Generate ASGI Diagnostic Report
        if: always()
        shell: pwsh
        run: |
          Set-StrictMode -Version Latest
          $report = @()
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report += "â•‘              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        â•‘"
          $report += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          $report += ""
          $report += "Timestamp: $(Get-Date -Format 'o')"
          $report += "Python: $(python --version)"
          $report += ""
          $report += "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          $result = if ($LASTEXITCODE -eq 0) { 'PASS âœ…' } else { 'FAIL âŒ' }
          $report += "â”‚ RESULT: $result â”‚"
          $report += "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          $report += ""
          $report += "If this passed:"
          $report += "  âœ… All required dependencies are installed"
          $report += "  âœ… python_service.main is importable"
          $report += "  âœ… FastAPI app is accessible"
          $report += "  âœ… The executable should work"
          $report += "  âœ… Uvicorn WILL be able to load the app"
          $report += ""
          $report += "If this failed:"
          $report += "  âŒ See error output above for the exact problem"
          $report += "  âŒ Fix the import error in your code"
          $report += "  âŒ Common issues:"
          $report += "     - Missing dependency in requirements.txt"
          $report += "     - Syntax error in api.py or main.py"
          $report += "     - Circular import in api.py"
          $report += "     - api.py imports a module that fails"
          $report += ""
          $report += "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          $report | Tee-Object "asgi-diagnostic-report.txt"

      - name: ğŸ“¤ Upload Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asgi-import-diagnostics-${{ github.run_id }}
          path: |
            install-requirements.log
            installed-packages.txt
            pip-freeze.txt
            asgi-diagnostic-report.txt
          retention-days: 30
          if-no-files-found: warn
