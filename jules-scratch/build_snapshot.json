{
  ".github/workflows/build-electron-clean-room.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-electron-clean-room.ymlx",
    "content": "name: Electron Clean Room (Refined)\n\non:\n  push:\n    branches: [ \"main\" ]\n  workflow_dispatch:\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  BACKEND_DIR: 'python_service'\n  FRONTEND_DIR: 'web_platform/frontend'\n  ELECTRON_DIR: 'electron'\n\njobs:\n  build-and-package:\n    name: \ud83d\udce6 Build & Package\n    runs-on: windows-latest\n    outputs:\n      semver: ${{ steps.meta.outputs.semver }}\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: \ud83c\udff7\ufe0f Metadata\n        id: meta\n        shell: pwsh\n        run: |\n          $ver = if (\"${{ github.ref }}\" -match 'refs/tags/v(.*)') { $Matches[1] } else { \"0.0.${{ github.run_number }}\" }\n          \"semver=$ver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"Build Version: $ver\"\n\n      # --- BACKEND ---\n      - uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n\n      - name: \ud83d\udc0d Install Python Dependencies\n        run: |\n          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt\n          pip install pyinstaller==6.6.0\n\n      - name: \ud83d\udc0d Build Python Backend\n        shell: pwsh\n        env:\n          BACKEND_DIR: ${{ env.BACKEND_DIR }}\n          PYTHONUTF8: '1'\n        run: python scripts/generate_spec_electron.py\n\n      # --- FRONTEND ---\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: \ud83c\udfa8 Build Frontend\n        shell: pwsh\n        run: |\n          cd ${{ env.FRONTEND_DIR }}\n          npm ci --prefer-offline\n          npm run build\n          # Ensure output exists\n          if (-not (Test-Path \"out\")) { throw \"Frontend build failed to produce 'out' directory\" }\n\n      # --- ELECTRON ---\n      - name: \ud83d\udcc4 Ensure WiX License Exists for electron-builder\n        shell: pwsh\n        run: |\n          # electron-builder uses build_wix/license.rtf by convention\n          $wixDir = 'build_wix'\n          if (-not (Test-Path $wixDir)) { New-Item -ItemType Directory -Path $wixDir | Out-Null }\n          $licensePath = Join-Path $wixDir 'license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder for electron-builder...'\n            $rtfContent = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0\\fs24 END USER LICENSE AGREEMENT\\par\\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: \u26a1 Build Electron MSI\n        shell: pwsh\n        working-directory: ${{ env.ELECTRON_DIR }}\n        env:\n          CSC_IDENTITY_AUTO_DISCOVERY: 'false'\n        run: |\n          npm ci --prefer-offline\n\n          # Dynamic Config Patching (No external YAML parser needed)\n          $config = Get-Content \"electron-builder-config.yml\" -Raw\n          # Ensure icon path is correct (simple string replace if needed, or rely on relative paths)\n\n          $artifactName = \"Fortuna-Electron-${{ steps.meta.outputs.semver }}.msi\"\n\n          npm run dist -- --win msi --config electron-builder-config.yml --publish never --config.artifactName=$artifactName\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        continue-on-error: true\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: \ud83d\udce4 Upload MSI\n        uses: actions/upload-artifact@v4\n        with:\n          name: electron-msi\n          path: ${{ env.ELECTRON_DIR }}/dist/*.msi\n          retention-days: 1\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test'\n    runs-on: windows-latest\n    needs: build-and-package\n    steps:\n      - name: \ud83d\udce5 Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          name: electron-msi\n          path: installer\n\n      - name: \ud83e\udd2b Install & Verify\n        shell: pwsh\n        run: |\n          $msi = Get-ChildItem \"installer\" -Filter \"*.msi\" -Recurse | Select -First 1\n          if (!$msi) { throw \"No MSI found\" }\n\n          Write-Host \"Installing $($msi.Name)...\"\n          $proc = Start-Process msiexec.exe -ArgumentList \"/i `\"$($msi.FullName)`\" /qn /L*v install.log\" -Wait -PassThru\n\n          if ($proc.ExitCode -ne 0) {\n            Get-Content install.log -Tail 50\n            throw \"Install failed with code $($proc.ExitCode)\"\n          }\n\n      - name: \ud83d\ude80 Launch & Wait (Dual Process)\n        shell: pwsh\n        run: |\n          # Dynamic Executable Finding (Robust)\n          $root = 'C:\\\\Program Files\\\\Fortuna Faucet'\n          if (-not (Test-Path $root)) { throw \"Install directory not found at $root\" }\n\n          $exe = Get-ChildItem $root -Filter \"*.exe\" -Recurse | Where { $_.Name -notmatch 'uninstall' } | Select -First 1\n          if (!$exe) { throw \"Executable not found in $root\" }\n\n          Write-Host \"Launching: $($exe.FullName)\"\n          # FIX: Add --no-sandbox to prevent Electron crash on headless CI\n          $proc = Start-Process -FilePath $exe.FullName -ArgumentList \"--no-sandbox\" -PassThru\n\n          Write-Host \"Waiting for Electron + Python processes to stabilize (up to 120s)...\"\n          $deadline = (Get-Date).AddSeconds(120)\n\n          while ((Get-Date) -lt $deadline) {\n              $p = Get-Process | Where { $_.ProcessName -like \"*Fortuna*\" }\n              $e = $p | Where { $_.ProcessName -match \"Fortuna Faucet\" }\n              $b = $p | Where { $_.ProcessName -match \"fortuna-backend\" }\n\n              if ($e) { Write-Host \" - Electron is running (PID: $($e.Id))\" }\n              if ($b) { Write-Host \" - Backend is running (PID: $($b.Id))\" }\n\n              if ($e -and $b) {\n                  Write-Host \"\u2705 SUCCESS: App and Backend are running.\"\n                  exit 0\n              }\n              Start-Sleep 2\n          }\n\n          Write-Error \"\u274c TIMEOUT: Processes did not stabilize.\"\n          Write-Host \"--- Process Dump (Fortuna) ---\"\n          Get-Process | Where { $_.ProcessName -like \"*Fortuna*\" } | Format-Table\n          Write-Host \"--- Full Process List (Top 20 Memory) ---\"\n          Get-Process | Sort-Object PM -Descending | Select -First 20 | Format-Table\n          exit 1\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        run: Stop-Process -Name \"Fortuna Faucet\", \"fortuna-backend\" -Force -ErrorAction SilentlyContinue\n\n  release:\n    name: '\ud83d\udce6 Release'\n    runs-on: windows-latest\n    needs: smoke-test\n    steps:\n      - name: \ud83d\udce5 Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          name: electron-msi\n          path: staging\n\n      - name: \ud83d\ude9a Robocopy Safe-Stage\n        shell: pwsh\n        run: |\n          $dest = \"final-artifact\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n\n          # The \"Clean Room\" Robocopy Logic\n          robocopy staging $dest /E /np\n\n          # 0-3 = Success. 4+ = Error.\n          if ($LASTEXITCODE -le 3) {\n            Write-Host \"\u2705 Staged successfully.\"\n            exit 0\n          } else {\n            throw \"Robocopy failed with code $LASTEXITCODE\"\n          }\n\n      - name: \ud83d\udce4 Upload Final\n        uses: actions/upload-artifact@v4\n        with:\n          name: Final-Electron-MSI\n          path: final-artifact/\n"
  },
  ".github/workflows/build-electron-from-ws-claude.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-electron-from-ws-claude.ymlx",
    "content": "name: Build Electron App (Claude's Hardened Version)\n\non:\n  push:\n    branches:\n      - deactivated\n  workflow_dispatch:\n\npermissions:\n  contents: read\n  actions: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n\njobs:\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend for Electron'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n      - name: Setup Node.js\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_platform/frontend/package-lock.json'\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          cd web_platform/frontend\n          npm ci --prefer-offline\n          npm run build\n      - name: Verify Frontend Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $outDir = 'web_platform/frontend/out'\n          if (-not (Test-Path $outDir)) { throw \"\u274c FATAL: Build output directory 'out' not created\" }\n          if ((Get-ChildItem -Path $outDir -Recurse -File).Count -eq 0) { throw \"\u274c FATAL: Build output directory is empty\" }\n          Write-Host \"\u2705 Frontend build verified.\"\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: frontend-build-electron-${{ github.run_id }}\n          path: web_platform/frontend/out\n          retention-days: 1\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend for Electron'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n      - name: Setup Python\n        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: 'python_service/requirements-dev.txt'\n      - name: Backend - Install Dependencies\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          python -m pip install --upgrade pip\n          pip install -r python_service/requirements-dev.txt\n      - name: Backend - Build with PyInstaller\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          pyinstaller fortuna-backend-electron.spec --clean --log-level WARN --noconfirm\n      - name: Verify Backend Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $exePath = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exePath)) { throw \"\u274c FATAL: Backend executable not created at $exePath\" }\n          Write-Host \"\u2705 Backend executable verified.\"\n      - name: Upload Backend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: backend-executable-electron-${{ github.run_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 1\n\n  smoke-test-electron:\n    name: '\ud83d\udd2c Smoke Test Electron App'\n    needs: [build-frontend, build-backend]\n    runs-on: windows-latest\n    timeout-minutes: 15\n    env:\n      SMOKE_SCREENSHOT_PATH: \"smoke-test-electron.png\"\n      SMOKE_FAILURE_SCREENSHOT_PATH: \"smoke-test-electron-FAILURE.png\"\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Download Artifacts\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          path: ./temp-artifacts/\n\n      - name: Stage Artifacts for Electron\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          New-Item -ItemType Directory -Path \"electron/resources\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"electron/web-ui-build\" -Force | Out-Null\n\n          $frontendSource = \"./temp-artifacts/frontend-build-electron-${{ github.run_id }}/\"\n          $backendSource = \"./temp-artifacts/backend-executable-electron-${{ github.run_id }}/fortuna-backend.exe\"\n\n          Copy-Item -Path $frontendSource* -Destination \"electron/web-ui-build/\" -Recurse -Force\n          Copy-Item -Path $backendSource -Destination \"electron/resources/fortuna-backend.exe\" -Force\n\n          Write-Host \"\u2705 Frontend and backend artifacts staged for Electron.\"\n\n      - name: Setup Node.js for Electron\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'electron/package-lock.json'\n\n      - name: Install Electron Dependencies\n        working-directory: electron\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          npm ci --prefer-offline\n\n      - name: Install Playwright for Python\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          pip install playwright\n          python -m playwright install chromium\n\n      - name: Verify Electron App with Playwright\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $script = @\"\n          import sys, os, asyncio\n          from playwright.async_api import async_playwright, expect\n\n          async def run_verification():\n              async with async_playwright() as p:\n                  try:\n                      # Correctly launch and connect to the Electron app\n                      app = await p._electron.launch(args=['electron/main.js'])\n                      page = await app.first_window()\n                      await page.wait_for_load_state('domcontentloaded', timeout=30000)\n\n                      # Perform verification on the Electron window content\n                      await expect(page.locator(\"h1:has-text('Fortuna Faucet')\")).to_be_visible(timeout=15000)\n                      await page.screenshot(path=os.environ[\"SMOKE_SCREENSHOT_PATH\"])\n                      print(\"\u2705 Electron UI verification successful\")\n                      await app.close()\n                      sys.exit(0)\n                  except Exception as e:\n                      print(f\"\u274c Error during Electron verification: {e}\", file=sys.stderr)\n                      # No need to take a failure screenshot here as the context might be invalid\n                      if 'app' in locals() and app:\n                          await app.close()\n                      sys.exit(1)\n\n          if __name__ == \"__main__\":\n              asyncio.run(run_verification())\n          \"@\n          Set-Content -Path \"verify_electron.py\" -Value $script\n          python verify_electron.py\n\n      - name: Upload Verification Artifacts\n        if: always()\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: smoke-test-evidence-electron-${{ github.run_id }}\n          path: |\n            ${{ env.SMOKE_SCREENSHOT_PATH }}\n            ${{ env.SMOKE_FAILURE_SCREENSHOT_PATH }}\n            electron/electron-out.log\n            electron/electron-err.log\n          if-no-files-found: warn\n\n      - name: Teardown Electron Process\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path \"electron.pid\") {\n            $pid = Get-Content \"electron.pid\"\n            Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue\n            Write-Host \"\u2705 Stopped Electron process $pid\"\n          }\n\n  package-electron-msi:\n    name: ' MSI Package Electron App'\n    needs: [smoke-test-electron]\n    runs-on: windows-latest\n    timeout-minutes: 25\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Download Validated Artifacts\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          path: ./temp-artifacts/\n\n      - name: Stage Artifacts for Packaging\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          New-Item -ItemType Directory -Path \"electron/resources\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"electron/web-ui-build\" -Force | Out-Null\n          Copy-Item -Path \"./temp-artifacts/frontend-build-electron-${{ github.run_id }}/*\" -Destination \"electron/web-ui-build/\" -Recurse -Force\n          Copy-Item -Path \"./temp-artifacts/backend-executable-electron-${{ github.run_id }}/fortuna-backend.exe\" -Destination \"electron/resources/fortuna-backend.exe\" -Force\n          Write-Host \"\u2705 Artifacts staged for final packaging.\"\n\n      - name: Setup Node.js for Electron Builder\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'electron/package-lock.json'\n\n      - name: Install Dependencies\n        working-directory: electron\n        run: npm ci --prefer-offline\n\n      - name: Package MSI Installer\n        working-directory: electron\n        run: npx electron-builder --win --publish=never\n\n      - name: Verify MSI Creation\n        shell: pwsh\n        run: |\n          $msiFiles = Get-ChildItem -Path \"electron/dist/*.msi\"\n          if ($msiFiles.Count -eq 0) { throw \"\u274c FATAL: No MSI file created\" }\n          Write-Host \"\u2705 MSI installer created successfully.\"\n\n      - name: Upload Final MSI Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: fortuna-installer-electron-claude-${{ github.run_id }}\n          path: electron/dist/*.msi\n          retention-days: 7\n"
  },
  ".github/workflows/build-electron-hybrid.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-electron-hybrid.yml",
    "content": "name:  Build Electron MSI (Hybrid V12 Engine)\n\non:\n  push:\n    branches: [ \"main\" ]\n  workflow_dispatch:\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  # Paths\n  BACKEND_DIR: 'python_service'\n  FRONTEND_DIR: 'web_platform/frontend'\n  ELECTRON_DIR: 'electron'\n  # Mock API keys for service startup\n  API_KEY: mock_key\n  TVG_API_KEY: mock\n  GREYHOUND_API_URL: http://mock\n  FORTUNA_ENV: smoke-test\n\njobs:\n  quality-gate:\n    name: 'Run Tests'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.12'\n      - run: |\n          pip install -r python_service/requirements-dev.txt\n          pytest python_service/tests\n  # ==================================================================================\n  # JOB 1: BUILD CORE (The \"HatTrick\" Engine)\n  # ==================================================================================\n  build-core:\n    name: '\u2699\ufe0f Build Core Components'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    needs: quality-gate\n    outputs:\n      semver: ${{ steps.meta.outputs.semver }}\n      build_id: ${{ steps.meta.outputs.build_id }}\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: \ud83d\udd16 Metadata\n        id: meta\n        shell: pwsh\n        run: |\n          $ver = if (\"${{ github.ref }}\" -match 'refs/tags/v(.*)') { $Matches[1] } else { \"0.0.${{ github.run_number }}\" }\n          \"semver=$ver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"build_id=${{ github.run_id }}\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      # --- FRONTEND (Standard) ---\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: \ud83c\udfa8 Build Frontend\n        shell: pwsh\n        run: |\n          cd ${{ env.FRONTEND_DIR }}\n          npm ci --prefer-offline\n          npm run build\n\n      # --- BACKEND (The \"HatTrick\" Upgrade) ---\n      - uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n\n      - name: \ud83d\udc0d Install Python Dependencies\n        run: |\n          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt\n          pip install pyinstaller==6.6.0\n\n      - name: \ud83d\udce6 Build Python Backend\n        shell: pwsh\n        env:\n          BACKEND_DIR: ${{ env.BACKEND_DIR }}\n          PYTHONUTF8: '1'\n        run: python scripts/generate_spec_electron.py\n\n      - name: \ud83d\udce4 Upload Backend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-build-${{ github.run_id }}\n          path: dist/service/fortuna-backend/\n          retention-days: 1\n\n      - name: \ud83d\udce4 Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_DIR }}/out/\n          retention-days: 1\n\n  # ==================================================================================\n  # JOB 2: PACKAGE ELECTRON (The \"Ironclad\" Chassis)\n  # ==================================================================================\n  package-electron:\n    name: '\u26a1 Package Electron MSI'\n    runs-on: windows-latest\n    needs: build-core\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.ELECTRON_DIR }}/package-lock.json'\n\n      - name: \ud83d\udce5 Download Backend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-build-${{ github.run_id }}\n          path: python-service-bin\n\n      - name: \ud83d\udce5 Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_DIR }}/out\n\n      - name: \ud83d\ude9a Stage Artifacts for Electron\n        shell: pwsh\n        run: |\n          # No staging needed, artifacts are downloaded to the correct locations\n          Write-Host \"Backend and Frontend artifacts downloaded to their respective directories.\"\n\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists for electron-builder\n        shell: pwsh\n        run: |\n          # electron-builder uses build_wix/license.rtf by convention\n          $wixDir = 'build_wix'\n          if (-not (Test-Path $wixDir)) { New-Item -ItemType Directory -Path $wixDir | Out-Null }\n          $licensePath = Join-Path $wixDir 'license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder for electron-builder...'\n            $rtfContent = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0\\fs24 END USER LICENSE AGREEMENT\\par\\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: \ud83c\udfd7\ufe0f Build MSI\n        working-directory: ${{ env.ELECTRON_DIR }}\n        env:\n          CSC_IDENTITY_AUTO_DISCOVERY: 'false'\n        run: |\n          npm ci --prefer-offline\n          $ver = \"${{ needs.build-core.outputs.semver }}\"\n          npm run dist -- --win msi --config electron-builder-config.yml --publish never --config.artifactName=\"Fortuna-Electron-${ver}.msi\"\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        continue-on-error: true\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: \ud83d\udce4 Upload MSI\n        uses: actions/upload-artifact@v4\n        with:\n          name: electron-msi-${{ github.run_id }}\n          path: ${{ env.ELECTRON_DIR }}/dist/*.msi\n          retention-days: 1\n\n  # ==================================================================================\n  # JOB 3: SMOKE TEST (The \"Robust\" Verification)\n  # ==================================================================================\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test'\n    runs-on: windows-latest\n    needs: package-electron\n    timeout-minutes: 30\n    steps:\n      - name: \ud83d\udce5 Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          name: electron-msi-${{ github.run_id }}\n          path: installer\n\n      - name: Configure Firewall\n        shell: pwsh\n        run: |\n          New-NetFirewallRule -DisplayName \"FortunaTest\" -Direction Inbound -LocalPort 8102 -Protocol TCP -Action Allow\n\n      - name: \ud83e\udd2b Install & Verify\n        shell: pwsh\n        run: |\n          $msi = Get-ChildItem \"installer\" -Filter \"*.msi\" -Recurse | Select -First 1\n          if (!$msi) { throw \"No MSI found\" }\n\n          Write-Host \"Installing $($msi.Name)...\"\n          # EXOTIC INGREDIENT: PassThru for accurate exit codes\n          $proc = Start-Process msiexec.exe -ArgumentList \"/i `\"$($msi.FullName)`\" /qn /L*v install.log\" -Wait -PassThru\n\n          if ($proc.ExitCode -ne 0) {\n            Get-Content install.log -Tail 50\n            throw \"Install failed with code $($proc.ExitCode)\"\n          }\n\n      - name: \ud83d\ude80 Launch & Wait (Port Detection)\n        shell: pwsh\n        run: |\n          $root = 'C:\\Program Files\\Fortuna Faucet'\n          $exe = Get-ChildItem $root -Filter \"*.exe\" -Recurse | Where { $_.Name -notmatch 'uninstall' } | Select -First 1\n          if (!$exe) { throw \"Executable not found in $root\" }\n\n          Write-Host \"Target: $($exe.FullName)\"\n\n          # Create Log Directory\n          $logDir = \"C:\\Temp\\fortuna-logs\"\n          New-Item -ItemType Directory -Path $logDir -Force | Out-Null\n\n          # Launch Electron with Log Redirection\n          # We use Start-Process to detach, but redirect streams\n          $proc = Start-Process -FilePath $exe.FullName -NoNewWindow -PassThru -RedirectStandardOutput \"$logDir\\stdout.log\" -RedirectStandardError \"$logDir\\stderr.log\"\n\n          Write-Host \"Electron launched (PID: $($proc.Id)). Waiting for Port 8102...\"\n\n          # Wait for Port 8102 (The Backend)\n          $deadline = (Get-Date).AddSeconds(60)\n          $connected = $false\n\n          while ((Get-Date) -lt $deadline) {\n            try {\n              $tcp = New-Object System.Net.Sockets.TcpClient\n              $tcp.Connect('127.0.0.1', 8102)\n              $tcp.Close()\n              Write-Host \"\u2705 SUCCESS: Backend is listening on port 8102!\" -ForegroundColor Green\n              $connected = $true\n              break\n            } catch {\n              Write-Host \"  ...waiting for port...\"\n              Start-Sleep 2\n            }\n          }\n\n          if (-not $connected) {\n            Write-Error \"\u274c TIMEOUT: Backend did not bind port 8102.\"\n\n            Write-Host \"--- ELECTRON STDOUT ---\"\n            if (Test-Path \"$logDir\\stdout.log\") { Get-Content \"$logDir\\stdout.log\" -Tail 50 }\n\n            Write-Host \"--- ELECTRON STDERR ---\"\n            if (Test-Path \"$logDir\\stderr.log\") { Get-Content \"$logDir\\stderr.log\" -Tail 50 }\n\n            exit 1\n          }\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        run: Stop-Process -Name \"Fortuna Faucet\", \"fortuna-backend\" -Force -ErrorAction SilentlyContinue\n\n  # ==================================================================================\n  # JOB 4: RELEASE (The \"Triple-Tap\" Staging)\n  # ==================================================================================\n  release:\n    name: '\ud83d\udce6 Release'\n    runs-on: windows-latest\n    needs: smoke-test\n    timeout-minutes: 30\n    steps:\n      - name: \ud83d\udce5 Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          name: electron-msi-${{ github.run_id }}\n          path: staging\n\n      - name: \ud83d\ude9a Robocopy Safe-Stage\n        shell: pwsh\n        run: |\n          $dest = \"final-artifact\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n\n          # EXOTIC INGREDIENT: The Robocopy Logic that finally worked\n          robocopy staging $dest /E /np\n\n          # 0-3 = Success. 4+ = Error.\n          if ($LASTEXITCODE -le 3) {\n            Write-Host \"\u2705 Staged successfully.\"\n            exit 0\n          } else {\n            throw \"Robocopy failed with code $LASTEXITCODE\"\n          }\n\n      - name: \ud83d\udce4 Upload Final\n        uses: actions/upload-artifact@v4\n        with:\n          name: Final-Electron-MSI\n          path: final-artifact/\n"
  },
  ".github/workflows/build-electron-msi-gpt5.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-electron-msi-gpt5.yml",
    "content": "# System Timestamp: 2025-12-07 15:30:00\nname: \ud83d\udd28 Build Electron MSI Installer (Production)\n\non:\n  push:\n    branches: [\"main\"]\n\nconcurrency:\n  group: build-electron-msi-${{ github.ref }}\n  cancel-in-progress: false\n\nenv:\n  NODE_VERSION: '18'\n  PYTHON_VERSION: '3.11'\n  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder\n  BACKEND_DIR: 'web_service/backend'\n  PYTHONUTF8: '1'\n  API_KEY: mock_key\n  FORTUNA_ENV: smoke-test\n  TVG_API_KEY: mock\n  GREYHOUND_API_URL: http://mock\n\njobs:\n  validate-environment:\n    name: \u2705 Pre-flight Validation\n    runs-on: windows-latest\n    timeout-minutes: 30\n    outputs:\n      node_version: ${{ steps.versions.outputs.node }}\n      python_version: ${{ steps.versions.outputs.python }}\n      build_id: ${{ steps.versions.outputs.build_id }}\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \ud83d\udd0d Verify Critical Files Exist\n        shell: pwsh\n        run: |\n          # FIX: Removed dynamic spec file from check\n          $criticalFiles = @(\n            'electron/electron-builder-config.yml',\n            'web_platform/frontend/package.json',\n            '${{ env.BACKEND_DIR }}/requirements-dev.txt',\n            'electron/package.json'\n          )\n\n          $manifest = @{\n            timestamp = Get-Date -Format 'o'\n            checks = @()\n            errors = @()\n          }\n\n          foreach ($file in $criticalFiles) {\n            if (Test-Path -LiteralPath $file) {\n              $hash = (Get-FileHash -LiteralPath $file -Algorithm SHA256).Hash\n              $manifest.checks += @{\n                file = $file\n                exists = $true\n                sha256 = $hash\n              }\n              Write-Host \"\u2713 $file ($hash.Substring(0,8)...)\"\n            } else {\n              $manifest.errors += @{ file = $file; error = 'MISSING' }\n              Write-Error \"\u2717 CRITICAL: $file not found\"\n              exit 1\n            }\n          }\n\n          $manifest | ConvertTo-Json | Out-File -FilePath \".\\\\validation-manifest.json\"\n          Write-Host \"Manifest saved\"\n\n      - name: \ud83d\udcca Capture Version Information\n        id: versions\n        shell: pwsh\n        run: |\n          $nodeVersion = node --version\n          $pythonVersion = python --version\n          $buildId = \"${{ github.run_id }}-${{ github.run_attempt }}\"\n\n          Write-Host \"Node: $nodeVersion\"\n          Write-Host \"Python: $pythonVersion\"\n          Write-Host \"Build ID: $buildId\"\n\n          \"node=$nodeVersion\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"python=$pythonVersion\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"build_id=$buildId\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: \ud83d\udea8 Capture Environment State\n        if: always()\n        shell: pwsh\n        run: |\n          New-Item -ItemType Directory -Path \"debug-artifacts\" -Force | Out-Null\n\n          # System info\n          systeminfo | Out-File \"debug-artifacts/systeminfo.txt\"\n          Get-CimInstance -ClassName Win32_OperatingSystem | Select-Object Caption, Version, BuildNumber | Out-File \"debug-artifacts/os-version.txt\"\n\n          # Disk space\n          $free = (Get-Volume | Where DriveLetter -eq 'C').SizeRemaining\n          if ($free -lt 10GB) { Write-Error \"Insufficient disk space\"; exit 1 }\n          Get-Volume | Out-File \"debug-artifacts/disk-space.txt\"\n\n          # File permissions - FIX: $. to $_.\n          Get-ChildItem -Recurse -Include \"*.yml\", \"*.spec\", \"*.json\" -ErrorAction SilentlyContinue |\n            ForEach-Object { \"{0} {1}\" -f $_.FullName, $_.Length } |\n            Out-File \"debug-artifacts/file-manifest.txt\"\n\n      - name: Derive Build Metadata\n        id: meta\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $ref = \"${{ github.ref }}\"\n          if ($ref -like 'refs/tags/v*') {\n            $semver = $ref -replace 'refs/tags/v', ''\n          } else {\n            $semver = \"0.0.${{ github.run_number }}\"\n          }\n          $shortSha = \"${{ github.sha }}\".Substring(0,7)\n          \"semver=$semver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"short_sha=$shortSha\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\ud83d\udd16 Version: $semver ($shortSha)\"\n\n      - name: \ud83d\udce4 Upload Validation Artifacts\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: validation-${{ github.run_id }}\n          path: |\n            validation-manifest.json\n            debug-artifacts/\n          retention-days: 14\n\n  build-python-service:\n    name: \ud83d\udc0d Build Python Service Bundle\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: validate-environment\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \ud83d\udc0d Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n\n      - name: \ud83d\udce6 Install Python Dependencies\n        shell: pwsh\n        run: |\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r ${{ env.BACKEND_DIR }}/requirements-dev.txt\n          Write-Host \"\u2713 Python dependencies installed\"\n\n      - name: \ud83e\uddea Run Unit Tests (Quality Gate)\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Test Dependencies...\"\n          pip install pytest pytest-asyncio httpx asgi-lifespan fakeredis\n          # 1. Define the Failure Threshold\n          $MAX_ALLOWED_FAILURES = 30\n          Write-Host \"Running Test Suite (Threshold: $MAX_ALLOWED_FAILURES failures)...\"\n          # 2. Run Pytest and generate an XML report.\n          # We use 'cmd /c' and '|| true' to ensure the script doesn't die immediately on exit code 1.\n          cmd /c \"pytest ${{ env.BACKEND_DIR }}/tests --junitxml=test-report.xml\" || Write-Host \"Pytest finished with issues.\"\n          # 3. Parse the XML Report\n          if (Test-Path \"test-report.xml\") {\n              [xml]$xml = Get-Content \"test-report.xml\"\n              # Sum up failures and errors\n              $failures = 0\n              $errors = 0\n              # Handle different XML structures (sometimes root is testsuites, sometimes testsuite)\n              if ($xml.testsuites) {\n                  $failures = [int]$xml.testsuites.failures\n                  $errors = [int]$xml.testsuites.errors\n              } elseif ($xml.testsuite) {\n                  $failures = [int]$xml.testsuite.failures\n                  $errors = [int]$xml.testsuite.errors\n              }\n              $total_issues = $failures + $errors\n              Write-Host \"----------------------------------------\"\n              Write-Host \"\ud83d\udcca TEST RESULTS SUMMARY\"\n              Write-Host \"   Failures: $failures\"\n              Write-Host \"   Errors:   $errors\"\n              Write-Host \"   Total:    $total_issues\"\n              Write-Host \"   Limit:    $MAX_ALLOWED_FAILURES\"\n              Write-Host \"----------------------------------------\"\n              # 4. The Decision Logic\n              if ($total_issues -gt $MAX_ALLOWED_FAILURES) {\n                  Write-Error \"\u274c CRITICAL: Too many tests failed ($total_issues). Limit is $MAX_ALLOWED_FAILURES.\"\n                  exit 1\n              } else {\n                  Write-Host \"\u2705 ACCEPTABLE: Failure count is within tolerance. Proceeding with build...\" -ForegroundColor Green\n                  exit 0 # Explicitly exit with success code to override pytest's failure code\n              }\n          } else {\n              Write-Error \"\u274c FATAL: No test report generated. Pytest failed to start.\"\n              exit 1\n          }\n\n      - name: \u2622\ufe0f NUCLEAR FIX -- Ensure Python Package Structure & Double Injection\n        shell: pwsh\n        run: |\n          Set-Content -Path \"web_service/backend/__init__.py\" -Value \"# This file is intentionally non-empty to ensure package recognition.\"\n          Write-Host \"\u2705 Ensured non-empty __init__.py files exist for package discovery.\"\n\n      - name: Create Dynamic fortuna-backend-electron.spec for PyInstaller\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $entry_point = '${{ env.BACKEND_DIR }}/main.py'.Replace('\\\\', '/')\n          $other_service = \"python_service\"\n\n          # Ensure absolute paths for the init files\n          $backend_init = (Resolve-Path \"web_service/backend/__init__.py\").Path.Replace('\\\\', '/')\n\n          $specContent = @(\n            \"# -- mode: python ; coding: utf-8 --\",\n            \"import os\",\n            \"from pathlib import Path\",\n            \"from PyInstaller.utils.hooks import collect_data_files, collect_submodules\",\n            \"\",\n            \"block_cipher = None\",\n            \"project_root = Path(os.getcwd())\",\n            \"\",\n            \"datas = []\",\n            \"datas += collect_data_files('uvicorn')\",\n            \"datas += collect_data_files('slowapi')\",\n            \"datas += collect_data_files('structlog')\",\n            \"\",\n            \"hiddenimports = collect_submodules('web_service.backend')\",\n            \"hiddenimports += [\",\n            \" 'uvicorn.logging', 'uvicorn.loops.auto', 'uvicorn.lifespan.on',\",\n            \" 'uvicorn.protocols.http.h11_impl', 'uvicorn.protocols.websockets.wsproto_impl',\",\n            \" 'fastapi.routing', 'starlette.staticfiles', 'anyio._backends._asyncio',\",\n            \" 'httpcore', 'httpx', 'slowapi', 'structlog', 'tenacity', 'aiosqlite',\",\n            \" 'pydantic_core', 'pydantic_settings.sources', 'win32timezone'\",\n            \"]\",\n            \"\",\n            \"a = Analysis(\",\n            \" ['$entry_point'],\",\n            \" pathex=[str(project_root)],\",\n            \" binaries=[],\",\n            \" datas=datas,\",\n            \" hiddenimports=hiddenimports,\",\n            \" hookspath=[],\",\n            \" runtime_hooks=[],\",\n            \" excludes=['tests', 'pytest', '$other_service'],\",\n            \" win_no_prefer_redirects=False,\",\n            \" win_private_assemblies=False,\",\n            \" cipher=block_cipher,\",\n            \" noarchive=False\",\n            \")\",\n            \"\",\n            \"# \u2622\ufe0f NUCLEAR OVERRIDE: Force init files into the PYZ archive\",\n            \"a.pure += [\",\n            \" ('web_service.backend', '$backend_init', 'PYMODULE')\",\n            \"]\",\n            \"\",\n            \"pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\",\n            \"exe = EXE(\",\n            \" pyz,\",\n            \" a.scripts,\",\n            \" a.binaries,\",\n            \" a.zipfiles,\",\n            \" a.datas,\",\n            \" [],\",\n            \" name='fortuna-backend',\",\n            \" debug=False,\",\n            \" bootloader_ignore_signals=False,\",\n            \" strip=False,\",\n            \" upx=True,\",\n            \" runtime_tmpdir=None,\",\n            \" console=True,\",\n            \" disable_windowed_traceback=False,\",\n            \" argv_emulation=False,\",\n            \" target_arch=None,\",\n            \" codesign_identity=None,\",\n            \" entitlements_file=None\",\n            \")\"\n          )\n          Set-Content -Path \"fortuna-backend-electron.spec\" -Value $specContent\n          Write-Host \"\u2705 Dynamically generated 'fortuna-backend-electron.spec' with PYZ Injection.\"\n\n      - name: \ud83d\udd28 Build Python Service with PyInstaller\n        shell: pwsh\n        run: |\n          $specFile = 'fortuna-backend-electron.spec'\n\n          if (-not (Test-Path $specFile)) {\n            Write-Error \"Spec file not found: $specFile\"\n            exit 1\n          }\n\n          pyinstaller `\n            --distpath \".\\\\dist\\\\service\" `\n            --workpath \".\\\\build\\\\service\" `\n            --clean `\n            $specFile\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"PyInstaller failed with code $LASTEXITCODE\"\n            exit $LASTEXITCODE\n          }\n\n          $serviceExe = Get-ChildItem -Path \".\\\\dist\\\\service\" -Filter \"*.exe\" | Select-Object -First 1\n          if ($null -eq $serviceExe) {\n            Write-Error \"No executable generated by PyInstaller\"\n            exit 1\n          }\n\n          Write-Host \"\u2713 Service executable: $($serviceExe.FullName) ($('{0:N0}' -f $serviceExe.Length) bytes)\"\n\n      - name: \ud83e\uddea Verify Service Executable\n        shell: pwsh\n        run: |\n          $serviceExe = Get-ChildItem -Path \".\\\\dist\\\\service\" -Filter \"*.exe\" | Select-Object -First 1\n\n          if ($null -eq $serviceExe) {\n            Write-Error \"Service executable not found\"\n            exit 1\n          }\n\n          # Verify it's a valid PE executable\n          $bytes = [System.IO.File]::ReadAllBytes($serviceExe.FullName)\n          if ($bytes[0] -ne 0x4D -or $bytes[1] -ne 0x5A) {\n            Write-Error \"Invalid PE executable signature\"\n            exit 1\n          }\n\n          Write-Host \"\u2713 Service executable is valid PE binary\"\n\n      - name: \ud83d\udce4 Upload Service Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: python-service-${{ needs.validate-environment.outputs.build_id }}\n          path: dist/service/\n          retention-days: 1\n\n      - name: \ud83d\udea8 Upload Failure Diagnostics\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: python-build-failure-logs-${{ needs.validate-environment.outputs.build_id }}\n          path: |\n            build/service/\n            spec-working/\n          retention-days: 30\n\n  build-frontend:\n    name: \ud83c\udfa8 Build Web Frontend\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: validate-environment\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \ud83d\udce6 Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_platform/frontend/package.json'\n\n      - name: \ud83d\udce5 Install Frontend Dependencies\n        shell: pwsh\n        working-directory: web_platform/frontend\n        run: |\n          npm ci --prefer-offline --no-audit\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"npm ci failed\"\n            exit 1\n          }\n          npm list --depth=0\n\n      - name: \ud83d\udd28 Build Frontend\n        shell: pwsh\n        working-directory: web_platform/frontend\n        run: |\n          npm run build 2>&1\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"Frontend build failed\"\n            exit 1\n          }\n\n          $outDir = Get-Item -Path \"out\" -ErrorAction SilentlyContinue\n          if ($null -eq $outDir) {\n            Write-Error \"No out/ directory generated\"\n            exit 1\n          }\n\n          $fileCount = (Get-ChildItem -Recurse -Path \"out\" | Measure-Object).Count\n          Write-Host \"\u2713 Frontend built: $fileCount files\"\n\n      - name: \ud83d\udce4 Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-dist-${{ needs.validate-environment.outputs.build_id }}\n          path: web_platform/frontend/out/\n          retention-days: 1\n\n      - name: \ud83d\udea8 Upload Failure Diagnostics\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-failure-logs-${{ needs.validate-environment.outputs.build_id }}\n          path: |\n            web_platform/frontend/.next/\n            web_platform/frontend/npm-debug.log\n          if-no-files-found: ignore\n          retention-days: 30\n\n  verify-assets:\n    name: '\ud83d\uddbc\ufe0f Verify Critical Build Assets'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    needs: validate-environment\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: \ud83e\uddd0 Forensic Asset Verification\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $asset_manifest = @(\n            @{ Path = \"electron/assets/icon.ico\"; Purpose = \"Main Application & MSI Icon\" }\n          )\n\n          Write-Host \"--- Asset Verification Forensics ---\"\n          $all_assets_found = $true\n\n          foreach ($asset in $asset_manifest) {\n            Write-Host \"Checking for: $($asset.Path) ($($asset.Purpose))\"\n            if (Test-Path -LiteralPath $asset.Path) {\n              $file_info = Get-Item -LiteralPath $asset.Path\n              $hash = (Get-FileHash -LiteralPath $asset.Path -Algorithm SHA256).Hash\n              Write-Host \" \u2705 FOUND: $($file_info.Length) bytes, SHA256: $($hash.Substring(0,12))\" -ForegroundColor Green\n            } else {\n              Write-Host \" \u274c MISSING\" -ForegroundColor Red\n              $all_assets_found = $false\n            }\n          }\n\n          if (-not $all_assets_found) {\n            Write-Error \"CRITICAL: One or more required assets are missing.\"\n            Write-Host \"\\\\n--- Filesystem State ---\"\n            Write-Host \"Listing contents of 'electron/assets' directory for debugging:\"\n            Get-ChildItem -Path \"electron/assets\" -Recurse | ForEach-Object {\n              Write-Host \" - $($_.FullName.Replace($env:GITHUB_WORKSPACE, ''))\"\n            }\n            exit 1\n          }\n\n          Write-Host \"\\\\n\u2705 All critical assets verified.\" -ForegroundColor Green\n  build-electron-msi:\n    name: \ud83d\ude80 Build Electron MSI Package\n    runs-on: windows-latest\n    timeout-minutes: 30\n    needs: [validate-environment, build-python-service, build-frontend, verify-assets]\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \ud83d\udce6 Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'electron/package.json'\n\n      - name: \ud83d\udce5 Download Python Service\n        uses: actions/download-artifact@v4\n        with:\n          name: python-service-${{ needs.validate-environment.outputs.build_id }}\n          path: python-service-bin\n\n      - name: \ud83d\udce5 Download Frontend Dist\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-dist-${{ needs.validate-environment.outputs.build_id }}\n          path: web_platform/frontend/out\n\n      - name: \ud83d\ude9a Stage Backend for Electron Builder\n        shell: pwsh\n        run: |\n          # FIX: The config looks for '../python-service-bin' relative to the 'electron' dir,\n          # so we place the artifact at the repo root.\n          $dest = \"python-service-bin\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n          Move-Item -Path \"python-service-bin/*\" -Destination $dest -Force\n          Write-Host \"\u2705 Backend staged to root '$dest' directory.\"\n          Write-Host \"Contents:\"\n          Get-ChildItem -Path $dest -Recurse | ForEach-Object { Write-Host \" - $($_.Name)\" }\n\n      - name: \ud83d\udce5 Install Electron Dependencies\n        shell: pwsh\n        working-directory: electron\n        run: |\n          npm ci --prefer-offline --no-audit\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"npm ci failed\"\n            exit 1\n          }\n\n      - name: '\ud83e\uddd0 Forensically Guarantee Icon Paths'\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $ErrorActionPreference = \"Stop\"\n\n          # Install and import the required module for YAML parsing\n          Install-Module -Name powershell-yaml -Force -Scope CurrentUser -ErrorAction Stop\n          Import-Module powershell-yaml\n\n          $configPath = 'electron/electron-builder-config.yml'\n          Write-Host \"--- Icon Path Forensics ---\"\n          Write-Host \"Verifying and correcting icon paths in: $configPath\"\n\n          # 1. Verify the icon file physically exists\n          $iconPath = \"electron/assets/icon.ico\"\n          if (-not (Test-Path -LiteralPath $iconPath)) {\n            Write-Error \"CRITICAL: The primary icon file is missing at '$iconPath'.\"\n            exit 1\n          }\n          $absoluteIconPath = (Resolve-Path -LiteralPath $iconPath).Path\n          Write-Host \"\u2705 Primary icon found at: $absoluteIconPath\"\n\n          # 2. Read and parse the YAML configuration\n          $config = Get-Content $configPath | ConvertFrom-Yaml\n\n          # 3. Normalize the icon path for YAML\n          $normalizedIconPath = $absoluteIconPath.Replace('\\\\', '/')\n\n          # 4. Update the icon paths in the configuration object\n          $config.win.icon = $normalizedIconPath\n\n          # The installerIcon and uninstallerIcon properties are not valid for the MSI target.\n          # electron-builder automatically uses the main application icon for the installer.\n          # We unconditionally remove them here to prevent schema validation errors, catching the error if they don't exist.\n          try {\n            $config.msi.PSObject.Properties.Remove('installerIcon')\n            Write-Host \" -> Removed 'msi.installerIcon' property.\" -ForegroundColor Yellow\n          } catch {\n            Write-Host \" -> 'msi.installerIcon' property did not exist, no action needed.\"\n          }\n          try {\n            $config.msi.PSObject.Properties.Remove('uninstallerIcon')\n            Write-Host \" -> Removed 'msi.uninstallerIcon' property.\" -ForegroundColor Yellow\n          } catch {\n            Write-Host \" -> 'msi.uninstallerIcon' property did not exist, no action needed.\"\n          }\n\n          Write-Host \" -> Set win.icon to '$normalizedIconPath'\" -ForegroundColor Green\n\n          # 5. Convert back to YAML and write to a NEW temporary config file\n          $tempConfigPath = 'electron/temp-builder-config.yml'\n          $config | ConvertTo-Yaml | Set-Content -Path $tempConfigPath\n          Write-Host \"\u2705 Successfully created temporary config '$tempConfigPath' with corrected icon paths.\"\n\n          # 6. Display final config for verification\n          Write-Host \"\\\\n--- Final Config ---\"\n          Get-Content $tempConfigPath | Write-Host\n          Write-Host \"--------------------\"\n\n      - name: \ud83d\udd0d Verify electron-builder Config\n        shell: pwsh\n        run: |\n          $configPath = 'electron/temp-builder-config.yml'\n\n          if (-not (Test-Path $configPath)) {\n            Write-Error \"electron-builder config not found: $configPath\"\n            exit 1\n          }\n\n          # Basic YAML syntax check (non-exhaustive)\n          $content = Get-Content $configPath -Raw\n          if ($content -notmatch 'appId:') {\n            Write-Error \"Invalid electron-builder config: missing appId\"\n            exit 1\n          }\n\n          Write-Host \"\u2713 electron-builder config valid\"\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists for electron-builder\n        shell: pwsh\n        run: |\n          if (-not (Test-Path 'build_wix')) { New-Item -ItemType Directory -Path 'build_wix' | Out-Null }\n          $licensePath = 'build_wix/license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder...'\n            # FIX: Use Base64 decoding to avoid RTF escape sequence issues in PowerShell/YAML\n            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String(\"e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0=\"))\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: \ud83d\udd28 Build Electron Application\n        shell: pwsh\n        working-directory: electron\n        run: |\n          # Set code signing to false for CI (unless you have signing certificates)\n          $env:CSC_IDENTITY_AUTO_DISCOVERY = 'false'\n\n          npm run build -- --config temp-builder-config.yml --publish never 2>&1\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"Electron build failed\"\n            exit 1\n          }\n\n          Write-Host \"\u2713 Electron build completed\"\n\n      - name: \ud83c\udfd7\ufe0f Build MSI with electron-builder\n        shell: pwsh\n        working-directory: electron\n        env:\n          CSC_IDENTITY_AUTO_DISCOVERY: 'false'\n        run: |\n          $semver = \"${{ needs.validate-environment.outputs.semver }}\"\n          $shortSha = \"${{ needs.validate-environment.outputs.short_sha }}\"\n          $artifactName = \"Fortuna-Electron-${semver}-${shortSha}.msi\"\n          npm run dist -- --win msi --config temp-builder-config.yml --publish never --config.artifactName=$artifactName 2>&1\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"electron-builder MSI creation failed\"\n            exit 1\n          }\n\n          Write-Host \"\u2713 MSI build completed\"\n\n      - name: \ud83d\udd0d Verify MSI Output\n        shell: pwsh\n        run: |\n          $msiFiles = Get-ChildItem -Recurse -Filter \"*.msi\" -ErrorAction SilentlyContinue\n\n          if ($msiFiles.Count -eq 0) {\n            Write-Error \"No MSI files generated\"\n            exit 1\n          }\n\n          foreach ($msi in $msiFiles) {\n            $sizeGB = $msi.Length / 1GB\n            $sizeMB = $msi.Length / 1MB\n\n            if ($msi.Length -lt 10MB) {\n              Write-Warning \"MSI suspiciously small: $($msi.Name) ($('{0:N1}' -f $sizeMB) MB)\"\n            }\n\n            Write-Host \"\u2713 MSI: $($msi.FullName) ($('{0:N1}' -f $sizeMB) MB)\"\n\n            # Generate checksum\n            $hash = (Get-FileHash -LiteralPath $msi.FullName -Algorithm SHA256).Hash\n            Write-Host \" SHA256: $hash\"\n            $hash | Out-File -FilePath \"$($msi.FullName).sha256\"\n          }\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: \ud83d\udcca Generate Build Report\n        if: always()\n        shell: pwsh\n        run: |\n          $report = @{\n            build_id = '${{ needs.validate-environment.outputs.build_id }}'\n            timestamp = Get-Date -Format 'o'\n            status = if ($LASTEXITCODE -eq 0) { 'SUCCESS' } else { 'FAILED' }\n            node_version = '${{ needs.validate-environment.outputs.node_version }}'\n            python_version = '${{ needs.validate-environment.outputs.python_version }}'\n            msi_files = @()\n          }\n\n          Get-ChildItem -Filter \"*.msi\" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {\n            $report.msi_files += @{\n              path = $_.FullName\n              size_mb = [math]::Round($_.Length / 1MB, 2)\n              hash = (Get-FileHash -LiteralPath $_.FullName -Algorithm SHA256).Hash\n            }\n          }\n\n          $report | ConvertTo-Json | Out-File -FilePath \"build-report.json\"\n          Get-Content \"build-report.json\" | Out-Host\n\n      - name: \ud83d\udce6 Stage Artifacts (Self-Discovery)\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $destDir = \"release-artifacts\"\n          New-Item -ItemType Directory -Path $destDir -Force | Out-Null\n          $destAbsolutePath = (Resolve-Path $destDir).Path\n\n          Write-Host \"Staging Destination: $destAbsolutePath\"\n\n          # Find all MSIs, excluding any inside the destination folder.\n          $msiFiles = Get-ChildItem -Path \".\" -Recurse -Filter \"*.msi\" |\n            Where-Object { $_.FullName -notlike \"$destAbsolutePath\" }\n\n          if ($msiFiles.Count -eq 0) {\n            Write-Error \"No MSI files found to stage!\"\n            exit 1\n          }\n\n          foreach ($msi in $msiFiles) {\n            Write-Host \"Moving: $($msi.FullName)\"\n            Move-Item $msi.FullName $destAbsolutePath -Force\n\n            # Handle the checksum file if it exists\n            $shaPath = \"$($msi.FullName).sha256\"\n            if (Test-Path $shaPath) {\n              Move-Item -LiteralPath $shaPath -Destination $destAbsolutePath -Force\n            }\n          }\n\n          Write-Host \"\u2705 Staging complete. Contents of $($destDir):\"\n          Get-ChildItem $destAbsolutePath | Select-Object Name, Length\n\n      - name: \ud83d\udce4 Upload Release Artifacts\n        if: success()\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-electron-msi-${{ needs.validate-environment.outputs.build_id }}\n          path: |\n            release-artifacts/\n            build-report.json\n          retention-days: 90\n\n      - name: \ud83d\udea8 Upload Failure Diagnostics\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: build-failure-logs-${{ needs.validate-environment.outputs.build_id }}\n          path: |\n            electron/dist/\n            python-service-bin/\n            web_platform/frontend/out/\n            build-report.json\n          retention-days: 30\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test (Robust)'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: [validate-environment, build-electron-msi]\n    env:\n      FORTUNA_ENV: 'smoke-test'\n    steps:\n      - name: \ud83d\udce5 Download MSI Installer\n        uses: actions/download-artifact@v4\n        with:\n          name: fortuna-electron-msi-${{ needs.validate-environment.outputs.build_id }}\n          path: msi-installer\n\n      - name: \ud83d\udccb Inspect Artifact\n        shell: pwsh\n        run: |\n          Write-Host \"=== Artifact Contents ===\"\n          Get-ChildItem -Path \"msi-installer\" -Recurse | ForEach-Object {\n            Write-Host \" $($_.FullName)\"\n          }\n\n      - name: \ud83e\udd2b Install MSI & Verify\n        shell: pwsh\n        run: |\n          # EXOTIC INGREDIENT #1: Find MSI with recursion\n          $msi = Get-ChildItem -Path \"msi-installer\" -Filter \"*.msi\" -Recurse -ErrorAction SilentlyContinue |\n            Select-Object -First 1\n\n          if (-not $msi) {\n            Write-Error \"\u274c FATAL: No MSI file found in artifact\"\n            exit 1\n          }\n\n          Write-Host \"Installing: $($msi.Name)\"\n\n          # EXOTIC INGREDIENT #2: Logging with /L*v\n          $proc = Start-Process msiexec.exe -ArgumentList \"/i `\"$($msi.FullName)`\" /qn /L*v msi-install.log\" -Wait -PassThru\n\n          if ($proc.ExitCode -ne 0) {\n            Write-Error \"\u274c MSI Install Failed with exit code $($proc.ExitCode)\"\n            if (Test-Path msi-install.log) {\n              Get-Content msi-install.log | Select-Object -Last 50\n            }\n            exit 1\n          }\n\n          Write-Host \"\u2705 MSI installation succeeded\"\n\n      - name: \ud83d\udd75\ufe0f Find Installed Executable\n        shell: pwsh\n        run: |\n          # EXOTIC INGREDIENT #3: Don't assume the path. Find it dynamically.\n          # Searches for the main executable, skipping uninstallers\n\n          $root = \"C:\\\\Program Files\\\\Fortuna Faucet\"\n          if (-not (Test-Path $root)) {\n            Write-Error \"\u274c Install directory not found: $root\"\n            Get-ChildItem \"C:\\\\Program Files\" | Write-Host\n            exit 1\n          }\n\n          $exe = Get-ChildItem -Path $root -Filter \"*.exe\" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -notmatch 'uninstall' } | Select-Object -First 1\n\n          if (-not $exe) {\n            Write-Error \"\u274c No main executable found in $root\"\n            Get-ChildItem -Path $root -Recurse | Write-Host\n            exit 1\n          }\n\n          Write-Host \"\u2705 Found Executable: $($exe.FullName)\"\n          $exe.FullName | Out-File \"installed_exe.txt\" -Encoding utf8\n\n      - name: \ud83d\ude80 Launch, Wait & Verify Backend\n        shell: pwsh\n        run: |\n          $root = 'C:\\\\Program Files\\\\Fortuna Faucet'\n          $exe = Get-ChildItem $root -Filter \"*.exe\" -Recurse | Where { $_.Name -notmatch 'uninstall' } | Select -First 1\n\n          if (!$exe) { throw \"Executable not found\" }\n\n          Write-Host \"=== PRE-LAUNCH DIAGNOSTICS ===\"\n          Write-Host \"Electron executable: $($exe.FullName)\"\n          Write-Host \"File size: $('{0:N0}' -f $exe.Length) bytes\"\n          Write-Host \"Exists: $(Test-Path $exe.FullName)\"\n\n          Write-Host \"`n=== LAUNCHING ELECTRON ===\"\n          $logDir = \"C:\\Temp\\fortuna-logs-$(Get-Random)\"\n          New-Item -ItemType Directory -Path $logDir -Force | Out-Null\n\n          $proc = Start-Process -FilePath $exe.FullName -PassThru -RedirectStandardOutput \"$logDir\\stdout.log\" -RedirectStandardError \"$logDir\\stderr.log\"\n\n          Write-Host \"Electron launched (PID: $($proc.Id))\"\n          Write-Host \"Waiting for backend to start listening on port 8000...\"\n\n          # Wait for port to be ready\n          $portReady = $false\n          for ($i = 0; $i -lt 60; $i++) {\n            try {\n              $tcp = New-Object System.Net.Sockets.TcpClient\n              $tcp.Connect('127.0.0.1', 8000)\n              $tcp.Close()\n              Write-Host \"\u2705 Port 8000 is OPEN!\"\n              $portReady = $true\n              break\n            } catch {\n              Write-Host \"  Attempt $($i+1)/60: Waiting...\"\n              Start-Sleep 2\n            }\n          }\n\n          if (!$portReady) {\n            Write-Error \"\u274c Backend never opened port 8000!\"\n            Write-Host \"`n=== ELECTRON STDOUT ===\"\n            Get-Content \"$logDir\\stdout.log\" -Tail 50\n            Write-Host \"`n=== ELECTRON STDERR ===\"\n            Get-Content \"$logDir\\stderr.log\" -Tail 50\n            exit 1\n          }\n\n          Write-Host \"\u2705 SUCCESS: Backend is ready and accepting connections!\"\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: \ud83d\udce4 Upload Logs on Failure\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: electron-smoke-test-logs-${{ github.run_id }}\n          path: |\n            msi-install.log\n          retention-days: 7\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        shell: pwsh\n        run: |\n          Stop-Process -Name \"Fortuna Faucet\" -Force -ErrorAction SilentlyContinue\n          Stop-Process -Name \"fortuna-backend\" -Force -ErrorAction SilentlyContinue\n          Write-Host \"\u2705 Cleanup complete\"\n\n  diagnose-asgi-imports:\n    name: '\ud83d\udd0d ASGI Import Killer Pre-Smoke Diagnostic'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: build-python-service\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n      - name: 'Run ASGI Diagnostics'\n        uses: ./.github/actions/run-asgi-diagnostics\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          backend-dir: 'python_service'\n          backend-module-path: 'python_service'\n\n  stage-release-artifacts:\n    name: '\ud83d\udce6 Stage Release Artifacts'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    if: success()\n    needs:\n      - build-electron-msi\n      - validate-environment\n      - smoke-test\n    steps:\n      - name: \ud83d\udce5 Download Build Artifacts\n        uses: actions/download-artifact@v4\n        with:\n          name: fortuna-electron-msi-${{ needs.validate-environment.outputs.build_id }}\n          path: staging-area\n\n      - name: \ud83d\ude9a Stage Final Artifact\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $sourceDir = \"staging-area\"\n          $destDir = \"final-release-artifact\"\n          New-Item -ItemType Directory -Path $destDir -Force | Out-Null\n\n          # FIX: $. to $_.\n          Get-ChildItem -Path $sourceDir -Recurse | ForEach-Object {\n            $destPath = Join-Path $destDir $_.Name\n            Move-Item -Path $_.FullName -Destination $destPath -Force\n          }\n\n          Write-Host \"\u2705 Artifacts staged to $destDir\"\n\n      - name: \ud83d\udce4 Upload Final MSI Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: Final-MSI-Artifact\n          path: final-release-artifact/\n          retention-days: 90\n"
  },
  ".github/workflows/build-electron-msi-grok.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-electron-msi-grok.ymlx",
    "content": "name: Build Fortuna Faucet MSI (Electron) - Grok\n\non:\n  push:\n    branches:\n      - deactivated\n  workflow_dispatch:\n\npermissions:\n  contents: write\n  actions: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n\njobs:\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_platform/frontend/package-lock.json'\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          cd web_platform/frontend\n          npm ci\n          npm run build\n      - name: Verify Frontend Build\n        shell: pwsh\n        run: |\n          if (-not (Test-Path 'web_platform/frontend/out/index.html')) { throw \"\u274c Missing index.html\" }\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: frontend-build\n          path: web_platform/frontend/out\n          retention-days: 1\n\n  build-and-test:\n    name: '\ud83d\udc0d Build & Smoke Test'\n    needs: [build-frontend]\n    runs-on: windows-latest\n    env:\n      SMOKE_FRONTEND_URL: \"http://localhost:3000\"\n      SMOKE_HEADING_SELECTOR: \"h1\"\n      SMOKE_SCREENSHOT_PATH: \"smoke-test.png\"\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Setup Python\n        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: 'python_service/requirements.txt'\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: frontend-build\n          path: web_platform/frontend/out\n\n      - name: Install Dependencies\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r python_service/requirements.txt\n          pip install playwright pytest-playwright\n\n      - name: Get Playwright Version\n        id: playwright-version\n        shell: pwsh\n        run: echo \"VERSION=$(python -c 'from importlib.metadata import version; print(version(\"playwright\"))')\" >> $env:GITHUB_OUTPUT\n\n      - name: Cache Playwright Browsers\n        uses: actions/cache@88522ab9f39a2ea568f7027ed67a8d8f9e9d59c3 # v4.0.2\n        id: playwright-cache\n        with:\n          path: C:\\Users\\runneradmin\\AppData\\Local\\ms-playwright\n          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.VERSION }}\n\n      - name: Install Playwright Browsers\n        if: steps.playwright-cache.outputs.cache-hit != 'true'\n        run: python -m playwright install --with-deps chromium\n\n      - name: Backend - Build with PyInstaller\n        run: pyinstaller fortuna-backend-electron.spec --clean --log-level WARN --noconfirm\n\n      - name: Run Electron App (Background)\n        shell: pwsh\n        run: |\n          cd electron\n          npm ci\n          $p = Start-Process -FilePath \"npm\" -ArgumentList \"start\" -PassThru -RedirectStandardOutput \"electron.log\" -RedirectStandardError \"electron.err\"\n          $p.Id | Out-File \"electron.pid\"\n          Start-Sleep -Seconds 10\n\n      - name: '\ud83d\udcf8 Playwright Verification'\n        shell: pwsh\n        run: |\n          $script = @\"\n          import sys, os, time\n          from playwright.sync_api import sync_playwright, expect\n\n          url = os.environ[\"SMOKE_FRONTEND_URL\"]\n          print(f\"Testing URL: {url}\")\n\n          with sync_playwright() as p:\n              browser = p.chromium.launch()\n              context = browser.new_context()\n              context.tracing.start(screenshots=True, snapshots=True)\n              page = context.new_page()\n              try:\n                  page.goto(url, wait_until='domcontentloaded', timeout=10000)\n                  expect(page.locator(\"body\")).to_be_visible(timeout=10000)\n                  page.screenshot(path=os.environ[\"SMOKE_SCREENSHOT_PATH\"])\n                  print(\"\u2705 Screenshot captured.\")\n                  context.tracing.stop(path=\"trace.zip\")\n              except Exception as e:\n                  print(f\"\u274c Error: {e}\")\n                  page.screenshot(path=\"FAILURE.png\")\n                  context.tracing.stop(path=\"trace.zip\")\n                  sys.exit(1)\n              finally:\n                  browser.close()\n          \"@\n          Set-Content -Path \"verify.py\" -Value $script\n          python verify.py\n\n      - name: Upload Screenshot & Logs\n        if: always()\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: smoke-test-evidence\n          path: |\n            *.png\n            electron.log\n            electron.err\n            trace.zip\n\n      - name: Cleanup Process\n        if: always()\n        shell: pwsh\n        run: if (Test-Path \"electron.pid\") { Stop-Process -Id (Get-Content \"electron.pid\") -Force -ErrorAction SilentlyContinue }\n\n      - name: Upload Validated EXE\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: backend-executable\n          path: dist/fortuna-backend.exe\n\n  package-electron-msi:\n    name: '\ud83d\udce6 Package Electron MSI'\n    needs: [build-and-test]\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Download Validated Executable\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: backend-executable\n          path: electron/resources\n\n      - name: Setup Node.js for Electron Builder\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'electron/package.json'\n\n      - name: Build Electron MSI\n        working-directory: electron\n        run: npx electron-builder --win --publish=never\n\n      - name: Verify MSI\n        shell: pwsh\n        run: if (-not (Test-Path \"dist/*.msi\")) { throw \"\u274c MSI build failed\" }\n\n      - name: Upload MSI\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: fortuna-installer\n          path: electron/dist/*.msi\n          if-no-files-found: error\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    needs: [package-electron-msi]\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: fortuna-installer\n          path: dist\n      - name: Create Release\n        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.2.0\n        with:\n          files: dist/*.msi\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-msi-hat-trick-fusion.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi-hat-trick-fusion.yml",
    "content": "# System Timestamp: 2025-12-07 14:00:00\nname: HatTrick Fusion (Perfected)\non:\n  workflow_dispatch:\n  push:\n    branches: [\"main\"]\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  WIX_VERSION: '4.0.5'\n  SERVICE_PORT: '8102'\n  FRONTEND_PORT: '3000'\n  MSI_NAME: 'HatTrickFusion.msi'\n  FIREWALL_RULE: 'HatTrickFusion-Port'\n  UPGRADE_CODE: 'FA689549-366B-4C5C-A482-1132F9A34B10'\n  # Mock API keys for service startup\n  API_KEY: mock_key\n  TVG_API_KEY: mock\n  GREYHOUND_API_URL: http://mock\n  FORTUNA_ENV: smoke-test\n\njobs:\n  # 1. Build Frontend First (so Backend can bundle it)\n  build-frontend:\n    name: Build Frontend\n    runs-on: windows-latest\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: npm\n      - name: Install and Build\n        run: |\n          cd web_platform/frontend\n          npm ci --prefer-offline --no-audit --no-fund\n          npm run build\n      - name: Upload Frontend\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build\n          path: web_platform/frontend/out\n\n  # 2. Build Backend (Downloads Frontend to bundle it)\n  build-backend:\n    name: Build Backend Binary\n    runs-on: windows-latest\n    needs: build-frontend\n    timeout-minutes: 30\n    outputs:\n      semver: ${{ steps.meta.outputs.semver }}\n      backend-dir: ${{ steps.meta.outputs.backend_dir }}\n    steps:\n      - uses: actions/checkout@v4\n\n      # Download Frontend for bundling\n      - uses: actions/download-artifact@v4\n        with:\n          name: frontend-build\n          path: web_platform/frontend/out\n\n      - id: meta\n        shell: pwsh\n        run: |\n          $ver = if (\"${{ github.ref }}\" -match 'refs/tags/v(.*)') { $Matches[1] } else { \"0.0.${{ github.run_number }}\" }\n          \"semver=$ver\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_dir=web_service/backend\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"module_path=web_service.backend\" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append\n\n      - uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: pip\n\n      - name: Install Dependencies\n        run: |\n          pip install -r ${{ steps.meta.outputs.backend_dir }}/requirements.txt\n          pip install pyinstaller==6.6.0\n\n      - name: Generate Spec & Build\n        shell: python\n        env:\n          BACKEND_DIR: ${{ steps.meta.outputs.backend_dir }}\n          MODULE_PATH: ${{ env.module_path }}\n          FRONTEND_OUT: web_platform/frontend/out\n        run: |\n          import os\n          from pathlib import Path\n\n          bk_dir = os.environ['BACKEND_DIR']\n          mod_path = os.environ['MODULE_PATH']\n          # CHANGE: Point to the new service wrapper\n          entry = f\"{bk_dir}/main.py\"\n          frontend_out = os.environ['FRONTEND_OUT']\n\n          # FIX: Fixed quoting in datas list to avoid syntax error\n          spec = f\"\"\"\n          # -- mode: python ; coding: utf-8 --\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n\n          a = Analysis(\n              ['{entry}'],\n              pathex=[],\n              binaries=[],\n              datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],\n              hiddenimports=collect_submodules('{mod_path}') + ['win32timezone'],\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest'],\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False,\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],\n              name='fortuna-backend', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False\n          )\n          \"\"\"\n          with open(\"hat-trick.spec\", \"w\") as f: f.write(spec)\n          os.system(\"pyinstaller hat-trick.spec --clean --noconfirm\")\n\n      - name: Upload Backend\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-dist\n          path: dist/fortuna-backend.exe\n\n  package-msi:\n    name: Package MSI\n    runs-on: windows-latest\n    needs: build-backend\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/download-artifact@v4\n        with:\n          name: backend-dist\n          path: staging/backend\n\n      - name: Create Restart Service Batch Script\n        shell: pwsh\n        run: |\n          $scriptContent = @\"\n          @echo off\n          echo Requesting Admin privileges to restart FortunaWebService...\n          net stop FortunaWebService\n          net start FortunaWebService\n          echo Service Restarted.\n          pause\n          \"@\n          Set-Content -Path \"staging/backend/restart_service.bat\" -Value $scriptContent -Encoding Ascii\n          Write-Host \"\u2705 Created restart_service.bat script.\"\n\n      - uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists\n        shell: pwsh\n        run: |\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n          $licensePath = 'build_wix/license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder...'\n            # FIX: Use Base64 decoding to avoid RTF escape sequence issues in PowerShell/YAML\n            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String(\"e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0=\"))\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: Prepare WiX\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n\n          # Copy template\n          Copy-Item build_wix/Product_WithService.wxs build_wix/Product.wxs -Force\n\n          # Dynamically remove the problematic Start=\"install\" attribute\n          $wxsPath = 'build_wix/Product.wxs'\n          $wxsContent = [xml](Get-Content $wxsPath)\n          $serviceControl = $wxsContent.SelectSingleNode(\"//*[local-name()='ServiceControl']\")\n          if ($serviceControl -and $serviceControl.HasAttribute(\"Start\")) {\n              $serviceControl.RemoveAttribute(\"Start\")\n              $wxsContent.Save($wxsPath)\n              Write-Host \"\u2705 Dynamically removed 'Start=install' attribute from WiX template.\"\n          }\n\n          # Stage Executable\n          if (Test-Path staging/backend/fortuna-backend.exe) {\n            Move-Item staging/backend/fortuna-backend.exe staging/backend/fortuna-webservice.exe -Force\n          }\n\n          # FIX: Generate Valid .wixproj with Extensions\n          $proj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">',\n            '  <PropertyGroup>',\n            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',\n            '    <OutputType>Package</OutputType>',\n            '    <Platforms>x64</Platforms>',\n            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',\n            '  </PropertyGroup>',\n            '  <ItemGroup>',\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '  </ItemGroup>',\n            '  <ItemGroup>',\n            '    <Compile Include=\"Product.wxs\" />',\n            '  </ItemGroup>',\n            '</Project>'\n          )\n          Set-Content build_wix/Fortuna.wixproj ($proj -join \"`r`n\") -Encoding utf8\n\n      - name: Build MSI\n        working-directory: build_wix\n        run: dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"${{ needs.build-backend.outputs.semver }}\" -p:SourceDir=\"../staging/backend\" -p:ServicePort=\"${{ env.SERVICE_PORT }}\"\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        continue-on-error: true\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: Upload MSI\n        uses: actions/upload-artifact@v4\n        with:\n          name: hat-trick-msi\n          path: build_wix/bin/x64/Release/\n\n  smoke-test:\n    name: HatTrick Fusion Smoke Test\n    runs-on: windows-latest\n    needs: package-msi\n    timeout-minutes: 30\n    steps:\n      - uses: actions/download-artifact@v4\n        with:\n          name: hat-trick-msi\n          path: installer\n\n      - name: \ud83d\udee1\ufe0f Firewall Rule\n        shell: pwsh\n        run: |\n          New-NetFirewallRule -DisplayName \"HatTrick-Test\" -Direction Inbound -LocalPort ${{ env.SERVICE_PORT }} -Protocol TCP -Action Allow\n\n      - name: \ud83e\udd2b Install MSI (With Logging)\n        shell: pwsh\n        run: |\n          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {\n            sc.exe stop FortunaWebService 2>&1 | Out-Null\n            sc.exe delete FortunaWebService 2>&1 | Out-Null\n          }\n\n          # FIX: Filter \\\"*.msi\\\"\n          $msi = Get-ChildItem -Path \"installer\" -Filter \"*.msi\" -Recurse | Select-Object -First 1\n          if (-not $msi) {\n            Write-Error \"\u274c FATAL: No MSI found in artifact\"\n            Get-ChildItem -Path \"installer\" -Recurse\n            exit 1\n          }\n\n          Write-Host \"Installing: $($msi.FullName)\"\n\n          $msiPath = $msi.FullName\n          # FIX: Quote escaping\n          $args = \"/i `\"$msiPath`\" /qn /L*v installation.log\"\n          $proc = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru\n\n          if ($proc.ExitCode -ne 0) {\n            Write-Error \"\u274c MSI Install Failed with exit code $($proc.ExitCode)\"\n            Get-Content installation.log -Tail 60 | ForEach-Object { Write-Error $_ }\n            throw \"Installation failed\"\n          }\n\n          Write-Host \"\u2705 MSI installation succeeded (Exit Code: 0)\"\n\n      - name: Emit MSI log tail\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path installation.log) {\n            Write-Host \"`n=== installation.log (last 200 lines) ===\"\n            Get-Content installation.log -Tail 200\n          } else {\n            Write-Host \"No installation.log found\"\n          }\n\n      - name: Create Runtime Directories\n        shell: pwsh\n        run: |\n          $installDir = \"C:\\Program Files\\Fortuna Faucet Service\"\n          New-Item -ItemType Directory -Path \"$installDir\\data\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\json\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\logs\" -Force\n          Write-Host \"\u2705 Ensured runtime directories exist in $installDir\"\n\n      - name: Health and Process Validation\n        shell: python\n        env:\n          PORT: ${{ env.SERVICE_PORT }}\n        run: |\n          import os, socket, time, urllib.request, urllib.error, subprocess, sys\n          port = int(os.environ[\"PORT\"])\n\n          # Start Service\n          subprocess.run([\"sc.exe\", \"start\", \"FortunaWebService\"], check=False)\n\n          # Wait for Port\n          for _ in range(30):\n            try:\n              with socket.create_connection((\"127.0.0.1\", port), timeout=1):\n                break\n            except Exception:\n              time.sleep(1)\n          else:\n            print(\"\u274c Port bind timeout\")\n            subprocess.run([\"sc.exe\", \"query\", \"FortunaWebService\"])\n            sys.exit(1)\n\n          # Health Check\n          for _ in range(6):\n            try:\n              req = urllib.request.Request(f\"http://127.0.0.1:{port}/health\")\n              req.add_header(\"User-Agent\", \"HatTrickFusion/1.0\")\n              with urllib.request.urlopen(req, timeout=5) as resp:\n                if resp.status == 200:\n                  print(\"\u2705 Health Check Passed\")\n                  sys.exit(0)\n            except urllib.error.HTTPError as err:\n              if err.code in (401, 403):\n                print(\"\u2705 Service Up (Auth Required\")\n                sys.exit(0)\n            except Exception:\n              time.sleep(2)\n          sys.exit(1)\n\n      - name: Verify UI is Served from Backend\n        shell: pwsh\n        run: |\n          $uri = \"http://127.0.0.1:${{ env.SERVICE_PORT }}/index.html\"\n          Write-Host \"Checking for frontend at $uri\"\n          for ($i = 0; $i -lt 12; $i++) {\n            try {\n              $resp = Invoke-WebRequest -Uri $uri -TimeoutSec 3 -UseBasicParsing -ErrorAction Stop\n              if ($resp.StatusCode -eq 200) {\n                Write-Host \"\u2705 UI is being served correctly.\"\n                exit 0\n              }\n            } catch {\n              Start-Sleep -Seconds 2\n            }\n          }\n          Write-Error \"UI was not served from the backend.\"\n          exit 1\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: Gather diagnostics\n        if: failure()\n        shell: pwsh\n        run: |\n          $diag = Join-Path $PWD \"installer-diag\"\n          Remove-Item $diag -Recurse -Force -ErrorAction SilentlyContinue\n          New-Item -ItemType Directory -Path $diag | Out-Null\n          Copy-Item -Path installation.log -Destination $diag -Force\n          Copy-Item -Path \"C:\\\\ProgramData\\\\Fortuna\\\\logs\\\\*.log\" -Destination $diag -Force -ErrorAction SilentlyContinue\n          Copy-Item -Path \"C:\\\\Program Files\\\\Fortuna Faucet\\\\\" -Destination $diag -Recurse -Force -ErrorAction SilentlyContinue\n      - name: Upload Logs on Failure\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: hat-trick-fusion-logs-${{ github.run_id }}\n          path: installer-diag"
  },
  ".github/workflows/build-msi-hattrickfusion-ultimate.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi-hattrickfusion-ultimate.yml",
    "content": "name: HatTrick Fusion (Ultimate Edition)\non:\n  push:\n    branches: [\"main\"]\n    tags: [\"v*\"]\n  workflow_dispatch:\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  WIX_VERSION: '4.0.5'\n  SERVICE_PORT: '8102'\n  FRONTEND_PORT: '3000'\n  FIREWALL_RULE: 'HatTrickFusion-Port'\n  # Paths\n  FRONTEND_DIR: 'web_platform/frontend'\n  WIX_DIR: 'build_wix'\n  # Settings\n  PYTHONUTF8: '1'\n  # Mock API keys for service startup\n  API_KEY: mock_key\n  TVG_API_KEY: mock\n  GREYHOUND_API_URL: http://mock\n  FORTUNA_ENV: smoke-test\n\njobs:\n  # ==================================================================================\n  # JOB 2: BUILD FRONTEND (Cached & Manifested)\n  # ==================================================================================\n  build-frontend:\n    name: '\ud83c\udfa8 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n      - name: Cache Build Output\n        id: cache-frontend\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.FRONTEND_DIR }}/out\n          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package-lock.json', '**/*.js', '**/*.ts', '**/*.tsx', '**/*.css') }}\n          restore-keys: |\n            ${{ runner.os }}-frontend-\n      - name: Install & Build\n        if: steps.cache-frontend.outputs.cache-hit != 'true'\n        run: |\n          cd ${{ env.FRONTEND_DIR }}\n          npm ci --prefer-offline --no-audit\n          npm run build\n      - name: Generate Artifact Manifest\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_DIR }}/out\"\n          # Fallback for different env var names in different workflows\n          if (-not (Test-Path $outDir)) { $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\" }\n\n          if (-not (Test-Path $outDir)) { Write-Error \"\u274c Build failed: 'out' dir missing\"; exit 1 }\n\n          $manifestPath = \"frontend-manifest.tsv\"\n          \"RelativePath`tSizeBytes`tSHA256\" | Out-File $manifestPath -Encoding utf8\n\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) { Write-Error \"\u274c Build failed: 'out' dir empty\"; exit 1 }\n\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n          foreach ($f in $files) {\n            # FIX: Changed TrimStart('\\\\\\\\', '/') to TrimStart('\\\\', '/') to prevent char conversion error\n            $rel = $f.FullName.Substring($outDir.Path.Length).TrimStart('\\','/')\n            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)\n            \"$rel`t$($f.Length)`t$hash\" | Out-File $manifestPath -Encoding utf8 -Append\n          }\n      - name: Upload Frontend\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}-${{ github.run_attempt }}\n          path: |\n            ${{ env.FRONTEND_DIR }}/out\n            frontend-manifest.tsv\n          retention-days: 3\n\n  # ==================================================================================\n  # JOB 3: BUILD BACKEND (TDD, Cached, Frozen & Injected)\n  # ==================================================================================\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    runs-on: windows-latest\n    needs: [build-frontend]\n    timeout-minutes: 30\n    outputs:\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    env:\n      BACKEND_DIR: 'web_service/backend'\n      MODULE_PATH: 'web_service.backend'\n    steps:\n      - uses: actions/checkout@v4\n      - id: meta\n        shell: pwsh\n        run: |\n          $ver = if (\"${{ github.ref }}\" -match 'refs/tags/v(.*)') { $Matches[1] } else { \"0.0.${{ github.run_number }}\" }\n          \"semver=$ver\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          $sha = git rev-parse --short HEAD\n          \"short_sha=$sha\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n      - uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}-${{ github.run_attempt }}\n          path: ${{ env.FRONTEND_DIR }}/out\n      - name: Clean Staging\n        run: Remove-Item \"${{ env.FRONTEND_DIR }}/out/frontend-manifest.tsv\" -ErrorAction SilentlyContinue\n      - uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n      - name: Install Dependencies\n        run: |\n          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt\n          pip install pyinstaller==6.6.0 pytest pytest-asyncio httpx asgi-lifespan fakeredis\n          pip freeze > backend-freeze.txt\n\n      - name: \ud83e\uddea Run Unit Tests (Quality Gate)\n        shell: pwsh\n        run: |\n          # 1. Define the Failure Threshold\n          $MAX_ALLOWED_FAILURES = 30\n          Write-Host \"Running Test Suite (Threshold: $MAX_ALLOWED_FAILURES failures)...\"\n          # 2. Run Pytest and generate an XML report.\n          # We use 'cmd /c' and '|| true' to ensure the script doesn't die immediately on exit code 1.\n          cmd /c \"pytest ${{ env.BACKEND_DIR }}/tests --junitxml=test-report.xml\" || Write-Host \"Pytest finished with issues.\"\n          # 3. Parse the XML Report\n          if (Test-Path \"test-report.xml\") {\n              [xml]$xml = Get-Content \"test-report.xml\"\n              # Sum up failures and errors\n              $failures = 0\n              $errors = 0\n              # Handle different XML structures (sometimes root is testsuites, sometimes testsuite)\n              if ($xml.testsuites) {\n                  $failures = [int]$xml.testsuites.failures\n                  $errors = [int]$xml.testsuites.errors\n              } elseif ($xml.testsuite) {\n                  $failures = [int]$xml.testsuite.failures\n                  $errors = [int]$xml.testsuite.errors\n              }\n              $total_issues = $failures + $errors\n              Write-Host \"----------------------------------------\"\n              Write-Host \"\ud83d\udcca TEST RESULTS SUMMARY\"\n              Write-Host \"   Failures: $failures\"\n              Write-Host \"   Errors:   $errors\"\n              Write-Host \"   Total:    $total_issues\"\n              Write-Host \"   Limit:    $MAX_ALLOWED_FAILURES\"\n              Write-Host \"----------------------------------------\"\n              # 4. The Decision Logic\n              if ($total_issues -gt $MAX_ALLOWED_FAILURES) {\n                  Write-Error \"\u274c CRITICAL: Too many tests failed ($total_issues). Limit is $MAX_ALLOWED_FAILURES.\"\n                  exit 1\n              } else {\n                  Write-Host \"\u2705 ACCEPTABLE: Failure count is within tolerance. Proceeding with build...\" -ForegroundColor Green\n                  exit 0 # Explicitly exit with success code to override pytest's failure code\n              }\n          } else {\n              Write-Error \"\u274c FATAL: No test report generated. Pytest failed to start.\"\n              exit 1\n          }\n\n      - name: Cache PyInstaller Dist\n        id: cache-backend\n        uses: actions/cache@v4\n        with:\n          path: dist\n          key: ${{ runner.os }}-backend-${{ hashFiles(format('{0}/**', env.BACKEND_DIR)) }}\n\n      - name: Generate Spec & Build\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        shell: python\n        env:\n          BACKEND_DIR: ${{ env.BACKEND_DIR }}\n          MODULE_PATH: ${{ env.MODULE_PATH }}\n          FRONTEND_OUT: ${{ env.FRONTEND_DIR }}/out\n        run: |\n          import os\n          from pathlib import Path\n\n          bk_dir = os.environ['BACKEND_DIR']\n          mod_path = os.environ['MODULE_PATH']\n          # CHANGE: Point to the new service wrapper\n          entry = f\"{bk_dir}/main.py\"\n          frontend_out = os.environ['FRONTEND_OUT']\n\n          # FIX: Fixed quoting in datas list to avoid syntax error\n          spec = f\"\"\"\n          # -- mode: python ; coding: utf-8 --\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n\n          a = Analysis(\n              ['{entry}'],\n              pathex=[],\n              binaries=[],\n              datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],\n              hiddenimports=collect_submodules('{mod_path}') + ['win32timezone'],\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest'],\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False,\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],\n              name='fortuna-backend', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False\n          )\n          \"\"\"\n          with open(\"hat-trick.spec\", \"w\") as f: f.write(spec)\n          os.system(\"pyinstaller hat-trick.spec --clean --noconfirm\")\n      - name: Verify & Hash Executable\n        shell: pwsh\n        run: |\n          $exe = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exe)) { Write-Error \"\u274c Executable missing\"; exit 1 }\n          $size = (Get-Item $exe).Length / 1MB\n          if ($size -lt 10) { Write-Error \"\u274c Executable too small ($size MB)\"; exit 1 }\n          $hash = (Get-FileHash $exe -Algorithm SHA256).Hash\n          $hash | Out-File \"dist/fortuna-backend.exe.sha256\" -Encoding utf8\n          Move-Item backend-freeze.txt dist/\n          Write-Host \"\u2705 Backend ready: $size MB | SHA256: $hash\"\n      - name: Upload Backend\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}\n          path: dist/\n          retention-days: 3\n\n  # ==================================================================================\n  # JOB 4: PACKAGE MSI (WiX v4 with Dietician & Canary)\n  # ==================================================================================\n  package-msi:\n    name: '\ud83d\udcbf Package MSI'\n    runs-on: windows-latest\n    needs: [build-backend]\n    timeout-minutes: 30\n    outputs:\n      msi_name: ${{ steps.name_msi.outputs.msi_name }}\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/download-artifact@v4\n        with:\n          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}\n          path: staging/backend\n\n      - name: Create Restart Service Batch Script\n        shell: pwsh\n        run: |\n          $scriptContent = @\"\n          @echo off\n          echo Requesting Admin privileges to restart FortunaWebService...\n          net stop FortunaWebService\n          net start FortunaWebService\n          echo Service Restarted.\n          pause\n          \"@\n          Set-Content -Path \"staging/backend/restart_service.bat\" -Value $scriptContent -Encoding Ascii\n          Write-Host \"\u2705 Created restart_service.bat script.\"\n\n      - uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: '\u2696\ufe0f The Dietician (Size Analysis)'\n        shell: pwsh\n        run: |\n          $target = \"staging\"\n          $limitMB = 300\n          Write-Host \"--- \ud83d\udcca Size Breakdown ---\"\n          $files = Get-ChildItem -Path $target -Recurse -File -ErrorAction SilentlyContinue\n          if (!$files) { Write-Warning \"No files found to weigh.\"; exit 0 }\n          $totalBytes = ($files | Measure-Object -Property Length -Sum).Sum\n          $totalMB = [math]::Round($totalBytes / 1MB, 2)\n          Write-Host \"Total Payload Size: $totalMB MB\"\n          if ($totalMB -gt $limitMB) {\n              Write-Warning \"\u26a0\ufe0f BLOAT ALERT: Build exceeds $limitMB MB limit! Check the heaviest files below.\"\n          } else {\n              Write-Host \"\u2705 Size within limits (< $limitMB MB).\" -ForegroundColor Green\n          }\n          Write-Host \"`n--- \ud83d\udc18 Top 10 Heaviest Files ---\"\n          $files | Sort-Object Length -Descending | Select-Object -First 10 @{N='File';E={$_.FullName.Replace($pwd,'')}}, @{N='Size(MB)';E={\"{0:N2}\" -f ($_.Length/1MB)}} | Format-Table -AutoSize\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists\n        shell: pwsh\n        run: |\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n          $licensePath = 'build_wix/license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder...'\n            # FIX: Use Base64 decoding to avoid RTF escape sequence issues\n            $rtfContent = [System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String(\"e1xydGYxXGFuc2lcZGVmZjB7XGZvbnR0Ymx7XGYwIEFyaWFsO319XGYwXGZzMjQgRU5EIFVTRVIgTElDRU5TRSBBR1JFRU1FTlRccGFyXHBhciBUaGlzIGlzIGEgcGxhY2Vob2xkZXIgbGljZW5zZSBmb3IgRm9ydHVuYSBGYXVjZXQuIFBsZWFzZSByZXBsYWNlIHdpdGggYWN0dWFsIHRlcm1zLn0=\"))\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: Prepare WiX\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n\n          # Copy template and apply fix\n          Copy-Item build_wix/Product_WithService.wxs build_wix/Product.wxs -Force\n\n          # Stage Executable\n          if (Test-Path staging/backend/fortuna-backend.exe) {\n            Move-Item staging/backend/fortuna-backend.exe staging/backend/fortuna-webservice.exe -Force\n          }\n\n          # FIX: Generate Valid .wixproj with Extensions\n          $proj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">',\n            '  <PropertyGroup>',\n            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',\n            '    <OutputType>Package</OutputType>',\n            '    <Platforms>x64</Platforms>',\n            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',\n            '  </PropertyGroup>',\n            '  <ItemGroup>',\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '  </ItemGroup>',\n            '  <ItemGroup>',\n            '    <Compile Include=\"Product.wxs\" />',\n            '  </ItemGroup>',\n            '</Project>'\n          )\n          Set-Content build_wix/Fortuna.wixproj ($proj -join \"`r`n\") -Encoding utf8\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        # FIX: Pass variables via DefineConstants\n        run: dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"0.0.${{ github.run_number }}\" -p:SourceDir=\"../staging/backend\" -p:ServicePort=\"${{ env.SERVICE_PORT }}\"\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        run: |\n          $msi = Get-ChildItem -Path \"${{ env.WIX_DIR }}/bin/x64/Release\" -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n          if (-not (Test-Path $defender)) { Write-Warning \"Windows Defender CLI not found.\"; exit 0 }\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n          if ($proc.ExitCode -eq 0) { Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green }\n          elseif ($proc.ExitCode -eq 2) { Write-Error \"\ud83d\udea8 THREAT DETECTED!\"; exit 1 }\n          else { Write-Warning \"\u26a0\ufe0f Scan inconclusive: $($proc.ExitCode)\" }\n\n      - name: Rename & Hash MSI\n        id: name_msi\n        shell: pwsh\n        run: |\n          $ver = \"${{ needs.build-backend.outputs.semver }}\"\n          $sha = \"${{ needs.build-backend.outputs.short_sha }}\"\n\n          # FIX: Don't assume the name. Find whatever MSI was built.\n          $releaseDir = \"${{ env.WIX_DIR }}/bin/x64/Release\"\n          $msiFound = Get-ChildItem -Path $releaseDir -Filter \"*.msi\" | Select-Object -First 1\n\n          if (-not $msiFound) {\n            Write-Error \"\u274c FATAL: No MSI file found in $releaseDir. Build may have failed silently.\"\n            exit 1\n          }\n\n          Write-Host \"Found built MSI: $($msiFound.Name)\"\n\n          $targetName = \"HatTrickFusion-${ver}-${sha}.msi\"\n          $newPath = Join-Path $releaseDir $targetName\n\n          Move-Item -Path $msiFound.FullName -Destination $newPath -Force\n\n          # Generate Hash\n          $hash = (Get-FileHash $newPath -Algorithm SHA256).Hash\n          $hash | Out-File \"$newPath.sha256\" -Encoding utf8\n\n          Write-Host \"\u2705 MSI Renamed to: $targetName\"\n          \"msi_name=$targetName\" | Out-File $env:GITHUB_OUTPUT -Append\n\n      - name: Upload MSI\n        uses: actions/upload-artifact@v4\n        with:\n          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}\n          path: ${{ env.WIX_DIR }}/bin/x64/Release/*\n          retention-days: 7\n\n  # ==================================================================================\n  # JOB 5: SMOKE TEST (Triple-Loop + Paparazzi)\n  # ==================================================================================\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test'\n    runs-on: windows-latest\n    needs: [package-msi]\n    timeout-minutes: 30\n    steps:\n      - uses: actions/download-artifact@v4\n        with:\n          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}\n          path: installer\n      - name: \ud83d\udee1\ufe0f Firewall & Install\n        shell: pwsh\n        run: |\n          New-NetFirewallRule -DisplayName \"${{ env.FIREWALL_RULE }}\" -Direction Inbound -LocalPort ${{ env.SERVICE_PORT }} -Protocol TCP -Action Allow\n          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {\n            sc.exe stop FortunaWebService 2>&1 | Out-Null\n            sc.exe delete FortunaWebService 2>&1 | Out-Null\n          }\n          $msi = Get-ChildItem installer -Filter \"*.msi\" -Recurse | Select -First 1\n          if (!$msi) { throw \"No MSI found\" }\n          Write-Host \"Installing $($msi.Name)...\"\n          $msiPath = $msi.FullName\n          $args = \"/i `\"$msiPath`\" /qn /L*v installation.log\"\n          $proc = Start-Process msiexec.exe -ArgumentList $args -Wait -NoNewWindow -PassThru\n          if ($proc.ExitCode -ne 0) {\n            Get-Content install.log -Tail 50\n            throw \"Install failed with code $($proc.ExitCode)\"\n          }\n\n      - name: Create Runtime Directories\n        shell: pwsh\n        run: |\n          $installDir = \"C:\\Program Files\\Fortuna Faucet Service\"\n          New-Item -ItemType Directory -Path \"$installDir\\data\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\json\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\logs\" -Force\n          Write-Host \"\u2705 Ensured runtime directories exist in $installDir\"\n      - name: '\u23f3 Loop 1 - Service Registration'\n        shell: pwsh\n        run: |\n          $reg = \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\FortunaWebService\"\n          for ($i=0; $i -lt 30; $i++) {\n            if (Test-Path $reg) { Write-Host \"\u2705 Service Registered\"; exit 0 }\n            Start-Sleep 1\n          }\n          throw \"Service failed to register in Registry\"\n\n      - name: '\ud83d\ude80 Loop 2 - Launch & Port Bind'\n        shell: python\n        env:\n          PORT: ${{ env.SERVICE_PORT }}\n        run: |\n          import os, socket, time, urllib.request, urllib.error, subprocess, sys\n          port = int(os.environ[\"PORT\"])\n          print(\"--- Starting Service ---\")\n          subprocess.run([\"sc.exe\", \"start\", \"FortunaWebService\"], check=False)\n          print(f\"--- Waiting for Port {port} (60s) ---\")\n          for _ in range(60):\n            try:\n              with socket.create_connection((\"127.0.0.1\", port), timeout=1):\n                print(\"\u2705 Socket bound.\")\n                sys.exit(0)\n            except:\n              time.sleep(1)\n\n          print(\"[X] Port bind timeout\")\n          subprocess.run([\"sc.exe\", \"query\", \"FortunaWebService\"])\n          sys.exit(1)\n\n      - name: '\ud83c\udfe5 Loop 3 - Health Check'\n        shell: python\n        env:\n          PORT: ${{ env.SERVICE_PORT }}\n        run: |\n          import urllib.request, urllib.error, time, sys, os\n          port = int(os.environ[\"PORT\"])\n          for _ in range(6):\n            try:\n              req = urllib.request.Request(f\"http://127.0.0.1:{port}/health\")\n              req.add_header(\"User-Agent\", \"HatTrickFusion/1.0\")\n              with urllib.request.urlopen(req, timeout=5) as resp:\n                if resp.status == 200:\n                  print(\"\u2705 Health Check Passed\")\n                  sys.exit(0)\n            except urllib.error.HTTPError as err:\n              if err.code in (401, 403):\n                print(\"\u2705 Service Up (Auth Required)\")\n                sys.exit(0)\n            except:\n              time.sleep(2)\n          sys.exit(1)\n\n      - name: \ud83d\udcca Capture Diagnostics\n        if: failure()\n        shell: pwsh\n        run: |\n          $diag = \"diagnostics\"\n          New-Item -ItemType Directory -Path $diag -Force\n          Copy-Item install.log $diag\n          Get-EventLog -LogName Application -Source \"FortunaWebService\" -Newest 50 | Out-File \"$diag/events.txt\"\n          Get-Service FortunaWebService | Out-File \"$diag/service_state.txt\"\n          netstat -anob > \"$diag/netstat.txt\"\n      - name: \ud83d\udce4 Upload Diagnostics\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: smoke-test-failure-${{ needs.path-finder.outputs.build_id }}\n          path: diagnostics/\n          retention-days: 30\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        run: |\n          sc.exe stop FortunaWebService\n          sc.exe delete FortunaWebService\n          Remove-NetFirewallRule -DisplayName \"${{ env.FIREWALL_RULE }}\" -ErrorAction SilentlyContinue\n\n  # ==================================================================================\n  # JOB 6: GENERATE SBOM\n  # ==================================================================================\n  generate-sbom:\n    name: '\ud83d\udcdc Generate SBOM'\n    runs-on: ubuntu-latest\n    needs: [build-backend]\n    timeout-minutes: 30\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/download-artifact@v4\n        with:\n          name: backend-dist-${{ github.run_id }}-${{ github.run_attempt }}\n          path: backend\n      - name: Create SBOM\n        uses: anchore/sbom-action@v0\n        with:\n          path: backend\n          output-file: sbom.spdx.json\n          format: spdx-json\n      - name: Upload SBOM\n        uses: actions/upload-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}-${{ github.run_attempt }}\n          path: sbom.json\n\n  # ==================================================================================\n  # JOB 7: RELEASE (On Tag)\n  # ==================================================================================\n  release:\n    name: '\ud83d\ude80 Create Release'\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    needs: [smoke-test, generate-sbom]\n    timeout-minutes: 30\n    permissions:\n      contents: write\n    steps:\n      - uses: actions/download-artifact@v4\n        with:\n          name: msi-installer-${{ github.run_id }}-${{ github.run_attempt }}\n          path: assets\n      - uses: actions/download-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}-${{ github.run_attempt }}\n          path: assets\n      - name: Generate Checksums\n        run: |\n          cd assets\n          sha256sum * > SHASUMS256.txt\n      - name: Publish Release\n        uses: softprops/action-gh-release@v2\n        with:\n          files: assets/*\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-msi-jules.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi-jules.ymlx",
    "content": "name: Build Fortuna Faucet MSI (Jules Challenger)\n\non:\n  workflow_dispatch:\n    inputs:\n      build_target:\n        description: 'Build Target'\n        required: true\n        default: 'web_service'\n        type: 'choice'\n        options:\n        - web_service\n        - electron\n  push:\n    branches:\n      - deactivated\n\npermissions:\n  contents: write\n  actions: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.build_target }}\n  cancel-in-progress: true\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n\njobs:\n  build:\n    name: '\ud83d\udd27 Build & Package ${{ inputs.build_target }}'\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      # ============================================================================\n      # == FRONTEND BUILD (Conditional)\n      # ============================================================================\n      - name: Setup Node.js\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ (inputs.build_target == 'electron' && 'web_platform/frontend/package-lock.json') || 'web_service/frontend/package-lock.json' }}'\n\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          $frontendPath = if (\"${{ inputs.build_target }}\" -eq \"electron\") { \"web_platform/frontend\" } else { \"web_service/frontend\" }\n          Write-Host \"Building frontend at $frontendPath\"\n          cd $frontendPath\n          npm ci\n          npm run build\n\n      # ============================================================================\n      # == BACKEND BUILD (Conditional)\n      # ============================================================================\n      - name: Setup Python\n        id: setup-python\n        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: '${{ (inputs.build_target == 'electron' && 'python_service/requirements.txt') || 'web_service/backend/requirements-dev.txt' }}'\n\n      - name: Backend - Install Dependencies\n        shell: pwsh\n        run: |\n          $requirementsPath = if (\"${{ inputs.build_target }}\" -eq \"electron\") { \"python_service/requirements.txt\" } else { \"web_service/backend/requirements-dev.txt\" }\n          Write-Host \"Installing dependencies from $requirementsPath\"\n          ${{ steps.setup-python.outputs.python-path }} -m pip install --upgrade pip\n          ${{ steps.setup-python.outputs.python-path }} -m pip install -r $requirementsPath\n          ${{ steps.setup-python.outputs.python-path }} -m pip install pyinstaller playwright\n\n      - name: Backend - Build with PyInstaller\n        shell: pwsh\n        run: |\n          $specFile = if (\"${{ inputs.build_target }}\" -eq \"electron\") { \"fortuna-backend-electron.spec\" } else { \"fortuna-webservice.spec\" }\n          Write-Host \"Building with spec file: $specFile\"\n          if (\"${{ inputs.build_target }}\" -ne \"electron\") {\n            # Create the spec file dynamically for the web service\n            cp fortuna-backend-electron.spec fortuna-webservice.spec\n            (Get-Content fortuna-webservice.spec) -replace 'python_service/main.py', 'web_service/backend/main.py' | Set-Content fortuna-webservice.spec\n            (Get-Content fortuna-webservice.spec) -replace 'fortuna-backend', 'fortuna-webservice' | Set-Content fortuna-webservice.spec\n          }\n          ${{ steps.setup-python.outputs.python-path }} -m pyinstaller $specFile --clean --log-level WARN --noconfirm\n\n      # ============================================================================\n      # == PACKAGE MSI (Conditional)\n      # ============================================================================\n      - name: Stage Artifacts and Package MSI\n        shell: pwsh\n        run: |\n          if (\"${{ inputs.build_target }}\" -eq \"electron\") {\n            # Electron Packaging\n            Write-Host \"Staging artifacts for Electron build...\"\n            New-Item -ItemType Directory -Path \"electron/resources\" -Force\n            Move-Item -Path \"dist/fortuna-backend.exe\" -Destination \"electron/resources/fortuna-backend.exe\"\n\n            Write-Host \"Packaging Electron MSI...\"\n            cd electron\n            npm ci\n            npx electron-builder --win --publish=never\n            Copy-Item -Path \"dist/*.msi\" -Destination \"${{ github.workspace }}/dist/\"\n          } else {\n            # Web Service Packaging\n            Write-Host \"Staging artifacts for Web Service build...\"\n            New-Item -ItemType Directory -Path \"build_wix/staging\" -Force\n            Move-Item -Path \"dist/fortuna-webservice.exe\" -Destination \"build_wix/staging/fortuna-webservice.exe\"\n\n            Write-Host \"Packaging Web Service MSI...\"\n            cd build_wix\n            cp ../wix/product_webservice.wxs ./Product_WithService.wxs\n\n            $msiName = \"Fortuna-WebService-${{ github.run_number }}\"\n            $wixProjContent = @\"\n            <Project Sdk=\"WixToolset.Sdk/4.0.5\">\n              <PropertyGroup>\n                <OutputName>$msiName</OutputName>\n                <OutputType>Package</OutputType>\n                <DefineConstants>SourceDir=staging</DefineConstants>\n                <Platforms>x64</Platforms>\n              </PropertyGroup>\n              <ItemGroup>\n                <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"4.0.5\" />\n                <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"4.0.5\" />\n                <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"4.0.5\" />\n              </ItemGroup>\n              <ItemGroup>\n                <Compile Include=\"Product_WithService.wxs\" />\n              </ItemGroup>\n            </Project>\n\"@\n            Set-Content -Path \"Fortuna.wixproj\" -Value $wixProjContent -Encoding UTF8\n\n            $packageVersion = \"1.0.${{ github.run_number }}.0\"\n            dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=$packageVersion\n            Copy-Item -Path \"bin/x64/Release/*.msi\" -Destination \"${{ github.workspace }}/dist/\"\n          }\n\n      - name: Upload Final MSI\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: fortuna-installer-${{ inputs.build_target }}\n          path: dist/*.msi\n          if-no-files-found: error\n\n  # ============================================================================\n  # == RELEASE JOB (Optional)\n  # ============================================================================\n  create-release:\n    name: '\ud83d\ude80 Create GitHub Release'\n    needs: [build]\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          pattern: fortuna-installer-*\n          path: installers/\n          merge-multiple: true\n      - name: Create Release\n        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.2.0\n        with:\n          files: installers/*.msi\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-msi-simplified.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi-simplified.ymlx",
    "content": "name: simplified MSI builder\n\non:\n  push:\n    branches:\n      - main\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  WIX_VERSION: '4.0.5'\n  FRONTEND_DIR: 'web_platform/frontend'\n  WIX_DIR: 'build_wix'\n\njobs:\n  path-finder:\n    name: '\ud83d\udd0e Path Finder - Dynamic Backend Detection'\n    runs-on: windows-latest\n    outputs:\n      backend_dir: ${{ steps.find-path.outputs.backend_dir }}\n      backend_module_path: ${{ steps.find-path.outputs.backend_module_path }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Detect Backend Path\n        id: find-path\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $web_service_path = \"web_service/backend\"\n          $python_service_path = \"python_service\"\n          $backend_dir = \"\"\n          $backend_module_path = \"\"\n          $spec_file = \"\"\n\n          Write-Host \"--- Path Finding Forensics ---\"\n          Write-Host \"Searching for the correct backend service directory...\"\n\n          # Test web_service path\n          $web_service_main = Test-Path (Join-Path $web_service_path \"main.py\")\n          $web_service_api = Test-Path (Join-Path $web_service_path \"api.py\")\n          $web_service_init = Test-Path (Join-Path $web_service_path \"__init__.py\")\n          Write-Host \"Checking '$web_service_path':\"\n          Write-Host \"  main.py -> $web_service_main\"\n          Write-Host \"  api.py -> $web_service_api\"\n          Write-Host \"  __init__.py -> $web_service_init\"\n\n          # Test python_service path\n          $python_service_main = Test-Path (Join-Path $python_service_path \"main.py\")\n          $python_service_api = Test-Path (Join-Path $python_service_path \"api.py\")\n          $python_service_init = Test-Path (Join-Path $python_service_path \"__init__.py\")\n          Write-Host \"Checking '$python_service_path':\"\n          Write-Host \"  main.py -> $python_service_main\"\n          Write-Host \"  api.py -> $python_service_api\"\n          Write-Host \"  __init__.py -> $python_service_init\"\n\n          if ($web_service_main -and $web_service_api -and $web_service_init) {\n            $backend_dir = $web_service_path\n            $backend_module_path = \"web_service.backend\"\n            $spec_file = \"webservice.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'web_service/backend' as the target.\" -ForegroundColor Green\n          } elseif ($python_service_main -and $python_service_api -and $python_service_init) {\n            $backend_dir = $python_service_path\n            $backend_module_path = \"python_service\"\n            $spec_file = \"fortuna-backend-webservice.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'python_service' as the target.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c FATAL: Could not determine a valid backend directory. Neither 'web_service/backend' nor 'python_service' contains the required files (main.py, api.py, __init__.py).\" -ForegroundColor Red\n            exit 1\n          }\n\n          Write-Host \"--- Outputs ---\"\n          Write-Host \"backend_dir: $backend_dir\"\n          Write-Host \"backend_module_path: $backend_module_path\"\n          Write-Host \"spec_file: $spec_file\"\n\n          \"backend_dir=$backend_dir\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_module_path=$backend_module_path\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n  build:\n    name: '\ud83d\udee0\ufe0f Build Unified Artifact'\n    runs-on: windows-latest\n    needs: path-finder\n    env:\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n    outputs:\n      build_id: ${{ steps.vars.outputs.build_id }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Set Build ID\n        id: vars\n        run: echo \"build_id=${{ github.run_id }}-${{ github.run_attempt }}\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Install Frontend Dependencies & Build\n        run: |\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline\n          npm run build\n          cd ../..\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: '${{ env.BACKEND_DIR }}/requirements.txt'\n\n      - name: Install Backend Dependencies\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt\n          pip install pyinstaller==6.6.0\n\n      - name: Create Dynamic webservice.spec for PyInstaller\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          $entry_point = (Join-Path $env:BACKEND_DIR \"main.py\").Replace('\\', '/')\n          $staging_ui_path = (Resolve-Path \"web_platform/frontend/out\").Path.Replace('\\', '/')\n          $other_service = if (\"$env:BACKEND_DIR\" -eq \"web_service/backend\") { \"python_service\" } else { \"web_service\" }\n\n          # Forcefully create non-empty __init__.py files if missing\n          $init_path = (Join-Path $env:BACKEND_DIR \"__init__.py\")\n          if (-not (Test-Path $init_path)) { Set-Content -Path $init_path -Value \"# DUMMY\" }\n          if ($env:BACKEND_DIR -eq \"web_service/backend\") {\n             if (-not (Test-Path \"web_service/__init__.py\")) { Set-Content -Path \"web_service/__init__.py\" -Value \"# DUMMY\" }\n          }\n\n          # Get absolute paths for datas section\n          $backend_init = (Resolve-Path $init_path).Path.Replace('\\', '/')\n          # Calculate destination path inside the archive (e.g. 'web_service\\backend')\n          $backend_dest = $env:BACKEND_DIR.Replace('/', '\\')\n\n          # Check for parent init\n          $parent_init_path = (Join-Path (Split-Path $env:BACKEND_DIR) \"__init__.py\")\n          $parent_init = \"\"\n          if (Test-Path $parent_init_path) {\n            $parent_init = (Resolve-Path $parent_init_path).Path.Replace('\\', '/')\n          }\n\n          # Start building the Python Spec content\n          $specContent = @(\n            \"# -*- mode: python ; coding: utf-8 -*-\",\n            \"import os\",\n            \"from pathlib import Path\",\n            \"from PyInstaller.utils.hooks import collect_data_files\",\n            \"block_cipher = None\",\n            \"a = Analysis(\",\n            \"    ['$entry_point'],\",\n            \"    pathex=[os.getcwd()],\",\n            \"    hiddenimports=['uvicorn.lifespan.on', 'uvicorn.loops.auto', 'uvicorn.protocols.http.h11_impl'],\",\n            \"    hookspath=[],\",\n            \"    runtime_hooks=[],\",\n            \"    excludes=['$other_service', 'tests'],\",\n            \"    win_no_prefer_redirects=False,\",\n            \"    win_private_assemblies=False,\",\n            \"    cipher=block_cipher,\",\n            \"    noarchive=False,\",\n            \")\",\n            \"# Explicitly bundle the __init__.py files as data\",\n            \"a.datas += [\",\n            \"    ('$staging_ui_path', 'ui'),\",\n            \"    ('$backend_init', '$backend_dest')\"\n          )\n\n          # Append parent init if it exists (PowerShell logic outside Python string)\n          if ($parent_init -ne \"\") {\n             $dest = (Split-Path $env:BACKEND_DIR -Leaf)\n             $specContent += \"    ,('$parent_init', '$dest')\"\n          }\n\n          # Close the list and define the One-File EXE\n          $specContent += @(\n            \"]\",\n            \"pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\",\n            \"exe = EXE(\",\n            \"    pyz,\",\n            \"    a.scripts,\",\n            \"    a.binaries,\",  # <--- CRITICAL: Include binaries here for One-File\",\n            \"    a.zipfiles,\",  # <--- CRITICAL: Include zipfiles here for One-File\",\n            \"    a.datas,\",     # <--- CRITICAL: Include datas here for One-File\",\n            \"    [],\",\n            \"    name='fortuna-backend',\",\n            \"    debug=False,\",\n            \"    bootloader_ignore_signals=False,\",\n            \"    strip=False,\",\n            \"    upx=True,\",\n            \"    upx_exclude=[],\",\n            \"    runtime_tmpdir=None,\",\n            \"    console=False,\",\n            \"    disable_windowed_traceback=False,\",\n            \"    argv_emulation=False,\",\n            \"    target_arch=None,\",\n            \"    codesign_identity=None,\",\n            \"    entitlements_file=None,\",\n            \")\"\n          )\n\n          Set-Content -Path \"simplified.spec\" -Value ($specContent -join \"`n\")\n          Write-Host \"\u2705 Dynamically generated 'simplified.spec' (One-File Mode) created.\"\n\n      - name: Build with PyInstaller\n        run: pyinstaller simplified.spec --clean --noconfirm\n\n      - name: Verify Executable Contents\n        shell: python\n        run: |\n          import zipfile\n          import sys\n          import os\n\n          exe_path = os.path.join('dist', 'fortuna-backend.exe')\n          module_path = \"${{ env.BACKEND_MODULE_PATH }}\".replace('.', '/')\n          expected_files = [\n              os.path.join(module_path, '__init__.py').replace('\\\\', '/')\n          ]\n          if \"${{ env.BACKEND_DIR }}\" == \"web_service/backend\":\n              expected_files.append('web_service/__init__.py'.replace('\\\\', '/'))\n\n          print(f\"--- Verifying onefile executable: {exe_path} ---\")\n          if not os.path.exists(exe_path):\n              print(f\"\u274c FATAL: Executable not found at {exe_path}\")\n              sys.exit(1)\n\n          found_all = True\n          try:\n              with zipfile.ZipFile(exe_path, 'r') as zf:\n                  archive_files = [f.replace('\\\\', '/') for f in zf.namelist()]\n                  print(f\"Found {len(archive_files)} files in the archive.\")\n\n                  for expected in expected_files:\n                      if expected in archive_files:\n                          print(f\"\u2705 Found required file: {expected}\")\n                      else:\n                          print(f\"\u274c MISSING required file: {expected}\")\n                          found_all = False\n          except Exception as e:\n              print(f\"\u274c Error inspecting executable: {e}\")\n              sys.exit(1)\n\n          if not found_all:\n              print(\"\\n--- Full Archive Listing ---\")\n              for f in sorted(archive_files):\n                  print(f)\n              print(\"-----------------------------\")\n              sys.exit(1)\n\n          print(\"\\n\u2705 All critical files verified in executable.\")\n\n      - name: Upload Backend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-dist-${{ steps.vars.outputs.build_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 1\n\n  package-msi:\n    name: '\ud83d\udcbf Package MSI'\n    runs-on: windows-latest\n    needs: build\n    outputs:\n      build_id: ${{ needs.build.outputs.build_id }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-dist-${{ needs.build.outputs.build_id }}\n          path: staging\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: Prepare WiX Project\n        run: |\n          Set-StrictMode -Version Latest\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n          $wixProj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">'\n            '  <PropertyGroup>'\n            '    <OutputName>Fortuna-WebService-Simplified</OutputName>'\n            '    <OutputType>Package</OutputType>'\n            '    <DefineConstants>SourceDir=../staging</DefineConstants>'\n            '  </PropertyGroup>'\n            '  <ItemGroup>'\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '  </ItemGroup>'\n            '  <ItemGroup>'\n            '    <Compile Include=\"Product.wxs\" />'\n            '  </ItemGroup>'\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value $wixProj -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: |\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64\n\n      - name: Upload MSI Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: msi-installer-${{ needs.build.outputs.build_id }}\n          path: ${{ env.WIX_DIR }}/bin/x64/Release/*.msi\n          retention-days: 1\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test'\n    runs-on: windows-latest\n    needs: package-msi\n    steps:\n      - name: Download MSI Installer\n        uses: actions/download-artifact@v4\n        with:\n          name: msi-installer-${{ needs.package-msi.outputs.build_id }}\n          path: msi-installer\n\n      - name: Install MSI\n        run: |\n          Set-StrictMode -Version Latest\n          $msi = Get-ChildItem -Path \"msi-installer\" -Filter \"*.msi\" -Recurse | Select-Object -First 1\n          if ($null -eq $msi) {\n            Write-Error \"MSI file not found in artifact\"\n            exit 1\n          }\n          Start-Process msiexec.exe -ArgumentList \"/i `\"$($msi.FullName)`\" /qn\" -Wait\n          $installDir = \"C:\\Program Files\\Fortuna Faucet\"\n          if (-not (Test-Path \"$installDir\\fortuna-backend.exe\")) {\n            Write-Error \"Application executable not found after installation\"\n            exit 1\n          }\n          Write-Host \"\u2705 Application appears to be installed\"\n\n      - name: Launch Service & Verify Health\n        env:\n          SERVICE_PORT: '8102'\n        shell: python\n        run: |\n          import os\n          import sys\n          import subprocess\n          import socket\n          import time\n          from contextlib import closing\n\n          HOST = \"127.0.0.1\"\n          PORT = int(os.environ.get(\"SERVICE_PORT\", \"8102\"))\n          STARTUP_TIMEOUT = 60\n          POLL_INTERVAL = 0.5\n\n          def check_socket(host, port):\n              with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as sock:\n                  return sock.connect_ex((host, port)) == 0\n\n          print(\"--- Starting Smoke Test ---\")\n          # Start the service via the command that the installer sets up\n          try:\n              print(\"Attempting to start the 'FortunaFaucetService'...\")\n              subprocess.run([\"sc.exe\", \"start\", \"FortunaFaucetService\"], check=True, capture_output=True, text=True)\n              print(\"Service start command issued successfully.\")\n          except subprocess.CalledProcessError as e:\n              print(f\"\u274c Error starting service with sc.exe: {e}\")\n              print(f\"   stdout: {e.stdout}\")\n              print(f\"   stderr: {e.stderr}\")\n              # It might have already been started, so we continue but with a warning.\n              print(\"\u26a0\ufe0f  Service might have already been running, proceeding with check...\")\n          except FileNotFoundError:\n              print(\"\u274c FATAL: sc.exe not found. This test can only run on Windows.\")\n              sys.exit(1)\n\n\n          print(f\"Waiting for service to start listening on port {PORT} (timeout: {STARTUP_TIMEOUT}s)...\")\n          start_time = time.time()\n          service_ready = False\n          while time.time() - start_time < STARTUP_TIMEOUT:\n              if check_socket(HOST, PORT):\n                  print(f\"\u2705 Service is running and listening on port {PORT}.\")\n                  service_ready = True\n                  break\n              time.sleep(POLL_INTERVAL)\n              print(\".\", end=\"\", flush=True)\n\n          if not service_ready:\n              print(f\"\\n\u274c FATAL: Timed out after {STARTUP_TIMEOUT}s waiting for service.\")\n              # Try to get service status\n              result = subprocess.run([\"sc.exe\", \"query\", \"FortunaFaucetService\"], capture_output=True, text=True)\n              print(\"\\n--- Service Status (sc query) ---\")\n              print(result.stdout)\n              print(result.stderr)\n              print(\"---------------------------------\")\n              sys.exit(1)\n\n          # If we get here, the test passed.\n          print(\"\\nSmoke test passed!\")\n\n      - name: Cleanup\n        if: always()\n        run: |\n          sc.exe stop FortunaFaucetService\n          sc.exe delete FortunaFaucetService\n"
  },
  ".github/workflows/build-msi-unified.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi-unified.yml",
    "content": "# System Timestamp: 2025-12-04 14:04:28.986665\nname: Unified MSI Builder (Jules's Gold Standard)\n\non:\n  push:\n    branches:\n      - main\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  WIX_VERSION: '4.0.5'\n  FRONTEND_DIR: 'web_platform/frontend'\n  WIX_DIR: 'build_wix'\n  SERVICE_PORT: '8102'\n  UPGRADE_CODE: 'FA689549-366B-4C5C-A482-1132F9A34B10'\n  # Mock API keys for service startup\n  API_KEY: mock_key\n  TVG_API_KEY: mock\n  GREYHOUND_API_URL: http://mock\n  FORTUNA_ENV: smoke-test\n\njobs:\n  quality-gate:\n    name: '\u2705 Quality Gate'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            web_service/backend/requirements.txt\n            web_service/backend/requirements-dev.txt\n\n      - name: Install Python Dependencies\n        run: |\n          python -m pip install --upgrade pip\n          if (Test-Path \"web_service/backend/requirements-dev.txt\") {\n            pip install -r web_service/backend/requirements-dev.txt\n          } else {\n            # Fallback to standard requirements if -dev is not found\n            pip install -r web_service/backend/requirements.txt\n          }\n\n      - name: Run Pytest\n        shell: pwsh\n        run: |\n          # Check if pytest is installed before trying to run it\n          $pytest_exists = Get-Command pytest -ErrorAction SilentlyContinue\n          if (-not $pytest_exists) {\n            Write-Host \"\u2139\ufe0f pytest not found in dependencies, skipping tests.\"\n            exit 0\n          }\n\n          python -m pytest web_service/backend\n\n          # Exit code 5 means no tests were found, which is not a failure in this context.\n          if ($LASTEXITCODE -eq 5) {\n            Write-Host \"\u2705 Pytest returned exit code 5 (No tests found), which is acceptable.\"\n            exit 0\n          } elseif ($LASTEXITCODE -ne 0) {\n            Write-Error \"\u274c Pytest failed with exit code $LASTEXITCODE.\"\n            exit $LASTEXITCODE\n          }\n          Write-Host \"\u2705 Pytest suite passed.\"\n\n  build-executable:\n    name: '\ud83d\udee0\ufe0f Build Executable'\n    runs-on: windows-latest\n    needs: [quality-gate]\n    timeout-minutes: 30\n    env:\n      BACKEND_DIR: 'web_service/backend'\n      BACKEND_MODULE_PATH: 'web_service.backend'\n    outputs:\n      build_id: ${{ steps.vars.outputs.build_id }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Set Build ID\n        id: vars\n        run: echo \"build_id=${{ github.run_id }}-${{ github.run_attempt }}\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Install Frontend Dependencies & Build\n        shell: pwsh\n        run: |\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline\n          npm run build\n          cd ../..\n\n      - name: Generate Artifact Manifest\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_DIR }}/out\"\n          # Fallback for different env var names in different workflows\n          if (-not (Test-Path $outDir)) { $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\" }\n\n          if (-not (Test-Path $outDir)) { Write-Error \"\u274c Build failed: 'out' dir missing\"; exit 1 }\n\n          $manifestPath = \"frontend-manifest.tsv\"\n          \"RelativePath`tSizeBytes`tSHA256\" | Out-File $manifestPath -Encoding utf8\n\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) { Write-Error \"\u274c Build failed: 'out' dir empty\"; exit 1 }\n\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n          foreach ($f in $files) {\n            # FIX: Changed TrimStart('\\\\\\\\', '/') to TrimStart('\\\\', '/') to prevent char conversion error\n            $rel = $f.FullName.Substring($outDir.Path.Length).TrimStart('\\','/')\n            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)\n            \"$rel`t$($f.Length)`t$hash\" | Out-File $manifestPath -Encoding utf8 -Append\n          }\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: '${{ env.BACKEND_DIR }}/requirements.txt'\n\n      - name: Install Backend Dependencies\n        shell: pwsh\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r ${{ env.BACKEND_DIR }}/requirements.txt\n          pip install pyinstaller==6.6.0\n\n      - name: Generate Spec & Build\n        shell: python\n        env:\n          BACKEND_DIR: ${{ env.BACKEND_DIR }}\n          MODULE_PATH: ${{ env.BACKEND_MODULE_PATH }}\n          FRONTEND_OUT: ${{ env.FRONTEND_DIR }}/out\n        run: |\n          import os\n          from pathlib import Path\n\n          bk_dir = os.environ['BACKEND_DIR'].replace('\\\\', '/')\n          mod_path = os.environ['MODULE_PATH']\n          frontend_out = os.environ['FRONTEND_OUT'].replace('\\\\', '/')\n\n          entry = f\"{bk_dir}/main.py\"\n\n          spec = f\"\"\"\n          # -- mode: python ; coding: utf-8 --\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n\n          a = Analysis(\n              ['{entry}'],\n              pathex=[],\n              binaries=[],\n              datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],\n              hiddenimports=collect_submodules('{mod_path}') + ['win32timezone'],\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest'],\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False,\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],\n              name='fortuna-backend', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False\n          )\n          \"\"\"\n          with open(\"unified.spec\", \"w\") as f: f.write(spec)\n          os.system(\"pyinstaller unified.spec --clean --noconfirm\")\n\n      - name: Upload Backend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-dist-${{ steps.vars.outputs.build_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 1\n\n      - name: \ud83d\udce4 Upload Executable on Failure\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: failed-executable-${{ steps.vars.outputs.build_id }}\n          path: dist/\n          retention-days: 5\n\n  package-msi:\n    name: '\ud83d\udcbf Package MSI'\n    runs-on: windows-latest\n    needs: [build-executable]\n    timeout-minutes: 30\n    outputs:\n      build_id: ${{ needs.build-executable.outputs.build_id }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-dist-${{ needs.build-executable.outputs.build_id }}\n          path: staging/backend\n\n      - name: Rename Executable for WiX\n        shell: pwsh\n        run: |\n          if (Test-Path staging/backend/fortuna-backend.exe) {\n            Rename-Item -Path staging/backend/fortuna-backend.exe -NewName fortuna-webservice.exe -Force\n            Write-Host \"\u2705 Renamed executable to fortuna-webservice.exe\"\n          } else {\n            Write-Error \"\u274c Executable not found in staging directory!\"\n            exit 1\n          }\n\n      - name: Create Restart Service Batch Script\n        shell: pwsh\n        run: |\n          $scriptContent = @\"\n          @echo off\n          echo Requesting Admin privileges to restart FortunaWebService...\n          net stop FortunaWebService\n          net start FortunaWebService\n          echo Service Restarted.\n          pause\n          \"@\n          Set-Content -Path \"staging/backend/restart_service.bat\" -Value $scriptContent -Encoding Ascii\n          Write-Host \"\u2705 Created restart_service.bat script.\"\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists\n        shell: pwsh\n        run: |\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n          $licensePath = 'build_wix/license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder...'\n            $rtfContent = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0\\fs24 END USER LICENSE AGREEMENT\\par\\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: Prepare WiX Project\n        shell: pwsh\n        run: |\n          # 1. Copy the template\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n\n          # 3. Generate Project with CAB embedding enabled\n          $proj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">',\n            '  <PropertyGroup>',\n            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',\n            '    <OutputType>Package</OutputType>',\n            '    <Platforms>x64</Platforms>',\n            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',\n            '  </PropertyGroup>',\n            '  <ItemGroup>',\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '  </ItemGroup>',\n            '  <ItemGroup>',\n            '    <Compile Include=\"Product.wxs\" />',\n            '  </ItemGroup>',\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value ($proj -join \"`r`n\") -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"0.0.${{ github.run_number }}\" -p:SourceDir=\"../staging/backend\" -p:ServicePort=\"${{ env.SERVICE_PORT }}\"\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        continue-on-error: true\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: Upload MSI Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: msi-installer-${{ needs.build-executable.outputs.build_id }}\n          path: ${{ env.WIX_DIR }}/bin/x64/Release/*\n          retention-days: 1\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test (Unified)'\n    runs-on: windows-latest\n    needs: package-msi\n    steps:\n      - name: Download MSI Installer\n        uses: actions/download-artifact@v4\n        with:\n          name: msi-installer-${{ needs.package-msi.outputs.build_id }}\n          path: msi-installer\n\n      - name: \ud83d\udee1\ufe0f Configure Firewall\n        shell: pwsh\n        run: |\n          New-NetFirewallRule `\n            -DisplayName \"FortunaWebService\" `\n            -Direction Inbound `\n            -LocalPort 8102 `\n            -Protocol TCP `\n            -Action Allow `\n            -ErrorAction SilentlyContinue\n          Write-Host \"\u2705 Firewall rule added for port 8102\"\n\n      - name: \ud83e\udd2b Install MSI (With Logging)\n        shell: pwsh\n        run: |\n          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {\n            sc.exe stop FortunaWebService 2>&1 | Out-Null\n            sc.exe delete FortunaWebService 2>&1 | Out-Null\n          }\n\n          $msi = Get-ChildItem -Path \"msi-installer\" -Filter \"*.msi\" -Recurse | Select-Object -First 1\n          if (-not $msi) {\n            Write-Error \"\u274c FATAL: No MSI found in artifact\"\n            Get-ChildItem -Path \"msi-installer\" -Recurse\n            exit 1\n          }\n\n          Write-Host \"Installing: $($msi.FullName)\"\n\n          $proc = Start-Process msiexec.exe `\n            -ArgumentList \"/i `\"$($msi.FullName)`\" /qn /L*v msi-install.log\" `\n            -Wait `\n            -NoNewWindow `\n            -PassThru\n\n          if ($proc.ExitCode -ne 0) {\n            Write-Error \"\u274c MSI Install Failed with exit code $($proc.ExitCode)\"\n            exit 1\n          }\n\n          Write-Host \"\u2705 MSI installation succeeded\"\n\n      - name: Emit MSI log tail\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path msi-install.log) {\n            Write-Host \"`n=== msi-install.log (last 200 lines) ===\"\n            Get-Content msi-install.log -Tail 200\n          } else {\n            Write-Host \"No msi-install.log found\"\n          }\n\n      - name: \u23f3 Wait for Service Registration\n        shell: pwsh\n        run: |\n          $regPath = \"HKLM:\\SYSTEM\\CurrentControlSet\\Services\\FortunaWebService\"\n          Write-Host \"Waiting for service to be registered in registry...\"\n\n          for ($i = 0; $i -lt 30; $i++) {\n            if (Test-Path $regPath) {\n              Write-Host \"\u2705 Service registered (took $i seconds)\"\n              $svc = Get-Service -Name \"FortunaWebService\" -ErrorAction SilentlyContinue\n              Write-Host \"   DisplayName: $($svc.DisplayName)\"\n              Write-Host \"   Status: $($svc.Status)\"\n              exit 0\n            }\n            Write-Host \"  Waiting... ($i/30 seconds)\"\n            Start-Sleep -Seconds 1\n          }\n\n          Write-Error \"\u274c Service was not registered in HKLM after 30 seconds\"\n          exit 1\n\n      - name: Create Runtime Directories\n        shell: pwsh\n        run: |\n          $installDir = \"C:\\Program Files\\Fortuna Faucet Service\"\n          New-Item -ItemType Directory -Path \"$installDir\\data\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\json\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\logs\" -Force\n          Write-Host \"\u2705 Ensured runtime directories exist in $installDir\"\n\n      - name: \ud83d\ude80 Launch & Verify Health\n        shell: python\n        env:\n          SERVICE_PORT: '8102'\n        run: |\n          import os, sys, subprocess, socket, time, urllib.request, urllib.error\n\n          PORT = int(os.getenv(\"SERVICE_PORT\", 8102))\n\n          print(\"--- Starting Service via SC.EXE ---\")\n          result = subprocess.run(\n            [\"sc.exe\", \"start\", \"FortunaWebService\"],\n            capture_output=True,\n            text=True\n          )\n          print(f\"sc.exe output: {result.stdout}\")\n          if result.stderr:\n            print(f\"sc.exe stderr: {result.stderr}\")\n\n          print(f\"\\n--- Waiting for Port {PORT} (up to 60 seconds) ---\")\n          start_time = time.time()\n          socket_bound = False\n\n          while time.time() - start_time < 60:\n            try:\n              with socket.create_connection((\"127.0.0.1\", PORT), timeout=1):\n                elapsed = time.time() - start_time\n                print(f\"\u2705 Socket bound after {elapsed:.1f} seconds.\")\n                socket_bound = True\n                break\n            except Exception as e:\n              elapsed = time.time() - start_time\n              print(f\"  Waiting... {elapsed:.1f}s\", end=\"\\r\")\n              time.sleep(2)\n\n          if not socket_bound:\n            print(f\"\\n\u274c FATAL: Service did not bind port 8102 within 60 seconds\")\n            print(\"Dumping service status for debugging:\")\n            subprocess.run([\"sc.exe\", \"query\", \"FortunaWebService\"])\n            sys.exit(1)\n\n          time.sleep(2)\n\n          print(\"\\n--- HTTP Health Check ---\")\n          for attempt in range(5):\n            try:\n              req = urllib.request.Request(f\"http://127.0.0.1:{PORT}/health\")\n              req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)')\n\n              with urllib.request.urlopen(req, timeout=5) as response:\n                if response.status == 200:\n                  print(f\"\u2705 Health Check PASSED (HTTP 200).\")\n                  sys.exit(0)\n                else:\n                  print(f\"\u26a0\ufe0f  Unexpected status {response.status}\")\n\n            except urllib.error.HTTPError as e:\n              if e.code in [401, 403]:\n                print(f\"\u26a0\ufe0f  Got HTTP {e.code} \u2014 service is responding!\")\n                sys.exit(0)\n              print(f\"Attempt {attempt + 1}: HTTP {e.code}\")\n\n            except Exception as e:\n              print(f\"Attempt {attempt + 1}: {type(e).__name__}: {e}\")\n\n            if attempt < 4:\n              time.sleep(2)\n\n          print(\"\u274c Health Check FAILED after 5 attempts\")\n          sys.exit(1)\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: Gather diagnostics\n        if: failure()\n        shell: pwsh\n        run: |\n          $diag = Join-Path $PWD \"installer-diag\"\n          Remove-Item $diag -Recurse -Force -ErrorAction SilentlyContinue\n          New-Item -ItemType Directory -Path $diag | Out-Null\n          Copy-Item -Path msi-install.log -Destination $diag -Force\n          Copy-Item -Path \"C:\\ProgramData\\Fortuna\\logs\\*.log\" -Destination $diag -Force -ErrorAction SilentlyContinue\n          Copy-Item -Path \"C:\\Program Files\\Fortuna Faucet\\*\" -Destination $diag -Recurse -Force -ErrorAction SilentlyContinue\n      - name: \ud83d\udce4 Upload Logs on Failure\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: unified-smoke-test-logs-${{ github.run_id }}\n          path: installer-diag\n          retention-days: 7\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        shell: pwsh\n        run: |\n          sc.exe stop FortunaWebService 2>&1 | Out-Null\n          sc.exe delete FortunaWebService 2>&1 | Out-Null\n          Remove-NetFirewallRule -DisplayName \"FortunaWebService\" -ErrorAction SilentlyContinue\n          Write-Host \"\u2705 Cleanup complete\"\n"
  },
  ".github/workflows/build-msi.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-msi.ymlx",
    "content": "# System Timestamp: 2025-11-29 13:19:26.933797\nname: Build Fortuna Web Service MSI (The Veteran)\n\non:\n  push:\n    branches:\n      - main\n      - session/jules1130b\n    tags:\n      - 'v*'\n  pull_request:\n    branches:\n      - main\n  workflow_dispatch:\n\npermissions:\n  contents: read\n  actions: read\n  checks: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\ndefaults:\n  run:\n    shell: pwsh\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  PYTHONUTF8: '1'\n  PIP_DISABLE_PIP_VERSION_CHECK: '1'\n  PIP_NO_PYTHON_VERSION_WARNING: '1'\n  NPM_CONFIG_FUND: 'false'\n  NPM_CONFIG_AUDIT: 'false'\n  FORCE_COLOR: '3'\n\n  # === PATH CONFIGURATION ===\n  FRONTEND_DIR: 'web_platform/frontend'\n  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'\n  BACKEND_DIR: 'web_service/backend'\n  WIX_DIR: 'build_wix'\n  BACKEND_SPEC: 'webservice.spec'\n\n  # === RUNTIME CONFIG ===\n  SERVICE_PORT: '8102'\n  HEALTH_ENDPOINT: '/health'\n  API_KEY: ${{ secrets.TEST_API_KEY }}\n  FORTUNA_MODE: 'webservice'\n\n  # === OUTPUTS ===\n  MSI_STAGING_DIR: 'build_wix/staging'\n  MSI_OUTPUT_DIR: 'dist'\n  WIX_VERSION: '4.0.5'\n\njobs:\n  repo-preflight:\n    name: '\ud83e\uddea Repo Preflight & Integrity'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    outputs:\n      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}\n      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}\n      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: Derive Build Metadata\n        id: meta\n        run: |\n          Set-StrictMode -Version Latest\n          $ref = \"${{ github.ref }}\"\n          if ($ref -like 'refs/tags/v*') {\n            $semver = $ref -replace 'refs/tags/v', ''\n          } else {\n            $semver = \"0.0.${{ github.run_number }}\"\n          }\n          $shortSha = \"${{ github.sha }}\".Substring(0,7)\n          \"semver=$semver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"short_sha=$shortSha\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\ud83d\udd16 Version: $semver ($shortSha)\"\n\n      - name: Validate Critical Files Exist\n        run: |\n          Set-StrictMode -Version Latest\n          $paths = @(\n            \"${{ env.FRONTEND_DIR }}/package.json\",\n            \"${{ env.FRONTEND_DIR }}/package-lock.json\",\n            \"${{ env.BACKEND_DIR }}/requirements.txt\",\n            \"${{ env.BACKEND_DIR }}/main.py\",\n            \"${{ env.WIX_DIR }}/Product_WithService.wxs\"\n          )\n          foreach ($path in $paths) {\n            if (-not (Test-Path $path)) {\n              Write-Host \"\u274c FATAL: Required path missing: $path\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical files confirmed.\"\n\n      - name: Capture Integrity Hashes\n        id: hashes\n        run: |\n          Set-StrictMode -Version Latest\n          $frontend = (Get-FileHash \"${{ env.FRONTEND_DIR }}/package-lock.json\" -Algorithm SHA256).Hash\n          $backend = (Get-FileHash \"${{ env.BACKEND_DIR }}/requirements.txt\" -Algorithm SHA256).Hash\n          $wix = (Get-FileHash \"${{ env.WIX_DIR }}/Product_WithService.wxs\" -Algorithm SHA256).Hash\n          \"frontend_lock_hash=$frontend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_requirements_hash=$backend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"wix_definition_hash=$wix\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Upload Integrity Snapshot\n        uses: actions/upload-artifact@v4\n        with:\n          name: repo-preflight-${{ github.run_id }}\n          path: |\n            ${{ env.FRONTEND_DIR }}/package-lock.json\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.WIX_DIR }}/Product_WithService.wxs\n          retention-days: 1\n\n  frontend-quality:\n    name: '\ud83e\uddfc Frontend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Run Lint (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {\n            Write-Host \"\ud83e\uddf9 Running npm run lint\"\n            npm run lint\n          } else {\n            Write-Host \"\u2139\ufe0f No lint script defined, skipping.\"\n          }\n\n      - name: Run Tests (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {\n            Write-Host \"\ud83e\uddea Running npm test -- --watch=false\"\n            npm test -- --watch=false\n          } else {\n            Write-Host \"\u2139\ufe0f No test script defined, skipping.\"\n          }\n\n      - name: Security Audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm audit --audit-level=critical\n\n  backend-quality:\n    name: '\ud83e\uddef Backend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: repo-preflight\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r \"${{ env.BACKEND_DIR }}/requirements.txt\"\n          if (Test-Path \"${{ env.BACKEND_DIR }}/requirements-dev.txt\") {\n            pip install -r \"${{ env.BACKEND_DIR }}/requirements-dev.txt\"\n          } else {\n            Write-Host \"\u2139\ufe0f requirements-dev.txt not found, skipping.\"\n          }\n\n      - name: Bytecode Compile (Fail Fast)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m compileall -q \"${{ env.BACKEND_DIR }}\"\n\n      - name: Run Pytest (if available)\n        run: |\n          Set-StrictMode -Version Latest\n          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec(\"pytest\") else 1)'\n          if ($LASTEXITCODE -eq 0) {\n            Write-Host \"\ud83e\uddea pytest detected, running suite...\"\n            python -m pytest \"${{ env.BACKEND_DIR }}\" --maxfail=1 --disable-warnings\n          } else {\n            Write-Host \"\u2139\ufe0f pytest not installed; skipping tests.\"\n          }\n\n      - name: pip-audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          pip install pip-audit\n          pip-audit -r ${{ env.BACKEND_DIR }}/requirements.txt\n\n  sbom:\n    name: '\ud83d\udcc4 SBOM Snapshot'\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Generate SBOM (SPDX)\n        uses: anchore/sbom-action@v0\n        with:\n          output-file: sbom.spdx.json\n          format: spdx-json\n\n      - name: Upload SBOM\n        uses: actions/upload-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: sbom.spdx.json\n          retention-days: 7\n\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: repo-preflight\n    env:\n      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Prime npm Cache\n        uses: actions/cache@v4\n        with:\n          path: ~\\AppData\\Local\\npm-cache\n          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}\n          restore-keys: |\n            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Build Frontend\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm run build\n\n      - name: Verify Build Output\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          if (-not (Test-Path $outDir)) {\n             Write-Host \"\u274c FATAL: Build directory not found\" -ForegroundColor Red\n             exit 1\n          }\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) {\n             Write-Host \"\u274c FATAL: Build directory empty\" -ForegroundColor Red\n             exit 1\n          }\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          retention-days: 1\n\n  pre-build-forensics:\n    name: '\ud83c\udf33 Pre-Build Forensic File Tree'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    needs: [repo-preflight, build-frontend]\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: web_platform/frontend/out\n      - name: \ud83d\udcdc Log Full File Tree\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          Write-Host \"--- Complete Workspace File Tree ---\"\n          Get-ChildItem -Recurse | ForEach-Object {\n            # Format the output to be more readable\n            $depth = $_.FullName.Split('\\').Count - $env:GITHUB_WORKSPACE.Split('\\').Count\n            $indent = \"  \" * $depth\n            Write-Host \"$indent- $($_.Name)\"\n          }\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [repo-preflight, build-frontend, pre-build-forensics]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: temp-frontend\n\n      - name: Stage Frontend for PyInstaller\n        run: |\n          Set-StrictMode -Version Latest\n          $dest = \"staging/ui\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n          Copy-Item -Path \"temp-frontend/*\" -Destination $dest -Recurse -Force\n          Write-Host \"\u2705 Frontend staged for inclusion.\"\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r \"${{ env.BACKEND_DIR }}/requirements.txt\"\n          if (Test-Path \"${{ env.BACKEND_DIR }}/requirements-dev.txt\") {\n            pip install -r \"${{ env.BACKEND_DIR }}/requirements-dev.txt\"\n          }\n\n      - name: Create webservice.spec for PyInstaller\n        run: |\n          $specContent = @\"\n          # -*- mode: python ; coding: utf-8 -*-\n          import os\n          from pathlib import Path\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n          project_root = Path(SPECPATH)\n          version_string = os.environ.get(\"FORTUNA_VERSION\", \"0.0.0\")\n\n          # Explicitly include the frontend UI files\n          datas = [\n              (str(project_root / 'staging/ui'), 'ui')\n          ]\n          # Include necessary data files from installed packages\n          datas += collect_data_files(\"uvicorn\")\n          datas += collect_data_files(\"slowapi\")\n          datas += collect_data_files(\"structlog\")\n          datas += collect_data_files(\"certifi\")\n\n          hiddenimports = set()\n          hiddenimports.update(collect_submodules(\"web_service.backend\"))\n          hiddenimports.update([\n              \"uvicorn.logging\", \"uvicorn.loops.auto\", \"uvicorn.lifespan.on\",\n              \"uvicorn.protocols.http.h11_impl\", \"uvicorn.protocols.websockets.wsproto_impl\",\n              \"fastapi.routing\", \"starlette.staticfiles\", \"anyio._backends._asyncio\",\n              \"httpcore\", \"httpx\", \"slowapi\", \"structlog\", \"tenacity\", \"aiosqlite\",\n              \"pydantic_core\", \"pydantic_settings.sources\", \"web_service.backend.main\"\n          ])\n\n          a = Analysis(\n              ['web_service/backend/main.py'],\n              pathex=[str(project_root)],\n              binaries=[],\n              datas=datas,\n              hiddenimports=sorted(hiddenimports),\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest', 'python_service'], # CRITICAL: Exclude the other service\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz,\n              a.scripts,\n              a.binaries,\n              a.zipfiles,\n              a.datas,\n              [],\n              name='fortuna-backend',\n              debug=False,\n              bootloader_ignore_signals=False,\n              strip=False,\n              upx=True,\n              runtime_tmpdir=None,\n              console=False,\n              disable_windowed_traceback=False,\n              argv_emulation=False,\n              target_arch=None,\n              codesign_identity=None,\n              entitlements_file=None\n          )\n          \"@\n          Set-Content -Path \"${{ env.BACKEND_SPEC }}\" -Value $specContent\n          Write-Host \"\u2705 Custom webservice.spec created.\"\n\n      - name: Create Required Backend Directories\n        run: |\n          Set-StrictMode -Version Latest\n          New-Item -ItemType Directory -Path \"${{ env.BACKEND_DIR }}/data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"${{ env.BACKEND_DIR }}/json\" -Force | Out-Null\n          Write-Host \"\u2705 Created required backend directories.\"\n\n      - name: Ensure Python Package Structure\n        run: |\n          Set-Content -Path \"web_service/__init__.py\" -Value \"\"\n          Set-Content -Path \"web_service/backend/__init__.py\" -Value \"\"\n          Write-Host \"\u2705 Ensured __init__.py files exist for package discovery.\"\n\n      - name: Build with PyInstaller\n        env:\n          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n        run: |\n          Set-StrictMode -Version Latest\n          pyinstaller \"${{ env.BACKEND_SPEC }}\" --clean --log-level=WARN --noconfirm\n\n      - name: Verify Executable\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exePath)) {\n            Write-Host \"\u274c FATAL: Executable not found\" -ForegroundColor Red\n            exit 1\n          }\n          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash\n          $size = (Get-Item $exePath).Length / 1MB\n          if ($size -lt 10) {\n            Write-Host \"\u274c FATAL: Executable is suspiciously small: $($size) MB.\" -ForegroundColor Red\n            exit 1\n          }\n          \"fortuna-backend.exe`t$hash\" | Out-File backend-sha256.tsv -Encoding utf8\n          Write-Host \"\u2705 Backend ready: $([math]::Round($size, 2)) MB ($hash)\"\n\n      - name: Upload Backend Executable\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 3\n\n      - name: Upload Backend Metadata\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-metadata-${{ github.run_id }}\n          path: backend-sha256.tsv\n          retention-days: 7\n\n  smoke-test-service:\n    name: '\ud83d\udd2c Smoke Test Service'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: build-backend\n    env:\n      SMOKE_LOG_DIR: 'logs'\n      FORTUNA_ENV: 'smoke-test'\n    steps:\n      - name: Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: Prepare Environment\n        run: |\n          Set-StrictMode -Version Latest\n          New-Item -ItemType Directory -Path $env:SMOKE_LOG_DIR -Force | Out-Null\n          New-Item -ItemType Directory -Path \"data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"json\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"logs\" -Force | Out-Null\n          New-NetFirewallRule -DisplayName \"FortunaSmokeTest\" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.SERVICE_PORT }} -ErrorAction SilentlyContinue\n\n      - name: Analyze Executable (Safe Check)\n        run: |\n          Set-StrictMode -Version Latest\n          $exe = \"dist/fortuna-backend.exe\"\n\n          # PE Check\n          $bytes = [System.IO.File]::ReadAllBytes($exe)\n          if ($bytes[0] -ne 0x4D -or $bytes[1] -ne 0x5A) {\n             Write-Host \"\u274c Invalid PE signature\" -ForegroundColor Red\n             exit 1\n          }\n          Write-Host \"\u2705 PE Signature OK\"\n\n          # String Check (PATCHED TO AVOID EXIT CODE 1)\n          $searchString = \"uvicorn\"\n          # Select-String returns $null if not found, doesn't throw error\n          $found = Select-String -Path $exe -Pattern $searchString -Encoding ascii -Quiet -SimpleMatch\n          if ($found) {\n             Write-Host \"\u2705 Found '$searchString' signature\" -ForegroundColor Green\n          } else {\n             Write-Host \"\u2139\ufe0f '$searchString' not found in plain text (likely compressed). Continuing...\" -ForegroundColor Gray\n          }\n\n          # Force successful exit code\n          exit 0\n\n      - name: Start Service\n        run: |\n          Set-StrictMode -Version Latest\n          $env:API_KEY = \"${{ env.API_KEY }}\"\n          $env:FORTUNA_PORT = \"${{ env.SERVICE_PORT }}\"\n          $env:FORTUNA_MODE = \"${{ env.FORTUNA_MODE }}\"\n\n          $proc = Start-Process -FilePath \"dist\\\\fortuna-backend.exe\" `\n            -PassThru `\n            -RedirectStandardOutput \"$env:SMOKE_LOG_DIR/backend-out.txt\" `\n            -RedirectStandardError \"$env:SMOKE_LOG_DIR/backend-err.txt\"\n          $proc.Id | Out-File backend.pid -Encoding ascii\n          Write-Host \"\u2705 Service started (PID: $($proc.Id))\"\n          Write-Host \"Pausing for 10 seconds to allow service initialization...\"\n          Start-Sleep -Seconds 10\n\n      - name: Wait for Health (Polling)\n        run: |\n          Set-StrictMode -Version Latest\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}\"\n          $deadline = (Get-Date).AddMinutes(3)\n          $success = $false\n          $attempt = 0\n          while ((Get-Date) -lt $deadline) {\n            $attempt++\n            Write-Host \"Health check attempt $attempt...\"\n            try {\n              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop\n              if ($resp.StatusCode -eq 200) {\n                $success = $true\n                Write-Host \"\u2705 Health check PASSED on attempt $attempt.\" -ForegroundColor Green\n                break\n              }\n            } catch {\n              Write-Host \"  Attempt $attempt failed: $_\" -ForegroundColor Yellow\n            }\n            Start-Sleep -Seconds 5\n          }\n\n          if (-not $success) {\n            Write-Host \"\u274c FATAL: Health check failed after multiple attempts.\" -ForegroundColor Red\n            Get-Content \"$env:SMOKE_LOG_DIR/backend-err.txt\" -Tail 40 | Write-Host\n            exit 1\n          }\n\n      - name: Verify API Response\n        run: |\n          Set-StrictMode -Version Latest\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}/api/races\"\n          $headers = @{ 'X-API-Key' = \"${{ env.API_KEY }}\" }\n          try {\n            $resp = Invoke-WebRequest -Uri $url -Headers $headers -UseBasicParsing -TimeoutSec 5\n            if ($resp.StatusCode -in 200,400,401) {\n              Write-Host \"\u2705 API verification successful (HTTP $($resp.StatusCode))\"\n            } else {\n               throw \"Unexpected status code: $($resp.StatusCode)\"\n            }\n          } catch {\n            Write-Host \"\u274c API Verification Failed: $_\"\n            exit 1\n          }\n\n      - name: Upload Logs\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: smoke-test-logs-${{ github.run_id }}\n          path: |\n            ${{ env.SMOKE_LOG_DIR }}/\n            backend.pid\n          retention-days: 7\n\n      - name: Teardown\n        if: always()\n        run: |\n          if (Test-Path 'backend.pid') {\n            $processId = Get-Content backend.pid\n            Stop-Process -Id $processId -Force -ErrorAction SilentlyContinue\n          }\n          Remove-NetFirewallRule -DisplayName \"FortunaSmokeTest\" -ErrorAction SilentlyContinue\n\n  diagnose-runtime:\n    name: '\ud83d\udd0e Diagnose PyInstaller Runtime'\n    runs-on: windows-latest\n    timeout-minutes: 10\n    needs: build-backend\n    steps:\n      - name: \ud83d\udce5 Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: \ud83d\udc0d Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: \ud83d\udce6 Install PyInstaller\n        run: pip install pyinstaller==6.6.0\n\n      - name: \ud83d\udd75\ufe0f Extract and Analyze Executable Contents\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n\n          Write-Host \"--- Executable Analysis ---\"\n          Write-Host \"Analyzing contents of $exePath with pyi-archive_viewer...\"\n\n          $archiveContents = pyi-archive_viewer $exePath\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"Failed to analyze executable with pyi-archive_viewer.\"\n            exit 1\n          }\n\n          Write-Host \"\\n--- Archive Contents ---\"\n          $archiveContents | Out-Host\n\n          $expectedInitFile = 'web_service\\backend\\__init__.py'\n          Write-Host \"\\n--- Verification ---\"\n          Write-Host \"Searching for key module file: '$expectedInitFile' in archive contents...\"\n\n          if ($archiveContents | Select-String -Pattern $expectedInitFile -Quiet -SimpleMatch) {\n            Write-Host \"\u2705 SUCCESS: Key module file found inside the executable archive.\" -ForegroundColor Green\n          } else {\n            Write-Error \"\u274c FAILURE: Key module file '$expectedInitFile' NOT found inside the executable. This confirms a bundling error.\"\n            exit 1\n          }\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [repo-preflight, smoke-test-service, diagnose-runtime]\n    env:\n      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: Stage Artifacts\n        id: stage\n        run: |\n          Set-StrictMode -Version Latest\n          $staging = \"${{ env.MSI_STAGING_DIR }}\"\n          New-Item -ItemType Directory -Path $staging -Force | Out-Null\n          Move-Item -Path \"dist/fortuna-backend.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n          $msiName = \"Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi\".Replace('/', '-')\n          \"msi_name=$msiName\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\u2705 Staged for MSI: $msiName\"\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: Cache NuGet\n        uses: actions/cache@v4\n        with:\n          path: ~/.nuget/packages\n          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}\n\n      - name: Prepare WiX Project\n        run: |\n          Set-StrictMode -Version Latest\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n          $wixProj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">'\n            '  <PropertyGroup>'\n            '    <OutputName>${{ steps.stage.outputs.msi_name }}</OutputName>'\n            '    <OutputType>Package</OutputType>'\n            '    <DefineConstants>SourceDir=staging</DefineConstants>'\n            '    <Platforms>x64</Platforms>'\n            '    <Version>${{ env.BUILD_VERSION }}</Version>'\n            '  </PropertyGroup>'\n            '  <ItemGroup>'\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '  </ItemGroup>'\n            '  <ItemGroup>'\n            '    <Compile Include=\"Product.wxs\" />'\n            '  </ItemGroup>'\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value $wixProj -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: |\n          Set-StrictMode -Version Latest\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"${{ env.BUILD_VERSION }}\"\n          $msiFile = \"bin/x64/Release/${{ steps.stage.outputs.msi_name }}\"\n          if (-not (Test-Path $msiFile)) { throw \"MSI not created\" }\n          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash\n          $hash | Out-File \"$msiFile.sha256\" -Encoding utf8\n          Write-Host \"\u2705 MSI Built: $hash\"\n\n      - name: Upload MSI + Hash\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: |\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.msi\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.sha256\n          retention-days: 10\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    needs: package-msi-service\n    permissions:\n      contents: write\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          pattern: fortuna-service-msi-*\n          merge-multiple: true\n          path: assets\n\n      - name: Generate Checksums\n        run: |\n          cd assets\n          ls *.msi\n          sha256sum *.msi > SHASUMS256.txt\n\n      - name: Publish Release\n        uses: softprops/action-gh-release@v2\n        with:\n          files: |\n            assets/*.msi\n            assets/*.sha256\n            assets/SHASUMS256.txt\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-web-service-msi-claude.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-web-service-msi-claude.ymlx",
    "content": "name: Build Fortuna Faucet MSI (WiX v4) - Claude\n\non:\n  push:\n    branches:\n      - deactivated\n  workflow_dispatch:\n\n# Restrict permissions to minimum necessary\npermissions:\n  contents: read\n  actions: read\n\n# Prevent concurrent builds on same ref\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n  # Cache keys for better cache hits\n  FRONTEND_CACHE_KEY: ${{ hashFiles('web_service/frontend/package-lock.json') }}\n  BACKEND_CACHE_KEY: ${{ hashFiles('web_service/backend/requirements-dev.txt') }}\n\njobs:\n  # ============================================================================\n  # JOB 1: BUILD FRONTEND\n  # ============================================================================\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n        with:\n          fetch-depth: 0\n\n      - name: Setup Node.js\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_service/frontend/package-lock.json'\n\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          cd web_service/frontend\n          npm ci --prefer-offline\n          npm run build\n\n      - name: Verify Frontend Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $outDir = 'web_service/frontend/out'\n          if (-not (Test-Path $outDir)) {\n            Write-Host \"\u274c FATAL: Build output directory 'out' not created\" -ForegroundColor Red\n            exit 1\n          }\n          $fileCount = (Get-ChildItem -Path $outDir -Recurse -File | Measure-Object).Count\n          if ($fileCount -eq 0) {\n            Write-Host \"\u274c FATAL: Build output directory is empty\" -ForegroundColor Red\n            exit 1\n          }\n          Write-Host \"\u2705 Frontend build verified: $fileCount files created\" -ForegroundColor Green\n\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: web_service/frontend/out\n          retention-days: 1\n          if-no-files-found: error\n\n  # ============================================================================\n  # JOB 2: BUILD BACKEND\n  # ============================================================================\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    needs: [build-frontend]\n    runs-on: windows-latest\n    timeout-minutes: 20\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n        with:\n          fetch-depth: 0\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: web_service/frontend/out\n\n      - name: Setup Python\n        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: 'web_service/backend/requirements-dev.txt'\n\n      - name: Backend - Install Dependencies\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          python -m pip install --upgrade pip\n          pip install -r web_service/backend/requirements-dev.txt\n\n      - name: Verify PyInstaller Entry Point\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $specFile = \"fortuna-webservice.spec\"\n          if (-not (Test-Path $specFile)) {\n            Write-Host \"\u274c FATAL: Spec file not found: $specFile\" -ForegroundColor Red\n            exit 1\n          }\n          $specContent = Get-Content $specFile -Raw\n          if ($specContent -match \"Analysis\\(\\s*\\[?'([^']+)'\") {\n            $entryPoint = $matches[1]\n            $entryPointPath = $entryPoint -replace '/', '\\'\n            if (Test-Path $entryPointPath) {\n              Write-Host \"\u2705 Entry point file exists: $entryPointPath\" -ForegroundColor Green\n            } else {\n              Write-Host \"\u274c FATAL: Entry point file NOT found: $entryPointPath\" -ForegroundColor Red\n              exit 1\n            }\n          } else {\n            Write-Host \"\u26a0\ufe0f WARNING: Could not parse entry point from spec file\" -ForegroundColor Yellow\n          }\n\n      - name: Backend - Build with PyInstaller\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          pyinstaller fortuna-webservice.spec --clean --log-level WARN --noconfirm\n\n      - name: Verify Backend Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $exePath = \"dist/fortuna-webservice.exe\"\n          if (-not (Test-Path $exePath)) {\n            Write-Host \"\u274c FATAL: Backend executable not created at $exePath\" -ForegroundColor Red\n            exit 1\n          }\n          $fileSize = (Get-Item $exePath).Length / 1MB\n          Write-Host \"\u2705 Backend executable verified: $($fileSize.ToString('F2')) MB\" -ForegroundColor Green\n\n      - name: Upload Backend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist/fortuna-webservice.exe\n          retention-days: 1\n          if-no-files-found: error\n\n  # ============================================================================\n  # JOB 3: SMOKE TEST SERVICE\n  # ============================================================================\n  smoke-test-service:\n    name: '\ud83d\udd2c Smoke Test Service'\n    needs: [build-backend]\n    runs-on: windows-latest\n    timeout-minutes: 15\n    env:\n      API_KEY: \"a_secure_test_api_key_that_is_long_enough_for_smoke_test\"\n      FORTUNA_MODE: \"webservice\"\n      FORTUNA_PORT: 8088\n      SMOKE_FRONTEND_URL: \"http://localhost:8088\"\n      SMOKE_HEADING_SELECTOR: \"h1:has-text('Fortuna Faucet')\"\n      SMOKE_SCREENSHOT_PATH: \"smoke-test-screenshot.png\"\n      SMOKE_FAILURE_SCREENSHOT_PATH: \"smoke-test-screenshot-FAILURE.png\"\n    steps:\n      - name: Download Backend Artifact\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: .\n\n      - name: Configure Firewall\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          New-NetFirewallRule -DisplayName \"Allow Fortuna Smoke Test\" `\n            -Direction Inbound `\n            -Action Allow `\n            -Protocol TCP `\n            -LocalPort ${{ env.FORTUNA_PORT }} `\n            -ErrorAction SilentlyContinue\n          Write-Host \"\u2705 Firewall rule configured for port ${{ env.FORTUNA_PORT }}\" -ForegroundColor Green\n\n      - name: Create Runtime Directories\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          New-Item -ItemType Directory -Path \"./data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"./logs\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"./json\" -Force | Out-Null\n          Write-Host \"\u2705 Created runtime directories: data, logs, json\" -ForegroundColor Green\n\n      - name: Start Web Service\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $backendProcess = Start-Process -FilePath \"./fortuna-webservice.exe\" `\n            -PassThru `\n            -RedirectStandardOutput \"backend-out.log\" `\n            -RedirectStandardError \"backend-err.log\"\n          Set-Content -Path \"backend.pid\" -Value $backendProcess.Id\n          Write-Host \"\u2705 Backend started with PID: $($backendProcess.Id)\" -ForegroundColor Green\n          Start-Sleep -Seconds 10\n\n      - name: Health Check\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Continue\"\n          $healthUrl = \"http://127.0.0.1:${{ env.FORTUNA_PORT }}/health\"\n          $maxAttempts = 15\n          $delaySeconds = 2\n          $success = $false\n\n          For ($i = 1; $i -le $maxAttempts; $i++) {\n            try {\n              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 Health check passed on attempt $i\" -ForegroundColor Green\n                $success = $true\n                break\n              }\n            } catch {\n              Write-Host \"Attempt $i of $maxAttempts failed. Retrying in $delaySeconds seconds...\" -ForegroundColor Yellow\n              Start-Sleep -Seconds $delaySeconds\n            }\n          }\n\n          if (-not $success) {\n            Write-Host \"\u274c Health check failed after $maxAttempts attempts\" -ForegroundColor Red\n            exit 1\n          }\n\n      - name: Setup Playwright\n        if: success() || failure()\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          pip install playwright\n          python -m playwright install chromium\n\n      - name: Frontend UI Verification\n        if: success() || failure()\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $scriptContent = @\"\n          import sys, os\n          from playwright.sync_api import sync_playwright, expect\n\n          def run_verification():\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  context = browser.new_context()\n                  context.tracing.start(screenshots=True, snapshots=True)\n                  page = context.new_page()\n                  try:\n                      url = os.environ[\"SMOKE_FRONTEND_URL\"]\n                      page.goto(url, wait_until='networkidle', timeout=20000)\n                      heading = page.locator(os.environ[\"SMOKE_HEADING_SELECTOR\"])\n                      expect(heading).to_be_visible(timeout=10000)\n                      page.screenshot(path=os.environ[\"SMOKE_SCREENSHOT_PATH\"])\n                      print(\"\u2705 Frontend verification successful\")\n                      context.tracing.stop(path = \"trace.zip\")\n                      sys.exit(0)\n                  except Exception as e:\n                      print(f\"\u274c Error: {e}\", file=sys.stderr)\n                      page.screenshot(path=os.environ[\"SMOKE_FAILURE_SCREENSHOT_PATH\"])\n                      context.tracing.stop(path = \"trace.zip\")\n                      sys.exit(1)\n                  finally:\n                      browser.close()\n\n          if __name__ == \"__main__\":\n              run_verification()\n          \"@\n          Set-Content -Path \"verify_frontend.py\" -Value $scriptContent\n          python verify_frontend.py\n\n      - name: Upload Verification Screenshot\n        if: always()\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: smoke-test-screenshot-${{ github.run_id }}\n          path: |\n            ${{ env.SMOKE_SCREENSHOT_PATH }}\n            ${{ env.SMOKE_FAILURE_SCREENSHOT_PATH }}\n            trace.zip\n          if-no-files-found: warn\n\n      - name: Collect Forensic Logs\n        if: always()\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Continue\"\n          $logFile = \"forensic-analysis.log\"\n\n          \"=== FORENSIC ANALYSIS ===\" | Out-File $logFile -Encoding utf8\n          \"`n--- ENVIRONMENT VARIABLES ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-ChildItem Env: | Sort-Object Name | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n\n          \"`n--- RUNNING PROCESSES ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-Process | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n\n          \"`n--- NETWORK CONNECTIONS ---\" | Out-File $logFile -Append -Encoding utf8\n          netstat -ano | Out-File $logFile -Append -Encoding utf8\n\n          \"`n--- BACKEND STDOUT ---\" | Out-File $logFile -Append -Encoding utf8\n          if (Test-Path backend-out.log) { Get-Content backend-out.log -Raw | Out-File $logFile -Append -Encoding utf8 }\n\n          \"`n--- BACKEND STDERR ---\" | Out-File $logFile -Append -Encoding utf8\n          if (Test-Path backend-err.log) { Get-Content backend-err.log -Raw | Out-File $logFile -Append -Encoding utf8 }\n\n          Write-Host \"\u2705 Forensic analysis written to $logFile\" -ForegroundColor Green\n\n      - name: Upload Forensic Analysis\n        if: always()\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: forensic-analysis-${{ github.run_id }}\n          path: |\n            forensic-analysis.log\n            backend-out.log\n            backend-err.log\n          retention-days: 7\n          if-no-files-found: ignore\n\n      - name: Teardown Processes\n        if: always()\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Continue\"\n          if (Test-Path \"backend.pid\") {\n            $pid = Get-Content \"backend.pid\"\n            Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue\n            Write-Host \"\u2705 Stopped process $pid\" -ForegroundColor Green\n          }\n          Remove-NetFirewallRule -DisplayName \"Allow Fortuna Smoke Test\" -ErrorAction SilentlyContinue\n\n  # ============================================================================\n  # JOB 4: PACKAGE SERVICE MSI\n  # ============================================================================\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    needs: [smoke-test-service]\n    runs-on: windows-latest\n    timeout-minutes: 20\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n        with:\n          fetch-depth: 0\n\n      - name: Download Backend Executable\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: ./dist\n\n      - name: Stage Build Artifacts\n        id: stage_files\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $staging = \"build_wix/staging\"\n          New-Item -ItemType Directory -Path $staging -Force | Out-Null\n\n          # Move backend executable\n          Move-Item -Path \"./dist/fortuna-webservice.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n\n          # Determine MSI name\n          $branchName = \"${{ github.ref_name }}\"\n          $msiName = if ($branchName -match \"main\") {\n            \"Fortuna-WebService-Nightly.msi\"\n          } else {\n            \"Fortuna-WebService-$($branchName -replace '/', '-').msi\"\n          }\n\n          Write-Host \"MSI will be named: $msiName\" -ForegroundColor Green\n          \"msi_name=$msiName\" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Setup .NET 8 SDK\n        uses: actions/setup-dotnet@3e891b0cb619bf60e2c25674b222b8940e2c1c25 # v4.1.0\n        with:\n          dotnet-version: '8.0.x'\n\n      - name: Copy WiX Source File\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          Copy-Item -Path \"wix/product_webservice.wxs\" -Destination \"build_wix/Product_WithService.wxs\" -Force\n          Write-Host \"\u2705 Copied WiX source file to build directory.\" -ForegroundColor Green\n\n      - name: Remove Conflicting WXS File\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $conflictFile = \"build_wix/Product_WithoutService.wxs\"\n          if (Test-Path $conflictFile) {\n            Remove-Item $conflictFile -Force\n            Write-Host \"\u2705 Removed conflicting file: $conflictFile\" -ForegroundColor Green\n          }\n\n      - name: Generate WiX Project File\n        working-directory: build_wix\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $msiOutputName = \"${{ steps.stage_files.outputs.msi_name }}\".Replace('.msi', '')\n          $wixProjContent = @\"\n          <Project Sdk=\"WixToolset.Sdk/4.0.5\">\n            <PropertyGroup>\n              <OutputName>$msiOutputName</OutputName>\n              <OutputType>Package</OutputType>\n              <DefineConstants>SourceDir=staging</DefineConstants>\n              <Platforms>x64</Platforms>\n              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>\n            </PropertyGroup>\n            <ItemGroup>\n              <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"4.0.5\" />\n            </ItemGroup>\n            <ItemGroup>\n              <Compile Include=\"Product_WithService.wxs\" />\n            </ItemGroup>\n          </Project>\n          \"@\n          Set-Content -Path \"Fortuna.wixproj\" -Value $wixProjContent -Encoding UTF8\n          Write-Host \"\u2705 Generated WiX project file\" -ForegroundColor Green\n\n      - name: Build MSI\n        working-directory: build_wix\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          $packageVersion = \"${{ github.run_number }}.${{ github.run_attempt }}.0\"\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=$packageVersion\n\n          $msiPath = \"bin/x64/Release/${{ steps.stage_files.outputs.msi_name }}\"\n          if (-not (Test-Path $msiPath)) {\n            Write-Host \"\u274c FATAL: Service MSI was not created at $msiPath\" -ForegroundColor Red\n            exit 1\n          }\n\n          New-Item -ItemType Directory -Path \"dist\" -Force | Out-Null\n          Copy-Item -Path $msiPath -Destination \"dist/\" -Force\n          Write-Host \"\u2705 MSI built successfully\" -ForegroundColor Green\n\n      - name: Upload MSI Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: fortuna-installer-service-${{ github.run_id }}\n          path: build_wix/dist/*.msi\n          retention-days: 7\n          if-no-files-found: error\n\n  # ============================================================================\n  # JOB 5: CREATE GITHUB RELEASE (only on tags)\n  # ============================================================================\n  create-release:\n    name: '\ud83d\ude80 Create GitHub Release'\n    needs: [package-msi-service]\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    permissions:\n      contents: write\n    steps:\n      - name: Download MSI Artifact\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          pattern: fortuna-installer-service-*\n          path: installers/\n          merge-multiple: true\n\n      - name: Create Release\n        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.2.0\n        with:\n          files: installers/*.msi\n          body: |\n            \ud83d\ude80 **Fortuna Faucet Production Release**\n\n            Native Windows Service Installer.\n\n            ### Installation\n            1. Download the MSI installer below\n            2. Run the installer with administrator privileges\n            3. Follow the setup wizard\n\n            ### What's Included\n            - FastAPI backend service\n            - Next.js frontend (static build)\n            - Windows Service integration\n            - Firewall configuration\n\n          draft: false\n          prerelease: false\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-web-service-msi-gpt5.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-web-service-msi-gpt5.ymlx",
    "content": "# System Timestamp: 2025-11-30 10:29:10.703207\nname: Build Fortuna Faucet Web Service Installer (Omega Overkill)\n\non:\n  push:\n    branches:\n      - main\n      - session/jules1130b\n    tags:\n      - 'v*'\n    paths:\n      - 'python_service/**'\n      - 'web_service/backend/**'\n      - 'web_platform/frontend/**'\n      - 'fortuna-backend-webservice.spec'\n      - 'webservice.spec'\n      - '.github/workflows/build-web-service-msi-gpt5.yml'\n  workflow_dispatch:\n\npermissions:\n  contents: read\n  actions: read\n  checks: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\ndefaults:\n  run:\n    shell: pwsh\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  PYTHONUTF8: '1'\n  PIP_DISABLE_PIP_VERSION_CHECK: '1'\n  PIP_NO_PYTHON_VERSION_WARNING: '1'\n  NPM_CONFIG_FUND: 'false'\n  NPM_CONFIG_AUDIT: 'false'\n  FORCE_COLOR: '3'\n  FRONTEND_DIR: 'web_platform/frontend'\n  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'\n  WIX_DIR: 'build_wix'\n  SERVICE_PORT: '8102'\n  HEALTH_ENDPOINT: '/health'\n  API_KEY: ${{ secrets.TEST_API_KEY }}\n  MSI_STAGING_DIR: 'build_wix/staging'\n  MSI_OUTPUT_DIR: 'dist'\n  WIX_VERSION: '4.0.5'\n\njobs:\n  path-finder:\n    name: '\ud83d\udd0e Path Finder (Dynamic Backend Detection)'\n    runs-on: windows-latest\n    outputs:\n      backend_dir: ${{ steps.find-path.outputs.backend_dir }}\n      backend_module_path: ${{ steps.find-path.outputs.backend_module_path }}\n      spec_file: ${{ steps.find-path.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Detect Backend Path\n        id: find-path\n        run: |\n          Set-StrictMode -Version Latest\n          $web_service_path = \"web_service/backend\"\n          $python_service_path = \"python_service\"\n          $backend_dir = \"\"\n          $backend_module_path = \"\"\n          $spec_file = \"\"\n\n          Write-Host \"--- Path Finding Forensics ---\"\n          Write-Host \"Searching for the correct backend service directory...\"\n\n          # Test web_service path\n          $web_service_main = Test-Path (Join-Path $web_service_path \"main.py\")\n          $web_service_api = Test-Path (Join-Path $web_service_path \"api.py\")\n          $web_service_init = Test-Path (Join-Path $web_service_path \"__init__.py\")\n          Write-Host \"Checking '$web_service_path':\"\n          Write-Host \"  main.py -> $web_service_main\"\n          Write-Host \"  api.py -> $web_service_api\"\n          Write-Host \"  __init__.py -> $web_service_init\"\n\n          # Test python_service path\n          $python_service_main = Test-Path (Join-Path $python_service_path \"main.py\")\n          $python_service_api = Test-Path (Join-Path $python_service_path \"api.py\")\n          $python_service_init = Test-Path (Join-Path $python_service_path \"__init__.py\")\n          Write-Host \"Checking '$python_service_path':\"\n          Write-Host \"  main.py -> $python_service_main\"\n          Write-Host \"  api.py -> $python_service_api\"\n          Write-Host \"  __init__.py -> $python_service_init\"\n\n          if ($web_service_main -and $web_service_api -and $web_service_init) {\n            $backend_dir = $web_service_path\n            $backend_module_path = \"web_service.backend\"\n            $spec_file = \"webservice.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'web_service/backend' as the target.\" -ForegroundColor Green\n          } elseif ($python_service_main -and $python_service_api -and $python_service_init) {\n            $backend_dir = $python_service_path\n            $backend_module_path = \"python_service\"\n            $spec_file = \"fortuna-backend-webservice.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'python_service' as the target.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c FATAL: Could not determine a valid backend directory. Neither 'web_service/backend' nor 'python_service' contains the required files (main.py, api.py, __init__.py).\" -ForegroundColor Red\n            exit 1\n          }\n\n          Write-Host \"--- Outputs ---\"\n          Write-Host \"backend_dir: $backend_dir\"\n          Write-Host \"backend_module_path: $backend_module_path\"\n          Write-Host \"spec_file: $spec_file\"\n\n          \"backend_dir=$backend_dir\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_module_path=$backend_module_path\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"spec_file=$spec_file\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n  system-check:\n    name: '\u2699\ufe0f System Prerequisites'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    outputs:\n      disk_free_gb: ${{ steps.system.outputs.disk_gb }}\n    steps:\n      - name: Verify Build Tools\n        run: |\n          Set-StrictMode -Version Latest\n          $tools = @('dotnet', 'python', 'node', 'npm', 'git')\n          foreach ($tool in $tools) {\n            Write-Host \"Checking for $($tool)...\"\n            Get-Command $tool -ErrorAction SilentlyContinue\n            if (-not $?) {\n              Write-Host \"\u274c FATAL: Build tool '$tool' not found in PATH.\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical build tools are present.\" -ForegroundColor Green\n      - name: Check Disk Space\n        id: system\n        run: |\n          Set-StrictMode -Version Latest\n          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }\n          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)\n          if ($freeGB -lt 10) {\n            Write-Host \"\u26a0\ufe0f WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended).\" -ForegroundColor Yellow\n          } else {\n            Write-Host \"\u2705 Disk space check passed ($freeGB GB free).\" -ForegroundColor Green\n          }\n          \"disk_gb=$freeGB\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n  repo-preflight:\n    name: '\ud83e\uddea Repo Preflight & Integrity'\n    runs-on: windows-latest\n    needs: [path-finder, system-check]\n    timeout-minutes: 5\n    outputs:\n      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}\n      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}\n      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: Derive Build Metadata\n        id: meta\n        run: |\n          Set-StrictMode -Version Latest\n          $ref = \"${{ github.ref }}\"\n          if ($ref -like 'refs/tags/v*') {\n            $semver = $ref -replace 'refs/tags/v', ''\n          } else {\n            $semver = \"0.0.${{ github.run_number }}\"\n          }\n          $shortSha = \"${{ github.sha }}\".Substring(0,7)\n          \"semver=$semver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"short_sha=$shortSha\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\ud83d\udd16 Version: $semver ($shortSha)\"\n\n      - name: Validate Critical Files Exist\n        env:\n          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n        run: |\n          Set-StrictMode -Version Latest\n          $paths = @(\n            \"${{ env.FRONTEND_DIR }}/package.json\",\n            \"${{ env.FRONTEND_DIR }}/package-lock.json\",\n            (Join-Path $env:BACKEND_DIR \"requirements.txt\"),\n            (Join-Path $env:BACKEND_DIR \"main.py\"),\n            \"${{ env.WIX_DIR }}/Product_WithService.wxs\"\n          )\n          foreach ($path in $paths) {\n            if (-not (Test-Path $path)) {\n              Write-Host \"\u274c FATAL: Required path missing: $path\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical files confirmed.\"\n\n      - name: Capture Integrity Hashes\n        id: hashes\n        env:\n          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n        run: |\n          Set-StrictMode -Version Latest\n          $frontend = (Get-FileHash \"${{ env.FRONTEND_DIR }}/package-lock.json\" -Algorithm SHA256).Hash\n          $backend = (Get-FileHash (Join-Path $env:BACKEND_DIR \"requirements.txt\") -Algorithm SHA256).Hash\n          $wix = (Get-FileHash \"${{ env.WIX_DIR }}/Product_WithService.wxs\" -Algorithm SHA256).Hash\n          \"frontend_lock_hash=$frontend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_requirements_hash=$backend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"wix_definition_hash=$wix\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Upload Integrity Snapshot\n        uses: actions/upload-artifact@v4\n        with:\n          name: repo-preflight-${{ github.run_id }}\n          path: |\n            ${{ env.FRONTEND_DIR }}/package-lock.json\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.WIX_DIR }}/Product_WithService.wxs\n          retention-days: 3\n\n  frontend-quality:\n    name: '\ud83e\uddfc Frontend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Cache Frontend Build\n        id: cache-frontend\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Run Lint (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {\n            Write-Host \"\ud83e\uddf9 Running npm run lint\"\n            npm run lint\n          } else {\n            Write-Host \"\u2139\ufe0f No lint script defined, skipping.\"\n          }\n\n      - name: Run Tests (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {\n            Write-Host \"\ud83e\uddea Running npm test -- --watch=false\"\n            npm test -- --watch=false\n          } else {\n            Write-Host \"\u2139\ufe0f No test script defined, skipping.\"\n          }\n\n      - name: Security Audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm audit --audit-level=critical\n\n  backend-quality:\n    name: '\ud83e\uddef Backend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: [path-finder, repo-preflight]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Cache Backend Build\n        id: cache-backend\n        uses: actions/cache@v4\n        with:\n          path: dist\n          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")\n          } else {\n            Write-Host \"\u2139\ufe0f requirements-dev.txt not found, skipping.\"\n          }\n\n      - name: Bytecode Compile (Fail Fast)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m compileall -q \"${{ env.BACKEND_DIR }}\"\n\n      - name: Run Pytest (if available)\n        run: |\n          Set-StrictMode -Version Latest\n          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec(\"pytest\") else 1)'\n          if ($LASTEXITCODE -eq 0) {\n            Write-Host \"\ud83e\uddea pytest detected, running suite...\"\n            python -m pytest \"${{ env.BACKEND_DIR }}\" --maxfail=1 --disable-warnings\n          } else {\n            Write-Host \"\u2139\ufe0f pytest not installed; skipping tests.\"\n          }\n\n      - name: pip-audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          pip install pip-audit\n          pip-audit -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n\n  sbom:\n    name: '\ud83d\udcc4 SBOM Snapshot'\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Generate SBOM (SPDX)\n        uses: anchore/sbom-action@v0\n        with:\n          output-file: sbom.spdx.json\n          format: spdx-json\n\n      - name: Upload SBOM\n        uses: actions/upload-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: sbom.spdx.json\n          retention-days: 7\n\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: [path-finder, repo-preflight, frontend-quality]\n    env:\n      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Cache Frontend Build\n        id: cache-frontend\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}\n          restore-keys: |\n            ${{ runner.os }}-frontend-build-\n\n      - name: Prime npm Cache\n        uses: actions/cache@v4\n        with:\n          path: ~\\AppData\\Local\\npm-cache\n          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}\n          restore-keys: |\n            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Build Frontend\n        if: steps.cache-frontend.outputs.cache-hit != 'true'\n        env:\n          NEXT_PUBLIC_API_URL: http://127.0.0.1:${{ env.SERVICE_PORT }}\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm run build\n\n      - name: Report Cache Status\n        run: |\n          if ('${{ steps.cache-frontend.outputs.cache-hit }}' -eq 'true') {\n            Write-Host \"\u2705 Frontend build restored from cache.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u2139\ufe0f No cache hit. A new build was performed.\" -ForegroundColor Yellow\n          }\n\n      - name: Verify Build Output\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          if (-not (Test-Path $outDir)) {\n             Write-Host \"\u274c FATAL: Build directory not found\" -ForegroundColor Red\n             exit 1\n          }\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) {\n             Write-Host \"\u274c FATAL: Build directory empty\" -ForegroundColor Red\n             exit 1\n          }\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n      - name: Generate Artifact Manifest\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          $manifestPath = \"frontend-manifest.tsv\"\n          \"RelativePath`tSizeBytes`tSHA256\" | Out-File $manifestPath -Encoding utf8\n          Get-ChildItem -Path $outDir -Recurse -File | ForEach-Object {\n            $relative = $_.FullName.Substring($outDir.Path.Length).TrimStart('\\','/')\n            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash\n            \"$relative`t$($_.Length)`t$hash\" | Out-File $manifestPath -Encoding utf8 -Append\n          }\n\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          retention-days: 3\n\n      - name: Upload Manifest\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-manifest-${{ github.run_id }}\n          path: frontend-manifest.tsv\n          retention-days: 3\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [path-finder, repo-preflight, build-frontend, backend-quality]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: temp-frontend\n\n      - name: Cache Backend Build\n        id: cache-backend\n        uses: actions/cache@v4\n        with:\n          path: dist\n          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}\n          restore-keys: |\n            ${{ runner.os }}-backend-build-\n\n      - name: Stage Frontend for PyInstaller\n        run: |\n          Set-StrictMode -Version Latest\n          $dest = \"staging/ui\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n          Copy-Item -Path \"temp-frontend/*\" -Destination $dest -Recurse -Force\n          Write-Host \"\u2705 Frontend staged for inclusion.\"\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")\n          }\n\n      - name: Freeze Dependency Snapshot\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          pip freeze | Out-File backend-freeze.txt -Encoding utf8\n\n      - name: Ensure Python Package Structure\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-Content -Path \"web_service/__init__.py\" -Value \"\"\n          Set-Content -Path \"web_service/backend/__init__.py\" -Value \"\"\n          Write-Host \"\u2705 Ensured __init__.py files exist for package discovery.\"\n\n      - name: Create Dynamic webservice.spec for PyInstaller\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          $entry_point = (Join-Path $env:BACKEND_DIR \"main.py\").Replace('\\', '/')\n          $submodules = \"collect_submodules('{0}')\" -f $env:BACKEND_MODULE_PATH\n          $main_import = \"'{0}.main'\" -f $env:BACKEND_MODULE_PATH\n          $staging_ui_path = (Resolve-Path \"staging/ui\").Path.Replace('\\', '/')\n          $other_service = if (\"${{ env.BACKEND_DIR }}\" -eq \"web_service/backend\") { \"python_service\" } else { \"web_service\" }\n\n          $specContent = @\"\n          # -*- mode: python ; coding: utf-8 -*-\n          # DYNAMICALLY GENERATED SPEC - DO NOT EDIT MANUALLY\n          import os\n          from pathlib import Path\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n          project_root = Path(SPECPATH).parent\n          version_string = os.environ.get(\"FORTUNA_VERSION\", \"0.0.0\")\n\n          # Explicitly include the frontend UI files\n          datas = [\n              ('$staging_ui_path', 'ui')\n          ]\n          # Include necessary data files from installed packages\n          datas += collect_data_files(\"uvicorn\")\n          datas += collect_data_files(\"slowapi\")\n          datas += collect_data_files(\"structlog\")\n          datas += collect_data_files(\"certifi\")\n\n          hiddenimports = set()\n          hiddenimports.update($submodules)\n          hiddenimports.update([\n              \"uvicorn.logging\", \"uvicorn.loops.auto\", \"uvicorn.lifespan.on\",\n              \"uvicorn.protocols.http.h11_impl\", \"uvicorn.protocols.websockets.wsproto_impl\",\n              \"fastapi.routing\", \"starlette.staticfiles\", \"anyio._backends._asyncio\",\n              \"httpcore\", \"httpx\", \"slowapi\", \"structlog\", \"tenacity\", \"aiosqlite\",\n              \"pydantic_core\", \"pydantic_settings.sources\", $main_import\n          ])\n\n          a = Analysis(\n              ['$entry_point'],\n              pathex=[str(project_root)],\n              binaries=[],\n              datas=datas,\n              hiddenimports=sorted(hiddenimports),\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest', '$other_service'], # CRITICAL: Exclude the other service\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz,\n              a.scripts,\n              a.binaries,\n              a.zipfiles,\n              a.datas,\n              [],\n              name='fortuna-backend',\n              debug=False,\n              bootloader_ignore_signals=False,\n              strip=False,\n              upx=True,\n              runtime_tmpdir=None,\n              console=False,\n              disable_windowed_traceback=False,\n              argv_emulation=False,\n              target_arch=None,\n              codesign_identity=None,\n              entitlements_file=None\n          )\n          \"@\n          Set-Content -Path \"${{ env.BACKEND_SPEC }}\" -Value $specContent\n          Write-Host \"\u2705 Dynamically generated '${{ env.BACKEND_SPEC }}' created.\"\n\n      - name: Create Required Backend Directories\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR \"data\") -Force | Out-Null\n          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR \"json\") -Force | Out-Null\n          Write-Host \"\u2705 Created required backend directories for PyInstaller.\" -ForegroundColor Green\n\n      - name: Build with PyInstaller\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        env:\n          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n        run: |\n          Set-StrictMode -Version Latest\n          pyinstaller \"${{ env.BACKEND_SPEC }}\" --clean --log-level=WARN --noconfirm\n\n      - name: Report Cache Status\n        run: |\n          if ('${{ steps.cache-backend.outputs.cache-hit }}' -eq 'true') {\n            Write-Host \"\u2705 Backend build restored from cache.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u2139\ufe0f No cache hit. A new build was performed.\" -ForegroundColor Yellow\n          }\n\n      - name: Verify Executable\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exePath)) {\n            Write-Host \"\u274c FATAL: Executable not found\" -ForegroundColor Red\n            exit 1\n          }\n          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash\n          $size = (Get-Item $exePath).Length / 1MB\n          if ($size -lt 10) {\n            Write-Host \"\u274c FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete.\" -ForegroundColor Red\n            exit 1\n          }\n          \"fortuna-backend.exe`t$hash\" | Out-File backend-sha256.tsv -Encoding utf8\n          Write-Host \"\u2705 Backend ready: $([math]::Round($size, 2)) MB ($hash)\"\n\n      - name: Upload Backend Executable\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 3\n\n      - name: Upload Backend Metadata\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-metadata-${{ github.run_id }}\n          path: |\n            backend-sha256.tsv\n            backend-freeze.txt\n          retention-days: 7\n\n  diagnose-asgi-imports:\n    name: '\ud83d\udd0d ASGI Import Killer (Pre-Smoke Diagnostic)'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: [path-finder, build-backend]\n    env:\n      PYTHONUTF8: '1'\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \u2699\ufe0f Setup Python (EXACT VERSION)\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: \ud83d\udccb Capture Python Info\n        run: |\n          Set-StrictMode -Version Latest\n          Write-Host \"Python executable: $(which python)\" -ForegroundColor Cyan\n          python --version\n          python -m site\n          python -c \"import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)\"\n\n      - name: \ud83d\udce5 Install Requirements (Exactly as Backend Build)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel --quiet\n\n          Write-Host \"Installing requirements.txt...\" -ForegroundColor Cyan\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\") -v 2>&1 | Tee-Object \"install-requirements.log\"\n\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            Write-Host \"Installing requirements-dev.txt...\" -ForegroundColor Cyan\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\") -v 2>&1 | Tee-Object -Append \"install-requirements.log\"\n          }\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u274c pip install failed\" -ForegroundColor Red\n            exit 1\n          }\n\n          Write-Host \"\u2705 All dependencies installed\" -ForegroundColor Green\n\n      - name: \ud83d\udce6 Capture Installed Packages\n        run: |\n          pip list | Tee-Object \"installed-packages.txt\"\n          pip freeze | Tee-Object \"pip-freeze.txt\"\n\n      - name: \ud83d\udc0d Set PYTHONPATH\n        run: |\n          echo \"PYTHONPATH=${{ github.workspace }}\" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append\n          Write-Host \"PYTHONPATH set to ${{ github.workspace }}\"\n\n      - name: \ud83e\uddea PHASE 1 System Imports\n        run: |\n          $script = @(\n            'import sys',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 1 SYSTEM-LEVEL IMPORTS\")',\n            'print(\"=\"*80)',\n            'modules = [',\n            \"    ('os', 'filesystem'), ('sys', 'system'), ('json', 'serialization'),\",\n            \"    ('asyncio', 'async I/O'), ('pathlib', 'paths'), ('typing', 'type hints'),\",\n            \"    ('importlib', 'import utilities')\",\n            ']',\n            'failed = []',\n            'for mod_name, desc in modules:',\n            '    try:',\n            '        __import__(mod_name)',\n            '        print(f\"\u2705 {mod_name:20} [{desc}]\")',\n            '    except ImportError as e:',\n            '        print(f\"\u274c {mod_name:20} ImportError: {e}\")',\n            '        failed.append(mod_name)',\n            'if failed:',\n            '    print(f\"\\n\u274c {len(failed)} system imports failed\")',\n            '    sys.exit(1)',\n            'print(f\"\\n\u2705 Phase 1 complete\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 2 Web Framework Core\n        run: |\n          $script = @(\n            'import sys',\n            'import traceback',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 2 WEB FRAMEWORK CORE\")',\n            'print(\"=\"*80)',\n            'modules = [',\n            \"    ('fastapi', 'web framework'),\",\n            \"    ('uvicorn', 'ASGI server'),\",\n            \"    ('starlette', 'ASGI toolkit'),\",\n            \"    ('starlette.applications', 'ASGI app'),\",\n            \"    ('starlette.routing', 'routing'),\",\n            ']',\n            'failed = []',\n            'for mod_name, desc in modules:',\n            '    try:',\n            '        __import__(mod_name)',\n            '        print(f\"\u2705 {mod_name:30} [{desc}]\")',\n            '    except ImportError as e:',\n            '        print(f\"\u274c {mod_name:30} ImportError: {e}\")',\n            '        failed.append((mod_name, str(e)))',\n            '    except Exception as e:',\n            '        print(f\"\u26a0\ufe0f  {mod_name:30} {type(e).__name__}: {e}\")',\n            'if failed:',\n            '    print(f\"\\n\u274c {len(failed)} core framework imports failed\")',\n            '    for mod, err in failed:',\n            '        print(f\"  - {mod}\")',\n            '    sys.exit(1)',\n            'print(f\"\\n\u2705 Phase 2 complete\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 3 Pydantic & Data Validation\n        run: |\n          $script = @(\n            'import sys',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 3 PYDANTIC & DATA VALIDATION\")',\n            'print(\"=\"*80)',\n            'modules = [',\n            \"    ('pydantic', 'validation'),\",\n            \"    ('pydantic_core', 'core'),\",\n            \"    ('pydantic_settings', 'settings'),\",\n            ']',\n            'for mod_name, desc in modules:',\n            '    try:',\n            '        __import__(mod_name)',\n            '        print(f\"\u2705 {mod_name:30} [{desc}]\")',\n            '    except Exception as e:',\n            '        print(f\"\u274c {mod_name:30} {type(e).__name__}: {e}\")',\n            '        sys.exit(1)',\n            'print(f\"\\n\u2705 Phase 3 complete\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 4 Async/IO Utilities\n        run: |\n          $script = @(\n            'import sys',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 4 ASYNC/IO UTILITIES\")',\n            'print(\"=\"*80)',\n            'modules = [',\n            \"    ('anyio', 'async compat'),\",\n            \"    ('httpcore', 'HTTP core'),\",\n            \"    ('httpx', 'HTTP client'),\",\n            \"    ('aiosqlite', 'async DB'),\",\n            ']',\n            'for mod_name, desc in modules:',\n            '    try:',\n            '        __import__(mod_name)',\n            '        print(f\"\u2705 {mod_name:30} [{desc}]\")',\n            '    except Exception as e:',\n            '        print(f\"\u274c {mod_name:30} {type(e).__name__}: {e}\")',\n            '        sys.exit(1)',\n            'print(f\"\\n\u2705 Phase 4 complete\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 5 Optional Dependencies (non-critical)\n        continue-on-error: true\n        run: |\n          $script = @(\n            'import sys',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 5 OPTIONAL DEPENDENCIES (non-critical)\")',\n            'print(\"=\"*80)',\n            'modules = [',\n            \"    ('slowapi', 'rate limiting'),\",\n            \"    ('structlog', 'logging'),\",\n            \"    ('tenacity', 'retries'),\",\n            ']',\n            'for mod_name, desc in modules:',\n            '    try:',\n            '        __import__(mod_name)',\n            '        print(f\"\u2705 {mod_name:30} [{desc}]\")',\n            '    except Exception as e:',\n            '        print(f\"\u26a0\ufe0f  {mod_name:30} not critical: {type(e).__name__}\")',\n            'print(f\"\\n\u2705 Phase 5 complete (warnings OK)\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n\n      - name: \ud83e\uddea PHASE 6 Application Directory Structure\n        run: |\n          Set-StrictMode -Version Latest\n\n          $script = @(\n            'import os',\n            'from pathlib import Path',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 6 APPLICATION DIRECTORY STRUCTURE\")',\n            'print(\"=\"*80)',\n            'cwd = Path.cwd()',\n            'backend_dir = cwd / \"${{ env.BACKEND_DIR }}\"',\n            'print(f\"\\nCurrent directory: {cwd}\")',\n            'print(f\"\\nBackend directory exists: {backend_dir.exists()}\")',\n            'if backend_dir.exists():',\n            '    print(f\"  Contents:\")',\n            '    for item in backend_dir.iterdir():',\n            '        print(f\"    - {item.name}\")',\n            '    main_py = backend_dir / \"main.py\"',\n            '    api_py = backend_dir / \"api.py\"',\n            '    print(f''\\n  main.py: {main_py.stat().st_size if main_py.exists() else \"N/A\"} bytes'')',\n            '    print(f''  api.py: {api_py.stat().st_size if api_py.exists() else \"N/A\"} bytes'')'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n\n      - name: \ud83e\uddea PHASE 7 CRITICAL - Application Module Imports\n        env:\n          BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n        run: |\n          $script = @(\n            'import sys',\n            'import traceback',\n            'import importlib',\n            'from pathlib import Path',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)\")',\n            'print(\"=\"*80)',\n            'backend_module_path = \"${{ env.BACKEND_MODULE_PATH }}\"',\n            'print(f\"\\n[Step 1] Dynamically importing module: {backend_module_path}\")',\n            'try:',\n            '    backend_module = importlib.import_module(backend_module_path)',\n            '    print(f\"\u2705 {backend_module_path} imported successfully\")',\n            'except Exception as e:',\n            '    print(f\"\u274c FATAL: {backend_module_path} import failed\")',\n            '    print(f\"   Error: {type(e).__name__}: {e}\")',\n            '    traceback.print_exc()',\n            '    sys.exit(1)',\n            'print(''\\\\n[Step 2] Retrieving \"app\" object from the API submodule...'')',\n            'api_module_path = f\"{backend_module_path}.api\"',\n            'try:',\n            '    api_module = importlib.import_module(api_module_path)',\n            '    app = getattr(api_module, \"app\")',\n            '    print(f\"\u2705 app object retrieved from {api_module_path}\")',\n            '    print(f\"   Type: {type(app)}\")',\n            '    print(f\"   Class: {app.__class__.__name__}\")',\n            '    print(f\"   Module: {app.__class__.__module__}\")',\n            'except (ImportError, AttributeError) as e:',\n            '    print(f\"\u274c FATAL: Could not get app object from {api_module_path}\")',\n            '    print(f\"   Error: {type(e).__name__}: {e}\")',\n            '    traceback.print_exc()',\n            '    sys.exit(1)',\n            'print(\"\\n\" + \"=\"*80)',\n            'print(\"\u2705 ALL APPLICATION IMPORTS SUCCESSFUL\")',\n            'print(\"=\"*80)',\n            'print(\"\\nThe ASGI app is fully importable.\")',\n            'print(\"Uvicorn should be able to load it successfully.\")'\n          )\n          $script | Out-File -FilePath \"diag_script.py\" -Encoding utf8\n          python diag_script.py\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u274c APPLICATION IMPORT TEST FAILED\" -ForegroundColor Red\n            exit 1\n          }\n\n      - name: \ud83d\udccb Generate ASGI Diagnostic Report\n        if: always()\n        run: |\n          Set-StrictMode -Version Latest\n          $report = @()\n          $report += \"\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\"\n          $report += \"\u2551              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        \u2551\"\n          $report += \"\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\"\n          $report += \"\"\n          $report += \"Timestamp: $(Get-Date -Format 'o')\"\n          $report += \"Python: $(python --version)\"\n          $report += \"\"\n          $report += \"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\"\n          $result = if ($LASTEXITCODE -eq 0) { 'PASS \u2705' } else { 'FAIL \u274c' }\n          $report += \"\u2502 RESULT: $result \u2502\"\n          $report += \"\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\"\n          $report += \"\"\n          $report += \"If this passed:\"\n          $report += \"  \u2705 All required dependencies are installed\"\n          $report += \"  \u2705 python_service.main is importable\"\n          $report += \"  \u2705 FastAPI app is accessible\"\n          $report += \"  \u2705 The executable should work\"\n          $report += \"  \u2705 Uvicorn WILL be able to load the app\"\n          $report += \"\"\n          $report += \"If this failed:\"\n          $report += \"  \u274c See error output above for the exact problem\"\n          $report += \"  \u274c Fix the import error in your code\"\n          $report += \"  \u274c Common issues:\"\n          $report += \"     - Missing dependency in requirements.txt\"\n          $report += \"     - Syntax error in api.py or main.py\"\n          $report += \"     - Circular import in api.py\"\n          $report += \"     - api.py imports a module that fails\"\n          $report += \"\"\n          $report += \"\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\"\n          $report | Tee-Object \"asgi-diagnostic-report.txt\"\n\n      - name: \ud83d\udce4 Upload Diagnostic Artifacts\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: asgi-import-diagnostics-${{ github.run_id }}\n          path: |\n            install-requirements.log\n            installed-packages.txt\n            pip-freeze.txt\n            asgi-diagnostic-report.txt\n          retention-days: 30\n          if-no-files-found: warn\n\n  diagnose-runtime:\n    name: '\ud83d\udd0e Diagnose PyInstaller Runtime'\n    runs-on: windows-latest\n    timeout-minutes: 10\n    needs: [path-finder, build-backend]\n    env:\n      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n    steps:\n      - name: \ud83d\udce5 Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: \ud83d\udc0d Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: \ud83d\udce6 Install PyInstaller\n        run: pip install pyinstaller==6.6.0\n\n      - name: \ud83d\udd75\ufe0f Extract and Analyze Executable Contents\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n\n          Write-Host \"--- Executable Analysis ---\"\n          Write-Host \"Analyzing contents of $exePath with pyi-archive_viewer...\"\n\n          $archiveContents = pyi-archive_viewer $exePath\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"Failed to analyze executable with pyi-archive_viewer.\"\n            exit 1\n          }\n\n          Write-Host \"\\n--- Archive Contents ---\"\n          $archiveContents | Out-Host\n\n          $expectedInitFile = ($env:BACKEND_MODULE_PATH.Replace('.', '\\') + '\\__init__.py')\n          Write-Host \"\\n--- Verification ---\"\n          Write-Host \"Searching for key module file: '$expectedInitFile' in archive contents...\"\n\n          if ($archiveContents | Select-String -Pattern $expectedInitFile -Quiet -SimpleMatch) {\n            Write-Host \"\u2705 SUCCESS: Key module file found inside the executable archive.\" -ForegroundColor Green\n          } else {\n            Write-Error \"\u274c FAILURE: Key module file '$expectedInitFile' NOT found inside the executable. This confirms a bundling error.\"\n            exit 1\n          }\n\n      - name: \ud83d\udce4 Upload Extracted Artifacts\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: extracted-executable-${{ github.run_id }}\n          path: extracted_exe/\n          retention-days: 7\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test (Diagnostic Overkill)'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    needs: [path-finder, build-frontend, build-backend, diagnose-asgi-imports, diagnose-runtime]\n    env:\n      PYTHONUTF8: '1'\n      FORTUNA_ENV: 'smoke-test'\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 0: PRE-EXECUTION FORENSICS\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udce5 Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: \ud83d\udce5 Download Frontend Build\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: frontend-dist\n\n      - name: \ud83c\udfd7\ufe0f Setup Directories & Capture Baseline\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create diagnostic structure\n          New-Item -ItemType Directory -Path \"service-logs\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/exe-analysis\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/runtime-trace\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/import-analysis\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/environment\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"json\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"logs\" -Force | Out-Null\n\n          # Baseline system state\n          Get-Process | Out-File \"diagnostics/baseline-processes.txt\"\n          Get-NetTCPConnection -ErrorAction SilentlyContinue | Out-File \"diagnostics/baseline-network.txt\"\n          [Environment]::GetEnvironmentVariables() | Out-File \"diagnostics/baseline-env.txt\"\n\n          Write-Host \"\u2705 Diagnostic directories created\" -ForegroundColor Green\n\n      - name: \ud83d\udd2c Analyze Executable (Pre-Execution)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = \"dist/fortuna-backend.exe\"\n\n          # File properties\n          $info = Get-Item $exe\n          $size = $info.Length / 1MB\n\n          $exeAnalysis = @(\n            \"=== EXECUTABLE ANALYSIS ===\",\n            \"Path: $($info.FullName)\",\n            \"Size: $([math]::Round($size, 2)) MB\",\n            \"Created: $($info.CreationTime)\",\n            \"Modified: $($info.LastWriteTime)\",\n            \"Attributes: $($info.Attributes)\"\n          )\n          $exeAnalysis | Tee-Object \"diagnostics/exe-analysis/exe-properties.txt\"\n\n          # PE signature check\n          $bytes = [System.IO.File]::ReadAllBytes($exe)\n          $peSignature = \"{0:X2}{1:X2}\" -f $bytes[0], $bytes[1]\n          if ($peSignature -eq \"4D5A\") {\n            Write-Host \"\u2705 Valid PE signature: $peSignature\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c INVALID PE signature: $peSignature (expected 4D5A)\" -ForegroundColor Red\n            exit 1\n          }\n\n          # Check for embedded dependencies (more robustly)\n          $searchString = \"uvicorn\"\n          # Use Select-String instead of findstr to avoid exit code 1 issues\n          if (Select-String -Path $exe -Pattern $searchString -Quiet -SimpleMatch) {\n              Write-Host \"\u2705 Found '$searchString' reference.\"\n          } else {\n              Write-Host \"\u2139\ufe0f '$searchString' not found in binary (likely packed). Continuing...\" -ForegroundColor Gray\n          }\n\n      - name: \ud83d\udd12 Configure Firewall & Network\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create firewall rule\n          try {\n            New-NetFirewallRule `\n              -DisplayName \"FortunaSmoke\" `\n              -Direction Inbound `\n              -Action Allow `\n              -Protocol TCP `\n              -LocalPort ${{ env.SERVICE_PORT }} `\n              -ErrorAction Stop\n            Write-Host \"\u2705 Firewall rule created\" -ForegroundColor Green\n          } catch {\n            Write-Host \"\u26a0\ufe0f  Firewall rule may exist: $_\" -ForegroundColor Yellow\n          }\n\n          # Allow port in Windows Defender\n          try {\n            netsh advfirewall firewall add rule name=\"FortunaSmokeHTTP\" dir=in action=allow protocol=tcp localport=${{ env.SERVICE_PORT }} | Out-File \"diagnostics/firewall-netsh.log\"\n          } catch {\n            Write-Host \"\u26a0\ufe0f  netsh command issue (non-critical)\" -ForegroundColor Yellow\n          }\n\n          # Baseline netstat\n          netstat -ano | Out-File \"diagnostics/network-baseline.txt\"\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 1: PRE-LAUNCH PYTHON/ASGI VALIDATION\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: Setup Python for Pre-Launch Check\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: Install Dependencies for Pre-Launch Check\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")\n          }\n\n      - name: \ud83d\udc0d Set PYTHONPATH for Pre-Launch Check\n        run: |\n          echo \"PYTHONPATH=${{ github.workspace }}\" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append\n          Write-Host \"PYTHONPATH set to ${{ github.workspace }}\"\n\n      - name: \ud83d\udc0d Test PyInstaller Python Environment (Mimic Executable)\n        env:\n          BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create a test script that mimics what the executable should do\n          $testScript = @(\n            'import sys, os, traceback, importlib',\n            'print(\"=\" * 80)',\n            'print(\"PRE-LAUNCH PYTHON ENVIRONMENT CHECK\")',\n            'print(\"=\" * 80)',\n            'print(\"\\n1. PYTHON ENVIRONMENT:\")',\n            'print(f\"   Python: {sys.executable}\")',\n            'print(f\"   Version: {sys.version}\")',\n            'print(f\"   Platform: {sys.platform}\")',\n            'print(f\"   Prefix: {sys.prefix}\")',\n            'print(\"\\n2. MODULE SEARCH PATHS:\")',\n            'for i, p in enumerate(sys.path):',\n            '    print(f\"   [{i}] {p}\")',\n            'critical_modules = [',\n            \"    'fastapi', 'uvicorn', 'pydantic', 'pydantic_core', 'pydantic_settings',\",\n            \"    'aiosqlite', 'slowapi', 'structlog', 'starlette', 'starlette.staticfiles',\",\n            \"    'anyio', 'httpcore', 'httpx'\",\n            ']',\n            'print(\"\\n3. CRITICAL MODULE IMPORTS:\")',\n            'failed = []',\n            'for mod in critical_modules:',\n            '    try:',\n            '        __import__(mod)',\n            '        print(f\"   \u2705 {mod}\")',\n            '    except ImportError as e:',\n            '        print(f\"   \u274c {mod}: {e}\")',\n            '        failed.append((mod, str(e)))',\n            '    except Exception as e:',\n            '        print(f\"   \u26a0\ufe0f  {mod}: {type(e).__name__}: {e}\")',\n            'backend_module_path = \"${{ env.BACKEND_MODULE_PATH }}\"',\n            'print(f\"\\n4. APPLICATION MODULES ({backend_module_path}):\")',\n            \"app_modules = [\",\n            \"    backend_module_path,\",\n            \"    f'{backend_module_path}.main',\",\n            \"    f'{backend_module_path}.api',\",\n            \"]\",\n            'for mod in app_modules:',\n            '    try:',\n            '        importlib.import_module(mod)',\n            '        print(f\"   \u2705 {mod}\")',\n            '    except ImportError as e:',\n            '        print(f\"   \u274c {mod}: {e}\")',\n            '        failed.append((mod, str(e)))',\n            '        traceback.print_exc()',\n            '    except Exception as e:',\n            '        print(f\"   \u26a0\ufe0f  {mod}: {type(e).__name__}: {e}\")',\n            '        traceback.print_exc()',\n            'print(\"\\n5. ASGI APP INSTANTIATION:\")',\n            'try:',\n            '    api_module = importlib.import_module(f\"{backend_module_path}.api\")',\n            '    app = getattr(api_module, \"app\")',\n            '    print(f\"   \u2705 Successfully imported app from {backend_module_path}.api\")',\n            '    print(f\"   App type: {type(app)}\")',\n            '    print(f\"   App class: {app.__class__.__name__}\")',\n            'except (ImportError, AttributeError) as e:',\n            '    print(f\"   \u274c Failed to import app: {e}\")',\n            '    traceback.print_exc()',\n            '    failed.append((\"app_import\", str(e)))',\n            'except Exception as e:',\n            '    print(f\"   \u26a0\ufe0f  {type(e).__name__}: {e}\")',\n            '    traceback.print_exc()',\n            'print(\"\\n\" + \"=\" * 80)',\n            'if failed:',\n            '    print(f\"FAILURES: {len(failed)} module(s) failed\")',\n            '    for mod, err in failed:',\n            '        print(f\"  - {mod}\")',\n            '        print(f\"    {err[:100]}\")',\n            '    sys.exit(1)',\n            'else:',\n            '    print(\"\u2705 ALL CHECKS PASSED\")',\n            '    sys.exit(0)',\n            ''\n          )\n          $testScript | Out-File \"diagnostics/import-analysis/pre-launch-test.py\" -Encoding utf8\n\n          python \"diagnostics/import-analysis/pre-launch-test.py\" 2>&1 | Tee-Object \"diagnostics/import-analysis/pre-launch-output.txt\"\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u26a0\ufe0f  Pre-launch Python check failed (but executable may still work)\" -ForegroundColor Yellow\n          }\n\n      - name: \ud83d\udd0d Inspect Executable Contents (Strings Dump)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = \"dist/fortuna-backend.exe\"\n\n          # Extract strings from executable (look for module names, ports, etc.)\n          # Note: This requires PowerShell Get-Content binary reading\n          $content = [System.IO.File]::ReadAllBytes($exe)\n          $text = [System.Text.Encoding]::ASCII.GetString($content)\n\n          # Extract readable strings\n          $strings = [regex]::Matches($text, '[A-Za-z0-9_.\\-/]+') | ForEach-Object { $_.Value } | Sort-Object -Unique\n\n          # Filter for interesting ones\n          $interestingStrings = $strings | Where-Object {\n            $_ -match '(uvicorn|fastapi|web_service|backend|main|api|asgi|starlette)' -or\n            $_.Length -gt 20 -and $_ -match '(\\.py|\\.so|\\.dll|Protocol|http)'\n          }\n\n          Write-Host \"Found $($interestingStrings.Count) interesting strings in executable\" -ForegroundColor Cyan\n          $interestingStrings | Out-File \"diagnostics/exe-analysis/interesting-strings.txt\"\n          $interestingStrings | Out-Host\n\n      - name: \ud83d\udcca Capture Environment for Service Launch\n        run: |\n          Set-StrictMode -Version Latest\n\n          Get-ChildItem Env: | Out-File \"diagnostics/environment/launch-environment.txt\"\n\n          $envVars = @{\n            'API_KEY' = $env:API_KEY\n            'FORTUNA_PORT' = $env:FORTUNA_PORT\n            'FORTUNA_ENV' = $env:FORTUNA_ENV\n            'PYTHONPATH' = $env:PYTHONPATH\n            'PATH' = $env:PATH\n            'TEMP' = $env:TEMP\n            'TMP' = $env:TMP\n          }\n\n          @\"\n          === SERVICE LAUNCH ENVIRONMENT ===\n          API_KEY: $($envVars['API_KEY'] ? '***SET***' : 'NOT SET')\n          FORTUNA_PORT: $($envVars['FORTUNA_PORT'])\n          FORTUNA_ENV: $($envVars['FORTUNA_ENV'])\n          PYTHONPATH: $($envVars['PYTHONPATH'])\n          TEMP: $($envVars['TEMP'])\n\n          Full environment:\n          \"@ | Out-File \"diagnostics/environment/service-environment.txt\"\n\n          $envVars.GetEnumerator() | ForEach-Object {\n            \"$($_.Key)=$($_.Value)\" | Out-File -Append \"diagnostics/environment/service-environment.txt\"\n          }\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 2: SERVICE LAUNCH WITH OBSESSIVE TRACING\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\ude80 Start Service with Full Output Capture\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = Resolve-Path \"dist/fortuna-backend.exe\"\n          $outLog = \"service-logs/stdout.txt\"\n          $errLog = \"service-logs/stderr.txt\"\n\n          Write-Host \"Starting service...\" -ForegroundColor Cyan\n          Write-Host \"Executable: $exe\" -ForegroundColor Cyan\n          Write-Host \"Port: ${{ env.SERVICE_PORT }}\" -ForegroundColor Cyan\n          Write-Host \"API_KEY: ***\" -ForegroundColor Cyan\n\n          # Set environment for subprocess\n          $env:API_KEY = \"${{ env.API_KEY }}\"\n          $env:FORTUNA_PORT = \"${{ env.SERVICE_PORT }}\"\n          $env:FORTUNA_ENV = \"smoke-test\"\n          $env:PYTHONUNBUFFERED = \"1\"  # Force unbuffered output\n\n          # Start process with full I/O redirection\n          $proc = Start-Process `\n            -FilePath $exe `\n            -PassThru `\n            -RedirectStandardOutput $outLog `\n            -RedirectStandardError $errLog `\n            -NoNewWindow\n\n          $backendPid = $proc.Id\n          Write-Host \"\u2705 Service process started with PID: $backendPid\" -ForegroundColor Green\n          $backendPid | Out-File \"service.pid\" -Encoding ascii\n\n          # Don't wait - proceed to health check\n          Start-Sleep -Seconds 5\n\n          # Check if process is still alive\n          if (Get-Process -Id $backendPid -ErrorAction SilentlyContinue) {\n            Write-Host \"\u2705 Process still alive after 5 seconds\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c FATAL: Process died immediately\" -ForegroundColor Red\n            Write-Host \"=== STDOUT ===\" -ForegroundColor Red\n            Get-Content $outLog\n            Write-Host \"=== STDERR ===\" -ForegroundColor Red\n            Get-Content $errLog\n            exit 1\n          }\n\n      - name: \ud83d\udcca Monitor Process While Running\n        run: |\n          Set-StrictMode -Version Latest\n\n          $backendPid = Get-Content \"service.pid\" -Raw -ErrorAction SilentlyContinue\n          if ($backendPid) {\n            $proc = Get-Process -Id $backendPid -ErrorAction SilentlyContinue\n            if ($proc) {\n              $processInfo = @(\n                \"=== PROCESS INFO ===\",\n                \"PID: $backendPid\",\n                \"Name: $($proc.ProcessName)\",\n                \"Memory: $([math]::Round($proc.WorkingSet / 1MB, 2)) MB\",\n                \"CPU Time: $($proc.TotalProcessorTime)\",\n                \"Threads: $($proc.Threads.Count)\",\n                \"Handle Count: $($proc.HandleCount)\"\n              )\n              $processInfo | Tee-Object \"diagnostics/runtime-trace/process-info.txt\"\n            }\n          }\n\n          # Network state while running\n          netstat -ano | Out-File \"diagnostics/network-running.txt\"\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 3: HEALTH CHECK WITH AGGRESSIVE RETRIES & DEBUGGING\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udc93 Health Check (Retry Loop with Diagnostics)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}\"\n          $maxRetries = 30  # 30 retries * 2s = 60s timeout\n          $retryInterval = 2\n          $attempt = 0\n          $success = $false\n\n          Write-Host \"Health check URL: $url\" -ForegroundColor Cyan\n          Write-Host \"Max retries: $maxRetries | Interval: $retryInterval seconds\" -ForegroundColor Cyan\n\n          $healthLog = \"diagnostics/runtime-trace/health-check.log\"\n\n          while ($attempt -lt $maxRetries -and -not $success) {\n            $attempt++\n            $elapsed = ($attempt - 1) * $retryInterval\n\n            Write-Host \"Attempt $attempt/$maxRetries (${elapsed}s elapsed)...\" -ForegroundColor Yellow\n\n            try {\n              # Attempt HTTP Request\n              Write-Host \"  [HTTP GET]...\" -ForegroundColor Gray\n              $response = Invoke-WebRequest `\n                -Uri $url `\n                -UseBasicParsing `\n                -TimeoutSec 10 `\n                -ErrorAction Stop\n\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 HEALTH CHECK PASSED (HTTP $($response.StatusCode))\" -ForegroundColor Green\n                $response.Content | Out-File \"diagnostics/runtime-trace/health-response.json\"\n                $response.Content | Out-File -Append $healthLog\n                $success = $true\n                break\n              } else {\n                Write-Host \"\u26a0\ufe0f  Unexpected status: $($response.StatusCode)\" -ForegroundColor Yellow\n                \"[$attempt] Status $($response.StatusCode)\" | Out-File -Append $healthLog\n              }\n\n            } catch [System.Net.WebException] {\n              $ex = $_\n              Write-Host \"  \u274c Request failed: $($ex.Exception.Message)\" -ForegroundColor Red\n              \"[$attempt] WebException: $($ex.Exception.Message)\" | Out-File -Append $healthLog\n\n            } catch [System.Net.Sockets.SocketException] {\n              $ex = $_\n              Write-Host \"  \u274c Socket error: $($ex.Exception.Message)\" -ForegroundColor Red\n              \"[$attempt] SocketException: $($ex.Exception.Message)\" | Out-File -Append $healthLog\n\n            } catch {\n              Write-Host \"  \u274c Error: $_\" -ForegroundColor Red\n              \"$attempt] Exception: $_\" | Out-File -Append $healthLog\n            }\n\n            # Capture logs between attempts\n            $stdoutTail = Get-Content \"service-logs/stdout.txt\" -Tail 5 -ErrorAction SilentlyContinue\n            $stderrTail = Get-Content \"service-logs/stderr.txt\" -Tail 5 -ErrorAction SilentlyContinue\n\n            if ($stderrTail) {\n              Write-Host \"  [STDERR tail]:\" -ForegroundColor Gray\n              $stderrTail | ForEach-Object { Write-Host \"    $_\" -ForegroundColor Red }\n            }\n\n            if ($attempt -lt $maxRetries) {\n              Start-Sleep -Seconds $retryInterval\n            }\n          }\n\n          if (-not $success) {\n            Write-Host \"\u274c FATAL: Health check failed after $maxRetries attempts\" -ForegroundColor Red\n\n            # FULL DIAGNOSTICS ON FAILURE\n            Write-Host \"`n=== FULL DIAGNOSTIC DUMP ===\" -ForegroundColor Red\n\n            Write-Host \"`n[STDOUT - Last 50 lines]\" -ForegroundColor Cyan\n            Get-Content \"service-logs/stdout.txt\" -Tail 50\n\n            Write-Host \"`n[STDERR - Last 50 lines]\" -ForegroundColor Cyan\n            Get-Content \"service-logs/stderr.txt\" -Tail 50\n\n            Write-Host \"`n[Process Status]\" -ForegroundColor Cyan\n            $processId = Get-Content \"service.pid\" -Raw\n            Get-Process -Id $processId -ErrorAction SilentlyContinue | Format-List\n\n            Write-Host \"`n[Port Binding Check]\" -ForegroundColor Cyan\n            netstat -ano | grep -E \"127\\.0\\.0\\.1:${{ env.SERVICE_PORT }}\" 2>$null || `\n              netstat -ano | Select-String \"127.0.0.1\" | Select-String \"${{ env.SERVICE_PORT }}\"\n\n            Write-Host \"`n[Firewall Rules]\" -ForegroundColor Cyan\n            Get-NetFirewallRule -DisplayName \"*Fortuna*\" -ErrorAction SilentlyContinue | Format-List\n\n            exit 1\n          }\n\n      - name: \ud83d\udd0c Test API Endpoint\n        run: |\n          Set-StrictMode -Version Latest\n\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}/api/races\"\n          $headers = @{ 'X-API-Key' = \"${{ env.API_KEY }}\" }\n\n          Write-Host \"Testing API endpoint: $url\" -ForegroundColor Cyan\n\n          try {\n            $response = Invoke-WebRequest `\n              -Uri $url `\n              -Headers $headers `\n              -UseBasicParsing `\n              -TimeoutSec 10\n\n            Write-Host \"\u2705 API Response: HTTP $($response.StatusCode)\" -ForegroundColor Green\n            Write-Host \"Response size: $($response.Content.Length) bytes\" -ForegroundColor Cyan\n            $response.Content | Out-File \"diagnostics/runtime-trace/api-response.json\"\n\n          } catch {\n            Write-Host \"\u26a0\ufe0f  API call failed (service running, but endpoint issue): $_\" -ForegroundColor Yellow\n          }\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 4: FRONTEND UI VERIFICATION\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: '\u2699\ufe0f Setup Node.js for Frontend Server'\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n\n      - name: '\ud83d\udce6 Install Serve for Static Hosting'\n        run: npm install -g serve\n\n      - name: '\ud83d\ude80 Start Frontend Server'\n        run: |\n          serve -s frontend-dist -l 3000 > frontend-server.log 2>&1 &\n          Start-Sleep -Seconds 5\n          $proc = Get-Process -Name \"serve\"\n          $frontendPid = $proc.Id\n          Write-Host \"\u2705 Frontend server started with PID: $frontendPid\"\n          $frontendPid | Out-File \"frontend.pid\" -Encoding ascii\n          Start-Sleep -Seconds 3\n\n      - name: '\ud83e\uddea Frontend UI Verification'\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          pip install playwright==1.48.2\n          python -m playwright install chromium\n          $scriptContent = @(\n            'import sys, os, time',\n            'from playwright.sync_api import sync_playwright, expect',\n            '',\n            'def run_verification():',\n            '    url = \"http://127.0.0.1:3000\"  # FRONTEND port, not backend!',\n            '',\n            '    with sync_playwright() as p:',\n            '        browser = p.chromium.launch()',\n            '        page = browser.new_page()',\n            '        page.tracing.start(screenshots=True, snapshots=True)',\n            '',\n            '        try:',\n            '            print(f\"[1] Navigating to {url}\")',\n            \"            page.goto(url, wait_until='networkidle', timeout=20000)\",\n            '',\n            '            print(f\"[2] Page title: {page.title()}\")',\n            '            print(f\"[3] Page URL: {page.url}\")',\n            '',\n            '            # Diagnostic: Get all h1 tags',\n            '            h1_elements = page.locator(\"h1\").all()',\n            '            print(f\"[4] Found {len(h1_elements)} h1 tag(s)\")',\n            '            for i, elem in enumerate(h1_elements):',\n            '                text = elem.text_content()',\n            '                print(f\"     h1[{i}] = \\'{text}\\'\")',\n            '',\n            '            # Diagnostic: Check page content',\n            '            content = page.content()',\n            '            if \"Fortuna Faucet\" in content:',\n            '                print(\"[5] \u2705 \\'Fortuna Faucet\\' in HTML\")',\n            '            else:',\n            '                print(\"[5] \u274c \\'Fortuna Faucet\\' NOT in HTML\")',\n            '                print(f\"     Page length: {len(content)} bytes\")',\n            '                print(f\"     First 500 chars: {content[:500]}\")',\n            '',\n            '            # Assertion',\n            \"            heading = page.locator(\\\"h1:has-text('Fortuna Faucet')\\\")\",\n            '            expect(heading).to_be_visible(timeout=10000)',\n            '',\n            '            print(\"[6] \u2705 UI test PASSED\")',\n            '            page.screenshot(path=\"smoke-test-screenshot.png\")',\n            '            page.tracing.stop(path=\"trace-success.zip\")',\n            '            sys.exit(0)',\n            '',\n            '        except Exception as e:',\n            '            print(f\"[ERROR] {type(e).__name__}: {e}\", file=sys.stderr)',\n            '            page.screenshot(path=\"smoke-test-screenshot-FAILURE.png\")',\n            '            page.tracing.stop(path=\"trace-failure.zip\")',\n            '            sys.exit(1)',\n            '        finally:',\n            '            browser.close()',\n            '',\n            'if __name__ == \"__main__\":',\n            '    run_verification()',\n            ''\n          )\n          Set-Content -Path \"verify_frontend.py\" -Value $scriptContent\n          python verify_frontend.py\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 4: POST-EXECUTION FORENSICS\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udcca Post-Test Forensics\n        if: failure()\n        run: |\n          Set-StrictMode -Version Latest\n\n          \"=== TOP PROCESSES ===\" | Out-File \"diagnostics/forensics.log\"\n          Get-Process | Sort-Object CPU -Descending | Select-Object -First 20 | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== NETWORK CONNECTIONS ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          netstat -ano | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== EVENT VIEWER (Last 20 errors) ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-EventLog -LogName System -EntryType Error -Newest 20 -ErrorAction SilentlyContinue | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== DISK SPACE ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-Volume | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== REGISTRY (FortunaWebService) ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-ItemProperty -Path \"HKLM:\\Software\\FortunaWebService\" -ErrorAction SilentlyContinue | Out-File -Append \"diagnostics/forensics.log\"\n\n      - name: \ud83d\udce4 Upload All Diagnostics\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: smoke-test-diagnostics-${{ github.run_id }}\n          path: |\n            service-logs/\n            diagnostics/\n            service.pid\n            frontend.pid\n            frontend-server.log\n            smoke-test-screenshot*.png\n            trace-*.zip\n          retention-days: 30\n          if-no-files-found: warn\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        run: |\n          if (Test-Path 'service.pid') {\n            try {\n              $backendPid = Get-Content 'service.pid' -Raw\n              Stop-Process -Id $backendPid -Force -ErrorAction SilentlyContinue\n              Write-Host \"\u2705 Backend service process terminated\"\n            } catch {\n              Write-Host \"\u26a0\ufe0f  Could not terminate backend process\"\n            }\n          }\n          if (Test-Path 'frontend.pid') {\n            try {\n              $frontendPid = Get-Content 'frontend.pid' -Raw\n              Stop-Process -Id $frontendPid -Force -ErrorAction SilentlyContinue\n              Write-Host \"\u2705 Frontend server process terminated\"\n            } catch {\n              Write-Host \"\u26a0\ufe0f  Could not terminate frontend process\"\n            }\n          }\n          Remove-NetFirewallRule -DisplayName \"FortunaSmoke\" -ErrorAction SilentlyContinue\n          Remove-NetFirewallRule -DisplayName \"FortunaSmokeHTTP\" -ErrorAction SilentlyContinue\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [path-finder, repo-preflight, smoke-test]\n    env:\n      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: Stage Artifacts\n        id: stage\n        run: |\n          Set-StrictMode -Version Latest\n          $staging = \"${{ env.MSI_STAGING_DIR }}\"\n          New-Item -ItemType Directory -Path $staging -Force | Out-Null\n          # Rename the executable to match the service name defined in the WiX project\n          Move-Item -Path \"dist/fortuna-backend.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n          $msiName = \"Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi\".Replace('/', '-')\n          \"msi_name=$msiName\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\u2705 Staged for MSI: $msiName\"\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: Cache NuGet\n        uses: actions/cache@v4\n        with:\n          path: ~/.nuget/packages\n          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}\n\n      - name: Prepare WiX Project\n        run: |\n          Set-StrictMode -Version Latest\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n          $wixProj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">'\n            '  <PropertyGroup>'\n            '    <OutputName>${{ steps.stage.outputs.msi_name }}</OutputName>'\n            '    <OutputType>Package</OutputType>'\n            '    <DefineConstants>SourceDir=staging;Version=${{ env.BUILD_VERSION }}</DefineConstants>'\n            '    <Platforms>x64</Platforms>'\n            '    <Version>${{ env.BUILD_VERSION }}</Version>'\n            '  </PropertyGroup>'\n            '  <ItemGroup>'\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '  </ItemGroup>'\n            '  <ItemGroup>'\n            '    <Compile Include=\"Product.wxs\" />'\n            '  </ItemGroup>'\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value $wixProj -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: |\n          Set-StrictMode -Version Latest\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"${{ env.BUILD_VERSION }}\"\n          $msiFile = \"bin/x64/Release/${{ steps.stage.outputs.msi_name }}\"\n          if (-not (Test-Path $msiFile)) { throw \"MSI not created\" }\n          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash\n          $hash | Out-File \"$msiFile.sha256\" -Encoding utf8\n          Write-Host \"\u2705 MSI Built: $hash\"\n\n      - name: Upload MSI + Hash\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: |\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.msi\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.sha256\n          retention-days: 10\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    needs: package-msi-service\n    permissions:\n      contents: write\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          pattern: fortuna-service-msi-*\n          merge-multiple: true\n          path: assets\n\n      - name: Download SBOM\n        uses: actions/download-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: assets\n\n      - name: Generate Checksums\n        run: |\n          cd assets\n          ls *.msi\n          sha256sum *.msi > SHASUMS256.txt\n\n      - name: Publish Release\n        uses: softprops/action-gh-release@v2\n        with:\n          files: |\n            assets/*.msi\n            assets/*.sha256\n            assets/SHASUMS256.txt\n            assets/sbom.spdx.json\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-web-service-msi-grok.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-web-service-msi-grok.ymlx",
    "content": "name: Build Fortuna Faucet MSI (WiX v4) - Grok\n\non:\n  push:\n    branches:\n      - deactivated\n  workflow_dispatch:\n\npermissions:\n  contents: write\n  actions: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n\njobs:\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_service/frontend/package-lock.json'\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          cd web_service/frontend\n          npm ci\n          npm run build\n      - name: Verify Frontend Build\n        shell: pwsh\n        run: |\n          if (-not (Test-Path 'web_service/frontend/out/index.html')) { throw \"\u274c Missing index.html\" }\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: frontend-build\n          path: web_service/frontend/out\n          retention-days: 1\n\n  build-and-test:\n    name: '\ud83d\udc0d Build & Smoke Test'\n    needs: [build-frontend]\n    runs-on: windows-latest\n    env:\n      FORTUNA_PORT: 8088\n      SMOKE_FRONTEND_URL: \"http://localhost:8088\"\n      SMOKE_HEADING_SELECTOR: \"h1\"\n      SMOKE_SCREENSHOT_PATH: \"smoke-test.png\"\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Setup Python\n        id: setup-python\n        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: 'web_service/backend/requirements-dev.txt'\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: frontend-build\n          path: web_service/frontend/out\n\n      - name: Install Dependencies\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Stop\"\n          ${{ steps.setup-python.outputs.python-path }} -m pip install --upgrade pip\n          ${{ steps.setup-python.outputs.python-path }} -m pip install -r web_service/backend/requirements-dev.txt\n          ${{ steps.setup-python.outputs.python-path }} -m pip install playwright pytest-playwright\n\n      - name: Get Playwright Version\n        id: playwright-version\n        shell: pwsh\n        run: echo \"VERSION=$(${{ steps.setup-python.outputs.python-path }} -c 'from importlib.metadata import version; print(version(\"playwright\"))')\" >> $env:GITHUB_OUTPUT\n\n      - name: Cache Playwright Browsers\n        uses: actions/cache@88522ab9f39a2ea568f7027ed67a8d8f9e9d59c3 # v4.0.2\n        id: playwright-cache\n        with:\n          path: C:\\Users\\runneradmin\\AppData\\Local\\ms-playwright\n          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.VERSION }}\n\n      - name: Install Playwright Browsers\n        if: steps.playwright-cache.outputs.cache-hit != 'true'\n        shell: pwsh\n        run: ${{ steps.setup-python.outputs.python-path }} -m playwright install --with-deps chromium\n\n      - name: Create Web Service PyInstaller Spec\n        shell: pwsh\n        run: |\n          cp fortuna-backend-electron.spec fortuna-webservice.spec\n          (Get-Content fortuna-webservice.spec) -replace 'python_service/main.py', 'web_service/backend/main.py' | Set-Content fortuna-webservice.spec\n          (Get-Content fortuna-webservice.spec) -replace 'python_service/data', 'web_service/backend/data' | Set-Content fortuna-webservice.spec\n          (Get-Content fortuna-webservice.spec) -replace 'python_service/json', 'web_service/backend/json' | Set-Content fortuna-webservice.spec\n          (Get-Content fortuna-webservice.spec) -replace 'python_service/adapters', 'web_service/backend/adapters' | Set-Content fortuna-webservice.spec\n          (Get-Content fortuna-webservice.spec) -replace 'fortuna-backend', 'fortuna-webservice' | Set-Content fortuna-webservice.spec\n\n      - name: Backend - Build with PyInstaller\n        shell: pwsh\n        run: ${{ steps.setup-python.outputs.python-path }} -m pyinstaller fortuna-webservice.spec --clean --log-level WARN --noconfirm\n\n      - name: '\ud83d\udee1\ufe0f Open Firewall'\n        shell: pwsh\n        run: New-NetFirewallRule -DisplayName \"SmokeTest\" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}\n\n      - name: Run Backend (Background)\n        shell: pwsh\n        run: |\n          New-Item -ItemType Directory -Path \"data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"logs\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"json\" -Force | Out-Null\n          Write-Host \"\ud83d\udcc2 Runtime directories created.\"\n          $env:FORTUNA_PORT = \"${{ env.FORTUNA_PORT }}\"\n          $env:FORTUNA_MODE = \"webservice\"\n          $p = Start-Process -FilePath \"dist/fortuna-webservice.exe\" -PassThru -RedirectStandardOutput \"backend.log\" -RedirectStandardError \"backend.err\"\n          $p.Id | Out-File \"backend.pid\"\n          Write-Host \"\ud83d\ude80 Service started with PID $($p.Id) on port $env:FORTUNA_PORT\"\n          Start-Sleep -Seconds 5\n\n      - name: Health Check\n        shell: pwsh\n        run: |\n          $ErrorActionPreference = \"Continue\"\n          $healthUrl = \"http://127.0.0.1:${{ env.FORTUNA_PORT }}/health\"\n          $maxAttempts = 15\n          $delaySeconds = 2\n          $success = $false\n\n          For ($i = 1; $i -le $maxAttempts; $i++) {\n            try {\n              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 Health check passed on attempt $i\" -ForegroundColor Green\n                $success = $true\n                break\n              }\n            } catch {\n              Write-Host \"Attempt $i of $maxAttempts failed. Retrying in $delaySeconds seconds...\" -ForegroundColor Yellow\n              Start-Sleep -Seconds $delaySeconds\n            }\n          }\n\n          if (-not $success) {\n            Write-Host \"\u274c Health check failed after $maxAttempts attempts\" -ForegroundColor Red\n            exit 1\n          }\n\n      - name: '\ud83d\udcf8 Playwright Verification'\n        shell: pwsh\n        run: |\n          $script = @\"\n          import sys, os, time\n          from playwright.sync_api import sync_playwright, expect\n\n          url = os.environ[\"SMOKE_FRONTEND_URL\"]\n          print(f\"Testing URL: {url}\")\n\n          with sync_playwright() as p:\n              browser = p.chromium.launch()\n              context = browser.new_context()\n              context.tracing.start(screenshots=True, snapshots=True)\n              page = context.new_page()\n              try:\n                  for i in range(10):\n                      try:\n                          page.goto(url, wait_until='domcontentloaded', timeout=5000)\n                          break\n                      except:\n                          print(f\"Waiting for server... ({i+1}/10)\")\n                          time.sleep(2)\n\n                  expect(page.locator(\"body\")).to_be_visible(timeout=10000)\n                  page.screenshot(path=os.environ[\"SMOKE_SCREENSHOT_PATH\"])\n                  print(\"\u2705 Screenshot captured.\")\n                  context.tracing.stop(path=\"trace.zip\")\n              except Exception as e:\n                  print(f\"\u274c Error: {e}\")\n                  page.screenshot(path=\"FAILURE.png\")\n                  context.tracing.stop(path=\"trace.zip\")\n                  sys.exit(1)\n              finally:\n                  browser.close()\n          \"@\n          Set-Content -Path \"verify.py\" -Value $script\n          ${{ steps.setup-python.outputs.python-path }} verify.py\n\n      - name: Upload Screenshot\n        if: always()\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: smoke-test-evidence\n          path: |\n            *.png\n            backend.log\n            backend.err\n            trace.zip\n\n      - name: '\ud83d\udd75\ufe0f Inspect Backend Logs (On Failure)'\n        if: failure()\n        shell: pwsh\n        run: |\n          Write-Host \"::group::Backend Error Log (Why did it crash?)\"\n          if (Test-Path \"backend.err\") { Get-Content \"backend.err\" } else { Write-Host \"No error log found.\" }\n          Write-Host \"::endgroup::\"\n\n          Write-Host \"::group::Backend Output Log\"\n          if (Test-Path \"backend.log\") { Get-Content \"backend.log\" }\n          Write-Host \"::endgroup::\"\n\n      - name: Upload Validated EXE\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: backend-executable\n          path: dist/fortuna-webservice.exe\n\n      - name: Cleanup Firewall & Process\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path \"backend.pid\") { Stop-Process -Id (Get-Content \"backend.pid\") -Force -ErrorAction SilentlyContinue }\n          Remove-NetFirewallRule -DisplayName \"SmokeTest\" -ErrorAction SilentlyContinue\n          Remove-NetFirewallRule -DisplayName \"Allow Fortuna Smoke Test\" -ErrorAction SilentlyContinue\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    needs: [build-and-test]\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2\n\n      - name: Download Validated Executable\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: backend-executable\n          path: build_wix/staging\n\n      - name: Setup .NET 8 (for WiX)\n        uses: actions/setup-dotnet@3e891b0cb619bf60e2c25674b222b8940e2c1c25 # v4.1.0\n        with:\n          dotnet-version: '8.0.x'\n\n      - name: Copy WXS File\n        shell: pwsh\n        run: cp wix/product_webservice.wxs build_wix/Product_WithService.wxs\n\n      - name: Remove Conflicting WXS\n        shell: pwsh\n        run: |\n           if (Test-Path \"build_wix/Product_WithoutService.wxs\") { Remove-Item \"build_wix/Product_WithoutService.wxs\" -Force }\n\n      - name: Generate WiX Project File (Dynamic Name)\n        working-directory: build_wix\n        shell: pwsh\n        run: |\n          $msiName = \"Fortuna-WebService-${{ github.run_number }}\"\n\n          $wixProjContent = @\"\n          <Project Sdk=\"WixToolset.Sdk/4.0.5\">\n            <PropertyGroup>\n              <OutputName>$msiName</OutputName>\n              <OutputType>Package</OutputType>\n              <DefineConstants>SourceDir=staging</DefineConstants>\n              <Platforms>x64</Platforms>\n              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>\n            </PropertyGroup>\n            <ItemGroup>\n              <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"4.0.5\" />\n            </ItemGroup>\n            <ItemGroup>\n              <Compile Include=\"Product_WithService.wxs\" />\n            </ItemGroup>\n          </Project>\n          \"@\n          Set-Content -Path \"Fortuna.wixproj\" -Value $wixProjContent -Encoding UTF8\n\n      - name: Build MSI (Inject Version)\n        working-directory: build_wix\n        run: |\n          $packageVersion = \"${{ github.run_number }}.${{ github.run_attempt }}.0\"\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=$packageVersion\n\n      - name: Upload MSI\n        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3\n        with:\n          name: fortuna-installer\n          path: build_wix/bin/x64/Release/*.msi\n          if-no-files-found: error\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    needs: [package-msi-service]\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8\n        with:\n          name: fortuna-installer\n          path: dist\n      - name: Create Release\n        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.2.0\n        with:\n          files: dist/*.msi\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-web-service-msi-jules.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-web-service-msi-jules.yml",
    "content": "# System Timestamp: 2025-12-04 16:01:12.318079\nname: Build Fortuna Faucet Web Service Installer (Synthesized Overkill)\n\non:\n  push:\n    branches:\n      - main\n\npermissions:\n  contents: read\n  actions: read\n  checks: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\ndefaults:\n  run:\n    shell: pwsh\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  PYTHONUTF8: '1'\n  PIP_DISABLE_PIP_VERSION_CHECK: '1'\n  PIP_NO_PYTHON_VERSION_WARNING: '1'\n  NPM_CONFIG_FUND: 'false'\n  NPM_CONFIG_AUDIT: 'false'\n  FORCE_COLOR: '3'\n  FRONTEND_DIR: 'web_platform/frontend'\n  FRONTEND_BUILD_DIR: 'web_platform/frontend/out'\n  WIX_DIR: 'build_wix'\n  SERVICE_PORT: '8102'\n  HEALTH_ENDPOINT: '/health'\n  API_KEY: ${{ secrets.TEST_API_KEY }}\n  TVG_API_KEY: \"mock_key\"\n  GREYHOUND_API_URL: \"http://mock\"\n  FORTUNA_ENV: \"smoke-test\"\n  MSI_STAGING_DIR: 'build_wix/staging'\n  MSI_OUTPUT_DIR: 'dist'\n  WIX_VERSION: '4.0.5'\n\njobs:\n  path-finder:\n    name: '\ud83d\udd0e Path Finder Dynamic Backend Detection'\n    runs-on: windows-latest\n    outputs:\n      backend_dir: ${{ steps.find-path.outputs.backend_dir }}\n      backend_module_path: ${{ steps.find-path.outputs.backend_module_path }}\n      spec_file: ${{ steps.find-path.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Detect Backend Path\n        id: find-path\n        run: |\n          Set-StrictMode -Version Latest\n          $web_service_path = \"web_service/backend\"\n          $python_service_path = \"python_service\"\n          $backend_dir = \"\"\n          $backend_module_path = \"\"\n          $spec_file = \"\"\n\n          Write-Host \"--- Path Finding Forensics ---\"\n          Write-Host \"Searching for the correct backend service directory...\"\n\n          # Test web_service path\n          $web_service_main = Test-Path (Join-Path $web_service_path \"main.py\")\n          $web_service_api = Test-Path (Join-Path $web_service_path \"api.py\")\n          $web_service_init = Test-Path (Join-Path $web_service_path \"__init__.py\")\n          Write-Host \"Checking '$web_service_path':\"\n          Write-Host \"  main.py -> $web_service_main\"\n          Write-Host \"  api.py -> $web_service_api\"\n          Write-Host \"  __init__.py -> $web_service_init\"\n\n          # Test python_service path\n          $python_service_main = Test-Path (Join-Path $python_service_path \"main.py\")\n          $python_service_api = Test-Path (Join-Path $python_service_path \"api.py\")\n          $python_service_init = Test-Path (Join-Path $python_service_path \"__init__.py\")\n          Write-Host \"Checking '$python_service_path':\"\n          Write-Host \"  main.py -> $python_service_main\"\n          Write-Host \"  api.py -> $python_service_api\"\n          Write-Host \"  __init__.py -> $python_service_init\"\n\n          if ($web_service_main -and $web_service_api -and $web_service_init) {\n            $backend_dir = $web_service_path\n            $backend_module_path = \"web_service.backend\"\n            $spec_file = \"jules.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'web_service/backend' as the target.\" -ForegroundColor Green\n          } elseif ($python_service_main -and $python_service_api -and $python_service_init) {\n            $backend_dir = $python_service_path\n            $backend_module_path = \"python_service\"\n            $spec_file = \"fortuna-backend-webservice.spec\"\n            Write-Host \"\u2705 Verdict: Detected 'python_service' as the target.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c FATAL: Could not determine a valid backend directory. Neither 'web_service/backend' nor 'python_service' contains the required files (main.py, api.py, __init__.py).\" -ForegroundColor Red\n            exit 1\n          }\n\n          Write-Host \"--- Outputs ---\"\n          Write-Host \"backend_dir: $backend_dir\"\n          Write-Host \"backend_module_path: $backend_module_path\"\n          Write-Host \"spec_file: $spec_file\"\n\n          \"backend_dir=$backend_dir\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_module_path=$backend_module_path\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"spec_file=$spec_file\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n  system-check:\n    name: '\u2699\ufe0f System Prerequisites'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    outputs:\n      disk_free_gb: ${{ steps.system.outputs.disk_gb }}\n    steps:\n      - name: Verify Build Tools\n        run: |\n          Set-StrictMode -Version Latest\n          $tools = @('dotnet', 'python', 'node', 'npm', 'git')\n          foreach ($tool in $tools) {\n            Write-Host \"Checking for $($tool)...\"\n            Get-Command $tool -ErrorAction SilentlyContinue\n            if (-not $?) {\n              Write-Host \"\u274c FATAL: Build tool '$tool' not found in PATH.\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical build tools are present.\" -ForegroundColor Green\n      - name: Check Disk Space\n        id: system\n        run: |\n          Set-StrictMode -Version Latest\n          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }\n          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)\n          if ($freeGB -lt 10) {\n            Write-Host \"\u26a0\ufe0f WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended).\" -ForegroundColor Yellow\n          } else {\n            Write-Host \"\u2705 Disk space check passed ($freeGB GB free).\" -ForegroundColor Green\n          }\n          \"disk_gb=$freeGB\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n  repo-preflight:\n    name: '\ud83e\uddea Repo Preflight & Integrity'\n    runs-on: windows-latest\n    needs: [path-finder, system-check]\n    timeout-minutes: 5\n    outputs:\n      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}\n      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}\n      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: Derive Build Metadata\n        id: meta\n        run: |\n          Set-StrictMode -Version Latest\n          $ref = \"${{ github.ref }}\"\n          if ($ref -like 'refs/tags/v*') {\n            $semver = $ref -replace 'refs/tags/v', ''\n          } else {\n            $semver = \"0.0.${{ github.run_number }}\"\n          }\n          $shortSha = \"${{ github.sha }}\".Substring(0,7)\n          \"semver=$semver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"short_sha=$shortSha\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\ud83d\udd16 Version: $semver ($shortSha)\"\n\n      - name: Validate Critical Files Exist\n        env:\n          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n        run: |\n          Set-StrictMode -Version Latest\n          $paths = @(\n            \"${{ env.FRONTEND_DIR }}/package.json\",\n            \"${{ env.FRONTEND_DIR }}/package-lock.json\",\n            (Join-Path $env:BACKEND_DIR \"requirements.txt\"),\n            (Join-Path $env:BACKEND_DIR \"main.py\"),\n            \"${{ env.WIX_DIR }}/Product_WithService.wxs\"\n          )\n          foreach ($path in $paths) {\n            if (-not (Test-Path $path)) {\n              Write-Host \"\u274c FATAL: Required path missing: $path\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical files confirmed.\"\n\n      - name: Capture Integrity Hashes\n        id: hashes\n        env:\n          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n        run: |\n          Set-StrictMode -Version Latest\n          $frontend = (Get-FileHash \"${{ env.FRONTEND_DIR }}/package-lock.json\" -Algorithm SHA256).Hash\n          $backend = (Get-FileHash (Join-Path $env:BACKEND_DIR \"requirements.txt\") -Algorithm SHA256).Hash\n          $wix = (Get-FileHash \"${{ env.WIX_DIR }}/Product_WithService.wxs\" -Algorithm SHA256).Hash\n          \"frontend_lock_hash=$frontend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_requirements_hash=$backend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"wix_definition_hash=$wix\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Upload Integrity Snapshot\n        uses: actions/upload-artifact@v4\n        with:\n          name: repo-preflight-${{ github.run_id }}\n          path: |\n            ${{ env.FRONTEND_DIR }}/package-lock.json\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.WIX_DIR }}/Product_WithService.wxs\n          retention-days: 3\n\n  frontend-quality:\n    name: '\ud83e\uddfc Frontend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Cache Frontend Build\n        id: cache-frontend\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Run Lint (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {\n            Write-Host \"\ud83e\uddf9 Running npm run lint\"\n            npm run lint\n          } else {\n            Write-Host \"\u2139\ufe0f No lint script defined, skipping.\"\n          }\n\n      - name: Run Tests (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {\n            Write-Host \"\ud83e\uddea Running npm test -- --watch=false\"\n            npm test -- --watch=false\n          } else {\n            Write-Host \"\u2139\ufe0f No test script defined, skipping.\"\n          }\n\n      - name: Security Audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm audit --audit-level=critical\n\n  backend-quality:\n    name: '\ud83e\uddef Backend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: [path-finder, repo-preflight]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Cache Backend Build\n        id: cache-backend\n        uses: actions/cache@v4\n        with:\n          path: dist\n          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")\n          }\n\n      - name: Bytecode Compile (Fail Fast)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m compileall -q \"${{ env.BACKEND_DIR }}\"\n\n      - name: Run Pytest (if available)\n        run: |\n          Set-StrictMode -Version Latest\n          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec(\"pytest\") else 1)'\n          if ($LASTEXITCODE -eq 0) {\n            Write-Host \"\ud83e\uddea pytest detected, running suite...\"\n            python -m pytest \"${{ env.BACKEND_DIR }}\" --maxfail=1 --disable-warnings\n          } else {\n            Write-Host \"\u2139\ufe0f pytest not installed; skipping tests.\"\n          }\n\n      - name: pip-audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          pip install pip-audit\n          pip-audit -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n\n  sbom:\n    name: '\ud83d\udcc4 SBOM Snapshot'\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Generate SBOM (SPDX)\n        uses: anchore/sbom-action@v0\n        with:\n          output-file: sbom.spdx.json\n          format: spdx-json\n\n      - name: Upload SBOM\n        uses: actions/upload-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: sbom.spdx.json\n          retention-days: 7\n\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: [path-finder, repo-preflight, frontend-quality]\n    env:\n      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Cache Frontend Build\n        id: cache-frontend\n        uses: actions/cache@v4\n        with:\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          key: ${{ runner.os }}-frontend-build-${{ hashFiles('${{ env.FRONTEND_DIR }}/**') }}\n          restore-keys: |\n            ${{ runner.os }}-frontend-build-\n\n      - name: Prime npm Cache\n        uses: actions/cache@v4\n        with:\n          path: ~\\AppData\\Local\\npm-cache\n          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}\n          restore-keys: |\n            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Build Frontend\n        if: steps.cache-frontend.outputs.cache-hit != 'true'\n        env:\n          NEXT_PUBLIC_API_URL: http://127.0.0.1:${{ env.SERVICE_PORT }}\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm run build\n\n      - name: Report Cache Status\n        run: |\n          if ('${{ steps.cache-frontend.outputs.cache-hit }}' -eq 'true') {\n            Write-Host \"\u2705 Frontend build restored from cache.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u2139\ufe0f No cache hit. A new build was performed.\" -ForegroundColor Yellow\n          }\n\n      - name: Verify Build Output\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          if (-not (Test-Path $outDir)) {\n             Write-Host \"\u274c FATAL: Build directory not found\" -ForegroundColor Red\n             exit 1\n          }\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) {\n             Write-Host \"\u274c FATAL: Build directory empty\" -ForegroundColor Red\n             exit 1\n          }\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n      - name: Generate Artifact Manifest\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_DIR }}/out\"\n          # Fallback for different env var names in different workflows\n          if (-not (Test-Path $outDir)) { $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\" }\n\n          if (-not (Test-Path $outDir)) { Write-Error \"\u274c Build failed: 'out' dir missing\"; exit 1 }\n\n          $manifestPath = \"frontend-manifest.tsv\"\n          \"RelativePath`tSizeBytes`tSHA256\" | Out-File $manifestPath -Encoding utf8\n\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) { Write-Error \"\u274c Build failed: 'out' dir empty\"; exit 1 }\n\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n          foreach ($f in $files) {\n            # FIX: Changed TrimStart('\\\\\\\\', '/') to TrimStart('\\\\', '/') to prevent char conversion error\n            $rel = $f.FullName.Substring($outDir.Path.Length).TrimStart('\\','/')\n            $hash = (Get-FileHash $f.FullName -Algorithm SHA256).Hash.Substring(0,16)\n            \"$rel`t$($f.Length)`t$hash\" | Out-File $manifestPath -Encoding utf8 -Append\n          }\n\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          retention-days: 3\n\n      - name: Upload Manifest\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-manifest-${{ github.run_id }}\n          path: frontend-manifest.tsv\n          retention-days: 3\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [path-finder, repo-preflight, build-frontend, backend-quality]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n      BACKEND_SPEC: ${{ needs.path-finder.outputs.spec_file }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: temp-frontend\n\n      - name: Cache Backend Build\n        id: cache-backend\n        uses: actions/cache@v4\n        with:\n          path: dist\n          key: ${{ runner.os }}-backend-build-${{ hashFiles(format('{0}/**', env.BACKEND_DIR), format('{0}', env.BACKEND_SPEC)) }}\n          restore-keys: |\n            ${{ runner.os }}-backend-build-\n\n      - name: Stage Frontend for PyInstaller\n        run: |\n          Set-StrictMode -Version Latest\n          $dest = \"staging/ui\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n          Copy-Item -Path \"temp-frontend/*\" -Destination $dest -Recurse -Force\n          Write-Host \"\u2705 Frontend staged for inclusion.\"\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r (Join-Path $env:BACKEND_DIR \"requirements.txt\")\n          if (Test-Path (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")) {\n            pip install -r (Join-Path $env:BACKEND_DIR \"requirements-dev.txt\")\n          }\n\n      - name: Freeze Dependency Snapshot\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          pip freeze | Out-File backend-freeze.txt -Encoding utf8\n\n      - name: Create Dynamic webservice.spec for PyInstaller\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        shell: python\n        env:\n          BACKEND_DIR: ${{ needs.path-finder.outputs.backend_dir }}\n          BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n          FRONTEND_OUT: ${{ env.FRONTEND_DIR }}/out\n        run: |\n          import os\n          from pathlib import Path\n\n          # FIX: Normalize paths to forward slashes to avoid f-string backslash hell\n          bk_dir = os.environ['BACKEND_DIR'].replace('\\\\', '/')\n          mod_path = os.environ['BACKEND_MODULE_PATH']\n          frontend_out = os.environ['FRONTEND_OUT'].replace('\\\\', '/')\n          spec_file = \"jules.spec\" # Hardcode the correct spec file name\n\n          entry = f\"{bk_dir}/main.py\"\n\n          spec = f\"\"\"\n          # -- mode: python ; coding: utf-8 --\n          from PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\n          block_cipher = None\n\n          a = Analysis(\n              ['{entry}'],\n              pathex=[],\n              binaries=[],\n              datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],\n              hiddenimports=collect_submodules('{mod_path}') + ['win32timezone'],\n              hookspath=[],\n              runtime_hooks=[],\n              excludes=['tests', 'pytest'],\n              win_no_prefer_redirects=False,\n              win_private_assemblies=False,\n              cipher=block_cipher,\n              noarchive=False,\n          )\n          pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n          exe = EXE(\n              pyz, a.scripts, a.binaries, a.zipfiles, a.datas, [],\n              name='fortuna-backend', debug=False, bootloader_ignore_signals=False, strip=False, upx=True, console=False\n          )\n          \"\"\"\n          with open(spec_file, \"w\") as f: f.write(spec)\n\n      - name: Create Required Backend Directories\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        run: |\n          Set-StrictMode -Version Latest\n          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR \"data\") -Force | Out-Null\n          New-Item -ItemType Directory -Path (Join-Path $env:BACKEND_DIR \"json\") -Force | Out-Null\n          Write-Host \"\u2705 Created required backend directories for PyInstaller.\" -ForegroundColor Green\n\n\n      - name: Build with PyInstaller\n        if: steps.cache-backend.outputs.cache-hit != 'true'\n        env:\n          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n        run: |\n          Set-StrictMode -Version Latest\n          pyinstaller \"${{ env.BACKEND_SPEC }}\" --clean --log-level=WARN --noconfirm\n\n      - name: Report Cache Status\n        run: |\n          if ('${{ steps.cache-backend.outputs.cache-hit }}' -eq 'true') {\n            Write-Host \"\u2705 Backend build restored from cache.\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u2139\ufe0f No cache hit. A new build was performed.\" -ForegroundColor Yellow\n          }\n\n      - name: Verify Executable\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exePath)) {\n            Write-Host \"\u274c FATAL: Executable not found\" -ForegroundColor Red\n            exit 1\n          }\n          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash\n          $size = (Get-Item $exePath).Length / 1MB\n          if ($size -lt 10) {\n            Write-Host \"\u274c FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete.\" -ForegroundColor Red\n            exit 1\n          }\n          \"fortuna-backend.exe`t$hash\" | Out-File backend-sha256.tsv -Encoding utf8\n          Write-Host \"\u2705 Backend ready: $([math]::Round($size, 2)) MB ($hash)\"\n\n      - name: Upload Backend Executable\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 3\n\n      - name: Upload Backend Metadata\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-metadata-${{ github.run_id }}\n          path: |\n            backend-sha256.tsv\n            backend-freeze.txt\n          retention-days: 7\n\n  diagnose-asgi-imports:\n    name: '\ud83d\udd0d ASGI Import Killer Pre-Smoke Diagnostic'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: [path-finder, build-backend]\n    continue-on-error: true\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n      - name: 'Run ASGI Diagnostics'\n        uses: ./.github/actions/run-asgi-diagnostics\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          backend-dir: ${{ needs.path-finder.outputs.backend_dir }}\n          backend-module-path: ${{ needs.path-finder.outputs.backend_module_path }}\n\n  diagnose-runtime:\n    name: '\ud83d\udd0e Diagnose PyInstaller Runtime'\n    runs-on: windows-latest\n    timeout-minutes: 10\n    needs: [path-finder, build-backend]\n    continue-on-error: true\n    env:\n      BACKEND_MODULE_PATH: ${{ needs.path-finder.outputs.backend_module_path }}\n    steps:\n      - name: \ud83d\udce5 Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: \ud83d\udc0d Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: \ud83d\udce6 Install PyInstaller\n        run: pip install pyinstaller==6.6.0\n\n      - name: \ud83d\udd75\ufe0f Extract and Analyze Executable Contents\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n\n          Write-Host \"--- Executable Analysis ---\"\n          Write-Host \"Analyzing contents of $exePath with pyi-archive_viewer...\"\n\n          $archiveContents = pyi-archive_viewer $exePath\n          if ($LASTEXITCODE -ne 0) {\n            Write-Error \"Failed to analyze executable with pyi-archive_viewer.\"\n            exit 1\n          }\n\n          Write-Host \"\\n--- Archive Contents ---\"\n          $archiveContents | Out-Host\n\n          # FIX: Normalize slashes for comparison\n          $expectedInitFile = ($env:BACKEND_MODULE_PATH.Replace('.', '/') + '/__init__.py')\n\n          # Check for the file, replacing backslashes with forward slashes in the output\n          $found = $archiveContents | ForEach-Object { $_.Replace('\\', '/') } | Select-String -Pattern $expectedInitFile -SimpleMatch -Quiet\n\n          if ($found) {\n            Write-Host \"\u2705 SUCCESS: Key module file found inside the executable archive.\" -ForegroundColor Green\n          } else {\n            Write-Error \"\u274c FAILURE: Key module file '$expectedInitFile' NOT found inside the executable.\"\n            exit 1\n          }\n\n      - name: \ud83d\udce4 Upload Extracted Artifacts\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: extracted-executable-${{ github.run_id }}\n          path: extracted_exe/\n          retention-days: 7\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test (Triple-Loop Synthesis)'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs:\n      - build-backend\n      - package-msi-service # Run after packaging is complete\n    steps:\n      - name: \ud83d\udce5 Download MSI Installer\n        uses: actions/download-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: msi-installer\n\n      - name: \ud83d\udd75\ufe0f Find MSI Installer\n        id: find_msi\n        shell: pwsh\n        run: |\n          $msi = Get-ChildItem -Path \"msi-installer\" -Filter \"*.msi\" -Recurse | Select-Object -First 1\n          if (-not $msi) {\n            Write-Error \"\u274c No MSI found in the artifact!\"\n            Get-ChildItem -Path \"msi-installer\" -Recurse | Write-Host\n            exit 1\n          }\n          Write-Host \"\u2705 Found MSI: $($msi.FullName)\"\n          \"msi_path=$($msi.FullName)\" | Out-File -FilePath $env:GITHUB_OUTPUT -Append\n\n      - name: \ud83d\udee1\ufe0f Grant Full Control to SYSTEM for Temp Directory\n        shell: pwsh\n        run: |\n          $tempPath = $env:TEMP\n          Write-Host \"Granting SYSTEM FullControl on $tempPath\"\n          icacls $tempPath /grant \"NT AUTHORITY\\SYSTEM:(OI)(CI)F\" /T\n          if ($LASTEXITCODE -ne 0) {\n            Write-Warning \"icacls command failed, but continuing...\"\n          } else {\n            Write-Host \"\u2705 Privileges granted successfully.\"\n          }\n\n      - name: Create Runtime Directories\n        shell: pwsh\n        run: |\n          $installDir = \"C:\\Program Files\\Fortuna Faucet Service\"\n          New-Item -ItemType Directory -Path \"$installDir\\data\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\json\" -Force\n          New-Item -ItemType Directory -Path \"$installDir\\logs\" -Force\n          Write-Host \"\u2705 Ensured runtime directories exist in $installDir\"\n\n      - name: '\ud83d\ude80 LOOP 1 - Install & Verify Service Registration'\n        shell: pwsh\n        run: |\n          if (Get-Service -Name FortunaWebService -ErrorAction SilentlyContinue) {\n            sc.exe stop FortunaWebService 2>&1 | Out-Null\n            sc.exe delete FortunaWebService 2>&1 | Out-Null\n          }\n\n          $msiPath = \"${{ steps.find_msi.outputs.msi_path }}\"\n          Write-Host \"Starting installation of $msiPath...\"\n\n          $proc = Start-Process msiexec.exe -ArgumentList \"/i `\"$msiPath`\" /qn /L*v msi-install.log\" -Wait -PassThru\n\n          # Allow exit code 3010 (reboot required)\n          if ($proc.ExitCode -ne 0 -and $proc.ExitCode -ne 3010) {\n            Write-Error \"\u274c MSI installation failed with exit code $($proc.ExitCode).\"\n            exit 1\n          }\n\n          Write-Host \"\u2705 Installation completed (Exit Code: $($proc.ExitCode)). Verifying service registration...\"\n\n          $service = Get-Service -Name \"FortunaWebService\" -ErrorAction SilentlyContinue\n          if (-not $service) {\n            Write-Error \"\u274c FATAL: Service 'FortunaWebService' was not registered.\"\n            exit 1\n          }\n\n          Write-Host \"\u2705 Service is registered. State: $($service.Status)\"\n\n      - name: Emit MSI log tail\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path msi-install.log) {\n            Write-Host \"`n=== msi-install.log (last 200 lines) ===\"\n            Get-Content msi-install.log -Tail 200\n          } else {\n            Write-Host \"No msi-install.log found\"\n          }\n\n      - name: \ud83d\ude80 Active Port Poll\n        shell: pwsh\n        run: |\n          $start = Get-Date\n          while ((Get-Date) - $start -lt (New-TimeSpan -Seconds 30)) {\n            if (Test-NetConnection -ComputerName localhost -Port 8102 -InformationLevel Quiet) {\n              Write-Host \"\u2705 Service is listening.\"\n              return\n            }\n            Start-Sleep 1\n          }\n          throw \"\u274c Service failed to bind port 8102 within 30 seconds.\"\n\n      - name: '\ud83e\ude7a LOOP 3 - Health Check Endpoint'\n        shell: pwsh\n        run: |\n          Write-Host \"Starting health checks against http://localhost:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }} (up to 60 seconds)...\"\n          $deadline = (Get-Date).AddSeconds(60)\n          $healthCheckPassed = $false\n\n          while ((Get-Date) -lt $deadline) {\n            try {\n              $response = Invoke-WebRequest -Uri \"http://localhost:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}\" -UseBasicParsing -TimeoutSec 5\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 Health check PASSED with status 200.\"\n                $healthCheckPassed = $true\n                break\n              }\n            } catch {\n              # This will catch connection refused, timeouts, etc.\n              Write-Host \"  ... waiting for service to be ready.\"\n            }\n            Start-Sleep -Seconds 2\n          }\n\n          if (-not $healthCheckPassed) {\n            Write-Error \"\u274c FATAL: Health check endpoint did not return 200 within the time limit.\"\n            exit 1\n          }\n\n      - name: '\ud83d\udcf8 The Paparazzi (Visual Proof)'\n        shell: pwsh\n        run: |\n          Write-Host \"Installing Playwright for visual verification...\"\n          python -m pip install playwright\n          python -m playwright install chromium\n\n          # Default to 8102 if SERVICE_PORT is not set\n          $port = \"${{ env.SERVICE_PORT }}\"\n          if ([string]::IsNullOrWhiteSpace($port)) { $port = \"8102\" }\n\n          Write-Host \"Taking screenshot of http://localhost:$port...\"\n          python -c \"\n          from playwright.sync_api import sync_playwright\n          import sys\n\n          try:\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  # Try index.html, fall back to root if needed\n                  url = f'http://localhost:{sys.argv[1]}/index.html'\n                  print(f'Navigating to {url}...')\n                  page.goto(url)\n                  # Wait a moment for React/Next.js hydration if needed\n                  page.wait_for_timeout(2000)\n                  page.screenshot(path='proof-of-life.png', full_page=True)\n                  browser.close()\n              print('\u2705 Screenshot captured.')\n          except Exception as e:\n              print(f'\u274c Screenshot failed: {e}')\n              # We do not fail the build for this; it is a bonus artifact.\n              sys.exit(0)\n          \" $port\n\n      - name: \ud83d\udce4 Upload Visual Proof\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: visual-proof-${{ github.run_id }}\n          path: proof-of-life.png\n          retention-days: 7\n\n      - name: \ud83d\udcca Capture Diagnostics on Failure\n        if: failure()\n        shell: pwsh\n        run: |\n          $diag = Join-Path $PWD \"installer-diag\"\n          Remove-Item $diag -Recurse -Force -ErrorAction SilentlyContinue\n          New-Item -ItemType Directory -Path $diag | Out-Null\n          Copy-Item -Path msi-install.log -Destination $diag -Force\n          Copy-Item -Path \"C:\\ProgramData\\Fortuna\\logs\\*.log\" -Destination $diag -Force -ErrorAction SilentlyContinue\n          Copy-Item -Path \"C:\\Program Files\\Fortuna Faucet\\*\" -Destination $diag -Recurse -Force -ErrorAction SilentlyContinue\n\n      - name: \ud83d\udce4 Upload Diagnostics\n        if: failure()\n        uses: actions/upload-artifact@v4\n        with:\n          name: jules-smoke-test-failure-${{ github.run_id }}\n          path: installer-diag\n          retention-days: 30\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        shell: pwsh\n        run: |\n          Write-Host \"Cleaning up...\"\n          Stop-Service -Name \"FortunaWebService\" -Force -ErrorAction SilentlyContinue\n          # Uninstall may not always work, especially if the service is stuck, but we try.\n          $msiPath = \"${{ steps.find_msi.outputs.msi_path }}\"\n          if (Test-Path $msiPath) {\n            Start-Process msiexec.exe -ArgumentList \"/x `\"$msiPath`\" /qn\" -Wait\n          }\n          Get-Process -Name \"fortuna-webservice\" -ErrorAction SilentlyContinue | Stop-Process -Force\n          Write-Host \"\u2705 Cleanup complete.\"\n\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [path-finder, repo-preflight, build-backend]\n    env:\n      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: Stage Artifacts\n        id: stage\n        run: |\n          Set-StrictMode -Version Latest\n          $staging = \"${{ env.MSI_STAGING_DIR }}\"\n          New-Item -ItemType Directory -Path $staging -Force | Out-Null\n          # Rename the executable to match the service name defined in the WiX project\n          Move-Item -Path \"dist/fortuna-backend.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n          $msiName = \"Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi\".Replace('/', '-')\n          \"msi_name=$msiName\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\u2705 Staged for MSI: $msiName\"\n\n      - name: Create Restart Service Batch Script\n        shell: pwsh\n        run: |\n          $scriptContent = @\"\n          @echo off\n          echo Requesting Admin privileges to restart FortunaWebService...\n          net stop FortunaWebService\n          net start FortunaWebService\n          echo Service Restarted.\n          pause\n          \"@\n          Set-Content -Path \"${{ env.MSI_STAGING_DIR }}/restart_service.bat\" -Value $scriptContent -Encoding Ascii\n          Write-Host \"\u2705 Created restart_service.bat script.\"\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: Cache NuGet\n        uses: actions/cache@v4\n        with:\n          path: ~/.nuget/packages\n          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}\n\n      - name: \ud83d\udcc4 Ensure WiX License Exists\n        run: |\n          if (-not (Test-Path build_wix)) { New-Item -ItemType Directory -Path build_wix | Out-Null }\n          $licensePath = 'build_wix/license.rtf'\n          if (-not (Test-Path $licensePath)) {\n            Write-Host '\u26a0\ufe0f License file missing. Generating placeholder...'\n            $rtfContent = '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\f0\\fs24 END USER LICENSE AGREEMENT\\par\\par This is a placeholder license for Fortuna Faucet. Please replace with actual terms.}'\n            Set-Content -Path $licensePath -Value $rtfContent -Encoding Ascii\n            Write-Host '\u2705 Placeholder license.rtf created.'\n          } else {\n            Write-Host '\u2705 Existing license.rtf found.'\n          }\n      - name: Prepare WiX Project\n        run: |\n          Set-StrictMode -Version Latest\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n\n          $proj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">',\n            '  <PropertyGroup>',\n            '    <EnableDefaultCompileItems>false</EnableDefaultCompileItems>',\n            '    <OutputType>Package</OutputType>',\n            '    <Platforms>x64</Platforms>',\n            '    <DefineConstants>Version=$(Version);SourceDir=$(SourceDir);ServicePort=$(ServicePort)</DefineConstants>',\n            '  </PropertyGroup>',\n            '  <ItemGroup>',\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />',\n            '  </ItemGroup>',\n            '  <ItemGroup>',\n            '    <Compile Include=\"Product.wxs\" />',\n            '  </ItemGroup>',\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value ($proj -join \"`r`n\") -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: |\n          Set-StrictMode -Version Latest\n          dotnet build Fortuna.wixproj -c Release `\n            -p:Platform=x64 `\n            -p:SourceDir=\"../${{ env.MSI_STAGING_DIR }}\" `\n            -p:Version=\"${{ env.BUILD_VERSION }}\" `\n            -p:ServicePort=\"${{ env.SERVICE_PORT }}\"\n          $msiFile = \"bin/x64/Release/${{ steps.stage.outputs.msi_name }}\"\n          if (-not (Test-Path $msiFile)) { throw \"MSI not created\" }\n          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash\n          $hash | Out-File \"$msiFile.sha256\" -Encoding utf8\n          Write-Host \"\u2705 MSI Built: $hash\"\n\n      - name: '\ud83d\udc24 The Canary (Malware Pre-Flight)'\n        shell: pwsh\n        continue-on-error: true\n        run: |\n          $msi = Get-ChildItem -Recurse -Filter \"*.msi\" | Select-Object -First 1\n          if (!$msi) { Write-Warning \"No MSI found to scan.\"; exit 0 }\n\n          Write-Host \"\ud83d\udd0d Scanning $($msi.Name) with Windows Defender...\"\n          $defender = \"C:\\Program Files\\Windows Defender\\MpCmdRun.exe\"\n\n          if (-not (Test-Path $defender)) {\n              Write-Warning \"Windows Defender CLI not found at expected path.\"\n              exit 0\n          }\n\n          # ScanType 3 = File/Custom Scan\n          $proc = Start-Process -FilePath $defender -ArgumentList \"-Scan -ScanType 3 -File `\"$($msi.FullName)`\"\" -Wait -PassThru -NoNewWindow\n\n          if ($proc.ExitCode -eq 0) {\n              Write-Host \"\u2705 CLEAN: Windows Defender found no threats.\" -ForegroundColor Green\n          } elseif ($proc.ExitCode -eq 2) {\n              Write-Error \"\ud83d\udea8 THREAT DETECTED: Windows Defender flagged this installer!\"\n              exit 1\n          } else {\n              Write-Warning \"\u26a0\ufe0f Scan completed with inconclusive exit code: $($proc.ExitCode)\"\n          }\n\n      - name: Upload MSI + Hash\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: ${{ env.WIX_DIR }}/bin/x64/Release/*\n          retention-days: 10\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    needs: package-msi-service\n    permissions:\n      contents: write\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          pattern: fortuna-service-msi-*\n          merge-multiple: true\n          path: assets\n\n      - name: Download SBOM\n        uses: actions/download-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: assets\n\n      - name: Generate Checksums\n        run: |\n          cd assets\n          ls *.msi\n          sha256sum *.msi > SHASUMS256.txt\n\n      - name: Publish Release\n        uses: softprops/action-gh-release@v2\n        with:\n          files: |\n            assets/*.msi\n            assets/*.sha256\n            assets/SHASUMS256.txt\n            assets/sbom.spdx.json\n          generate_release_notes: true\n\n  stage-release-artifacts:\n    name: '\ud83d\udce6 Stage Release Artifacts'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    needs: [package-msi-service, repo-preflight]\n    steps:\n      - name: \ud83d\udce5 Download MSI Installer\n        uses: actions/download-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: msi-installer\n      - name: \ud83d\ude9a Stage Final Artifact\n        shell: pwsh\n        run: |\n          Set-StrictMode -Version Latest\n          $sourceDir = \"msi-installer\"\n          $destDir = \"final-release-artifact\"\n          New-Item -ItemType Directory -Path $destDir -Force | Out-Null\n\n          robocopy $sourceDir $destDir /E\n\n          if ($LASTEXITCODE -ge 8) {\n            Write-Error \"Robocopy failed with exit code $LASTEXITCODE. This indicates a serious error.\"\n            exit 1\n          }\n\n          Write-Host \"\u2705 Robocopy completed successfully.\"\n          Get-ChildItem -Path $destDir | Write-Host\n          exit 0\n\n      - name: \ud83d\udce4 Upload Final MSI Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: Final-MSI-Artifact\n          path: final-release-artifact/\n          retention-days: 90\n"
  },
  ".github/workflows/build-web-service-msi.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-web-service-msi.ymlx",
    "content": "name: Build Fortuna Web Service MSI (Master)\n\non:\n  push:\n    branches:\n      - main\n    tags:\n      - 'v*'\n  workflow_dispatch:\n\npermissions:\n  contents: read\n  actions: read\n  checks: read\n\nconcurrency:\n  group: ${{ github.workflow }}-${{ github.ref }}\n  cancel-in-progress: true\n\ndefaults:\n  run:\n    shell: pwsh\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  DOTNET_VERSION: '8.0.x'\n  PYTHONUTF8: '1'\n  PIP_DISABLE_PIP_VERSION_CHECK: '1'\n  PIP_NO_PYTHON_VERSION_WARNING: '1'\n  NPM_CONFIG_FUND: 'false'\n  NPM_CONFIG_AUDIT: 'false'\n  FORCE_COLOR: '3'\n  FRONTEND_DIR: 'web_service/frontend'\n  FRONTEND_BUILD_DIR: 'web_service/frontend/out'\n  BACKEND_DIR: 'web_service/backend'\n  WIX_DIR: 'build_wix'\n  BACKEND_SPEC: 'fortuna-backend-webservice.spec'\n  SERVICE_PORT: '8102'\n  HEALTH_ENDPOINT: '/health'\n  API_KEY: 'a_secure_test_api_key_that_is_long_enough_for_smoke_test'\n  MSI_STAGING_DIR: 'build_wix/staging'\n  MSI_OUTPUT_DIR: 'dist'\n  WIX_VERSION: '4.0.5'\n\njobs:\n  system-check:\n    name: '\u2699\ufe0f System Prerequisites'\n    runs-on: windows-latest\n    timeout-minutes: 5\n    outputs:\n      disk_free_gb: ${{ steps.system.outputs.disk_gb }}\n    steps:\n      - name: Verify Build Tools\n        run: |\n          Set-StrictMode -Version Latest\n          $tools = @('dotnet', 'python', 'node', 'npm', 'git')\n          foreach ($tool in $tools) {\n            Write-Host \"Checking for $($tool)...\"\n            Get-Command $tool -ErrorAction SilentlyContinue\n            if (-not $?) {\n              Write-Host \"\u274c FATAL: Build tool '$tool' not found in PATH.\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical build tools are present.\" -ForegroundColor Green\n      - name: Check Disk Space\n        id: system\n        run: |\n          Set-StrictMode -Version Latest\n          $disk = Get-Volume | Where-Object { $_.DriveLetter -eq 'C' }\n          $freeGB = [math]::Round($disk.SizeRemaining / 1GB, 2)\n          if ($freeGB -lt 10) {\n            Write-Host \"\u26a0\ufe0f WARNING: Low disk space. Only $freeGB GB free (10+ GB recommended).\" -ForegroundColor Yellow\n          } else {\n            Write-Host \"\u2705 Disk space check passed ($freeGB GB free).\" -ForegroundColor Green\n          }\n          \"disk_gb=$freeGB\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n  repo-preflight:\n    name: '\ud83e\uddea Repo Preflight & Integrity'\n    runs-on: windows-latest\n    needs: system-check\n    timeout-minutes: 5\n    outputs:\n      frontend_lock_hash: ${{ steps.hashes.outputs.frontend_lock_hash }}\n      backend_requirements_hash: ${{ steps.hashes.outputs.backend_requirements_hash }}\n      wix_definition_hash: ${{ steps.hashes.outputs.wix_definition_hash }}\n      semver: ${{ steps.meta.outputs.semver }}\n      short_sha: ${{ steps.meta.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n\n      - name: Derive Build Metadata\n        id: meta\n        run: |\n          Set-StrictMode -Version Latest\n          $ref = \"${{ github.ref }}\"\n          if ($ref -like 'refs/tags/v*') {\n            $semver = $ref -replace 'refs/tags/v', ''\n          } else {\n            $semver = \"0.0.${{ github.run_number }}\"\n          }\n          $shortSha = \"${{ github.sha }}\".Substring(0,7)\n          \"semver=$semver\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"short_sha=$shortSha\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\ud83d\udd16 Version: $semver ($shortSha)\"\n\n      - name: Validate Critical Files Exist\n        run: |\n          Set-StrictMode -Version Latest\n          $paths = @(\n            \"${{ env.FRONTEND_DIR }}/package.json\",\n            \"${{ env.FRONTEND_DIR }}/package-lock.json\",\n            \"${{ env.BACKEND_DIR }}/requirements.txt\",\n            \"${{ env.BACKEND_DIR }}/main.py\",\n            \"${{ env.BACKEND_SPEC }}\",\n            \"${{ env.WIX_DIR }}/Product_WithService.wxs\"\n          )\n          foreach ($path in $paths) {\n            if (-not (Test-Path $path)) {\n              Write-Host \"\u274c FATAL: Required path missing: $path\" -ForegroundColor Red\n              exit 1\n            }\n          }\n          Write-Host \"\u2705 All critical files confirmed.\"\n\n      - name: Capture Integrity Hashes\n        id: hashes\n        run: |\n          Set-StrictMode -Version Latest\n          $frontend = (Get-FileHash \"${{ env.FRONTEND_DIR }}/package-lock.json\" -Algorithm SHA256).Hash\n          $backend = (Get-FileHash \"${{ env.BACKEND_DIR }}/requirements.txt\" -Algorithm SHA256).Hash\n          $wix = (Get-FileHash \"${{ env.WIX_DIR }}/Product_WithService.wxs\" -Algorithm SHA256).Hash\n          \"frontend_lock_hash=$frontend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"backend_requirements_hash=$backend\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          \"wix_definition_hash=$wix\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n\n      - name: Upload Integrity Snapshot\n        uses: actions/upload-artifact@v4\n        with:\n          name: repo-preflight-${{ github.run_id }}\n          path: |\n            ${{ env.FRONTEND_DIR }}/package-lock.json\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.WIX_DIR }}/Product_WithService.wxs\n          retention-days: 3\n\n  frontend-quality:\n    name: '\ud83e\uddfc Frontend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 15\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Run Lint (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'lint') {\n            Write-Host \"\ud83e\uddf9 Running npm run lint\"\n            npm run lint\n          } else {\n            Write-Host \"\u2139\ufe0f No lint script defined, skipping.\"\n          }\n\n      - name: Run Tests (if defined)\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          $pkg = Get-Content package.json -Raw | ConvertFrom-Json\n          if ($pkg.scripts.PSObject.Properties.Name -contains 'test') {\n            Write-Host \"\ud83e\uddea Running npm test -- --watch=false\"\n            npm test -- --watch=false\n          } else {\n            Write-Host \"\u2139\ufe0f No test script defined, skipping.\"\n          }\n\n      - name: Security Audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm audit --audit-level=critical\n\n  backend-quality:\n    name: '\ud83e\uddef Backend Quality Gates'\n    runs-on: ubuntu-latest\n    timeout-minutes: 20\n    needs: repo-preflight\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r \"${{ env.BACKEND_DIR }}/requirements.txt\"\n          if (Test-Path \"${{ env.BACKEND_DIR }}/requirements-dev.txt\") {\n            pip install -r \"${{ env.BACKEND_DIR }}/requirements-dev.txt\"\n          } else {\n            Write-Host \"\u2139\ufe0f requirements-dev.txt not found, skipping.\"\n          }\n\n      - name: Bytecode Compile (Fail Fast)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m compileall -q \"${{ env.BACKEND_DIR }}\"\n\n      - name: Run Pytest (if available)\n        run: |\n          Set-StrictMode -Version Latest\n          python -c 'import importlib.util, sys; sys.exit(0 if importlib.util.find_spec(\"pytest\") else 1)'\n          if ($LASTEXITCODE -eq 0) {\n            Write-Host \"\ud83e\uddea pytest detected, running suite...\"\n            python -m pytest \"${{ env.BACKEND_DIR }}\" --maxfail=1 --disable-warnings\n          } else {\n            Write-Host \"\u2139\ufe0f pytest not installed; skipping tests.\"\n          }\n\n      - name: pip-audit (non-blocking)\n        continue-on-error: true\n        run: |\n          Set-StrictMode -Version Latest\n          pip install pip-audit\n          pip-audit -r ${{ env.BACKEND_DIR }}/requirements.txt\n\n  sbom:\n    name: '\ud83d\udcc4 SBOM Snapshot'\n    runs-on: ubuntu-latest\n    timeout-minutes: 10\n    needs: repo-preflight\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Generate SBOM (SPDX)\n        uses: anchore/sbom-action@v0\n        with:\n          output-file: sbom.spdx.json\n          format: spdx-json\n\n      - name: Upload SBOM\n        uses: actions/upload-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: sbom.spdx.json\n          retention-days: 7\n\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend'\n    runs-on: windows-latest\n    timeout-minutes: 20\n    needs: [repo-preflight, frontend-quality]\n    env:\n      FRONTEND_LOCK_HASH: ${{ needs.repo-preflight.outputs.frontend_lock_hash }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: '${{ env.FRONTEND_DIR }}/package-lock.json'\n\n      - name: Prime npm Cache\n        uses: actions/cache@v4\n        with:\n          path: ~\\AppData\\Local\\npm-cache\n          key: ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-${{ env.FRONTEND_LOCK_HASH }}\n          restore-keys: |\n            ${{ runner.os }}-npm-${{ env.NODE_VERSION }}-\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm ci --prefer-offline --no-audit --no-fund\n\n      - name: Build Frontend\n        run: |\n          Set-StrictMode -Version Latest\n          cd \"${{ env.FRONTEND_DIR }}\"\n          npm run build\n\n      - name: Verify Build Output\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          if (-not (Test-Path $outDir)) {\n             Write-Host \"\u274c FATAL: Build directory not found\" -ForegroundColor Red\n             exit 1\n          }\n          $files = Get-ChildItem -Path $outDir -Recurse -File\n          if ($files.Count -eq 0) {\n             Write-Host \"\u274c FATAL: Build directory empty\" -ForegroundColor Red\n             exit 1\n          }\n          Write-Host \"\u2705 Frontend built: $($files.Count) files.\"\n\n      - name: Generate Artifact Manifest\n        run: |\n          Set-StrictMode -Version Latest\n          $outDir = Resolve-Path \"${{ env.FRONTEND_BUILD_DIR }}\"\n          $manifestPath = \"frontend-manifest.tsv\"\n          \"RelativePath`tSizeBytes`tSHA256\" | Out-File $manifestPath -Encoding utf8\n          Get-ChildItem -Path $outDir -Recurse -File | ForEach-Object {\n            $relative = $_.FullName.Substring($outDir.Path.Length).TrimStart('\\','/')\n            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash\n            \"$relative`t$($_.Length)`t$hash\" | Out-File $manifestPath -Encoding utf8 -Append\n          }\n\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: ${{ env.FRONTEND_BUILD_DIR }}\n          retention-days: 3\n\n      - name: Upload Manifest\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-manifest-${{ github.run_id }}\n          path: frontend-manifest.tsv\n          retention-days: 3\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [repo-preflight, build-frontend, backend-quality]\n    env:\n      BACKEND_REQUIREMENTS_HASH: ${{ needs.repo-preflight.outputs.backend_requirements_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-${{ github.run_id }}\n          path: temp-frontend\n\n      - name: Stage Frontend for PyInstaller\n        run: |\n          Set-StrictMode -Version Latest\n          $dest = \"staging/ui\"\n          New-Item -ItemType Directory -Path $dest -Force | Out-Null\n          Copy-Item -Path \"temp-frontend/*\" -Destination $dest -Recurse -Force\n          Write-Host \"\u2705 Frontend staged for inclusion.\"\n\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: |\n            ${{ env.BACKEND_DIR }}/requirements.txt\n            ${{ env.BACKEND_DIR }}/requirements-dev.txt\n\n      - name: Install Dependencies\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel\n          pip install -r \"${{ env.BACKEND_DIR }}/requirements.txt\"\n          if (Test-Path \"${{ env.BACKEND_DIR }}/requirements-dev.txt\") {\n            pip install -r \"${{ env.BACKEND_DIR }}/requirements-dev.txt\"\n          }\n\n      - name: Freeze Dependency Snapshot\n        run: |\n          Set-StrictMode -Version Latest\n          pip freeze | Out-File backend-freeze.txt -Encoding utf8\n\n      - name: Create Required Backend Directories\n        run: |\n          Set-StrictMode -Version Latest\n          New-Item -ItemType Directory -Path \"${{ env.BACKEND_DIR }}/data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"${{ env.BACKEND_DIR }}/json\" -Force | Out-Null\n          Write-Host \"\u2705 Created required backend directories for PyInstaller.\" -ForegroundColor Green\n\n      - name: Build with PyInstaller\n        env:\n          FORTUNA_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n        run: |\n          Set-StrictMode -Version Latest\n          pyinstaller \"${{ env.BACKEND_SPEC }}\" --clean --log-level=WARN --noconfirm\n\n      - name: Verify Executable\n        run: |\n          Set-StrictMode -Version Latest\n          $exePath = \"dist/fortuna-backend.exe\"\n          if (-not (Test-Path $exePath)) {\n            Write-Host \"\u274c FATAL: Executable not found\" -ForegroundColor Red\n            exit 1\n          }\n          $hash = (Get-FileHash $exePath -Algorithm SHA256).Hash\n          $size = (Get-Item $exePath).Length / 1MB\n          if ($size -lt 10) {\n            Write-Host \"\u274c FATAL: Executable is suspiciously small: $($size) MB. Build may be incomplete.\" -ForegroundColor Red\n            exit 1\n          }\n          \"fortuna-backend.exe`t$hash\" | Out-File backend-sha256.tsv -Encoding utf8\n          Write-Host \"\u2705 Backend ready: $([math]::Round($size, 2)) MB ($hash)\"\n\n      - name: Upload Backend Executable\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist/fortuna-backend.exe\n          retention-days: 3\n\n      - name: Upload Backend Metadata\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-metadata-${{ github.run_id }}\n          path: |\n            backend-sha256.tsv\n            backend-freeze.txt\n          retention-days: 7\n\n  diagnose-asgi-imports:\n    name: '\ud83d\udd0d ASGI Import Killer (Pre-Smoke Diagnostic)'\n    runs-on: windows-latest\n    timeout-minutes: 15\n    needs: build-backend\n    steps:\n      - name: \ud83d\udce5 Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 1\n\n      - name: \u2699\ufe0f Setup Python (EXACT VERSION)\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n\n      - name: \ud83d\udccb Capture Python Info\n        run: |\n          Set-StrictMode -Version Latest\n          Write-Host \"Python executable: $(which python)\" -ForegroundColor Cyan\n          python --version\n          python -m site\n          python -c \"import sys; print('Prefix:', sys.prefix); print('Base prefix:', sys.base_prefix)\"\n\n      - name: \ud83d\udce5 Install Requirements (Exactly as Backend Build)\n        run: |\n          Set-StrictMode -Version Latest\n          python -m pip install --upgrade pip setuptools wheel --quiet\n\n          Write-Host \"Installing requirements.txt...\" -ForegroundColor Cyan\n          pip install -r \"${{ env.BACKEND_DIR }}/requirements.txt\" -v 2>&1 | Tee-Object \"install-requirements.log\"\n\n          if (Test-Path \"${{ env.BACKEND_DIR }}/requirements-dev.txt\") {\n            Write-Host \"Installing requirements-dev.txt...\" -ForegroundColor Cyan\n            pip install -r \"${{ env.BACKEND_DIR }}/requirements-dev.txt\" -v 2>&1 | Tee-Object -Append \"install-requirements.log\"\n          }\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u274c pip install failed\" -ForegroundColor Red\n            exit 1\n          }\n\n          Write-Host \"\u2705 All dependencies installed\" -ForegroundColor Green\n\n      - name: \ud83d\udce6 Capture Installed Packages\n        run: |\n          pip list | Tee-Object \"installed-packages.txt\"\n          pip freeze | Tee-Object \"pip-freeze.txt\"\n\n      - name: \ud83e\uddea PHASE 1 System Imports\n        run: |\n          python -c @'\n          import sys\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 1 SYSTEM-LEVEL IMPORTS\")\n          print(\"=\"*80)\n\n          modules = [\n              ('os', 'filesystem'),\n              ('sys', 'system'),\n              ('json', 'serialization'),\n              ('asyncio', 'async I/O'),\n              ('pathlib', 'paths'),\n              ('typing', 'type hints'),\n              ('importlib', 'import utilities'),\n          ]\n\n          failed = []\n          for mod_name, desc in modules:\n              try:\n                  __import__(mod_name)\n                  print(f\"\u2705 {mod_name:20} [{desc}]\")\n              except Exception as e:\n                  print(f\"\u274c {mod_name:20} ERROR: {e}\")\n                  failed.append((mod_name, str(e)))\n\n          if failed:\n              print(f\"\\n\u274c CRITICAL: {len(failed)} system imports failed\")\n              sys.exit(1)\n\n          print(f\"\\n\u2705 Phase 1 complete\")\n          '@\n\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 2 Web Framework Core\n        run: |\n          python -c @'\n          import sys\n          import traceback\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 2 WEB FRAMEWORK CORE\")\n          print(\"=\"*80)\n\n          modules = [\n              ('fastapi', 'web framework'),\n              ('uvicorn', 'ASGI server'),\n              ('starlette', 'ASGI toolkit'),\n              ('starlette.applications', 'ASGI app'),\n              ('starlette.routing', 'routing'),\n          ]\n\n          failed = []\n          for mod_name, desc in modules:\n              try:\n                  __import__(mod_name)\n                  print(f\"\u2705 {mod_name:30} [{desc}]\")\n              except ImportError as e:\n                  print(f\"\u274c {mod_name:30} ImportError: {e}\")\n                  failed.append((mod_name, str(e)))\n              except Exception as e:\n                  print(f\"\u26a0\ufe0f  {mod_name:30} {type(e).__name__}: {e}\")\n\n          if failed:\n              print(f\"\\n\u274c {len(failed)} core framework imports failed\")\n              for mod, err in failed:\n                  print(f\"  - {mod}\")\n              sys.exit(1)\n\n          print(f\"\\n\u2705 Phase 2 complete\")\n          '@\n\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 3 Pydantic & Data Validation\n        run: |\n          python -c @'\n          import sys\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 3 PYDANTIC & DATA VALIDATION\")\n          print(\"=\"*80)\n\n          modules = [\n              ('pydantic', 'validation'),\n              ('pydantic_core', 'core'),\n              ('pydantic_settings', 'settings'),\n          ]\n\n          for mod_name, desc in modules:\n              try:\n                  __import__(mod_name)\n                  print(f\"\u2705 {mod_name:30} [{desc}]\")\n              except Exception as e:\n                  print(f\"\u274c {mod_name:30} {type(e).__name__}: {e}\")\n                  sys.exit(1)\n\n          print(f\"\\n\u2705 Phase 3 complete\")\n          '@\n\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 4 Async/IO Utilities\n        run: |\n          python -c @'\n          import sys\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 4 ASYNC/IO UTILITIES\")\n          print(\"=\"*80)\n\n          modules = [\n              ('anyio', 'async compat'),\n              ('httpcore', 'HTTP core'),\n              ('httpx', 'HTTP client'),\n              ('aiosqlite', 'async DB'),\n          ]\n\n          for mod_name, desc in modules:\n              try:\n                  __import__(mod_name)\n                  print(f\"\u2705 {mod_name:30} [{desc}]\")\n              except Exception as e:\n                  print(f\"\u274c {mod_name:30} {type(e).__name__}: {e}\")\n                  sys.exit(1)\n\n          print(f\"\\n\u2705 Phase 4 complete\")\n          '@\n\n          if ($LASTEXITCODE -ne 0) { exit 1 }\n\n      - name: \ud83e\uddea PHASE 5 Optional Dependencies (non-critical)\n        continue-on-error: true\n        run: |\n          python -c @'\n          import sys\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 5 OPTIONAL DEPENDENCIES (non-critical)\")\n          print(\"=\"*80)\n\n          modules = [\n              ('slowapi', 'rate limiting'),\n              ('structlog', 'logging'),\n              ('tenacity', 'retries'),\n          ]\n\n          for mod_name, desc in modules:\n              try:\n                  __import__(mod_name)\n                  print(f\"\u2705 {mod_name:30} [{desc}]\")\n              except Exception as e:\n                  print(f\"\u26a0\ufe0f  {mod_name:30} not critical: {type(e).__name__}\")\n\n          print(f\"\\n\u2705 Phase 5 complete (warnings OK)\")\n          '@\n\n      - name: \ud83e\uddea PHASE 6 Application Directory Structure\n        run: |\n          Set-StrictMode -Version Latest\n\n          python -c @'\n          import os\n          from pathlib import Path\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 6 APPLICATION DIRECTORY STRUCTURE\")\n          print(\"=\"*80)\n\n          cwd = Path.cwd()\n          web_service = cwd / \"web_service\"\n          backend = web_service / \"backend\"\n\n          print(f\"\\nCurrent directory: {cwd}\")\n          print(f\"\\nweb_service exists: {web_service.exists()}\")\n          if web_service.exists():\n              print(f\"  Contents:\")\n              for item in web_service.iterdir():\n                  print(f\"    - {item.name}\")\n\n          print(f\"\\nweb_service/backend exists: {backend.exists()}\")\n          if backend.exists():\n              print(f\"  Contents:\")\n              for item in backend.iterdir():\n                  print(f\"    - {item.name}\")\n\n              main_py = backend / \"main.py\"\n              api_py = backend / \"api.py\"\n\n              print(f\"\\n  main.py: {main_py.exists()} ({main_py.stat().st_size if main_py.exists() else 'N/A'} bytes)\")\n              print(f\"  api.py: {api_py.exists()} ({api_py.stat().st_size if api_py.exists() else 'N/A'} bytes)\")\n          '@\n\n      - name: \ud83e\uddea PHASE 7 CRITICAL - Application Module Imports\n        run: |\n          python -c @'\n          import sys\n          import traceback\n          from pathlib import Path\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"PHASE 7 APPLICATION MODULE IMPORTS (CRITICAL)\")\n          print(\"=\"*80)\n\n          # Step 1: web_service\n          print(\"\\n[Step 1] Importing web_service...\")\n          try:\n              import web_service\n              print(f\"\u2705 web_service imported\")\n              print(f\"   Location: {web_service.__file__}\")\n          except Exception as e:\n              print(f\"\u274c FATAL: web_service import failed\")\n              print(f\"   Error: {type(e).__name__}: {e}\")\n              traceback.print_exc()\n              sys.exit(1)\n\n          # Step 2: web_service.backend\n          print(\"\\n[Step 2] Importing web_service.backend...\")\n          try:\n              import web_service.backend\n              print(f\"\u2705 web_service.backend imported\")\n              print(f\"   Location: {web_service.backend.__file__}\")\n          except Exception as e:\n              print(f\"\u274c FATAL: web_service.backend import failed\")\n              print(f\"   Error: {type(e).__name__}: {e}\")\n              traceback.print_exc()\n              sys.exit(1)\n\n          # Step 3: web_service.backend.api (THE CRITICAL ONE)\n          print(\"\\n[Step 3] Importing web_service.backend.api (CRITICAL)...\")\n          try:\n              import web_service.backend.api\n              print(f\"\u2705 web_service.backend.api imported\")\n              print(f\"   Location: {web_service.backend.api.__file__}\")\n          except Exception as e:\n              print(f\"\\n\u274c FATAL: web_service.backend.api import failed\")\n              print(f\"   This is why uvicorn fails with:\")\n              print(f\"   'Error loading ASGI app. Could not import module web_service.backend.api'\")\n              print(f\"\\n   Error details:\")\n              print(f\"   {type(e).__name__}: {e}\")\n              print(f\"\\n   Full traceback:\")\n              traceback.print_exc()\n              sys.exit(1)\n\n          # Step 4: main.py\n          print(\"\\n[Step 4] Importing web_service.backend.main...\")\n          try:\n              import web_service.backend.main\n              print(f\"\u2705 web_service.backend.main imported\")\n              print(f\"   Location: {web_service.backend.main.__file__}\")\n          except Exception as e:\n              print(f\"\u274c FATAL: web_service.backend.main import failed\")\n              print(f\"   Error: {type(e).__name__}: {e}\")\n              traceback.print_exc()\n              sys.exit(1)\n\n          # Step 5: Get app object\n          print(\"\\n[Step 2] Retrieving 'app' object from main...\")\n          try:\n              from web_service.backend.main import app\n              print(f\"\u2705 app object retrieved\")\n              print(f\"   Type: {type(app)}\")\n              print(f\"   Class: {app.__class__.__name__}\")\n              print(f\"   Module: {app.__class__.__module__}\")\n          except Exception as e:\n              print(f\"\u274c FATAL: Could not get app object\")\n              print(f\"   Error: {type(e).__name__}: {e}\")\n              traceback.print_exc()\n              sys.exit(1)\n\n          print(\"\\n\" + \"=\"*80)\n          print(\"\u2705 ALL APPLICATION IMPORTS SUCCESSFUL\")\n          print(\"=\"*80)\n          print(\"\\nThe ASGI app is fully importable.\")\n          print(\"Uvicorn should be able to load it successfully.\")\n          '@\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u274c APPLICATION IMPORT TEST FAILED\" -ForegroundColor Red\n            exit 1\n          }\n\n      - name: \ud83d\udccb Generate ASGI Diagnostic Report\n        if: always()\n        run: |\n          Set-StrictMode -Version Latest\n          $report = @()\n          $report += \"\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\"\n          $report += \"\u2551              ASGI IMPORT KILLER - DIAGNOSTIC REPORT                        \u2551\"\n          $report += \"\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\"\n          $report += \"\"\n          $report += \"Timestamp: $(Get-Date -Format 'o')\"\n          $report += \"Python: $(python --version)\"\n          $report += \"\"\n          $report += \"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\"\n          $result = if ($LASTEXITCODE -eq 0) { 'PASS \u2705' } else { 'FAIL \u274c' }\n          $report += \"\u2502 RESULT: $result \u2502\"\n          $report += \"\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\"\n          $report += \"\"\n          $report += \"If this passed:\"\n          $report += \"  \u2705 All required dependencies are installed\"\n          $report += \"  \u2705 web_service.backend.api is importable\"\n          $report += \"  \u2705 FastAPI app is accessible\"\n          $report += \"  \u2705 The executable should work\"\n          $report += \"  \u2705 Uvicorn WILL be able to load the app\"\n          $report += \"\"\n          $report += \"If this failed:\"\n          $report += \"  \u274c See error output above for the exact problem\"\n          $report += \"  \u274c Fix the import error in your code\"\n          $report += \"  \u274c Common issues:\"\n          $report += \"     - Missing dependency in requirements.txt\"\n          $report += \"     - Syntax error in api.py or main.py\"\n          $report += \"     - Circular import in api.py\"\n          $report += \"     - api.py imports a module that fails\"\n          $report += \"\"\n          $report += \"\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\"\n          $report | Tee-Object \"asgi-diagnostic-report.txt\"\n\n      - name: \ud83d\udce4 Upload Diagnostic Artifacts\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: asgi-import-diagnostics-${{ github.run_id }}\n          path: |\n            install-requirements.log\n            installed-packages.txt\n            pip-freeze.txt\n            asgi-diagnostic-report.txt\n          retention-days: 30\n          if-no-files-found: warn\n\n  smoke-test:\n    name: '\ud83d\udd2c Smoke Test (Diagnostic Overkill)'\n    runs-on: windows-latest\n    timeout-minutes: 30\n    needs: [build-backend, diagnose-asgi-imports]\n    steps:\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 0: PRE-EXECUTION FORENSICS\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udce5 Download Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: \ud83c\udfd7\ufe0f Setup Directories & Capture Baseline\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create diagnostic structure\n          New-Item -ItemType Directory -Path \"service-logs\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/exe-analysis\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/runtime-trace\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/import-analysis\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"diagnostics/environment\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"data\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"json\" -Force | Out-Null\n          New-Item -ItemType Directory -Path \"logs\" -Force | Out-Null\n\n          # Baseline system state\n          Get-Process | Out-File \"diagnostics/baseline-processes.txt\"\n          Get-NetTCPConnection -ErrorAction SilentlyContinue | Out-File \"diagnostics/baseline-network.txt\"\n          [Environment]::GetEnvironmentVariables() | Out-File \"diagnostics/baseline-env.txt\"\n\n          Write-Host \"\u2705 Diagnostic directories created\" -ForegroundColor Green\n\n      - name: \ud83d\udd2c Analyze Executable (Pre-Execution)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = \"dist/fortuna-backend.exe\"\n\n          # File properties\n          $info = Get-Item $exe\n          $size = $info.Length / 1MB\n\n          @\"\n          === EXECUTABLE ANALYSIS ===\n          Path: $($info.FullName)\n          Size: $([math]::Round($size, 2)) MB\n          Created: $($info.CreationTime)\n          Modified: $($info.LastWriteTime)\n          Attributes: $($info.Attributes)\n          \"@ | Tee-Object \"diagnostics/exe-analysis/exe-properties.txt\"\n\n          # PE signature check\n          $bytes = [System.IO.File]::ReadAllBytes($exe)\n          $peSignature = \"{0:X2}{1:X2}\" -f $bytes[0], $bytes[1]\n          if ($peSignature -eq \"4D5A\") {\n            Write-Host \"\u2705 Valid PE signature: $peSignature\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c INVALID PE signature: $peSignature (expected 4D5A)\" -ForegroundColor Red\n            exit 1\n          }\n\n          # Check for embedded dependencies (more robustly)\n          $searchString = \"uvicorn\"\n          # Use Select-String instead of findstr to avoid exit code 1 issues\n          if (Select-String -Path $exe -Pattern $searchString -Quiet -SimpleMatch) {\n              Write-Host \"\u2705 Found '$searchString' reference.\"\n          } else {\n              Write-Host \"\u2139\ufe0f '$searchString' not found in binary (likely packed). Continuing...\" -ForegroundColor Gray\n          }\n\n      - name: \ud83d\udd12 Configure Firewall & Network\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create firewall rule\n          try {\n            New-NetFirewallRule `\n              -DisplayName \"FortunaSmoke\" `\n              -Direction Inbound `\n              -Action Allow `\n              -Protocol TCP `\n              -LocalPort ${{ env.SERVICE_PORT }} `\n              -ErrorAction Stop\n            Write-Host \"\u2705 Firewall rule created\" -ForegroundColor Green\n          } catch {\n            Write-Host \"\u26a0\ufe0f  Firewall rule may exist: $_\" -ForegroundColor Yellow\n          }\n\n          # Allow port in Windows Defender\n          try {\n            netsh advfirewall firewall add rule name=\"FortunaSmokeHTTP\" dir=in action=allow protocol=tcp localport=${{ env.SERVICE_PORT }} | Out-File \"diagnostics/firewall-netsh.log\"\n          } catch {\n            Write-Host \"\u26a0\ufe0f  netsh command issue (non-critical)\" -ForegroundColor Yellow\n          }\n\n          # Baseline netstat\n          netstat -ano | Out-File \"diagnostics/network-baseline.txt\"\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 1: PRE-LAUNCH PYTHON/ASGI VALIDATION\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udc0d Test PyInstaller Python Environment (Mimic Executable)\n        run: |\n          Set-StrictMode -Version Latest\n\n          # Create a test script that mimics what the executable should do\n          $testScript = @'\n          import sys\n          import os\n          import traceback\n\n          print(\"=\" * 80)\n          print(\"PRE-LAUNCH PYTHON ENVIRONMENT CHECK\")\n          print(\"=\" * 80)\n\n          # 1. System paths\n          print(\"\\n1. PYTHON ENVIRONMENT:\")\n          print(f\"   Python: {sys.executable}\")\n          print(f\"   Version: {sys.version}\")\n          print(f\"   Platform: {sys.platform}\")\n          print(f\"   Prefix: {sys.prefix}\")\n\n          # 2. Module search paths\n          print(\"\\n2. MODULE SEARCH PATHS:\")\n          for i, p in enumerate(sys.path):\n              print(f\"   [{i}] {p}\")\n\n          # 3. Critical imports (same as in PyInstaller spec)\n          critical_modules = [\n              'fastapi',\n              'uvicorn',\n              'pydantic',\n              'pydantic_core',\n              'pydantic_settings',\n              'aiosqlite',\n              'slowapi',\n              'structlog',\n              'starlette',\n              'starlette.staticfiles',\n              'anyio',\n              'httpcore',\n              'httpx',\n          ]\n\n          print(\"\\n3. CRITICAL MODULE IMPORTS:\")\n          failed = []\n          for mod in critical_modules:\n              try:\n                  __import__(mod)\n                  print(f\"   \u2705 {mod}\")\n              except ImportError as e:\n                  print(f\"   \u274c {mod}: {e}\")\n                  failed.append((mod, str(e)))\n              except Exception as e:\n                  print(f\"   \u26a0\ufe0f  {mod}: {type(e).__name__}: {e}\")\n\n          # 4. Attempt to import web_service modules\n          print(\"\\n4. APPLICATION MODULES (web_service.backend):\")\n          app_modules = [\n              'web_service',\n              'web_service.backend',\n              'web_service.backend.main',\n              'web_service.backend.api',\n          ]\n\n          for mod in app_modules:\n              try:\n                  __import__(mod)\n                  print(f\"   \u2705 {mod}\")\n              except ImportError as e:\n                  print(f\"   \u274c {mod}: {e}\")\n                  failed.append((mod, str(e)))\n                  traceback.print_exc()\n              except Exception as e:\n                  print(f\"   \u26a0\ufe0f  {mod}: {type(e).__name__}: {e}\")\n                  traceback.print_exc()\n\n          # 5. Test ASGI app instantiation\n          print(\"\\n5. ASGI APP INSTANTIATION:\")\n          try:\n              from web_service.backend.main import app\n              print(f\"   \u2705 Successfully imported app from main\")\n              print(f\"   App type: {type(app)}\")\n              print(f\"   App class: {app.__class__.__name__}\")\n          except ImportError as e:\n              print(f\"   \u274c Failed to import app: {e}\")\n              traceback.print_exc()\n              failed.append((\"main.app\", str(e)))\n          except Exception as e:\n              print(f\"   \u26a0\ufe0f  {type(e).__name__}: {e}\")\n              traceback.print_exc()\n\n          # Summary\n          print(\"\\n\" + \"=\" * 80)\n          if failed:\n              print(f\"FAILURES: {len(failed)} module(s) failed\")\n              for mod, err in failed:\n                  print(f\"  - {mod}\")\n                  print(f\"    {err[:100]}\")\n              sys.exit(1)\n          else:\n              print(\"\u2705 ALL CHECKS PASSED\")\n              sys.exit(0)\n          '@\n\n          $testScript | Out-File \"diagnostics/import-analysis/pre-launch-test.py\" -Encoding utf8\n\n          python \"diagnostics/import-analysis/pre-launch-test.py\" 2>&1 | Tee-Object \"diagnostics/import-analysis/pre-launch-output.txt\"\n\n          if ($LASTEXITCODE -ne 0) {\n            Write-Host \"\u26a0\ufe0f  Pre-launch Python check failed (but executable may still work)\" -ForegroundColor Yellow\n          }\n\n      - name: \ud83d\udd0d Inspect Executable Contents (Strings Dump)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = \"dist/fortuna-backend.exe\"\n\n          # Extract strings from executable (look for module names, ports, etc.)\n          # Note: This requires PowerShell Get-Content binary reading\n          $content = [System.IO.File]::ReadAllBytes($exe)\n          $text = [System.Text.Encoding]::ASCII.GetString($content)\n\n          # Extract readable strings\n          $strings = [regex]::Matches($text, '[A-Za-z0-9_.\\-/]+') | ForEach-Object { $_.Value } | Sort-Object -Unique\n\n          # Filter for interesting ones\n          $interestingStrings = $strings | Where-Object {\n            $_ -match '(uvicorn|fastapi|web_service|backend|main|api|asgi|starlette)' -or\n            $_.Length -gt 20 -and $_ -match '(\\.py|\\.so|\\.dll|Protocol|http)'\n          }\n\n          Write-Host \"Found $($interestingStrings.Count) interesting strings in executable\" -ForegroundColor Cyan\n          $interestingStrings | Out-File \"diagnostics/exe-analysis/interesting-strings.txt\"\n          $interestingStrings | Out-Host\n\n      - name: \ud83d\udcca Capture Environment for Service Launch\n        run: |\n          Set-StrictMode -Version Latest\n\n          $env | Out-File \"diagnostics/environment/launch-environment.txt\"\n\n          $envVars = @{\n            'API_KEY' = $env:API_KEY\n            'FORTUNA_PORT' = $env:FORTUNA_PORT\n            'FORTUNA_ENV' = $env:FORTUNA_ENV\n            'PYTHONPATH' = $env:PYTHONPATH\n            'PATH' = $env:PATH\n            'TEMP' = $env:TEMP\n            'TMP' = $env:TMP\n          }\n\n          @\"\n          === SERVICE LAUNCH ENVIRONMENT ===\n          API_KEY: $($envVars['API_KEY'] ? '***SET***' : 'NOT SET')\n          FORTUNA_PORT: $($envVars['FORTUNA_PORT'])\n          FORTUNA_ENV: $($envVars['FORTUNA_ENV'])\n          PYTHONPATH: $($envVars['PYTHONPATH'])\n          TEMP: $($envVars['TEMP'])\n\n          Full environment:\n          \"@ | Out-File \"diagnostics/environment/service-environment.txt\"\n\n          $envVars.GetEnumerator() | ForEach-Object {\n            \"$($_.Key)=$($_.Value)\" | Out-File -Append \"diagnostics/environment/service-environment.txt\"\n          }\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 2: SERVICE LAUNCH WITH OBSESSIVE TRACING\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\ude80 Start Service with Full Output Capture\n        run: |\n          Set-StrictMode -Version Latest\n\n          $exe = Resolve-Path \"dist/fortuna-backend.exe\"\n          $outLog = \"service-logs/stdout.txt\"\n          $errLog = \"service-logs/stderr.txt\"\n\n          Write-Host \"Starting service...\" -ForegroundColor Cyan\n          Write-Host \"Executable: $exe\" -ForegroundColor Cyan\n          Write-Host \"Port: ${{ env.SERVICE_PORT }}\" -ForegroundColor Cyan\n          Write-Host \"API_KEY: ***\" -ForegroundColor Cyan\n\n          # Set environment for subprocess\n          $env:API_KEY = \"${{ env.API_KEY }}\"\n          $env:FORTUNA_PORT = \"${{ env.SERVICE_PORT }}\"\n          $env:FORTUNA_ENV = \"smoke-test\"\n          $env:PYTHONUNBUFFERED = \"1\"  # Force unbuffered output\n\n          # Start process with full I/O redirection\n          $proc = Start-Process `\n            -FilePath $exe `\n            -PassThru `\n            -RedirectStandardOutput $outLog `\n            -RedirectStandardError $errLog `\n            -NoNewWindow\n\n          $pid = $proc.Id\n          Write-Host \"\u2705 Service process started with PID: $pid\" -ForegroundColor Green\n          $pid | Out-File \"service.pid\" -Encoding ascii\n\n          # Don't wait - proceed to health check\n          Start-Sleep -Seconds 5\n\n          # Check if process is still alive\n          if (Get-Process -Id $pid -ErrorAction SilentlyContinue) {\n            Write-Host \"\u2705 Process still alive after 5 seconds\" -ForegroundColor Green\n          } else {\n            Write-Host \"\u274c FATAL: Process died immediately\" -ForegroundColor Red\n            Write-Host \"=== STDOUT ===\" -ForegroundColor Red\n            Get-Content $outLog\n            Write-Host \"=== STDERR ===\" -ForegroundColor Red\n            Get-Content $errLog\n            exit 1\n          }\n\n      - name: \ud83d\udcca Monitor Process While Running\n        run: |\n          Set-StrictMode -Version Latest\n\n          $pid = Get-Content \"service.pid\" -Raw -ErrorAction SilentlyContinue\n          if ($pid) {\n            $proc = Get-Process -Id $pid -ErrorAction SilentlyContinue\n            if ($proc) {\n              @\"\n              === PROCESS INFO ===\n              PID: $pid\n              Name: $($proc.ProcessName)\n              Memory: $([math]::Round($proc.WorkingSet / 1MB, 2)) MB\n              CPU Time: $($proc.TotalProcessorTime)\n              Threads: $($proc.Threads.Count)\n              Handle Count: $($proc.HandleCount)\n              \"@ | Tee-Object \"diagnostics/runtime-trace/process-info.txt\"\n            }\n          }\n\n          # Network state while running\n          netstat -ano | Out-File \"diagnostics/network-running.txt\"\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 3: HEALTH CHECK WITH AGGRESSIVE RETRIES & DEBUGGING\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udc93 Health Check (Retry Loop with Diagnostics)\n        run: |\n          Set-StrictMode -Version Latest\n\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}${{ env.HEALTH_ENDPOINT }}\"\n          $maxRetries = 60  # 60 retries = 2 minutes\n          $retryInterval = 2\n          $attempt = 0\n          $success = $false\n\n          Write-Host \"Health check URL: $url\" -ForegroundColor Cyan\n          Write-Host \"Max retries: $maxRetries | Interval: $retryInterval seconds\" -ForegroundColor Cyan\n\n          $healthLog = \"diagnostics/runtime-trace/health-check.log\"\n\n          while ($attempt -lt $maxRetries -and -not $success) {\n            $attempt++\n            $elapsed = ($attempt - 1) * $retryInterval\n\n            Write-Host \"Attempt $attempt/$maxRetries (${elapsed}s elapsed)...\" -ForegroundColor Yellow\n\n            try {\n              # Attempt 1: Test-NetConnection (TCP)\n              Write-Host \"  [TCP Check]...\" -ForegroundColor Gray\n              $tcpTest = Test-NetConnection -ComputerName 127.0.0.1 -Port ${{ env.SERVICE_PORT }} -ErrorAction Stop\n              if ($tcpTest.TcpTestSucceeded) {\n                Write-Host \"  \u2705 TCP Connection successful\" -ForegroundColor Green\n                \"[$attempt] TCP connection successful\" | Out-File -Append $healthLog\n              } else {\n                Write-Host \"  \u274c TCP connection failed\" -ForegroundColor Red\n                \"[$ attempt] TCP connection failed\" | Out-File -Append $healthLog\n                throw \"TCP connection failed\"\n              }\n\n              # Attempt 2: HTTP Request\n              Write-Host \"  [HTTP GET]...\" -ForegroundColor Gray\n              $response = Invoke-WebRequest `\n                -Uri $url `\n                -UseBasicParsing `\n                -TimeoutSec 10 `\n                -ErrorAction Stop\n\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 HEALTH CHECK PASSED (HTTP $($response.StatusCode))\" -ForegroundColor Green\n                $response.Content | Out-File \"diagnostics/runtime-trace/health-response.json\"\n                $response.Content | Out-File -Append $healthLog\n                $success = $true\n                break\n              } else {\n                Write-Host \"\u26a0\ufe0f  Unexpected status: $($response.StatusCode)\" -ForegroundColor Yellow\n                \"[$attempt] Status $($response.StatusCode)\" | Out-File -Append $healthLog\n              }\n\n            } catch [System.Net.WebException] {\n              $ex = $_\n              Write-Host \"  \u274c Request failed: $($ex.Exception.Message)\" -ForegroundColor Red\n              \"[$attempt] WebException: $($ex.Exception.Message)\" | Out-File -Append $healthLog\n\n            } catch [System.Net.Sockets.SocketException] {\n              $ex = $_\n              Write-Host \"  \u274c Socket error: $($ex.Exception.Message)\" -ForegroundColor Red\n              \"[$attempt] SocketException: $($ex.Exception.Message)\" | Out-File -Append $healthLog\n\n            } catch {\n              Write-Host \"  \u274c Error: $_\" -ForegroundColor Red\n              \"$attempt] Exception: $_\" | Out-File -Append $healthLog\n            }\n\n            # Capture logs between attempts\n            $stdoutTail = Get-Content \"service-logs/stdout.txt\" -Tail 5 -ErrorAction SilentlyContinue\n            $stderrTail = Get-Content \"service-logs/stderr.txt\" -Tail 5 -ErrorAction SilentlyContinue\n\n            if ($stderrTail) {\n              Write-Host \"  [STDERR tail]:\" -ForegroundColor Gray\n              $stderrTail | ForEach-Object { Write-Host \"    $_\" -ForegroundColor Red }\n            }\n\n            if ($attempt -lt $maxRetries) {\n              Start-Sleep -Seconds $retryInterval\n            }\n          }\n\n          if (-not $success) {\n            Write-Host \"\u274c FATAL: Health check failed after $maxRetries attempts\" -ForegroundColor Red\n\n            # FULL DIAGNOSTICS ON FAILURE\n            Write-Host \"`n=== FULL DIAGNOSTIC DUMP ===\" -ForegroundColor Red\n\n            Write-Host \"`n[STDOUT - Last 50 lines]\" -ForegroundColor Cyan\n            Get-Content \"service-logs/stdout.txt\" -Tail 50\n\n            Write-Host \"`n[STDERR - Last 50 lines]\" -ForegroundColor Cyan\n            Get-Content \"service-logs/stderr.txt\" -Tail 50\n\n            Write-Host \"`n[Process Status]\" -ForegroundColor Cyan\n            $pid = Get-Content \"service.pid\" -Raw\n            Get-Process -Id $pid -ErrorAction SilentlyContinue | Format-List\n\n            Write-Host \"`n[Port Binding Check]\" -ForegroundColor Cyan\n            netstat -ano | grep -E \"127\\.0\\.0\\.1:${{ env.SERVICE_PORT }}\" 2>$null || `\n              netstat -ano | Select-String \"127.0.0.1\" | Select-String \"${{ env.SERVICE_PORT }}\"\n\n            Write-Host \"`n[Firewall Rules]\" -ForegroundColor Cyan\n            Get-NetFirewallRule -DisplayName \"*Fortuna*\" -ErrorAction SilentlyContinue | Format-List\n\n            exit 1\n          }\n\n      - name: \ud83d\udd0c Test API Endpoint\n        run: |\n          Set-StrictMode -Version Latest\n\n          $url = \"http://127.0.0.1:${{ env.SERVICE_PORT }}/api/races\"\n          $headers = @{ 'X-API-Key' = \"${{ env.API_KEY }}\" }\n\n          Write-Host \"Testing API endpoint: $url\" -ForegroundColor Cyan\n\n          try {\n            $response = Invoke-WebRequest `\n              -Uri $url `\n              -Headers $headers `\n              -UseBasicParsing `\n              -TimeoutSec 10\n\n            Write-Host \"\u2705 API Response: HTTP $($response.StatusCode)\" -ForegroundColor Green\n            Write-Host \"Response size: $($response.Content.Length) bytes\" -ForegroundColor Cyan\n            $response.Content | Out-File \"diagnostics/runtime-trace/api-response.json\"\n\n          } catch {\n            Write-Host \"\u26a0\ufe0f  API call failed (service running, but endpoint issue): $_\" -ForegroundColor Yellow\n          }\n\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      # PHASE 4: POST-EXECUTION FORENSICS\n      # \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n      - name: \ud83d\udcca Post-Test Forensics\n        if: failure()\n        run: |\n          Set-StrictMode -Version Latest\n\n          \"=== TOP PROCESSES ===\" | Out-File \"diagnostics/forensics.log\"\n          Get-Process | Sort-Object CPU -Descending | Select-Object -First 20 | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== NETWORK CONNECTIONS ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          netstat -ano | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== EVENT VIEWER (Last 20 errors) ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-EventLog -LogName System -EntryType Error -Newest 20 -ErrorAction SilentlyContinue | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== DISK SPACE ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-Volume | Out-File -Append \"diagnostics/forensics.log\"\n\n          \"=== REGISTRY (FortunaWebService) ===\" | Out-File -Append \"diagnostics/forensics.log\"\n          Get-ItemProperty -Path \"HKLM:\\Software\\FortunaWebService\" -ErrorAction SilentlyContinue | Out-File -Append \"diagnostics/forensics.log\"\n\n      - name: \ud83d\udce4 Upload All Diagnostics\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: smoke-test-diagnostics-${{ github.run_id }}\n          path: |\n            service-logs/\n            diagnostics/\n            service.pid\n          retention-days: 30\n          if-no-files-found: warn\n\n      - name: \ud83e\uddf9 Cleanup\n        if: always()\n        run: |\n          if (Test-Path 'service.pid') {\n            try {\n              $pid = Get-Content 'service.pid' -Raw\n              Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue\n              Write-Host \"\u2705 Service process terminated\" -ForegroundColor Green\n            } catch {\n              Write-Host \"\u26a0\ufe0f  Could not terminate process\" -ForegroundColor Yellow\n            }\n          }\n\n          Remove-NetFirewallRule -DisplayName \"FortunaSmoke\" -ErrorAction SilentlyContinue\n          Remove-NetFirewallRule -DisplayName \"FortunaSmokeHTTP\" -ErrorAction SilentlyContinue\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI'\n    runs-on: windows-latest\n    timeout-minutes: 25\n    needs: [repo-preflight, smoke-test]\n    env:\n      WIX_HASH: ${{ needs.repo-preflight.outputs.wix_definition_hash }}\n      BUILD_VERSION: ${{ needs.repo-preflight.outputs.semver }}\n      SHORT_SHA: ${{ needs.repo-preflight.outputs.short_sha }}\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n\n      - name: Download Backend\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-${{ github.run_id }}\n          path: dist\n\n      - name: Stage Artifacts\n        id: stage\n        run: |\n          Set-StrictMode -Version Latest\n          $staging = \"${{ env.MSI_STAGING_DIR }}\"\n          New-Item -ItemType Directory -Path $staging -Force | Out-Null\n          Move-Item -Path \"dist/fortuna-backend.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n          $msiName = \"Fortuna-WebService-${{ env.BUILD_VERSION }}-${{ env.SHORT_SHA }}.msi\".Replace('/', '-')\n          \"msi_name=$msiName\" | Out-File $env:GITHUB_OUTPUT -Encoding utf8 -Append\n          Write-Host \"\u2705 Staged for MSI: $msiName\"\n\n      - name: Setup .NET SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: ${{ env.DOTNET_VERSION }}\n\n      - name: Cache NuGet\n        uses: actions/cache@v4\n        with:\n          path: ~/.nuget/packages\n          key: ${{ runner.os }}-nuget-${{ env.WIX_HASH }}\n\n      - name: Prepare WiX Project\n        run: |\n          Set-StrictMode -Version Latest\n          Copy-Item \"${{ env.WIX_DIR }}/Product_WithService.wxs\" \"${{ env.WIX_DIR }}/Product.wxs\" -Force\n          $wixProj = @(\n            '<Project Sdk=\"WixToolset.Sdk/${{ env.WIX_VERSION }}\">'\n            '  <PropertyGroup>'\n            '    <OutputName>${{ steps.stage.outputs.msi_name }}</OutputName>'\n            '    <OutputType>Package</OutputType>'\n            '    <DefineConstants>SourceDir=staging</DefineConstants>'\n            '    <Platforms>x64</Platforms>'\n            '    <Version>${{ env.BUILD_VERSION }}</Version>'\n            '  </PropertyGroup>'\n            '  <ItemGroup>'\n            '    <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '    <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"${{ env.WIX_VERSION }}\" />'\n            '  </ItemGroup>'\n            '  <ItemGroup>'\n            '    <Compile Include=\"Product.wxs\" />'\n            '  </ItemGroup>'\n            '</Project>'\n          )\n          Set-Content \"${{ env.WIX_DIR }}/Fortuna.wixproj\" -Value $wixProj -Encoding utf8\n\n      - name: Build MSI\n        working-directory: ${{ env.WIX_DIR }}\n        run: |\n          Set-StrictMode -Version Latest\n          dotnet build Fortuna.wixproj -c Release -p:Platform=x64 -p:Version=\"${{ env.BUILD_VERSION }}\"\n          $msiFile = \"bin/x64/Release/${{ steps.stage.outputs.msi_name }}\"\n          if (-not (Test-Path $msiFile)) { throw \"MSI not created\" }\n          $hash = (Get-FileHash $msiFile -Algorithm SHA256).Hash\n          $hash | Out-File \"$msiFile.sha256\" -Encoding utf8\n          Write-Host \"\u2705 MSI Built: $hash\"\n\n      - name: Upload MSI + Hash\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-service-msi-${{ github.run_id }}\n          path: |\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.msi\n            ${{ env.WIX_DIR }}/bin/x64/Release/*.sha256\n          retention-days: 10\n\n  create-release:\n    name: '\ud83d\ude80 Create Release'\n    runs-on: ubuntu-latest\n    if: startsWith(github.ref, 'refs/tags/')\n    needs: package-msi-service\n    permissions:\n      contents: write\n    steps:\n      - name: Download MSI\n        uses: actions/download-artifact@v4\n        with:\n          pattern: fortuna-service-msi-*\n          merge-multiple: true\n          path: assets\n\n      - name: Download SBOM\n        uses: actions/download-artifact@v4\n        with:\n          name: sbom-${{ github.run_id }}\n          path: assets\n\n      - name: Generate Checksums\n        run: |\n          cd assets\n          ls *.msi\n          sha256sum *.msi > SHASUMS256.txt\n\n      - name: Publish Release\n        uses: softprops/action-gh-release@v2\n        with:\n          files: |\n            assets/*.msi\n            assets/*.sha256\n            assets/SHASUMS256.txt\n            assets/sbom.spdx.json\n          generate_release_notes: true\n"
  },
  ".github/workflows/build-webservice-as-a-service.ymlx": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/build-webservice-as-a-service.ymlx",
    "content": "name: Build Web Service as a Service MSI\n\non:\n  push:\n    branches:\n      - deactivated\n  workflow_dispatch:\n\nenv:\n  NODE_VERSION: '20'\n  PYTHON_VERSION: '3.12'\n  PYTHONUTF8: \"1\"\n\njobs:\n  build-frontend:\n    name: '\ud83d\udce6 Build Frontend (Web Service)'\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n      - name: Setup Node.js\n        uses: actions/setup-node@v4\n        with:\n          node-version: ${{ env.NODE_VERSION }}\n          cache: 'npm'\n          cache-dependency-path: 'web_service/frontend/package-lock.json'\n      - name: Frontend - Install & Build\n        shell: pwsh\n        run: |\n          cd web_service/frontend\n          npm ci\n          npm run build\n      - name: Verify Frontend Build\n        continue-on-error: true\n        shell: pwsh\n        run: |\n          $outDir = 'web_service/frontend/out'\n          if (-not (Test-Path $outDir)) { throw \"\u274c FATAL: Build output directory 'out' not created\" }\n      - name: Upload Frontend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: frontend-build-ws-service\n          path: web_service/frontend/out\n          retention-days: 1\n\n  build-backend:\n    name: '\ud83d\udc0d Build Backend (Web Service for Service)'\n    needs: [build-frontend]\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n      - name: Setup Python\n        uses: actions/setup-python@v5\n        with:\n          python-version: ${{ env.PYTHON_VERSION }}\n          cache: 'pip'\n          cache-dependency-path: 'web_service/backend/requirements.txt'\n      - name: Download Frontend Artifact\n        uses: actions/download-artifact@v4\n        with:\n          name: frontend-build-ws-service\n          path: web_service/frontend/out\n      - name: Install Python Dependencies\n        shell: pwsh\n        run: |\n          python -m pip install --upgrade pip\n          pip install -r web_service/backend/requirements-dev.txt\n      - name: Verify Frontend Files Exist Before PyInstaller\n        continue-on-error: true\n        shell: pwsh\n        run: |\n          $frontendOut = 'web_service/frontend/out'\n          if (-not (Test-Path $frontendOut)) {\n            Write-Host \"\u274c FATAL: Frontend build output missing at expected path!\" -ForegroundColor Red\n            Write-Host \"Expected: $frontendOut\" -ForegroundColor Red\n            exit 1\n          }\n          $fileCount = (Get-ChildItem -Path $frontendOut -Recurse -File | Measure-Object).Count\n          if ($fileCount -eq 0) {\n            Write-Host \"\u274c FATAL: Frontend directory exists but is empty!\" -ForegroundColor Red\n            exit 1\n          }\n          Write-Host \"\u2705 Frontend files present: $fileCount files\" -ForegroundColor Green\n\n          # Show first few files for debugging\n          Write-Host \"`nFirst 5 frontend files:\" -ForegroundColor Cyan\n          Get-ChildItem -Path $frontendOut -Recurse -File | Select-Object -First 5 | ForEach-Object {\n            Write-Host \"  - $($_.FullName)\" -ForegroundColor Gray\n          }\n      - name: Verify PyInstaller Entry Point\n        continue-on-error: true\n        shell: pwsh\n        run: |\n          $specFile = \"fortuna-webservice.spec\"\n          if (-not (Test-Path $specFile)) { throw \"\u274c FATAL: Spec file not found: $specFile\" }\n          $specContent = Get-Content $specFile -Raw\n          if ($specContent -match \"Analysis\\(\\s*\\[?'([^']+)'\") {\n            $entryPoint = $matches[1]\n            $entryPointPath = $entryPoint -replace '/', '\\'\n            if (Test-Path $entryPointPath) {\n              Write-Host \"\u2705 Entry point file exists: $entryPointPath\" -ForegroundColor Green\n            } else {\n              throw \"\u274c FATAL: Entry point file NOT found: $entryPointPath\"\n            }\n          } else {\n            throw \"\u26a0\ufe0f WARNING: Could not parse entry point from spec file\"\n          }\n      - name: Backend - Build with PyInstaller\n        shell: pwsh\n        run: pyinstaller fortuna-webservice.spec --noconfirm\n      - name: Upload Backend Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-executable-ws-service\n          path: dist/fortuna-webservice.exe\n          retention-days: 1\n\n  smoke-test-service:\n    name: '\ud83e\uddea Smoke Test Service (Backend + Frontend)'\n    timeout-minutes: 15\n    needs: [build-backend]\n    runs-on: windows-latest\n    env:\n      API_KEY: \"a_secure_test_api_key_that_is_long_enough_for_smoke_test\"\n      FORTUNA_MODE: \"webservice\"\n      FORTUNA_PORT: 8089\n      SMOKE_FRONTEND_URL: \"http://localhost:8089\"\n      SMOKE_HEADING_SELECTOR: \"h1:has-text('Fortuna Faucet')\"\n      SMOKE_SCREENSHOT_PATH: \"smoke-test-screenshot.png\"\n      SMOKE_FAILURE_SCREENSHOT_PATH: \"smoke-test-screenshot-FAILURE.png\"\n    steps:\n      - name: Download Artifacts\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-ws-service\n          path: .\n      - name: '\ud83d\udee1\ufe0f Configure Firewall for Smoke Test'\n        shell: pwsh\n        run: |\n          New-NetFirewallRule -DisplayName \"Allow Fortuna Smoke Test\" -Direction Inbound -Action Allow -Protocol TCP -LocalPort ${{ env.FORTUNA_PORT }}\n          Write-Host \"\u2705 Firewall rule added for port ${{ env.FORTUNA_PORT }}.\"\n      - name: Run Backend\n        shell: pwsh\n        run: |\n          $backendProcess = Start-Process -FilePath \"./fortuna-webservice.exe\" -PassThru -RedirectStandardOutput \"backend-out.log\" -RedirectStandardError \"backend-err.log\"\n          Set-Content -Path \"backend.pid\" -Value $backendProcess.Id\n          Start-Sleep -Seconds 10\n      - name: Deep Integration Test (Poll Health Endpoint)\n        continue-on-error: true\n        shell: pwsh\n        run: |\n          $healthUrl = \"${{ env.SMOKE_FRONTEND_URL }}/health\"\n          $maxAttempts = 15\n          $delaySeconds = 2\n          For ($i=1; $i -le $maxAttempts; $i++) {\n            try {\n              $response = Invoke-WebRequest -Uri $healthUrl -UseBasicParsing -TimeoutSec 2\n              if ($response.StatusCode -eq 200) {\n                Write-Host \"\u2705 Health check passed on attempt $i.\"\n                return\n              }\n            } catch {\n              Write-Host \"Attempt $i of $maxAttempts failed. Retrying in $delaySeconds seconds...\"\n              Start-Sleep -Seconds $delaySeconds\n            }\n          }\n          Write-Host \"\u274c Health check failed after $maxAttempts attempts.\"\n          exit 1\n      - name: '\ud83d\udd75\ufe0f\u200d\u2640\ufe0f Enhanced Forensic Analysis'\n        if: always()\n        shell: pwsh\n        run: |\n          $logFile = \"forensic-analysis.log\"\n          \"--- \ud83d\udd75\ufe0f\u200d\u2640\ufe0f FORENSIC ANALYSIS \ud83d\udd75\ufe0f\u200d\u2640\ufe0f ---\" | Out-File $logFile -Encoding utf8\n          \"`n--- 1. SYSTEM INFORMATION ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-ComputerInfo | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n          \"`n--- 2. ENVIRONMENT VARIABLES ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-ChildItem Env: | Sort-Object Name | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n          \"`n--- 3. FILE SYSTEM SNAPSHOT ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-ChildItem -Recurse | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n          \"`n--- 4. RUNNING PROCESSES ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-Process | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n          \"`n--- 5. NETWORK PORT USAGE (netstat) ---\" | Out-File $logFile -Append -Encoding utf8\n          try {\n            netstat -anb | Out-File $logFile -Append -Encoding utf8\n          } catch {\n            \"  (netstat -anb failed, attempting without -b)\" | Out-File $logFile -Append -Encoding utf8\n            netstat -an | Out-File $logFile -Append -Encoding utf8\n          }\n          \"`n--- 6. FIREWALL RULES ---\" | Out-File $logFile -Append -Encoding utf8\n          Get-NetFirewallRule -DisplayName \"Allow Fortuna Smoke Test\" | Format-Table -AutoSize | Out-String -Width 4096 | Out-File $logFile -Append -Encoding utf8\n          \"`n--- 7. FATAL BOOT ERROR LOG (fatal_boot_error.log) ---\" | Out-File $logFile -Append -Encoding utf8\n          if (Test-Path fatal_boot_error.log) { Get-Content fatal_boot_error.log -Raw | Out-File $logFile -Append -Encoding utf8 }\n          \"`n--- 8. BACKEND STDOUT (backend-out.log) ---\" | Out-File $logFile -Append -Encoding utf8\n          if (Test-Path backend-out.log) { Get-Content backend-out.log -Raw | Out-File $logFile -Append -Encoding utf8 }\n          \"`n--- 9. BACKEND STDERR (backend-err.log) ---\" | Out-File $logFile -Append -Encoding utf8\n          if (Test-Path backend-err.log) { Get-Content backend-err.log -Raw | Out-File $logFile -Append -Encoding utf8 }\n          \"`n--- END OF FORENSIC ANALYSIS ---\" | Out-File $logFile -Append -Encoding utf8\n          Write-Host \"\u2705 Forensic analysis written to $logFile\"\n      - name: Upload Forensic Analysis\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: forensic-analysis-service-${{ github.sha }}\n          path: forensic-analysis.log\n          retention-days: 7\n      - name: Frontend UI Verification\n        continue-on-error: true\n        shell: pwsh\n        run: |\n          pip install playwright\n          if ($LASTEXITCODE -ne 0) { throw \"Playwright installation via pip failed.\" }\n          python -m playwright install --with-deps\n          if ($LASTEXITCODE -ne 0) { throw \"Playwright browser installation failed.\" }\n          $scriptContent = @\"\n          import sys, os\n          from playwright.sync_api import sync_playwright, expect\n\n          def run_verification():\n              with sync_playwright() as p:\n                  browser = p.chromium.launch()\n                  page = browser.new_page()\n                  try:\n                      url = os.environ[\"SMOKE_FRONTEND_URL\"]\n                      page.goto(url, wait_until='networkidle', timeout=20000)\n                      heading = page.locator(os.environ[\"SMOKE_HEADING_SELECTOR\"])\n                      expect(heading).to_be_visible(timeout=10000)\n                      page.screenshot(path=os.environ[\"SMOKE_SCREENSHOT_PATH\"])\n                      sys.exit(0)\n                  except Exception as e:\n                      print(f\"Error: {e}\", file=sys.stderr)\n                      page.screenshot(path=os.environ[\"SMOKE_FAILURE_SCREENSHOT_PATH\"])\n                      sys.exit(1)\n                  finally:\n                      browser.close()\n\n          if __name__ == \"__main__\":\n              run_verification()\n          \"@\n          Set-Content -Path \"verify_frontend.py\" -Value $scriptContent\n          python verify_frontend.py\n      - name: Upload Verification Screenshot\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: smoke-test-screenshot-${{ github.sha }}\n          path: |\n            ${{ env.SMOKE_SCREENSHOT_PATH }}\n            ${{ env.SMOKE_FAILURE_SCREENSHOT_PATH }}\n          if-no-files-found: warn\n      - name: Teardown Processes\n        if: always()\n        shell: pwsh\n        run: |\n          if (Test-Path \"backend.pid\") { Get-Content \"backend.pid\" | ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue } }\n      - name: Upload Backend Logs for Diagnosis\n        if: always()\n        uses: actions/upload-artifact@v4\n        with:\n          name: backend-logs-service-${{ github.sha }}\n          path: |\n            backend-out.log\n            backend-err.log\n          if-no-files-found: ignore\n\n  package-msi-service:\n    name: '\ud83d\udcbf Package Service MSI (Web Service)'\n    needs: [smoke-test-service]\n    runs-on: windows-latest\n    steps:\n      - name: Checkout Repository\n        uses: actions/checkout@v4\n        with:\n          fetch-depth: 0\n      - name: Download Backend Executable\n        uses: actions/download-artifact@v4\n        with:\n          name: backend-executable-ws-service\n          path: ./dist\n      - name: Stage Artifacts\n        id: stage_files\n        shell: pwsh\n        run: |\n          $staging = \"build_wix/staging\"\n          New-Item -ItemType Directory -Path $staging -Force\n          Move-Item -Path \"./dist/fortuna-webservice.exe\" -Destination \"$staging/fortuna-webservice.exe\" -Force\n          $msiName = \"Fortuna-As-A-Service-${{ github.ref_name }}.msi\".Replace('/', '-')\n          if ($msiName -match \"main\") { $msiName = \"Fortuna-As-A-Service-Nightly.msi\" }\n          echo \"msi_name=$msiName\" >> $env:GITHUB_OUTPUT\n      - name: Setup .NET 8 SDK\n        uses: actions/setup-dotnet@v4\n        with:\n          dotnet-version: '8.0.x'\n      - name: Build MSI\n        working-directory: build_wix\n        shell: pwsh\n        run: |\n          # Use the Product_WithService.wxs configuration\n          $wixProjContent = @\"\n          <Project Sdk=\"WixToolset.Sdk/4.0.5\">\n            <PropertyGroup>\n              <OutputName>${{ steps.stage_files.outputs.msi_name }}</OutputName>\n              <OutputType>Package</OutputType>\n              <DefineConstants>SourceDir=./staging</DefineConstants>\n              <Platforms>x64</Platforms>\n              <EnableDefaultCompileItems>false</EnableDefaultCompileItems>\n            </PropertyGroup>\n            <ItemGroup>\n              <PackageReference Include=\"WixToolset.Util.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.Firewall.wixext\" Version=\"4.0.5\" />\n              <PackageReference Include=\"WixToolset.UI.wixext\" Version=\"4.0.5\" />\n              <Compile Include=\"./Product_WithService.wxs\" />\n            </ItemGroup>\n          </Project>\n          \"@\n          Set-Content -Path \"FortunaWebService.wixproj\" -Value $wixProjContent -Encoding UTF8\n          dotnet build FortunaWebService.wixproj -c Release -p:Platform=x64\n          $msiPath = \"bin/x64/Release/${{ steps.stage_files.outputs.msi_name }}\"\n          if (-not (Test-Path $msiPath)) { throw \"\u274c Service MSI was not created.\" }\n          New-Item -ItemType Directory -Path \"dist\" -Force\n          Copy-Item -Path $msiPath -Destination \"dist/${{ steps.stage_files.outputs.msi_name }}\" -Force\n      - name: Upload MSI Artifact\n        uses: actions/upload-artifact@v4\n        with:\n          name: fortuna-installer-webservice-as-a-service\n          path: build_wix/dist/*.msi\n          retention-days: 1\n"
  },
  ".github/workflows/codeql.yml": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/.github/workflows/codeql.yml",
    "content": "# System Timestamp: 2025-11-29 13:19:26.933797\n# System Timestamp: 2025-12-03 22:44:34.655552917\nname: \"CodeQL\"\n\non:\n  push:\n    branches: [ \"main\" ]\n  workflow_dispatch:\n\nenv:\n  API_KEY: \"mock_key\"\n  TVG_API_KEY: \"mock_key\"\n  GREYHOUND_API_URL: \"http://mock\"\n  FORTUNA_ENV: \"smoke-test\"\n\njobs:\n  analyze:\n    name: Analyze\n    runs-on: ubuntu-latest\n    permissions:\n      actions: read\n      contents: read\n      security-events: write\n\n    strategy:\n      fail-fast: false\n      matrix:\n        language: [ 'python', 'javascript' ]\n        # CodeQL supports [ 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby' ]\n        # Learn more about CodeQL language support at https://aka.ms/codeql-docs/language-support\n\n    steps:\n    - name: Checkout repository\n      uses: actions/checkout@v4\n\n    # Initializes the CodeQL tools for scanning.\n    - name: Initialize CodeQL\n      uses: github/codeql-action/init@v4\n      with:\n        languages: ${{ matrix.language }}\n        # If you wish to specify custom queries, you can do so here or in a config file.\n        # By default, queries are pulled from a suite stored in GitHub.\n        # See https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs\n        # queries: security-extended,security-and-quality\n\n    - name: Install Python dependencies\n      if: matrix.language == 'python'\n      run: |\n        python -m pip install --upgrade pip\n        # Find and install all requirements files to ensure all dependencies are met for a full scan\n        find . -type f -name 'requirements*.txt' ! -path './.venv/*' -exec echo \"Installing {}\" \\; -exec python -m pip install -r {} \\;\n\n    - name: Install Javascript dependencies\n      if: matrix.language == 'javascript'\n      run: |\n        # Find all package.json files, excluding node_modules, and run npm ci in their directories\n        find . -type f -name 'package.json' ! -path '*/node_modules/*' -exec dirname {} \\; | while read dir; do\n          echo \"Installing dependencies in $dir\"\n          (cd \"$dir\" && npm ci --prefer-offline --no-audit)\n        done\n\n    - name: Perform CodeQL Analysis\n      uses: github/codeql-action/analyze@v4\n      with:\n        category: \"/language:${{matrix.language}}\"\n"
  },
  "build_wix/Product_WithService.wxs": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/build_wix/Product_WithService.wxs",
    "content": "<Wix xmlns=\"http://wixtoolset.org/schemas/v4/wxs\"\n     xmlns:ui=\"http://wixtoolset.org/schemas/v4/wxs/ui\"\n     xmlns:util=\"http://wixtoolset.org/schemas/v4/wxs/util\"\n     xmlns:fire=\"http://wixtoolset.org/schemas/v4/wxs/firewall\">\n\n  <Package Name=\"Fortuna Faucet Web Service\"\n           Manufacturer=\"Fortuna Engineering\"\n           Version=\"$(var.Version)\"\n           UpgradeCode=\"FA689549-366B-4C5C-A482-1132F9A34B10\"\n           Scope=\"perMachine\"\n           Compressed=\"yes\">\n\n    <MajorUpgrade DowngradeErrorMessage=\"A newer version of [ProductName] is already installed.\" />\n    <MediaTemplate EmbedCab=\"yes\" />\n\n    <Feature Id=\"Main\">\n      <ComponentGroupRef Id=\"ServiceComponents\" />\n      <ComponentGroupRef Id=\"ScriptComponents\" />\n      <ComponentGroupRef Id=\"RuntimeDirectoryComponents\" />\n      <ComponentGroupRef Id=\"ShortcutComponents\" />\n    </Feature>\n\n    <ui:WixUI Id=\"WixUI_InstallDir\" InstallDirectory=\"INSTALLFOLDER\">\n        <Publish Dialog=\"ExitDialog\" Control=\"Finish\" Event=\"DoAction\" Value=\"LaunchBrowser\" Condition=\"WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed\" />\n    </ui:WixUI>\n    <WixVariable Id=\"WixUILicenseRtf\" Value=\"license.rtf\" />\n\n    <!-- Properties for the auto-launch checkbox on the exit dialog -->\n    <Property Id=\"WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT\" Value=\"Launch Fortuna Dashboard\" />\n    <Property Id=\"WIXUI_EXITDIALOGOPTIONALCHECKBOX\" Value=\"1\" />\n    <Property Id=\"WixShellExecTarget\" Value=\"http://localhost:$(var.ServicePort)\" />\n\n    <CustomAction Id=\"LaunchBrowser\" BinaryKey=\"WixCA\" DllEntry=\"WixShellExec\" Impersonate=\"yes\" />\n\n    <StandardDirectory Id=\"ProgramFiles64Folder\">\n      <Directory Id=\"INSTALLFOLDER\" Name=\"Fortuna Faucet Service\">\n         <Directory Id=\"Dir_Data\" Name=\"data\" />\n         <Directory Id=\"Dir_Json\" Name=\"json\" />\n         <Directory Id=\"Dir_Logs\" Name=\"logs\" />\n      </Directory>\n    </StandardDirectory>\n\n    <StandardDirectory Id=\"ProgramMenuFolder\">\n        <Directory Id=\"ApplicationProgramsFolder\" Name=\"Fortuna Faucet\"/>\n    </StandardDirectory>\n\n    <StandardDirectory Id=\"DesktopFolder\" />\n\n    <ComponentGroup Id=\"ServiceComponents\" Directory=\"INSTALLFOLDER\">\n      <!-- FIX: Changed Guid from placeholder to '*' for auto-generation -->\n      <Component Id=\"ServiceExecutable\" Guid=\"*\">\n        <File Id=\"FortunaEXE\" Source=\"$(var.SourceDir)/fortuna-webservice.exe\" KeyPath=\"yes\" />\n        <ServiceInstall Id=\"ServiceInstaller\" Type=\"ownProcess\" Name=\"FortunaWebService\" DisplayName=\"Fortuna Faucet Web Service\" Description=\"Background service for Fortuna Faucet\" Start=\"auto\" Account=\"LocalSystem\" ErrorControl=\"normal\" Vital=\"yes\" />\n        <ServiceControl Id=\"StartService\" Stop=\"both\" Remove=\"uninstall\" Name=\"FortunaWebService\" Wait=\"no\" />\n        <fire:FirewallException Id=\"FirewallRule\" Name=\"Fortuna Faucet\" Port=\"$(var.ServicePort)\" Protocol=\"tcp\" Scope=\"any\" />\n      </Component>\n    </ComponentGroup>\n\n    <ComponentGroup Id=\"ScriptComponents\" Directory=\"INSTALLFOLDER\">\n      <Component Id=\"RestartScriptComponent\" Guid=\"*\">\n        <File Id=\"RestartScript\" Source=\"$(var.SourceDir)/restart_service.bat\" KeyPath=\"yes\" />\n      </Component>\n    </ComponentGroup>\n\n    <ComponentGroup Id=\"RuntimeDirectoryComponents\" Directory=\"INSTALLFOLDER\">\n        <Component Id=\"DataDirectoryComponent\" Guid=\"*\">\n            <CreateFolder Directory=\"Dir_Data\" />\n            <RegistryValue Root=\"HKCU\" Key=\"Software\\Fortuna Faucet\\Directories\" Name=\"Data\" Type=\"string\" Value=\"1\" KeyPath=\"yes\" />\n        </Component>\n        <Component Id=\"JsonDirectoryComponent\" Guid=\"*\">\n            <CreateFolder Directory=\"Dir_Json\" />\n            <RegistryValue Root=\"HKCU\" Key=\"Software\\Fortuna Faucet\\Directories\" Name=\"Json\" Type=\"string\" Value=\"1\" KeyPath=\"yes\" />\n        </Component>\n        <Component Id=\"LogsDirectoryComponent\" Guid=\"*\">\n            <CreateFolder Directory=\"Dir_Logs\" />\n            <RegistryValue Root=\"HKCU\" Key=\"Software\\Fortuna Faucet\\Directories\" Name=\"Logs\" Type=\"string\" Value=\"1\" KeyPath=\"yes\" />\n        </Component>\n    </ComponentGroup>\n\n    <ComponentGroup Id=\"ShortcutComponents\">\n        <Component Id=\"StartMenuShortcuts\" Guid=\"*\" Directory=\"ApplicationProgramsFolder\">\n            <util:InternetShortcut Id=\"DashboardShortcut\" Name=\"Fortuna Dashboard\" Target=\"http://localhost:$(var.ServicePort)\" />\n            <Shortcut Id=\"RestartShortcut\" Name=\"Restart Service\" Description=\"Restarts the background service (Run as Admin)\" Target=\"[INSTALLFOLDER]restart_service.bat\" />\n            <Shortcut Id=\"LogsShortcut\" Name=\"View Logs\" Description=\"Opens the log file directory\" Target=\"[Dir_Logs]\" />\n            <util:InternetShortcut Id=\"HelpShortcut\" Name=\"Help & Documentation\" Description=\"View API documentation and help\" Target=\"http://localhost:$(var.ServicePort)/docs\" />\n            <Shortcut Id=\"UninstallShortcut\" Name=\"Uninstall Fortuna Faucet\" Description=\"Removes the application\" Target=\"[System64Folder]msiexec.exe\" Arguments=\"/x [ProductCode]\" />\n            <RemoveFolder Id=\"ApplicationProgramsFolder\" On=\"uninstall\" />\n            <RegistryValue Root=\"HKCU\" Key=\"Software\\Fortuna Faucet\" Name=\"StartMenuShortcut\" Type=\"integer\" Value=\"1\" KeyPath=\"yes\" />\n        </Component>\n    </ComponentGroup>\n\n  </Package>\n</Wix>"
  },
  "build_wix/Product_WithoutService.wxs.bak": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/build_wix/Product_WithoutService.wxs.bak",
    "content": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Wix xmlns=\"http://wixtoolset.org/schemas/v4/wxs\"\n     xmlns:util=\"http://wixtoolset.org/schemas/v4/wxs/util\">\n\n  <Package Name=\"Fortuna Faucet - Standalone\"\n           Manufacturer=\"Fortuna Development Team\"\n           Version=\"1.0.0.0\"\n           UpgradeCode=\"28085bda-8ed9-48de-8d12-08d9cc77fb76\"\n           Scope=\"perMachine\">\n\n    <MajorUpgrade DowngradeErrorMessage=\"A newer version is already installed.\" />\n    <MediaTemplate EmbedCab=\"yes\" />\n\n    <!-- Features -->\n    <Feature Id=\"MainApplication\" Title=\"Main Application\" Level=\"1\">\n      <ComponentGroupRef Id=\"StandaloneComponents\" />\n      <ComponentGroupRef Id=\"ShortcutsComponentGroup\"/>\n    </Feature>\n\n    <!-- Directory Structure -->\n    <StandardDirectory Id=\"ProgramFiles64Folder\">\n      <Directory Id=\"INSTALLFOLDER\" Name=\"Fortuna Standalone\">\n        <Component Id=\"FortunaBackendStandalone\" Guid=\"04e85c16-b8de-4ca6-b540-dbf5f178ba3e\">\n          <File Id=\"FortunaBackendExe\"\n                Source=\"$(var.SourceDir)/fortuna-backend.exe\"\n                KeyPath=\"yes\" />\n        </Component>\n      </Directory>\n    </StandardDirectory>\n\n    <StandardDirectory Id=\"ProgramMenuFolder\">\n        <Directory Id=\"ApplicationProgramsFolder\" Name=\"Fortuna Standalone\"/>\n    </StandardDirectory>\n\n    <!-- Component Groups -->\n    <ComponentGroup Id=\"StandaloneComponents\">\n      <ComponentRef Id=\"FortunaBackendStandalone\" />\n    </ComponentGroup>\n\n    <ComponentGroup Id=\"ShortcutsComponentGroup\" Directory=\"ApplicationProgramsFolder\">\n      <Component Id=\"ApplicationShortcuts\" Guid=\"f4bd5c40-1d9f-4428-9413-8fbcf6ecdc4e\">\n          <util:InternetShortcut Id=\"DashboardShortcut\" Name=\"Fortuna Faucet Dashboard\" Target=\"http://localhost:8000\"/>\n          <Shortcut Id=\"UninstallShortcut\" Name=\"Uninstall Fortuna Faucet Standalone\" Description=\"Remove this application\" Target=\"[System64Folder]msiexec.exe\" Arguments=\"/x [ProductCode]\" />\n          <RemoveFolder Id=\"ApplicationProgramsFolder\" On=\"uninstall\"/>\n          <RegistryValue Root=\"HKCU\" Key=\"Software\\Fortuna Faucet Standalone\" Name=\"Installed\" Type=\"integer\" Value=\"1\" KeyPath=\"yes\"/>\n      </Component>\n    </ComponentGroup>\n\n    <!-- UI -->\n    <Property Id=\"WIXUI_INSTALLDIR\" Value=\"INSTALLFOLDER\" />\n    <UI>\n      <UIRef Id=\"WixUI_InstallDir\" />\n    </UI>\n\n  </Package>\n</Wix>\n"
  },
  "electron/main.js": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/electron/main.js",
    "content": "// electron/main.js - CORRECTED VERSION\nconst { app, BrowserWindow, Tray, Menu, nativeImage, ipcMain, dialog } = require('electron');\nconst { autoUpdater } = require('electron-updater');\nconst { spawn } = require('child_process');\nconst net = require('net');\nconst path = require('path');\nconst fs = require('fs');\nconst SecureSettingsManager = require('./secure-settings-manager');\n\nclass FortunaDesktopApp {\n constructor() {\n this.backendProcess = null;\n this.mainWindow = null;\n this.tray = null;\n this.backendState = 'stopped'; // \"stopped\", \"starting\", \"running\", \"error\"\n this.backendLogs = [];\n this.isBackendStarting = false;\n }\n\n sendBackendStatusUpdate() {\n if (this.mainWindow) {\n this.mainWindow.webContents.send('backend-status-update', {\n state: this.backendState,\n logs: this.backendLogs.slice(-20) // Send last 20 log entries\n });\n }\n }\n\n stopBackend() {\n if (this.backendProcess && !this.backendProcess.killed) {\n console.log('Stopping backend process...');\n this.backendProcess.kill();\n this.backendState = 'stopped';\n this.isBackendStarting = false; // Ensure lock is released on stop\n this.backendLogs.push('Backend process stopped by user.');\n this.sendBackendStatusUpdate();\n }\n }\n\n  checkPortInUse(port) {\n    return new Promise((resolve, reject) => {\n      const server = net.createServer();\n      server.once('error', (err) => {\n        if (err.code === 'EADDRINUSE') {\n          resolve(true); // Port is in use\n        } else {\n          reject(err);\n        }\n      });\n      server.once('listening', () => {\n        server.close(() => {\n          resolve(false); // Port is free\n        });\n      });\n      server.listen(port, '127.0.0.1');\n    });\n  }\n\n  async startBackend() {\n    if (this.isBackendStarting) {\n      console.log('Backend start already in progress. Ignoring request.');\n      return;\n    }\n\n    this.isBackendStarting = true;\n    this.backendState = 'starting';\n    this.backendLogs = ['Attempting to start backend...'];\n    this.sendBackendStatusUpdate();\n\n    const port = process.env.FORTUNA_PORT || 8000;\n\n    try {\n      const isPortInUse = await this.checkPortInUse(port);\n      if (isPortInUse) {\n        console.log(`Port ${port} is already in use. Assuming backend is running.`);\n        this.backendState = 'running';\n        this.backendLogs.push(`Port ${port} is already in use. Assuming backend is running.`);\n        this.isBackendStarting = false;\n        this.sendBackendStatusUpdate();\n        return; // The most important change: we just stop here.\n      }\n    } catch (error) {\n        const errorMsg = `Error checking port ${port}: ${error.message}`;\n        console.error(errorMsg);\n        this.backendState = 'error';\n        this.backendLogs.push(errorMsg);\n        this.isBackendStarting = false;\n        this.sendBackendStatusUpdate();\n        dialog.showErrorBox('Network Error', `Could not check port ${port}. Please check your network configuration.`);\n        return;\n    }\n\n    if (this.backendProcess && !this.backendProcess.killed) {\n      console.log('An old backend process was found. Terminating it before starting a new one.');\n      this.backendProcess.kill();\n    }\n\n    const isDev = !app.isPackaged;\n    let backendCommand;\n    const backendArgs = [];\n    let backendCwd = process.cwd();\n\n    if (isDev) {\n      // This logic remains the same for development\n      console.log('[DEV MODE] Configuring backend to run from Python venv...');\n      backendCommand = path.join(__dirname, '..', '.venv', 'Scripts', 'python.exe');\n      backendArgs.push('-m', 'uvicorn', 'api:app', '--host', '127.0.0.1', '--port', port);\n      backendCwd = path.join(__dirname, '..', 'python_service');\n    } else {\n      console.log('[PROD MODE] Configuring backend to run from packaged executable...');\n      backendCommand = path.join(process.resourcesPath, 'python-service-bin', 'fortuna-backend.exe');\n    }\n\n    if (!fs.existsSync(backendCommand)) {\n      const errorMsg = `FATAL: Backend executable not found at ${backendCommand}`;\n      console.error(errorMsg);\n      this.backendState = 'error';\n      this.backendLogs.push(errorMsg);\n      this.isBackendStarting = false;\n      this.sendBackendStatusUpdate();\n      dialog.showErrorBox('Backend Missing', 'The backend service executable is missing. Please try reinstalling Fortuna Faucet.');\n      return;\n    }\n\n    console.log(`Spawning backend: ${backendCommand} ${backendArgs.join(' ')}`);\n    this.backendProcess = spawn(backendCommand, backendArgs, {\n      cwd: backendCwd,\n      env: { ...process.env, FORTUNA_PORT: port.toString() },\n      stdio: ['ignore', 'pipe', 'pipe'],\n    });\n\n    this.backendProcess.stdout.on('data', (data) => {\n      const output = data.toString().trim();\n      console.log(`[Backend] ${output}`);\n      this.backendLogs.push(output);\n      if (this.backendState !== 'running' && output.includes('Application startup complete')) {\n        console.log('\u2705 Backend is ready!');\n        this.backendState = 'running';\n        this.isBackendStarting = false;\n      }\n      this.sendBackendStatusUpdate();\n    });\n\n this.backendProcess.stderr.on('data', (data) => {\n const errorOutput = data.toString().trim();\n console.error(`[Backend ERROR] ${errorOutput}`);\n this.backendLogs.push(`ERROR: ${errorOutput}`);\n this.backendState = 'error';\n this.isBackendStarting = false;\n this.sendBackendStatusUpdate();\n });\n\n this.backendProcess.on('error', (err) => {\n const errorMsg = `FATAL: Failed to start backend process: ${err.message}`;\n console.error(errorMsg);\n this.backendLogs.push(errorMsg);\n this.backendState = 'error';\n this.isBackendStarting = false;\n this.sendBackendStatusUpdate();\n });\n\n this.backendProcess.on('exit', (code) => {\n if (code !== 0 && this.backendState !== 'stopped') {\n const errorMsg = `Backend process exited unexpectedly with code ${code}`;\n console.error(errorMsg);\n this.backendLogs.push(errorMsg);\n this.backendState = 'error';\n this.isBackendStarting = false;\n this.sendBackendStatusUpdate();\n }\n });\n }\n\n getFrontendPath() {\n const isDev = !app.isPackaged;\n\n if (isDev) {\n return 'http://localhost:3000';\n }\n\n const indexPath = path.join(app.getAppPath(), 'web-ui-build', 'out', 'index.html');\n const { pathToFileURL } = require('url');\n return pathToFileURL(indexPath).toString();\n }\n\n createMainWindow() {\n this.mainWindow = new BrowserWindow({\n width: 1600,\n height: 1000,\n title: 'Fortuna Faucet - Racing Analysis',\n icon: path.join(__dirname, 'assets', 'icon.ico'),\n webPreferences: {\n nodeIntegration: false,\n contextIsolation: true,\n preload: path.join(__dirname, 'preload.js')\n },\n autoHideMenuBar: true,\n backgroundColor: '#1a1a2e'\n });\n\n const frontendUrl = this.getFrontendPath();\n this.mainWindow.loadURL(frontendUrl);\n\n if (!app.isPackaged) {\n this.mainWindow.webContents.openDevTools();\n }\n\n this.mainWindow.on('close', (event) => {\n if (!app.isQuitting) {\n event.preventDefault();\n this.mainWindow.hide();\n }\n });\n }\n\n createSystemTray() {\n // ... (rest of the file is unchanged)\n }\n\n initialize() {\n  ipcMain.handle('get-api-port', () => {\n    return process.env.FORTUNA_PORT || 8000;\n  });\n this.createMainWindow();\n this.createSystemTray();\n this.startBackend();\n\n // Check for updates\n autoUpdater.checkForUpdatesAndNotify();\n\n autoUpdater.on('update-downloaded', (info) => {\n const dialogOpts = {\n type: 'info',\n buttons: ['Restart', 'Later'],\n title: 'Application Update',\n message: process.platform === 'win32' ? info.releaseName : info.releaseName,\n detail: 'A new version has been downloaded. Restart the application to apply the updates.'\n };\n\n dialog.showMessageBox(dialogOpts).then((returnValue) => {\n if (returnValue.response === 0) autoUpdater.quitAndInstall();\n });\n });\n\n ipcMain.on('restart-backend', () => this.startBackend());\n ipcMain.on('stop-backend', () => this.stopBackend());\n ipcMain.handle('get-backend-status', async () => ({\n state: this.backendState,\n logs: this.backendLogs.slice(-20)\n }));\n\n ipcMain.handle('get-api-key', async () => {\n return SecureSettingsManager.getApiKey();\n });\n\n ipcMain.handle('generate-api-key', async () => {\n const crypto = require('node:crypto');\n const newKey = crypto.randomBytes(16).toString('hex');\n SecureSettingsManager.saveApiKey(newKey);\n return newKey;\n });\n\n ipcMain.handle('save-api-key', async (event, apiKey) => {\n return SecureSettingsManager.saveApiKey(apiKey);\n });\n\n ipcMain.handle('save-betfair-credentials', async (event, credentials) => {\n return SecureSettingsManager.saveBetfairCredentials(credentials);\n });\n }\n\n cleanup() {\n if (this.backendProcess && !this.backendProcess.killed) {\n this.backendProcess.kill();\n }\n }\n}\n\nlet fortunaApp;\n\napp.whenReady().then(() => {\n fortunaApp = new FortunaDesktopApp();\n fortunaApp.initialize();\n});\n\napp.on('window-all-closed', () => {\n if (process.platform !== 'darwin') {\n // Do nothing, keep app running in tray\n }\n});\n\napp.on('activate', () => {\n if (BrowserWindow.getAllWindows().length === 0) {\n fortunaApp.createMainWindow();\n } else {\n fortunaApp.mainWindow.show();\n }\n});\n\napp.on('before-quit', () => {\n app.isQuitting = true;\n if (fortunaApp) {\n fortunaApp.cleanup();\n }\n});\n"
  },
  "web_service/backend/service_entry.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/web_service/backend/service_entry.py",
    "content": "import win32serviceutil\nimport win32service\nimport win32event\nimport servicemanager\nimport socket\nimport sys\nimport os\nimport uvicorn\nimport multiprocessing\nimport threading\nfrom pathlib import Path\n\n# FIX: Ensure the current directory is in sys.path for relative imports in frozen state\nsys.path.insert(0, str(Path(__file__).parent))\n\ntry:\n    from main import app\nexcept ImportError:\n    # Fallback for different packaging structures\n    from web_service.backend.main import app\n\nclass FortunaSvc(win32serviceutil.ServiceFramework):\n    _svc_name_ = 'FortunaWebService'\n    _svc_display_name_ = 'Fortuna Faucet Backend Service'\n    _svc_description_ = 'Data aggregation and analysis engine.'\n\n    def __init__(self, args):\n        win32serviceutil.ServiceFramework.__init__(self, args)\n        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)\n        self.server = None\n        self.server_thread = None\n\n    def SvcStop(self):\n        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)\n        win32event.SetEvent(self.hWaitStop)\n        if self.server:\n            self.server.should_exit = True\n\n    def SvcDoRun(self):\n        servicemanager.LogMsg(servicemanager.EVENTLOG_INFORMATION_TYPE,\n                              servicemanager.PYS_SERVICE_STARTED,\n                              (self._svc_name_, ''))\n\n        config = uvicorn.Config(app, host='127.0.0.1', port=8102, log_config=None, reload=False)\n        self.server = uvicorn.Server(config)\n\n        # Run the server in a separate thread\n        self.server_thread = threading.Thread(target=self.server.run)\n        self.server_thread.start()\n\n        # Wait for the stop event\n        win32event.WaitForSingleObject(self.hWaitStop, win32event.INFINITE)\n\n        # Wait for the server thread to finish\n        self.server_thread.join()\n\nif __name__ == '__main__':\n    multiprocessing.freeze_support()\n    if len(sys.argv) == 1:\n        servicemanager.Initialize()\n        servicemanager.PrepareToHostSingle(FortunaSvc)\n        servicemanager.StartServiceCtrlDispatcher()\n    else:\n        win32serviceutil.HandleCommandLine(FortunaSvc)\n"
  },
  "web_service/backend/main.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/web_service/backend/main.py",
    "content": "import uvicorn\nimport sys\nimport os\nfrom multiprocessing import freeze_support\n\n# Force UTF-8 encoding for stdout and stderr, crucial for PyInstaller on Windows\nos.environ[\"PYTHONUTF8\"] = \"1\"\n\n# This is the definitive entry point for the Fortuna Faucet backend service.\n# It is designed to be compiled with PyInstaller.\n\ndef _configure_sys_path():\n    \"\"\"\n    Dynamically adds project paths to sys.path.\n    This is the robust solution to ensure that string-based imports like\n    \"web_service.backend.api:app\" work correctly when the application is\n    run from a PyInstaller executable. The `_MEIPASS` attribute is a temporary\n    directory created by PyInstaller at runtime.\n    \"\"\"\n    if getattr(sys, \"frozen\", False) and hasattr(sys, \"_MEIPASS\"):\n        # Running in a PyInstaller bundle. The project root is the _MEIPASS directory.\n        project_root = os.path.abspath(sys._MEIPASS)\n\n        # Aggressively add paths to resolve potential module lookup issues in frozen mode.\n        paths_to_add = [\n            project_root,\n            os.path.join(project_root, \"web_service\"),\n            os.path.join(project_root, \"web_service\", \"backend\"),\n        ]\n\n        # Insert paths at the beginning of sys.path in reverse order\n        # to maintain the desired precedence.\n        for path in reversed(paths_to_add):\n            if path not in sys.path:\n                sys.path.insert(0, path)\n                print(f\"INFO: Added path to sys.path: {path}\")\n\n    else:\n        # Running as a normal script. The project root is two levels up.\n        project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), \"..\", \"..\"))\n        if project_root not in sys.path:\n            sys.path.insert(0, project_root)\n            print(f\"INFO: Added project root to sys.path: {project_root}\")\n\ndef main():\n    \"\"\"\n    Primary entry point for the Fortuna Faucet backend application.\n    This function configures and runs the Uvicorn server.\n    \"\"\"\n    # CRITICAL: This must be called before any other application imports.\n    _configure_sys_path()\n\n    # When packaged, we need to ensure multiprocessing and asyncio work correctly.\n    if getattr(sys, \"frozen\", False):\n        # CRITICAL for multiprocessing support in frozen mode on Windows.\n        freeze_support()\n        # CRITICAL for asyncio server behavior in frozen mode on Windows.\n        import asyncio\n        print(\"[BOOT] Applied WindowsSelectorEventLoopPolicy for PyInstaller\")\n        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())\n\n\n    from web_service.backend.config import get_settings\n    from web_service.backend.port_check import check_port_and_exit_if_in_use\n    # The 'app' object is needed for the server to run. Importing it here ensures\n    # all its dependencies are resolved after the sys.path modification.\n    from web_service.backend.api import app\n\n    settings = get_settings()\n\n    # In CI/CD, binding to 0.0.0.0 is more robust than 127.0.0.1.\n    # We will override the host setting for the smoke test environment.\n    run_host = settings.UVICORN_HOST\n    if os.environ.get(\"FORTUNA_ENV\") == \"smoke-test\":\n        run_host = \"0.0.0.0\"\n        print(f\"INFO: Smoke test environment detected. Overriding host to '{run_host}'\")\n\n\n    # --- Port Sanity Check ---\n    check_port_and_exit_if_in_use(settings.FORTUNA_PORT, run_host)\n\n    print(f\"INFO: Starting Uvicorn server...\")\n    print(f\"      APP: web_service.backend.api:app\")\n    print(f\"      HOST: {run_host}\")\n    print(f\"      PORT: {settings.FORTUNA_PORT}\")\n\n    # For PyInstaller, it's more reliable to pass the app object directly\n    # rather than a string, as string-based imports can be fragile.\n    uvicorn.run(\n        app,\n        host=run_host,\n        port=settings.FORTUNA_PORT,\n        log_level=\"info\"\n    )\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "web_service/backend/requirements.txt": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/web_service/backend/requirements.txt",
    "content": "#\n# This file is autogenerated by pip-compile with Python 3.12\n# by the following command:\n#\n#    pip-compile --output-file=python_service/requirements.txt python_service/requirements.in\n#\naiosqlite==0.21.0\n    # via -r python_service/requirements.in\naltgraph==0.17.4\n    # via pyinstaller\nannotated-doc==0.0.4\n    # via fastapi\nannotated-types==0.7.0\n    # via pydantic\nanyio==4.11.0\n    # via\n    #   httpx\n    #   starlette\nbeautifulsoup4==4.14.2\n    # via -r python_service/requirements.in\nblack==25.11.0\n    # via -r python_service/requirements.in\nbuild==1.3.0\n    # via pip-tools\ncertifi==2025.10.5\n    # via\n    #   -r python_service/requirements.in\n    #   httpcore\n    #   httpx\n    #   requests\ncffi==2.0.0\n    # via cryptography\ncharset-normalizer==3.4.4\n    # via requests\nclick==8.3.0\n    # via\n    #   black\n    #   pip-tools\n    #   uvicorn\ncryptography==46.0.3\n    # via\n    #   -r python_service/requirements.in\n    #   secretstorage\ndeprecated==1.3.1\n    # via limits\nfastapi==0.121.1\n    # via -r python_service/requirements.in\ngreenlet==3.2.4\n    # via sqlalchemy\nh11==0.16.0\n    # via\n    #   httpcore\n    #   uvicorn\nh2==4.3.0\n    # via httpx\nhpack==4.1.0\n    # via h2\nhttpcore==1.0.9\n    # via httpx\nhttpx[http2]==0.28.1\n    # via -r python_service/requirements.in\nhyperframe==6.1.0\n    # via h2\nidna==3.11\n    # via\n    #   anyio\n    #   httpx\n    #   requests\niniconfig==2.3.0\n    # via pytest\njaraco-classes==3.4.0\n    # via keyring\njaraco-context==6.0.1\n    # via keyring\njaraco-functools==4.3.0\n    # via keyring\njeepney==0.9.0\n    # via\n    #   keyring\n    #   secretstorage\nkeyring==25.6.0\n    # via -r python_service/requirements.in\nlimits==5.6.0\n    # via slowapi\nmore-itertools==10.8.0\n    # via\n    #   jaraco-classes\n    #   jaraco-functools\nmypy-extensions==1.1.0\n    # via black\nnumpy==2.3.4\n    # via\n    #   -r python_service/requirements.in\n    #   pandas\n    #   scipy\npackaging==25.0\n    # via\n    #   black\n    #   build\n    #   limits\n    #   pyinstaller\n    #   pyinstaller-hooks-contrib\n    #   pytest\npandas==2.3.3\n    # via -r python_service/requirements.in\npathspec==0.12.1\n    # via black\npip-tools==7.5.1\n    # via -r python_service/requirements.in\nplatformdirs==4.5.0\n    # via black\npluggy==1.6.0\n    # via pytest\npsutil==7.1.3\n    # via -r python_service/requirements.in\npsycopg2-binary==2.9.11\n    # via -r python_service/requirements.in\npycparser==2.23\n    # via cffi\npydantic==2.12.4\n    # via\n    #   fastapi\n    #   pydantic-settings\npydantic-core==2.41.5\n    # via pydantic\npydantic-settings==2.12.0\n    # via -r python_service/requirements.in\npygments==2.19.2\n    # via pytest\npyinstaller==6.6.0\n    # via -r python_service/requirements.in\npyinstaller-hooks-contrib==2025.9\n    # via pyinstaller\npyproject-hooks==1.2.0\n    # via\n    #   build\n    #   pip-tools\npytest==9.0.0\n    # via\n    #   -r python_service/requirements.in\n    #   pytest-asyncio\npytest-asyncio==1.3.0\n    # via -r python_service/requirements.in\npython-dateutil==2.9.0.post0\n    # via pandas\npython-dotenv==1.2.1\n    # via pydantic-settings\npytokens==0.3.0\n    # via black\npytz==2025.2\n    # via pandas\nredis==7.0.1\n    # via -r python_service/requirements.in\nrequests==2.32.5\n    # via -r python_service/requirements.in\nscipy==1.16.3\n    # via -r python_service/requirements.in\nsecretstorage==3.4.1\n    # via keyring\nselectolax==0.4.0\n    # via -r python_service/requirements.in\nsix==1.17.0\n    # via python-dateutil\nslowapi==0.1.9\n    # via -r python_service/requirements.in\nsniffio==1.3.1\n    # via anyio\nsoupsieve==2.8\n    # via beautifulsoup4\nsqlalchemy==2.0.44\n    # via -r python_service/requirements.in\nstarlette==0.49.3\n    # via fastapi\nstructlog==25.5.0\n    # via -r python_service/requirements.in\ntenacity==8.5.0\n    # via -r python_service/requirements.in\ntyping-extensions==4.15.0\n    # via\n    #   aiosqlite\n    #   anyio\n    #   beautifulsoup4\n    #   fastapi\n    #   limits\n    #   pydantic\n    #   pydantic-core\n    #   pytest-asyncio\n    #   sqlalchemy\n    #   starlette\n    #   typing-inspection\ntyping-inspection==0.4.2\n    # via\n    #   pydantic\n    #   pydantic-settings\ntzdata==2025.2\n    # via pandas\nurllib3>=2.6.0\n    # via\n    #   -r python_service/requirements.in\n    #   requests\nuvicorn==0.30.1\n    # via -r python_service/requirements.in\nwheel==0.45.1\n    # via\n    #   -r python_service/requirements.in\n    #   pip-tools\nwrapt==2.0.1\n    # via deprecated\n\n# The following packages are considered to be unsafe in a requirements file:\n# pip\n# setuptools\npywin32==306; sys_platform == 'win32'\n"
  },
  "electron/package.json": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/electron/package.json",
    "content": "{\n \"name\": \"fortuna-faucet\",\n \"version\": \"1.0.0\",\n \"description\": \"Fortuna Faucet Data Management Console\",\n \"main\": \"main.js\",\n \"scripts\": {\n \"start\": \"electron .\",\n \"build\": \"electron-builder\",\n \"dist\": \"electron-builder\"\n },\n \"author\": \"Fortuna Development Team\",\n \"devDependencies\": {\n \"electron\": \"28.0.0\",\n \"electron-builder\": \"24.9.1\"\n },\n \"dependencies\": {\n \"electron-updater\": \"^6.1.1\"\n }\n}\n"
  },
  "web_service/backend/api.spec": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/web_service/backend/api.spec",
    "content": "# -*- mode: python ; coding: utf-8 -*-\n\n\na = Analysis(\n    ['api.py'],\n    pathex=[],\n    binaries=[],\n    datas=[('adapters', 'adapters')],\n    hiddenimports=['uvicorn'],\n    hookspath=[],\n    hooksconfig={},\n    runtime_hooks=[],\n    excludes=[],\n    noarchive=False,\n    optimize=0,\n)\npyz = PYZ(a.pure)\n\nexe = EXE(\n    pyz,\n    a.scripts,\n    a.binaries,\n    a.datas,\n    [],\n    name='api',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    upx_exclude=[],\n    runtime_tmpdir=None,\n    console=True,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n)\n"
  },
  "fortuna-webservice.spec": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/fortuna-webservice.spec",
    "content": "# -*- mode: python ; coding: utf-8 -*-\n\nimport os\nfrom pathlib import Path\nfrom PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\nblock_cipher = None\nproject_root = Path(SPECPATH).resolve()\n\ndef include_tree(rel_path, target, store):\n    absolute = project_root / rel_path\n    if absolute.exists():\n        store.append((str(absolute), target))\n        print(f\"[spec] Including {absolute} -> {target}\")\n    else:\n        # This spec is used by the legacy build-msi.yml, which checks for these dirs.\n        # If they are missing here, it's a critical error.\n        raise FileNotFoundError(f\"[spec] Required directory not found: {absolute}\")\n\ndatas = []\n# Paths must match the legacy structure used by build-msi.yml\ninclude_tree('python_service/adapters', 'adapters', datas)\ninclude_tree('python_service/data', 'data', datas)\ninclude_tree('python_service/json', 'json', datas)\n\n# Collect library assets\ntry:\n    datas += collect_data_files('uvicorn', includes=['*.html', '*.json'])\n    datas += collect_data_files('structlog', includes=['*.json'])\nexcept Exception as e:\n    print(f\"[spec] Warning: Could not collect library data files: {e}\")\n\n# Collect Hidden Imports for python_service\nhidden_imports = set()\nhidden_imports.update(collect_submodules('python_service'))\nhidden_imports.update([\n    'fastapi', 'uvicorn', 'uvicorn.logging', 'uvicorn.loops.auto', 'uvicorn.lifespan.on',\n    'uvicorn.protocols.http.h11_impl', 'uvicorn.protocols.http.httptools_impl',\n    'uvicorn.protocols.websockets.wsproto_impl', 'uvicorn.protocols.websockets.websockets_impl',\n    'anyio', 'httpcore', 'httpx', 'python_multipart', 'pydantic', 'pydantic_core',\n    'aiosqlite', 'structlog', 'tenacity', 'slowapi'\n])\n\na = Analysis(\n    ['python_service/main.py'],  # Corrected Entry Point for the legacy workflow\n    pathex=[str(project_root)],\n    binaries=[],\n    datas=datas,\n    hiddenimports=sorted(hidden_imports),\n    hookspath=[],\n    hooksconfig={},\n    runtime_hooks=[],\n    excludes=['matplotlib', 'pandas', 'numpy', 'torch', 'tensorflow', 'web_service'],\n    win_no_prefer_redirects=False,\n    win_private_assemblies=False,\n    cipher=block_cipher,\n    noarchive=False,\n)\n\npyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n\nexe = EXE(\n    pyz,\n    a.scripts,\n    a.binaries,\n    a.zipfiles,\n    a.datas,\n    [],\n    name='fortuna-webservice', # Name matches the workflow expectation\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=False,\n    runtime_tmpdir=None,\n    console=False,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n)\n"
  },
  "python_service/api.spec": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/python_service/api.spec",
    "content": "# -*- mode: python ; coding: utf-8 -*-\n\n\na = Analysis(\n    ['api.py'],\n    pathex=[],\n    binaries=[],\n    datas=[('adapters', 'adapters')],\n    hiddenimports=['uvicorn'],\n    hookspath=[],\n    hooksconfig={},\n    runtime_hooks=[],\n    excludes=[],\n    noarchive=False,\n    optimize=0,\n)\npyz = PYZ(a.pure)\n\nexe = EXE(\n    pyz,\n    a.scripts,\n    a.binaries,\n    a.datas,\n    [],\n    name='api',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    upx_exclude=[],\n    runtime_tmpdir=None,\n    console=True,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n)\n"
  },
  "fortuna-backend-webservice.spec": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/fortuna-backend-webservice.spec",
    "content": "# -*- mode: python ; coding: utf-8 -*-\n\nimport os\nfrom pathlib import Path\nfrom textwrap import dedent\n\nfrom PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\nblock_cipher = None\nproject_root = Path(SPECPATH)\nversion_string = os.environ.get(\"FORTUNA_VERSION\", \"0.0.0\")\n\n\ndef ensure_path(rel_path: str) -> Path:\n    target = project_root / rel_path\n    if not target.exists():\n        raise SystemExit(f\"[spec] Required path missing: {target}\")\n    return target\n\n\ndef include_tree(rel_path: str, target: str, store: list):\n    absolute = ensure_path(rel_path)\n    store.append((str(absolute), target))\n    print(f\"[spec] Including {absolute} -> {target}\")\n\n\ndef build_version_file(version: str) -> str:\n    parts = [int(p) for p in version.split(\".\") if p.isdigit()]\n    while len(parts) < 4:\n        parts.append(0)\n    parts = parts[:4]\n    file_content = dedent(\n        f\"\"\"\n        VSVersionInfo(\n          ffi=FixedFileInfo(\n            filevers={tuple(parts)},\n            prodvers={tuple(parts)},\n            mask=0x3f,\n            flags=0x0,\n            OS=0x40004,\n            fileType=0x1,\n            subtype=0x0,\n            date=(0, 0)\n          ),\n          kids=[\n            StringFileInfo([\n              StringTable(\n                '040904B0',\n                [\n                  StringStruct('CompanyName', 'Fortuna Development Team'),\n                  StringStruct('FileDescription', 'Fortuna Backend Web Service'),\n                  StringStruct('FileVersion', '{version}'),\n                  StringStruct('InternalName', 'fortuna-backend'),\n                  StringStruct('ProductName', 'Fortuna Web Service'),\n                  StringStruct('ProductVersion', '{version}')\n                ]\n              )\n            ]),\n            VarFileInfo([VarStruct('Translation', [1033, 1200])])\n          ]\n        )\n        \"\"\"\n    ).strip()\n    version_dir = project_root / \"build\" / \"pyinstaller\"\n    version_dir.mkdir(parents=True, exist_ok=True)\n    version_file = version_dir / \"version-info.txt\"\n    version_file.write_text(file_content, encoding=\"utf-8\")\n    return str(version_file)\n\n\ndatas = []\nhiddenimports = set()\n\ninclude_tree(\"staging/ui\", \"ui\", datas)\ninclude_tree(\"python_service/adapters\", \"adapters\", datas)\ninclude_tree(\"python_service/data\", \"data\", datas)\ninclude_tree(\"python_service/json\", \"json\", datas)\n\ndatas += collect_data_files(\"uvicorn\", includes=[\"*.html\", \"*.json\"])\ndatas += collect_data_files(\"slowapi\", includes=[\"*.json\", \"*.yaml\"])\ndatas += collect_data_files(\"structlog\", includes=[\"*.json\"])\ndatas += collect_data_files(\"certifi\")\n\nhiddenimports.update(collect_submodules(\"python_service\"))\nhiddenimports.update(\n    [\n        \"uvicorn.logging\",\n        \"uvicorn.loops.auto\",\n        \"uvicorn.lifespan.on\",\n        \"uvicorn.protocols.http.h11_impl\",\n        \"uvicorn.protocols.http.httptools_impl\",\n        \"uvicorn.protocols.websockets.wsproto_impl\",\n        \"uvicorn.protocols.websockets.websockets_impl\",\n        \"fastapi.routing\",\n        \"fastapi.middleware.cors\",\n        \"fastapi.middleware.gzip\",\n        \"starlette.staticfiles\",\n        \"starlette.middleware.cors\",\n        \"anyio._backends._asyncio\",\n        \"httpcore\",\n        \"httpx\",\n        \"python_multipart\",\n        \"slowapi\",\n        \"structlog\",\n        \"tenacity\",\n        \"aiosqlite\",\n        \"selectolax\",\n        \"pydantic_core\",\n        \"pydantic_settings.sources\",\n    ]\n)\n\nanalysis = Analysis(\n    [\"python_service/main.py\"],\n    pathex=[str(project_root)],\n    binaries=[],\n    datas=datas,\n    hiddenimports=sorted(hiddenimports),\n    hookspath=[],\n    hooksconfig={},\n    runtime_hooks=[],\n    excludes=[\"tests\", \"pytest\", \"web_service\"],\n    win_no_prefer_redirects=False,\n    win_private_assemblies=False,\n    cipher=block_cipher,\n    noarchive=False,\n)\n\npyz = PYZ(analysis.pure, analysis.zipped_data, cipher=block_cipher)\n\nexe = EXE(\n    pyz,\n    analysis.scripts,\n    analysis.binaries,\n    analysis.zipfiles,\n    analysis.datas,\n    [],\n    name=\"fortuna-backend\",\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=False,\n    upx_exclude=[],\n    runtime_tmpdir=None,\n    console=False,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n    icon=None,\n    version=build_version_file(version_string),\n)\n"
  },
  "fortuna-backend-electron.spec": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/fortuna-backend-electron.spec",
    "content": "# -*- mode: python ; coding: utf-8 -*-\nfrom pathlib import Path\nfrom PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\nblock_cipher = None\nproject_root = Path(SPECPATH).parent\n\n# Helper function to include data files\ndef include(rel_path: str, target: str, store: list):\n    absolute = project_root / rel_path\n    if absolute.exists():\n        store.append((str(absolute), target))\n    else:\n        print(f\"[spec] WARNING: Skipping missing include: {absolute}\")\n\ndatas = []\nhiddenimports = set()\n\n# Include necessary data directories\ninclude('python_service/data', 'data', datas)\ninclude('python_service/json', 'json', datas)\ninclude('python_service/adapters', 'adapters', datas)\n\n# Automatically collect submodules and data files for key libraries\ndatas += collect_data_files('uvicorn')\ndatas += collect_data_files('fastapi')\ndatas += collect_data_files('starlette')\nhiddenimports.update(collect_submodules('python_service'))\nhiddenimports.update([\n    'asyncio',\n    'asyncio.windows_events',\n    'asyncio.selector_events',\n    'uvicorn.logging',\n    'uvicorn.loops.auto',\n    'uvicorn.protocols.http.h11_impl',\n    'uvicorn.protocols.http.httptools_impl',\n    'uvicorn.protocols.websockets.wsproto_impl',\n    'uvicorn.protocols.websockets.websockets_impl',\n    'uvicorn.lifespan.on',\n    'fastapi.routing',\n    'fastapi.middleware.cors',\n    'starlette.staticfiles',\n    'starlette.middleware.cors',\n    'pydantic_core',\n    'pydantic_settings.sources',\n    'anyio._backends._asyncio',\n    'httpcore',\n    'httpx',\n    'python_multipart',\n    'numpy',\n    'pandas',\n])\n\na = Analysis(\n    ['python_service/main.py'],\n    pathex=[str(project_root)],\n    binaries=[],\n    datas=datas,\n    hiddenimports=sorted(hiddenimports),\n    hookspath=[],\n    hooksconfig={},\n    runtime_hooks=[],\n    excludes=[],\n    win_no_prefer_redirects=False,\n    win_private_assemblies=False,\n    cipher=block_cipher,\n    noarchive=False,\n)\n\n# \u2622\ufe0f PYZ INJECTION: Force __init__ files into the PYZ archive as modules\n# This is the definitive fix for ModuleNotFoundError at runtime.\na.pure += [\n    ('python_service', str(project_root / 'python_service/__init__.py'), 'PYMODULE'),\n]\n\npyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n\nexe = EXE(\n    pyz,\n    a.scripts,\n    a.binaries,\n    a.zipfiles,\n    a.datas,\n    name='fortuna-backend',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    console=False,\n    disable_windowed_traceback=False,\n    argv_emulation=False,\n    target_arch=None,\n    codesign_identity=None,\n    entitlements_file=None,\n)\n"
  },
  "scripts/audit_rebranding.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/audit_rebranding.py",
    "content": "#!/usr/bin/env python3\n# ==============================================================================\n#  Fortuna Faucet: Rebranding Audit Script\n# ==============================================================================\n# This script performs a comprehensive, read-only audit of the project to\n# identify all files containing legacy branding terms.\n# ==============================================================================\n\nimport os\n\n# --- CONFIGURATION ---\nTARGET_TERMS = [\"checkmate\", \"solo\"]\nEXCLUDED_DIRS = [\n    \".git\",\n    \".venv\",\n    \"node_modules\",\n    \"build\",\n    \"dist\",\n    \"__pycache__\",\n    \"ReviewableJSON\",\n]\nEXCLUDED_FILES = [\"audit_rebranding.py\", \"REBRANDING_AUDIT.md\"]\nOUTPUT_FILE = \"REBRANDING_AUDIT.md\"\n# -------------------\n\n\ndef search_file_for_terms(file_path, terms):\n    \"\"\"Searches a single file for a list of terms, case-insensitively.\"\"\"\n    try:\n        with open(file_path, \"r\", encoding=\"utf-8\", errors=\"ignore\") as f:\n            content = f.read().lower()\n            for term in terms:\n                if term in content:\n                    return True\n    except Exception as e:\n        print(f\"[WARNING] Could not read file {file_path}: {e}\")\n    return False\n\n\ndef main():\n    \"\"\"Main orchestrator for the audit.\"\"\"\n    print(\"--- Starting Rebranding Audit ---\")\n    affected_files = []\n    for root, dirs, files in os.walk(\".\", topdown=True):\n        # Exclude specified directories\n        dirs[:] = [d for d in dirs if d not in EXCLUDED_DIRS]\n\n        for filename in files:\n            if filename in EXCLUDED_FILES:\n                continue\n\n            file_path = os.path.join(root, filename)\n\n            # Check filename itself\n            if any(term in filename.lower() for term in TARGET_TERMS):\n                affected_files.append(file_path)\n                print(f\"[FOUND] Legacy term in filename: {file_path}\")\n                continue  # No need to search content if filename matches\n\n            # Check file content\n            if search_file_for_terms(file_path, TARGET_TERMS):\n                affected_files.append(file_path)\n                print(f\"[FOUND] Legacy term in content: {file_path}\")\n\n    print(f\"\\n--- Audit Complete. Found {len(affected_files)} affected files. ---\")\n\n    with open(OUTPUT_FILE, \"w\", encoding=\"utf-8\") as f:\n        f.write(\"# Fortuna Faucet: Rebranding Audit Report\\n\\n\")\n        f.write(\"This report lists all files containing legacy branding terms (`checkmate`, `solo`).\\n\\n---\\n\\n\")\n        if affected_files:\n            for file_path in sorted(affected_files):\n                f.write(f\"- `{file_path.replace(os.sep, '/')}`\\n\")\n        else:\n            f.write(\"No files with legacy branding were found.\\n\")\n\n    print(f\"[SUCCESS] Report written to {OUTPUT_FILE}\")\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/convert_to_json.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/convert_to_json.py",
    "content": "# convert_to_json.py\n# This script now contains the full, enlightened logic to handle all manifest formats and path styles.\n\nimport json\nimport os\nimport sys\nfrom multiprocessing import Process\nfrom multiprocessing import Queue\n\n# --- Configuration ---\nMANIFEST_FILES = [\n    \"MANIFEST_PART1_BACKEND.json\",\n    \"MANIFEST_PART2_FRONTEND.json\",\n    \"MANIFEST_PART3_SUPPORT.json\",\n    \"MANIFEST_PART4_ROOT.json\",\n]\nOUTPUT_DIR = \"ReviewableJSON\"\nFILE_PROCESSING_TIMEOUT = 10\nEXCLUDED_FILES = [\"package-lock.json\"]\nMAX_FILE_SIZE_MB = 10  # Max file size in megabytes\n\n\ndef read_json_manifest(manifest_path: str) -> list[str]:\n    \"\"\"Reads a JSON manifest file and returns a list of file paths.\"\"\"\n    try:\n        with open(manifest_path, \"r\", encoding=\"utf-8\") as f:\n            return json.load(f)\n    except (json.JSONDecodeError, FileNotFoundError):\n        return []\n\n\n# --- SANDBOXED FILE READ (Unchanged) ---\ndef _sandboxed_file_read(file_path, q):\n    try:\n        with open(file_path, \"r\", encoding=\"utf-8\", errors=\"ignore\") as f:\n            content = f.read()\n        q.put({\"file_path\": file_path, \"content\": content})\n    except Exception as e:\n        q.put({\"error\": str(e)})\n\n\ndef convert_file_to_json_sandboxed(file_path):\n    # --- Pre-flight check: File size ---\n    try:\n        file_size = os.path.getsize(file_path)\n        if file_size > MAX_FILE_SIZE_MB * 1024 * 1024:\n            return {\"error\": f\"File exceeds {MAX_FILE_SIZE_MB}MB size limit.\"}\n    except FileNotFoundError:\n        return {\"error\": \"File not found.\"}\n    except Exception as e:\n        return {\"error\": f\"Could not check file size: {e}\"}\n\n    q = Queue()\n    p = Process(target=_sandboxed_file_read, args=(file_path, q))\n    p.start()\n    p.join(timeout=FILE_PROCESSING_TIMEOUT)\n\n    try:\n        if p.is_alive():\n            print(f\"    [WARNING] Process for {file_path} timed out. Attempting graceful termination...\")\n            p.terminate()\n            p.join(timeout=2)  # Give it a moment to terminate gracefully\n\n            if p.is_alive():\n                print(f\"    [ERROR] Graceful termination failed. Forcibly killing process...\")\n                p.kill()  # The ultimate \"just die\"\n                p.join()\n            return {\"error\": f\"Timeout: File processing took longer than {FILE_PROCESSING_TIMEOUT} seconds.\"}\n\n        if not q.empty():\n            return q.get()\n        return {\"error\": \"Unknown error in sandboxed read process.\"}\n    finally:\n        # \u2705 Properly close and flush the queue\n        try:\n            while not q.empty():\n                q.get_nowait()\n        except Exception:\n            pass\n        q.close()\n        q.join_thread()\n\n\n# --- Main Orchestrator ---\ndef main():\n    print(f\"\\n{'=' * 60}\\nStarting IRONCLAD JSON backup process... (Enlightened Scribe Edition)\\n{'=' * 60}\")\n    os.makedirs(OUTPUT_DIR, exist_ok=True)\n\n    all_local_paths = []\n    for manifest in MANIFEST_FILES:\n        print(f\"--> Parsing manifest: {manifest}\")\n        paths = read_json_manifest(manifest)\n        if paths:\n            all_local_paths.extend(paths)\n            print(f\"    --> Found {len(paths)} valid file paths.\")\n        else:\n            print(f\"    [WARNING] Manifest not found or is empty: {manifest}\")\n\n    if not all_local_paths:\n        print(\"\\n[FATAL] No valid file paths found in any manifest. Aborting.\")\n        sys.exit(1)\n\n    unique_local_paths = sorted(list(set(all_local_paths)))\n    print(f\"\\nFound a total of {len(unique_local_paths)} unique files to process.\")\n    processed_count, failed_count = 0, 0\n\n    for local_path in unique_local_paths:\n        if os.path.basename(local_path) in EXCLUDED_FILES:\n            print(f\"\\n--> Skipping excluded file: {local_path}\")\n            failed_count += 1\n            continue\n        print(f\"\\nProcessing: {local_path}\")\n        json_data = convert_file_to_json_sandboxed(local_path)\n        if json_data and \"error\" not in json_data:\n            output_path = os.path.join(OUTPUT_DIR, local_path + \".json\")\n            os.makedirs(os.path.dirname(output_path), exist_ok=True)\n            with open(output_path, \"w\", encoding=\"utf-8\") as f:\n                json.dump(json_data, f, indent=4)\n            print(f\"    [SUCCESS] Saved backup to {output_path}\")\n            processed_count += 1\n        else:\n            error_msg = json_data.get(\"error\", \"Unknown error\") if json_data else \"File not found\"\n            print(f\"    [ERROR] Failed to process {local_path}: {error_msg}\")\n            failed_count += 1\n\n    print(f\"\\n{'=' * 60}\")\n    print(\"Backup process complete.\")\n    print(f\"Successfully processed: {processed_count}/{len(unique_local_paths)}\")\n    print(f\"Failed/Skipped: {failed_count}\")\n    print(f\"{'=' * 60}\")\n\n    if failed_count > 0:\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/fortuna-quick-start.ps1": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/fortuna-quick-start.ps1",
    "content": "# ====================================================================\n# Fortuna Faucet - Quick Start Script (No Installation Required)\n# ====================================================================\n# This script runs Fortuna directly from source without any MSI\n# Useful for development and testing before packaging\n# ====================================================================\n\nparam(\n    [switch]$SkipChecks,\n    [switch]$NoFrontend\n)\n\n$ErrorActionPreference = 'Stop'\n$OriginalLocation = Get-Location\n\n# ============= CONFIGURATION =============\n$PROJECT_ROOT = Split-Path -Parent $MyInvocation.MyCommand.Path\n$VENV_PATH = Join-Path $PROJECT_ROOT \".venv\"\n$PYTHON_EXE = Join-Path $VENV_PATH \"Scripts\\python.exe\"\n$BACKEND_DIR = Join-Path $PROJECT_ROOT \"python_service\"\n$FRONTEND_DIR = Join-Path $PROJECT_ROOT \"web_platform\\frontend\"\n$BACKEND_PORT = 8000\n$FRONTEND_PORT = 3000\n\n# ============= HELPER FUNCTIONS =============\n\nfunction Write-Status {\n    param([string]$Message, [string]$Status = \"INFO\")\n    $Color = switch ($Status) {\n        \"OK\"      { \"Green\" }\n        \"ERROR\"   { \"Red\" }\n        \"WARNING\" { \"Yellow\" }\n        default   { \"Cyan\" }\n    }\n    Write-Host \"[$Status] $Message\" -ForegroundColor $Color\n}\n\nfunction Test-CommandExists {\n    param([string]$Command)\n    try {\n        Get-Command $Command -ErrorAction Stop | Out-Null\n        return $true\n    } catch {\n        return $false\n    }\n}\n\nfunction Test-PortAvailable {\n    param([int]$Port)\n    try {\n        $Listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, $Port)\n        $Listener.Start()\n        $Listener.Stop()\n        return $true\n    } catch {\n        return $false\n    }\n}\n\nfunction Stop-ProcessOnPort {\n    param([int]$Port)\n    $Connection = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue\n    if ($Connection) {\n        $ProcessId = $Connection.OwningProcess\n        Write-Status \"Killing process $ProcessId on port $Port\" \"WARNING\"\n        Stop-Process -Id $ProcessId -Force -ErrorAction SilentlyContinue\n        Start-Sleep -Seconds 2\n    }\n}\n\nfunction Wait-ForBackend {\n    param([int]$MaxAttempts = 30)\n\n    Write-Status \"Waiting for backend to start (http://127.0.0.1:$BACKEND_PORT/health)...\"\n\n    for ($i = 1; $i -le $MaxAttempts; $i++) {\n        try {\n            $Response = Invoke-WebRequest -Uri \"http://127.0.0.1:$BACKEND_PORT/health\" -UseBasicParsing -TimeoutSec 2\n            if ($Response.StatusCode -eq 200) {\n                Write-Status \"Backend is healthy!\" \"OK\"\n                return $true\n            }\n        } catch {\n            Write-Host \".\" -NoNewline\n            Start-Sleep -Seconds 1\n        }\n    }\n\n    Write-Status \"Backend failed to start after $MaxAttempts seconds\" \"ERROR\"\n    return $false\n}\n\n# ============= PREFLIGHT CHECKS =============\n\nWrite-Host \"`n========================================\" -ForegroundColor Cyan\nWrite-Host \" Fortuna Faucet - Quick Start\" -ForegroundColor Cyan\nWrite-Host \"========================================`n\" -ForegroundColor Cyan\n\nif (-not $SkipChecks) {\n    Write-Status \"Running preflight checks...\"\n\n    # Check Python\n    if (-not (Test-Path $PYTHON_EXE)) {\n        Write-Status \"Python virtual environment not found at $VENV_PATH\" \"ERROR\"\n        Write-Status \"Please run setup script first or create venv manually\" \"ERROR\"\n        exit 1\n    }\n    Write-Status \"Python venv found\" \"OK\"\n\n    # Check Node.js\n    if (-not (Test-CommandExists \"node\")) {\n        Write-Status \"Node.js not found in PATH\" \"ERROR\"\n        Write-Status \"Install from: https://nodejs.org/\" \"ERROR\"\n        exit 1\n    }\n    Write-Status \"Node.js found: $(node --version)\" \"OK\"\n\n    # Check npm\n    if (-not (Test-CommandExists \"npm\")) {\n        Write-Status \"npm not found\" \"ERROR\"\n        exit 1\n    }\n    Write-Status \"npm found: $(npm --version)\" \"OK\"\n\n    # Check if ports are available\n    if (-not (Test-PortAvailable $BACKEND_PORT)) {\n        Write-Status \"Port $BACKEND_PORT is already in use\" \"WARNING\"\n        Stop-ProcessOnPort $BACKEND_PORT\n    }\n\n    if (-not $NoFrontend -and -not (Test-PortAvailable $FRONTEND_PORT)) {\n        Write-Status \"Port $FRONTEND_PORT is already in use\" \"WARNING\"\n        Stop-ProcessOnPort $FRONTEND_PORT\n    }\n\n    # Check Python dependencies\n    Write-Status \"Checking Python dependencies...\"\n    $PipList = & $PYTHON_EXE -m pip list\n    if ($PipList -notmatch \"fastapi\") {\n        Write-Status \"Python dependencies not installed\" \"WARNING\"\n        Write-Status \"Installing dependencies...\"\n        & $PYTHON_EXE -m pip install -r (Join-Path $BACKEND_DIR \"requirements.txt\")\n    } else {\n        Write-Status \"Python dependencies OK\" \"OK\"\n    }\n\n    # Check Node dependencies\n    if (-not $NoFrontend) {\n        Write-Status \"Checking Node.js dependencies...\"\n        $NodeModules = Join-Path $FRONTEND_DIR \"node_modules\"\n        if (-not (Test-Path $NodeModules)) {\n            Write-Status \"Node.js dependencies not installed\" \"WARNING\"\n            Write-Status \"Installing dependencies...\"\n            Push-Location $FRONTEND_DIR\n            npm install\n            Pop-Location\n        } else {\n            Write-Status \"Node.js dependencies OK\" \"OK\"\n        }\n    }\n\n    Write-Host \"\"\n}\n\n# ============= LAUNCH BACKEND =============\n\nWrite-Status \"Starting backend server...\"\n\n$BackendJob = Start-Job -ScriptBlock {\n    param($PythonExe, $BackendDir)\n    Set-Location $BackendDir\n    & $PythonExe -m uvicorn api:app --host 127.0.0.1 --port 8000 --reload\n} -ArgumentList $PYTHON_EXE, $BACKEND_DIR\n\nWrite-Status \"Backend job started (ID: $($BackendJob.Id))\"\n\n# Wait for backend to be healthy\nif (-not (Wait-ForBackend)) {\n    Write-Status \"Backend startup failed. Checking logs...\" \"ERROR\"\n    Receive-Job $BackendJob\n    Stop-Job $BackendJob\n    Remove-Job $BackendJob\n    exit 1\n}\n\n# ============= LAUNCH FRONTEND =============\n\nif (-not $NoFrontend) {\n    Write-Status \"Starting frontend dev server...\"\n\n    $FrontendJob = Start-Job -ScriptBlock {\n        param($FrontendDir)\n        Set-Location $FrontendDir\n        npm run dev\n    } -ArgumentList $FRONTEND_DIR\n\n    Write-Status \"Frontend job started (ID: $($FrontendJob.Id))\"\n\n    # Wait a bit for frontend to start\n    Start-Sleep -Seconds 5\n\n    Write-Status \"Opening browser...\" \"OK\"\n    Start-Process \"http://localhost:$FRONTEND_PORT\"\n}\n\n# ============= MONITORING =============\n\nWrite-Host \"`n========================================\" -ForegroundColor Green\nWrite-Host \" Fortuna is now running!\" -ForegroundColor Green\nWrite-Host \"========================================\" -ForegroundColor Green\nWrite-Host \"\"\nWrite-Status \"Backend:  http://127.0.0.1:$BACKEND_PORT\" \"OK\"\nif (-not $NoFrontend) {\n    Write-Status \"Frontend: http://127.0.0.1:$FRONTEND_PORT\" \"OK\"\n}\nWrite-Host \"\"\nWrite-Host \"Press Ctrl+C to stop all services\" -ForegroundColor Yellow\nWrite-Host \"\"\n\ntry {\n    while ($true) {\n        Start-Sleep -Seconds 2\n\n        # Check if jobs are still running\n        if ($BackendJob.State -eq \"Failed\" -or $BackendJob.State -eq \"Stopped\") {\n            Write-Status \"Backend has stopped unexpectedly!\" \"ERROR\"\n            Receive-Job $BackendJob\n            break\n        }\n\n        if (-not $NoFrontend -and ($FrontendJob.State -eq \"Failed\" -or $FrontendJob.State -eq \"Stopped\")) {\n            Write-Status \"Frontend has stopped unexpectedly!\" \"ERROR\"\n            Receive-Job $FrontendJob\n            break\n        }\n    }\n} finally {\n    # ============= CLEANUP =============\n    Write-Host \"`n`nShutting down...\" -ForegroundColor Yellow\n\n    if ($BackendJob) {\n        Write-Status \"Stopping backend...\"\n        Stop-Job $BackendJob -ErrorAction SilentlyContinue\n        Remove-Job $BackendJob -Force -ErrorAction SilentlyContinue\n    }\n\n    if ($FrontendJob) {\n        Write-Status \"Stopping frontend...\"\n        Stop-Job $FrontendJob -ErrorAction SilentlyContinue\n        Remove-Job $FrontendJob -Force -ErrorAction SilentlyContinue\n    }\n\n    # Kill any remaining processes on the ports\n    Stop-ProcessOnPort $BACKEND_PORT\n    if (-not $NoFrontend) {\n        Stop-ProcessOnPort $FRONTEND_PORT\n    }\n\n    Set-Location $OriginalLocation\n    Write-Status \"Cleanup complete\" \"OK\"\n}\n\n# ============= USAGE EXAMPLES =============\n<#\n.SYNOPSIS\nQuick start script for Fortuna Faucet (no installation required)\n\n.DESCRIPTION\nLaunches the backend and frontend servers directly from source code\nUseful for development and testing before creating an MSI installer\n\n.PARAMETER SkipChecks\nSkip all preflight dependency checks (faster startup)\n\n.PARAMETER NoFrontend\nOnly start the backend API server (no UI)\n\n.EXAMPLE\n.\\fortuna-quick-start.ps1\nStarts both backend and frontend with full checks\n\n.EXAMPLE\n.\\fortuna-quick-start.ps1 -NoFrontend\nStarts only the backend API (useful for API testing)\n\n.EXAMPLE\n.\\fortuna-quick-start.ps1 -SkipChecks\nFast startup (assumes all dependencies are already installed)\n#>"
  },
  "scripts/generate_manifests.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/generate_manifests.py",
    "content": "# scripts/generate_manifests.py\nimport json\nimport os\nfrom pathlib import Path\n\n# --- Configuration ---\nROOT_DIR = Path(\".\")\nOUTPUT_DIR = Path(\".\")\nNUM_MANIFESTS = 5 # We will create 5 balanced manifests\n\n# --- Inclusion/Exclusion Rules ---\n# To keep the manifests clean and focused, we define specific directories to include.\n# Everything else will be ignored.\nINCLUDE_ONLY_DIRS = {\n    \"python_service\",\n    \"web_platform\",\n    \"electron\",\n    \"scripts\",\n    \"wix\",\n    \".github\",\n    \"web_service\", # Include the new web service architecture\n}\n\nEXCLUDE_DIRS = {\n    \".git\",\n    \".idea\",\n    \".vscode\",\n    \"node_modules\",\n    \".next\",\n    \".venv\",\n    \"dist\",\n    \"build\",\n    \"__pycache__\",\n    \"attic\",\n    \"installer\",\n    \"ReviewableJSON\",\n    \"PREV_src\",\n    \".pytest_cache\",\n}\n\nEXCLUDE_FILES = {\n    # Exclude deactivated workflows\n    \".ymlx\",\n    # Exclude the manifests and archives themselves\n    \"MANIFEST_PART1.json\",\n    \"MANIFEST_PART2.json\",\n    \"MANIFEST_PART3.json\",\n    \"MANIFEST_PART4.json\",\n    \"MANIFEST_PART5.json\",\n    \"FORTUNA_ALL_PART1.JSON\",\n    \"FORTUNA_ALL_PART2.JSON\",\n    \"FORTUNA_ALL_PART3.JSON\",\n    \"FORTUNA_ALL_PART4.JSON\",\n    \"FORTUNA_ALL_PART5.JSON\",\n    # Exclude self and other key scripts from being archived\n    \"generate_manifests.py\",\n    \"ARCHIVE_PROJECT.py\",\n    # Exclude environment files and build specs\n    \".env\",\n    \".env.local.example\",\n    \"env\",\n    \"api.spec\",\n    \"fortuna-api.spec\",\n}\n\n\ndef get_all_project_files():\n    \"\"\"Walk the directory to find all files, respecting inclusions and exclusions.\"\"\"\n    all_files_with_size = []\n\n    # Start with a curated list of top-level files to include\n    top_level_files = [\n        \"AGENTS.md\", \"ARCHITECTURAL_MANDATE.md\", \"HISTORY.md\", \"README.md\",\n        \"WISDOM.md\", \"PSEUDOCODE.MD\", \"VERSION.txt\", \"fortuna-backend-electron.spec\",\n        \"fortuna-backend-webservice.spec\", \"fortuna-webservice-electron.spec\",\n        \"fortuna-webservice-service.spec\", \"pyproject.toml\", \"pytest.ini\",\n        \"requirements.txt\", \"requirements-dev.txt\", \"package.json\", \"package-lock.json\"\n    ]\n    for file_name in top_level_files:\n        file_path = ROOT_DIR / file_name\n        if file_path.exists():\n            all_files_with_size.append((str(file_path.as_posix()), os.path.getsize(file_path)))\n\n    # Walk through the explicitly included directories\n    for include_dir in INCLUDE_ONLY_DIRS:\n        walk_path = ROOT_DIR / include_dir\n        if not walk_path.is_dir():\n            continue\n        for root, dirs, files in os.walk(walk_path, topdown=True):\n            # Still respect the nested exclude directories like __pycache__\n            dirs[:] = [d for d in dirs if d not in EXCLUDE_DIRS]\n\n            for name in files:\n                if name in EXCLUDE_FILES or name.endswith((\".bmp\", \".png\", \".ico\", \".ymlx\")):\n                    continue\n\n                file_path = Path(root) / name\n                try:\n                    # Use forward slashes for cross-platform compatibility\n                    posix_path = str(file_path.as_posix())\n                    size = os.path.getsize(file_path)\n                    all_files_with_size.append((posix_path, size))\n                except FileNotFoundError:\n                    print(f\"[WARNING] File not found while scanning: {file_path}\")\n                    continue\n\n    # Consolidate and remove duplicates that might arise from overlapping rules\n    return list(set(all_files_with_size))\n\n\ndef balance_files_by_size(files_with_size, num_bins):\n    \"\"\"\n    Distributes files into a specified number of bins, balancing the total size.\n    Uses a greedy algorithm for efficiency.\n    \"\"\"\n    # Sort files by size in descending order to handle largest files first\n    files_with_size.sort(key=lambda x: x[1], reverse=True)\n\n    bins = [[] for _ in range(num_bins)]\n    bin_sizes = [0] * num_bins\n\n    for path, size in files_with_size:\n        # Find the bin with the smallest current total size\n        min_bin_index = bin_sizes.index(min(bin_sizes))\n        # Add the file to that bin\n        bins[min_bin_index].append(path)\n        # Update the bin's total size\n        bin_sizes[min_bin_index] += size\n\n    # Print the balancing results for verification\n    print(\"--- Manifest Balancing Results ---\")\n    for i, (file_list, total_size) in enumerate(zip(bins, bin_sizes)):\n        print(\n            f\" Manifest {i+1}: {len(file_list):>4} files, \"\n            f\"Total size: {total_size / 1024 / 1024:>6.2f} MB\"\n        )\n    print(\"---------------------------------\")\n\n    return bins\n\n\ndef main():\n    \"\"\"Generate balanced manifest files based on file size.\"\"\"\n    print(\"--- Starting Manifest Generation (Size-Balanced) ---\")\n    all_files = get_all_project_files()\n    print(f\"Found {len(all_files)} total project files to consider.\")\n\n    balanced_manifests = balance_files_by_size(all_files, NUM_MANIFESTS)\n\n    # Write the updated manifest files\n    for i, file_list in enumerate(balanced_manifests):\n        manifest_name = f\"MANIFEST_PART{i+1}.json\"\n        output_path = OUTPUT_DIR / manifest_name\n        sorted_files = sorted(file_list) # Sort alphabetically for consistency\n        with open(output_path, \"w\", encoding=\"utf-8\") as f:\n            json.dump(sorted_files, f, indent=4)\n        print(f\"\u2705 Wrote {len(sorted_files)} entries to {output_path}\")\n\n    print(\"\\n[SUCCESS] All manifest files have been generated and balanced.\")\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/generate_spec_electron.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/generate_spec_electron.py",
    "content": "# scripts/generate_spec_electron.py\nimport os\nimport sys\nimport subprocess\nfrom pathlib import Path\n\ndef main():\n    \"\"\"\n    Generates a PyInstaller spec file for the Electron workflows,\n    ensures __init__.py files exist, and runs the PyInstaller build.\n    \"\"\"\n    print(\"--- \ud83d\udc0d Electron Spec Generator ---\")\n\n    # 1. Get environment variables\n    try:\n        bk_dir = os.environ['BACKEND_DIR']\n        entry = f\"{bk_dir}/main.py\"\n    except KeyError as e:\n        print(f\"\u274c Missing environment variable: {e}\")\n        sys.exit(1)\n\n    print(f\"Backend Dir: {bk_dir}\")\n    print(f\"Entry Point: {entry}\")\n\n    # 2. Validate paths\n    if not Path(entry).exists():\n        print(f\"\u274c Entry point not found: {entry}\")\n        sys.exit(1)\n\n    # 3. This build is simpler and doesn't require the dynamic __init__\n    # injection that the web service does, as it's a more controlled environment.\n    # We just need to ensure the `python_service` is on the path.\n    pathex = [str(Path.cwd().resolve())]\n    print(f\"Using pathex: {pathex}\")\n\n\n    # 4. Define the spec file content for Electron\n    # This is based on the configuration required for the Electron app,\n    # which excludes the web service components.\n    spec_content = f\"\"\"\n# -*- mode: python ; coding: utf-8 -*-\n# Generated by scripts/generate_spec_electron.py\n\nfrom PyInstaller.utils.hooks import collect_data_files\n\nblock_cipher = None\n\na = Analysis(\n    ['{entry}'],\n    pathex={pathex},\n    binaries=[],\n    datas=[],\n    hiddenimports=['uvicorn.lifespan', 'uvicorn.loops', 'uvicorn.protocols', 'win32timezone'],\n    hookspath=[],\n    runtime_hooks=[],\n    excludes=['web_service'], # Explicitly exclude the other backend\n    win_no_prefer_redirects=False,\n    win_private_assemblies=False,\n    cipher=block_cipher,\n    noarchive=False,\n)\npyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n\nexe = EXE(\n    pyz,\n    a.scripts,\n    [],\n    exclude_binaries=True,\n    name='fortuna-backend',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    console=True, # Electron requires a console app to manage stdio\n)\ncoll = COLLECT(\n    exe,\n    a.binaries,\n    a.zipfiles,\n    a.datas,\n    strip=False,\n    upx=True,\n    upx_exclude=[],\n    name='fortuna-backend',\n)\n\"\"\"\n\n    # 5. Write the spec file\n    spec_path = \"fortuna-backend-electron.spec\"\n    print(f\"--- Writing spec file to {spec_path} ---\")\n    with open(spec_path, \"w\", encoding=\"utf-8\") as f:\n        f.write(spec_content)\n    print(f\"\u2705 Spec file created.\")\n\n    # 6. Run PyInstaller\n    print(\"--- Running PyInstaller build ---\")\n    cmd = [\n        sys.executable,\n        \"-m\", \"PyInstaller\",\n        spec_path,\n        \"--clean\",\n        \"--noconfirm\",\n        \"--log-level\", \"WARN\"\n    ]\n\n    result = subprocess.run(cmd, capture_output=True, text=True)\n\n    if result.returncode != 0:\n        print(\"\u274c PyInstaller build failed!\")\n        print(\"--- STDOUT ---\")\n        print(result.stdout)\n        print(\"--- STDERR ---\")\n        print(result.stderr)\n        sys.exit(1)\n\n    print(\"\u2705 PyInstaller build successful.\")\n    print(result.stdout)\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/generate_spec_ultimate.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/generate_spec_ultimate.py",
    "content": "# scripts/generate_spec_ultimate.py\nimport os\nimport sys\nimport subprocess\nfrom pathlib import Path\n\ndef main():\n    \"\"\"\n    Generates a PyInstaller spec file for the \"Ultimate\" workflow,\n    ensures __init__.py files exist, and runs the PyInstaller build.\n    \"\"\"\n    print(\"--- \ud83d\udc0d Ultimate Spec Generator ---\")\n\n    # 1. Get environment variables\n    try:\n        bk_dir = os.environ['BACKEND_DIR']\n        mod_path = os.environ['MODULE_PATH']\n        frontend_out = os.environ['FRONTEND_OUT']\n        entry = f\"{bk_dir}/main.py\"\n    except KeyError as e:\n        print(f\"\u274c Missing environment variable: {e}\")\n        sys.exit(1)\n\n    print(f\"Backend Dir: {bk_dir}\")\n    print(f\"Module Path: {mod_path}\")\n    print(f\"Frontend Out: {frontend_out}\")\n    print(f\"Entry Point: {entry}\")\n\n    # 2. Validate paths\n    if not Path(entry).exists():\n        print(f\"\u274c Entry point not found: {entry}\")\n        sys.exit(1)\n    if not Path(frontend_out).exists():\n        print(f\"\u274c Frontend output directory not found: {frontend_out}\")\n        sys.exit(1)\n\n    # 3. Ensure __init__.py files exist for all potential packages\n    # This covers both 'web_service' and 'python_service' structures.\n    inits = [\n        \"web_service/__init__.py\",\n        \"web_service/backend/__init__.py\",\n        \"python_service/__init__.py\"\n    ]\n\n    pure_injections = []\n    print(\"--- Ensuring package __init__.py files ---\")\n    for p in inits:\n        path = Path(p)\n        # Only create if the parent directory exists. This prevents creating\n        # 'python_service' when we're in 'web_service' mode, and vice-versa.\n        if path.parent.exists():\n            if not path.exists():\n                print(f\"   - Creating missing: {path}\")\n                path.write_text(\"# HatTrick Injection\")\n            else:\n                print(f\"   - Found existing: {path}\")\n\n            # Convert path to module name (e.g., 'web_service/backend' -> 'web_service.backend')\n            mod_name = str(path.parent).replace(os.sep, '.')\n            # Use absolute POSIX path for PyInstaller\n            abs_path_posix = path.resolve().as_posix()\n            pure_injections.append(f\"('{mod_name}', '{abs_path_posix}', 'PYMODULE')\")\n\n    injection_str = \",\\n    \".join(pure_injections)\n\n    # 4. Define the spec file content\n    spec_content = f\"\"\"\n# -*- mode: python ; coding: utf-8 -*-\n# Generated by scripts/generate_spec_ultimate.py\n\nfrom PyInstaller.utils.hooks import collect_data_files, collect_submodules\n\nblock_cipher = None\n\n# --- Analysis Phase ---\na = Analysis(\n    ['{entry}'],\n    pathex=[],\n    binaries=[],\n    datas=collect_data_files('uvicorn') + collect_data_files('slowapi') + [('{frontend_out}', 'ui')],\n    hiddenimports=collect_submodules('{mod_path}'),\n    hookspath=[],\n    runtime_hooks=[],\n    excludes=['tests', 'pytest'],\n    win_no_prefer_redirects=False,\n    win_private_assemblies=False,\n    cipher=block_cipher,\n    noarchive=False,\n)\n\n# --- PURE Injection (Dynamic) ---\n# This ensures that packages are correctly identified by PyInstaller.\na.pure += [\n    {injection_str}\n]\n\n# --- PYZ (Python Archive) Phase ---\npyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)\n\n# --- EXE (Executable) Phase ---\nexe = EXE(\n    pyz,\n    a.scripts,\n    a.binaries,\n    a.zipfiles,\n    a.datas,\n    [],\n    name='fortuna-backend',\n    debug=False,\n    bootloader_ignore_signals=False,\n    strip=False,\n    upx=True,\n    console=False  # GUI application\n)\n\"\"\"\n\n    # 5. Write the spec file\n    spec_path = \"hat-trick.spec\"\n    print(f\"--- Writing spec file to {spec_path} ---\")\n    with open(spec_path, \"w\", encoding=\"utf-8\") as f:\n        f.write(spec_content)\n    print(f\"\u2705 Spec file created.\")\n    print(\"-\" * 20)\n    print(spec_content)\n    print(\"-\" * 20)\n\n    # 6. Run PyInstaller\n    print(\"--- Running PyInstaller build ---\")\n    cmd = [\n        sys.executable,  # Use the same python interpreter running this script\n        \"-m\", \"PyInstaller\",\n        spec_path,\n        \"--clean\",\n        \"--noconfirm\",\n        \"--log-level\", \"WARN\"\n    ]\n\n    result = subprocess.run(cmd, capture_output=True, text=True)\n\n    if result.returncode != 0:\n        print(\"\u274c PyInstaller build failed!\")\n        print(\"--- STDOUT ---\")\n        print(result.stdout)\n        print(\"--- STDERR ---\")\n        print(result.stderr)\n        sys.exit(1)\n\n    print(\"\u2705 PyInstaller build successful.\")\n    print(result.stdout)\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/get_api_key.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/get_api_key.py",
    "content": "# scripts/get_api_key.py\nimport os\nimport sys\n\n# This is a workaround to ensure the script can find the python_service module,\n# especially when run from the packaged Electron app.\n# It assumes this script is in `resources/app/scripts` and the service is in `resources/app/python_service`.\ntry:\n    # Get the directory of the current script.\n    script_dir = os.path.dirname(os.path.abspath(__file__))\n    # Go up one level to the `app` directory and add `python_service` to the path.\n    project_root = os.path.dirname(script_dir)\n    sys.path.append(project_root)\n    from python_service.credentials_manager import SecureCredentialsManager\nexcept ImportError as e:\n    # If the import fails, write the error to stderr and exit.\n    # This helps in debugging path issues in the production environment.\n    print(\n        f\"Error: Failed to import SecureCredentialsManager. Details: {e}\",\n        file=sys.stderr,\n    )\n    sys.exit(1)\n\n\ndef retrieve_and_print_key():\n    \"\"\"\n    Retrieves the API key using the SecureCredentialsManager and prints it to stdout.\n    If the key is not found, it prints an empty string.\n    If an error occurs, it prints the error to stderr.\n    \"\"\"\n    try:\n        api_key = SecureCredentialsManager.get_api_key()\n        if api_key:\n            print(api_key, end=\"\")  # Print the key directly to stdout\n        else:\n            print(\"\", end=\"\")  # Print empty string if no key is found\n    except Exception as e:\n        print(f\"An error occurred while retrieving the API key: {e}\", file=sys.stderr)\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    retrieve_and_print_key()\n"
  },
  "scripts/install_fortuna_gui.bat": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/install_fortuna_gui.bat",
    "content": "@echo off\nREM Interactive MSI installation with standard Windows UI\n\ntitle Fortuna Faucet Installation Wizard\n\nnet session >nul 2>&1\nif %errorlevel% neq 0 (\n    echo ERROR: Administrator privileges required\n    echo Please right-click this file and select \"Run as Administrator\"\n    pause\n    exit /b 1\n)\n\nREM Assumes the MSI is in the 'dist' subfolder relative to the project root\nmsiexec.exe /i \"..\\dist\\Fortuna-Faucet-2.1.0-x64.msi\" /L*v \"%TEMP%\\fortuna_install.log\"\n\nif %errorlevel% equ 0 (\n    echo Installation completed successfully!\n    echo Access dashboard at: http://localhost:3000\n) else (\n    echo Installation failed. Log: %TEMP%\\fortuna_install.log\n)\npause"
  },
  "scripts/install_fortuna_silent.bat": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/install_fortuna_silent.bat",
    "content": "@echo off\nREM Automated deployment (no UI, minimal interaction)\n\nnet session >nul 2>&1\nif %errorlevel% neq 0 (\n    echo ERROR: Admin rights required\n    exit /b 1\n)\n\nREM Assumes the MSI is in the 'dist' subfolder relative to the project root\nmsiexec.exe /i \"..\\dist\\Fortuna-Faucet-2.1.0-x64.msi\" ^\n    /qn ^\n    /l*v \"%TEMP%\\fortuna_silent_install.log\" ^\n    /norestart ^\n    ALLUSERS=1 ^\n    INSTALLSCOPE=perMachine\n\nexit /b %errorlevel%"
  },
  "scripts/prepare_minimal_build.py": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/prepare_minimal_build.py",
    "content": "# scripts/prepare_minimal_build.py\nimport os\nimport shutil\n\n# This script prepares the source tree for a 'minimal' build.\n# A minimal build includes only the core application and a small, curated\n# set of essential data adapters, excluding the larger, more specialized ones.\n\nADAPTERS_TO_KEEP = [\n    \"__init__.py\",\n    \"base_adapter.py\",\n    \"handler_factory.py\",\n    # --- Essential Adapters ---\n    \"betfair_adapter.py\",\n    \"sporting_life_adapter.py\",\n    \"racing_post_adapter.py\",\n]\n\n\ndef main():\n    \"\"\"\n    Removes non-essential adapter files from the python_service/adapters\n    directory to create a minimal build artifact.\n    \"\"\"\n    adapters_dir = os.path.join(\"python_service\", \"adapters\")\n    if not os.path.isdir(adapters_dir):\n        print(f\"[ERROR] Adapters directory not found at: {adapters_dir}\")\n        exit(1)\n\n    print(f\"Scanning adapters directory: {adapters_dir}\")\n    removed_count = 0\n    for filename in os.listdir(adapters_dir):\n        if filename not in ADAPTERS_TO_KEEP:\n            file_path = os.path.join(adapters_dir, filename)\n            try:\n                if os.path.isfile(file_path):\n                    os.remove(file_path)\n                    print(f\"  - Removed file: {filename}\")\n                    removed_count += 1\n                elif os.path.isdir(file_path):\n                    shutil.rmtree(file_path)\n                    print(f\"  - Removed directory: {filename}\")\n                    removed_count += 1\n            except OSError as e:\n                print(f\"[ERROR] Failed to remove {file_path}: {e}\")\n                exit(1)\n\n    print(f\"\\nMinimal build preparation complete. Removed {removed_count} non-essential adapter(s).\")\n\n\nif __name__ == \"__main__\":\n    main()\n"
  },
  "scripts/repair_fortuna.bat": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/repair_fortuna.bat",
    "content": "@echo off\nREM Repair corrupted or missing files\n\nnet session >nul 2>&1\nif %errorlevel% neq 0 (\n    echo ERROR: Admin rights required\n    exit /b 1\n)\n\necho Repairing Fortuna Faucet installation...\n\nREM /f flag performs repair. Assumes MSI is in the 'dist' folder.\nmsiexec.exe /f \"..\\dist\\Fortuna-Faucet-2.1.0-x64.msi\" ^\n    /qn ^\n    /l*v \"%TEMP%\\fortuna_repair.log\"\n\nif %errorlevel% equ 0 (\n    echo Repair completed successfully.\n) else (\n    echo Repair failed. Check log: %TEMP%\\fortuna_repair.log\n)\n\nexit /b %errorlevel%"
  },
  "scripts/uninstall_fortuna.bat": {
    "raw_url": "https://raw.githubusercontent.com/masonj0/fortuna/refs/heads/main/scripts/uninstall_fortuna.bat",
    "content": "@echo off\nREM Complete removal of Fortuna Faucet\n\nnet session >nul 2>&1\nif %errorlevel% neq 0 (\n    echo ERROR: Admin rights required\n    exit /b 1\n)\n\necho WARNING: This will remove Fortuna Faucet completely.\nset /p confirm=\"Are you sure? (y/N): \"\n\nif /i not \"%confirm%\"==\"y\" exit /b 0\n\nREM Find and remove MSI by UpgradeCode\nfor /f \"tokens=2 delims=\" %%A in ('wmic product where \"Name like 'Fortuna Faucet%%'\" get IdentifyingNumber /value') do (\n    for /f \"tokens=2 delims==\" %%B in (\"%%A\") do (\n        msiexec.exe /x %%B /qn /l*v \"%TEMP%\\fortuna_uninstall.log\"\n    )\n)\n\nREM Clean up directories\nif exist \"%PROGRAMFILES%\\Fortuna Faucet\" rmdir /s /q \"%PROGRAMFILES%\\Fortuna Faucet\" 2>nul\nif exist \"%APPDATA%\\Fortuna Faucet\" rmdir /s /q \"%APPDATA%\\Fortuna Faucet\" 2>nul\n\necho Uninstall complete."
  }
}