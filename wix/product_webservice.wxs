<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product Id="*"
           Name="Fortuna Web Service"
           Language="1033"
           Version="$(var.Version)"
           Manufacturer="Fortuna Development Team"
           UpgradeCode="A3A4A3B6-2313-4375-9A97-15206C81454A">

    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Property Id="ARPNOREPAIR" Value="no" />
    <Property Id="ARPNOMODIFY" Value="yes" />

    <UI>
      <UIRef Id="WixUI_Minimal" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="electron\assets\license.rtf"/>
    <WixVariable Id="WixUIBannerBmp"  Value="electron\assets\banner.bmp"/>
    <WixVariable Id="WixUIDialogBmp"  Value="electron\assets\dialog.bmp"/>

    <Feature Id="ProductFeature" Title="Fortuna Web Service" Level="1">
      <ComponentGroupRef Id="WebServiceComponents" />
      <ComponentRef Id="ApplicationShortcut" />
    </Feature>
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLDIR" Name="FortunaWebService"/>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Web Service"/>
      </Directory>
      <Directory Id="CommonAppDataFolder">
        <Directory Id="FortunaData" Name="FortunaWebService"/>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="WebServiceComponents" Directory="INSTALLDIR">
      <Component Id="WebServiceExecutable" Guid="3F2A4A9C-4055-4D62-812E-B715A0123594">
        <File Id="WebServiceExe" Source="staging/fortuna-webservice.exe" KeyPath="yes"/>
        <ServiceInstall Id="FortunaWebService"
                        Name="FortunaWebService"
                        DisplayName="Fortuna Web Service"
                        Description="Provides live odds and race data via a web interface."
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal"
                        Account="NetworkService"/>
        <ServiceControl Id="StartFortunaWebService"
                        Name="FortunaWebService"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes"/>
        <fire:FirewallException Id="FortunaFirewall"
                                Name="FortunaWebService"
                                Port="8088"
                                Protocol="tcp"
                                Scope="any"/>
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="5E95E5B9-4F3D-4B9A-819B-9149C5E4700F">
        <util:InternetShortcut Id="DashboardShortcut"
                               Name="Fortuna Dashboard"
                               Target="http://localhost:8088"/>
        <Shortcut Id="UninstallProduct"
                  Name="Uninstall Fortuna Web Service"
                  Target="[SystemFolder]msiexec.exe"
                  Arguments="/x [ProductCode]"
                  Description="Uninstalls Fortuna Web Service"/>
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU"
                       Key="Software\FortunaWebService"
                       Name="installed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes"/>
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
