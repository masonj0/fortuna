<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product
    Id="*"
    Name="Fortuna Faucet - Racing Analysis Engine"
    Language="1033"
    Version="$(var.Version)"
    Manufacturer="Mason J0 Studios"
    UpgradeCode="12345678-1234-1234-1234-123456789012">

    <Package
      InstallerVersion="200"
      Compressed="yes"
      InstallScope="perMachine"
      Platform="x64"
      Description="Horse racing analysis platform with Python backend and React frontend"
      Comments="Professional-grade installer"/>

    <Media Id="1" Cabinet="fortuna.cab" EmbedCab="yes"/>

    <!-- Add the validation script to the installer's binary table -->
    <Binary Id="ValidateInstallScript" SourceFile="..\scripts\validate_installation.ps1" />

    <!-- Define the Custom Action -->
    <CustomAction Id="ValidateInstallation"
                  BinaryKey="ValidateInstallScript"
                  PowerShellCommand="-InstallPath `"[INSTALLFOLDER]`""
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <!-- Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet">
          <Directory Id="PythonDir" Name="python" />
          <Directory Id="AppDir" Name="app" />
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
      </Directory>
    </Directory>

    <!-- Features -->
    <Feature Id="ProductFeature" Title="Fortuna Faucet" Level="1">
        <ComponentGroupRef Id="PythonRuntimeFiles"/>
        <ComponentGroupRef Id="BackendFileGroup"/>
        <ComponentGroupRef Id="FrontendFileGroup"/>
        <ComponentGroupRef Id="ProductComponents"/>
        <ComponentGroupRef Id="ShortcutsComponentGroup"/>
    </Feature>

    <!-- Core Application Components -->
    <ComponentGroup Id="ProductComponents" Directory="AppDir">
      <Component Id="RegistryAndServiceComponent" Guid="*">
        <RegistryValue Root="HKLM" Key="Software\Fortuna Faucet" Name="Installed" Type="integer" Value="1" KeyPath="yes"/>
        <ServiceInstall Id="FortunaService" Name="FortunaFaucetBackend" DisplayName="Fortuna Faucet Background Service" Description="Continuous horse racing data monitoring engine" Type="ownProcess" Start="auto" Account="LocalSystem" ErrorControl="normal"/>
        <ServiceControl Id="StartService" Name="FortunaFaucetBackend" Start="install" Stop="both" Remove="uninstall"/>
      </Component>
    </ComponentGroup>

    <!-- Shortcuts -->
    <ComponentGroup Id="ShortcutsComponentGroup" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcuts" Guid="*">
          <util:InternetShortcut Id="DashboardShortcut" Name="Fortuna Faucet Dashboard" Target="http://localhost:3000"/>
          <Shortcut Id="UninstallShortcut" Name="Uninstall Fortuna Faucet" Description="Remove this application" Target="[SystemFolder]msiexec.exe" Arguments="/x [ProductCode]" Advertise="no"/>
          <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
          <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="Installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </ComponentGroup>

    <!-- UI -->
    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
    </UI>
    <UIRef Id="WixUI_Common" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="electron\assets\license.rtf"/>
    <WixVariable Id="WixUIBannerBmp" Value="electron\assets\banner.bmp"/>
    <WixVariable Id="WixUIDialogBmp" Value="electron\assets\dialog.bmp"/>

    <!-- Schedule the Custom Action to run after installation files are finalized -->
    <InstallExecuteSequence>
        <Custom Action="ValidateInstallation" After="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>

    <!-- System Requirements -->
    <Condition Message="Windows 7 or later (64-bit) is required">
      <![CDATA[Installed OR (VersionNT64 >= 601)]]>
    </Condition>

  </Product>
</Wix>
