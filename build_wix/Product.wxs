<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <Product Id="*" Name="Fortuna Full App Service" Language="1033" Version="1.0.0.0"
             Manufacturer="Fortuna Project" UpgradeCode="{da2c1b11-23f3-4787-a655-8094e97aa905}">

        <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
        <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <!-- Add UI and required license variable -->
        <UIRef Id="WixUI_Minimal" />
        <WixVariable Id="WixUILicenseRtf" Value="electron/assets/license.rtf" />

        <Feature Id="ProductFeature" Title="Fortuna Full App Service" Level="1">
            <ComponentRef Id="cmp_fortuna_backend_exe" />
            <ComponentRef Id="cmp_fortuna_service" />
            <ComponentGroupRef Id="FrontendFiles" />
            <ComponentRef Id="ApplicationShortcuts" />
        </Feature>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="Fortuna App Service">
                    <!-- Component for JUST the backend executable file -->
                    <Component Id="cmp_fortuna_backend_exe" Guid="*">
                        <File Id="file_fortuna_backend_exe" KeyPath="yes" Source="$(var.SourceDir)\fortuna-backend.exe" />
                    </Component>

                    <!-- SEPARATE Component for the Windows Service configuration -->
                    <Component Id="cmp_fortuna_service" Guid="*">
                        <CreateFolder />
                        <util:ServiceInstall
                            Id="ServiceInstaller"
                            Name="FortunaBackendService"
                            DisplayName="Fortuna Faucet Backend Service"
                            Description="Fortuna Faucet Backend API Service"
                            Type="ownProcess"
                            Start="auto"
                            ErrorControl="normal"
                            Account="LocalSystem"
                            Arguments=""
                            Interactive="no"
                        >
                            <util:ServiceConfig
                                FirstFailureActionType="restart"
                                SecondFailureActionType="restart"
                                ThirdFailureActionType="restart"
                                ResetPeriodInDays="1"
                                RestartServiceDelayInSeconds="60" />
                        </util:ServiceInstall>
                        <util:ServiceControl
                            Id="ServiceStarter"
                            Start="install"
                            Stop="both"
                            Remove="uninstall"
                            Name="FortunaBackendService"
                            Wait="yes"
                        />
                    </Component>

                    <!-- Directory for the UI -->
                    <Directory Id="UIDirectory" Name="ui" />
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="Fortuna App"/>
            </Directory>
        </Directory>

        <DirectoryRef Id="ApplicationProgramsFolder">
            <Component Id="ApplicationShortcuts" Guid="*">
                <Shortcut Id="ApplicationStartMenuShortcut"
                          Name="Fortuna Faucet"
                          Description="Launch the Fortuna Faucet Dashboard"
                          Target="[INSTALLFOLDER]ui\index.html"
                          WorkingDirectory="INSTALLFOLDER"/>
                <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
                <RegistryValue Root="HKCU" Key="Software\FortunaProject\FortunaApp" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
            </Component>
        </DirectoryRef>

    </Product>
</Wix>