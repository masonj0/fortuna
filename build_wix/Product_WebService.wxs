<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Package Name="Fortuna Faucet Web Service"
           Manufacturer="Fortuna Engineering"
           Version="$(var.Version)"
           UpgradeCode="D2F8159E-6324-4B3A-867A-8A875D3C5D3D"
           Scope="perMachine"
           Compressed="yes">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." Schedule="afterInstallExecute" />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="Main">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="ScriptComponents" />
      <ComponentGroupRef Id="RuntimeDirectoryComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch Fortuna Dashboard" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WixShellExecTarget" Value="http://localhost:$(var.ServicePort)" />

    <?if $(var.Platform) = x64 ?>
      <StandardDirectory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet Service">
           <Directory Id="Dir_Data" Name="data" />
           <Directory Id="Dir_Json" Name="json" />
           <Directory Id="Dir_Logs" Name="logs" />
        </Directory>
      </StandardDirectory>
    <?else?>
      <StandardDirectory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet Service">
           <Directory Id="Dir_Data" Name="data" />
           <Directory Id="Dir_Json" Name="json" />
           <Directory Id="Dir_Logs" Name="logs" />
        </Directory>
      </StandardDirectory>
    <?endif?>

    <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />

    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceExecutable" Guid="E4B9C2C2-5B4E-4B02-A2DA-820152433E72">
        <File Id="FortunaEXE" Source="$(var.SourceDir)/fortuna-webservice.exe" KeyPath="yes" />
        <ServiceInstall Id="ServiceInstaller" Type="ownProcess" Name="FortunaWebService"
                        DisplayName="Fortuna Web Service" Description="Background service for Fortuna Faucet"
                        Start="auto" Account="LocalSystem" ErrorControl="normal" Vital="yes" />
        <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="FortunaWebService" Wait="no" />
        <fire:FirewallException Id="FirewallRule" Name="Fortuna Faucet" Port="$(var.ServicePort)" Protocol="tcp" Scope="any" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="ScriptComponents" Directory="INSTALLFOLDER">
      <Component Id="RestartScriptComponent" Guid="F8A2D7B1-6E9A-4E1D-9B6C-7264871E9D5B">
        <File Id="RestartScript" Source="$(var.SourceDir)/restart_service.bat" KeyPath="yes" />
      </Component>
      <Component Id="ReadmeComponent" Guid="*">
        <File Id="ReadmeFile" Source="$(var.SourceDir)/README.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="RuntimeDirectoryComponents">
        <Component Id="DataDirectoryComponent" Directory="Dir_Data" Guid="*">
            <CreateFolder />
            <RemoveFile Id="RemoveDataDir" Name="*.*" On="uninstall" />
            <RegistryValue Root="HKLM" Key="Software\Fortuna" Name="DataDir" Type="string" Value="1" KeyPath="yes" />
        </Component>
        <Component Id="JsonDirectoryComponent" Directory="Dir_Json" Guid="*">
            <CreateFolder />
            <RemoveFile Id="RemoveJsonDir" Name="*.*" On="uninstall" />
            <RegistryValue Root="HKLM" Key="Software\Fortuna" Name="JsonDir" Type="string" Value="1" KeyPath="yes" />
        </Component>
        <Component Id="LogsDirectoryComponent" Directory="Dir_Logs" Guid="*">
            <CreateFolder />
            <RemoveFile Id="RemoveLogsDir" Name="*.*" On="uninstall" />
            <RegistryValue Root="HKLM" Key="Software\Fortuna" Name="LogsDir" Type="string" Value="1" KeyPath="yes" />
        </Component>
    </ComponentGroup>

    <ComponentGroup Id="ShortcutComponents">
        <Component Id="StartMenuShortcuts" Guid="E5D8F1A2-7C3B-4A9F-B8E2-4C5D6E7F8A1B" Directory="ApplicationProgramsFolder">
            <util:InternetShortcut Id="DashboardShortcut" Name="Fortuna Dashboard" Target="http://localhost:$(var.ServicePort)" />
            <Shortcut Id="RestartShortcut" Name="Restart Service" Description="Restarts the background service (Run as Admin)" Target="[INSTALLFOLDER]restart_service.bat" />
            <Shortcut Id="LogsShortcut" Name="View Logs" Description="Opens the log file directory" Target="[System64Folder]explorer.exe" Arguments="[Dir_Logs]" />
            <util:InternetShortcut Id="HelpShortcut" Name="Help &amp; Documentation" Target="http://localhost:$(var.ServicePort)/docs" />
            <Shortcut Id="UninstallShortcut" Name="Uninstall Fortuna Faucet" Description="Removes the application" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
        </Component>
    </ComponentGroup>
  </Package>
</Wix>
