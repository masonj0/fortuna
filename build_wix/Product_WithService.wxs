<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

    <Package Name="Fortuna Faucet Web Service"
             Language="1033"
             Version="1.0.0.0"
             Manufacturer="Fortuna Development"
             UpgradeCode="{A1B2C3D4-E5F6-7890-1234-567890ABCDEF}">

        <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <Feature Id="ProductFeature" Title="Fortuna Faucet Service" Level="1">
            <ComponentRef Id="ServiceComponent" />
            <ComponentRef Id="ConfigComponent" />
            <ComponentRef Id="StartMenuShortcut" />
            <ComponentRef Id="FirewallRule" />
        </Feature>

        <StandardDirectory Id="ProgramFilesFolder">
            <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet">
                <Directory Id="DataFolder" Name="data" />
                <Directory Id="LogsFolder" Name="logs" />
            </Directory>
        </StandardDirectory>

        <!-- Main Service Component -->
        <DirectoryRef Id="INSTALLFOLDER">
            <Component Id="ServiceComponent" Guid="*">
                <File Id="BackendExecutable"
                      Source="$(var.SourceDir)\fortuna-backend.exe"
                      KeyPath="yes" />

                <!-- Install as Windows Service -->
                <ServiceInstall
                    Id="ServiceInstaller"
                    Name="FortunaFaucetService"
                    DisplayName="Fortuna Faucet Web Service"
                    Description="Backend API and web server for Fortuna Faucet application"
                    Type="ownProcess"
                    Start="auto"
                    ErrorControl="normal"
                    Account="NT AUTHORITY\LocalService"
                    Arguments='--host 0.0.0.0 --port 8000 --log-level info'
                    Interactive="no"
                >
                    <!-- Service Recovery Configuration -->
                    <util:ServiceConfig
                        FirstFailureActionType="restart"
                        SecondFailureActionType="restart"
                        ThirdFailureActionType="restart"
                        ResetPeriodInDays="1"
                        RestartServiceDelayInSeconds="60" />
                </ServiceInstall>

                <!-- Service Control: Start/Stop/Remove -->
                <ServiceControl
                    Id="ServiceController"
                    Start="install"
                    Stop="both"
                    Remove="uninstall"
                    Name="FortunaFaucetService"
                    Wait="yes" />
            </Component>

            <!-- Configuration Component -->
            <Component Id="ConfigComponent" Guid="*">
                <!-- Environment Variables for Service -->
                <Environment
                    Id="DataPath"
                    Name="FORTUNA_DATA_PATH"
                    Value="[INSTALLFOLDER]data"
                    Action="set"
                    System="yes" />

                <Environment
                    Id="LogPath"
                    Name="FORTUNA_LOG_PATH"
                    Value="[INSTALLFOLDER]logs"
                    Action="set"
                    System="yes" />

                <!-- Create logs directory with permissions -->
                <CreateFolder Directory="LogsFolder">
                    <util:PermissionEx User="NT AUTHORITY\LocalService"
                                      GenericAll="yes" />
                </CreateFolder>

                <!-- Registry key for tracking installation -->
                <RegistryKey Root="HKLM"
                            Key="Software\Fortuna\FaucetService">
                    <RegistryValue Type="string"
                                  Name="InstallPath"
                                  Value="[INSTALLFOLDER]" />
                    <RegistryValue Type="string"
                                  Name="Version"
                                  Value="1.0.0.0" />
                    <RegistryValue Type="integer"
                                  Name="Port"
                                  Value="8000" />
                </RegistryKey>
            </Component>
        </DirectoryRef>

        <!-- Start Menu Shortcut -->
        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
        </StandardDirectory>

        <DirectoryRef Id="ApplicationProgramsFolder">
            <Component Id="StartMenuShortcut" Guid="*">
                <Shortcut Id="LaunchWebUI"
                          Name="Fortuna Faucet Dashboard"
                          Description="Open Fortuna Faucet in your browser"
                          Target="http://localhost:8000"
                          Icon="AppIcon" />

                <Shortcut Id="ServiceManager"
                          Name="Manage Fortuna Service"
                          Description="Open Windows Services to manage Fortuna"
                          Target="[System64Folder]services.msc"
                          Arguments="/s" />

                <RemoveFolder Id="CleanupShortcuts" On="uninstall"/>
                <RegistryValue Root="HKCU"
                              Key="Software\Fortuna\Service"
                              Name="ShortcutsInstalled"
                              Type="integer"
                              Value="1"
                              KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <!-- Firewall Rule Component -->
        <DirectoryRef Id="INSTALLFOLDER">
            <Component Id="FirewallRule" Guid="*">
                <util:FirewallException
                    Id="AllowLocalhost8000"
                    Name="Fortuna Faucet Local Server"
                    Description="Allow localhost connections to Fortuna Faucet on port 8000"
                    Port="8000"
                    Protocol="tcp"
                    Scope="localSubnet"
                    IgnoreFailure="yes" />
                <RegistryValue Root="HKCU"
                              Key="Software\Fortuna\Service"
                              Name="FirewallConfigured"
                              Type="integer"
                              Value="1"
                              KeyPath="yes"/>
            </Component>
        </DirectoryRef>

        <!-- Icon Definition -->
        <Icon Id="AppIcon" SourceFile="assets\icon.ico" />

    </Package>
</Wix>
