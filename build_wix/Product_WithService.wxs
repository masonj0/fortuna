<?xml version="1.0" encoding="UTF-8"?>
<!--
  This is the authoritative WiX v4 source file for the Fortuna Faucet Web Service.
  It has been corrected and modernized to use the v4 schema and best practices.
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Package Name="Fortuna Faucet Web Service"
           Manufacturer="Fortuna Engineering"
           Version="$(var.Version)"
           UpgradeCode="FA689549-366B-4C5C-A482-1132F9A34B10">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <Feature Id="Main">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="RuntimeDirectoryComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <ui:WixUI Id="WixUI_InstallDir"
              InstallDirectory="INSTALLFOLDER" />

    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

  </Package>

  <Fragment>
    <!-- 1. DEFINE THE DIRECTORY STRUCTURE WITH IDs -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet">
        <!-- Define the subfolders and give them IDs -->
        <Directory Id="Dir_Data" Name="data" />
        <Directory Id="Dir_Json" Name="json" />
        <Directory Id="Dir_Logs" Name="logs" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
    </StandardDirectory>

    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceComponent" Guid="*">
        <File Id="ServiceExe"
              Source="$(var.SourceDir)/fortuna-webservice.exe"
              KeyPath="true" />

        <ServiceInstall Id="ServiceInstaller"
                        Name="FortunaWebService"
                        DisplayName="Fortuna Faucet Backend Service"
                        Description="Data aggregation and analysis engine for horse racing."
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal" />

        <ServiceControl Id="ServiceControl"
                        Name="FortunaWebService"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="true" />

        <util:ServiceConfig ServiceName="FortunaWebService"
                            FirstFailureActionType="restart"
                            SecondFailureActionType="restart"
                            ThirdFailureActionType="restart"
                            RestartServiceDelayInSeconds="60" />

        <fire:FirewallException Id="FirewallRule"
                                Name="Fortuna Faucet"
                                Port="8102"
                                Protocol="tcp"
                                Scope="any" />

        <!-- This forces the app to listen on 8102 instead of default 8000 -->
        <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\FortunaWebService">
            <RegistryValue Name="Environment" Type="multiString" Value="PORT=8102[~]FORTUNA_PORT=8102" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <!-- 2. REFERENCE THE IDs IN THE COMPONENTS -->
    <ComponentGroup Id="RuntimeDirectoryComponents">
        <!-- Use Directory="Dir_Data" (the ID), not "data" (the name) -->
        <Component Id="DataDirectoryComponent" Directory="Dir_Data" Guid="a2e3820a-606b-452f-b43f-b82b9a7852a0">
            <CreateFolder />
        </Component>
        <Component Id="JsonDirectoryComponent" Directory="Dir_Json" Guid="b4d7ea21-821f-4a0b-9303-3a52e1f42d2a">
            <CreateFolder />
        </Component>
        <Component Id="LogsDirectoryComponent" Directory="Dir_Logs" Guid="d66f6540-3f11-4475-9a67-9c9852f87a32">
            <CreateFolder />
        </Component>
    </ComponentGroup>

    <ComponentGroup Id="ShortcutComponents" Directory="ApplicationProgramsFolder">
        <Component Id="ShortcutComponent" Guid="*">
            <Shortcut Id="UninstallShortcut"
                      Name="Uninstall Fortuna Faucet"
                      Description="Removes the application"
                      Target="[System64Folder]msiexec.exe"
                      Arguments="/x [ProductCode]" />
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="installed" Type="integer" Value="1" KeyPath="yes" />
        </Component>
    </ComponentGroup>

  </Fragment>
</Wix>
