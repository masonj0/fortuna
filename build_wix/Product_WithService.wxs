<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:firewall="http://wixtoolset.org/schemas/v4/wxs/firewall"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <Package Name="Fortuna Faucet Web Service"
           Manufacturer="Fortuna Development Team"
           Version="1.0.0.0"
           UpgradeCode="d8ba82a4-1215-4c83-9369-5254165563e4"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="MainApplication" Title="Main Application" Level="1">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="ShortcutsComponentGroup" />
    </Feature>

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Fortuna">
        <Directory Id="DataFolder" Name="data" />
        <Directory Id="LogsFolder" Name="logs" />

        <Component Id="FortunaBackendService" Guid="a1b1a73a-4424-4221-897b-0331984639e2">
          <File Id="FortunaBackendExe"
                Source="$(var.SourceDir)/fortuna-backend.exe"
                KeyPath="yes" />

          <Environment Id="FortunaDataDir" Name="FORTUNA_DATA_DIR" Value="[DataFolder]" Action="set" System="yes" />
          <Environment Id="FortunaLogDir" Name="FORTUNA_LOG_DIR" Value="[LogsFolder]" Action="set" System="yes" />
          <Environment Id="FortunaMode" Name="FORTUNA_MODE" Value="webservice" Action="set" System="yes" />

          <ServiceInstall Id="InstallFortunaService"
                          Name="FortunaBackendService"
                          DisplayName="Fortuna Faucet Backend"
                          Description="Handles data aggregation for Fortuna Faucet."
                          Start="auto"
                          Type="ownProcess"
                          ErrorControl="normal"
                          Account="NetworkService" />

          <ServiceControl Id="StartFortunaService"
                          Name="FortunaBackendService"
                          Start="demand"
                          Stop="both"
                          Remove="uninstall"
                          Wait="no" />

          <firewall:FirewallException Id="FWException"
                                      Name="Fortuna Faucet"
                                      Port="8000"
                                      Protocol="tcp"
                                      Scope="any" />

          <CreateFolder Directory="DataFolder">
            <util:PermissionEx User="NetworkService" GenericAll="yes" />
          </CreateFolder>
          <CreateFolder Directory="LogsFolder">
            <util:PermissionEx User="NetworkService" GenericAll="yes" />
          </CreateFolder>
        </Component>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Fortuna Service" />
    </StandardDirectory>

    <ComponentGroup Id="ServiceComponents">
      <ComponentRef Id="FortunaBackendService" />
    </ComponentGroup>

    <ComponentGroup Id="ShortcutsComponentGroup" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcuts" Guid="0fe34ea7-c144-465a-8ab7-7eef33ccfd5c">
        <util:InternetShortcut Id="DashboardShortcut" Name="Fortuna Faucet Dashboard" Target="http://localhost:8000" />
        <Shortcut Id="UninstallShortcut" Name="Uninstall Fortuna Service" Description="Remove this application" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet Service" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- MODERN WIX V4 UI SYNTAX -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />

  </Package>
</Wix>
