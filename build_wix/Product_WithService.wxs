<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Package Name="Fortuna Faucet Web Service"
           Manufacturer="Fortuna Engineering"
           Version="$(var.Version)"
           UpgradeCode="FA689549-366B-4C5C-A482-1132F9A34B10"
           Scope="perMachine"
           Compressed="yes">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="Main">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="RuntimeDirectoryComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet Service">
         <Directory Id="Dir_Data" Name="data" />
         <Directory Id="Dir_Json" Name="json" />
         <Directory Id="Dir_Logs" Name="logs" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
    </StandardDirectory>

    <StandardDirectory Id="DesktopFolder" />

    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceExecutable" Guid="YOUR-GUID-HERE-OR-AUTO-GEN">
        <File Id="FortunaEXE" Source="$(var.SourceDir)/fortuna-webservice.exe" KeyPath="yes" />
        <ServiceInstall Id="ServiceInstaller" Type="ownProcess" Name="FortunaWebService" DisplayName="Fortuna Faucet Web Service" Description="Background service for Fortuna Faucet" Start="auto" Account="LocalSystem" ErrorControl="normal" Vital="yes" />
        <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="FortunaWebService" Wait="yes" />
        <fire:FirewallException Id="FirewallRule" Name="Fortuna Faucet" Port="$(var.ServicePort)" Protocol="tcp" Scope="any" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="RuntimeDirectoryComponents" Directory="INSTALLFOLDER">
        <Component Id="DataDirectoryComponent" Guid="a2e3820a-606b-452f-b43f-b82b9a7852a0">
            <CreateFolder Directory="Dir_Data" />
        </Component>
        <Component Id="JsonDirectoryComponent" Guid="b4d7ea21-821f-4a0b-9303-3a52e1f42d2a">
            <CreateFolder Directory="Dir_Json" />
        </Component>
        <Component Id="LogsDirectoryComponent" Guid="d66f6540-3f11-4475-9a67-9c9852f87a32">
            <CreateFolder Directory="Dir_Logs" />
        </Component>
    </ComponentGroup>

    <ComponentGroup Id="ShortcutComponents">
        <Component Id="StartMenuShortcuts" Guid="*" Directory="ApplicationProgramsFolder">
            <util:InternetShortcut Id="WebShortcut" Name="Fortuna Faucet Dashboard" Target="http://localhost:$(var.ServicePort)" />
            <Shortcut Id="UninstallShortcut" Name="Uninstall Fortuna Faucet" Description="Removes the application" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" />
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
        </Component>
    </ComponentGroup>

  </Package>
</Wix>