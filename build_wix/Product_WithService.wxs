<?xml version="1.0" encoding="UTF-8"?>
<!--
  This is the authoritative WiX v4 source file for the Fortuna Faucet Web Service.
  It has been corrected and modernized to use the v4 schema and best practices.
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:fire="http://wixtoolset.org/schemas/v4/wxs/firewall">

  <Package Name="Fortuna Faucet Web Service"
           Manufacturer="Fortuna Engineering"
           Version="$(var.Version)"
           UpgradeCode="FA689549-366B-4C5C-A482-1132F9A34B10">

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <Feature Id="Main">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="RuntimeDirectoryComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <!-- The InstallDirectory attribute handles the WIXUI_INSTALLDIR property automatically in WiX v4, fixing WIX0091 -->
    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />

  </Package>

  <Fragment>
    <!-- 1. DIRECTORY STRUCTURE -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Fortuna Faucet">
        <Directory Id="Dir_Data" Name="data" />
        <Directory Id="Dir_Json" Name="json" />
        <Directory Id="Dir_Logs" Name="logs" />
      </Directory>
    </StandardDirectory>

    <!-- Start Menu Folder -->
    <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Fortuna Faucet"/>
    </StandardDirectory>

    <!-- Desktop Folder (NEW) -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- 2. SERVICE COMPONENTS -->
    <ComponentGroup Id="ServiceComponents" Directory="INSTALLFOLDER">
      <Component Id="ServiceComponent" Guid="*">
        <File Id="ServiceExe"
              Source="$(var.SourceDir)/fortuna-webservice.exe"
              KeyPath="yes" />

        <ServiceInstall Id="ServiceInstaller"
                        Name="FortunaFaucetService"
                        DisplayName="Fortuna Faucet Backend Service"
                        Description="Data aggregation and analysis engine."
                        Start="auto"
                        Type="ownProcess"
                        ErrorControl="normal" />

        <ServiceControl Id="ServiceControl"
                        Name="FortunaFaucetService"
                        Stop="both"
                        Remove="uninstall"
                        Wait="true" />

        <util:ServiceConfig ServiceName="FortunaFaucetService"
                            FirstFailureActionType="restart"
                            SecondFailureActionType="restart"
                            ThirdFailureActionType="restart"
                            RestartServiceDelayInSeconds="60" />

        <fire:FirewallException Id="FirewallRule"
                                Name="Fortuna Faucet"
                                Port="8102"
                                Protocol="tcp"
                                Scope="any" />

        <RegistryKey Root="HKLM" Key="SYSTEM\CurrentControlSet\Services\FortunaFaucetService">
            <RegistryValue Name="Environment" Type="multiString" Value="PORT=8102[~]FORTUNA_PORT=8102" />
        </RegistryKey>
      </Component>
    </ComponentGroup>

    <!-- 3. RUNTIME DIRECTORIES -->
    <ComponentGroup Id="RuntimeDirectoryComponents">
        <Component Id="DataDirectoryComponent" Directory="Dir_Data" Guid="a2e3820a-606b-452f-b43f-b82b9a7852a0">
            <CreateFolder />
        </Component>
        <Component Id="JsonDirectoryComponent" Guid="b4d7ea21-821f-4a0b-9303-3a52e1f42d2a">
            <CreateFolder Directory="Dir_Json" />
        </Component>
        <Component Id="LogsDirectoryComponent" Guid="d66f6540-3f11-4475-9a67-9c9852f87a32">
            <CreateFolder Directory="Dir_Logs" />
        </Component>
    </ComponentGroup>

    <!-- 4. SHORTCUTS (UPDATED) -->
    <ComponentGroup Id="ShortcutComponents">

        <!-- Start Menu Shortcuts -->
        <Component Id="StartMenuShortcuts" Guid="*" Directory="ApplicationProgramsFolder">
            <!-- Shortcut to Launch the App (or Web Interface) -->
            <!-- Since this is a service, we usually point to the Web UI URL -->
            <util:InternetShortcut Id="WebShortcut"
                                   Name="Fortuna Faucet Dashboard"
                                   Target="http://localhost:8102" />

            <Shortcut Id="UninstallShortcut"
                      Name="Uninstall Fortuna Faucet"
                      Description="Removes the application"
                      Target="[System64Folder]msiexec.exe"
                      Arguments="/x [ProductCode]" />

            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
        </Component>

        <!-- Desktop Shortcut -->
        <Component Id="DesktopShortcut" Guid="*" Directory="DesktopFolder">
            <util:InternetShortcut Id="DesktopWebShortcut"
                                   Name="Fortuna Faucet"
                                   Target="http://localhost:8102" />
            <RegistryValue Root="HKCU" Key="Software\Fortuna Faucet" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
        </Component>

    </ComponentGroup>

  </Fragment>
</Wix>
